














#include "stdio_64.h"
#include <math.h>
#include "MS_Swift.h"
#include "CR_Common.h"

EXEC SQL INCLUDE SQLCA;




#define	APL_MALLOC_FAIL_LOC(pointer)\
			if (pointer == NULL)\
			{\
				return APL_FAILURE;\
			}

/* AIX - Warnings removal - Start */
int MS_Rtv_TabVal(int ,char *,FILE *,char *,MS_STATIC_VAL *,int );
int MS_Chk_CondPrevMsg(int,char *,FILE *,MS_STATIC_VAL *,int);
extern int MS_Rtv_SeqRep(int ,int ,MS_SEQ_ELM_STRUCT_H *,int *);
extern int MS_Rtv_ParSeqRep(int ,int ,MS_SEQ_ELM_STRUCT_H *,int *);
extern int MS_Chk_TagCond(char *p_cond,int  p_val_rec,FILE *p_data_values,MS_STATIC_VAL *);
void MS_Proc_Round(char *,double ,char *,char ,char *,char,FILE *); 
int MS_Rtv_ComputedVal(char *,MS_CALC_ELM_STRUCT_H **,double *, int );
int MS_Proc_TailUpd(char *,MS_VAL_ELM_STRUCT_H **,int ,MS_CALC_ELM_STRUCT_H **,int ,
                    char,char,int ,MS_STATIC_VAL *,FILE *,FILE *);
int MS_Proc_ComputedVal(char *,MS_CALC_ELM_STRUCT_H **,int ,int ,FILE *,
                        MS_STATIC_VAL *,FILE *,int,DEBUG_INFO_STRUCT_H ** );
int MS_Proc_MsgEnd(MS_TAG_ELM_STRUCT_H **,int ,int ,MS_VAL_ELM_STRUCT_H **,
               MS_STATIC_VAL *,MS_CALC_ELM_STRUCT_H **,int ,FILE *,
               int,char * ,char *,FILE *, DEBUG_INFO_STRUCT_H **);
/* AIX - Warnings removal - End */
 
int MS_Proc_ISOMsg(char *chr_p_msgno_a,MS_TAG_ELM_STRUCT_H **p_ms_tag_elm_struct_h,int p_tot_tag,
                  MS_SEQ_ELM_STRUCT_H **p_ms_seq_elm_struct_h,
                  int p_tot_seq,MS_VAL_ELM_STRUCT_H **p_ms_val_elm_struct_h,int *p_tot_val,
                  FILE *l_data_values,int *p_val_rec,char *p_msg_file,
                  char p_swftlx,MS_CALC_ELM_STRUCT_H **p_ms_calc_elm_struct_h,int p_calc_ctr,
                  MS_STATIC_VAL *p_ms_static_val_d,FILE *p_errfile,char *p_txn_msg,
                  int *int_p_retstat,char p_priority,char *p_priority1_swift,char *p_uniq_seme_ident,DEBUG_INFO_STRUCT_H **l_debug_info_ptr) 
{

EXEC SQL BEGIN DECLARE SECTION;
char chr_h_form_val[201] = APL_NULL_STRING;
char chr_l_form_val[201] = APL_NULL_STRING;
char chr_l_fld_value1[201] = APL_NULL_STRING;

char chr_h_priority1_swift[201] = APL_NULL_STRING;
exec sql var chr_h_form_val is string;
exec sql var chr_l_form_val is string;
exec sql var chr_l_fld_value1 is string;
EXEC SQL END DECLARE SECTION;

struct sqlca sqlca;

int int_tag_ctr=0,int_val_ctr=0,int_seq_ctr=0,int_prv_seqno=0,int_calc_ctr=0,int_prev_val_rec=0;
int int_mprocessed=0,int_l_seq_rep_no=0,int_tot_tag=0,int_tot_seq=0,int_returnval=0,int_multi_skip=0;
int int_msglen=0,int_newmsgflg=0,int_prev_val_ctr=0,int_maxmsglen,int_newmsg=1,int_l_new_rec=0;
int int_replen=0,int_prv_replen = 0,int_l_len_data_val=0,int_rec_processed = 0;
int int_tag_skip=0,int_first_skip=0,int_line_ctr=0,int_last_proc=0,int_l_length_add = 0,int_retstat=0;
double dbl_l_calc_val= 0.0;
char chr_l_ccycode[APL_CCYCODE_LEN],chr_l_ccy_format[100];
char chr_format_code[10],chr_l_format_str[201];
char chr_l_date_time[APL_DATE_LEN],chr_l_seq_flag[2];
MS_MSGSTAT_STRUCT l_ms_msgstat_structa;



char chr_l_571_ind='N';
double dbl_l_571_mclosproc=0;
int 	int_l_seq_no_new=0;
int int_l_seq_ctr_new=0;
char chr_l_536fiop_ind='Y';	
int int_l_valrec_ctr_new;
char chr_l_536ficl_ind='Y';	
int	int_l_new_prv_rep_len_ind=0;
int	int_new_nreplen=0;
char  chr_l_temp_val[201] = APL_NULL_STRING;


int int_tp =0; 

char chr_l_neg_holp[201] =APL_NULL_STRING;
char chr_holp_ccycode[201] =APL_NULL_STRING;
char *chr_temp_holp;

int int_l_ret_tagcondeval = APL_FAILURE;
int int_l_block_tagcondeval = APL_SUCCESS;
char chr_l_block_name[20] = APL_NULL_STRING;


memset(chr_l_neg_holp,APL_NULL_CHAR,201);
memset(chr_holp_ccycode,APL_NULL_CHAR,201);
//memset(chr_l_fld_value1,APL_NULL_CHAR,201);
memset(chr_l_form_val,APL_NULL_CHAR,201);
memset(chr_h_form_val,APL_NULL_CHAR,201);
memset(chr_l_ccycode,APL_NULL_CHAR,APL_CCYCODE_LEN);
memset(chr_l_ccy_format,APL_NULL_CHAR,100);
memset(l_ms_msgstat_structa.swift_msg_rep,APL_NULL_CHAR,7);
memset(l_ms_msgstat_structa.proc_init,APL_NULL_CHAR,61);
memset(l_ms_msgstat_structa.generate_dt,APL_NULL_CHAR,APL_DATE_LEN);
memset(chr_l_date_time,APL_NULL_CHAR,APL_DATE_LEN);
memset(chr_l_format_str,APL_NULL_CHAR,201);
memset(chr_format_code,APL_NULL_CHAR,10);


int_tot_tag = p_tot_tag;
int_tot_seq = p_tot_seq;






int_prv_seqno = (*p_ms_tag_elm_struct_h)[int_tag_ctr].identity_no;
int_mprocessed = 0;
strcpy(chr_l_seq_flag,(*p_ms_seq_elm_struct_h)[0].ind);
if ((p_swftlx == 'S')|| (p_swftlx == 'B'))
			int_maxmsglen = MAXSWIFTLENISO15022; 

else if (p_swftlx == 'E')
			int_maxmsglen = MAXSWIFTLENISO15022; 
else
     int_maxmsglen = l_mt_message_sys_params_struct_h.allowed_tlx_len;

memset((*p_ms_val_elm_struct_h)[int_val_ctr].h_data_val,201,APL_NULL_CHAR);
memset(chr_h_priority1_swift,APL_NULL_CHAR,201);
strcpy(chr_h_priority1_swift,p_priority1_swift);

Alert("11111111");
while (int_mprocessed != 1)
{
	rewind(l_data_values); //HM :: rewind
	chr_l_571_ind = 'N';	
	dbl_l_571_mclosproc=0;
   int_tag_skip = 0; 
   if((int_msglen-int_prv_replen+int_replen) > int_maxmsglen)
   {
      if(int_rec_processed == 1)
                MS_Proc_TailUpd(chr_p_msgno_a,p_ms_val_elm_struct_h,int_val_ctr,p_ms_calc_elm_struct_h,p_calc_ctr,int_newmsg,'S',*p_val_rec,p_ms_static_val_d,l_data_values,p_errfile);
      else
                MS_Proc_TailUpd(chr_p_msgno_a,p_ms_val_elm_struct_h,int_val_ctr,p_ms_calc_elm_struct_h,p_calc_ctr,int_newmsg,'R',*p_val_rec,p_ms_static_val_d,l_data_values,p_errfile);
      MS_Proc_MsgEnd(p_ms_tag_elm_struct_h,int_tot_tag,*p_val_rec,p_ms_val_elm_struct_h,
               p_ms_static_val_d,p_ms_calc_elm_struct_h,int_newmsg,l_data_values, int_prev_val_ctr,chr_p_msgno_a,p_txn_msg,p_errfile,l_debug_info_ptr);
		
      int_returnval = MS_Proc_MsgFormat(*p_ms_seq_elm_struct_h,int_tot_seq,*p_ms_val_elm_struct_h,
                  int_prev_val_ctr,p_msg_file,p_swftlx,p_priority,chr_h_priority1_swift,p_uniq_seme_ident,chr_p_msgno_a);
      APL_GOBACK_SUCCESS;
   }
	
	
if(int_tag_ctr <= int_tot_tag)
{ 
	if(int_l_new_rec == 0)
  	{
     	int_rec_processed = 0;
     	int_returnval = MS_Proc_ComputedVal(chr_p_msgno_a,p_ms_calc_elm_struct_h,*p_val_rec,int_newmsg,l_data_values,p_ms_static_val_d,p_errfile,p_calc_ctr,l_debug_info_ptr);
     	if(int_returnval == APL_FAILURE)
     	{
        	APL_GOBACK_FAIL;
     	}
     	int_l_new_rec = 1;
  	}
                /* Added %d for AIX Migration*/
		Alert("(*p_ms_tag_elm_struct_h)[int_tag_ctr].identity_no  is %d\n",(*p_ms_tag_elm_struct_h)[int_tag_ctr].identity_no );
		Alert("int_prv_seqno is %d\n",int_prv_seqno);
   if ((*p_ms_tag_elm_struct_h)[int_tag_ctr].identity_no !=  int_prv_seqno) 
   { 
      if( strlen((*p_ms_seq_elm_struct_h)[((*p_ms_tag_elm_struct_h)[int_tag_ctr].identity_no)-1].seq_condition) != 0) 
      {
         if( APL_SUCCESS == MS_Chk_CondPrevMsg(*p_val_rec,(*p_ms_seq_elm_struct_h)[((*p_ms_tag_elm_struct_h)[int_tag_ctr].identity_no)-1].seq_condition,l_data_values,p_ms_static_val_d,int_newmsg))
         { 
           	
				if((*p_ms_tag_elm_struct_h)[int_tag_ctr].head_cont_newline == 'T')
           	{
				
					if((APL_FAILURE == MS_Chk_TagCond((*p_ms_tag_elm_struct_h)[int_tag_ctr].msg_tag_cond,*p_val_rec, l_data_values,p_ms_static_val_d)) || 
										strlen((*p_ms_tag_elm_struct_h)[int_tag_ctr].msg_tag_cond) == 0)
					{
						chr_l_536ficl_ind='N';   
					}
					else
					{
              	 	MS_Proc_TailUpd(chr_p_msgno_a,p_ms_val_elm_struct_h,int_val_ctr,p_ms_calc_elm_struct_h,p_calc_ctr,int_newmsg,'N',*p_val_rec,p_ms_static_val_d,l_data_values,p_errfile);
					 	chr_l_536ficl_ind='Y';   
					}
           	}
           	int_tag_ctr++;
           	continue;
         }
         else
         {
         	if((*p_ms_tag_elm_struct_h)[int_tag_ctr].head_cont_newline == 'T')
         	{
				
					if(((APL_FAILURE == MS_Chk_TagCond((*p_ms_tag_elm_struct_h)[int_tag_ctr].msg_tag_cond,*p_val_rec, l_data_values,p_ms_static_val_d)) ||
							strlen((*p_ms_tag_elm_struct_h)[int_tag_ctr].msg_tag_cond) == 0) )
					{
						chr_l_536ficl_ind='N';   
						int_tag_ctr++;
						continue;
					}
					else
					{
              		MS_Proc_TailUpd(chr_p_msgno_a,p_ms_val_elm_struct_h,int_val_ctr,p_ms_calc_elm_struct_h,p_calc_ctr,int_newmsg,'S',*p_val_rec,p_ms_static_val_d,l_data_values,p_errfile);
				 		chr_l_536ficl_ind='Y'; 
					}
         	}
         	if( (*p_ms_tag_elm_struct_h)[int_tag_ctr].identity_no == 1)
         	{
              if(int_rec_processed == 1)
              	MS_Proc_TailUpd(chr_p_msgno_a,p_ms_val_elm_struct_h,int_val_ctr,p_ms_calc_elm_struct_h,p_calc_ctr,int_newmsg,'S',*p_val_rec,p_ms_static_val_d,l_data_values,p_errfile);
              else
              	MS_Proc_TailUpd(chr_p_msgno_a,p_ms_val_elm_struct_h,int_val_ctr,p_ms_calc_elm_struct_h,p_calc_ctr,int_newmsg,'R',*p_val_rec,p_ms_static_val_d,l_data_values,p_errfile);
              
				  MS_Proc_MsgEnd(p_ms_tag_elm_struct_h,int_tot_tag,*p_val_rec,p_ms_val_elm_struct_h,
               		 p_ms_static_val_d,p_ms_calc_elm_struct_h,int_newmsg,l_data_values, int_prev_val_ctr,chr_p_msgno_a,p_txn_msg,p_errfile,l_debug_info_ptr);
	     			if(int_last_proc == 0)
	      		{
              		int_returnval = MS_Proc_MsgFormat(*p_ms_seq_elm_struct_h,int_tot_seq,*p_ms_val_elm_struct_h,
                           int_val_ctr+1,p_msg_file,p_swftlx,p_priority,chr_h_priority1_swift,p_uniq_seme_ident,chr_p_msgno_a);
	      		}
	      		else
	      		{
              		int_returnval = MS_Proc_MsgFormat(*p_ms_seq_elm_struct_h,int_tot_seq,*p_ms_val_elm_struct_h,
                            int_val_ctr,p_msg_file,p_swftlx,p_priority,chr_h_priority1_swift,p_uniq_seme_ident,chr_p_msgno_a);
	      		}
               APL_GOBACK_SUCCESS;
         	}
         }
      }
      else
      {
      if( (*p_ms_tag_elm_struct_h)[int_tag_ctr].identity_no == 1)
      {
              if(int_rec_processed == 1)
                MS_Proc_TailUpd(chr_p_msgno_a,p_ms_val_elm_struct_h,int_val_ctr,p_ms_calc_elm_struct_h,p_calc_ctr,int_newmsg,'S',*p_val_rec,p_ms_static_val_d,l_data_values,p_errfile);
              else
                MS_Proc_TailUpd(chr_p_msgno_a,p_ms_val_elm_struct_h,int_val_ctr,p_ms_calc_elm_struct_h,p_calc_ctr,int_newmsg,'R',*p_val_rec,p_ms_static_val_d,l_data_values,p_errfile);
              MS_Proc_MsgEnd(p_ms_tag_elm_struct_h,int_tot_tag,*p_val_rec,p_ms_val_elm_struct_h,
               		 p_ms_static_val_d,p_ms_calc_elm_struct_h,int_newmsg,l_data_values, int_prev_val_ctr,chr_p_msgno_a,p_txn_msg,p_errfile,l_debug_info_ptr);
              int_returnval = MS_Proc_MsgFormat(*p_ms_seq_elm_struct_h,int_tot_seq,*p_ms_val_elm_struct_h,
                          int_val_ctr+1,p_msg_file,p_swftlx,p_priority,chr_h_priority1_swift,p_uniq_seme_ident,chr_p_msgno_a);
               APL_GOBACK_SUCCESS;
      }
      }

      int_seq_ctr = 0;
      while( int_seq_ctr <= int_tot_seq)
      {
         if( (*p_ms_seq_elm_struct_h)[int_seq_ctr].identity_no == int_prv_seqno)
         { 
            (*p_ms_seq_elm_struct_h)[int_seq_ctr].sequence_rep_no = (*p_ms_seq_elm_struct_h)[int_seq_ctr].sequence_rep_no  + 1;
            break;
         }
         int_seq_ctr++;
      }
      int_prv_seqno = (*p_ms_tag_elm_struct_h)[int_tag_ctr].identity_no;
      int_seq_ctr = 0;
      while( int_seq_ctr <= int_tot_seq)
      {
         if( (*p_ms_seq_elm_struct_h)[int_seq_ctr].identity_no == (*p_ms_tag_elm_struct_h)[int_tag_ctr].identity_no)
         { 
            strcpy(chr_l_seq_flag,(*p_ms_seq_elm_struct_h)[int_seq_ctr].ind);
            break;
         }
         int_seq_ctr++;
      }
   }


   if((strlen((*p_ms_tag_elm_struct_h)[int_tag_ctr].msg_tag_cond) != 0)||(int_l_block_tagcondeval==APL_FAILURE))
   {

		if (int_l_block_tagcondeval==APL_SUCCESS)
		{
			int_l_ret_tagcondeval = MS_Chk_TagCond((*p_ms_tag_elm_struct_h)[int_tag_ctr].msg_tag_cond,*p_val_rec, l_data_values,p_ms_static_val_d);
			if ((strcmp((*p_ms_tag_elm_struct_h)[int_tag_ctr].msg_tag,"16R")==0) )
			{
				int_l_block_tagcondeval = int_l_ret_tagcondeval;
				strcpy(chr_l_block_name,(*p_ms_tag_elm_struct_h)[int_tag_ctr].info_elem);
			}
		}
		else
			int_l_ret_tagcondeval = APL_FAILURE;


			if(APL_FAILURE == int_l_ret_tagcondeval)
            {
				
					if(strncmp(chr_p_msgno_a,"535",3) ==0)
					{
				
						if((strcmp((*p_ms_tag_elm_struct_h)[int_tag_ctr].msg_tag,"19A")==0) && (strcmp((*p_ms_tag_elm_struct_h)[int_tag_ctr].info_elem,":HOLS//")== 0))
						{
							memset(chr_l_fld_value1,APL_NULL_CHAR,201);
							if(APL_FAILURE == MS_Rtv_TabVal(*p_val_rec,"FCLOSPRC",l_data_values,chr_l_fld_value1,p_ms_static_val_d,0))
							{
								chr_l_571_ind='N';
								dbl_l_571_mclosproc=0;
							}
							else
							{
								dbl_l_571_mclosproc = atof(chr_l_fld_value1);
								if(dbl_l_571_mclosproc != 0)
									chr_l_571_ind='Y';
								else
								{
									chr_l_571_ind='N';
									dbl_l_571_mclosproc=0;
								}
							}
						}
					}
                int_tag_skip = 1; 

		strcpy(chr_format_code,APL_NULL_STRING);
                
                
                if(int_last_proc == 0)
			int_multi_skip = 1;
                else
			int_multi_skip = 0;
                int_last_proc = 0;
             }
             else
             {
               int_last_proc = 1; 
             }
   }
	else
	{
		
		int_last_proc = 1;
	}

	if ((strcmp((*p_ms_tag_elm_struct_h)[int_tag_ctr].msg_tag,"16S")==0) && (strcmp(chr_l_block_name,(*p_ms_tag_elm_struct_h)[int_tag_ctr].info_elem)==0))
	{
		int_l_block_tagcondeval = APL_SUCCESS;
		strcpy(chr_l_block_name,APL_NULL_STRING);
	}

   if((*p_ms_tag_elm_struct_h)[int_tag_ctr].info_type == 'F')
   {
       strcpy(chr_format_code,(*p_ms_tag_elm_struct_h)[int_tag_ctr].info_elem);
       int_tag_skip = 1;
   }


   
   
   if((*p_ms_tag_elm_struct_h)[int_tag_ctr].head_cont_newline == 'F' )
   {
       if(int_tag_skip == 1)
       	int_first_skip = 1;
       else
        int_first_skip = 0;
   }

   
   int_l_length_add = 0;
   
	if(int_tag_skip != 1 || chr_l_571_ind !='N' )
   { 

   	strcpy((*p_ms_val_elm_struct_h)[int_val_ctr].msg_tag, (*p_ms_tag_elm_struct_h)[int_tag_ctr].msg_tag);


      (*p_ms_val_elm_struct_h)[int_val_ctr].identity_no  = (*p_ms_tag_elm_struct_h)[int_tag_ctr].identity_no;
      if(int_first_skip == 1 && ((*p_ms_tag_elm_struct_h)[int_tag_ctr].head_cont_newline == 'N'))
      	(*p_ms_val_elm_struct_h)[int_val_ctr].head_cont_newline  = 'H';
      else
      	(*p_ms_val_elm_struct_h)[int_val_ctr].head_cont_newline  = (*p_ms_tag_elm_struct_h)[int_tag_ctr].head_cont_newline;
      (*p_ms_val_elm_struct_h)[int_val_ctr].print_cd  = (*p_ms_tag_elm_struct_h)[int_tag_ctr].print_cd;
		

      (*p_ms_val_elm_struct_h)[int_val_ctr].srl_num  = (*p_ms_tag_elm_struct_h)[int_tag_ctr].srl_num;

		



   
      MS_Rtv_SeqRep((*p_ms_tag_elm_struct_h)[int_tag_ctr].identity_no,int_tot_seq,*p_ms_seq_elm_struct_h,&int_l_seq_rep_no);
      (*p_ms_val_elm_struct_h)[int_val_ctr].REP_NO  = int_l_seq_rep_no;
  
    
 

   
      MS_Rtv_ParSeqRep((*p_ms_tag_elm_struct_h)[int_tag_ctr].identity_no,int_tot_seq,*p_ms_seq_elm_struct_h,&int_tp);
      (*p_ms_val_elm_struct_h)[int_val_ctr].PAR_REP_NO  = int_tp;

    
      if((*p_ms_tag_elm_struct_h)[int_tag_ctr].head_cont_newline == 'N')
      {
        if(int_first_skip != 1)
        {
         int_line_ctr++;
         strcpy((*p_ms_val_elm_struct_h)[int_val_ctr].msg_tag,(*p_ms_tag_elm_struct_h)[int_tag_ctr].msg_tag);
         strcat((*p_ms_val_elm_struct_h)[int_val_ctr].msg_tag,ltoa(int_line_ctr));
        }
        else
        {
         strcpy((*p_ms_val_elm_struct_h)[int_val_ctr].msg_tag,(*p_ms_tag_elm_struct_h)[int_tag_ctr].msg_tag);
         int_first_skip = 0;
        }
      }
      else
      if((*p_ms_tag_elm_struct_h)[int_tag_ctr].head_cont_newline != 'C')
	 int_line_ctr = 0;

    

   
      if((*p_ms_tag_elm_struct_h)[int_tag_ctr].info_type == 'T')
      {
		 
			if(chr_l_571_ind != 'Y')
			{
         	memset(chr_l_fld_value1,APL_NULL_CHAR,201);
         	int_returnval = MS_Rtv_TabVal(*p_val_rec,(*p_ms_tag_elm_struct_h)[int_tag_ctr].info_elem,l_data_values,chr_l_fld_value1,p_ms_static_val_d,0);

	         if(int_returnval == APL_FAILURE)
   	      {
	   	 		 fprintf(p_errfile,"Failure in reading datafile for %s\n",(*p_ms_tag_elm_struct_h)[int_tag_ctr].info_elem);
         	    APL_GOBACK_FAIL
         	}
 
 	        if ((*p_ms_tag_elm_struct_h)[int_tag_ctr].print_cd != ' ')
   	      { 
      	      if ((*p_ms_tag_elm_struct_h)[int_tag_ctr].print_cd == 'A')
         	   {
            	    memset(chr_l_ccy_format,APL_NULL_CHAR,100);
               	 strcpy(chr_l_ccy_format,"CCY");
               	 strcat(chr_l_ccy_format,(*p_ms_tag_elm_struct_h)[int_tag_ctr].info_elem);
                	int_returnval = MS_Rtv_TabVal(*p_val_rec,chr_l_ccy_format,l_data_values,chr_l_ccycode,p_ms_static_val_d,0);
            	}
            	if ((*p_ms_tag_elm_struct_h)[int_tag_ctr].print_cd == 'R')
            	{
               	 memset(chr_l_ccy_format,APL_NULL_CHAR,100);
                	strcpy(chr_l_ccy_format,"DEC");
                	strcat(chr_l_ccy_format,(*p_ms_tag_elm_struct_h)[int_tag_ctr].info_elem);
                	int_returnval = MS_Rtv_TabVal(*p_val_rec,chr_l_ccy_format,l_data_values,chr_l_ccycode,p_ms_static_val_d,0);
            	}
	   			 if(strcmp(chr_p_msgno_a,"599CPJ") == 0 || strcmp(chr_p_msgno_a,"599PFR") == 0)
	    			{
	   				 MS_Proc_Round(chr_p_msgno_a,atof(chr_l_fld_value1),chr_l_form_val,(*p_ms_tag_elm_struct_h)[int_tag_ctr].print_cd,chr_l_ccycode,'T',p_errfile);
	   			 }
	    			else
	   			 {
	   				 MS_Proc_Round(chr_p_msgno_a,atof(chr_l_fld_value1),chr_l_form_val,(*p_ms_tag_elm_struct_h)[int_tag_ctr].print_cd,chr_l_ccycode,p_swftlx,p_errfile);
	    			 }
			printf("\n ********************* \n");
			printf("Nikhil SHinde :%s:", chr_l_form_val);
			
			if(p_swftlx == 'E')
			{
				if(chr_l_form_val[strlen(chr_l_form_val)-1] == ',')
				{
					EXEC SQL SELECT REPLACE(:chr_l_form_val,',','.00') 
						INTO :chr_l_fld_value1
						FROM DUAL;
					IS_ANY_ORA_ERROR
				}
				else
				{
					EXEC SQL SELECT REPLACE(:chr_l_form_val,',','.') 
						INTO :chr_l_fld_value1
						FROM DUAL;
					IS_ANY_ORA_ERROR
				}
			}
			else
			{
				strcpy(chr_l_fld_value1,chr_l_form_val);
			}
         	}

	 			if(strlen(chr_format_code) != 0)
	 			{
	    			sprintf(chr_l_format_str,chr_format_code,chr_l_fld_value1);
	    			strcpy(chr_l_fld_value1,chr_l_format_str);
	    			strcpy(chr_format_code,APL_NULL_STRING);
	 			}
			} 

	   
         if((*p_ms_tag_elm_struct_h)[int_tag_ctr].head_cont_newline == 'C')
         {
				if(chr_l_571_ind != 'Y')	
				{
             strcat((*p_ms_val_elm_struct_h)[int_val_ctr-1].h_data_val,chr_l_fld_value1);  
             int_val_ctr--;
             if(strcmp((*p_ms_tag_elm_struct_h)[int_tag_ctr].msg_tag,"PG") == 0 ||
                strcmp((*p_ms_tag_elm_struct_h)[int_tag_ctr].msg_tag,"PGC") == 0 )
                 int_l_length_add = 26 - strlen((*p_ms_val_elm_struct_h)[int_val_ctr].msg_tag)-4;
             else
                 int_l_length_add = strlen(chr_l_fld_value1)- strlen((*p_ms_val_elm_struct_h)[int_val_ctr].msg_tag)-4;
				}
				else		
				{
					strcat((*p_ms_val_elm_struct_h)[int_val_ctr-1].h_data_val,"\0");
					int_val_ctr--;
				}
         }
         else 
         {
      	    strcpy((*p_ms_val_elm_struct_h)[int_val_ctr].h_data_val,chr_l_fld_value1);  
            if((*p_ms_tag_elm_struct_h)[int_tag_ctr].head_cont_newline == 'N')
            {
             if(strcmp((*p_ms_tag_elm_struct_h)[int_tag_ctr].msg_tag,"PG") == 0 ||
                strcmp((*p_ms_tag_elm_struct_h)[int_tag_ctr].msg_tag,"PGC") == 0 )
                 int_l_length_add = 26 - strlen((*p_ms_val_elm_struct_h)[int_val_ctr].msg_tag)-4;
             else
                 int_l_length_add = strlen(chr_l_fld_value1)-strlen((*p_ms_val_elm_struct_h)[int_val_ctr].msg_tag);
            }
            else
            {
              if(strcmp((*p_ms_tag_elm_struct_h)[int_tag_ctr].msg_tag,"PG") == 0 ||
                strcmp((*p_ms_tag_elm_struct_h)[int_tag_ctr].msg_tag,"PGC") == 0 )
                int_l_length_add = 26;
              else
                int_l_length_add = strlen(chr_l_fld_value1);
            }
         }
      } 
 
   
      if((*p_ms_tag_elm_struct_h)[int_tag_ctr].info_type == 'C')
      {
			
			if((strcmp(chr_p_msgno_a,"536") == 0) && strcmp((*p_ms_tag_elm_struct_h)[int_tag_ctr].info_elem,"CLOSING_BAL") != 0 )
				chr_l_536ficl_ind = 'Y';

		
			if(chr_l_536ficl_ind == 'Y')//AIX - Warnings Removal
			{	
         	MS_Rtv_ComputedVal((*p_ms_tag_elm_struct_h)[int_tag_ctr].info_elem,p_ms_calc_elm_struct_h,
                         &dbl_l_calc_val,p_calc_ctr);

         	if((*p_ms_tag_elm_struct_h)[int_tag_ctr].print_cd ==  'A')
         	{
            	memset(chr_l_ccy_format,APL_NULL_CHAR,100);
            	strcpy(chr_l_ccy_format,"CCY");
            	strcat(chr_l_ccy_format,(*p_ms_tag_elm_struct_h)[int_tag_ctr].info_elem);
            	int_returnval = MS_Rtv_TabVal(*p_val_rec,chr_l_ccy_format,l_data_values,chr_l_ccycode,p_ms_static_val_d,0);
         	}
         	if((*p_ms_tag_elm_struct_h)[int_tag_ctr].print_cd ==  'R')
         	{
            	memset(chr_l_ccy_format,APL_NULL_CHAR,100);
            	strcpy(chr_l_ccy_format,"DEC");
            	strcat(chr_l_ccy_format,(*p_ms_tag_elm_struct_h)[int_tag_ctr].info_elem);
            	int_returnval = MS_Rtv_TabVal(*p_val_rec,chr_l_ccy_format,l_data_values,chr_l_ccycode,p_ms_static_val_d,0);
         	}
	 			if(strcmp(chr_p_msgno_a,"599CPJ") == 0 ||
            	strcmp(chr_p_msgno_a,"599PFR") == 0)
         	{
	 				MS_Proc_Round(chr_p_msgno_a,dbl_l_calc_val,chr_l_form_val,(*p_ms_tag_elm_struct_h)[int_tag_ctr].print_cd,chr_l_ccycode,'T',p_errfile);
         	}
	 			else
         	{
	 				MS_Proc_Round(chr_p_msgno_a,dbl_l_calc_val,chr_l_form_val,(*p_ms_tag_elm_struct_h)[int_tag_ctr].print_cd,chr_l_ccycode,p_swftlx,p_errfile);
         	}

				 if(strcmp((*p_ms_tag_elm_struct_h)[int_tag_ctr].info_elem,"PAGENO") == 0 ||
	    				strcmp((*p_ms_tag_elm_struct_h)[int_tag_ctr].info_elem,"PARTNO") == 0 )
	
					{
	    				EXEC SQL SELECT substr(lpad(:chr_l_form_val,5,'0'),1,5) into :chr_h_form_val FROM DUAL;

	    				IS_ANY_ORA_ERROR
	    				memset(chr_l_form_val,APL_NULL_CHAR,201);
	    				strcpy(chr_l_form_val,chr_h_form_val);
	 				}
        
	 			if(strlen(chr_format_code) != 0)
	 			{
	    			sprintf(chr_l_format_str,chr_format_code,chr_l_form_val);
	    			strcpy(chr_l_form_val,chr_l_format_str);
	    			strcpy(chr_format_code,APL_NULL_STRING);
	 			}
         	if((*p_ms_tag_elm_struct_h)[int_tag_ctr].head_cont_newline == 'C')
         	{
            	 
            
            	if(dbl_l_calc_val < 0)
                  {
							if((strncmp(chr_p_msgno_a,"535",3)==0) &&  (strncmp((*p_ms_val_elm_struct_h)[int_val_ctr-1].h_data_val,":HOLP//",6)==0))
							{
								strcpy(chr_l_neg_holp,(*p_ms_val_elm_struct_h)[int_val_ctr-1].h_data_val);
								strcpy(chr_holp_ccycode, strtok_r(chr_l_neg_holp,"//",&chr_temp_holp));	
								strcpy(chr_holp_ccycode , strtok_r(NULL,"//",&chr_temp_holp));	
								chr_holp_ccycode[4] =APL_NULL_CHAR;
								strcpy((*p_ms_val_elm_struct_h)[int_val_ctr-1].h_data_val, APL_NULL_STRING);
								strcpy((*p_ms_val_elm_struct_h)[int_val_ctr-1].h_data_val, "HOLP//N");
								strcat((*p_ms_val_elm_struct_h)[int_val_ctr-1].h_data_val,chr_holp_ccycode);
							}
							else
                    	{
								memset(chr_l_temp_val,APL_NULL_CHAR,30);
                    		strcpy(chr_l_temp_val,chr_l_form_val);
                    		if (atol(chr_l_temp_val)!=0)
                      	{
      	              		strcat((*p_ms_val_elm_struct_h)[int_val_ctr-1].h_data_val,"N");
                      	}
							}
                  }
           		strcat((*p_ms_val_elm_struct_h)[int_val_ctr-1].h_data_val,chr_l_form_val);  
             	int_val_ctr--;
             	if(strcmp((*p_ms_tag_elm_struct_h)[int_tag_ctr].msg_tag,"PG") == 0 ||
               	 strcmp((*p_ms_tag_elm_struct_h)[int_tag_ctr].msg_tag,"PGC") == 0 )
                	int_l_length_add = 26-strlen((*p_ms_val_elm_struct_h)[int_val_ctr].msg_tag)-4;
             	else
                	int_l_length_add = strlen(chr_l_form_val)-strlen((*p_ms_val_elm_struct_h)[int_val_ctr].msg_tag)-4;
         	}
         	else
         	{ 
            
            	if(dbl_l_calc_val < 0)
					{
                 memset(chr_l_temp_val,APL_NULL_CHAR,30);
                  strcpy(chr_l_temp_val,chr_l_form_val);
                  if (atol(chr_l_temp_val)!=0)
                      {
               	     strcpy((*p_ms_val_elm_struct_h)[int_val_ctr].h_data_val,"N");
  		          	     strcat((*p_ms_val_elm_struct_h)[int_val_ctr].h_data_val,chr_l_form_val);
                      }
                  else
                       strcpy((*p_ms_val_elm_struct_h)[int_val_ctr].h_data_val,chr_l_form_val);
					}
					else
     		        	strcpy((*p_ms_val_elm_struct_h)[int_val_ctr].h_data_val,chr_l_form_val);
 
             	if((*p_ms_tag_elm_struct_h)[int_tag_ctr].head_cont_newline == 'N')
             	{
             		if(strcmp((*p_ms_tag_elm_struct_h)[int_tag_ctr].msg_tag,"PG") == 0 ||
                		strcmp((*p_ms_tag_elm_struct_h)[int_tag_ctr].msg_tag,"PGC") == 0 )
                 		int_l_length_add = 26-strlen((*p_ms_val_elm_struct_h)[int_val_ctr].msg_tag);
             		else
                 		int_l_length_add = strlen(chr_l_form_val)-strlen((*p_ms_val_elm_struct_h)[int_val_ctr].msg_tag);
             	}
             	else
             	{
             		if(strcmp((*p_ms_tag_elm_struct_h)[int_tag_ctr].msg_tag,"PG") == 0 ||
                		strcmp((*p_ms_tag_elm_struct_h)[int_tag_ctr].msg_tag,"PGC") == 0 )
                 		int_l_length_add = 26;
             		else
                 		int_l_length_add = strlen(chr_l_form_val);
             	}
          	}
			}
			
			if((strcmp(chr_p_msgno_a,"536") == 0) && strcmp((*p_ms_tag_elm_struct_h)[int_tag_ctr].info_elem,"CLOSING_BAL") == 0 )
				chr_l_536ficl_ind = 'N';
      }

    
      if(((*p_ms_tag_elm_struct_h)[int_tag_ctr].info_type == 'S')  || ((*p_ms_tag_elm_struct_h)[int_tag_ctr].info_type == 'B')  )
      {
    
         if((*p_ms_tag_elm_struct_h)[int_tag_ctr].head_cont_newline == 'C')
         {
            
            strcat((*p_ms_val_elm_struct_h)[int_val_ctr-1].h_data_val,(*p_ms_tag_elm_struct_h)[int_tag_ctr].info_elem);  
            int_val_ctr--;
				if(chr_l_571_ind !='Y') 
				{
            	if(strcmp((*p_ms_tag_elm_struct_h)[int_tag_ctr].msg_tag,"PG") == 0 || strcmp((*p_ms_tag_elm_struct_h)[int_tag_ctr].msg_tag,"PGC") == 0 )
               	 int_l_length_add = 26-strlen((*p_ms_val_elm_struct_h)[int_val_ctr].msg_tag)-4;  
            	else
               	 int_l_length_add = strlen((*p_ms_tag_elm_struct_h)[int_tag_ctr].info_elem)-strlen((*p_ms_val_elm_struct_h)[int_val_ctr].msg_tag)-4;  
         	}
			}
         else
         { 
		
			if(strcmp(chr_p_msgno_a,"536") == 0)
			{
				int_l_valrec_ctr_new = *p_val_rec;
				if(!strcmp((*p_ms_tag_elm_struct_h)[int_tag_ctr].info_elem,":FIOP//"))
				{
					if(int_l_valrec_ctr_new > 1 && chr_l_536fiop_ind == 'Y' )
					{
					
						if(APL_SUCCESS == MS_Chk_CondPrevMsg(int_l_valrec_ctr_new,"ACC_INSTR_CODE",l_data_values,p_ms_static_val_d,0)) 
						{
							strcpy((*p_ms_val_elm_struct_h)[int_val_ctr].h_data_val,":INOP//");
							chr_l_536fiop_ind = 'N';
							
							
						}
						else
						{
							chr_l_536fiop_ind = 'N';	
							strcpy((*p_ms_val_elm_struct_h)[int_val_ctr].h_data_val,(*p_ms_tag_elm_struct_h)[int_tag_ctr].info_elem);
						}
					}
					else
					{
						if(int_l_valrec_ctr_new <=1)
						{
							chr_l_536fiop_ind = 'N';
						}
						strcpy((*p_ms_val_elm_struct_h)[int_val_ctr].h_data_val,(*p_ms_tag_elm_struct_h)[int_tag_ctr].info_elem);
					}
				}
				else
				{
					strcpy((*p_ms_val_elm_struct_h)[int_val_ctr].h_data_val,(*p_ms_tag_elm_struct_h)[int_tag_ctr].info_elem);
					
					if((!strcmp((*p_ms_val_elm_struct_h)[int_val_ctr].msg_tag,"23G")) && p_priority != '1')
						strcat((*p_ms_val_elm_struct_h)[int_val_ctr].h_data_val,"/COPY");
					
				}
			}
			else
			{
             strcpy((*p_ms_val_elm_struct_h)[int_val_ctr].h_data_val,(*p_ms_tag_elm_struct_h)[int_tag_ctr].info_elem);  
				
				if((!strcmp((*p_ms_val_elm_struct_h)[int_val_ctr].msg_tag,"23G")) && (p_priority != '1') && (strcmp((*p_ms_tag_elm_struct_h)[int_tag_ctr].info_elem,"NEWM/COPY")))
					strcat((*p_ms_val_elm_struct_h)[int_val_ctr].h_data_val,"/COPY");
					
			}
          
             if((*p_ms_tag_elm_struct_h)[int_tag_ctr].head_cont_newline == 'N')
             {
              if(strcmp((*p_ms_tag_elm_struct_h)[int_tag_ctr].msg_tag,"PG") == 0 ||
                strcmp((*p_ms_tag_elm_struct_h)[int_tag_ctr].msg_tag,"PGC") == 0 )
                  int_l_length_add = 26-strlen((*p_ms_val_elm_struct_h)[int_val_ctr].msg_tag);
              else
                  int_l_length_add = strlen((*p_ms_tag_elm_struct_h)[int_tag_ctr].info_elem)-strlen((*p_ms_val_elm_struct_h)[int_val_ctr].msg_tag);
             }
             else
             {
					if(chr_l_571_ind !='Y') 
					{
              		if(strcmp((*p_ms_tag_elm_struct_h)[int_tag_ctr].msg_tag,"PG") == 0 || strcmp((*p_ms_tag_elm_struct_h)[int_tag_ctr].msg_tag,"PGC") == 0 )
                  	int_l_length_add = 26;
              		else
                  	int_l_length_add = strlen((*p_ms_tag_elm_struct_h)[int_tag_ctr].info_elem);  
             	}
				 }
         }
       }
		
else if ((strcmp((*p_ms_tag_elm_struct_h)[int_tag_ctr].info_elem,"FUNCTION") == 0) && (!strncmp(chr_p_msgno_a,"564R",4)) && ((*p_ms_tag_elm_struct_h)[int_tag_ctr].info_type == 'T'))
   {
         	memset(chr_l_fld_value1,APL_NULL_CHAR,201);
         	int_returnval = MS_Rtv_TabVal(*p_val_rec,(*p_ms_tag_elm_struct_h)[int_tag_ctr].info_elem,l_data_values,chr_l_fld_value1,p_ms_static_val_d,0);

	         if(int_returnval == APL_FAILURE)
   	      {
	   	 		 fprintf(p_errfile,"Failure in reading datafile for %s\n",(*p_ms_tag_elm_struct_h)[int_tag_ctr].info_elem);
         	    APL_GOBACK_FAIL
         	}
	
      if((!strcmp((*p_ms_val_elm_struct_h)[int_val_ctr].msg_tag,"23G")) && p_priority != '1')
		{
          strcpy((*p_ms_val_elm_struct_h)[int_val_ctr].h_data_val,chr_l_fld_value1);
          strcat((*p_ms_val_elm_struct_h)[int_val_ctr].h_data_val,"/COPY");
		}
   }
	
	else if ((strcmp((*p_ms_tag_elm_struct_h)[int_tag_ctr].info_elem,"NEW_MSG_FUNC") == 0) && (!strncmp(chr_p_msgno_a,"567N",4)))
	{
      memset(chr_l_fld_value1,APL_NULL_CHAR,201);
      int_returnval = MS_Rtv_TabVal(*p_val_rec,(*p_ms_tag_elm_struct_h)[int_tag_ctr].info_elem,l_data_values,chr_l_fld_value1,p_ms_static_val_d,0);
		printf("HI ****** priority_ind=|%d|, msg_tag = |%s|\n",p_priority,(*p_ms_val_elm_struct_h)[int_val_ctr].msg_tag);

	   if(int_returnval == APL_FAILURE)
   	{
	   	fprintf(p_errfile,"Failure in reading datafile for %s\n",(*p_ms_tag_elm_struct_h)[int_tag_ctr].info_elem);
      	APL_GOBACK_FAIL
      }
      if((!strcmp((*p_ms_val_elm_struct_h)[int_val_ctr].msg_tag,"23G")) && p_priority != '1')
		{
          strcpy((*p_ms_val_elm_struct_h)[int_val_ctr].h_data_val,chr_l_fld_value1);
          strcat((*p_ms_val_elm_struct_h)[int_val_ctr].h_data_val,"/COPY");
		}
	}
		
   }
   int_tag_ctr++;
   if(int_tag_skip != 1)	
   {
      if((p_swftlx == 'S' ) || (p_swftlx == 'B'))
      {
        if(strcmp(chr_l_seq_flag,"NR") == 0)
        {
   	    	int_replen = int_replen + strlen((*p_ms_val_elm_struct_h)[int_val_ctr].msg_tag) + int_l_length_add + 4;
     	
			 if(int_l_new_prv_rep_len_ind == 0)
   	    	int_new_nreplen =  int_replen;
     	
        }
        else
        {
   	   int_msglen = int_msglen + strlen((*p_ms_val_elm_struct_h)[int_val_ctr].msg_tag) + int_l_length_add + 4;
        }
      }
      else
      {
        if(strcmp(chr_l_seq_flag,"NR") == 0)
        {
   	   int_replen = int_replen + strlen((*p_ms_val_elm_struct_h)[int_val_ctr].msg_tag) + int_l_length_add + 2;
        }
        else
        {
   	   int_msglen = int_msglen + strlen((*p_ms_val_elm_struct_h)[int_val_ctr].msg_tag) + int_l_length_add + 2;
        }
      }
   }
} 


   if( int_tag_ctr >= int_tot_tag)
   {
	  int_rec_processed = 1;
		int_prev_val_rec = *p_val_rec;
			 
		if(int_tag_skip != 1 || chr_l_571_ind != 'N')	
     		int_prev_val_ctr = int_val_ctr+1;
		else
			int_prev_val_ctr = int_val_ctr;
     	
		int_prv_replen = int_replen - int_new_nreplen;
	
	  if (int_l_new_prv_rep_len_ind == 0)
		int_l_new_prv_rep_len_ind = 1;
     	
		
     int_l_new_rec = 0;


		memset(chr_l_fld_value1,APL_NULL_CHAR,201);
		int_returnval = MS_Rtv_TabVal(*p_val_rec,"CLIENT",l_data_values,&chr_l_fld_value1,&p_ms_static_val_d,0);
		if(int_returnval == APL_FAILURE)
		{
		fprintf(p_errfile,"Failure in reading datafile for %s for record %d\n","CLIENT",*p_val_rec);
			 APL_GOBACK_FAIL
		}
		strcpy(l_ms_msgstat_structa.client,chr_l_fld_value1);
		Alert("HM :- CLIENT chr_l_fld_value1 %s",chr_l_fld_value1);

		memset(chr_l_fld_value1,APL_NULL_CHAR,201);
		int_returnval = MS_Rtv_TabVal(*p_val_rec,"PROC_INIT",l_data_values,&chr_l_fld_value1,&p_ms_static_val_d,0);
		Alert("HM :- PROC_INIT chr_l_fld_value1 %s",chr_l_fld_value1);
		if(int_returnval == APL_FAILURE)
		{
		fprintf(p_errfile,"Failure in reading datafile for %s for record %d\n","PROC_INIT",*p_val_rec);
			 APL_GOBACK_FAIL
		}
		strcpy(l_ms_msgstat_structa.proc_init,chr_l_fld_value1);

		strcpy(l_ms_msgstat_structa.swift_msg_rep,chr_p_msgno_a);   
	 	l_ms_msgstat_structa.swift_msg_rep[strlen(l_ms_msgstat_structa.swift_msg_rep)] = APL_NULL_CHAR;

     int_returnval = CO_RtvSysDt(chr_l_date_time,l_debug_info_ptr);
     if(int_returnval == APL_FAILURE)
     {
          APL_GOBACK_FAIL
     }
     strcpy(l_ms_msgstat_structa.generate_dt,chr_l_date_time);
     int_returnval = MS_Mod_MsgStat(l_ms_msgstat_structa,&int_retstat,l_debug_info_ptr);

     if(int_returnval == APL_FAILURE)
     {
          APL_GOBACK_FAIL
     }
     
     (*p_val_rec)++;  
     int_newmsg = 0;
     
     memset(chr_l_fld_value1,APL_NULL_CHAR,201);
     int_returnval = MS_Rtv_TabVal(*p_val_rec,"EOF",l_data_values,&chr_l_fld_value1,&p_ms_static_val_d,0);
     if(feof(l_data_values) == 0)
     {
     g_prev_pos = g_cur_pos;
     fgetpos(l_data_values,&g_cur_pos);
     }

     if(int_returnval == APL_FAILURE)
     {
	     fprintf(p_errfile,"Failure in reading datafile for %s\n",(*p_ms_tag_elm_struct_h)[int_tag_ctr].info_elem);
             APL_GOBACK_FAIL
     }
     int_tag_ctr = 0;
     if((strcmp(chr_l_fld_value1,"T" )== 0) || (int_tot_seq == 1))
     {
     	
	  		chr_l_571_ind='N';
			dbl_l_571_mclosproc=0;
     	
     			
				if(int_last_proc == 0)
     			{
       			int_val_ctr--;
     			}
     			
            if(int_rec_processed == 1)
                MS_Proc_TailUpd(chr_p_msgno_a,p_ms_val_elm_struct_h,int_val_ctr,p_ms_calc_elm_struct_h,p_calc_ctr,int_newmsg,'S',*p_val_rec,p_ms_static_val_d,l_data_values,p_errfile);
            else
                MS_Proc_TailUpd(chr_p_msgno_a,p_ms_val_elm_struct_h,int_val_ctr,p_ms_calc_elm_struct_h,p_calc_ctr,int_newmsg,'R',*p_val_rec,p_ms_static_val_d,l_data_values,p_errfile);
            MS_Proc_MsgEnd(p_ms_tag_elm_struct_h,int_tot_tag,*p_val_rec,p_ms_val_elm_struct_h,
                   p_ms_static_val_d,p_ms_calc_elm_struct_h,int_newmsg,l_data_values, int_prev_val_ctr,chr_p_msgno_a,p_txn_msg,p_errfile,l_debug_info_ptr);
        int_returnval = MS_Proc_MsgFormat(*p_ms_seq_elm_struct_h,int_tot_seq,*p_ms_val_elm_struct_h,
                    (int_val_ctr+1),p_msg_file,p_swftlx,p_priority,chr_h_priority1_swift,p_uniq_seme_ident,chr_p_msgno_a);
        if(int_returnval == APL_FAILURE)
		APL_GOBACK_FAIL
        int_mprocessed = 1;
        break;
     }
     
   }
   if(int_tag_skip != 1 || chr_l_571_ind != 'N')	
   {
      int_val_ctr++;  
      int_last_proc = 1;
      if(int_val_ctr == 1)
         *p_ms_val_elm_struct_h = (MS_VAL_ELM_STRUCT_H *)realloc(*p_ms_val_elm_struct_h,sizeof(MS_VAL_ELM_STRUCT_H)*(int_val_ctr+2));
      else
         *p_ms_val_elm_struct_h = (MS_VAL_ELM_STRUCT_H *)realloc(*p_ms_val_elm_struct_h,sizeof(MS_VAL_ELM_STRUCT_H)*(int_val_ctr+1));

      memset((*p_ms_val_elm_struct_h)[int_val_ctr].msg_tag,APL_NULL_CHAR,6);
      memset((*p_ms_val_elm_struct_h)[int_val_ctr].h_data_val,APL_NULL_CHAR,201);
      (*p_ms_val_elm_struct_h)[int_val_ctr].head_cont_newline = '\0';
      (*p_ms_val_elm_struct_h)[int_val_ctr].print_cd = '\0';
		(*p_ms_val_elm_struct_h)[int_val_ctr].identity_no=0;
		(*p_ms_val_elm_struct_h)[int_val_ctr].REP_NO=0;
		(*p_ms_val_elm_struct_h)[int_val_ctr].PAR_REP_NO=0;
		(*p_ms_val_elm_struct_h)[int_val_ctr].srl_num=0;

		
   }
}  

*p_tot_val = int_val_ctr;

APL_GOBACK_SUCCESS;

RETURN_SUCCESS:

        CO_ProcMonitor(APL_OUT_FILE,"Exiting successfully  out of Message Processing\n",NULL,NULL);
       

        return APL_SUCCESS;

RETURN_FAILURE:
        CO_ProcMonitor(APL_OUT_FILE,"Exiting unsuccesfully out of Message Processing\n",NULL,NULL);
       
        return APL_FAILURE;

}


int MS_Proc_TailUpd(char *chr_p_msgno_a,MS_VAL_ELM_STRUCT_H **p_ms_val_elm_struct_h,int p_val_ctr,MS_CALC_ELM_STRUCT_H **p_ms_calc_elm_struct_h,int p_calc_ctr,char p_newmsg,char p_revflg,int p_rownum,MS_STATIC_VAL *p_ms_static_val_d,FILE *p_data_values,FILE *p_errfile)
{

int int_ctr=0,int_returnval=0;
double dbl_l_calc_val=0;
char chr_l_form_val[30] = APL_NULL_STRING;
char chr_l_fld_value1[201] = APL_NULL_STRING;

char chr_l_temp_string_new[13]=APL_NULL_STRING;
char chr_l_temp_val[30] = APL_NULL_STRING;
void MS_Proc_Round(char *,double ,char *,char ,char *,char,FILE *); /* PJ */

memset(chr_l_fld_value1,APL_NULL_CHAR,201);

    if(strcmp(chr_p_msgno_a,"536") == 0)
    {
       if (APL_SUCCESS == MS_Chk_CondPrevMsg(p_rownum,"CLIENT",p_data_values,p_ms_static_val_d,0))
       {
          if(p_revflg == 'N')
             (*p_ms_calc_elm_struct_h)[11].link_tag = (*p_ms_calc_elm_struct_h)[11].PREV_VAL;
       }
       else if(p_revflg == 'N')
          p_revflg = 'S';

      if(p_revflg == 'S')
      {
      int_returnval = MS_Rtv_TabVal(p_rownum,"EOF",p_data_values,chr_l_fld_value1,p_ms_static_val_d,0);

       if(int_returnval == APL_FAILURE)
       {
             fprintf(p_errfile,"Failure in reading datafile for EOF\n");
             APL_GOBACK_FAIL
       }

       if(strcmp(chr_l_fld_value1,"T") == 0)
       {
           (*p_ms_calc_elm_struct_h)[11].link_tag = (*p_ms_calc_elm_struct_h)[11].PREV_VAL;
       } 

       }
       int_ctr = p_val_ctr;
       if(p_revflg != 'N')	
		 {
       	while(int_ctr > 0)
       	{
		 	
        	
        		if(strcmp((*p_ms_val_elm_struct_h)[int_ctr].msg_tag,"93B") == 0 && (!strncmp((*p_ms_val_elm_struct_h)[int_ctr].h_data_val,":FICL//",7) || !strncmp((*p_ms_val_elm_struct_h)[int_ctr].h_data_val,":INCL//",7)))
        		{
         		if(p_revflg == 'R')
         		{
         			(*p_ms_calc_elm_struct_h)[11].link_tag = (*p_ms_calc_elm_struct_h)[12].link_tag;
         			(*p_ms_calc_elm_struct_h)[11].PREV_VAL = (*p_ms_calc_elm_struct_h)[12].PREV_VAL;
         		}
         		if(p_revflg != 'N')
         		{
         			dbl_l_calc_val = (*p_ms_calc_elm_struct_h)[11].link_tag;
         			
	 					//MS_Proc_Round(chr_p_msgno_a,dbl_l_calc_val,&chr_l_form_val,'Q',APL_NULL_STRING,'S',p_errfile); //AIX - Warnings Removal
	 					MS_Proc_Round(chr_p_msgno_a,dbl_l_calc_val,chr_l_form_val,'Q',APL_NULL_STRING,'S',p_errfile);
        				
						memset(chr_l_temp_string_new,APL_NULL_CHAR,13);
						strncpy(chr_l_temp_string_new,(*p_ms_val_elm_struct_h)[int_ctr].h_data_val,12);
						strcpy((*p_ms_val_elm_struct_h)[int_ctr].h_data_val,chr_l_temp_string_new);
						
						if(dbl_l_calc_val < 0)
						{
                     memset(chr_l_temp_val,APL_NULL_CHAR,30);
                     strcpy(chr_l_temp_val,chr_l_form_val);
                     if (atol(chr_l_temp_val)!=0)
                     {
							 strcat((*p_ms_val_elm_struct_h)[int_ctr].h_data_val,"N");
						   }
                  }
         			strcat((*p_ms_val_elm_struct_h)[int_ctr].h_data_val,chr_l_form_val); 
         		}
         		break;
        		}
        		int_ctr--;
	 		} 
       }
       if(p_revflg == 'S')
          (*p_ms_calc_elm_struct_h)[11].link_tag = (*p_ms_calc_elm_struct_h)[11].PREV_VAL;

    }
APL_GOBACK_SUCCESS // AIX - Warnings removal
RETURN_SUCCESS:

        CO_ProcMonitor(APL_OUT_FILE,"Exiting successfully  out of Update Tail\n",NULL,NULL);
        return APL_SUCCESS;

RETURN_FAILURE:
        CO_ProcMonitor(APL_OUT_FILE,"Exiting unsuccesfully out of Update Tail\n",NULL,NULL);
        return APL_FAILURE;

}







int MS_Rtv_SeqRep(int p_seq_no,int p_no_of_seq,MS_SEQ_ELM_STRUCT_H *p_ms_seq_elm_struct_h,int *p_seq_rep_no)
{
int int_seq_ctr=0;
   for(int_seq_ctr=0;int_seq_ctr<p_no_of_seq;int_seq_ctr++)
   {

      if(p_ms_seq_elm_struct_h[int_seq_ctr].identity_no == p_seq_no)
	break;

   }
   *p_seq_rep_no = p_ms_seq_elm_struct_h[int_seq_ctr].sequence_rep_no+1;

APL_GOBACK_SUCCESS;

RETURN_SUCCESS:

        CO_ProcMonitor(APL_OUT_FILE,"Exiting successfully  out of MS_Rtv_SeqRep\n",NULL,NULL);

        return APL_SUCCESS;
/* AIX - Warnings removal
RETURN_FAILURE:
        CO_ProcMonitor(APL_OUT_FILE,"Exiting unsuccesfully out of MS_Rtv_SeqRep\n",NULL,NULL);
        return APL_FAILURE;
*/
}

int MS_Rtv_ParSeqRep(int p_seq_no,int p_no_of_seq,MS_SEQ_ELM_STRUCT_H *p_ms_seq_elm_struct_h,int *p_par_seq_rep_no)
{

int int_seq_ctr = 0,int_l_par_seq_no=0;

    for(int_seq_ctr=0;int_seq_ctr<=p_no_of_seq;int_seq_ctr++)
    {

      if(p_ms_seq_elm_struct_h[int_seq_ctr].identity_no == p_seq_no)
      {
        int_l_par_seq_no = p_ms_seq_elm_struct_h[int_seq_ctr].par_seqno;
	break;
      }
       
    }
    for(int_seq_ctr=0;int_seq_ctr<=p_no_of_seq;int_seq_ctr++)
    {
      if(p_ms_seq_elm_struct_h[int_seq_ctr].identity_no == int_l_par_seq_no)
      {
        *p_par_seq_rep_no = p_ms_seq_elm_struct_h[int_seq_ctr].sequence_rep_no;
	break;
      }
       
    }
APL_GOBACK_SUCCESS;

RETURN_SUCCESS:

        CO_ProcMonitor(APL_OUT_FILE,"Exiting successfully  out of MS_Rtv_ParSeqRep\n",NULL,NULL);

        return APL_SUCCESS;
/* AIX - Warnings removal
RETURN_FAILURE:
        CO_ProcMonitor(APL_OUT_FILE,"Exiting unsuccesfully out of MS_Rtv_ParSeqRep\n",NULL,NULL);
        return APL_FAILURE;
*/
}

int MS_Rtv_TabVal(int p_val_rec_seq_no,char *p_fld_name,FILE *p_data_values,char *p_fld_value,MS_STATIC_VAL *p_ms_static_val_d,int p_pos)
{

int int_returnval=0,int_stat_ctr=0;
char chr_l_fld_name[205];
char chr_l_fld_value1[201];
int g_curr_rec_start = 0;  /*Added for Linux Mig */
int g_prev_rec_start = 0;  /*Added for Linux Mig */

		  if (p_ms_static_val_d != NULL)
			{
      while(p_ms_static_val_d[int_stat_ctr].link_val != NULL && strlen(p_ms_static_val_d[int_stat_ctr].link_val) != 0)
      {
			printf(" |%d| |%s| |%s| \n", int_stat_ctr, p_ms_static_val_d[int_stat_ctr].link_val, p_fld_name );

           if(strcmp(p_ms_static_val_d[int_stat_ctr].link_val,p_fld_name) == 0)	
           {
          	strcpy(p_fld_value,p_ms_static_val_d[int_stat_ctr].link_tag);
                APL_GOBACK_SUCCESS 
           }
           int_stat_ctr++;
      }
		}	

     	memset(chr_l_fld_name,APL_NULL_CHAR,205); 
      strcpy(chr_l_fld_name,ltoa(p_val_rec_seq_no));
      strcat(chr_l_fld_name,p_fld_name);



		if (int_g_curr_rec_no == 0)			
		{
			int_g_curr_rec_no = p_val_rec_seq_no;
			strcpy(chr_l_fld_name,"1EOF");
			int_returnval = CO_Rtv_Token(p_val_rec_seq_no,p_data_values,chr_l_fld_name,p_fld_value,NULL);
			fgetpos(p_data_values,&g_curr_rec_start);
			g_curr_rec_start = g_curr_rec_start - (strlen(ltoa(p_val_rec_seq_no)) + 6);
			g_prev_rec_start = g_curr_rec_start;
		}
		
		if (p_val_rec_seq_no < int_g_curr_rec_no)
		{
			fsetpos(p_data_values,&g_prev_rec_start);
		}

		if (p_val_rec_seq_no < int_g_curr_rec_no-1)
		{
printf("\n Evaluated msg changes:  CALL TO PREVREC-1 chr_p_val is |%d| and g_curr is |%d|\n",p_val_rec_seq_no,int_g_curr_rec_no);
			rewind(p_data_values);

			int_g_curr_rec_no = p_val_rec_seq_no;
			sprintf(chr_l_fld_name,"%dEOF",p_val_rec_seq_no);
			printf("\n 1159 ******** ");
			int_returnval = CO_Rtv_Token(p_val_rec_seq_no,p_data_values,chr_l_fld_name,chr_l_fld_value1,NULL);
			fgetpos(p_data_values,&g_curr_rec_start);
			g_curr_rec_start = g_curr_rec_start - (strlen(ltoa(p_val_rec_seq_no)) + 6);
			g_prev_rec_start = g_curr_rec_start;

		}

		if (p_val_rec_seq_no == int_g_curr_rec_no)
		{
			 fsetpos(p_data_values,&g_curr_rec_start); 
		}

		if (p_val_rec_seq_no > int_g_curr_rec_no)
		{
			fsetpos(p_data_values,&g_curr_rec_start); 
		}

		if(!strcmp(p_fld_name,"CLIENT") || !strcmp(p_fld_name,"PROC_INIT") || !strcmp(p_fld_name,"EOF"))
		{
			Alert("rewind dat file");
			rewind(p_data_values);
		}
		rewind(p_data_values);
		strcpy(chr_l_fld_name,ltoa(p_val_rec_seq_no));
		strcat(chr_l_fld_name,p_fld_name);
		printf("\n 1176 **** \n");
		int_returnval = CO_Rtv_Token(p_val_rec_seq_no,p_data_values,chr_l_fld_name,p_fld_value,NULL);
		printf("\n 1178 **** \n");
		Alert("1701 chr_l_fld_name %s| p_fld_value %s|",chr_l_fld_name,p_fld_value);
		if(int_returnval == APL_SUCCESS)
		{

			if (p_val_rec_seq_no > int_g_curr_rec_no)
			{
				int_g_curr_rec_no = p_val_rec_seq_no;
				g_prev_rec_start = g_curr_rec_start;



				sprintf(chr_l_fld_name,"%dEOF",p_val_rec_seq_no);
				fsetpos(p_data_values,&g_curr_rec_start);
				int_returnval = CO_Rtv_Token(p_val_rec_seq_no,p_data_values,chr_l_fld_name,chr_l_fld_value1,NULL);



				fgetpos(p_data_values,&g_curr_rec_start);
				g_curr_rec_start = g_curr_rec_start - (strlen(ltoa(p_val_rec_seq_no)) + 6);
			}
				printf("\n returning .....%s...\n", p_fld_value);			
	 		 APL_GOBACK_SUCCESS;
      }
      else
      {
          APL_GOBACK_FAIL;
      }


RETURN_SUCCESS:

        CO_ProcMonitor(APL_OUT_FILE,"Exiting successfully  out of MS_Rtv_TabVal\n",NULL,NULL);

        return APL_SUCCESS;

RETURN_FAILURE:
        CO_ProcMonitor(APL_OUT_FILE,"Exiting unsuccesfully out of GetTableBalues\n",NULL,NULL);
        return APL_FAILURE;

}

int MS_Chk_CondPrevMsg(int p_val_rec,char *p_fld_name,FILE *p_data_values,MS_STATIC_VAL *p_ms_static_val_d,int p_newmsg)
{

char chr_curr_fld_val[201];
char chr_prev_fld_val[201];
char chr_l_fld_value1[201];

memset(chr_curr_fld_val,APL_NULL_CHAR,201);
memset(chr_prev_fld_val,APL_NULL_CHAR,201);
memset(chr_l_fld_value1,APL_NULL_CHAR,201);

      MS_Rtv_TabVal(p_val_rec,p_fld_name,p_data_values,
                     chr_l_fld_value1,p_ms_static_val_d,0);
      strcpy(chr_curr_fld_val,chr_l_fld_value1);

      
      
      if(p_val_rec == 1  || p_newmsg == 1)
            APL_GOBACK_FAIL

      memset(chr_l_fld_value1,APL_NULL_CHAR,201);
      
      MS_Rtv_TabVal((p_val_rec-1),p_fld_name,p_data_values,
                     chr_l_fld_value1,p_ms_static_val_d,1);
      strcpy(chr_prev_fld_val,chr_l_fld_value1);
      if(strcmp(chr_curr_fld_val,chr_prev_fld_val) == 0)
		APL_GOBACK_SUCCESS
      else
		APL_GOBACK_FAIL

RETURN_SUCCESS:

        CO_ProcMonitor(APL_OUT_FILE,"Exiting successfully  out of MS_Chk_CondPrevMsg\n",NULL,NULL);

        return APL_SUCCESS;

RETURN_FAILURE:
        CO_ProcMonitor(APL_OUT_FILE,"Exiting unsuccesfully out of MS_Chk_CondPrevMsg\n",NULL,NULL);
        return APL_FAILURE;
    
}

int MS_Rtv_ComputedVal(char *p_fld_name,MS_CALC_ELM_STRUCT_H **p_ms_calc_elm_struct_h,double *p_calc_val,
                      int p_calc_ctr)
{
int int_calc_ctr=0;
int int_found_flg = 0,int_first_flg = 0;

  for(int_calc_ctr=0;int_calc_ctr<p_calc_ctr;++int_calc_ctr)
  {

      if(strcmp((*p_ms_calc_elm_struct_h)[int_calc_ctr].link_val,p_fld_name) == 0)
      {
            *p_calc_val = (*p_ms_calc_elm_struct_h)[int_calc_ctr].link_tag;
            break;
             
      }

  }

APL_GOBACK_SUCCESS

RETURN_SUCCESS:

        CO_ProcMonitor(APL_OUT_FILE,"Exiting successfully  out of MS_Rtv_ComputedVal\n",NULL,NULL);

        return APL_SUCCESS;
/* AIX - Warnings removal
RETURN_FAILURE:
        CO_ProcMonitor(APL_OUT_FILE,"Exiting unsuccesfully out of MS_Rtv_ComputedVal \n",NULL,NULL);
        return APL_FAILURE;
*/
}

int MS_Proc_ComputedVal(char *chr_p_msgno_a,MS_CALC_ELM_STRUCT_H **p_ms_calc_elm_struct_h,int p_rownum,int p_newmsg,FILE *p_data_values,MS_STATIC_VAL *p_ms_static_val_d,FILE *p_errfile,int p_calc_ctr,DEBUG_INFO_STRUCT_H **l_debug_info_ptr)
{
char chr_l_fld_value1[201],chr_l_pvalue[201],chr_l_trcode_a[2],l_quantity[100], chr_l_fld_value1_negport[201];
char *chr_l_ccy_end = NULL;
char *chr_l_ccy_end_t = NULL;
int int_returnval=0;
double dbl_l_calc_val=0;
char chr_l_reverse[2]; 

char chr_l_fld_value1_new[201]=APL_NULL_STRING;

char chr_l_client_weektxnbal[11] = APL_NULL_STRING;
char chr_l_instrcode_weektxnbal[11] = APL_NULL_STRING;
char chr_l_date_time[APL_DATE_LEN] =APL_NULL_STRING;
int  int_l_closbal_weektxn =0;
char chr_l_weekly_stm[2]=APL_NULL_STRING;

chr_l_ccy_end_t = chr_l_ccy_end = (char *)calloc(4,sizeof(char));
APL_MALLOC_FAIL_LOC(chr_l_ccy_end);

EXEC SQL VAR chr_l_client_weektxnbal IS STRING;
EXEC SQL VAR chr_l_instrcode_weektxnbal IS STRING;
EXEC SQL VAR chr_l_date_time IS STRING;

memset(chr_l_fld_value1,APL_NULL_CHAR,201);
memset(chr_l_fld_value1_negport,APL_NULL_CHAR,201);
memset(chr_l_pvalue,APL_NULL_CHAR,201);
memset(chr_l_trcode_a,APL_NULL_CHAR,2);
memset(l_quantity,APL_NULL_CHAR,100);
memset(chr_l_fld_value1_new,APL_NULL_CHAR,201);

memset(chr_l_client_weektxnbal,APL_NULL_CHAR,11);
memset(chr_l_instrcode_weektxnbal,APL_NULL_CHAR,11); 
memset(chr_l_date_time,APL_NULL_CHAR,APL_DATE_LEN); 
memset(chr_l_weekly_stm,APL_NULL_CHAR,2);

memset(chr_l_reverse,APL_NULL_CHAR,2);
  if(p_newmsg == 1)
  {
         (*p_ms_calc_elm_struct_h)[1].link_tag = 0;
         (*p_ms_calc_elm_struct_h)[3].link_tag = 0;
         (*p_ms_calc_elm_struct_h)[4].link_tag = 0;
         (*p_ms_calc_elm_struct_h)[5].link_tag = 0;
  }

   if(strncmp(chr_p_msgno_a,"535",3) == 0)
   {

      int_returnval = MS_Rtv_TabVal(p_rownum,"COMB_MSG",p_data_values,
                     chr_l_fld_value1,p_ms_static_val_d,0);
      if(int_returnval == APL_FAILURE)
      {
         fprintf(p_errfile,"Failure in reading data h_file for consmsg indicator\n");
         APL_GOBACK_FAIL
      }
      if(strcmp(chr_l_fld_value1,"Y") == 0)
      {
         
         if (APL_SUCCESS == MS_Chk_CondPrevMsg(p_rownum,"CLIENT",p_data_values,p_ms_static_val_d,0))
         {
                if( p_newmsg == 1)
		  (*p_ms_calc_elm_struct_h)[0].link_tag++;
         }
         else
         {
                if ( p_newmsg == 1)
	        		(*p_ms_calc_elm_struct_h)[0].link_tag = 1;
                (*p_ms_calc_elm_struct_h)[1].link_tag = 0;
         }
      }
      else
      {
         if (APL_SUCCESS == MS_Chk_CondPrevMsg(p_rownum,"SUBACCOUNT",p_data_values,p_ms_static_val_d,0))
         {
                if ( p_newmsg == 1)
		  (*p_ms_calc_elm_struct_h)[0].link_tag++;
         }
         else
         {
                if ( p_newmsg == 1)
					(*p_ms_calc_elm_struct_h)[0].link_tag = 1;
                (*p_ms_calc_elm_struct_h)[1].link_tag = 0;
         }

      }

      if(p_newmsg == 1)
         (*p_ms_calc_elm_struct_h)[2].link_tag = 0;
      
		if(strcmp(chr_p_msgno_a,"535B")==0)
		{
			if (APL_FAILURE == MS_Chk_CondPrevMsg(p_rownum,"ACC_INSTR_CODE",p_data_values,p_ms_static_val_d,p_newmsg))
      	{
      		memset(chr_l_fld_value1,APL_NULL_CHAR,201);

      		int_returnval = MS_Rtv_TabVal(p_rownum,"LOCSTAT",p_data_values,chr_l_fld_value1,p_ms_static_val_d,0);
				if(strcmp(chr_l_fld_value1,"L")==0)
				{
      			memset(chr_l_fld_value1,APL_NULL_CHAR,201);
      			int_returnval = MS_Rtv_TabVal(p_rownum,"NEW_TOTALPORTFOLIO",p_data_values,chr_l_fld_value1,p_ms_static_val_d,0);
				}
				else
				{
      			memset(chr_l_fld_value1,APL_NULL_CHAR,201);
      			int_returnval = MS_Rtv_TabVal(p_rownum,"TOTAL_PORTFOLIO",p_data_values,
         	            chr_l_fld_value1,p_ms_static_val_d,0);	
				}
      		if(int_returnval == APL_SUCCESS)
      		{
      			int_returnval = MS_Rtv_TabVal(p_rownum,"NEGPORT",p_data_values,chr_l_fld_value1_negport,p_ms_static_val_d,0);
					if(strcmp(chr_l_fld_value1_negport,"N")==0)
                   (*p_ms_calc_elm_struct_h)[2].link_tag = (*p_ms_calc_elm_struct_h)[2].link_tag-atof(chr_l_fld_value1);
					else
                   (*p_ms_calc_elm_struct_h)[2].link_tag = (*p_ms_calc_elm_struct_h)[2].link_tag+atof(chr_l_fld_value1);
      		}
				(*p_ms_calc_elm_struct_h)[1].link_tag++;
				(*p_ms_calc_elm_struct_h)[6].link_tag = 0;
      	}
      	memset(chr_l_fld_value1,APL_NULL_CHAR,201);
      	int_returnval = MS_Rtv_TabVal(p_rownum,"SAFEKEEP_POS",p_data_values,
                     chr_l_fld_value1,p_ms_static_val_d,0);
      	if(int_returnval == APL_SUCCESS)
      	{
                   (*p_ms_calc_elm_struct_h)[6].link_tag = (*p_ms_calc_elm_struct_h)[6].link_tag+atof(chr_l_fld_value1);
      	}
		}
		else
		{
			if (APL_FAILURE == MS_Chk_CondPrevMsg(p_rownum,"INSTR_CODE",p_data_values,p_ms_static_val_d,p_newmsg))
      	{
      		memset(chr_l_fld_value1,APL_NULL_CHAR,201);

      		int_returnval = MS_Rtv_TabVal(p_rownum,"LOCSTAT",p_data_values,chr_l_fld_value1,p_ms_static_val_d,0);
				if(strcmp(chr_l_fld_value1,"L")==0)
				{
      			memset(chr_l_fld_value1,APL_NULL_CHAR,201);
      			int_returnval = MS_Rtv_TabVal(p_rownum,"NEW_TOTALPORTFOLIO",p_data_values,chr_l_fld_value1,p_ms_static_val_d,0);
				}
				else
				{
      			memset(chr_l_fld_value1,APL_NULL_CHAR,201);
      			int_returnval = MS_Rtv_TabVal(p_rownum,"TOTAL_PORTFOLIO",p_data_values,
         	            chr_l_fld_value1,p_ms_static_val_d,0);	
				}
      		if(int_returnval == APL_SUCCESS)
      		{
      			int_returnval = MS_Rtv_TabVal(p_rownum,"NEGPORT",p_data_values,chr_l_fld_value1_negport,p_ms_static_val_d,0);
					if(strcmp(chr_l_fld_value1_negport,"N")==0)
                   (*p_ms_calc_elm_struct_h)[2].link_tag = (*p_ms_calc_elm_struct_h)[2].link_tag-atof(chr_l_fld_value1);
					else
                   (*p_ms_calc_elm_struct_h)[2].link_tag = (*p_ms_calc_elm_struct_h)[2].link_tag+atof(chr_l_fld_value1);
      		}
				(*p_ms_calc_elm_struct_h)[1].link_tag++;
				(*p_ms_calc_elm_struct_h)[6].link_tag = 0;
      	}
      	memset(chr_l_fld_value1,APL_NULL_CHAR,201);
      	int_returnval = MS_Rtv_TabVal(p_rownum,"SAFEKEEP_POS",p_data_values,
                     chr_l_fld_value1,p_ms_static_val_d,0);
      	if(int_returnval == APL_SUCCESS)
      	{
                   (*p_ms_calc_elm_struct_h)[6].link_tag = (*p_ms_calc_elm_struct_h)[6].link_tag+atof(chr_l_fld_value1);
      	}
/* Changes done for ISKB_1621 SWIFT upgradtion*/
//added by sachin for scotia - HOLP tag val was coming as USD1, always
		memset(chr_l_fld_value1,APL_NULL_CHAR,201);
      	int_returnval = MS_Rtv_TabVal(p_rownum,"PORTFOLIO",p_data_values,
                     chr_l_fld_value1,p_ms_static_val_d,0);
      	if(int_returnval == APL_SUCCESS)
      	{
			printf("Printf populating value");
                   (*p_ms_calc_elm_struct_h)[13].link_tag = (*p_ms_calc_elm_struct_h)[13].link_tag+atof(chr_l_fld_value1);
				  
      	}
//sachin ends
 		}  

  }
  if(strcmp(chr_p_msgno_a,"536") == 0)
  {

       if (APL_SUCCESS == MS_Chk_CondPrevMsg(p_rownum,"CLIENT",p_data_values,p_ms_static_val_d,0))
       {
             if( p_newmsg == 1)
             {
		(*p_ms_calc_elm_struct_h)[0].link_tag++;
             }
       }
       else
       {
		(*p_ms_calc_elm_struct_h)[0].link_tag = 1;
                (*p_ms_calc_elm_struct_h)[1].link_tag = 0;
       }
       

       memset(chr_l_fld_value1,APL_NULL_CHAR,201);
       int_returnval = MS_Rtv_TabVal(p_rownum,"REVERSE",p_data_values,
                     chr_l_fld_value1,p_ms_static_val_d,0);
       strcpy(chr_l_reverse,chr_l_fld_value1);

      

      

       memset(chr_l_fld_value1,APL_NULL_CHAR,201);
       int_returnval = MS_Rtv_TabVal(p_rownum,"DEAL_CD",p_data_values,
                     chr_l_fld_value1,p_ms_static_val_d,0);

       strcpy(chr_l_trcode_a,chr_l_fld_value1);
       memset(chr_l_fld_value1,APL_NULL_CHAR,201);
       memset(chr_l_fld_value1_new,APL_NULL_CHAR,201);
		 
       
       int_returnval = MS_Rtv_TabVal(p_rownum,"FENT_POS",p_data_values,
                     chr_l_fld_value1,p_ms_static_val_d,0);
       strcpy(l_quantity,chr_l_fld_value1);


       if (APL_SUCCESS == MS_Chk_CondPrevMsg(p_rownum,"INSTR_CODE",p_data_values,p_ms_static_val_d,0))
       {
             if( p_newmsg == 1)
	     {
                (*p_ms_calc_elm_struct_h)[1].link_tag++;
      		memset(chr_l_fld_value1,APL_NULL_CHAR,201);
      		int_returnval = MS_Rtv_TabVal(p_rownum,"OPNBAL",p_data_values,
                     chr_l_fld_value1,p_ms_static_val_d,0);
				
      		int_returnval = MS_Rtv_TabVal(p_rownum,"NEW_OPNBAL",p_data_values,
                     chr_l_fld_value1_new,p_ms_static_val_d,0);
      		if(int_returnval == APL_SUCCESS)
      		{
					if(atof(chr_l_fld_value1) == atof(chr_l_fld_value1_new))
                   (*p_ms_calc_elm_struct_h)[10].link_tag = atof(chr_l_fld_value1);
					else
                   (*p_ms_calc_elm_struct_h)[10].link_tag = atof(chr_l_fld_value1_new);
      		}

		if((*p_ms_calc_elm_struct_h)[0].link_tag > 1)
                {
		
                MS_Rtv_ComputedVal("CLOSING_BAL",p_ms_calc_elm_struct_h,&dbl_l_calc_val,p_calc_ctr);
                (*p_ms_calc_elm_struct_h)[10].link_tag = dbl_l_calc_val; 
      		} 
	     }
       }
       else
       {
                (*p_ms_calc_elm_struct_h)[1].link_tag++;
      		memset(chr_l_fld_value1,APL_NULL_CHAR,201);
      		int_returnval = MS_Rtv_TabVal(p_rownum,"OPNBAL",p_data_values,
                     chr_l_fld_value1,p_ms_static_val_d,0);
				
      		int_returnval = MS_Rtv_TabVal(p_rownum,"NEW_OPNBAL",p_data_values,
                     chr_l_fld_value1_new,p_ms_static_val_d,0);
      		if(int_returnval == APL_SUCCESS)
      		{
					if(atof(chr_l_fld_value1) == atof(chr_l_fld_value1_new))
                   (*p_ms_calc_elm_struct_h)[10].link_tag = atof(chr_l_fld_value1);
					else
                   (*p_ms_calc_elm_struct_h)[10].link_tag = atof(chr_l_fld_value1_new);
      		}
	      
       }

      
	   
       if (APL_SUCCESS == MS_Chk_CondPrevMsg(p_rownum,"ACC_INSTR_CODE",p_data_values,p_ms_static_val_d,0))
       {
         (*p_ms_calc_elm_struct_h)[12].link_tag = (*p_ms_calc_elm_struct_h)[11].link_tag;
         (*p_ms_calc_elm_struct_h)[12].PREV_VAL = (*p_ms_calc_elm_struct_h)[11].PREV_VAL;
           if((*p_ms_calc_elm_struct_h)[0].link_tag > 1 && p_newmsg == 1)
           {
	         (*p_ms_calc_elm_struct_h)[11].PREV_VAL = (*p_ms_calc_elm_struct_h)[10].link_tag  ;
           }
	   
 
	   if((strcmp(chr_l_trcode_a,"1") == 0 ||
             strcmp(chr_l_trcode_a,"3") == 0 || strcmp(chr_l_trcode_a,"7") == 0) && (strcmp(chr_l_reverse,"N")==0))

           	(*p_ms_calc_elm_struct_h)[11].PREV_VAL = (*p_ms_calc_elm_struct_h)[11].PREV_VAL - atof(l_quantity);
	   else
      if((strcmp(chr_l_trcode_a,"2") == 0 ||strcmp(chr_l_trcode_a,"4") == 0 ||strcmp(chr_l_trcode_a,"8") == 0) && (strcmp(chr_l_reverse,"N")==0))
           	(*p_ms_calc_elm_struct_h)[11].PREV_VAL = (*p_ms_calc_elm_struct_h)[11].PREV_VAL + atof(l_quantity);
     if((strcmp(chr_l_trcode_a,"1") == 0 ||
             strcmp(chr_l_trcode_a,"3") == 0 || strcmp(chr_l_trcode_a,"7") == 0) && (strcmp(chr_l_reverse,"Y")==0))
           (*p_ms_calc_elm_struct_h)[11].PREV_VAL = (*p_ms_calc_elm_struct_h)[11].PREV_VAL + atof(l_quantity);
     else
      if((strcmp(chr_l_trcode_a,"2") == 0 ||strcmp(chr_l_trcode_a,"4") == 0 || strcmp(chr_l_trcode_a,"8") == 0) && (strcmp(chr_l_reverse,"Y")==0))
            (*p_ms_calc_elm_struct_h)[11].PREV_VAL = (*p_ms_calc_elm_struct_h)[11].PREV_VAL - atof(l_quantity);
       }
       else
       {
         (*p_ms_calc_elm_struct_h)[12].link_tag = (*p_ms_calc_elm_struct_h)[11].link_tag;
         (*p_ms_calc_elm_struct_h)[12].PREV_VAL = (*p_ms_calc_elm_struct_h)[11].PREV_VAL;
	   
	   if((strcmp(chr_l_trcode_a,"1") == 0 ||
             strcmp(chr_l_trcode_a,"3") == 0 || strcmp(chr_l_trcode_a,"7") == 0)&& (strcmp(chr_l_reverse,"N")==0))
	     (*p_ms_calc_elm_struct_h)[11].PREV_VAL = (*p_ms_calc_elm_struct_h)[10].link_tag  - atof(l_quantity);
      else
        if((strcmp(chr_l_trcode_a,"2") == 0 ||strcmp(chr_l_trcode_a,"4") == 0 ||strcmp(chr_l_trcode_a,"8") == 0) && (strcmp(chr_l_reverse,"N")==0))
	     (*p_ms_calc_elm_struct_h)[11].PREV_VAL = (*p_ms_calc_elm_struct_h)[10].link_tag + atof(l_quantity);
	   if((strcmp(chr_l_trcode_a,"1") == 0 ||
             strcmp(chr_l_trcode_a,"3") == 0 || strcmp(chr_l_trcode_a,"7") == 0)&& (strcmp(chr_l_reverse,"Y")==0))
         (*p_ms_calc_elm_struct_h)[11].PREV_VAL = (*p_ms_calc_elm_struct_h)[10].link_tag + atof(l_quantity);
      else
       if ((strcmp(chr_l_trcode_a,"2") == 0 ||strcmp(chr_l_trcode_a,"4") == 0 || strcmp(chr_l_trcode_a,"8") == 0) && (strcmp(chr_l_reverse,"Y")==0))
         (*p_ms_calc_elm_struct_h)[11].PREV_VAL = (*p_ms_calc_elm_struct_h)[10].link_tag  - atof(l_quantity);
       	
       }
      
       


	 memset(chr_l_weekly_stm,APL_NULL_CHAR,2);
    memset(chr_l_fld_value1,APL_NULL_CHAR,201);
  	 int_returnval = MS_Rtv_TabVal(p_rownum,"WEEKLY_STM",p_data_values,
      	            chr_l_fld_value1,p_ms_static_val_d,0);
	 strncpy(chr_l_weekly_stm,chr_l_fld_value1,2);
	 chr_l_weekly_stm[1]=APL_NULL_CHAR;
	
	if (strcmp(chr_l_weekly_stm,"Y")==0)
	{
		if (APL_FAILURE == MS_Chk_ISOCondPrevMsg(p_rownum,"INSTR_CODE",p_data_values,p_ms_static_val_d,0))
		{
			    memset(chr_l_fld_value1,APL_NULL_CHAR,201);
   	    	 int_returnval = MS_Rtv_TabVal(p_rownum,"CLIENT",p_data_values,
         	            chr_l_fld_value1,p_ms_static_val_d,0);
				memset(chr_l_client_weektxnbal,APL_NULL_CHAR,11);
				strncpy(chr_l_client_weektxnbal,chr_l_fld_value1,11);
				strcat(chr_l_client_weektxnbal,APL_NULL_STRING);
		
		     memset(chr_l_fld_value1,APL_NULL_CHAR,201);
       	  int_returnval = MS_Rtv_TabVal(p_rownum,"INSTR_CODE",p_data_values,
                     chr_l_fld_value1,p_ms_static_val_d,0);	
				memset(chr_l_instrcode_weektxnbal,APL_NULL_CHAR,11);
				strncpy(chr_l_instrcode_weektxnbal,chr_l_fld_value1,11);
				strcat(chr_l_instrcode_weektxnbal,APL_NULL_STRING);
			
				memset(chr_l_date_time,APL_NULL_CHAR,APL_DATE_LEN);
     			int_returnval = CO_RtvSysDt(chr_l_date_time,l_debug_info_ptr);
     			if(int_returnval == APL_FAILURE)
     			{
          		APL_GOBACK_FAIL
     			}
				int_l_closbal_weektxn=0;
				int_l_closbal_weektxn =(*p_ms_calc_elm_struct_h)[11].PREV_VAL;

				EXEC SQL DELETE FROM DL_WEEKTXNBAL
								 WHERE CLIENT=:chr_l_client_weektxnbal
								 AND INSTR_CODE=:chr_l_instrcode_weektxnbal ;
				IS_ANY_ORA_ERROR;

				EXEC SQL INSERT INTO  DL_WEEKTXNBAL
						VALUES(:chr_l_client_weektxnbal,
								 :chr_l_instrcode_weektxnbal,
								 :chr_l_date_time,:int_l_closbal_weektxn);
				
				IS_ANY_ORA_ERROR;
			}
			
		}

  }
  if(strcmp(chr_p_msgno_a,"537") == 0)
  {

       if (APL_SUCCESS == MS_Chk_CondPrevMsg(p_rownum,"CLIENT",p_data_values,p_ms_static_val_d,0))
       {
             if( p_newmsg == 1)
		(*p_ms_calc_elm_struct_h)[0].link_tag++;
       }
       else
       {
		(*p_ms_calc_elm_struct_h)[0].link_tag = 1;
		(*p_ms_calc_elm_struct_h)[1].link_tag = 0;
       }

       if (APL_FAILURE  == MS_Chk_CondPrevMsg(p_rownum,"INSTR_CODE",p_data_values,p_ms_static_val_d,0))
		(*p_ms_calc_elm_struct_h)[1].link_tag++;
       else
       {
            if(p_newmsg == 1)
		(*p_ms_calc_elm_struct_h)[1].link_tag++;
       }

      memset(chr_l_fld_value1,APL_NULL_CHAR,201);
      int_returnval = MS_Rtv_TabVal(p_rownum,"TR3TOT",p_data_values,
                     chr_l_fld_value1,p_ms_static_val_d,0);
      if(int_returnval == APL_FAILURE)
      {
         fprintf(p_errfile,"Failure in reading data h_file for total deliver amount\n");
         APL_GOBACK_FAIL
      }

      (*p_ms_calc_elm_struct_h)[3].link_tag = (*p_ms_calc_elm_struct_h)[3].link_tag + atof(chr_l_fld_value1);
      memset(chr_l_fld_value1,APL_NULL_CHAR,201);
      int_returnval = MS_Rtv_TabVal(p_rownum,"TR4TOT",p_data_values,
                     chr_l_fld_value1,p_ms_static_val_d,0);
      if(int_returnval == APL_FAILURE)
      {
         fprintf(p_errfile,"Failure in reading data h_file for total receive amount\n");
         APL_GOBACK_FAIL
      }
      (*p_ms_calc_elm_struct_h)[4].link_tag = (*p_ms_calc_elm_struct_h)[4].link_tag + atof(chr_l_fld_value1);
      (*p_ms_calc_elm_struct_h)[5].link_tag = (*p_ms_calc_elm_struct_h)[3].link_tag - (*p_ms_calc_elm_struct_h)[4].link_tag;
        
  }
  if(strcmp(chr_p_msgno_a,"DRT") ==0)
  {
    
      if (APL_SUCCESS == MS_Chk_CondPrevMsg(p_rownum,"CLIENT",p_data_values,p_ms_static_val_d,0))
      {
             if( p_newmsg == 1)
		(*p_ms_calc_elm_struct_h)[0].link_tag++;
      }
      else
		(*p_ms_calc_elm_struct_h)[0].link_tag = 1;
     if(p_newmsg == 1)
     {
      memset(chr_l_fld_value1,APL_NULL_CHAR,201);
      int_returnval = MS_Rtv_TabVal(p_rownum,"OPNBAL",p_data_values,
                     chr_l_fld_value1,p_ms_static_val_d,0);
      if(int_returnval == APL_FAILURE)
      {
         fprintf(p_errfile,"Failure in reading data h_file for opening balance\n");
         APL_GOBACK_FAIL
      }
      (*p_ms_calc_elm_struct_h)[6].link_tag = atof(chr_l_fld_value1);
        
     }
      if (APL_FAILURE== MS_Chk_CondPrevMsg(p_rownum,"INSTR_CODE",p_data_values,p_ms_static_val_d,0))
      {
      memset(chr_l_fld_value1,APL_NULL_CHAR,201);
      int_returnval = MS_Rtv_TabVal(p_rownum,"OPNBAL",p_data_values,
                     chr_l_fld_value1,p_ms_static_val_d,0);
      if(int_returnval == APL_FAILURE)
      {
         fprintf(p_errfile,"Failure in reading data h_file for opening balance\n");
         APL_GOBACK_FAIL
      }
      (*p_ms_calc_elm_struct_h)[6].link_tag = atof(chr_l_fld_value1);
      }
     memset(chr_l_fld_value1,APL_NULL_CHAR,201);
     int_returnval = MS_Rtv_TabVal(p_rownum,"DEAL_CD",p_data_values,
                     chr_l_fld_value1,p_ms_static_val_d,0);
     if(int_returnval == APL_FAILURE)
     {
         fprintf(p_errfile,"Failure in reading data h_file for trade h_code\n");
         APL_GOBACK_FAIL
     }
     strcpy(chr_l_trcode_a,chr_l_fld_value1);
     memset(chr_l_fld_value1,APL_NULL_CHAR,201);
     int_returnval = MS_Rtv_TabVal(p_rownum,"QTY",p_data_values,
                     chr_l_fld_value1,p_ms_static_val_d,0);
     if(int_returnval == APL_FAILURE)
     {
         fprintf(p_errfile,"Failure in reading data h_file for quantity\n");
         APL_GOBACK_FAIL
     }
     strcpy(l_quantity,chr_l_fld_value1);
     if(strcmp(chr_l_trcode_a,"1")== 0 ||
        strcmp(chr_l_trcode_a,"3")==0 ||
			strcmp(chr_l_trcode_a,"7")==0)
     {
         (*p_ms_calc_elm_struct_h)[6].link_tag = (*p_ms_calc_elm_struct_h)[6].link_tag - atof(l_quantity);
     }
     else
         (*p_ms_calc_elm_struct_h)[6].link_tag = (*p_ms_calc_elm_struct_h)[6].link_tag + atof(l_quantity);

  }
	
  if(strncmp(chr_p_msgno_a,"54x",3) == 0 ) 
  {
       if (APL_SUCCESS == MS_Chk_CondPrevMsg(p_rownum,"CLIENT",p_data_values,p_ms_static_val_d,0))
       {
                if ( p_newmsg == 1)
		(*p_ms_calc_elm_struct_h)[0].link_tag++;
       }
       else
		(*p_ms_calc_elm_struct_h)[0].link_tag = 1;
  }

  if(strncmp(chr_p_msgno_a,"586",3) == 0 ) 
  {
       if (APL_SUCCESS == MS_Chk_CondPrevMsg(p_rownum,"CLIENT",p_data_values,p_ms_static_val_d,0))
       {
                if ( p_newmsg == 1)
		(*p_ms_calc_elm_struct_h)[0].link_tag++;
       }
       else
		 {
                if ( p_newmsg == 1)
			(*p_ms_calc_elm_struct_h)[0].link_tag = 1;
		 }
  }

  if(strncmp(chr_p_msgno_a,"538",3) == 0 ) 
  {
       if (APL_SUCCESS == MS_Chk_CondPrevMsg(p_rownum,"CLIENT",p_data_values,p_ms_static_val_d,0))
       {
                if ( p_newmsg == 1)
		(*p_ms_calc_elm_struct_h)[0].link_tag++;
       }
       else
		 {
                if ( p_newmsg == 1)
		(*p_ms_calc_elm_struct_h)[0].link_tag = 1;
		 }
  }


  if(strcmp(chr_p_msgno_a,"599FX") == 0 ||
     strcmp(chr_p_msgno_a,"599PFR") == 0)
  {
       if (APL_SUCCESS == MS_Chk_CondPrevMsg(p_rownum,"CLIENT",p_data_values,p_ms_static_val_d,0))
       {
                if ( p_newmsg == 1)
		(*p_ms_calc_elm_struct_h)[0].link_tag++;
       }
       else
		(*p_ms_calc_elm_struct_h)[0].link_tag = 1;
  }
  
  if(strcmp(chr_p_msgno_a,"512_E") == 0 ||
     strcmp(chr_p_msgno_a,"512_C") == 0 ||
	  strcmp(chr_p_msgno_a,"599EXP") == 0)
  {
       if (APL_SUCCESS == MS_Chk_CondPrevMsg(p_rownum,"CLIENT",p_data_values,p_ms_static_val_d,0))
       {
                if ( p_newmsg == 1)
		(*p_ms_calc_elm_struct_h)[0].link_tag++;
       }
       else
		(*p_ms_calc_elm_struct_h)[0].link_tag = 1;
  }
APL_GOBACK_SUCCESS
RETURN_SUCCESS:
        free(chr_l_ccy_end_t);
        CO_ProcMonitor(APL_OUT_FILE,"Exiting successfully  out of MS_Proc_ComputedVal\n",NULL,NULL);

        return APL_SUCCESS;

RETURN_FAILURE:
        free(chr_l_ccy_end_t);
        CO_ProcMonitor(APL_OUT_FILE,"Exiting unsuccesfully out of MS_Proc_ComputedVal\n",NULL,NULL);
        return APL_FAILURE;

}




#define SWIFT_MSG_LENGTH	201
#define MAX_TOKENS			25
#define MAX_TOKEN_LENGTH	50
#define MAX_TOKEN_VAL_LENGTH	50

/* OPT:AIX - Start */
#ifdef LINERR_LENGTH
#undef LINERR_LENGTH
#endif
/* OPT:AIX - End*/

#define LINERR_LENGTH			205


static char chr_token_arr[MAX_TOKENS][MAX_TOKEN_LENGTH+1];
static char chr_token_value_arr[MAX_TOKENS][MAX_TOKEN_VAL_LENGTH+1];

static int int_token_count;             

/* OPT:AIX - Start "const *p_expr/const char *p_cond" changed to "char *p_expr/ char *p_cond" */

int MS_Rtv_ISOTokens(char *p_expr,int p_val_rec, FILE *p_data_values,
							MS_STATIC_VAL *p_ms_static_val_d);
int MS_Chk_TagCond( char *p_cond, int p_val_rec, FILE *p_data_values,
						MS_STATIC_VAL *p_ms_static_val_d);

/*"const char *expression" changed to "char *expression"  */
int MS_Chk_ISOMsgSyntax( char *expression);

/* OPT:AIX - End */


/*OPT:AIX - In Func MS_Chk_TagCond "const char *p_cond"  changed to "char *p_cond"*/

int MS_Chk_TagCond( char *p_cond, int p_val_rec, FILE *p_data_values,
						MS_STATIC_VAL *p_ms_static_val_d)
{
		int MS_Rcr_EvalCond( char *condition_string);
		char chr_l_expr[SWIFT_MSG_LENGTH+1];
		if(APL_SUCCESS != MS_Chk_ISOMsgSyntax(p_cond) )
		{
			 fprintf(stderr,"Error Checking syntax in processtion MS_Chk_TagCond:"
									"File %s, Line %d\n", __FILE__,__LINE__);
			 CO_ProcMonitor(APL_OUT_FILE,"Returning unsuccessfully  out of MS_Chk_TagCond\n",\
							NULL,NULL);
			 return -1;                
		}
		strcpy(chr_l_expr,p_cond);
		
		/* OPT:AIX - Start "p_cond" Changed to "(char *)p_cond" */
		MS_Rtv_ISOTokens((char *)p_cond,p_val_rec,p_data_values,p_ms_static_val_d);
		/* OPT:AIX - End */

		return  MS_Rcr_EvalCond(chr_l_expr);
}



int MS_Rcr_EvalCond(char *p_expr)
{

	
	int MS_Rtv_ISOExprVal(const char *expression);
	char *MS_Rtv_ISOTokenPos( const char *expression, const char *chr_operator);

	int int_result = 0 ;                       
	char *chr_splitptr=NULL;
	char *chr_left_expr=NULL;
	char *chr_right_expr=NULL;

	
	if( NULL != (chr_splitptr = MS_Rtv_ISOTokenPos( p_expr, "OR" )))
	{
		int Op_len = strlen("OR");
		chr_left_expr= p_expr;                  
		*(chr_splitptr) = '\0';                 

		chr_right_expr = chr_splitptr + Op_len;     
		#ifdef DEBUG_FLAG
			printf("\nEvaluating(OR-left) : %s",chr_left_expr);
		#endif

		int_result = MS_Rcr_EvalCond(chr_left_expr);
		if(0 == int_result)                     
		{
			#ifdef DEBUG_FLAG
				printf("\nEvaluating(OR-right) : %s",chr_right_expr);
			#endif
			return  MS_Rcr_EvalCond(chr_right_expr);
		}
		else
				return int_result;                 
	}


	
	if( NULL != (chr_splitptr = MS_Rtv_ISOTokenPos( p_expr, "AND" )))
	{
		int Op_len = strlen("AND");
		chr_left_expr= p_expr;                   
		*(chr_splitptr) = '\0';                  
 
		chr_right_expr = chr_splitptr + Op_len;      
		#ifdef DEBUG_FLAG
			printf("\nEvaluating(AND-left) : %s",chr_left_expr);
		#endif

		int_result = MS_Rcr_EvalCond(chr_left_expr);
		if(1 == int_result)                      
		{
			#ifdef DEBUG_FLAG
				printf("\nEvaluating(AND-right) : %s",chr_right_expr);
			#endif
			return  MS_Rcr_EvalCond(chr_right_expr); 
		}
		else
			   return int_result;                  
					
	}

	
	{
		char *chr_tail_ptr=NULL;
		while(isspace(*p_expr++));  p_expr--; 
		chr_tail_ptr = p_expr + strlen(p_expr)-1;
		while(isspace(*chr_tail_ptr)&& (chr_tail_ptr > p_expr)) chr_tail_ptr--; 
		*(chr_tail_ptr+1) = '\0';
	}

	
	if( '(' == *p_expr )
	{
		int int_len=strlen(p_expr);

		
		*(p_expr+int_len-1)='\0';                  
		p_expr +=1;

		return MS_Rcr_EvalCond(p_expr);
	}

	

	int_result = MS_Rtv_ISOExprVal(p_expr);
	#ifdef DEBUG_FLAG
		printf(" Result=%d\n",int_result);
	#endif
	return int_result;
}


/* OPT:AIX  "const *p_expr" changed to "char *p_expr" */
int MS_Rtv_ISOTokens(char *p_expr,int p_val_rec, FILE *p_data_values,
							MS_STATIC_VAL *p_ms_static_val_d)
{
	char *chr_l_expr = NULL;
	char chr_tmp_token[ SWIFT_MSG_LENGTH + 1 ] = {0};
	int expr_len = strlen(p_expr);
	int i = 0 , int_found = 0;


	int_token_count = 0 ;



	
	memset(chr_token_arr,'\0', (MAX_TOKENS) * (MAX_TOKEN_LENGTH+1) );
	memset(chr_token_value_arr,'\0', (MAX_TOKENS)* (MAX_TOKEN_VAL_LENGTH+1) );


	chr_l_expr = p_expr;
	while( '\0' != *chr_l_expr )
	{
		if( *chr_l_expr == '{' )                
		{
			chr_l_expr++;         
			if( 1 != sscanf(chr_l_expr,"%[^}]",chr_tmp_token))
			{
				fprintf(stderr,"File: %s , Line: %d - Error reading tokens from the \
							expression\n",__FILE__,__LINE__);
				fprintf(stderr,"%s\n",p_expr);
				//fprintf(stderr,"%*c\n",chr_l_expr-p_expr,'*');
				return APL_FAILURE;                     
			}
			
			chr_l_expr += strlen(chr_tmp_token);     
			int_found = 0;

			
			
			for( i  = int_token_count-1  ; i >= 0  ; i--)
			{
				if(!strncmp(chr_tmp_token,chr_token_arr[i],MAX_TOKEN_LENGTH))
				{
					int_found = 1;                 
					chr_l_expr++;
					break;
				}
			}

			if( 1 == int_found ) continue;       
			if(int_token_count<MAX_TOKENS)
				strncpy(chr_token_arr[int_token_count++],chr_tmp_token,MAX_TOKEN_LENGTH);
			else
			{
				fprintf(stderr,"File: %s , Line: %d - Too Many tokens in the \
							expression\n",__FILE__,__LINE__);
				return APL_FAILURE;            
			}
		}
		chr_l_expr++;
	}

	
	#ifdef DEBUG_FLAG
		printf("The tokens extracetd from the expression are :\n");
	#endif
	for( i = 0 ; i < int_token_count ; i++)
	{

		
		if( 0 == MS_Rtv_TabVal(p_val_rec,chr_token_arr[i],\
										p_data_values,chr_token_value_arr[i],p_ms_static_val_d,0))
		{
			fprintf(stderr,"Error: File :%s , Line: %d - Token \"%s\" not\
						int_found in data h_file\n",__FILE__,__LINE__,chr_token_arr[i]);
			return APL_FAILURE;                       
		}
		#ifdef DEBUG_FLAG
			printf("%d.%s = %s\n",i,chr_token_arr[i],chr_token_value_arr[i]);
		#endif
	}
	#ifdef DEBUG_FLAG
		printf("No of tokens: %d\n\n",int_token_count);
	#endif
	return APL_SUCCESS;                    

}



int MS_Rtv_ISOExprVal(const char *p_expr)
{
	char chr_l_expr[SWIFT_MSG_LENGTH+1]={0};
	char chr_token[SWIFT_MSG_LENGTH+1]={0};
	char chr_operator[SWIFT_MSG_LENGTH+1]={0};
	char chr_value[SWIFT_MSG_LENGTH+1]={0};
	char chr_req_value[MAX_TOKEN_VAL_LENGTH+1] ={0};
	int i = 0;
	strncpy(chr_l_expr,p_expr,SWIFT_MSG_LENGTH);

	
	while( '\0' != chr_l_expr[i])
	{
		switch(chr_l_expr[i])
		{
			case '{' :
			case '[' :
			case '}' : 
							chr_l_expr[i] = ' '; break;
			case ']' : break;
			default  : break;
		}
		i++;
	}
	sscanf(chr_l_expr," %s %s %[^]]",chr_token,chr_operator,chr_value);

	
	for(i=0; i < int_token_count ; i++)
		if(!strncmp(chr_token,chr_token_arr[i],MAX_TOKEN_LENGTH))
		{
			strncpy(chr_req_value,chr_token_value_arr[i],MAX_TOKEN_VAL_LENGTH);
			break;
		}

	if( i == int_token_count ) return -1;      

	#ifdef DEBUG_FLAG
		printf(" =>  %s %s %s\t ",chr_req_value,chr_operator,chr_value);
	#endif

	if(!strcmp(chr_operator,"="))              
  { // AIX - Warnings removal
	if(!strncmp(chr_value,chr_req_value,MAX_TOKEN_VAL_LENGTH))
		return  APL_SUCCESS;
	else
		return  APL_FAILURE;
  }

	if(!strcmp(chr_operator,"!="))              
  { // AIX - Warnings removal
	if(strncmp(chr_value,chr_req_value,MAX_TOKEN_VAL_LENGTH))
		return  APL_SUCCESS;
	else
		return  APL_FAILURE;
  }

	if(!strcmp(chr_operator,"=="))              
  { // AIX - Warnings removal
	if(atof(chr_value) == atof(chr_req_value))
		return  APL_SUCCESS;
	else
		return  APL_FAILURE;
  }

	if(!strcmp(chr_operator,"<"))              
  { // AIX - Warnings removal
	if(atof(chr_value) > atof(chr_req_value))
		return  APL_SUCCESS;
	else
		return  APL_FAILURE;
  }

	if(!strcmp(chr_operator,">"))              
  { // AIX - Warnings removal
	if(atof(chr_value) < atof(chr_req_value))
		return  APL_SUCCESS;
	else
		return  APL_FAILURE;
  }

	if(!strcmp(chr_operator,"<="))              
  { // AIX - Warnings removal
	if(atof(chr_value) >= atof(chr_req_value))
		return  APL_SUCCESS;
	else
		return  APL_FAILURE;
  }

	if(!strcmp(chr_operator,">="))              
  { // AIX - Warnings removal
	if(atof(chr_value) <= atof(chr_req_value))
		return  APL_SUCCESS;
	else
		return  APL_FAILURE;
  }

	if(!strcmp(chr_operator,"!=="))              
  { // AIX - Warnings removal
	if(atof(chr_value) != atof(chr_req_value))
		return  APL_SUCCESS;
	else
		return  APL_FAILURE;
  }

	return -1;                               
}




char *MS_Rtv_ISOTokenPos( const char *p_expr, const char *p_token)
{
		int int_ctr = 0;                          
		char *int_result = NULL;                   
		char *chr_exprptr = (char *)p_expr;//Changes done for AIX Migration
		int tok_len = strlen(p_token);        
		char chr_tmp_val[100]={0};
		while( *chr_exprptr != '\0' )
		{
			while( isspace(*chr_exprptr) )
					chr_exprptr++;                   
			if( '\0' == *chr_exprptr ) break;
			switch(*chr_exprptr)
			{
				case '(' :
				case '{' :
				case '[' :
								int_ctr++;
								break;
				case ')' :
				case '}' :
				case ']' :
								int_ctr--;
								break;
				default  :
								break;
		  } 

			if( 0 == int_ctr )                     
			if( *chr_exprptr == p_token[0] )       
			{
				strncpy(chr_tmp_val,chr_exprptr,tok_len); 
				if(0==strncmp(p_token,chr_tmp_val,tok_len) )  
				{
						int_result = chr_exprptr;
						break;
				}
			}
			chr_exprptr++;

		} 

		return int_result;
}
	
/* OPT:AIX - Start -In Func MS_Chk_ISOMsgSyntax  "const  char *p_expression" changed to " char *p_expression" */

int MS_Chk_ISOMsgSyntax( char *p_expression)
{
	int int_result = 1;    
	int int_stack_ptr = 0;
	char chr_ch;           
	/* OPT:AIX - Start "const char *chr_t_l_expr" changed to "char *chr_t_l_expr" */
	char *chr_t_l_expr;
	/* OPT:AIX - End */
	char chr_stack[SWIFT_MSG_LENGTH+1];
	char *chr_l_expr = chr_t_l_expr = (char *) calloc( strlen(p_expression)+1,sizeof(char) );
	if( NULL == chr_l_expr)
	{
		fprintf(stderr,"\nIn h_file: %s ,h_line :%d -\
					Can not allocate Enough Memory\n",__FILE__,__LINE__);
		return -1;       
	}

	

	strcpy(chr_l_expr,p_expression);
	while(isspace(*chr_l_expr)) chr_l_expr++;

	switch( *chr_l_expr )
	{
		case '(' :
		case '{' :
						break;           
		default  : 
						int_result  = APL_FAILURE;  
						break;
	}

	
	while( ('\0' != *chr_l_expr) && ( APL_FAILURE != int_result))
	{
		switch( *chr_l_expr )
		{
			case '(' :
			case '{' :
			case '[' :
							chr_stack[++int_stack_ptr] = *chr_l_expr;
							break;
			case ')' :
							if ( '(' != chr_stack[int_stack_ptr--])
								int_result = APL_FAILURE;
							break;
			case '}' :
							if ( '{' != chr_stack[int_stack_ptr--])
								int_result = APL_FAILURE;
							break;
			case ']' :
							if ( '[' != chr_stack[int_stack_ptr--])
								int_result = APL_FAILURE;
							break;
			default  :
							break;
		}
		chr_l_expr++;
	}


	if( int_result != APL_FAILURE )
  { // AIX - Warnings removal
		if(int_stack_ptr != 0) 
       int_result = APL_FAILURE;
		else 
       int_result = APL_SUCCESS;
  }

	/* OPT:AIX - Start - "free(chr_t_l_expr)" changed to "free((char *)chr_t_l_expr)" */

	free((char *)chr_t_l_expr);

	/* OPT:AIX - End*/

	return int_result;
}




void MS_Proc_Round(char *chr_p_msgno_a,double chr_p_val,char *f_val,char p_print_code,char *p_currencycode,char p_swftlx,FILE *p_errfile)
{

int h_dec_len = 0;
char chr_fchar[7]; /** Added By Sana for SIT issue fix -- Retro from SCOTIA **/
char chr_l_val[15] = APL_NULL_STRING; /*Added FOr AIX Migration to remove junk values*/
char fsign[20]= APL_NULL_STRING;



char chr_h_main_func_area[21], chr_h_sub_func[21], chr_h_field_val[21];
int int_h_exists = 0;
memset(chr_h_main_func_area,APL_NULL_CHAR,21);
memset(chr_h_sub_func,APL_NULL_CHAR,21);
memset(chr_h_field_val,APL_NULL_CHAR,21);
memset(fsign,APL_NULL_CHAR,20);
strcpy(chr_h_main_func_area, "MSG_FORMATTER");
strcpy(chr_h_sub_func, "QTY_LENGTH");
strcpy(chr_h_field_val, "6");



            if(p_print_code  == 'A')
            {
               EXEC SQL SELECT DEC_LEN INTO :h_dec_len
                        FROM  DL_CURRENCY
                        WHERE currency_cd = :p_currencycode;

               if(sqlca.sqlcode < 0 || sqlca.sqlcode == 1403)
               {
                   fprintf(p_errfile,"Error in accessing currency table for %s\n",p_currencycode); 
               }
					h_dec_len =2; 

            }
            else if(p_print_code  == 'Q')
				{
					

               if(APL_FAILURE==CO_Chk_SplVal(chr_h_main_func_area,chr_h_sub_func,chr_h_field_val,&int_h_exists,NULL))
               {
                  CO_ProcMonitor(p_errfile,"Error in MS_Proc_Round Calling CO_Chk_SplVal\n",NULL,NULL);
                  int_h_exists=0;
               }
               if(int_h_exists)
               {
                  h_dec_len=6;
               }
					// Chirag add for ISKB 644 Stmt Of Holding & Stmt Of Transaction shld display qty in decimal
					else if((strncmp(chr_p_msgno_a,"535",3) == 0 || strncmp(chr_p_msgno_a,"536",3) == 0)  )
					{
						Alert("In MSG 535 & 536 block....Chirag \n");
						EXEC SQL SELECT FIELD_VAL INTO :h_dec_len
									FROM PRO_GSSPLVAL
									WHERE MAIN_FUN = 'QTY_LEN_SWFT'
									AND SUB_PROCESS = 'MSG_535_536'
									AND NATION = 'IN';

						if (sqlca.sqlcode < 0 || sqlca.sqlcode == 1403)
						{
							Alert("Error occured in setup for quantity decimal length\n");
							fprintf(p_errfile,"Error in accessing setup for quantity decimal length\n");
						}
						
					}
					// Chirag add for ISKB 644 Stmt Of Holding & Stmt Of Transaction shld display qty in decimal
               else
               {
					EXEC SQL SELECT QTY_DEC_LEN INTO :h_dec_len
					FROM  MT_CORE_SYS_PARAMS;

					if (sqlca.sqlcode < 0 || sqlca.sqlcode == 1403)
					{
						fprintf(p_errfile,"Error in accessing setup for quantity decimal length\n");
					}
					}

            }
            else if(p_print_code  == 'R')
	    {
		h_dec_len = atoi(p_currencycode);
	    }
            if(p_print_code == 'N')
		strcpy(chr_fchar,"%lf");
	    else/*Added For AIX*/
	     {
            	sprintf(chr_fchar,"%s%d%s","%.",h_dec_len,"lf");
	        chr_fchar[strlen(chr_fchar)]=APL_NULL_CHAR;	
	     }	
            memset(chr_l_val,'\0',sizeof(chr_l_val));
	    if(strcmp(chr_p_msgno_a,"DRT") == 0)
            	sprintf(chr_l_val,chr_fchar,chr_p_val);
	    else
		 {
			 Alert("b level 1  formater ************************");
			fflush(stdout);
			 if(p_swftlx!='E')
			 {
				 Alert("before formater ************************");
				 fflush(stdout); 
				 if (chr_p_val < 0 && strncmp(chr_p_msgno_a,"535",3) != 0 ) /*** Negative Dnyanesh SIGN ***/
				 {
					 strcpy(fsign,"N");
					 sprintf(chr_l_val,chr_fchar,fabs(chr_p_val));				
					 strcat(fsign , chr_l_val);
					 memset(chr_l_val,APL_NULL_CHAR,15);
					 strcpy(chr_l_val,fsign);
					 Alert("in formater ************************");
				 	fflush(stdout);
				 }
				 else
				 {
					 sprintf(chr_l_val,chr_fchar,fabs(chr_p_val));
				 }
			 }
			 else
			{
            			memset(chr_l_val,APL_NULL_CHAR,sizeof(chr_l_val));
				 sprintf(chr_l_val,chr_fchar,chr_p_val);
			}
		 }

	
	    if(p_print_code != ' ' && p_swftlx == 'T')
		strcpy(f_val,chr_l_val);
            else if(p_print_code != ' ')
		{
			fflush(stdout);
            		MS_Proc_SWFTForm(chr_l_val,f_val);
			fflush(stdout);
		}
            else
		strcpy(f_val,chr_l_val);
		
		Alert("Finally ------ f_val in MS_Proc_Round = |%s|",f_val);
		fflush(stdout);

 return; 
}

int MS_Proc_MsgEnd(MS_TAG_ELM_STRUCT_H **p_ms_tag_elm_struct_h,int int_tag_ctr,int p_rownum,MS_VAL_ELM_STRUCT_H **p_ms_val_elm_struct_h,
               MS_STATIC_VAL *p_ms_static_val_d,MS_CALC_ELM_STRUCT_H **p_ms_calc_elm_struct_h,int p_newmsg,FILE *l_data_values,
               int p_val_ctr,char *p_msg_no,char *p_txn_msg,FILE *p_errfile, DEBUG_INFO_STRUCT_H **l_debug_info_ptr)
{
int i=0,j=p_val_ctr,k=0;
double dbl_l_calc_val = 0;

char *int_l_temp=NULL,chr_l_page[11];
char chr_l_536ficl_rep_ind='Y';	

char chr_l_client_a[APL_CLIENT_LENGTH],chr_l_fld_value1[201],dbl_l_amount_a[201],chr_l_dbind[30];
char chr_l_domciti_flg[201] = APL_NULL_STRING;
short int_l_cond=0;
int int_returnval=0;


memset(chr_l_page,APL_NULL_CHAR,11);

memset(chr_l_client_a,APL_NULL_CHAR,APL_CLIENT_LENGTH);
memset(chr_l_fld_value1,APL_NULL_CHAR,201);
memset(dbl_l_amount_a,APL_NULL_CHAR,201);
memset(chr_l_dbind,APL_NULL_CHAR,30);


    for(i=0;i<int_tag_ctr;i++)
    {
							
	if((strcmp((*p_ms_tag_elm_struct_h)[i].msg_tag,"28E") == 0) && (strcmp((*p_ms_tag_elm_struct_h)[i].info_elem,"PAGENO") == 0))
        {
           if(strcmp(p_msg_no,"535") == 0)
              strcpy(chr_l_client_a,"SUBACCOUNT");
           else
              strcpy(chr_l_client_a,"CLIENT");   
           if( APL_FAILURE == MS_Chk_CondPrevMsg(p_rownum,chr_l_client_a,l_data_values,p_ms_static_val_d,p_newmsg))
           {
               j=p_val_ctr;
               while(j>=0)
               {
		  if((strcmp((*p_ms_val_elm_struct_h)[j].msg_tag,"28E") == 0) && ((*p_ms_tag_elm_struct_h)[i].identity_no == (*p_ms_val_elm_struct_h)[j].identity_no))
		  {
                      int_l_temp = strchr((*p_ms_val_elm_struct_h)[j].h_data_val,'/');
                      memset(chr_l_page,APL_NULL_CHAR,11);
							 if (int_l_temp != NULL)
                      		strncpy(chr_l_page,(*p_ms_val_elm_struct_h)[j].h_data_val,strlen((*p_ms_val_elm_struct_h)[j].h_data_val) - strlen(int_l_temp));
							 else
                      		strncpy(chr_l_page,(*p_ms_val_elm_struct_h)[j].h_data_val,strlen((*p_ms_val_elm_struct_h)[j].h_data_val));
							 strcat(chr_l_page,"\0");
							 if((*p_ms_calc_elm_struct_h)[0].link_tag > 1)
								strcat(chr_l_page,"/LAST");
							 else
								strcat(chr_l_page,"/ONLY");
                      
                      strcpy((*p_ms_val_elm_struct_h)[j].h_data_val,chr_l_page);
							
                      break;	
		  }
		  j--;
               }
           }
	   
        }
	if((strcmp((*p_ms_tag_elm_struct_h)[i].msg_tag,"72") == 0) && (strcmp((*p_ms_tag_elm_struct_h)[i].info_elem,"PAGENO") == 0))
        {
           if(strcmp(p_msg_no,"535") == 0)
              strcpy(chr_l_client_a,"SUBACCOUNT");
           else
              strcpy(chr_l_client_a,"CLIENT");   
           if( APL_FAILURE == MS_Chk_CondPrevMsg(p_rownum,chr_l_client_a,l_data_values,p_ms_static_val_d,p_newmsg))
           {
               j=p_val_ctr;
               while(j>=0)
               {
		  if((strcmp((*p_ms_val_elm_struct_h)[j].msg_tag,"72") == 0) && ((*p_ms_tag_elm_struct_h)[i].identity_no == (*p_ms_val_elm_struct_h)[j].identity_no))
		  {
                      if( strstr( (*p_ms_val_elm_struct_h)[j].h_data_val,"/PG/") != NULL)
                      {
                          strcat((*p_ms_val_elm_struct_h)[j].h_data_val,"L");
                          break;	
                      }
		  }
		  j--;
               }
           }
	   
        }
	if(strcmp((*p_ms_tag_elm_struct_h)[i].msg_tag,"PGC") == 0)
        {
               j=p_val_ctr;
               while(j>=0)
               {
		  if((strcmp((*p_ms_val_elm_struct_h)[j].msg_tag,"PGC") == 0) && ((*p_ms_tag_elm_struct_h)[i].identity_no == (*p_ms_val_elm_struct_h)[j].identity_no))
		  {
		
                   strcpy((*p_ms_val_elm_struct_h)[j].msg_tag,"");
                   (*p_ms_val_elm_struct_h)[j].head_cont_newline = 'N';
		   if((*p_ms_calc_elm_struct_h)[0].link_tag == 1)
                     strcpy((*p_ms_val_elm_struct_h)[j].h_data_val,"");
                   else if((*p_ms_calc_elm_struct_h)[0].link_tag > 1)
                   {
                     strcpy((*p_ms_val_elm_struct_h)[j].h_data_val,"FOLLOWING FROM PAGE ");
                     strcat((*p_ms_val_elm_struct_h)[j].h_data_val,ltoa((*p_ms_calc_elm_struct_h)[0].link_tag-1));
                     strcat((*p_ms_val_elm_struct_h)[j].h_data_val,APL_NULL_STRING);
                   }
                     break;	
		  }
		  j--;
               }
        }
        if(strcmp((*p_ms_tag_elm_struct_h)[i].msg_tag,"PG") == 0)
        {
           strcpy(chr_l_client_a,"CLIENT");
               j=p_val_ctr;
               while(j>=0)
               {
                  if((strcmp((*p_ms_val_elm_struct_h)[j].msg_tag,"PG") == 0) && ((*p_ms_tag_elm_struct_h)[i].identity_no == (*p_ms_val_elm_struct_h)[j].identity_no))
                  {
                   (*p_ms_val_elm_struct_h)[j].head_cont_newline = 'N';
                   strcpy((*p_ms_val_elm_struct_h)[j].msg_tag,"");
                   if( APL_SUCCESS == MS_Chk_CondPrevMsg(p_rownum,chr_l_client_a,l_data_values,p_ms_static_val_d,p_newmsg))
                   {
                     strcpy((*p_ms_val_elm_struct_h)[j].h_data_val,"END OF PAGE ");
                     strcat((*p_ms_val_elm_struct_h)[j].h_data_val,ltoa((*p_ms_calc_elm_struct_h)[0].link_tag));
                     strcat((*p_ms_val_elm_struct_h)[j].h_data_val," (CONTINUE)");
                     strcat((*p_ms_val_elm_struct_h)[j].h_data_val,APL_NULL_STRING);
                     break;
                  }
                  else
                  {
                    strcpy((*p_ms_val_elm_struct_h)[j].h_data_val,"");
                    break;	

                  }
                }
                  j--;
           }
         }
        if(strcmp((*p_ms_tag_elm_struct_h)[i].msg_tag,"TR3") == 0) 
    	{
               memset(chr_l_fld_value1,APL_NULL_CHAR,201);
               int_returnval = MS_Rtv_TabVal(p_rownum,"REF_CCY",l_data_values,chr_l_fld_value1,p_ms_static_val_d,0);

               if(int_returnval == APL_FAILURE)
               {
	  		fprintf(p_errfile,"Failure in reading datafile for %s\n","REF_CCY");
             		APL_GOBACK_FAIL
              }
               j=p_val_ctr;
               while(j>=0)
               {
		     if((strcmp((*p_ms_val_elm_struct_h)[j].msg_tag,"TR3") == 0) && ((*p_ms_tag_elm_struct_h)[i].identity_no == (*p_ms_val_elm_struct_h)[j].identity_no))
        	    {
                       strcpy(dbl_l_amount_a,(*p_ms_val_elm_struct_h)[j].h_data_val);
                       if((*p_ms_calc_elm_struct_h)[3].link_tag > 0)
                       {
                       strcpy((*p_ms_val_elm_struct_h)[j].h_data_val,"TOTAL AMOUNT TO BE CREDITED ");
                       for(k=0;k<=13;k++)
                       	 strcat((*p_ms_val_elm_struct_h)[j].h_data_val," ");
                       strcat((*p_ms_val_elm_struct_h)[j].h_data_val,chr_l_fld_value1);
                       strcat((*p_ms_val_elm_struct_h)[j].h_data_val,dbl_l_amount_a);
                       strcat((*p_ms_val_elm_struct_h)[j].h_data_val,APL_NULL_STRING);
                       }
                       else
                       {
                         strcpy((*p_ms_val_elm_struct_h)[j].h_data_val,"");
                       }
                       break;
                   }
                  j--;
              }
        }
        if(strcmp((*p_ms_tag_elm_struct_h)[i].msg_tag,"TR4") == 0) 
    	{
               memset(chr_l_fld_value1,APL_NULL_CHAR,201);
               int_returnval = MS_Rtv_TabVal(p_rownum-1,"REF_CCY",l_data_values,chr_l_fld_value1,p_ms_static_val_d,1);

               if(int_returnval == APL_FAILURE)
               {
	  		fprintf(p_errfile,"Failure in reading datafile for %s\n","REF_CCY");
             		APL_GOBACK_FAIL
              }
               j=p_val_ctr;
               while(j>=0)
               {
		  if((strcmp((*p_ms_val_elm_struct_h)[j].msg_tag,"TR4") == 0) && ((*p_ms_tag_elm_struct_h)[i].identity_no == (*p_ms_val_elm_struct_h)[j].identity_no))
		  {
                       strcpy(dbl_l_amount_a,(*p_ms_val_elm_struct_h)[j].h_data_val);
                       if((*p_ms_calc_elm_struct_h)[4].link_tag > 0)
                       {
                       strcpy((*p_ms_val_elm_struct_h)[j].h_data_val,"TOTAL AMOUNT TO BE DEBITED ");
                       for(k=0;k<=14;k++)
                       	 strcat((*p_ms_val_elm_struct_h)[j].h_data_val," ");
                       strcat((*p_ms_val_elm_struct_h)[j].h_data_val,chr_l_fld_value1);
                       strcat((*p_ms_val_elm_struct_h)[j].h_data_val,dbl_l_amount_a);
                       strcat((*p_ms_val_elm_struct_h)[j].h_data_val,APL_NULL_STRING);
                       }
                       else
                       {
                         strcpy((*p_ms_val_elm_struct_h)[j].h_data_val,"");
                       }
                       break;
                  }
                  j--;
              }
         }
        if(strcmp((*p_ms_tag_elm_struct_h)[i].msg_tag,"NET") == 0) 
    	{
               memset(chr_l_fld_value1,APL_NULL_CHAR,201);
               int_returnval = MS_Rtv_TabVal(p_rownum-1,"REF_CCY",l_data_values,chr_l_fld_value1,p_ms_static_val_d,1);

               if(int_returnval == APL_FAILURE)
               {
	  		fprintf(p_errfile,"Failure in reading datafile for %s\n","REF_CCY");
             		APL_GOBACK_FAIL
              }
               memset(chr_l_dbind,'\0',30);
               j=p_val_ctr;
               while(j>=0)
               {
		  if((strcmp((*p_ms_val_elm_struct_h)[j].msg_tag,"NET") == 0) && ((*p_ms_tag_elm_struct_h)[i].identity_no == (*p_ms_val_elm_struct_h)[j].identity_no))
		  {
                       strcpy(dbl_l_amount_a,(*p_ms_val_elm_struct_h)[j].h_data_val);
                       if((*p_ms_calc_elm_struct_h)[5].link_tag != 0)
                       {
		       if((*p_ms_calc_elm_struct_h)[5].link_tag > 0)
                          strcpy(chr_l_dbind,"CREDITED");
                       else
                          strcpy(chr_l_dbind,"DEBITED ");
                       strcpy((*p_ms_val_elm_struct_h)[j].h_data_val,"NET AMOUNT TO BE ");
                       strcat((*p_ms_val_elm_struct_h)[j].h_data_val,chr_l_dbind);
                       for(k=0;k<=15;k++)
                       	 strcat((*p_ms_val_elm_struct_h)[j].h_data_val," ");
                       strcat((*p_ms_val_elm_struct_h)[j].h_data_val,chr_l_fld_value1);
                       strcat((*p_ms_val_elm_struct_h)[j].h_data_val,dbl_l_amount_a);
                       strcat((*p_ms_val_elm_struct_h)[j].h_data_val,APL_NULL_STRING);
                       }
                       else
                       {
                         strcpy((*p_ms_val_elm_struct_h)[j].h_data_val,"");
                       }
                       break;
                  }
                  j--;

             }

         } 
         if(strcmp(p_msg_no,"599PFR") == 0)
         {
               j=p_val_ctr;
               while(j>=0)
               {
           	if(strcmp((*p_ms_val_elm_struct_h)[j].msg_tag,"REG") == 0)
            	{
                   (*p_ms_val_elm_struct_h)[j].head_cont_newline = 'N';
           	   strcpy((*p_ms_val_elm_struct_h)[j].msg_tag,"");
           	   break;
                }
                j--;
               }
         }
			
			if(strcmp(p_msg_no,"536") == 0)
			{
				if(chr_l_536ficl_rep_ind == 'Y')	
				{
					if((strcmp((*p_ms_tag_elm_struct_h)[i].msg_tag,"93B") == 0) && ( !strcmp((*p_ms_tag_elm_struct_h)[i].info_elem,":FICL//FAMT/") ||
																				 !strcmp((*p_ms_tag_elm_struct_h)[i].info_elem,":FICL//UNIT/") ))
					{
     					memset(chr_l_fld_value1,APL_NULL_CHAR,201);
     					int_returnval = MS_Rtv_TabVal(p_rownum,"EOF",l_data_values,chr_l_fld_value1,p_ms_static_val_d,0);
     					if(int_returnval == APL_FAILURE)
     					{
	     					fprintf(p_errfile,"Failure in reading datafile for %s\n",(*p_ms_tag_elm_struct_h)[int_tag_ctr].info_elem);
           				APL_GOBACK_FAIL
     					}
					
     					if(strcmp(chr_l_fld_value1,"T" ) != 0)
     					{
							if(APL_SUCCESS == MS_Chk_CondPrevMsg(p_rownum,"ACC_INSTR_CODE",l_data_values,p_ms_static_val_d,0))
							{
               			j=p_val_ctr;
               			while(j>=0)
               			{
		  							if((strcmp((*p_ms_val_elm_struct_h)[j].msg_tag,"93B") == 0) && ((*p_ms_tag_elm_struct_h)[i].identity_no == (*p_ms_val_elm_struct_h)[j].identity_no))
		  							{
                    				if( !strncmp((*p_ms_val_elm_struct_h)[j].h_data_val,":FICL//FAMT/",12) || !strncmp((*p_ms_val_elm_struct_h)[j].h_data_val,":FICL//UNIT/",12) )
                    				{
                       				strncpy((*p_ms_val_elm_struct_h)[j].h_data_val,":INCL//",7);	
											chr_l_536ficl_rep_ind='N';
                       				break;	
                     			}
		  							}
		  							j--;
               			}
							}
						}
					}
				}
			}
    }
	 
    if(strcmp(p_msg_no,MS_MSGNO_54XN02)==0) 
    {
         memset(chr_l_fld_value1,APL_NULL_CHAR,201);
         int_returnval = MS_Rtv_TabVal(p_rownum-1,"DEAL_CD",l_data_values,chr_l_fld_value1,p_ms_static_val_d,1);

         if(int_returnval == APL_FAILURE)
         {
	     		 fprintf(p_errfile,"Failure in reading datafile for %s\n","DEAL_CD");
             APL_GOBACK_FAIL
         }
			
       	if(strcmp(chr_l_fld_value1,"1")==0)
           	strcpy(p_txn_msg,MS_MSGNO_542);
        	else if(strcmp(chr_l_fld_value1,"2")==0)
           	strcpy(p_txn_msg,MS_MSGNO_540);
        	else if(strcmp(chr_l_fld_value1,"3")==0)
           	strcpy(p_txn_msg,MS_MSGNO_543);
        	else if(strcmp(chr_l_fld_value1,"4")==0)
           	strcpy(p_txn_msg,MS_MSGNO_541);
    }  
    else if(strncmp(p_msg_no,"54x",3)==0) 
    {
         memset(chr_l_fld_value1,APL_NULL_CHAR,201);
         int_returnval = MS_Rtv_TabVal(p_rownum-1,"DEAL_CD",l_data_values,chr_l_fld_value1,p_ms_static_val_d,1);

         if(int_returnval == APL_FAILURE)
         {
	     fprintf(p_errfile,"Failure in reading datafile for %s\n","DEAL_CD");
             APL_GOBACK_FAIL
         }
			if(strncmp(p_msg_no,"54x",3)==0)
			{
         	if(strcmp(chr_l_fld_value1,"1")==0)
            	strcpy(p_txn_msg,"546");
         	else if(strcmp(chr_l_fld_value1,"2")==0)
		{
			/* ISKB -1001 - Shailesh  -21-03-2008  Start */
         		int_returnval = MS_Rtv_TabVal(p_rownum-1,"DL_CLASS",l_data_values,chr_l_fld_value1,p_ms_static_val_d,1);
			if(int_returnval == APL_FAILURE)
			{
				fprintf(p_errfile,"Failure in reading datafile for %s\n","DL_CLASS");
				APL_GOBACK_FAIL
			}

			if(strcmp(chr_l_fld_value1, "59") == 0)
				strcpy(p_txn_msg,"545");
			else
			/* ISKB -1001  - Shailesh  - End */
            			strcpy(p_txn_msg,"544");
		}
         	else if(strcmp(chr_l_fld_value1,"3")==0)
            	strcpy(p_txn_msg,"547");
         	else if(strcmp(chr_l_fld_value1,"4")==0)
            	strcpy(p_txn_msg,"545");
			}
    } 
	 
    else if(strcmp(p_msg_no,MS_MSGNO_52X)==0 
				|| strcmp(p_msg_no, MS_SWIFT_BOG_NO)==0
				|| strcmp(p_msg_no,"54BN01")==0) 
    {
         memset(chr_l_fld_value1,APL_NULL_CHAR,201);
         int_returnval = MS_Rtv_TabVal(p_rownum-1,"DEAL_CD",l_data_values,chr_l_fld_value1,p_ms_static_val_d,1);

         if(int_returnval == APL_FAILURE)
         {
	     fprintf(p_errfile,"Failure in reading datafile for %s\n","DEAL_CD");
             APL_GOBACK_FAIL
         }

			

			if (APL_FAILURE == CO_Chk_CntryEnabled(	"MSG_52X",
																"GEN_52X_FOR_BOG",
																&int_l_cond,
																l_debug_info_ptr ))
			{
				APL_GOBACK_FAIL
			}

			if (int_l_cond) 
			{
				

				memset(chr_l_domciti_flg, NULL, 201);
				if (APL_FAILURE == MS_Rtv_TabVal(	p_rownum-1,
																"ISDOMCITI",
																l_data_values,
																chr_l_domciti_flg,
																p_ms_static_val_d,
																1 ))
				{
	     			fprintf(p_errfile,"Failure in reading datafile for %s\n","ISDOMCITI");
             	APL_GOBACK_FAIL
				}

				if (((!strcmp(chr_l_fld_value1,"1")) || (!strcmp(chr_l_fld_value1, "3"))) &&
					 (!strcmp(chr_l_domciti_flg, "Y")))
				{
					
					if(strcmp(p_msg_no,MS_MSGNO_52X)==0)
						strcpy(p_txn_msg, "522");
					else if(strcmp(p_msg_no,MS_SWIFT_BOG_NO)==0 || strcmp(p_msg_no,"54BN01")==0)
						strcpy(p_txn_msg, MS_MSGNO_542);
				}
				else if (!strcmp(chr_l_fld_value1, "1"))
				{
					
					if(strcmp(p_msg_no,MS_MSGNO_52X)==0)
						strcpy(p_txn_msg, "522");
					else if(strcmp(p_msg_no,MS_SWIFT_BOG_NO)==0 || strcmp(p_msg_no,"54BN01")==0)
						strcpy(p_txn_msg, MS_MSGNO_542);
				}
				else if (!strcmp(chr_l_fld_value1, "2"))
				{
					
					if(strcmp(p_msg_no,MS_MSGNO_52X)==0)
						strcpy(p_txn_msg, "520");
					else if(strcmp(p_msg_no,MS_SWIFT_BOG_NO)==0 || strcmp(p_msg_no,"54BN01")==0)
						strcpy(p_txn_msg, MS_MSGNO_540);
				}
				else if (!strcmp(chr_l_fld_value1, "3"))
				{
					
					if(strcmp(p_msg_no,MS_MSGNO_52X)==0)
						strcpy(p_txn_msg, "523");
					else if(strcmp(p_msg_no,MS_SWIFT_BOG_NO)==0)
						strcpy(p_txn_msg, MS_MSGNO_543);
				}
				else if (!strcmp(chr_l_fld_value1, "4"))
				{
					
					if(strcmp(p_msg_no,MS_MSGNO_52X)==0)
						strcpy(p_txn_msg, "521");
					else if(strcmp(p_msg_no,MS_SWIFT_BOG_NO)==0)
						strcpy(p_txn_msg, MS_MSGNO_541);
				}
			}
			else
			{
				if(strcmp(chr_l_fld_value1,"1")==0)
					{
					
					if(strcmp(p_msg_no,MS_MSGNO_52X)==0)
						strcpy(p_txn_msg, "522");
					else if(strcmp(p_msg_no,MS_SWIFT_BOG_NO)==0 || strcmp(p_msg_no,"54BN01")==0)
						strcpy(p_txn_msg, MS_MSGNO_542);
					}
				else if(strcmp(chr_l_fld_value1,"2")==0)
					{
					
					if(strcmp(p_msg_no,MS_MSGNO_52X)==0)
						strcpy(p_txn_msg, "520");
					else if(strcmp(p_msg_no,MS_SWIFT_BOG_NO)==0 || strcmp(p_msg_no,"54BN01")==0)
						strcpy(p_txn_msg, MS_MSGNO_540);
					}
			}
    } 
    else
    {
	memset(p_txn_msg,APL_NULL_CHAR,7);
    }

APL_GOBACK_SUCCESS;

RETURN_SUCCESS:

        CO_ProcMonitor(APL_OUT_FILE,"Exiting successfully  out of end of Message Processing \n",NULL,NULL);

        return APL_SUCCESS;

RETURN_FAILURE:
        CO_ProcMonitor(APL_OUT_FILE,"Exiting unsuccesfully out of end of Message Processing\n",NULL,NULL);
        return APL_FAILURE;

}

int MS_Chk_ISOCondPrevMsg(int p_val_rec,char *p_fld_name,FILE *p_data_values,MS_STATIC_VAL *p_ms_static_val_d,int p_newmsg)
{

char chr_curr_fld_val[201];
char chr_next_fld_val[201];
char chr_l_fld_value1[201];

memset(chr_curr_fld_val,APL_NULL_CHAR,201);
memset(chr_next_fld_val,APL_NULL_CHAR,201);
memset(chr_l_fld_value1,APL_NULL_CHAR,201);

      
      MS_Rtv_ISOTabVal(p_val_rec,p_fld_name,p_data_values,
                     chr_l_fld_value1,p_ms_static_val_d,0);
      strcpy(chr_curr_fld_val,chr_l_fld_value1);

      memset(chr_l_fld_value1,APL_NULL_CHAR,201);

      MS_Rtv_ISOTabVal((p_val_rec+1),p_fld_name,p_data_values,
                     &chr_l_fld_value1,p_ms_static_val_d,0);
      strcpy(chr_next_fld_val,chr_l_fld_value1);
      if(strcmp(chr_curr_fld_val,chr_next_fld_val) == 0)
      APL_GOBACK_SUCCESS
      else
      APL_GOBACK_FAIL

RETURN_SUCCESS:

        CO_ProcMonitor(APL_OUT_FILE,"Exiting successfully  out of MS_Chk_ISOCondPrevMsg\n",NULL,NULL);

        return APL_SUCCESS;
RETURN_FAILURE:
        CO_ProcMonitor(APL_OUT_FILE,"Exiting unsuccesfully out of MS_Chk_ISOCondPrevMsg\n",NULL,NULL);
        return APL_FAILURE;

}



int MS_Rtv_ISOTabVal(int p_val_rec_seq_no,char *p_fld_name,FILE *p_data_values,char *p_fld_value,MS_STATIC_VAL *p_ms_static_val_d,int p_pos)
{

int int_returnval=0,int_stat_ctr=0;
char chr_l_fld_name[205];
int g_curr_rec_start = 0;  /*Added for Linux Mig */
int g_prev_rec_start = 0;  /*Added for Linux Mig */

      while(p_ms_static_val_d[int_stat_ctr].link_val != NULL && strlen(p_ms_static_val_d[int_stat_ctr].link_val) != 0)
      {
           if(strcmp(p_ms_static_val_d[int_stat_ctr].link_val,p_fld_name) == 0)
           {
            strcpy(p_fld_value,p_ms_static_val_d[int_stat_ctr].link_tag);
                APL_GOBACK_SUCCESS
           }
           int_stat_ctr++;
      }

      memset(chr_l_fld_name,APL_NULL_CHAR,205);
      strcpy(chr_l_fld_name,ltoa(p_val_rec_seq_no));
      strcat(chr_l_fld_name,p_fld_name);

      if (int_g_curr_rec_no == 0)       
      {
         int_g_curr_rec_no = p_val_rec_seq_no;
         strcpy(chr_l_fld_name,"1EOF");
         int_returnval = CO_Rtv_Token(p_val_rec_seq_no,p_data_values,chr_l_fld_name,p_fld_value,NULL);
         fgetpos(p_data_values,&g_curr_rec_start);
         g_curr_rec_start = g_curr_rec_start - (strlen(ltoa(p_val_rec_seq_no)) + 6);
         g_prev_rec_start = g_curr_rec_start;
      }


      if (p_val_rec_seq_no < int_g_curr_rec_no)
      {
         fsetpos(p_data_values,&g_prev_rec_start);
      }

      if (p_val_rec_seq_no == int_g_curr_rec_no)
      {
          fsetpos(p_data_values,&g_curr_rec_start);
      }

      if (p_val_rec_seq_no > int_g_curr_rec_no)
      {
         fsetpos(p_data_values,&g_curr_rec_start);
      }

      strcpy(chr_l_fld_name,ltoa(p_val_rec_seq_no));
      strcat(chr_l_fld_name,p_fld_name);
      int_returnval = CO_Rtv_Token(p_val_rec_seq_no,p_data_values,chr_l_fld_name,p_fld_value,NULL);
      if(int_returnval == APL_SUCCESS)
      {
         
          APL_GOBACK_SUCCESS;
      }
      else
      {
          APL_GOBACK_FAIL;
      }

RETURN_SUCCESS:

        CO_ProcMonitor(APL_OUT_FILE,"Exiting successfully  out of MS_Rtv_ISOTabVal\n",NULL,NULL);

        return APL_SUCCESS;

RETURN_FAILURE:
        CO_ProcMonitor(APL_OUT_FILE,"Exiting unsuccesfully out of MS_Rtv_ISOTabVal\n",NULL,NULL);
        return APL_FAILURE;

}
