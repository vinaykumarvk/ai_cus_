

  









#include "CO_HostStructdef.h"
#include "MS_Swift.h"
#include "CA_Common.h"

#define SETTLEMENT_SEQ_NO "SETTLEMENT_SEQ_NOSEQ"

EXEC SQL INCLUDE SQLCA.H;



#define ERROR_COND_LEN 3
#define RGBRIND_LEN  3
#define BEARER_IND	  "BR"
#define	CLSCD_LCR	"LCR"

short int_l_move_from_dp_to_settled				=0;	

int DL_Proc_PosChkMod(	DL_DEAL_SSTDET_STRUCT_H *p_dl_deal_sstdet_struct_h_a,
							char *p_instr_code,
							char *p_location,
							char *p_status_ind,
							char *p_dealcd,
							short p_iinstrdate,
							char *p_old_status,
							double p_quantity,
							char	p_chk_or_upd,
							char *p_block_type,
							int *p_success_flg,
							DEBUG_INFO_STRUCT_H **l_debug_info_ptr );




int DL_Proc_DLSetlSing(	DL_DEAL_SSTDET_STRUCT_H *p_dl_deal_sstdet_struct_h_a,
                     char            *p_eventid,
							INTL_ENV_DATA_STRUCT_H *p_intl_envdatastruct_h,	
							DEBUG_INFO_STRUCT_H **l_debug_info_ptr )
{

	

	struct sqlca sqlca;	

	int 		int_l_error_flag 								= APL_SUCCESS;
	int		int_l_diff_dates 								= 0;
	int		int_l_chkflg 	 								= 0;
	int		int_l_h_amt_declen								= 0;
	int		int_l_price_declen 							= 0;
	int		int_l_h_par_srlno								= 0;
	int      int_l_count_val                         = 0;

	double 	l_new_quantity 									= 0.0;
	double 	h_l_quantity 										= 0.0;
	double	l_h_minfmttrdquantity							= 0.0;
	double   chr_l_h_amount                          = 0.0;
	double   l_recv_qty										= 0.0;

	char  	chr_l_h_rowid[APL_ROWID_LEN] 				= APL_NULL_STRING;
	char  	chr_l_now[APL_DATE_LEN] 						= APL_NULL_STRING;
	char  	chr_l_date[APL_DATE_LEN] 					= APL_NULL_STRING;
	char		chr_l_manif_flag[APL_FLAG_LENGTH] 			= APL_NULL_STRING;
	char		chr_l_subfun[APL_SUB_FUN_LEN] 				= APL_NULL_STRING;
	char		chr_l_settl_err_cond[ERROR_COND_LEN] 	= APL_NULL_STRING;
	char		chr_l_instr_dt[APL_DATE_LEN] 					= APL_NULL_STRING;
	char		chr_l_moneydt[APL_DATE_LEN] 				= APL_NULL_STRING;
	char		int_l_retval 									= NULL;
	char		chr_l_h_clscode[CLSCD_LEN] 			= APL_NULL_STRING;
	char		chr_l_new_status[STATUS_POS_LEN] 		= APL_NULL_STRING;
	char		chr_l_new_refno[APL_TXNREFNO_LEN] 		= APL_NULL_STRING;
	char		chr_l_h_par_accst[APL_DATE_LEN] 			= APL_NULL_STRING;
	char		chr_l_h_regstatus[APL_FLAG_LENGTH] 			= APL_NULL_STRING;
	char		chr_l_candropdt[APL_DATE_LEN] 				= APL_NULL_STRING;
	char		chr_l_h_nds[APL_FLAG_LENGTH]					= APL_NULL_STRING;
	char		chr_l_h_typeofinstr[TYPEOF_INSTR_LEN]				= APL_NULL_STRING;
	char		chr_l_h_rgbrind[RGBRIND_LEN]				= APL_NULL_STRING;
	char		chr_l_h_canreg[APL_FLAG_LENGTH]				= APL_NULL_STRING;
	char		chr_l_trd_status[APL_STATUS_LEN]			= APL_NULL_STRING;
	char		chr_l_hisposflg[APL_FLAG_LENGTH]				= APL_NULL_STRING;
	char		chr_l_buf[BUFFER_LEN]							= APL_NULL_STRING;
	char		chr_l_msg_type[4]								= APL_NULL_STRING;
   char     chr_l_locncode_c[APL_LOCNCODE_LENGTH]        = APL_NULL_STRING;  
   char		chr_l_new_typeoftrd[DEALTYPE_LEN_A]      = APL_NULL_STRING;   
   char     int_l_domcpac[APL_CLIENT_LENGTH]				= APL_NULL_STRING;  
	char     chr_l_ndsdt[APL_DATE_LEN]					= APL_NULL_STRING; 
	char		chr_l_comm_ref_no[APL_TXNREFNO_LEN + 4] = APL_NULL_STRING;
	char		chr_l_blclscode[CLSCD_LEN]				= APL_NULL_STRING;	
	char     l_dl_ref_no[19]         = APL_NULL_STRING;	
	char l_evt_type[10];
	char l_op_evt_type[10];

	char  	chr_deal_money_settl_dt[APL_DATE_LEN] 						= APL_NULL_STRING;
	char  	chr_deal_instr_settl_dt[APL_DATE_LEN] 						= APL_NULL_STRING;
	char  	chr_deal_clh_dvp_flg[APL_FLAG_LENGTH] 						= APL_NULL_STRING;
	char  	chr_deal_dealcd[2] 						= APL_NULL_STRING;
	char l_dl_stat[3] = APL_NULL_STRING; /* VaibhavK ISKB:529 23 Nov 2007 */

   char chr_l_trd_mkt_type[4]                  = APL_NULL_STRING; /** Added by Vijay For SLB **/
   short i_l_trd_mkt_type                      = 0; /** Added by Vijay For SLB **/
   char chr_l_exch_code[4]                     = APL_NULL_STRING; /** Added by Vijay For SLB **/
   short i_l_exch_code                         = 0; /** Added by Vijay For SLB **/

	short	i_dl_stat = 0;  /* VaibhavK ISKB:529 23 Nov 2007 */
	short  	i_deal_money_settl_dt = 0;
	short  	i_deal_instr_settl_dt = 0;
	short  	i_deal_clh_dvp_flg = 0;
	short  	i_deal_dealcd = 0;

	short		l_partial_ma 								= 0;
	short		l_iflag 		  								= 0;
	short		l_i_rowid	 								= 0;
	short		l_i_clscode	 								= 0;	
	short		l_i_typeofinstr  								= 0;
	short		l_i_rgbrind									= 0;
	short		l_i_canreg	 								= 0;
	short		l_i_amt_declen								= 0;
	short		l_i_par_accst  							= 0;
	short		l_i_par_srlno								= 0;
	short		l_i_minfmttrdqty							= 0;
   short    int_l_exist_a                             = 0;
	short    l_i_ndsdt                           = 0;
	short		l_i_blclscode									= 0;	
	short l_dp_passed                =  0;


	char		chr_l_fail_code[FAILREAS_CD_LEN]			= APL_NULL_STRING;
	short		l_i_fail_code								= 0;

	

	int		int_l_h_subfailcode							= 0;
	short		l_i_subfailcode							= 0;


	short		int_l_partial_no_mand							= 0;

	SYS_DL_DEAL_STRUCT_H	*l_sys_dl_deal_struct_hn 		= NULL;
	SYS_DL_DEAL_STRUCT_I	*l_sys_dl_deal_struct_id 		= NULL;
	DL_DEALAUDIT_STRUCT_H *l_dl_dealaudit_struct_h  = NULL;
	DL_REGDET_STRUCT_H *l_reg_trf_struct_h 		= NULL;
	REQDETAILS_STRUCT_H l_reqdetails_struct_h;

	
	char chr_param_string[201] = APL_NULL_STRING;
	MS_MSGSTAT_STRUCT l_ms_msgstat_structa  ;
	int int_retstat=0;
	

   char chr_l_prevseme[17];
   short i_prevseme = 0;
   char chr_l_sc_eventid[17];
   short i_sc_eventid=0;

	int   int_p_smieligibility_flg = 0;
	int 	int_h_count					=0; 
	short int_l_condexists				=0;	
  
	PRO_GSEQNUM_STRUCT_H        l_pro_gseq_struct_h;
	short    l_lrflag    = 0;
	long  l_lng_lr_seq_num=0;
	
	char chr_l_cubk_exttrd[2] = APL_NULL_STRING;
	short l_ext_trd_check   =  0  ;   
	char     chr_mainfuncarea[APL_MAINFUNCAREA_LEN]= APL_NULL_STRING;
	char     chr_l_condid[APL_CONDID_LEN]            = APL_NULL_STRING;

	char l_block_type[5] = APL_NULL_STRING;
	int l_sqroff_cnt= 0;
        /* VaibhavK ISKB:529 23 Nov 2007  Start*/
	char l_exch_cd[DL_EXCH_CODE_LEN]	=APL_NULL_STRING;	/*	Exchange Code for Holiday Check	*/
	char l_instr_type[4] = APL_NULL_STRING;
	short i_instr_type  = 0;
        /* VaibhavK ISKB:529 23 Nov 2007 End*/


	#ifdef APL_THREADS
		APL_SET_CONTEXT
		EXEC SQL CONTEXT USE	:my_ctx_local;
	#endif

	sqlca.sqlcode = 0;

	

	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_dl_client  			IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_indentity_no 				IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_dlt 					IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_setldt 			IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_ex_arena				IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_instrdate					IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_moneydate				IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_domcpclt_cd				IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_isspotdl			IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_dlfromord			IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_entry 			IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_reapired_ind			IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_domcp_custodyclt			IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_countclt 			IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_countcltnm			IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_clientof			IS STRING;		
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_custinfo				IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_fx_reqd				IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_ispymtlocal			IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_verfied_with				IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_brkrno				IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_fail_cd				IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_failinfo				IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_ispart_			IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_report_at_eom_ind				IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_billdate				IS STRING;	
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_locindentity_no				IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_instruct_person			IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_dealcd				IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_instr_code				IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_currencycode				IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_classofdl			IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_origindentity_no			IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_newdt				IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_maker					IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_maker_dt				IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_deal_status		IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_access_stamp		IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_info1					IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_loccode 			IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_reginstr_ind				IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_pos_stat			IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_status_reg			IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_confdate				IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_matchindentity_no			IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_markfaildate			IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_candropdate			IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_checker				IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_checker_dt			IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_instrconv_ind			IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_ndsbldate				IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_lrdltype			IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_ndsdate					IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_ublckdate				IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_delrecdate				IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_lastregdate			IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_lr_chkdate				IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_lr_confdate			IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_lr_instrdate				IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_tmpoutdate				IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_tmpretdate				IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_transmitdate			IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_hostdate				IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_lr_ndsbldate			IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_lr_ndsdate				IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_lr_ublckdate			IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_clt_reqdel_flag		IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_mod_hispos_ind		IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_updhispos_date		IS STRING;
	EXEC SQL VAR int_l_domcpac		IS STRING;
	EXEC SQL VAR chr_l_locncode_c		IS STRING;
	EXEC SQL VAR chr_l_ndsdt                      IS STRING;
	EXEC SQL VAR chr_l_h_clscode   IS STRING;
   EXEC SQL VAR l_sys_dl_deal_struct_hn->h_cash_client IS STRING;
   EXEC SQL VAR l_sys_dl_deal_struct_hn->h_msg_stat IS STRING;
   
   EXEC SQL VAR l_sys_dl_deal_struct_hn->h_instruct_person      IS STRING;
   EXEC SQL VAR l_sys_dl_deal_struct_hn->h_clientofcode  IS STRING;
   EXEC SQL VAR l_sys_dl_deal_struct_hn->h_inter_med_person      IS STRING;
   EXEC SQL VAR l_sys_dl_deal_struct_hn->h_inter_med_personnm    IS STRING;
   
   EXEC SQL VAR l_sys_dl_deal_struct_hn->h_fxccy    IS STRING;
   EXEC SQL VAR l_sys_dl_deal_struct_hn->h_exp_setl_date    IS STRING;
   EXEC SQL VAR l_sys_dl_deal_struct_hn->h_uniq_ident_no IS STRING;
   EXEC SQL VAR l_sys_dl_deal_struct_hn->h_misinfo        IS STRING;  
   EXEC SQL VAR l_sys_dl_deal_struct_hn->h_exch_code        IS STRING;  
	EXEC SQL VAR l_dl_ref_no IS STRING;   
   EXEC SQL VAR chr_l_trd_mkt_type IS STRING; /** Vijay For SLB **/
   EXEC SQL VAR chr_l_exch_code IS STRING;  /** Vijay For SLB **/


   EXEC SQL VAR chr_l_prevseme IS STRING;
   EXEC SQL VAR chr_l_sc_eventid IS STRING;
  
	 EXEC SQL VAR l_pro_gseq_struct_h.sequencename        IS STRING;
  
	
	EXEC SQL VAR chr_l_blclscode	IS STRING;
	memset(chr_l_blclscode, APL_NULL_CHAR, CLSCD_LEN);
	
	
	l_sys_dl_deal_struct_hn = (SYS_DL_DEAL_STRUCT_H *)calloc(1, sizeof(SYS_DL_DEAL_STRUCT_H));
	l_sys_dl_deal_struct_id = (SYS_DL_DEAL_STRUCT_I *)calloc(1, sizeof(SYS_DL_DEAL_STRUCT_I));
	l_reg_trf_struct_h = (DL_REGDET_STRUCT_H *)calloc(1, sizeof(DL_REGDET_STRUCT_H));
	l_dl_dealaudit_struct_h = (DL_DEALAUDIT_STRUCT_H *)calloc(1, sizeof(DL_DEALAUDIT_STRUCT_H));
	
	memset(&l_ms_msgstat_structa,NULL,sizeof(MS_MSGSTAT_STRUCT)); 
	

	memset(&l_pro_gseq_struct_h,NULL,sizeof(PRO_GSEQNUM_STRUCT_H)); 

	APL_MALLOC_FAIL(l_sys_dl_deal_struct_hn);
	APL_MALLOC_FAIL(l_sys_dl_deal_struct_id);
	APL_MALLOC_FAIL(l_reg_trf_struct_h);
	APL_MALLOC_FAIL(l_dl_dealaudit_struct_h);
	
	

	APL_IF_DEBUG
	{
		CO_ProcMonitor(	APL_OUT_FILE, 
						"Entered Function CDBUpdSSTDetFn", 
						NULL, 
						p_intl_envdatastruct_h );
		memset(chr_l_buf, NULL, BUFFER_LEN);
		sprintf(	chr_l_buf, 
					"The Account is         : %s",	
					p_dl_deal_sstdet_struct_h_a->h_dl_client);
		CO_ProcMonitor(	APL_OUT_FILE, 
						chr_l_buf, 
						NULL, 
						p_intl_envdatastruct_h);
		memset(chr_l_buf, NULL, BUFFER_LEN);
		sprintf(	chr_l_buf, 
					"The RefNo is           : %s", 
					p_dl_deal_sstdet_struct_h_a->h_indentity_no);
		CO_ProcMonitor(	APL_OUT_FILE, 
						chr_l_buf, 
						NULL, 
						p_intl_envdatastruct_h);
		memset(chr_l_buf, NULL, BUFFER_LEN);
		sprintf(	chr_l_buf, 
					"The Ispartial is       : %s", 
					p_dl_deal_sstdet_struct_h_a->h_ispart_);
		CO_ProcMonitor(	APL_OUT_FILE, 
						chr_l_buf, 
						NULL, 
						p_intl_envdatastruct_h);
		memset(chr_l_buf, NULL, BUFFER_LEN);
		sprintf(	chr_l_buf, 
					"The NewQuantity is     : %f", 
					p_dl_deal_sstdet_struct_h_a->h_newquantity);
		CO_ProcMonitor(	APL_OUT_FILE, 
						chr_l_buf, 
						NULL, 
						p_intl_envdatastruct_h);
		memset(chr_l_buf, NULL, BUFFER_LEN);
		sprintf(	chr_l_buf, 
					"The NewAmount is       : %f", 
					p_dl_deal_sstdet_struct_h_a->h_newamount);
		CO_ProcMonitor(	APL_OUT_FILE, 
						chr_l_buf, 
						NULL, 
						p_intl_envdatastruct_h);
		memset(chr_l_buf, NULL, BUFFER_LEN);
		sprintf(	chr_l_buf, 
					"The NewRefNo is        : %s", 
					p_dl_deal_sstdet_struct_h_a->h_newindentity_no);
		CO_ProcMonitor(	APL_OUT_FILE, 
						chr_l_buf, 
						NULL, 
						p_intl_envdatastruct_h);
		memset(chr_l_buf, NULL, BUFFER_LEN);
		sprintf(	chr_l_buf, 
					"The Instr. Dt. is        : %s", 
					p_dl_deal_sstdet_struct_h_a->h_instrdate);
		CO_ProcMonitor(	APL_OUT_FILE, 
						chr_l_buf, 
						NULL, 
						p_intl_envdatastruct_h);
		memset(chr_l_buf, NULL, BUFFER_LEN);
		sprintf(	chr_l_buf, 
					"The Money Dt. is       : %s", 
					p_dl_deal_sstdet_struct_h_a->h_moneydate);
		CO_ProcMonitor(	APL_OUT_FILE, 
						chr_l_buf, 
						NULL, 
						p_intl_envdatastruct_h);
		memset(chr_l_buf, NULL, BUFFER_LEN);
		sprintf(	chr_l_buf, 
					"The Price is           : %f", 
					p_dl_deal_sstdet_struct_h_a->h_pr);
		CO_ProcMonitor(	APL_OUT_FILE, 
						chr_l_buf, 
						NULL, 
						p_intl_envdatastruct_h);
		memset(chr_l_buf, NULL, BUFFER_LEN);
		sprintf(	chr_l_buf, 
					"The Brk. Comm. is      : %f", 
					p_dl_deal_sstdet_struct_h_a->h_brokercomm);
		CO_ProcMonitor(	APL_OUT_FILE, 
						chr_l_buf, 
						NULL, 
						p_intl_envdatastruct_h);
		memset(chr_l_buf, NULL, BUFFER_LEN);
		sprintf(	chr_l_buf, 
					"The Sel. For Reg. is   : %s", 
					p_dl_deal_sstdet_struct_h_a->h_sel_forreg);
		CO_ProcMonitor(	APL_OUT_FILE, 
						chr_l_buf, 
						NULL, 
						p_intl_envdatastruct_h);
		memset(chr_l_buf, NULL, BUFFER_LEN);
		sprintf(	chr_l_buf, 
					"The Pend Reg Qty is    : %f", 
					p_dl_deal_sstdet_struct_h_a->h_pendregquantity);
		CO_ProcMonitor(	APL_OUT_FILE, 
						chr_l_buf, 
						NULL, 
						p_intl_envdatastruct_h);
		memset(chr_l_buf, NULL, BUFFER_LEN);
		sprintf(	chr_l_buf, 
					"The Mark Trf Qty is    : %f", 
					p_dl_deal_sstdet_struct_h_a->h_marktrfquantity);
		CO_ProcMonitor(	APL_OUT_FILE, 
						chr_l_buf, 
						NULL, 
						p_intl_envdatastruct_h);
		memset(chr_l_buf, NULL, BUFFER_LEN);
		sprintf(	chr_l_buf, 
					"The Mark Compl. Qty is : %f", 
					p_dl_deal_sstdet_struct_h_a->h_mcomplquantity);
		CO_ProcMonitor(	APL_OUT_FILE, 
						chr_l_buf, 
						NULL, 
						p_intl_envdatastruct_h);
		memset(chr_l_buf, NULL, BUFFER_LEN);
		sprintf(	chr_l_buf, 
					"The Rec. Into 000 is   : %f", 
					p_dl_deal_sstdet_struct_h_a->h_rec_int_000);
		CO_ProcMonitor(	APL_OUT_FILE, 
						chr_l_buf, 
						NULL, 
						p_intl_envdatastruct_h);
		memset(chr_l_buf, NULL, BUFFER_LEN);
		sprintf(	chr_l_buf, 
					"The Del From 000 is    : %f", 
					p_dl_deal_sstdet_struct_h_a->h_delta_000);
		CO_ProcMonitor(	APL_OUT_FILE, 
						chr_l_buf, 
						NULL, 
						p_intl_envdatastruct_h);
		memset(chr_l_buf, NULL, BUFFER_LEN);
		sprintf(	chr_l_buf, 
					"The Del From 001 is    : %f", 
					p_dl_deal_sstdet_struct_h_a->h_delta_001);
		CO_ProcMonitor(	APL_OUT_FILE, 
						chr_l_buf, 
						NULL, 
						p_intl_envdatastruct_h);
		memset(chr_l_buf, NULL, BUFFER_LEN);
		sprintf(	chr_l_buf, 
					"The Del From 003 is    : %f", 
					p_dl_deal_sstdet_struct_h_a->h_delta_002);
		CO_ProcMonitor(	APL_OUT_FILE, 
						chr_l_buf, 
						NULL, 
						p_intl_envdatastruct_h);
		memset(chr_l_buf, NULL, BUFFER_LEN);
		sprintf(	chr_l_buf, 
					"The Access Stamp is    : %s", 
					p_dl_deal_sstdet_struct_h_a->h_access_stamp);
		CO_ProcMonitor(	APL_OUT_FILE, 
						chr_l_buf, 
						NULL, 
						p_intl_envdatastruct_h);
	}

	
	

	if (!strlen(p_dl_deal_sstdet_struct_h_a->h_dl_client))
	{
		APL_DATA_MISSING("Account", APL_NULL_STRING, APL_NULL_STRING);
		int_l_error_flag = APL_FAILURE;
	} 
	if (!strlen(p_dl_deal_sstdet_struct_h_a->h_indentity_no))
	{
		APL_DATA_MISSING("RefNo", APL_NULL_STRING, APL_NULL_STRING);
		int_l_error_flag = APL_FAILURE;
	} 

	if (APL_FAILURE == int_l_error_flag) APL_GOBACK_FAIL
	memset(l_dl_ref_no,APL_NULL_CHAR,19);
   strcpy(l_dl_ref_no,APL_NULL_STRING);

   memset(l_exch_cd,APL_NULL_CHAR,DL_EXCH_CODE_LEN); /* VaibhavK ISKB:529 23 Nov 2007 */

   strcpy(l_dl_ref_no,"%");
   strcat(l_dl_ref_no,p_dl_deal_sstdet_struct_h_a->h_indentity_no);
   strcat(l_dl_ref_no,"%");
   l_dp_passed = 0;

   /** Added By Vijay **/
   memset(chr_l_trd_mkt_type,APL_NULL_CHAR,4);
   EXEC SQL SELECT MKT_TYPE,EXCH_CODE 
            INTO :chr_l_trd_mkt_type:i_l_trd_mkt_type,:chr_l_exch_code:i_l_exch_code
            FROM DL_DEAL 
            WHERE CLIENT   =:p_dl_deal_sstdet_struct_h_a->h_dl_client
              AND IDENTIY_NO =:p_dl_deal_sstdet_struct_h_a->h_indentity_no;
  

	IS_ANY_ORA_ERROR

   /** Vijay SLB Ends **/

	printf("\nSearching for Deal record presence in DP Instruction table ... for |%s|%s|\n",l_dl_ref_no,p_dl_deal_sstdet_struct_h_a->h_dl_client);

	/*Query Modified by siva.ganapathi for ISKB_3462 -- started*/
          
       /*EXEC SQL SELECT COUNT(*) into :l_dp_passed FROM DL_DPINSTRS WHERE DEAL_REF_NOS LIKE :l_dl_ref_no AND
		STATUS='P' AND CLIENT in (select cln_depo_map_client_id from mt_cli_depo_map where cln_code = :p_dl_deal_sstdet_struct_h_a->h_dl_client);*/


	//Commented by Sandip for ISKB_12228
	/*	EXEC SQL SELECT COUNT(*) 
			 INTO :l_dp_passed 
		     FROM DL_DPINSTRS 
			 WHERE DEAL_REF_NOS LIKE :l_dl_ref_no 
			 AND STATUS='P' 
			 AND CLIENT IN ( SELECT CLN_DEPO_MAP_CLIENT_ID 
							 FROM MT_CLI_DEPO_MAP 
							 WHERE CLN_CODE = :p_dl_deal_sstdet_struct_h_a->h_dl_client ) 
		AND	INSTR(','|| DECODE(INSTR(DEAL_REF_NOS, ','),0, DEAL_REF_NOS||',', DEAL_REF_NOS),','||:p_dl_deal_sstdet_struct_h_a->h_indentity_no||',') > 0 ;
		*/
		
		//Added by Sandip for ISKB_12228
		EXEC SQL SELECT COUNT(1) into :l_dp_passed FROM DL_DEAL WHERE 
		CLIENT = :p_dl_deal_sstdet_struct_h_a->h_dl_client AND IDENTIY_NO = :p_dl_deal_sstdet_struct_h_a->h_indentity_no
		AND NDS_DATE IS NOT NULL;


	/*Query Modified by siva.ganapathi for ISKB_3462 -- Ended*/

	printf("\nsqlca.sqlcode is ... for |%d|\n",sqlca.sqlcode);
	printf("\nl_dp_passed is ... for |%d|\n",l_dp_passed);

	fflush(stdout);

	IS_ANY_ORA_ERROR

	if (l_dp_passed != 0)
	{
		int_l_move_from_dp_to_settled = 1;	
	}
	else
	{
		int_l_move_from_dp_to_settled = 0;	
	}	

	EXEC SQL SELECT DL_DEAL.ROWID 
	INTO 	:chr_l_h_rowid:l_i_rowid
	FROM DL_DEAL
	WHERE CLIENT = :p_dl_deal_sstdet_struct_h_a->h_dl_client
	AND	IDENTIY_NO   = :p_dl_deal_sstdet_struct_h_a->h_indentity_no
	AND DEAL_STAT != 'CS'           /* ISKB - 1658 : ASHISH 14-07-2008 */
									
	FOR UPDATE OF ACCESS_STAMP;

	IS_ANY_ORA_ERROR_AND_ZERO_RESULTSET(	ERR_DEAL_NF,
														p_dl_deal_sstdet_struct_h_a->h_dl_client,
														p_dl_deal_sstdet_struct_h_a->h_indentity_no,
														APL_NULL_STRING);

   EXEC SQL SELECT DL_DEAL.*
   INTO  :l_sys_dl_deal_struct_hn:l_sys_dl_deal_struct_id
   FROM DL_DEAL
   WHERE ROWID=:chr_l_h_rowid;

   IS_ANY_ORA_ERROR_AND_ZERO_RESULTSET( ERR_DEAL_NF,
                                          p_dl_deal_sstdet_struct_h_a->h_dl_client,
                                          p_dl_deal_sstdet_struct_h_a->h_indentity_no,
                                          APL_NULL_STRING);
	/*AmitB:Check of unauth Sqroff Entry:170507	*/
	if(strcmp(l_sys_dl_deal_struct_hn->h_classofdl,"59")==0 && (strcmp(p_intl_envdatastruct_h->processtion,"DL_SQOFF")!=0  && strcmp(p_intl_envdatastruct_h->h_mode,APL_FUNC_AUTHORISE)!=0) )
	{
		EXEC SQL SELECT COUNT(*) INTO :l_sqroff_cnt FROM DL_SQOFF
					WHERE DL_REF_NO=:p_dl_deal_sstdet_struct_h_a->h_indentity_no
					AND CLN_CODE=:p_dl_deal_sstdet_struct_h_a->h_dl_client
					AND STATUS IN('UU','DU');
		IS_ANY_ORA_ERROR
		
		
		if(l_sqroff_cnt > 0)
		{	
			if(!strcmp(p_intl_envdatastruct_h->processtion,"DL_DEAL") && !strcmp(p_intl_envdatastruct_h->h_mode,SST_MODE))
			{
				printf("\n 1 UnAuthorized Square-Off Record Exists,Can Not Settle Trade. Refno:%s Client:%s\n",p_dl_deal_sstdet_struct_h_a->h_indentity_no,p_dl_deal_sstdet_struct_h_a->h_dl_client);
				CO_InsertErr(	l_debug_info_ptr,
									ERR_UNAUTH_SQRAUTH,
									p_dl_deal_sstdet_struct_h_a->h_indentity_no,
									p_dl_deal_sstdet_struct_h_a->h_dl_client,
									APL_NULL_STRING,
									__LINE__,
									__FILE__ );
				APL_GOBACK_FAIL
			}
			else
			{
				printf("\n UnAuthorized Square-Off Record Exists,Can Not Settle Trade. Refno:%s Client:%s\n",p_dl_deal_sstdet_struct_h_a->h_indentity_no,p_dl_deal_sstdet_struct_h_a->h_dl_client);
				CO_InsertErr(	l_debug_info_ptr,
									ERR_UNAUTH_SQRAUTH,
									p_dl_deal_sstdet_struct_h_a->h_indentity_no,
									p_dl_deal_sstdet_struct_h_a->h_dl_client,
									APL_NULL_STRING,
									__LINE__,
									__FILE__ );
				APL_GOBACK_FAIL;
			}
		}
	}
   	if (strcmp(g_mt_commonsys_params_struct_h.ei_smi_ind,"Y") == 0)
	{
		if (EI_Chk_SMIElg( l_sys_dl_deal_struct_hn->h_loccode,
											  l_sys_dl_deal_struct_hn->h_dlt,
											  l_sys_dl_deal_struct_hn->h_classofdl,
											  l_sys_dl_deal_struct_hn->h_instr_code,
											  l_sys_dl_deal_struct_hn->h_locchng_flg,
											  chr_l_h_rowid,
											  &int_p_smieligibility_flg,
											  p_intl_envdatastruct_h,
											  l_debug_info_ptr
											  ) == APL_FAILURE)
		{
				CO_ProcMonitor(APL_OUT_FILE,"Failure from SMI_CheckSMIEligibility",NULL,p_intl_envdatastruct_h);
				APL_GOBACK_FAIL;
		}
	}
   if (  (int_p_smieligibility_flg) &&
         (strcmp(g_mt_commonsys_params_struct_h.ei_smi_ind,"Y") == 0)  )
	{}		
	else if (strcmp(l_sys_dl_deal_struct_hn->h_access_stamp, p_dl_deal_sstdet_struct_h_a->h_access_stamp))
	{
	  if(strcmp(p_intl_envdatastruct_h->auth_req,"Y")){
		CO_InsertErr(	l_debug_info_ptr,
								ERR_ACCESSSTAMP_CHGD,
								APL_NULL_STRING,
								APL_NULL_STRING,
								APL_NULL_STRING,
								__LINE__,
								__FILE__ );
		APL_GOBACK_FAIL
	}
	}


	

	if (APL_FAILURE == CO_Chk_CntryEnabled(	"TRD_SETTLEMENT",
														"PARTIALS",
														&l_partial_ma,
														l_debug_info_ptr))
	{
		APL_GOBACK_FAIL
	}
	
	
	
	int_l_partial_no_mand = 0;
	if (APL_FAILURE == CO_Chk_CntryEnabled(	"TRD_SETTLEMENT",
														"PARTIALS_NOT_MAND",
														&int_l_partial_no_mand,
														l_debug_info_ptr))
	{
		APL_GOBACK_FAIL
	}
	if (l_partial_ma)
	{
	
	
		if (!strlen(p_dl_deal_sstdet_struct_h_a->h_ispart_) && (int_l_partial_no_mand == 0))
		{
			APL_DATA_MISSING("Partial Flag", APL_NULL_STRING, APL_NULL_STRING);
			int_l_error_flag = APL_FAILURE;
		}	
		if (p_dl_deal_sstdet_struct_h_a->h_ispart_[0] == 'Y')
		{
			if (p_dl_deal_sstdet_struct_h_a->h_newquantity <= 0)
			{
				APL_DATA_MISSING("New Quantity", APL_NULL_STRING, APL_NULL_STRING);
				int_l_error_flag = APL_FAILURE;
			}
			if ((p_dl_deal_sstdet_struct_h_a->h_newamount < 1) && 
				 (VAL_VP_DEAL(l_sys_dl_deal_struct_hn->h_dealcd[0])))
			{
				APL_DATA_MISSING("New Amount", APL_NULL_STRING, APL_NULL_STRING);
				int_l_error_flag = APL_FAILURE;
			}
			if (!strlen(p_dl_deal_sstdet_struct_h_a->h_newindentity_no))
			{
				APL_DATA_MISSING("New Ref.No.", APL_NULL_STRING, APL_NULL_STRING);
				int_l_error_flag = APL_FAILURE;
			}
		}
	}
	
	int_l_condexists=0;
   if (APL_FAILURE == CO_Chk_CntryEnabled(  "TRD_SETTLEMENT",
									  "BROK_52XN02_MESSAGE",
									  &int_l_condexists,
									  l_debug_info_ptr))

	{
		APL_GOBACK_FAIL
	}
	
	if(int_l_condexists > 0 )
	{
	
		EXEC SQL SELECT COUNT(*) INTO :int_h_count FROM MT_MSGADDRESS A, MT_CLIENT B 
		WHERE A.CLN_CODE=B.CLN_CODE 
		AND B.CLN_BRK_ALL = 'B'
		AND B.STATUS = 'AA'
		AND A.MSG_IDENT_NO='35'
		AND B.CLN_CODE=	:l_sys_dl_deal_struct_hn->h_domcpclt_cd;
	
			IS_ANY_ORA_ERROR
		if (int_h_count >0)
		{
			if(strchr(l_sys_dl_deal_struct_hn->h_msg_stat,'E')== NULL)
			{
				CO_InsertErr(   l_debug_info_ptr,
								ERR_EUROMSG_NOTSENT,
								l_sys_dl_deal_struct_hn->h_domcpclt_cd,
								APL_NULL_STRING,
								APL_NULL_STRING,
								__LINE__,
								__FILE__ );
				APL_GOBACK_FAIL	
			}
			
		}
	}
		

		

		
	if ((!strlen(p_dl_deal_sstdet_struct_h_a->h_instrdate)) &&
		 ((!strlen(p_dl_deal_sstdet_struct_h_a->h_moneydate)) || (l_sys_dl_deal_struct_hn->h_isspotdl[0] == 'Y')))
	{
		APL_DATA_MISSING("Instr. Dt.", APL_NULL_STRING, APL_NULL_STRING);
		int_l_error_flag = APL_FAILURE;
	}
	if ((!strlen(p_dl_deal_sstdet_struct_h_a->h_moneydate)) &&
		 (VAL_VP_DEAL(l_sys_dl_deal_struct_hn->h_dealcd[0])) &&
		 (!strlen(p_dl_deal_sstdet_struct_h_a->h_instrdate) || (l_sys_dl_deal_struct_hn->h_isspotdl[0] == 'Y')))
	{
		APL_DATA_MISSING("Money Dt.", APL_NULL_STRING, APL_NULL_STRING);
		int_l_error_flag = APL_FAILURE;
	}

	
	EXEC SQL SELECT CLH_FLG, DEAL_CD, MONEY_SETL_DT , INSTRUMENT_DT
	INTO 	:chr_deal_clh_dvp_flg:i_deal_clh_dvp_flg,
			:chr_deal_dealcd:i_deal_dealcd,
			:chr_deal_money_settl_dt:i_deal_money_settl_dt,
			:chr_deal_instr_settl_dt:i_deal_instr_settl_dt	
	FROM DL_DEAL
	WHERE CLIENT = :p_dl_deal_sstdet_struct_h_a->h_dl_client
	AND	IDENTIY_NO   = :p_dl_deal_sstdet_struct_h_a->h_indentity_no;

	IS_ANY_ORA_ERROR_AND_ZERO_RESULTSET(	ERR_DEAL_NF,
														p_dl_deal_sstdet_struct_h_a->h_dl_client,
														p_dl_deal_sstdet_struct_h_a->h_indentity_no,
														APL_NULL_STRING);


	printf("\n CLH-DVP = |%s|",chr_deal_clh_dvp_flg);
	printf("\n REC-DEL = |%c|", chr_deal_dealcd[0]);
	printf("\n money settl date = |%s|", p_dl_deal_sstdet_struct_h_a->h_moneydate);
	printf("\n sec settl date = |%s|", p_dl_deal_sstdet_struct_h_a->h_instrdate);

	if (VAL_VP_DEAL(chr_deal_dealcd[0]))
	{
		if ( 	(strcmp(chr_deal_clh_dvp_flg,"C")==0) && 
				(VAL_RECDEAL(chr_deal_dealcd[0]))	&& 
			   (strlen(p_dl_deal_sstdet_struct_h_a->h_moneydate) == 0) && 
				 (strlen(p_dl_deal_sstdet_struct_h_a->h_instrdate))	
			)
		{
			if (APL_FAILURE == CO_InsertErr(	l_debug_info_ptr,
															ERR_DEAL_MNYSETL_PEND,
															"CLH - RECEIVE ",
															p_dl_deal_sstdet_struct_h_a->h_dl_client,
															p_dl_deal_sstdet_struct_h_a->h_indentity_no,
															__LINE__,
															__FILE__ ))
			{
				APL_GOBACK_FAIL
			}
			int_l_error_flag = APL_FAILURE;
		}
		else if ( 	(strcmp(chr_deal_clh_dvp_flg,"C")==0) && 
				(VAL_DELIVER_DEAL(chr_deal_dealcd[0]))	&& 
			   (strlen(p_dl_deal_sstdet_struct_h_a->h_instrdate) == 0) && 
				 (strlen(p_dl_deal_sstdet_struct_h_a->h_moneydate))	
			)
		{
			if (APL_FAILURE == CO_InsertErr(	l_debug_info_ptr,
															ERR_DEAL_SECSETL_PEND,
															"CLH - DELIVER ",
															p_dl_deal_sstdet_struct_h_a->h_dl_client,
															p_dl_deal_sstdet_struct_h_a->h_indentity_no,
															__LINE__,
															__FILE__ ))
			{
				APL_GOBACK_FAIL
			}
			int_l_error_flag = APL_FAILURE;
		}
		else if ( 	(strcmp(chr_deal_clh_dvp_flg,"D")==0) && 
				(VAL_DELIVER_DEAL(chr_deal_dealcd[0]))	&& 
			   (strlen(p_dl_deal_sstdet_struct_h_a->h_moneydate) == 0) && 
				 (strlen(p_dl_deal_sstdet_struct_h_a->h_instrdate))	
			)
		{
                       /* VaibhavK ISKB:529 23 Nov 2007 */ 
			EXEC SQL SELECT INSTR_TYPE into :l_instr_type:i_instr_type FROM MT_INSTRUMENT
			WHERE INSTR_CODE = :l_sys_dl_deal_struct_hn->h_instr_code
				AND STATUS = 'AA';

			IS_ANY_ORA_ERROR

			printf("\n l_instr_type=|%s| \n",l_instr_type);

			if(strcmp(l_instr_type,"BON"))
			{
				if (APL_FAILURE == CO_InsertErr(	l_debug_info_ptr,
															ERR_DEAL_MNYSETL_PEND,
															"DVP - DELIVER ",
															p_dl_deal_sstdet_struct_h_a->h_dl_client,
															p_dl_deal_sstdet_struct_h_a->h_indentity_no,
															__LINE__,
															__FILE__ ))
				{
					APL_GOBACK_FAIL
				}
				int_l_error_flag = APL_FAILURE;
			}
		}
		else if ( 	(strcmp(chr_deal_clh_dvp_flg,"D")==0) && 
				(VAL_RECDEAL(chr_deal_dealcd[0]))	&& 
			   (strlen(p_dl_deal_sstdet_struct_h_a->h_instrdate) == 0) && 
				 (strlen(p_dl_deal_sstdet_struct_h_a->h_moneydate))	
			)
		{
			if (APL_FAILURE == CO_InsertErr(	l_debug_info_ptr,
															ERR_DEAL_SECSETL_PEND,
															"DVP - RECEIVE ",
															p_dl_deal_sstdet_struct_h_a->h_dl_client,
															p_dl_deal_sstdet_struct_h_a->h_indentity_no,
															__LINE__,
															__FILE__ ))
			{
				APL_GOBACK_FAIL
			}
			int_l_error_flag = APL_FAILURE;
		}
	}

	l_iflag = 0;
	if (APL_FAILURE == CO_Chk_CntryEnabled(	"TRD_SETTLEMENT",
														"CAN_RECINT000",
														&l_iflag,
														l_debug_info_ptr ))
	{
		APL_GOBACK_FAIL
	}

	if ((!l_iflag) && (p_dl_deal_sstdet_struct_h_a->h_rec_int_000))
	{
		if (APL_FAILURE == CO_InsertErr(	l_debug_info_ptr,
														ERR_DEAL_CANT_RECINT000,
														l_sys_dl_deal_struct_hn->h_instr_code,
														APL_NULL_STRING,
														APL_NULL_STRING,
														__LINE__,
														__FILE__ ))
		{
			APL_GOBACK_FAIL
		}
		int_l_error_flag = APL_FAILURE;
	}
	
	if (APL_FAILURE == int_l_error_flag) APL_GOBACK_FAIL



	

	

	l_iflag = 0;

	if (APL_FAILURE == CO_Chk_CntryEnabled(	"TRD_MANIFOLD",
														"MANI_NOTREQD_FOR_MIN",
														&l_iflag,
														l_debug_info_ptr ))
	{
		APL_GOBACK_FAIL
	}
	
	EXEC SQL SELECT CLASSCD, INSTR_TYPE, REG_BR_IND, MIN_FMT_DL_QTY 
	INTO 	:chr_l_h_clscode:l_i_clscode,
			:chr_l_h_typeofinstr:l_i_typeofinstr,
			:chr_l_h_rgbrind:l_i_rgbrind,
			:l_h_minfmttrdquantity:l_i_minfmttrdqty
   FROM MT_INSTRUMENT
   WHERE instr_code = RTRIM(:l_sys_dl_deal_struct_hn->h_instr_code);

   IS_ANY_ORA_ERROR_AND_ZERO_RESULTSET( ERR_INSTR_NOTFND,
                                          l_sys_dl_deal_struct_hn->h_instr_code,
                                          APL_NULL_STRING,
                                          APL_NULL_STRING );

	if (l_mt_core_sys_params_struct_h.manifld_print_ind[0] == 'Y') 
	{
		if ((l_iflag) && (!strcmp(chr_l_h_clscode, "MIN")))
		{
			strcpy(chr_l_manif_flag, APL_NULL_STRING);
		}
		else if (l_mt_core_sys_params_struct_h.loc_proc_ind[0] == 'Y')
		{
			EXEC SQL SELECT MANIFLD_IND INTO :chr_l_manif_flag
			FROM MT_LOCATION
			WHERE location_cd = :l_sys_dl_deal_struct_hn->h_loccode;
	
			IS_ANY_ORA_ERROR_AND_ZERO_RESULTSET(	ERR_LOCN_NOTFND,
																l_sys_dl_deal_struct_hn->h_loccode,
																APL_NULL_STRING,
																APL_NULL_STRING);
																
			if (chr_l_manif_flag[0] == 'N')
			{
				chr_l_manif_flag[0] = ' ';
			}
			else
			{
				if ((VAL_DELIVER_DEAL(l_sys_dl_deal_struct_hn->h_dealcd[0])) || l_sys_dl_deal_struct_hn->h_dealcd[0]=='5' || l_sys_dl_deal_struct_hn->h_dealcd[0]=='7')
				{
					chr_l_manif_flag[0] = 'D';
				}
				else
				{
					chr_l_manif_flag[0] = 'R';
				}
			}
		}
		else
		{
			if ((VAL_DELIVER_DEAL(l_sys_dl_deal_struct_hn->h_dealcd[0])) || l_sys_dl_deal_struct_hn->h_dealcd[0]=='5' || l_sys_dl_deal_struct_hn->h_dealcd[0]=='7')
         {
            chr_l_manif_flag[0] = 'D';
         }
         else
         {
            chr_l_manif_flag[0] = 'R';
         }
		}
	}
	else
	{
		strcpy(chr_l_manif_flag, APL_NULL_STRING);
	}

   if (APL_FAILURE == DL_Chk_DLDet(  p_dl_deal_sstdet_struct_h_a->h_dl_client,
                                    p_dl_deal_sstdet_struct_h_a->h_indentity_no,
                                    'Y',		
                                    'Y',		
                                    'N',		
                                    'Y',		
                                    NULL,		
                                    NULL,
                                    NULL,
                                    chr_l_manif_flag[0],
                                    l_debug_info_ptr ))
   {
      int_l_error_flag = APL_FAILURE;
   }

	
	if (strlen(p_dl_deal_sstdet_struct_h_a->h_moneydate) == 0)
	{
		if ((!l_sys_dl_deal_struct_id->i_instrdate) && (strlen(p_dl_deal_sstdet_struct_h_a->h_instrdate)))
		{
			if (APL_FAILURE == CO_InsertErr(	l_debug_info_ptr,
															ERR_DEAL_INSTRSETL,
															p_dl_deal_sstdet_struct_h_a->h_dl_client,
															p_dl_deal_sstdet_struct_h_a->h_indentity_no,
															APL_NULL_STRING,
															__LINE__,
															__FILE__))
			{
				APL_GOBACK_FAIL
			}
			int_l_error_flag = APL_FAILURE;
		}
	}

	if (strlen(p_dl_deal_sstdet_struct_h_a->h_instrdate) == 0)
	{
		if ((!l_sys_dl_deal_struct_id->i_moneydate) && (strlen(p_dl_deal_sstdet_struct_h_a->h_moneydate)))
		{
		if (APL_FAILURE == CO_InsertErr(	l_debug_info_ptr,
														ERR_DEAL_MONSETL,
														p_dl_deal_sstdet_struct_h_a->h_dl_client,
														p_dl_deal_sstdet_struct_h_a->h_indentity_no,
														APL_NULL_STRING,
														__LINE__,
														__FILE__))
		{
			APL_GOBACK_FAIL
		}
		int_l_error_flag = APL_FAILURE;
		}
	}
	if (APL_FAILURE == int_l_error_flag) APL_GOBACK_FAIL

	

	if (APL_FAILURE == DL_Chk_TrCdInstr(	l_sys_dl_deal_struct_hn->h_instr_code,
													l_sys_dl_deal_struct_hn->h_dealcd[0],
													&int_l_retval,
													l_debug_info_ptr ))
	{
		APL_GOBACK_FAIL
	}

	if (int_l_retval == 'N')
	{
		if (APL_FAILURE == CO_InsertErr(	l_debug_info_ptr,
														ERR_DEAL_DEALTYP_NVALFORINSTR_A,
														l_sys_dl_deal_struct_hn->h_instr_code,
														APL_NULL_STRING,
														APL_NULL_STRING,
														__LINE__,
														__FILE__ ))
		{
			APL_GOBACK_FAIL
		}
		int_l_error_flag = APL_FAILURE;
	}
   
   l_iflag = 0;
   if (APL_FAILURE == CO_Chk_CntryEnabled(  "TRD_SETTLEMENT",
                                          "NDS_BLK_CONF_REQD",
                                          &l_iflag,
                                          l_debug_info_ptr ))
   {
      APL_GOBACK_FAIL
   }

	if (l_iflag)
      {  sleep(1) ; }

	

	if (APL_FAILURE == CO_RtvSysDtTime(chr_l_now, l_debug_info_ptr))
	{
		APL_GOBACK_FAIL
	}

	if (APL_FAILURE == CO_RtvSysDt(chr_l_date, l_debug_info_ptr))
	{
		APL_GOBACK_FAIL
	}

	l_iflag = 0;

	if (APL_FAILURE == CO_Chk_CntryEnabled(	"TRD_SETTLEMENT",
														"CSD>TODAY_OK",
														&l_iflag,
														l_debug_info_ptr ))
	{
		APL_GOBACK_FAIL
	}

	int_l_diff_dates = 0;
	printf("\n Before calling ... h_setldt is |%s|, now is |%s|\n",l_sys_dl_deal_struct_hn->h_setldt,chr_l_now);
	if (APL_FAILURE == CO_Pro_DateComp(	l_sys_dl_deal_struct_hn->h_setldt,
												chr_l_now,
												&int_l_diff_dates,
												l_debug_info_ptr ))
	{
		APL_GOBACK_FAIL
	}	

	if ((l_iflag == 0) && (int_l_diff_dates < 0))
	{
		if (APL_FAILURE == CO_InsertErr(	l_debug_info_ptr,
														ERR_DEAL_NO_SETL_BEFORE_CSD,
														l_sys_dl_deal_struct_hn->h_dl_client,
														l_sys_dl_deal_struct_hn->h_indentity_no,
														APL_NULL_STRING,
														__LINE__,
														__FILE__ ))
		{
			APL_GOBACK_FAIL
		}
		int_l_error_flag = APL_FAILURE;
	}

	

	 l_iflag = 0;

	if (APL_FAILURE == CO_Chk_CntryEnabled(  "TRD_SETTLEMENT",
                                          "CSD-10<TODAY",
                                          &l_iflag,
                                          l_debug_info_ptr ))
	{
      APL_GOBACK_FAIL
	}

	if ((l_iflag) && (int_l_diff_dates < -10))
	{
		if (APL_FAILURE == CO_InsertErr(	l_debug_info_ptr,
														ERR_DEAL_CSD_MINUS_10_CANT_GT_TODAY,
														l_sys_dl_deal_struct_hn->h_dl_client,	
														l_sys_dl_deal_struct_hn->h_indentity_no,
														APL_NULL_STRING,
														__LINE__,
														__FILE__ ))
		{
			APL_GOBACK_FAIL
		}
		int_l_error_flag = APL_FAILURE;
	}

	

	l_iflag = 0;
	if (APL_FAILURE == CO_Chk_CntryEnabled(	"TRD_SETTLEMENT",
														"NDS_BLK_CONF_REQD",
														&l_iflag,
														l_debug_info_ptr ))
	{
		APL_GOBACK_FAIL
	}

	if ( (l_iflag) && (strcmp(l_sys_dl_deal_struct_hn->h_lrdltype,APL_NULL_STRING) != 0 ) )
	{
		EXEC SQL SELECT NDS_BLK INTO :chr_l_h_nds
		FROM DL_LOCALREPDEALTYPE
		WHERE DEAL_CLASS = :l_sys_dl_deal_struct_hn->h_lrdltype;

		IS_ANY_ORA_ERROR_AND_ZERO_RESULTSET(	ERR_VAL_NF,
															"NDS Blk",
															APL_NULL_STRING,
															APL_NULL_STRING);

		l_iflag = 0;
		if (APL_FAILURE == CO_Chk_CntryEnabled(  "NDS_BLK_CONF_REQD",
												"CLSCODE_CHECK",
												 &l_iflag,
												  l_debug_info_ptr ))
		{
			APL_GOBACK_FAIL
		}
		if(l_iflag)
		{
			EXEC SQL SELECT CLASSCD INTO :chr_l_blclscode:l_i_blclscode
				FROM MT_INSTRUMENT
				WHERE INSTR_CODE = :l_sys_dl_deal_struct_hn->h_instr_code;

			IS_ANY_ORA_ERROR
		
			if ((chr_l_h_nds[0] == 'T') && (l_sys_dl_deal_struct_id->i_ndsbldate == -1) && (!strcmp(CLSCD_LCR, chr_l_blclscode)))
			{
				if (APL_FAILURE == CO_InsertErr(	l_debug_info_ptr,
																ERR_DEAL_NNDSBLCKCONF,
																l_sys_dl_deal_struct_hn->h_dl_client,
																l_sys_dl_deal_struct_hn->h_indentity_no,
																APL_NULL_STRING,
																__LINE__,
																__FILE__ ))
				{
					APL_GOBACK_FAIL
				}
				int_l_error_flag = APL_FAILURE;
			}
		}
		else
		{

			if ((chr_l_h_nds[0] == 'T') && (l_sys_dl_deal_struct_id->i_ndsbldate == -1))
			{
			if (APL_FAILURE == CO_InsertErr(  l_debug_info_ptr,
										 ERR_DEAL_NNDSBLCKCONF,
										 l_sys_dl_deal_struct_hn->h_dl_client,
										 l_sys_dl_deal_struct_hn->h_indentity_no,
										 APL_NULL_STRING,
										 __LINE__,
										 __FILE__ ))
			{
				APL_GOBACK_FAIL
			}
			int_l_error_flag = APL_FAILURE;
			}
		}	
	}
	


	

	if (strlen(p_dl_deal_sstdet_struct_h_a->h_instrdate))
	{

		

		int_l_diff_dates = 0;

		printf("\n Before calling ... h_instrdate is |%s|, now is |%s|\n",p_dl_deal_sstdet_struct_h_a->h_instrdate,chr_l_now);
		if (APL_FAILURE == CO_Pro_DateComp(	p_dl_deal_sstdet_struct_h_a->h_instrdate,
													chr_l_now,
													&int_l_diff_dates,
													l_debug_info_ptr ))
		{
			APL_GOBACK_FAIL
		}

		if (int_l_diff_dates < 0)
		{
			if (APL_FAILURE == CO_InsertErr(	l_debug_info_ptr,
															ERR_DEAL_INSTR_DT_CANT_FUTURE,
															l_sys_dl_deal_struct_hn->h_dl_client,
															l_sys_dl_deal_struct_hn->h_indentity_no,
															APL_NULL_STRING,
															__LINE__,
															__FILE__ ))
			{
				APL_GOBACK_FAIL
			}
			int_l_error_flag = APL_FAILURE;
		}

		

		if (int_l_diff_dates > 0)
		{
                        /* VaibhavK ISKB:529 23 Nov 2007 */
			EXEC SQL SELECT DEAL_STAT INTO :l_dl_stat:i_dl_stat
						FROM DL_DEAL
						WHERE CLIENT =: l_sys_dl_deal_struct_hn->h_dl_client AND
						IDENTIY_NO =: l_sys_dl_deal_struct_hn->h_indentity_no;
			IS_ANY_ORA_ERROR
			if(i_dl_stat == -1 || strcmp(l_dl_stat,"SS"))
			{
				strcpy(chr_l_hisposflg, "Y");
			}
		}

		

		l_iflag = 0;

		if (APL_FAILURE == CO_Chk_CntryEnabled(	"TRD_SETTLEMENT",
															"INSTR_DT<CSD",
															&l_iflag,
															l_debug_info_ptr ))
		{
			APL_GOBACK_FAIL
		}

		int_l_diff_dates = 0;

		printf("\n Before calling ... h_instrdate is |%s|, h_setldt is |%s|\n",p_dl_deal_sstdet_struct_h_a->h_instrdate,l_sys_dl_deal_struct_hn->h_setldt);
		if (APL_FAILURE == CO_Pro_DateComp( p_dl_deal_sstdet_struct_h_a->h_instrdate,
                                       l_sys_dl_deal_struct_hn->h_setldt,
                                       &int_l_diff_dates,
                                       l_debug_info_ptr ))
		{
			APL_GOBACK_FAIL
		}

		if ((!l_iflag) && (int_l_diff_dates > 0))
		{
			if (APL_FAILURE == CO_InsertErr(	l_debug_info_ptr,
															ERR_DEAL_INSTR_DT_CANT_BEFORE_CSD,
															l_sys_dl_deal_struct_hn->h_dl_client,
                                             l_sys_dl_deal_struct_hn->h_indentity_no,
                                             APL_NULL_STRING,
                                             __LINE__,
                                             __FILE__ ))
         {
            APL_GOBACK_FAIL
         }
         int_l_error_flag = APL_FAILURE;
      }

		

		int_l_diff_dates = 0;

		printf("\n Before calling ... h_instrdate is |%s|, h_confdate is |%s|\n",p_dl_deal_sstdet_struct_h_a->h_instrdate,l_sys_dl_deal_struct_hn->h_confdate);
		if (APL_FAILURE == CO_Pro_DateComp(	p_dl_deal_sstdet_struct_h_a->h_instrdate,
													l_sys_dl_deal_struct_hn->h_confdate,
													&int_l_diff_dates,
													l_debug_info_ptr ))
		{
			APL_GOBACK_FAIL
		}
		
		if (int_l_diff_dates > 0)
		{
			if (APL_FAILURE == CO_InsertErr(	l_debug_info_ptr,
															ERR_DEAL_INSTR_DT_CANT_BEFORE_CONFDT,
															l_sys_dl_deal_struct_hn->h_dl_client,
                                             l_sys_dl_deal_struct_hn->h_indentity_no,
                                             APL_NULL_STRING,
                                             __LINE__,
                                             __FILE__ ))
			{
				APL_GOBACK_FAIL
			}
			int_l_error_flag = APL_FAILURE;
		}
	}

	

	if (strlen(p_dl_deal_sstdet_struct_h_a->h_moneydate))
	{

		

		l_iflag = 0;

      if (APL_FAILURE == CO_Chk_CntryEnabled(  "TRD_SETTLEMENT",
                                             "MONEYDT>TODAY",
                                             &l_iflag,
                                             l_debug_info_ptr ))
      {
         APL_GOBACK_FAIL
      }

		int_l_diff_dates = 0;

		printf("\n Before calling ... h_moneydate is |%s|, chr_l_now is |%s|\n",p_dl_deal_sstdet_struct_h_a->h_moneydate,l_sys_dl_deal_struct_hn->h_confdate);
		if (APL_FAILURE == CO_Pro_DateComp(	p_dl_deal_sstdet_struct_h_a->h_moneydate,
													chr_l_now,
													&int_l_diff_dates,
													l_debug_info_ptr ))
		{
			APL_GOBACK_FAIL
		}

		if ((!l_iflag) && (int_l_diff_dates < 0))
		{
			if (APL_FAILURE == CO_InsertErr(	l_debug_info_ptr,
															ERR_DEAL_MONEYDT_CANT_FUTURE,
															l_sys_dl_deal_struct_hn->h_dl_client,
															l_sys_dl_deal_struct_hn->h_indentity_no,
															APL_NULL_STRING,
															__LINE__,
															__FILE__ ))
			{
				APL_GOBACK_FAIL
			}
			int_l_error_flag = APL_FAILURE;
		}

		

		if ((l_iflag) && (int_l_diff_dates < -9))
		{
         if (APL_FAILURE == CO_InsertErr(  l_debug_info_ptr,
                                             ERR_DEAL_MONEYDT_MINUS_9_CANT_AFTER_TODAY,
                                             l_sys_dl_deal_struct_hn->h_dl_client,
                                             l_sys_dl_deal_struct_hn->h_indentity_no,
                                             APL_NULL_STRING,
                                             __LINE__,
                                             __FILE__ ))
         {
            APL_GOBACK_FAIL
         }
         int_l_error_flag = APL_FAILURE;
		}

		

		l_iflag = 0;

		if (APL_FAILURE == CO_Chk_CntryEnabled(	"TRD_SETTLEMENT",
															"MONEYDT<CSD",
															&l_iflag,
															l_debug_info_ptr ))
		{
			APL_GOBACK_FAIL
		}

		int_l_diff_dates = 0;

		printf("\n Before calling ... h_moneydate is |%s|, h_setldt is |%s|\n",p_dl_deal_sstdet_struct_h_a->h_moneydate,l_sys_dl_deal_struct_hn->h_setldt);
		if (APL_FAILURE == CO_Pro_DateComp( p_dl_deal_sstdet_struct_h_a->h_moneydate,
                                       l_sys_dl_deal_struct_hn->h_setldt,
                                       &int_l_diff_dates,
                                       l_debug_info_ptr ))
		{
			APL_GOBACK_FAIL
		}

		if ((!l_iflag) && (int_l_diff_dates > 0))
		{
			if (APL_FAILURE == CO_InsertErr(	l_debug_info_ptr,
															ERR_DEAL_MONEYDT_CANT_BEFORE_CSD,
															l_sys_dl_deal_struct_hn->h_dl_client,
                                             l_sys_dl_deal_struct_hn->h_indentity_no,
                                             APL_NULL_STRING,
                                             __LINE__,
                                             __FILE__ ))
         {
            APL_GOBACK_FAIL
         }
         int_l_error_flag = APL_FAILURE;
		}

		

		int_l_diff_dates = 0;

		printf("\n Before calling ... h_moneydate is |%s|, h_confdate is |%s|\n",p_dl_deal_sstdet_struct_h_a->h_moneydate,l_sys_dl_deal_struct_hn->h_confdate);
		if (APL_FAILURE == CO_Pro_DateComp(	p_dl_deal_sstdet_struct_h_a->h_moneydate,
													l_sys_dl_deal_struct_hn->h_confdate,
													&int_l_diff_dates,
													l_debug_info_ptr ))
		{
			APL_GOBACK_FAIL
		}
		
		if (int_l_diff_dates > 0)
		{
			if (APL_FAILURE == CO_InsertErr(	l_debug_info_ptr,
															ERR_DEAL_MONEYDT_CANT_BEFORE_CONFDT,
															l_sys_dl_deal_struct_hn->h_dl_client,
                                             l_sys_dl_deal_struct_hn->h_indentity_no,
                                             APL_NULL_STRING,
                                             __LINE__,
                                             __FILE__ ))
         {
            APL_GOBACK_FAIL
         }
         int_l_error_flag = APL_FAILURE;
		}
	}
	
	

	if (l_sys_dl_deal_struct_id->i_instrdate == -1) 
	{
		strcpy(chr_l_instr_dt, p_dl_deal_sstdet_struct_h_a->h_instrdate);
	}
	else
	{
		strcpy(chr_l_instr_dt, l_sys_dl_deal_struct_hn->h_instrdate);
	}
	if (l_sys_dl_deal_struct_id->i_moneydate == -1) 
	{
		strcpy(chr_l_moneydt, p_dl_deal_sstdet_struct_h_a->h_moneydate);
	}
	else
	{
		strcpy(chr_l_moneydt, l_sys_dl_deal_struct_hn->h_moneydate);
	}

	if ((l_sys_dl_deal_struct_hn->h_isspotdl[0] == 'Y') &&
		 (strcmp(p_dl_deal_sstdet_struct_h_a->h_instrdate, p_dl_deal_sstdet_struct_h_a->h_moneydate)))
	{
		if (APL_FAILURE == CO_InsertErr(	l_debug_info_ptr,
														ERR_DEAL_INSTR_DT_NOTEQUAL_MONEYDT,
														p_dl_deal_sstdet_struct_h_a->h_dl_client,
														p_dl_deal_sstdet_struct_h_a->h_indentity_no,
														APL_NULL_STRING,
														__LINE__,
														__FILE__ ))
		{
			APL_GOBACK_FAIL
		}
		int_l_error_flag = APL_FAILURE;
	}
	else if ((strlen(chr_l_instr_dt)) && 
				(strlen(chr_l_moneydt)))
	{
	printf("\n Before calling ... chr_l_instr_dt is |%s|, chr_l_moneydt is |%s|\n",chr_l_instr_dt,chr_l_moneydt);
		if (APL_FAILURE == CO_Pro_DateComp(	chr_l_instr_dt,
													chr_l_moneydt,
													&int_l_diff_dates,
													l_debug_info_ptr ))
		{
			APL_GOBACK_FAIL
		}
	}
	else
	{
		int_l_diff_dates = 0;
	}

	if (!strcmp(l_sys_dl_deal_struct_hn->h_ex_arena, "1"))
	{
		strcpy(chr_l_settl_err_cond, l_mt_core_sys_params_struct_h.op_oth_stx_error);
	}
	else
	{
		strcpy(chr_l_settl_err_cond, l_mt_core_sys_params_struct_h.op_oth_trd_error);
	}

   if ( (!strcmp(chr_l_settl_err_cond, "<") ) &&
      ( (int_l_diff_dates > 0) ||
        ( strlen(chr_l_instr_dt) &&
        ( !strlen(chr_l_moneydt) &&
        ( VAL_VP_DEAL( l_sys_dl_deal_struct_hn->h_dealcd[0]) ) ) ) ) )
	{
		if (APL_FAILURE == CO_InsertErr(	l_debug_info_ptr,
														ERR_DEAL_MONEYDT_CANT_AFTER_INSTR_DT,
														p_dl_deal_sstdet_struct_h_a->h_dl_client,
														p_dl_deal_sstdet_struct_h_a->h_indentity_no,
														APL_NULL_STRING,
														__LINE__,
														__FILE__ ))
		{
			APL_GOBACK_FAIL
		}
		int_l_error_flag = APL_FAILURE;
	}

   if ( (!strcmp(chr_l_settl_err_cond, ">") ) &&
      ( (int_l_diff_dates < 0) ||
        ( !strlen(chr_l_instr_dt) &&
           strlen(chr_l_moneydt) ) ) )
	{
		if (APL_FAILURE == CO_InsertErr(	l_debug_info_ptr,
														ERR_DEAL_MONEYDT_CANT_BEFORE_INSTR_DT,
														p_dl_deal_sstdet_struct_h_a->h_dl_client,
														p_dl_deal_sstdet_struct_h_a->h_indentity_no,
														APL_NULL_STRING,
														__LINE__,
														__FILE__ ))
		{
			APL_GOBACK_FAIL
		}
		int_l_error_flag = APL_FAILURE;
	}

   if ( (!strcmp(chr_l_settl_err_cond, "<>") ) &&
      ( (int_l_diff_dates) ||
        ( !strlen(chr_l_instr_dt) && 
			  strlen(chr_l_moneydt) ) ||
        ( strlen(chr_l_instr_dt) && 
			 !strlen(chr_l_moneydt) && 
			 ( VAL_VP_DEAL(l_sys_dl_deal_struct_hn->h_dealcd[0]) ) ) ) )
	{
		if (APL_FAILURE == CO_InsertErr(	l_debug_info_ptr,
														ERR_DEAL_INSTR_DT_NOTEQUAL_MONEYDT,
														p_dl_deal_sstdet_struct_h_a->h_dl_client,
														p_dl_deal_sstdet_struct_h_a->h_indentity_no,
														APL_NULL_STRING,
														__LINE__,
														__FILE__ ))
		{
			APL_GOBACK_FAIL
		}
		int_l_error_flag = APL_FAILURE;
	}

	/*	Addition Exchange Code for Holiday Check	UAT	*/	
	printf("Deal Exchange Code for Holiday, |%s|",l_sys_dl_deal_struct_hn->h_exch_code);	
	
	/* added by amish - 18/01/2007 to skip exchange holiday for DVP*/
	if(!strcmp(l_sys_dl_deal_struct_hn->h_clh_flg,"D"))
	{
		strcpy(l_sys_dl_deal_struct_hn->h_exch_code,APL_NULL_STRING);
	}
	/* added by amish - 18/01/2007 */

	if (strlen(p_dl_deal_sstdet_struct_h_a->h_instrdate))
	{
		int_l_chkflg = 0;
		if (APL_FAILURE == CO_Chk_Holiday(	p_dl_deal_sstdet_struct_h_a->h_instrdate,
															&int_l_chkflg,
															l_debug_info_ptr,l_sys_dl_deal_struct_hn->h_exch_code ))
		{
			APL_GOBACK_FAIL;
		}
	
		if (int_l_chkflg)
		{
			if (APL_FAILURE == CO_InsertErr(	l_debug_info_ptr,
															ERR_DATE_IS_HOLIDAY,
															"InstrDt",
															p_dl_deal_sstdet_struct_h_a->h_dl_client,
															p_dl_deal_sstdet_struct_h_a->h_indentity_no,
															__LINE__,
															__FILE__ ))
			{
				APL_GOBACK_FAIL
			}
			int_l_error_flag = APL_FAILURE;
		} 
	}				

	if (strlen(p_dl_deal_sstdet_struct_h_a->h_moneydate))
	{
		int_l_chkflg = 0;
		if (APL_FAILURE == CO_Chk_Holiday(	p_dl_deal_sstdet_struct_h_a->h_moneydate,
															&int_l_chkflg,
															l_debug_info_ptr,l_sys_dl_deal_struct_hn->h_exch_code ))
		{
			APL_GOBACK_FAIL;
		}
	
		if (int_l_chkflg)
		{
			if (APL_FAILURE == CO_InsertErr(	l_debug_info_ptr,
															ERR_DATE_IS_HOLIDAY,
															"MoneyDt",
															p_dl_deal_sstdet_struct_h_a->h_dl_client,
															p_dl_deal_sstdet_struct_h_a->h_indentity_no,
															__LINE__,
															__FILE__ ))
			{
				APL_GOBACK_FAIL
			}
			int_l_error_flag = APL_FAILURE;
		} 
	}

	

	if (((!l_sys_dl_deal_struct_id->i_instrdate) || (!l_sys_dl_deal_struct_id->i_moneydate)) &&
		 (p_dl_deal_sstdet_struct_h_a->h_ispart_[0] == 'Y'))
	{
		if (APL_FAILURE == CO_InsertErr(	l_debug_info_ptr,
														ERR_DEAL_CANT_PARSETL,
														p_dl_deal_sstdet_struct_h_a->h_dl_client,
														p_dl_deal_sstdet_struct_h_a->h_indentity_no,
														APL_NULL_STRING,
														__LINE__,
														__FILE__))
		{
			APL_GOBACK_FAIL
		}
		int_l_error_flag = APL_FAILURE;
	}

	

	if (p_dl_deal_sstdet_struct_h_a->h_ispart_[0] == 'Y')
	{
		l_new_quantity = p_dl_deal_sstdet_struct_h_a->h_newquantity;
	}
	else
	{
		l_new_quantity = l_sys_dl_deal_struct_hn->h_qty;
	}

	if (p_dl_deal_sstdet_struct_h_a->h_marktrfquantity)
	{
		strcpy(chr_l_new_status, "002");
	}
	else if (p_dl_deal_sstdet_struct_h_a->h_rec_int_000 == l_new_quantity)
	{
		strcpy(chr_l_new_status, "000");
	}
	else
	{
		strcpy(chr_l_new_status, l_sys_dl_deal_struct_hn->h_pos_stat);
	}

	

	if (p_dl_deal_sstdet_struct_h_a->h_pr < 0)
	{
		if (APL_FAILURE == CO_InsertErr(	l_debug_info_ptr,
														ERR_VALUE_CANT_NEGATIVE,
														"Instrurity Price",
														APL_NULL_STRING,
														APL_NULL_STRING,
														__LINE__,
														__FILE__ ))
		{
			APL_GOBACK_FAIL
		}
		int_l_error_flag = APL_FAILURE;
	}

	if (p_dl_deal_sstdet_struct_h_a->h_brokercomm < 0)
	{
		if (APL_FAILURE == CO_InsertErr(	l_debug_info_ptr,
														ERR_VALUE_CANT_NEGATIVE,
														"Brok. Comm.",
														APL_NULL_STRING,
														APL_NULL_STRING,
														__LINE__,
														__FILE__ ))
		{
			APL_GOBACK_FAIL
		}
		int_l_error_flag = APL_FAILURE;
	}

	

	

	if ((l_mt_core_sys_params_struct_h.proc_reg_ind[0] == 'N') &&
		 ((p_dl_deal_sstdet_struct_h_a->h_pendregquantity) ||
		  (p_dl_deal_sstdet_struct_h_a->h_marktrfquantity) ||
		  (p_dl_deal_sstdet_struct_h_a->h_mcomplquantity) ||
		  (p_dl_deal_sstdet_struct_h_a->h_rec_int_000) ||
		  (p_dl_deal_sstdet_struct_h_a->h_delta_000) ||
		  (p_dl_deal_sstdet_struct_h_a->h_delta_001) ||
		  (p_dl_deal_sstdet_struct_h_a->h_delta_002)))
	{
		CO_InsertErr(	l_debug_info_ptr,
								ERR_DATA_INTEGRITY,
								"Partial.Reg.Qtys",
								p_dl_deal_sstdet_struct_h_a->h_dl_client,
								p_dl_deal_sstdet_struct_h_a->h_indentity_no,
								__LINE__,
								__FILE__ );
		APL_GOBACK_FAIL
	}		  

	

	if ((VAL_RECDEAL(l_sys_dl_deal_struct_hn->h_dealcd[0]) || l_sys_dl_deal_struct_hn->h_dealcd[0]=='6' || l_sys_dl_deal_struct_hn->h_dealcd[0]=='8') &&
		 ((!strcmp(l_sys_dl_deal_struct_hn->h_pos_stat, STATUS_POS_000)) ||
		  (!strcmp(l_sys_dl_deal_struct_hn->h_pos_stat, STATUS_POS_003))) &&
		 ((p_dl_deal_sstdet_struct_h_a->h_pendregquantity > 0) ||
		  (p_dl_deal_sstdet_struct_h_a->h_marktrfquantity > 0) ||
		  (p_dl_deal_sstdet_struct_h_a->h_mcomplquantity  > 0)))
	{
		CO_InsertErr(	l_debug_info_ptr,
								ERR_DATA_INTEGRITY,
								"Partial.Reg.Qtys",
								p_dl_deal_sstdet_struct_h_a->h_dl_client,
								p_dl_deal_sstdet_struct_h_a->h_indentity_no,
								__LINE__,
								__FILE__ );
		APL_GOBACK_FAIL
	}

	

	EXEC SQL SELECT CLN_ALLOW_REGIND 
	INTO :chr_l_h_canreg:l_i_canreg
	FROM MT_CLIENT
	WHERE CLN_CODE = :p_dl_deal_sstdet_struct_h_a->h_dl_client;

	IS_ANY_ORA_ERROR_AND_ZERO_RESULTSET(	ERR_ACCNOT_FND,
														p_dl_deal_sstdet_struct_h_a->h_dl_client,
														APL_NULL_STRING,
														APL_NULL_STRING);

	if ((chr_l_h_canreg[0] == 'N') && (p_dl_deal_sstdet_struct_h_a->h_marktrfquantity))
	{
		if (APL_FAILURE == CO_InsertErr(	l_debug_info_ptr,
														ERR_ACCOUNT_CANT_REGSTR,
														p_dl_deal_sstdet_struct_h_a->h_dl_client,
														APL_NULL_STRING,
														APL_NULL_STRING,
														__LINE__,
														__FILE__ ))
		{
			APL_GOBACK_FAIL
		}
		int_l_error_flag = APL_FAILURE;
	}

	

	if ((p_dl_deal_sstdet_struct_h_a->h_newquantity > 0) &&
		 (p_dl_deal_sstdet_struct_h_a->h_newquantity > l_sys_dl_deal_struct_hn->h_qty))
	{
		if (APL_FAILURE == CO_InsertErr(	l_debug_info_ptr,
														ERR_DEAL_QTY_CANT_MORE_TRDQTY,
														l_sys_dl_deal_struct_hn->h_dl_client,
														l_sys_dl_deal_struct_hn->h_indentity_no,
														APL_NULL_STRING,
														__LINE__,
														__FILE__ ))
		{
			APL_GOBACK_FAIL
		}
		int_l_error_flag = APL_FAILURE;
	}

	

	if ((!strcmp(chr_l_h_typeofinstr, "FMT")) &&
		 ((p_dl_deal_sstdet_struct_h_a->h_ispart_[0] == 'Y') &&
		  (p_dl_deal_sstdet_struct_h_a->h_newquantity < l_h_minfmttrdquantity)) ||
		 ((p_dl_deal_sstdet_struct_h_a->h_ispart_[0] != 'Y') &&
		  (l_sys_dl_deal_struct_hn->h_qty < l_h_minfmttrdquantity)))
	{
		if (APL_FAILURE == CO_InsertErr(	l_debug_info_ptr,
														ERR_QTY_CANT_LESS_MINFINQTY,
														l_sys_dl_deal_struct_hn->h_dl_client,
														l_sys_dl_deal_struct_hn->h_indentity_no,
														l_sys_dl_deal_struct_hn->h_instr_code,
														__LINE__,
														__FILE__ ))
		{
			APL_GOBACK_FAIL
		}
		int_l_error_flag = APL_FAILURE;
	}

	

	if ((!strcmp(chr_l_h_typeofinstr, "FMT")) &&
		 (p_dl_deal_sstdet_struct_h_a->h_ispart_[0] == 'Y') &&
		 ((l_sys_dl_deal_struct_hn->h_qty - p_dl_deal_sstdet_struct_h_a->h_newquantity) < l_h_minfmttrdquantity))
	{
		if (APL_FAILURE == CO_InsertWarning(	l_debug_info_ptr,
															W_REM_QTY_LESS_MINFMTQTY,
															l_sys_dl_deal_struct_hn->h_dl_client,
															l_sys_dl_deal_struct_hn->h_indentity_no,
															APL_NULL_STRING,
															__LINE__,
															__FILE__ ))
		{
			APL_GOBACK_FAIL
		}
	}

	

	if (VAL_RECDEAL(l_sys_dl_deal_struct_hn->h_dealcd[0]) || l_sys_dl_deal_struct_hn->h_dealcd[0]=='6' || l_sys_dl_deal_struct_hn->h_dealcd[0]=='8')
	{
		p_dl_deal_sstdet_struct_h_a->h_delta_000 = 0.0;
		p_dl_deal_sstdet_struct_h_a->h_delta_001 = 0.0;
		p_dl_deal_sstdet_struct_h_a->h_delta_002 = 0.0;
	}
	else
	{
		p_dl_deal_sstdet_struct_h_a->h_pendregquantity = 0.0;
		p_dl_deal_sstdet_struct_h_a->h_marktrfquantity = 0.0;
		p_dl_deal_sstdet_struct_h_a->h_mcomplquantity  = 0.0;
		p_dl_deal_sstdet_struct_h_a->h_rec_int_000  = 0.0;
	}

	

	if (l_mt_core_sys_params_struct_h.proc_reg_ind[0] == 'Y')
	{
		if (!strcmp(chr_l_h_rgbrind, BEARER_IND))
		{
			p_dl_deal_sstdet_struct_h_a->h_pendregquantity = 0;
			p_dl_deal_sstdet_struct_h_a->h_marktrfquantity = 0;
			p_dl_deal_sstdet_struct_h_a->h_mcomplquantity  = 0;
			p_dl_deal_sstdet_struct_h_a->h_rec_int_000  = 0;

			

			p_dl_deal_sstdet_struct_h_a->h_delta_000  = l_sys_dl_deal_struct_hn->h_qty;
			p_dl_deal_sstdet_struct_h_a->h_delta_001  = 0;
			p_dl_deal_sstdet_struct_h_a->h_delta_002  = 0;
			strcpy(chr_l_new_status, "000");
		}

		

		

		else if (VAL_RECDEAL(l_sys_dl_deal_struct_hn->h_dealcd[0]) || l_sys_dl_deal_struct_hn->h_dealcd[0]=='6' || l_sys_dl_deal_struct_hn->h_dealcd[0]=='8')
		{
			if (l_new_quantity != (	p_dl_deal_sstdet_struct_h_a->h_pendregquantity +
										p_dl_deal_sstdet_struct_h_a->h_marktrfquantity +
										p_dl_deal_sstdet_struct_h_a->h_mcomplquantity +
										p_dl_deal_sstdet_struct_h_a->h_rec_int_000 ))
			{
				if (APL_FAILURE == CO_InsertErr(	l_debug_info_ptr,
																ERR_DEAL_TOTQTY_CANT_MORE_DEALQTY,
																l_sys_dl_deal_struct_hn->h_dl_client,
																l_sys_dl_deal_struct_hn->h_indentity_no,
																APL_NULL_STRING,
																__LINE__,
																__FILE__ ))
				{
					APL_GOBACK_FAIL
				}
				int_l_error_flag = APL_FAILURE;
			}
		}
		else  
		{
			if (((!strcmp(l_sys_dl_deal_struct_hn->h_pos_stat, "003")) && 
				 (l_new_quantity != p_dl_deal_sstdet_struct_h_a->h_delta_002)) ||
			 	 (l_new_quantity != (	p_dl_deal_sstdet_struct_h_a->h_delta_000 +
										p_dl_deal_sstdet_struct_h_a->h_delta_001 +
										p_dl_deal_sstdet_struct_h_a->h_delta_002 )))
			{
				if (APL_FAILURE == CO_InsertErr(	l_debug_info_ptr,
																ERR_DEAL_TOTQTY_CANT_MORE_DEALQTY,
																l_sys_dl_deal_struct_hn->h_dl_client,
																l_sys_dl_deal_struct_hn->h_indentity_no,
																APL_NULL_STRING,
																__LINE__,
																__FILE__ ))
				{
					APL_GOBACK_FAIL
				}
				int_l_error_flag = APL_FAILURE;
			}
		}
	}

	

	if ((l_mt_core_sys_params_struct_h.proc_reg_ind[0] == 'Y') && 
		 (l_mt_core_sys_params_struct_h.part_reg_ind[0] == 'N'))
	{
		if (p_dl_deal_sstdet_struct_h_a->h_sel_forreg[0] == 'Y')
		{
			if (p_dl_deal_sstdet_struct_h_a->h_marktrfquantity != l_new_quantity)
			{
				if (APL_FAILURE == CO_InsertErr(	l_debug_info_ptr,
																ERR_DEAL_QTYREG_NEQUAL_TOTQTY,
																l_sys_dl_deal_struct_hn->h_dl_client,	
																l_sys_dl_deal_struct_hn->h_indentity_no,
																APL_NULL_STRING,
																__LINE__,	
																__FILE__ ))
				{
					APL_GOBACK_FAIL
				}
				int_l_error_flag = APL_FAILURE;
			}	
		}
		else if (p_dl_deal_sstdet_struct_h_a->h_sel_forreg[0] == 'N')
		{
			if (p_dl_deal_sstdet_struct_h_a->h_mcomplquantity != l_new_quantity)
			{
				if (APL_FAILURE == CO_InsertErr(	l_debug_info_ptr,
																ERR_DEAL_QTYMCL_NEQUAL_TOTQTY,
																l_sys_dl_deal_struct_hn->h_dl_client,	
																l_sys_dl_deal_struct_hn->h_indentity_no,
																APL_NULL_STRING,
																__LINE__,	
																__FILE__ ))
				{
					APL_GOBACK_FAIL
				}
				int_l_error_flag = APL_FAILURE;
			}	
		}
		else if (!strlen(p_dl_deal_sstdet_struct_h_a->h_sel_forreg))
		{
			if ((p_dl_deal_sstdet_struct_h_a->h_pendregquantity) &&
			    (p_dl_deal_sstdet_struct_h_a->h_pendregquantity != l_new_quantity))
			{
				if (APL_FAILURE == CO_InsertErr(	l_debug_info_ptr,
																ERR_DEAL_QTYPND_NEQUAL_TOTQTY,
																l_sys_dl_deal_struct_hn->h_dl_client,	
																l_sys_dl_deal_struct_hn->h_indentity_no,
																APL_NULL_STRING,
																__LINE__,	
																__FILE__ ))
				{
					APL_GOBACK_FAIL
				}
				int_l_error_flag = APL_FAILURE;
			}	
		}
	}	

	

	if (APL_FAILURE == int_l_error_flag) APL_GOBACK_FAIL

	/** Changes:AmitB 29/10/06	: Stock Split - CR**/
	printf("\n Rahul:Settl: Location=|%s| \n",l_sys_dl_deal_struct_hn->h_loccode);
	if (!strcmp(l_sys_dl_deal_struct_hn->h_classofdl,"40") && !strncmp(l_sys_dl_deal_struct_hn->h_loccode,"CSGL") && !strncmp(l_sys_dl_deal_struct_hn->h_dealcd,"3"))
	    {
		   printf("\n RAHULinside : Location=|%s| \n",l_sys_dl_deal_struct_hn->h_loccode);
		   printf("\n RAHUL:inside Settl: Location=|%s| \n",l_sys_dl_deal_struct_hn->h_classofdl);
		   strcpy(l_sys_dl_deal_struct_hn->h_classofdl,NORMALDEAL);
		
	    }
	

	IF_COND_EXISTS("SPLIT_PROCESSING","SPCR_MULTITRD")
	{	
		if (strcmp(l_sys_dl_deal_struct_hn->h_classofdl,DEALTYPE_CORP_A)==0 && (strncmp(l_sys_dl_deal_struct_hn->h_indentity_no,STOCK_SPLIT,strlen(STOCK_SPLIT) - 1)==0 ||  strncmp(l_sys_dl_deal_struct_hn->h_indentity_no,CACR_IND,strlen(CACR_IND))==0) && strncmp(l_sys_dl_deal_struct_hn->h_indentity_no,"STKSPA",6) != 0 )/* Exclude Amalgamation event Chirag 20-11-06 */
		{
			printf("\n Amit:Settl:Copy Deal Cash=|%s| to BlockType \n",l_sys_dl_deal_struct_hn->h_cash_client);
			strcpy(l_block_type,l_sys_dl_deal_struct_hn->h_cash_client);
		}
		else
		{
			if(CA_Rtv_Block_Type(  l_sys_dl_deal_struct_hn->h_indentity_no,
					l_sys_dl_deal_struct_hn -> h_classofdl,
					l_sys_dl_deal_struct_hn->h_dealcd,
					l_block_type,
					l_debug_info_ptr) == APL_FAILURE)
			{
					APL_GOBACK_FAIL
			}	
		}
	}
	else
	{
		if(CA_Rtv_Block_Type(  l_sys_dl_deal_struct_hn->h_indentity_no,
					l_sys_dl_deal_struct_hn -> h_classofdl,
					l_sys_dl_deal_struct_hn->h_dealcd,
					l_block_type,
					l_debug_info_ptr) == APL_FAILURE)
		{
				APL_GOBACK_FAIL
		}	
	}

		

		/* if(Rtv_Block_Type(  l_sys_dl_deal_struct_hn->h_indentity_no,
					l_sys_dl_deal_struct_hn -> h_classofdl,
					l_sys_dl_deal_struct_hn->h_dealcd,
					l_block_type,
					l_debug_info_ptr) == APL_FAILURE)
		{
				APL_GOBACK_FAIL
		}	*/
	printf("\n ********* Deal Status is |%s| %s************ \n",l_sys_dl_deal_struct_hn->h_deal_status,l_block_type);
	if (strcmp(l_sys_dl_deal_struct_hn->h_deal_status,"SS") != 0)	
	{
	        /* Condition added by Dipak for accounting entries passing getting stuck 
                ** taking lock on dl_safek, which is not required in AE passing */
		if 	((strlen(p_dl_deal_sstdet_struct_h_a->h_instrdate)) ||
			((!l_sys_dl_deal_struct_id->i_instrdate) && (l_mt_core_sys_params_struct_h.proc_reg_ind[0] == 'Y')))
		{	
			Alert("Updating accessstamp of DL_SAFEK record");
			if (APL_FAILURE == DL_Proc_PosLock(	l_sys_dl_deal_struct_hn->h_dl_client,
															l_sys_dl_deal_struct_hn->h_instr_code,
															l_sys_dl_deal_struct_hn->h_loccode,
															APL_NULL_STRING,l_block_type,
															l_debug_info_ptr ))
			{
				APL_GOBACK_FAIL
			}

       /* Condition Commented by Dipak for accounting entries passing issue  */
	//if ((strlen(p_dl_deal_sstdet_struct_h_a->h_instrdate)) ||
		// ((!l_sys_dl_deal_struct_id->i_instrdate) &&
		  //(l_mt_core_sys_params_struct_h.proc_reg_ind[0] == 'Y')))
	//{
			if (APL_FAILURE == DL_Proc_PosChkMod(	p_dl_deal_sstdet_struct_h_a,
															l_sys_dl_deal_struct_hn->h_instr_code,
															l_sys_dl_deal_struct_hn->h_loccode,
															chr_l_new_status,
															l_sys_dl_deal_struct_hn->h_dealcd,
															l_sys_dl_deal_struct_id->i_instrdate,
															l_sys_dl_deal_struct_hn->h_pos_stat,
															l_new_quantity,
															'C',
															l_block_type,
															&int_l_chkflg,
															l_debug_info_ptr ))
			{
				APL_GOBACK_FAIL
			}

			if (int_l_chkflg == APL_FAILURE)
			{
				if (APL_FAILURE == CO_InsertErr(	l_debug_info_ptr,
																ERR_DEAL_NENUFPOSN,
																l_sys_dl_deal_struct_hn->h_dl_client,
																l_sys_dl_deal_struct_hn->h_indentity_no,
																APL_NULL_STRING,
																__LINE__,
																__FILE__ ))
				{
					APL_GOBACK_FAIL
				}
				int_l_error_flag = APL_FAILURE;
			}
		}
	}	

	

	

	if ( l_sys_dl_deal_struct_hn->h_dlfromord[0] == 'Y' )
	{
			if ( APL_FAILURE == CO_Chk_AccValid(	p_dl_deal_sstdet_struct_h_a->h_dl_client, 
														'Y', 
														'C', 
														'B', 
														NULL, 
														'Y', 
														'N', 
														'N', 
														'N', 
														l_debug_info_ptr ) )
  		 {
     		 int_l_error_flag = APL_FAILURE;
		}
	}
	else
	{
		//Changed function name by Swapnil for Freezed client for Isolve no ISKB_2188 Start
	
		if ( strcmp(l_sys_dl_deal_struct_hn->h_classofdl,"19") == 0 )
		{

			if ( APL_FAILURE == CO_Chk_AccValid_CA(	p_dl_deal_sstdet_struct_h_a->h_dl_client, 
														'Y',
														'C',
														NULL,
														NULL,
														'Y',
														'N',
														'N',
														'N',
														l_debug_info_ptr))
			{
				printf("Swapnil **...inside  CO_Chk_AccValid_CA()  ");
				int_l_error_flag = APL_FAILURE;
			}
		}
		else
		{
			if ( APL_FAILURE == CO_Chk_AccValid(	p_dl_deal_sstdet_struct_h_a->h_dl_client, 
														'Y',
														'C',
														NULL,
														NULL,
														'Y',
														'N',
														'N',
														'N',
														l_debug_info_ptr))
			{
				printf("Swapnil... in CO_Chk_AccValid() ");
				int_l_error_flag = APL_FAILURE;
			}
		}
		//Changed function name by Swapnil for Freezed client for Isolve no ISKB_2188 End		
	}

	IF_COND_EXISTS("DL_DEAL","DOMCPAC")	
	{


		if ( APL_FAILURE == CO_Chk_AccValid(	l_sys_dl_deal_struct_hn->h_domcpclt_cd, 
													'Y', 
													'B', 
													NULL, 
													NULL, 
													'Y', 
													'N', 
													'N', 
													'N', 
													l_debug_info_ptr ) )
		{
      	int_l_error_flag = APL_FAILURE;
		}
	

	
	
		strcpy(chr_mainfuncarea, "TRD_MAINT");
		strcpy(chr_l_condid, "EXT_TRD_CNTAC_ALWD");
		l_ext_trd_check =0;

		if (APL_FAILURE == CO_Chk_CntryEnabled(chr_mainfuncarea,
														chr_l_condid,
														&l_ext_trd_check,
														l_debug_info_ptr))
		{
			APL_GOBACK_FAIL;
		}
		if (l_ext_trd_check == 0)
		{
			if((strcmp(l_mt_core_sys_params_struct_h.custody_clt_cd,int_l_domcpac)==0) ||(l_ext_trd_check==0))
			{
				if (!l_sys_dl_deal_struct_id->i_countclt)
				{
					if ( APL_FAILURE == CO_Chk_AccValid(	l_sys_dl_deal_struct_hn->h_countclt, 
															'Y', 
															'C', 
															'C', 
															NULL, 
															'Y', 
															'N', 
															'N', 
															'N', 
															l_debug_info_ptr ) )
					{
						printf("Swapnil ****  in CO_Chk_AccValid()  ");
						int_l_error_flag = APL_FAILURE;
					}
				}
			}	
		}
	
	}	

	if ( APL_FAILURE == CO_Chk_InstrValid(	l_sys_dl_deal_struct_hn->h_instr_code, 
												'Y', 
												'Y', 
												'N', 
												'N', 
												NULL, 
												'N', 
												l_debug_info_ptr ) )
	{
      int_l_error_flag = APL_FAILURE;
	}
	
	

	if (l_mt_core_sys_params_struct_h.loc_proc_ind[0] == 'Y')
	{
		if (APL_FAILURE == MT_Chk_Loc(	l_sys_dl_deal_struct_hn->h_loccode,
													'Y',
													'Y',
													NULL,
													l_debug_info_ptr ))
		{
			int_l_error_flag = APL_FAILURE;
		}
	}

	

	if ( APL_FAILURE == CO_Chk_CcyValid(	l_sys_dl_deal_struct_hn->h_currencycode, 
												'M', 
												'Y', 
												l_debug_info_ptr ) )
	{
      int_l_error_flag = APL_FAILURE;
	}
  
  
	l_lrflag=0;
	if (APL_FAILURE == CO_Chk_CntryEnabled(  "TRD_SETTLEMENT", "LR_SETTL_ORDER", &l_lrflag, l_debug_info_ptr))
	{
	  APL_GOBACK_FAIL
	}
	if (l_lrflag)
	{
		strcpy(l_pro_gseq_struct_h.sequencename, SETTLEMENT_SEQ_NO);
		strcpy(l_pro_gseq_struct_h.seq_attrb_a, APL_NULL_STRING);
		strcpy(l_pro_gseq_struct_h.seq_attrb_b, APL_NULL_STRING);
		strcpy(l_pro_gseq_struct_h.seq_attrb_c, APL_NULL_STRING);

		l_pro_gseq_struct_h.seq_stepby = 1;
		l_pro_gseq_struct_h.seq_start = 1;
		l_pro_gseq_struct_h.last_seqnum = 999999999;
		l_pro_gseq_struct_h.recycle_ind = RECYCLE_YES;
		l_lng_lr_seq_num = CO_RtvNxtSeqNum_OraSeq(&l_pro_gseq_struct_h,l_debug_info_ptr);
		if (l_lng_lr_seq_num == APL_FAILURE)
				APL_GOBACK_FAIL
	}
	  

	

	if (APL_FAILURE == int_l_error_flag) APL_GOBACK_FAIL

	/* if (APL_SUCCESS == CO_ChkErr(*l_debug_info_ptr)) APL_GOBACK_FAIL */
	
	

	

	EXEC SQL SELECT DEC_LEN
	INTO :int_l_h_amt_declen:l_i_amt_declen
	FROM DL_CURRENCY
	WHERE CURRENCY_CD = :l_sys_dl_deal_struct_hn->h_currencycode;

	IS_ANY_ORA_ERROR_AND_ZERO_RESULTSET(	ERR_CCY_NOTFND,
														l_sys_dl_deal_struct_hn->h_currencycode,
														APL_NULL_STRING,
														APL_NULL_STRING);

	

	if (!strcmp(chr_l_h_typeofinstr, "FMT"))
      p_dl_deal_sstdet_struct_h_a->h_pr/=100;

	
	
	printf("\n ********* Deal Status is |%s| ************ \n",l_sys_dl_deal_struct_hn->h_deal_status);
	if (strcmp(l_sys_dl_deal_struct_hn->h_deal_status,"SS") != 0)	
	{
		if ((strlen(p_dl_deal_sstdet_struct_h_a->h_instrdate)) ||
			 ((!l_sys_dl_deal_struct_id->i_instrdate) &&
			  (l_mt_core_sys_params_struct_h.proc_reg_ind[0] == 'Y')))
		{
			if (APL_FAILURE == DL_Proc_PosChkMod(	p_dl_deal_sstdet_struct_h_a,
															l_sys_dl_deal_struct_hn->h_instr_code,
															l_sys_dl_deal_struct_hn->h_loccode,
															chr_l_new_status,
															l_sys_dl_deal_struct_hn->h_dealcd,
															l_sys_dl_deal_struct_id->i_instrdate,
															l_sys_dl_deal_struct_hn->h_pos_stat,
															l_new_quantity,
															'U',
															l_block_type,
															&int_l_chkflg,
															l_debug_info_ptr ))
			{
				APL_GOBACK_FAIL
			}
		}
	}
	

	if (!strcmp(chr_l_h_rgbrind, BEARER_IND))
	{
		p_dl_deal_sstdet_struct_h_a->h_delta_000 = 0;
	}

	

	if	((VAL_FREE_DEAL(l_sys_dl_deal_struct_hn->h_dealcd[0])) || 
		 ((strlen(chr_l_instr_dt)) && 
		  (strlen(chr_l_moneydt))))
	{
		strcpy(chr_l_trd_status, STATUS_SETL);
		
		strcpy(chr_l_fail_code,APL_NULL_STRING);
		l_i_fail_code	= -1;
		
		
		l_i_subfailcode	=	-1;
	}
	else if (strlen(chr_l_instr_dt))
	{
		strcpy(chr_l_trd_status, STATUS_INSTR_SETL);
		
		strcpy(chr_l_fail_code,FAILREASON_539_INSTRSETL);
		l_i_fail_code	= 0;
		
		
		l_i_subfailcode	=	0;
	}
	else if (strlen(chr_l_moneydt))
	{
		strcpy(chr_l_trd_status, STATUS_MON_SETL);
		
		strcpy(chr_l_fail_code,FAILREASON_539_MONEYSETL);
		l_i_fail_code	= 0;
		
		
		l_i_subfailcode	=	0;
	}

	if (p_dl_deal_sstdet_struct_h_a->h_ispart_[0] == 'Y')
	{
		
		
		if (!strcmp(l_sys_dl_deal_struct_hn->h_maker, l_sys_dl_deal_struct_hn->h_checker))
		{
			CR_Proc_InstrQtyRound(l_sys_dl_deal_struct_hn->h_qty-p_dl_deal_sstdet_struct_h_a->h_newquantity,l_sys_dl_deal_struct_hn->h_instr_code,&h_l_quantity,l_debug_info_ptr);

			EXEC SQL	UPDATE dl_deal
			SET	QTY = :h_l_quantity,
					AMOUNT = ROUND(AMOUNT-:p_dl_deal_sstdet_struct_h_a->h_newamount,:int_l_h_amt_declen),
					PARTIAL_IND_B = 'Y',
					checker = :p_intl_envdatastruct_h->usr,
					checker_dt = :chr_l_now,
					access_stamp = :chr_l_now
			WHERE rowid = :chr_l_h_rowid;

			IS_ANY_ORA_ERROR_AND_ZERO_RESULTSET(	ERR_DEAL_NF,
																p_dl_deal_sstdet_struct_h_a->h_dl_client,
																p_dl_deal_sstdet_struct_h_a->h_indentity_no,
																APL_NULL_STRING);
		}
		else
		{
			CR_Proc_InstrQtyRound(l_sys_dl_deal_struct_hn->h_qty-p_dl_deal_sstdet_struct_h_a->h_newquantity,l_sys_dl_deal_struct_hn->h_instr_code,&h_l_quantity,l_debug_info_ptr);

			EXEC SQL	UPDATE dl_deal
			SET	QTY = :h_l_quantity,
					AMOUNT = ROUND(AMOUNT-:p_dl_deal_sstdet_struct_h_a->h_newamount,:int_l_h_amt_declen),
					PARTIAL_IND_B = 'Y',
					access_stamp = :chr_l_now
			WHERE rowid = :chr_l_h_rowid;

			IS_ANY_ORA_ERROR_AND_ZERO_RESULTSET(	ERR_DEAL_NF,
																p_dl_deal_sstdet_struct_h_a->h_dl_client,
																p_dl_deal_sstdet_struct_h_a->h_indentity_no,
																APL_NULL_STRING);
		}	
	
		

		strcpy(l_dl_dealaudit_struct_h->h_dl_client, p_dl_deal_sstdet_struct_h_a->h_dl_client);
		strcpy(l_dl_dealaudit_struct_h->h_indentity_no, p_dl_deal_sstdet_struct_h_a->h_indentity_no);
		strcpy(l_dl_dealaudit_struct_h->h_trail_for, "T");
		strcpy(l_dl_dealaudit_struct_h->h_processdetail, p_intl_envdatastruct_h->processtion);
		strcpy(l_dl_dealaudit_struct_h->h_proc_usr, p_intl_envdatastruct_h->usr);
		strcpy(l_dl_dealaudit_struct_h->h_subprocess, PARTIALEXECUTE);
		strcpy(l_dl_dealaudit_struct_h->h_logdate, APL_NULL_STRING);
		strcpy(l_dl_dealaudit_struct_h->h_fail_cd, APL_NULL_STRING);
		if ((!strlen(p_dl_deal_sstdet_struct_h_a->h_instrdate)) &&
			 (strlen(p_dl_deal_sstdet_struct_h_a->h_moneydate)))
		{
			l_dl_dealaudit_struct_h->h_qty = 0;
		}
		else
		{
			l_dl_dealaudit_struct_h->h_qty = l_sys_dl_deal_struct_hn->h_qty - l_new_quantity;
		}
		strcpy(l_dl_dealaudit_struct_h->h_dlfromord, l_sys_dl_deal_struct_hn->h_dlfromord);
						
		if (APL_FAILURE == CR_Mod_CLHAudTrail(l_dl_dealaudit_struct_h, l_debug_info_ptr))
		{
			APL_GOBACK_FAIL
		} 

		

		strcpy(l_sys_dl_deal_struct_hn->h_ispart_, "N");
		l_sys_dl_deal_struct_hn->h_qty = p_dl_deal_sstdet_struct_h_a->h_newquantity;
		l_sys_dl_deal_struct_hn->h_amt = p_dl_deal_sstdet_struct_h_a->h_newamount;
		strcpy(l_sys_dl_deal_struct_hn->h_indentity_no, p_dl_deal_sstdet_struct_h_a->h_newindentity_no);
		if ((p_dl_deal_sstdet_struct_h_a->h_mcomplquantity) || (p_dl_deal_sstdet_struct_h_a->h_marktrfquantity))
		{
			strcpy(l_sys_dl_deal_struct_hn->h_lastregdate, chr_l_date);
		}
		l_sys_dl_deal_struct_hn->h_stx_comm = 0.0;
		l_sys_dl_deal_struct_hn->h_custodycomm = 0.0;
		l_sys_dl_deal_struct_hn->h_oth_comm = 0.0;
		l_sys_dl_deal_struct_hn->h_pr = p_dl_deal_sstdet_struct_h_a->h_pr;
		
		if(int_l_partial_no_mand == 0)
			strcpy(l_sys_dl_deal_struct_hn->h_classofdl, "20");
		strcpy(l_sys_dl_deal_struct_hn->h_fail_cd, chr_l_fail_code);  
		strcpy(l_sys_dl_deal_struct_hn->h_failinfo, APL_NULL_STRING);
		strcpy(l_sys_dl_deal_struct_hn->h_custinfo, APL_NULL_STRING);
		strcpy(l_sys_dl_deal_struct_hn->h_markfaildate, APL_NULL_STRING);			
		strcpy(l_sys_dl_deal_struct_hn->h_pos_stat, chr_l_new_status);
		strcpy(l_sys_dl_deal_struct_hn->h_instrdate, p_dl_deal_sstdet_struct_h_a->h_instrdate);			
		strcpy(l_sys_dl_deal_struct_hn->h_moneydate, p_dl_deal_sstdet_struct_h_a->h_moneydate);			
		if (APL_FAILURE == DL_Rtv_DLDropToHis(	chr_l_instr_dt,
                     							chr_l_moneydt,
                     							l_sys_dl_deal_struct_hn->h_pos_stat,
                     							l_sys_dl_deal_struct_hn->h_dealcd[0],
                     							&p_dl_deal_sstdet_struct_h_a->h_mcomplquantity,
                     							&l_sys_dl_deal_struct_hn->h_complquantity,
                     							&l_sys_dl_deal_struct_hn->h_qty,
                     							chr_l_candropdt,
                     							l_debug_info_ptr ))
		{
			APL_GOBACK_FAIL
		}
		strcpy(l_sys_dl_deal_struct_hn->h_candropdate, chr_l_candropdt);
		strcpy(l_sys_dl_deal_struct_hn->h_mod_hispos_ind, chr_l_hisposflg);
		l_sys_dl_deal_struct_hn->h_brokercomm = p_dl_deal_sstdet_struct_h_a->h_brokercomm;
		l_sys_dl_deal_struct_hn->h_rec_int_000 = p_dl_deal_sstdet_struct_h_a->h_rec_int_000;
		l_sys_dl_deal_struct_hn->h_delta_000 = p_dl_deal_sstdet_struct_h_a->h_delta_000;
		l_sys_dl_deal_struct_hn->h_delta_001 = p_dl_deal_sstdet_struct_h_a->h_delta_001;
		l_sys_dl_deal_struct_hn->h_delta_002 = p_dl_deal_sstdet_struct_h_a->h_delta_002;
		strcpy(l_sys_dl_deal_struct_hn->h_deal_status, chr_l_trd_status);
		if (!strcmp(l_sys_dl_deal_struct_hn->h_maker, l_sys_dl_deal_struct_hn->h_checker))
		{
			strcpy(l_sys_dl_deal_struct_hn->h_checker, p_intl_envdatastruct_h->usr);
			strcpy(l_sys_dl_deal_struct_hn->h_checker_dt, chr_l_now);
		}
		strcpy(l_sys_dl_deal_struct_hn->h_access_stamp, chr_l_now);
   
		if (l_lrflag)
			l_sys_dl_deal_struct_hn->h_regmsgquantity = (double)l_lng_lr_seq_num;
	

		

		strcpy(p_intl_envdatastruct_h->h_mode, APL_FUNC_INPUT);

		memset(chr_l_comm_ref_no,APL_NULL_CHAR,APL_TXNREFNO_LEN+4);
		strcpy(chr_l_comm_ref_no,"CHD-");
		strcat(chr_l_comm_ref_no,l_sys_dl_deal_struct_hn->h_comm_indentity_no);

		strncpy(l_sys_dl_deal_struct_hn->h_comm_indentity_no,chr_l_comm_ref_no,APL_TXNREFNO_LEN-1);
		l_sys_dl_deal_struct_hn->h_comm_indentity_no[APL_TXNREFNO_LEN] = '\0';

		int_l_chkflg = 0;

		if (APL_FAILURE == DL_Mod_DL(	l_sys_dl_deal_struct_hn,
													APL_NULL_STRING,
													&int_l_chkflg,
													p_intl_envdatastruct_h,
													l_debug_info_ptr ))
		{
			APL_GOBACK_FAIL
		}

		

		memset(l_dl_dealaudit_struct_h, NULL, sizeof(DL_DEALAUDIT_STRUCT_H));
		strcpy(l_dl_dealaudit_struct_h->h_dl_client, p_dl_deal_sstdet_struct_h_a->h_dl_client);
		strcpy(l_dl_dealaudit_struct_h->h_indentity_no, p_dl_deal_sstdet_struct_h_a->h_newindentity_no);
		strcpy(l_dl_dealaudit_struct_h->h_trail_for, "T");
		strcpy(l_dl_dealaudit_struct_h->h_processdetail, p_intl_envdatastruct_h->processtion);
		strcpy(l_dl_dealaudit_struct_h->h_proc_usr, p_intl_envdatastruct_h->usr);
		if ((strlen(p_dl_deal_sstdet_struct_h_a->h_instrdate)) && (strlen(p_dl_deal_sstdet_struct_h_a->h_moneydate)))
		{
			strcpy(chr_l_subfun, SETTLE_SD_MD);
		}
		else if (strlen(p_dl_deal_sstdet_struct_h_a->h_instrdate))
		{
			strcpy(chr_l_subfun, SETTLE_SD);
		}
		else
		{
			strcpy(chr_l_subfun, SETTLE_MD);
		}
		strcpy(l_dl_dealaudit_struct_h->h_subprocess, chr_l_subfun);
		strcpy(l_dl_dealaudit_struct_h->h_logdate, APL_NULL_STRING);
		strcpy(l_dl_dealaudit_struct_h->h_fail_cd, chr_l_fail_code);		
		l_dl_dealaudit_struct_h->h_qty = l_new_quantity;
		strcpy(l_dl_dealaudit_struct_h->h_dlfromord, l_sys_dl_deal_struct_hn->h_dlfromord);
						
		if (APL_FAILURE == CR_Mod_CLHAudTrail(l_dl_dealaudit_struct_h, l_debug_info_ptr))
		{
			APL_GOBACK_FAIL
		} 
	}
	else 
	{

		

		if (APL_FAILURE == DL_Rtv_DLDropToHis(	chr_l_instr_dt,
      	              							chr_l_moneydt,
         	           							chr_l_new_status,
            	        							l_sys_dl_deal_struct_hn->h_dealcd[0],
               	     							&p_dl_deal_sstdet_struct_h_a->h_mcomplquantity,
                  	  							&l_sys_dl_deal_struct_hn->h_complquantity,
                    								&l_sys_dl_deal_struct_hn->h_qty,
                    								chr_l_candropdt,
                    								l_debug_info_ptr ))
		{
			APL_GOBACK_FAIL
		}

		int_l_price_declen = PR_DEC_LEN;


		

		  



		
      
       int_l_count_val=0;

       EXEC SQL SELECT count(*) INTO :int_l_count_val
       FROM PRO_GSSPLVAL
       WHERE MAIN_FUN = 'SING_SETTL'
       AND SUB_PROCESS = 'DOMCPAC'
       AND NATION = :g_mt_commonsys_params_struct_h.nation_code
       AND FIELD_VAL =:l_sys_dl_deal_struct_hn->h_domcpclt_cd ;	
	
       

       EXEC SQL SELECT FIELD_VAL INTO :chr_l_locncode_c
       FROM PRO_GSSPLVAL
       WHERE MAIN_FUN = 'SING_SETTL'
       AND SUB_PROCESS = 'LOCATION_BOND'
       AND NATION = :g_mt_commonsys_params_struct_h.nation_code;
   	
		 if  ((strcmp(l_sys_dl_deal_struct_hn->h_loccode, chr_l_locncode_c)==0) && 
			(int_l_count_val == 1) )
		
	    {
			strcpy(chr_l_new_typeoftrd,EXTERNALDEAL);
	    }
	    else
		 {
   	 	strcpy(chr_l_new_typeoftrd,l_sys_dl_deal_struct_hn->h_classofdl);
	    }


		

		
      
		

		if (APL_FAILURE == CO_Chk_CntryEnabled("TRADE_MAINT","NDS_EQ_INSTR_DT",&int_l_exist_a,l_debug_info_ptr))
		{
			APL_GOBACK_FAIL
		}
		if (int_l_exist_a > 0)
		{
			strcpy(chr_l_ndsdt,chr_l_instr_dt);
		}
		else
		{
			strcpy(chr_l_ndsdt,APL_NULL_STRING);
		}	
 
		if (!strcmp(chr_l_ndsdt,APL_NULL_STRING))
		{
			l_i_ndsdt = -1;
		}
   
		if (l_lrflag)
			l_sys_dl_deal_struct_hn->h_regmsgquantity = (double)l_lng_lr_seq_num;
	

		
		if(int_p_smieligibility_flg && !strcmp(g_mt_commonsys_params_struct_h.ei_smi_ind,"Y"))
		{
			chr_l_h_amount  =  p_dl_deal_sstdet_struct_h_a->h_newamount;
		}
		else
		{
			chr_l_h_amount  =  l_sys_dl_deal_struct_hn->h_amt;
		}

		if (!strcmp(l_sys_dl_deal_struct_hn->h_maker, l_sys_dl_deal_struct_hn->h_checker))
		{
		

			EXEC SQL UPDATE dl_deal 
			SET 	INSTRUMENT_DT		    = :chr_l_instr_dt,
					NDS_DATE        = :chr_l_ndsdt:l_i_ndsdt,
					MONEY_SETL_DT	    = :chr_l_moneydt,
					COST        = ROUND(:p_dl_deal_sstdet_struct_h_a->h_pr,:int_l_price_declen),
					brokercomm      = ROUND(:p_dl_deal_sstdet_struct_h_a->h_brokercomm,:int_l_h_amt_declen),
					STATUS_POS  = :chr_l_new_status,
					failreason_cd     = :chr_l_fail_code:l_i_fail_code,     
					sub_fail_cd	 = :int_l_h_subfailcode:l_i_subfailcode,
					fail_det     = NULL,
					client_note     = NULL,
					DATEOF_MARKFAIL	 = NULL,
					ALLOW_DROPDT	 = :chr_l_candropdt,
					MOD_HISPOS_IND = :chr_l_hisposflg,
					REC_INT_000	 = :p_dl_deal_sstdet_struct_h_a->h_rec_int_000,
					DELTA_000    = :p_dl_deal_sstdet_struct_h_a->h_delta_000,
					DELTA_001    = :p_dl_deal_sstdet_struct_h_a->h_delta_001,
					DELTA_003    = :p_dl_deal_sstdet_struct_h_a->h_delta_002,
					checker      = :p_intl_envdatastruct_h->usr,
					checker_dt 	 = :chr_l_now,
					DEAL_STAT = :chr_l_trd_status,
				   dl_class	 = :chr_l_new_typeoftrd,	
					access_stamp = :chr_l_now,
					REG_MSG_QTY    = :l_sys_dl_deal_struct_hn->h_regmsgquantity, 
					AMOUNT       = ROUND(:chr_l_h_amount,:int_l_h_amt_declen)
			WHERE rowid = :chr_l_h_rowid;

			IS_ANY_ORA_ERROR_AND_ZERO_RESULTSET(	ERR_DEAL_NF,
																p_dl_deal_sstdet_struct_h_a->h_dl_client,
																p_dl_deal_sstdet_struct_h_a->h_indentity_no,
																APL_NULL_STRING);
		}
		else
		{
			EXEC SQL UPDATE dl_deal 
			SET   INSTRUMENT_DT		    = :chr_l_instr_dt,
               NDS_DATE        = :chr_l_ndsdt:l_i_ndsdt,
					MONEY_SETL_DT	    = :chr_l_moneydt,
					COST        = ROUND(:p_dl_deal_sstdet_struct_h_a->h_pr,:int_l_price_declen),
					brokercomm      = ROUND(:p_dl_deal_sstdet_struct_h_a->h_brokercomm,:int_l_h_amt_declen),
					STATUS_POS  = :chr_l_new_status,
					failreason_cd     = :chr_l_fail_code:l_i_fail_code,    
					sub_fail_cd	 = :int_l_h_subfailcode:l_i_subfailcode,
					fail_det     = NULL,
					client_note     = NULL,
					DATEOF_MARKFAIL	 = NULL,
					ALLOW_DROPDT	 = :chr_l_candropdt,
					MOD_HISPOS_IND = :chr_l_hisposflg,
					REC_INT_000	 = :p_dl_deal_sstdet_struct_h_a->h_rec_int_000,
					DELTA_000    = :p_dl_deal_sstdet_struct_h_a->h_delta_000,
					DELTA_001    = :p_dl_deal_sstdet_struct_h_a->h_delta_001,
					DELTA_003    = :p_dl_deal_sstdet_struct_h_a->h_delta_002,
					DEAL_STAT = :chr_l_trd_status,
				   dl_class	 = :chr_l_new_typeoftrd,	
					access_stamp = :chr_l_now,
					REG_MSG_QTY    = :l_sys_dl_deal_struct_hn->h_regmsgquantity, 
					AMOUNT       = ROUND(:chr_l_h_amount,:int_l_h_amt_declen)
			WHERE CLIENT = :p_dl_deal_sstdet_struct_h_a->h_dl_client
			AND   IDENTIY_NO   = :p_dl_deal_sstdet_struct_h_a->h_indentity_no;

			IS_ANY_ORA_ERROR_AND_ZERO_RESULTSET(	ERR_DEAL_NF,
																p_dl_deal_sstdet_struct_h_a->h_dl_client,
																p_dl_deal_sstdet_struct_h_a->h_indentity_no,
																APL_NULL_STRING);
		}

		
      /*** Added By Vijay For SLB Enhancement ***/
 
      if(!strcmp(chr_l_exch_code,"NSE"))
      {
         printf("***** Vijay -----A SLB trade  \n");
        if((strcmp(chr_l_trd_mkt_type,"23")==0)&& (strcmp(chr_l_trd_status,"CS")==0))
        {
        if(APL_FAILURE == DL_SLBREVINP(p_dl_deal_sstdet_struct_h_a,p_intl_envdatastruct_h,&l_debug_info_ptr ))
        {
            APL_GOBACK_FAIL
        }
        }
      }
      else if(!strcmp(chr_l_exch_code,"BSE"))
      {
         printf("***** Vijay -----A SLB trade  \n");
        if((strcmp(chr_l_trd_mkt_type,"18")==0)&& (strcmp(chr_l_trd_status,"CS")==0))
        {
        if(APL_FAILURE == DL_SLBREVINP(p_dl_deal_sstdet_struct_h_a,p_intl_envdatastruct_h,&l_debug_info_ptr ))
        {
            APL_GOBACK_FAIL
        }
        }
      }
     
      /** SLB Ends for 1st Leg **/
	
		memset(l_dl_dealaudit_struct_h, NULL, sizeof(DL_DEALAUDIT_STRUCT_H));

		strcpy(l_dl_dealaudit_struct_h->h_dl_client, p_dl_deal_sstdet_struct_h_a->h_dl_client);
		strcpy(l_dl_dealaudit_struct_h->h_indentity_no, p_dl_deal_sstdet_struct_h_a->h_indentity_no);
		strcpy(l_dl_dealaudit_struct_h->h_trail_for, "T");
		strcpy(l_dl_dealaudit_struct_h->h_processdetail, p_intl_envdatastruct_h->processtion);
		strcpy(l_dl_dealaudit_struct_h->h_proc_usr, p_intl_envdatastruct_h->usr);
		if ((strlen(p_dl_deal_sstdet_struct_h_a->h_instrdate)) && (strlen(p_dl_deal_sstdet_struct_h_a->h_moneydate)))
		{
			strcpy(chr_l_subfun, SETTLE_SD_MD);
		}
		else if (strlen(p_dl_deal_sstdet_struct_h_a->h_instrdate))
		{
			strcpy(chr_l_subfun, SETTLE_SD);
		}
		else
		{
			strcpy(chr_l_subfun, SETTLE_MD);
		}
		strcpy(l_dl_dealaudit_struct_h->h_subprocess, chr_l_subfun);
		strcpy(l_dl_dealaudit_struct_h->h_logdate, APL_NULL_STRING);
		strcpy(l_dl_dealaudit_struct_h->h_fail_cd, chr_l_fail_code);		
		l_dl_dealaudit_struct_h->h_qty = l_sys_dl_deal_struct_hn->h_qty;
		strcpy(l_dl_dealaudit_struct_h->h_dlfromord, l_sys_dl_deal_struct_hn->h_dlfromord);
						
		if (APL_FAILURE == CR_Mod_CLHAudTrail(l_dl_dealaudit_struct_h, l_debug_info_ptr))
		{
			APL_GOBACK_FAIL
		}
	} 

	if (strlen(p_dl_deal_sstdet_struct_h_a->h_newindentity_no))
	{
		strcpy(chr_l_new_refno, p_dl_deal_sstdet_struct_h_a->h_newindentity_no);
	}
	else
	{
		strcpy(chr_l_new_refno, p_dl_deal_sstdet_struct_h_a->h_indentity_no);
	}

	if ((l_mt_core_sys_params_struct_h.proc_reg_ind[0] == 'Y') &&
		 (VAL_RECDEAL(l_sys_dl_deal_struct_hn->h_dealcd[0]) || l_sys_dl_deal_struct_hn->h_dealcd[0]=='6' || l_sys_dl_deal_struct_hn->h_dealcd[0]=='8'))
	{
		

		if (p_dl_deal_sstdet_struct_h_a->h_marktrfquantity)
		{	
			if ( APL_FAILURE == DL_Proc_Reg( p_dl_deal_sstdet_struct_h_a->h_dl_client,
															 chr_l_new_refno,
															 l_sys_dl_deal_struct_hn->h_delrecdate,
															 chr_l_date,
															 &l_sys_dl_deal_struct_hn->h_qty,
															 &p_dl_deal_sstdet_struct_h_a->h_marktrfquantity,
															 DL_MARKTRF_REGSTCODE,
															 p_intl_envdatastruct_h,
															 l_debug_info_ptr ))
			{
				APL_GOBACK_FAIL
			}
		}

		

		if (p_dl_deal_sstdet_struct_h_a->h_mcomplquantity)
		{	
			if ( APL_FAILURE == DL_Proc_Reg( p_dl_deal_sstdet_struct_h_a->h_dl_client,
															 chr_l_new_refno,
															 l_sys_dl_deal_struct_hn->h_delrecdate,
															 chr_l_date,
															 &l_sys_dl_deal_struct_hn->h_qty,
															 &p_dl_deal_sstdet_struct_h_a->h_mcomplquantity,
															 DL_MARKCOMPL_REGSTCODE,
															 p_intl_envdatastruct_h,
															 l_debug_info_ptr ))
			{
				APL_GOBACK_FAIL
			}
		}
	}


	

	if (strlen(p_dl_deal_sstdet_struct_h_a->h_instrdate))
	{
		EXEC SQL UPDATE MT_CLIENT
		SET 	CLN_POS_DT = :p_dl_deal_sstdet_struct_h_a->h_instrdate
		WHERE CLN_CODE = :p_dl_deal_sstdet_struct_h_a->h_dl_client;
	}
			
	IS_ANY_ORA_ERROR_AND_ZERO_RESULTSET(	ERR_ACCNOT_FND,
														p_dl_deal_sstdet_struct_h_a->h_dl_client,
														APL_NULL_STRING,
														APL_NULL_STRING);
	
	if  (!strcmp(l_sys_dl_deal_struct_hn->h_classofdl,RTSPROCDEAL) ||
			(!strcmp(l_sys_dl_deal_struct_hn->h_classofdl,"19")))
	{
				printf("\n 2510  %s \n",chr_l_trd_status);
		if (strcmp(chr_l_trd_status,"CS")==0 && (strcmp(l_evt_type ,CA_RT_ALLOT_IND)!=0))
		{
			if ((l_sys_dl_deal_struct_hn->h_dealcd[0] == DEALCD_RF)||(l_sys_dl_deal_struct_hn->h_dealcd[0] == DEALCD_RVP))
			{
				if( !strcmp(l_sys_dl_deal_struct_hn->h_classofdl,"19") )
				{

					printf("\n 2515 \n");
					memset(chr_l_prevseme,APL_NULL_CHAR,17);
					EXEC SQL SELECT SWIFT_MSGREFNO INTO :chr_l_prevseme:i_prevseme 
					FROM DEAL_EVNTIDLINK
					WHERE IDENTIY_NO = :l_sys_dl_deal_struct_hn->h_indentity_no
					AND CLIENT = :l_sys_dl_deal_struct_hn->h_dl_client
					AND SWIFT_MSG_NO = '563N03'
					AND ACCESS_STAMP = ( SELECT MAX(ACCESS_STAMP) FROM DEAL_EVNTIDLINK WHERE IDENTIY_NO = :l_sys_dl_deal_struct_hn->h_indentity_no
                                        AND CLIENT = :l_sys_dl_deal_struct_hn->h_dl_client AND SWIFT_MSG_NO = '563N05');

					IS_ANY_ORA_ERROR
					/*Changes:AmitB:Should check origrefno for all deals:CA trade Settlement:300507 */

					/*			  if(Rtv_Evt_Type(  l_sys_dl_deal_struct_hn->h_indentity_no,
						  l_evt_type,
						  l_op_evt_type,
						  l_debug_info_ptr) == APL_FAILURE)
					{
							Alert("Failed In Rtv_Evt_Type");
					}
					*/
					if(Rtv_Evt_Type(  l_sys_dl_deal_struct_hn->h_origindentity_no,
						  l_evt_type,
						  l_op_evt_type,
						  l_debug_info_ptr) == APL_FAILURE)
					{
						  Alert("Failed In Rtv_Evt_Type");
					}

					/*** To populate qty paid **/
			
					if(((strcmp(l_evt_type ,EVT_SPLIT)==0) && (strcmp(l_op_evt_type,"SP")==0 || strcmp(l_op_evt_type,"SR")==0))
						|| (strcmp(l_evt_type ,EVT_CAP_RED)==0 ))
					{
						EXEC SQL SELECT round(:l_sys_dl_deal_struct_hn->h_qty/QUANTITY_BAL*ELIG_ENTITL_POS,0) 
									INTO :l_recv_qty FROM CAENTITLEMENT 
									WHERE CLIENT = :l_sys_dl_deal_struct_hn->h_dl_client 
										AND CORP_ID = :l_sys_dl_deal_struct_hn->h_misinfo;
						IS_ANY_ORA_ERROR
					}
					else 
					{
						EXEC SQL SELECT QUANTITY_PAID INTO :l_recv_qty FROM CACHEQUE 
									WHERE DEAL_IDENTITY_NO = :l_sys_dl_deal_struct_hn->h_indentity_no
										AND CLIENT = :l_sys_dl_deal_struct_hn->h_dl_client ;
						IS_ANY_ORA_ERROR
					}

					if(APL_DOUBLE_EQUAL(l_recv_qty,0.0))
					l_recv_qty = l_sys_dl_deal_struct_hn->h_qty;

					sprintf( chr_param_string,"%s%s%f%s%s%s%f%s",
					  l_sys_dl_deal_struct_hn->h_indentity_no,
					  ";",
					  l_sys_dl_deal_struct_hn->h_qty,
					  ";",
					  l_evt_type,
					  ";",
					  l_recv_qty,
					  ";");


					 /* strcpy(chr_param_string,l_sys_dl_deal_struct_hn->h_indentity_no);
					 strcat(chr_param_string,";");
				   strcat(chr_param_string,l_sys_dl_deal_struct_hn->h_qty);
				   strcat(chr_param_string,";");
					 strcat(chr_param_string,"SP");
				   strcat(chr_param_string,";");
				   strcat(chr_param_string,l_sys_dl_deal_struct_hn->h_qty);
				   strcat(chr_param_string,";");     */

					 if(strncmp(l_sys_dl_deal_struct_hn->h_indentity_no,CA_IPO_ALLOT_IND,strlen(CA_IPO_ALLOT_IND)))
					 {
					if (APL_FAILURE == GBDbInsIMSGENT(	"563N03",
																	l_sys_dl_deal_struct_hn->h_misinfo,
																	l_sys_dl_deal_struct_hn->h_dl_client,
																	'Y',
																	chr_param_string,
																	l_debug_info_ptr ))
						{
							APL_GOBACK_FAIL
						  }
					 }
				
				  strcpy(l_ms_msgstat_structa.proc_init,l_sys_dl_deal_struct_hn->h_indentity_no);
				  strcpy(l_ms_msgstat_structa.swift_msg_rep,"53x"); 
				  strcpy(l_ms_msgstat_structa.client,l_sys_dl_deal_struct_hn->h_dl_client);
				  strcpy(l_ms_msgstat_structa.generate_dt,chr_l_now);


					if (APL_FAILURE == MS_Mod_MsgStat(	l_ms_msgstat_structa,
																	&int_retstat,
																	l_debug_info_ptr ))
					{
						APL_GOBACK_FAIL
					}
				
					EXEC SQL UPDATE DL_DEAL
						SET MSG_STAT = ltrim(rtrim(MSG_STAT))||'A'
						WHERE CLIENT=RTRIM(:l_sys_dl_deal_struct_hn->h_dl_client)
						AND   IDENTIY_NO  =RTRIM(:l_sys_dl_deal_struct_hn->h_indentity_no)
						AND INSTR(NVL(MSG_STAT,' '),'A') = 0
						AND INSTRUMENT_DT IS NOT NULL ; 

				   IS_ANY_ORA_ERROR 
				}
				else
				{
					printf("\n 2513 \n");
					memset(chr_l_prevseme,APL_NULL_CHAR,17);
					EXEC SQL SELECT SWIFT_MSGREFNO INTO :chr_l_prevseme:i_prevseme 
							 FROM DEAL_EVNTIDLINK
							 WHERE IDENTIY_NO = :l_sys_dl_deal_struct_hn->h_indentity_no
							 AND CLIENT = :l_sys_dl_deal_struct_hn->h_dl_client
							 AND SWIFT_MSG_NO = '563N05'
							 AND ACCESS_STAMP = ( SELECT MAX(ACCESS_STAMP) FROM DEAL_EVNTIDLINK WHERE IDENTIY_NO = :l_sys_dl_deal_struct_hn->h_indentity_no
													AND CLIENT = :l_sys_dl_deal_struct_hn->h_dl_client AND SWIFT_MSG_NO = '563N05');

					IS_ANY_ORA_ERROR
				 

					strcpy(chr_param_string,l_sys_dl_deal_struct_hn->h_instr_code);
					strcat(chr_param_string,";");
				   strcat(chr_param_string,p_eventid);
				   strcat(chr_param_string,";");
				   if (i_prevseme != -1)
				   strcat(chr_param_string,chr_l_prevseme);
				   strcat(chr_param_string,";");
				   strcat(chr_param_string,";");    

					if (APL_FAILURE == GBDbInsIMSGENT(	"563N05",
																	l_sys_dl_deal_struct_hn->h_indentity_no,
																	l_sys_dl_deal_struct_hn->h_dl_client,
																	'Y',
																	chr_param_string,
																	l_debug_info_ptr ))
						{
							APL_GOBACK_FAIL
						  }

				  strcpy(l_ms_msgstat_structa.proc_init,l_sys_dl_deal_struct_hn->h_indentity_no);
				  strcpy(l_ms_msgstat_structa.swift_msg_rep,"563N05"); 
				  strcpy(l_ms_msgstat_structa.client,l_sys_dl_deal_struct_hn->h_dl_client);
				  strcpy(l_ms_msgstat_structa.generate_dt,chr_l_now);


					if (APL_FAILURE == MS_Mod_MsgStat(	l_ms_msgstat_structa,
																	&int_retstat,
																	l_debug_info_ptr ))
					{
						APL_GOBACK_FAIL
					}

					EXEC SQL UPDATE DL_DEAL
						SET MSG_STAT = ltrim(rtrim(MSG_STAT))||'A'
						WHERE CLIENT=RTRIM(:l_sys_dl_deal_struct_hn->h_dl_client)
						AND   IDENTIY_NO  =RTRIM(:l_sys_dl_deal_struct_hn->h_indentity_no)
						AND INSTR(NVL(MSG_STAT,' '),'A') = 0
						AND INSTRUMENT_DT IS NOT NULL ; 

				   IS_ANY_ORA_ERROR 
				}
			}
			else
			{
	    		EXEC SQL UPDATE DL_DEAL
				SET MSG_STAT = ltrim(rtrim(MSG_STAT))||'A'
				WHERE CLIENT=RTRIM(:l_sys_dl_deal_struct_hn->h_dl_client)
				AND   IDENTIY_NO  =RTRIM(:l_sys_dl_deal_struct_hn->h_indentity_no)
				AND INSTR(NVL(MSG_STAT,' '),'A') = 0
				AND INSTRUMENT_DT IS NOT NULL ; 

				IS_ANY_ORA_ERROR 
			}
		}
		else
		{
			printf("\n 2569 \n");
		   EXEC SQL UPDATE DL_DEAL
				SET MSG_STAT = ltrim(rtrim(MSG_STAT))||'C'
				WHERE CLIENT=RTRIM(:l_sys_dl_deal_struct_hn->h_dl_client)
				AND   IDENTIY_NO  =RTRIM(:l_sys_dl_deal_struct_hn->h_indentity_no)
				AND INSTR(NVL(MSG_STAT,' '),'C') = 0;
	 

		   IS_ANY_ORA_ERROR  
		}      

	}
	else if ((!strcmp(l_sys_dl_deal_struct_hn->h_classofdl,"11")) && (!strcmp(l_sys_dl_deal_struct_hn->h_entry,"G")))
	{ 
		if (strcmp(chr_l_trd_status,"CS")==0)
		{  
			memset(chr_l_sc_eventid,APL_NULL_CHAR,17);
			EXEC SQL SELECT EVENT_ID INTO :chr_l_sc_eventid:i_sc_eventid
			FROM DEAL_EVNTIDLINK
			WHERE SWIFT_MSG_NO='563N04'
			AND CLIENT = :l_sys_dl_deal_struct_hn->h_dl_client
			AND IDENTIY_NO = :l_sys_dl_deal_struct_hn->h_indentity_no;

			IS_ANY_ORA_ERROR   
			

			strcpy(chr_param_string,APL_NULL_STRING);
			strcat(chr_param_string,";");
			strcat(chr_param_string,chr_l_sc_eventid);
			strcat(chr_param_string,";");

			if(l_sys_dl_deal_struct_hn->h_dealcd[0] == DEALCD_DF)
			  strcat(chr_param_string,"D");
			else 
			  strcat(chr_param_string,"R");

			strcat(chr_param_string,";");
	   
			if (APL_FAILURE == GBDbInsIMSGENT("563N04",l_sys_dl_deal_struct_hn->h_indentity_no,l_sys_dl_deal_struct_hn->h_dl_client,'Y',chr_param_string,l_debug_info_ptr))
				 APL_GOBACK_FAIL 
			strcpy(l_ms_msgstat_structa.proc_init,l_sys_dl_deal_struct_hn->h_indentity_no);
			strcpy(l_ms_msgstat_structa.swift_msg_rep,"53x"); 
			strcpy(l_ms_msgstat_structa.client,l_sys_dl_deal_struct_hn->h_dl_client);
			strcpy(l_ms_msgstat_structa.generate_dt,chr_l_now);

			if(APL_FAILURE == MS_Mod_MsgStat(l_ms_msgstat_structa,&int_retstat,l_debug_info_ptr))
					{
					  APL_GOBACK_FAIL
					}

		   EXEC SQL UPDATE DL_DEAL
            SET MSG_STAT = ltrim(rtrim(MSG_STAT))||'A'
            WHERE CLIENT=RTRIM(:l_sys_dl_deal_struct_hn->h_dl_client)
            AND   IDENTIY_NO  =RTRIM(:l_sys_dl_deal_struct_hn->h_indentity_no)
            AND INSTR(NVL(MSG_STAT,' '),'A') = 0
            AND INSTRUMENT_DT IS NOT NULL ;

            IS_ANY_ORA_ERROR
		}
		else
		{
			EXEC SQL UPDATE DL_DEAL
            SET MSG_STAT = ltrim(rtrim(MSG_STAT))||'C'
            WHERE CLIENT=RTRIM(:l_sys_dl_deal_struct_hn->h_dl_client)
            AND   IDENTIY_NO  =RTRIM(:l_sys_dl_deal_struct_hn->h_indentity_no)
            AND INSTR(NVL(MSG_STAT,' '),'C') = 0;
    
            IS_ANY_ORA_ERROR 
		}
        
	}
	else if(strcmp(chr_l_trd_status, STATUS_INSTR_SETL)==0)
	{
		strcpy(chr_l_msg_type, "539");
		memset(chr_param_string,APL_NULL_CHAR,201);
		strcpy(chr_param_string,chr_l_instr_dt);
		strcat(chr_param_string,";");

		if (APL_FAILURE == GBDbInsIMSGENT(  "539",
											  l_sys_dl_deal_struct_hn->h_indentity_no,
											  l_sys_dl_deal_struct_hn->h_dl_client,
											  'Y',
											  chr_param_string,
											  l_debug_info_ptr ))
		{
			 APL_GOBACK_FAIL
		}

		memset(chr_param_string,APL_NULL_CHAR,201);
		strcpy(chr_param_string,APL_NULL_STRING);
		if ( APL_FAILURE == GBDbInsIMSGENT( MS_MSGNO_534,
				                                     l_sys_dl_deal_struct_hn->h_indentity_no,
				                                     l_sys_dl_deal_struct_hn->h_dl_client,
				                                     'Y',
				                                     chr_param_string,
				                                     l_debug_info_ptr ) )
		{
			APL_GOBACK_FAIL;
		}



	}
	else if(strcmp(chr_l_trd_status, STATUS_MON_SETL)==0)
	{
		memset(chr_param_string,APL_NULL_CHAR,201);
		strcpy(chr_param_string,APL_NULL_STRING);
		if ( APL_FAILURE == GBDbInsIMSGENT( MS_MSGNO_534,
												 l_sys_dl_deal_struct_hn->h_indentity_no,
												 l_sys_dl_deal_struct_hn->h_dl_client,
												 'Y',
												 chr_param_string,
												 l_debug_info_ptr ) )
		{
			   APL_GOBACK_FAIL;
		}
	}
	else if (l_mt_core_sys_params_struct_h.ms_53x_online_eod_ind[0] == MS_SEND53X_ONLINE_IND)
	{

	

	

		strcpy(chr_l_msg_type, "53x");
		memset(chr_param_string,APL_NULL_CHAR,201);
		strcpy(chr_param_string,APL_NULL_STRING);

		if (APL_FAILURE == GBDbInsIMSGENT(	chr_l_msg_type,
														l_sys_dl_deal_struct_hn->h_indentity_no,
														l_sys_dl_deal_struct_hn->h_dl_client,
														'Y',
														chr_param_string,
														l_debug_info_ptr ))
		{
			APL_GOBACK_FAIL
		}
	}

	printf("values are l_sys_dl_deal_struct_hn->h_setldt is %s, l_sys_dl_deal_struct_hn->h_dl_client is %s, l_sys_dl_deal_struct_hn->h_indentity_no is %s \n",l_sys_dl_deal_struct_hn->h_setldt,l_sys_dl_deal_struct_hn->h_dl_client,l_sys_dl_deal_struct_hn->h_indentity_no);
	if(strncmp(l_sys_dl_deal_struct_hn->h_indentity_no,"LOCCHG",6)== 0)
	{
		if(l_sys_dl_deal_struct_hn->h_dealcd[0] == DEALCD_DF)
		{
			EXEC SQL UPDATE DL_LOCNCHG 
					 	SET DF_SETLDATE=:l_sys_dl_deal_struct_hn->h_setldt
					 	WHERE DF_TXNR_IDEN =:l_sys_dl_deal_struct_hn->h_indentity_no
								AND CLIENT = :l_sys_dl_deal_struct_hn->h_dl_client;
			
			IS_ANY_ORA_ERROR
		} 
		
		if(l_sys_dl_deal_struct_hn->h_dealcd[0] == DEALCD_RF)
		{
			EXEC SQL UPDATE DL_LOCNCHG 
					 	SET RF_SETL_DATE=:l_sys_dl_deal_struct_hn->h_setldt
					 	WHERE RF_DL_IDENT =:l_sys_dl_deal_struct_hn->h_indentity_no
							 	AND CLIENT = :l_sys_dl_deal_struct_hn->h_dl_client;
			
			IS_ANY_ORA_ERROR
		} 
	}

   
	if (strcmp(chr_l_trd_status,STATUS_SETL)==0)
	{
		if ((g_mt_commonsys_params_struct_h.ccs_ind[0] != 'Y') && (strstr(l_sys_dl_deal_struct_hn->h_msg_stat,"O")>0))
		{
			
			if ( APL_FAILURE ==  DL_Mod_CCSPendDL(l_sys_dl_deal_struct_hn->h_dl_client,
														l_sys_dl_deal_struct_hn->h_indentity_no,
                                          MS_CCS_XS,
                                          APL_NULL_STRING,
                                          APL_NULL_STRING,
                                          APL_NULL_STRING,
                                          &l_debug_info_ptr) )
			{
        		APL_GOBACK_FAIL
			}
		}
		else
		{
			if ( APL_FAILURE ==  DL_Mod_CCSPendDL(l_sys_dl_deal_struct_hn->h_dl_client,
														l_sys_dl_deal_struct_hn->h_indentity_no,
                                          MS_CCS_SC,
                                          APL_NULL_STRING,
                                          APL_NULL_STRING,
                                          APL_NULL_STRING,
                                          &l_debug_info_ptr) )
			{
        		APL_GOBACK_FAIL
			}
		}
	}
   

	 

	if (APL_FAILURE==EI_Mod_MQData(l_sys_dl_deal_struct_hn->h_dl_client,
                                        l_sys_dl_deal_struct_hn->h_indentity_no,
                                        NULL,
                                        NULL,
                                        "B",
                                        l_debug_info_ptr))
		APL_GOBACK_FAIL


	
	
	APL_GOBACK_SUCCESS

	RETURN_SUCCESS :
      APL_IF_DEBUG
         CO_ProcMonitor(APL_OUT_FILE,"Leaving Function DL_Proc_DLSetlSing successfully", NULL, p_intl_envdatastruct_h);
		free(l_sys_dl_deal_struct_hn);
		free(l_sys_dl_deal_struct_id);
		free(l_reg_trf_struct_h);
		free(l_dl_dealaudit_struct_h);
      return(APL_SUCCESS);

	RETURN_FAILURE :
      APL_IF_DEBUG
         CO_ProcMonitor(APL_OUT_FILE,"Leaving Function DL_Proc_DLSetlSing with errors", NULL, p_intl_envdatastruct_h);
		//free(l_sys_dl_deal_struct_hn);
		//free(l_sys_dl_deal_struct_id);
		//free(l_reg_trf_struct_h);
		//free(l_dl_dealaudit_struct_h);
      return(APL_FAILURE);

}





int DL_Proc_DLSetlRRMMSing(	DL_DEAL_SSTDET_STRUCT_H *p_dl_deal_sstdet_struct_h_a,
                     char            *p_ru_eventid,
							char				 *srn_params_str,
							INTL_ENV_DATA_STRUCT_H *p_intl_envdatastruct_h,	
							DEBUG_INFO_STRUCT_H **l_debug_info_ptr )
{

	

	struct sqlca sqlca;	

	int 		int_l_error_flag 								= APL_SUCCESS;
	int		int_l_diff_dates 								= 0;
	int		int_l_chkflg 	 								= 0;
	int		int_l_h_amt_declen								= 0;
	int		int_l_price_declen 							= 0;
	int		int_l_h_par_srlno								= 0;
	int 		int_noelem										= 0;
	int		i												= 0;	
	int		int_nlen											= 0;

	double   p_new_amount								= 0.0; 
	double 	l_new_quantity 									= 0.0; 
	double   h_srn_quantity									= 0.0;
	double 	h_l_quantity 										= 0.0;
	double	l_h_minfmttrdquantity							= 0.0;

	char  	chr_l_h_rowid[APL_ROWID_LEN] 				= APL_NULL_STRING;
	char  	chr_l_now[APL_DATE_LEN] 						= APL_NULL_STRING;
	char  	chr_l_date[APL_DATE_LEN] 					= APL_NULL_STRING;
	char		chr_l_manif_flag[APL_FLAG_LENGTH] 			= APL_NULL_STRING;
	char		chr_l_subfun[APL_SUB_FUN_LEN] 				= APL_NULL_STRING;
	char		chr_l_settl_err_cond[ERROR_COND_LEN] 	= APL_NULL_STRING;
	char		chr_l_instr_dt[APL_DATE_LEN] 					= APL_NULL_STRING;
	char		chr_l_moneydt[APL_DATE_LEN] 				= APL_NULL_STRING;
	char		int_l_retval 									= NULL;
	char		chr_l_h_clscode[CLSCD_LEN] 			= APL_NULL_STRING;
	char		chr_l_new_status[STATUS_POS_LEN] 		= APL_NULL_STRING;
	char		chr_l_new_refno[APL_TXNREFNO_LEN] 		= APL_NULL_STRING;
	char		chr_l_h_par_accst[APL_DATE_LEN] 			= APL_NULL_STRING;
	char		chr_l_h_regstatus[APL_FLAG_LENGTH] 			= APL_NULL_STRING;
	char		chr_l_candropdt[APL_DATE_LEN] 				= APL_NULL_STRING;
	char		chr_l_h_nds[APL_FLAG_LENGTH]					= APL_NULL_STRING;
	char		chr_l_h_typeofinstr[TYPEOF_INSTR_LEN]				= APL_NULL_STRING;
	char		chr_l_h_rgbrind[RGBRIND_LEN]				= APL_NULL_STRING;
	char		chr_l_h_canreg[APL_FLAG_LENGTH]				= APL_NULL_STRING;
	char		chr_l_trd_status[APL_STATUS_LEN]			= APL_NULL_STRING;
	char		chr_l_hisposflg[APL_FLAG_LENGTH]				= APL_NULL_STRING;
	char		chr_l_buf[BUFFER_LEN]							= APL_NULL_STRING;
	char		chr_l_msg_type[4]								= APL_NULL_STRING;
   char     chr_l_locncode_c[APL_LOCNCODE_LENGTH]        = APL_NULL_STRING;  
   char		chr_l_new_typeoftrd[DEALTYPE_LEN_A]      = APL_NULL_STRING;   
   char     int_l_domcpac[APL_CLIENT_LENGTH]				= APL_NULL_STRING;  
	char     chr_l_ndsdt[APL_DATE_LEN]					= APL_NULL_STRING; 
   char     chr_h_srnregno[APL_SRN_LEN]					= APL_NULL_STRING; 	
   char     chr_l_h_acc_class[3]							= APL_NULL_STRING; 	
	char     chr_mainfuncarea[APL_MAINFUNCAREA_LEN]= APL_NULL_STRING;
   char     chr_l_condid[APL_CONDID_LEN]            = APL_NULL_STRING;
	/* OPT:AIX char 		**chr_l_param									= APL_NULL_STRING; */
	char 		**chr_l_param									= NULL;
	char     *chr_posofspace_A                         = APL_NULL_STRING;
	char 		chr_l_h_ru_rowid[APL_ROWID_LEN]			= APL_NULL_STRING;
	char 		l_block_type[5]			= APL_NULL_STRING;

	short		l_partial_ma 								= 0;
	short		l_iflag 		  								= 0;
	short		l_i_rowid	 								= 0;
	short		l_i_clscode	 								= 0;	
	short		l_i_typeofinstr  								= 0;
	short		l_i_rgbrind									= 0;
	short		l_i_canreg	 								= 0;
	short		l_i_amt_declen								= 0;
	short		l_i_par_accst  							= 0;
	short		l_i_par_srlno								= 0;
	short		l_i_minfmttrdqty							= 0;
   short    int_l_exist_a                             = 0;
	short    l_i_ndsdt                           = 0;
   short    l_i_acc_class								= 0; 	
   short 	l_i_ru_rowid								= 0;
	short      int_l_condexists								= 0;
   int      int_h_count              					= 0; 



	char		chr_l_fail_code[FAILREAS_CD_LEN]			= APL_NULL_STRING;
	short		l_i_fail_code								= 0;

	

	int		int_l_h_subfailcode							= 0;
	short		l_i_subfailcode							= 0;

	SYS_DL_DEAL_STRUCT_H	*l_sys_dl_deal_struct_hn 		= NULL;
	SYS_DL_DEAL_STRUCT_I	*l_sys_dl_deal_struct_id 		= NULL;
	DL_DEALAUDIT_STRUCT_H *l_dl_dealaudit_struct_h  = NULL;
	DL_REGDET_STRUCT_H *l_reg_trf_struct_h 		= NULL;
	DEAL_RU_STRUCT_H *l_deal_ru_struct_h	= NULL;	
	REQDETAILS_STRUCT_H l_reqdetails_struct_h;

	
	char chr_param_string[201] = APL_NULL_STRING;
	char chr_lp_param_string[30] = APL_NULL_STRING;
	MS_MSGSTAT_STRUCT l_ms_msgstat_structa  ;
	int int_retstat=0;
	

   char chr_l_prevseme[17];
   short i_prevseme = 0;
   char chr_l_sc_eventid[17];
   short i_sc_eventid=0;
   int int_lp_count=0;
   int int_lp_noelem=0;
   char **chr_lp_param;
   char chr_lp_cetyp[10] = APL_NULL_STRING;
   char chr_lp_decldt[APL_DATE_LEN] = APL_NULL_STRING;
   char chr_lp_eventnbr[10] = APL_NULL_STRING;
   char chr_lp_event[17] = APL_NULL_STRING;
	char chr_l_cubk_exttrd[2] = APL_NULL_STRING;
	short l_ext_trd_check   =  0  ;   

	#ifdef APL_THREADS
		APL_SET_CONTEXT
		EXEC SQL CONTEXT USE	:my_ctx_local;
	#endif

	sqlca.sqlcode = 0;

	

	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_dl_client  			IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_indentity_no 				IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_dlt 					IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_setldt 			IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_ex_arena				IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_instrdate					IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_moneydate				IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_domcpclt_cd				IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_isspotdl			IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_dlfromord			IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_entry 			IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_reapired_ind			IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_domcp_custodyclt			IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_countclt 			IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_countcltnm			IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_clientof			IS STRING;		
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_custinfo				IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_fx_reqd				IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_ispymtlocal			IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_verfied_with				IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_brkrno				IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_fail_cd				IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_failinfo				IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_ispart_			IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_report_at_eom_ind				IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_billdate				IS STRING;	
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_locindentity_no				IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_instruct_person			IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_dealcd				IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_instr_code				IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_currencycode				IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_classofdl			IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_origindentity_no			IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_newdt				IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_maker					IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_maker_dt				IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_deal_status		IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_access_stamp		IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_info1					IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_loccode 			IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_reginstr_ind				IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_pos_stat			IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_status_reg			IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_confdate				IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_matchindentity_no			IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_markfaildate			IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_candropdate			IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_checker				IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_checker_dt			IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_instrconv_ind			IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_ndsbldate				IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_lrdltype			IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_ndsdate					IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_ublckdate				IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_delrecdate				IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_lastregdate			IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_lr_chkdate				IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_lr_confdate			IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_lr_instrdate				IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_tmpoutdate				IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_tmpretdate				IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_transmitdate			IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_hostdate				IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_lr_ndsbldate			IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_lr_ndsdate				IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_lr_ublckdate			IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_clt_reqdel_flag		IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_mod_hispos_ind		IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_updhispos_date		IS STRING;
	EXEC SQL VAR int_l_domcpac		IS STRING;
	EXEC SQL VAR chr_l_locncode_c		IS STRING;
	EXEC SQL VAR chr_l_ndsdt                      IS STRING;
	EXEC SQL VAR chr_l_h_acc_class                IS STRING;
	EXEC SQL VAR chr_h_srnregno							IS STRING; 
	EXEC SQL VAR chr_l_h_clscode   IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hn->h_cash_client 		IS STRING; 
   EXEC SQL VAR l_sys_dl_deal_struct_hn->h_msg_stat 			IS STRING;
      
   EXEC SQL VAR l_sys_dl_deal_struct_hn->h_instruct_personnm       IS STRING;
   EXEC SQL VAR l_sys_dl_deal_struct_hn->h_clientofcode     IS STRING;
   EXEC SQL VAR l_sys_dl_deal_struct_hn->h_inter_med_person         IS STRING;
   EXEC SQL VAR l_sys_dl_deal_struct_hn->h_inter_med_personnm       IS STRING;
      
   EXEC SQL VAR l_sys_dl_deal_struct_hn->h_fxccy       IS STRING;
   EXEC SQL VAR l_sys_dl_deal_struct_hn->h_exp_setl_date       IS STRING;
   EXEC SQL VAR l_sys_dl_deal_struct_hn->h_misinfo            IS STRING; 
   EXEC SQL VAR l_sys_dl_deal_struct_hn->h_exch_code            IS STRING; 

	

	l_sys_dl_deal_struct_hn = (SYS_DL_DEAL_STRUCT_H *)calloc(1, sizeof(SYS_DL_DEAL_STRUCT_H));
	l_sys_dl_deal_struct_id = (SYS_DL_DEAL_STRUCT_I *)calloc(1, sizeof(SYS_DL_DEAL_STRUCT_I));
	l_reg_trf_struct_h = (DL_REGDET_STRUCT_H *)calloc(1, sizeof(DL_REGDET_STRUCT_H));
	l_dl_dealaudit_struct_h = (DL_DEALAUDIT_STRUCT_H *)calloc(1, sizeof(DL_DEALAUDIT_STRUCT_H));

	
	l_deal_ru_struct_h = (DEAL_RU_STRUCT_H *)calloc(1, sizeof(DEAL_RU_STRUCT_H));

	
	memset(&l_ms_msgstat_structa,NULL,sizeof(MS_MSGSTAT_STRUCT)); 
	
	
	
	memset(chr_h_srnregno, APL_NULL_CHAR, APL_SRN_LEN); 	
	memset(chr_mainfuncarea, APL_NULL_CHAR, APL_MAINFUNCAREA_LEN);
   memset(chr_l_condid, APL_NULL_CHAR, APL_CONDID_LEN);

	APL_MALLOC_FAIL(l_sys_dl_deal_struct_hn);
	APL_MALLOC_FAIL(l_sys_dl_deal_struct_id);
	APL_MALLOC_FAIL(l_reg_trf_struct_h);
	APL_MALLOC_FAIL(l_dl_dealaudit_struct_h);
	APL_MALLOC_FAIL(l_deal_ru_struct_h);
	
	

	APL_IF_DEBUG
	{
		CO_ProcMonitor(	APL_OUT_FILE, 
						"Entered Function CDBUpdSSTDetFn", 
						NULL, 
						p_intl_envdatastruct_h );
		memset(chr_l_buf, NULL, BUFFER_LEN);
		sprintf(	chr_l_buf, 
					"The Account is         : %s",	
					p_dl_deal_sstdet_struct_h_a->h_dl_client);
		CO_ProcMonitor(	APL_OUT_FILE, 
						chr_l_buf, 
						NULL, 
						p_intl_envdatastruct_h);
		memset(chr_l_buf, NULL, BUFFER_LEN);
		sprintf(	chr_l_buf, 
					"The RefNo is           : %s", 
					p_dl_deal_sstdet_struct_h_a->h_indentity_no);
		CO_ProcMonitor(	APL_OUT_FILE, 
						chr_l_buf, 
						NULL, 
						p_intl_envdatastruct_h);
		memset(chr_l_buf, NULL, BUFFER_LEN);
		sprintf(	chr_l_buf, 
					"The Ispartial is       : %s", 
					p_dl_deal_sstdet_struct_h_a->h_ispart_);
		CO_ProcMonitor(	APL_OUT_FILE, 
						chr_l_buf, 
						NULL, 
						p_intl_envdatastruct_h);
		memset(chr_l_buf, NULL, BUFFER_LEN);
		sprintf(	chr_l_buf, 
					"The NewQuantity is     : %f", 
					p_dl_deal_sstdet_struct_h_a->h_newquantity);
		CO_ProcMonitor(	APL_OUT_FILE, 
						chr_l_buf, 
						NULL, 
						p_intl_envdatastruct_h);
		memset(chr_l_buf, NULL, BUFFER_LEN);
		sprintf(	chr_l_buf, 
					"The NewAmount is       : %f", 
					p_dl_deal_sstdet_struct_h_a->h_newamount);
		CO_ProcMonitor(	APL_OUT_FILE, 
						chr_l_buf, 
						NULL, 
						p_intl_envdatastruct_h);
		memset(chr_l_buf, NULL, BUFFER_LEN);
		sprintf(	chr_l_buf, 
					"The NewRefNo is        : %s", 
					p_dl_deal_sstdet_struct_h_a->h_newindentity_no);
		CO_ProcMonitor(	APL_OUT_FILE, 
						chr_l_buf, 
						NULL, 
						p_intl_envdatastruct_h);
		memset(chr_l_buf, NULL, BUFFER_LEN);
		sprintf(	chr_l_buf, 
					"The Instr. Dt. is        : %s", 
					p_dl_deal_sstdet_struct_h_a->h_instrdate);
		CO_ProcMonitor(	APL_OUT_FILE, 
						chr_l_buf, 
						NULL, 
						p_intl_envdatastruct_h);
		memset(chr_l_buf, NULL, BUFFER_LEN);
		sprintf(	chr_l_buf, 
					"The Money Dt. is       : %s", 
					p_dl_deal_sstdet_struct_h_a->h_moneydate);
		CO_ProcMonitor(	APL_OUT_FILE, 
						chr_l_buf, 
						NULL, 
						p_intl_envdatastruct_h);
		memset(chr_l_buf, NULL, BUFFER_LEN);
		sprintf(	chr_l_buf, 
					"The Price is           : %f", 
					p_dl_deal_sstdet_struct_h_a->h_pr);
		CO_ProcMonitor(	APL_OUT_FILE, 
						chr_l_buf, 
						NULL, 
						p_intl_envdatastruct_h);
		memset(chr_l_buf, NULL, BUFFER_LEN);
		sprintf(	chr_l_buf, 
					"The Brk. Comm. is      : %f", 
					p_dl_deal_sstdet_struct_h_a->h_brokercomm);
		CO_ProcMonitor(	APL_OUT_FILE, 
						chr_l_buf, 
						NULL, 
						p_intl_envdatastruct_h);
		memset(chr_l_buf, NULL, BUFFER_LEN);
		sprintf(	chr_l_buf, 
					"The Sel. For Reg. is   : %s", 
					p_dl_deal_sstdet_struct_h_a->h_sel_forreg);
		CO_ProcMonitor(	APL_OUT_FILE, 
						chr_l_buf, 
						NULL, 
						p_intl_envdatastruct_h);
		memset(chr_l_buf, NULL, BUFFER_LEN);
		sprintf(	chr_l_buf, 
					"The Pend Reg Qty is    : %f", 
					p_dl_deal_sstdet_struct_h_a->h_pendregquantity);
		CO_ProcMonitor(	APL_OUT_FILE, 
						chr_l_buf, 
						NULL, 
						p_intl_envdatastruct_h);
		memset(chr_l_buf, NULL, BUFFER_LEN);
		sprintf(	chr_l_buf, 
					"The Mark Trf Qty is    : %f", 
					p_dl_deal_sstdet_struct_h_a->h_marktrfquantity);
		CO_ProcMonitor(	APL_OUT_FILE, 
						chr_l_buf, 
						NULL, 
						p_intl_envdatastruct_h);
		memset(chr_l_buf, NULL, BUFFER_LEN);
		sprintf(	chr_l_buf, 
					"The Mark Compl. Qty is : %f", 
					p_dl_deal_sstdet_struct_h_a->h_mcomplquantity);
		CO_ProcMonitor(	APL_OUT_FILE, 
						chr_l_buf, 
						NULL, 
						p_intl_envdatastruct_h);
		memset(chr_l_buf, NULL, BUFFER_LEN);
		sprintf(	chr_l_buf, 
					"The Rec. Into 000 is   : %f", 
					p_dl_deal_sstdet_struct_h_a->h_rec_int_000);
		CO_ProcMonitor(	APL_OUT_FILE, 
						chr_l_buf, 
						NULL, 
						p_intl_envdatastruct_h);
		memset(chr_l_buf, NULL, BUFFER_LEN);
		sprintf(	chr_l_buf, 
					"The Del From 000 is    : %f", 
					p_dl_deal_sstdet_struct_h_a->h_delta_000);
		CO_ProcMonitor(	APL_OUT_FILE, 
						chr_l_buf, 
						NULL, 
						p_intl_envdatastruct_h);
		memset(chr_l_buf, NULL, BUFFER_LEN);
		sprintf(	chr_l_buf, 
					"The Del From 001 is    : %f", 
					p_dl_deal_sstdet_struct_h_a->h_delta_001);
		CO_ProcMonitor(	APL_OUT_FILE, 
						chr_l_buf, 
						NULL, 
						p_intl_envdatastruct_h);
		memset(chr_l_buf, NULL, BUFFER_LEN);
		sprintf(	chr_l_buf, 
					"The Del From 003 is    : %f", 
					p_dl_deal_sstdet_struct_h_a->h_delta_002);
		CO_ProcMonitor(	APL_OUT_FILE, 
						chr_l_buf, 
						NULL, 
						p_intl_envdatastruct_h);
		memset(chr_l_buf, NULL, BUFFER_LEN);
		sprintf(	chr_l_buf, 
					"The Access Stamp is    : %s", 
					p_dl_deal_sstdet_struct_h_a->h_access_stamp);
		CO_ProcMonitor(	APL_OUT_FILE, 
						chr_l_buf, 
						NULL, 
						p_intl_envdatastruct_h);
	}

	
	

	if (!strlen(p_dl_deal_sstdet_struct_h_a->h_dl_client))
	{
		APL_DATA_MISSING("Account", APL_NULL_STRING, APL_NULL_STRING);
		int_l_error_flag = APL_FAILURE;
	} 
	if (!strlen(p_dl_deal_sstdet_struct_h_a->h_indentity_no))
	{
		APL_DATA_MISSING("RefNo", APL_NULL_STRING, APL_NULL_STRING);
		int_l_error_flag = APL_FAILURE;
	} 

	if (APL_FAILURE == int_l_error_flag) APL_GOBACK_FAIL

	

	EXEC SQL SELECT DL_DEAL.ROWID 
	INTO 	:chr_l_h_rowid:l_i_rowid
	FROM DL_DEAL
	WHERE CLIENT = :p_dl_deal_sstdet_struct_h_a->h_dl_client
	AND	IDENTIY_NO   = :p_dl_deal_sstdet_struct_h_a->h_indentity_no
	FOR UPDATE OF ACCESS_STAMP;

	IS_ANY_ORA_ERROR_AND_ZERO_RESULTSET(	ERR_DEAL_NF,
														p_dl_deal_sstdet_struct_h_a->h_dl_client,
														p_dl_deal_sstdet_struct_h_a->h_indentity_no,
														APL_NULL_STRING);

	EXEC SQL SELECT DL_DEAL.*
	INTO  :l_sys_dl_deal_struct_hn:l_sys_dl_deal_struct_id
	FROM DL_DEAL
	WHERE ROWID=:chr_l_h_rowid;

	IS_ANY_ORA_ERROR_AND_ZERO_RESULTSET( ERR_DEAL_NF,
                                          p_dl_deal_sstdet_struct_h_a->h_dl_client,
                                          p_dl_deal_sstdet_struct_h_a->h_indentity_no,
                                          APL_NULL_STRING);

	

	if (strcmp(l_sys_dl_deal_struct_hn->h_access_stamp, p_dl_deal_sstdet_struct_h_a->h_access_stamp))
	{
		CO_InsertErr(	l_debug_info_ptr,
								ERR_ACCESSSTAMP_CHGD,
								APL_NULL_STRING,
								APL_NULL_STRING,
								APL_NULL_STRING,
								__LINE__,
								__FILE__ );
		APL_GOBACK_FAIL
	}

	

	if (APL_FAILURE == CO_Chk_CntryEnabled(	"TRD_SETTLEMENT",
														"PARTIALS",
														&l_partial_ma,
														l_debug_info_ptr))
	{
		APL_GOBACK_FAIL
	}
	if (l_partial_ma)
	{
		if (!strlen(p_dl_deal_sstdet_struct_h_a->h_ispart_))
		{
			APL_DATA_MISSING("Partial Flag", APL_NULL_STRING, APL_NULL_STRING);
			int_l_error_flag = APL_FAILURE;
		}	
		if (p_dl_deal_sstdet_struct_h_a->h_ispart_[0] == 'Y')
		{
			if (p_dl_deal_sstdet_struct_h_a->h_newquantity <= 0)
			{
				APL_DATA_MISSING("New Quantity", APL_NULL_STRING, APL_NULL_STRING);
				int_l_error_flag = APL_FAILURE;
			}
			if ((p_dl_deal_sstdet_struct_h_a->h_newamount < 1) && 
				 (VAL_VP_DEAL(l_sys_dl_deal_struct_hn->h_dealcd[0])))
			{
				APL_DATA_MISSING("New Amount", APL_NULL_STRING, APL_NULL_STRING);
				int_l_error_flag = APL_FAILURE;
			}
			if (!strlen(p_dl_deal_sstdet_struct_h_a->h_newindentity_no))
			{
				APL_DATA_MISSING("New Ref.No.", APL_NULL_STRING, APL_NULL_STRING);
				int_l_error_flag = APL_FAILURE;
			}
		}
	}

	
	int_l_condexists=0;
	if (APL_FAILURE == CO_Chk_CntryEnabled(  "TRD_SETTLEMENT",
                                          "BROK_52XN02_MESSAGE",
                                          &int_l_condexists,
                                          l_debug_info_ptr))

	{
         APL_GOBACK_FAIL
	}

	if(int_l_condexists > 0 )
	{

         EXEC SQL SELECT COUNT(*) INTO :int_h_count FROM MT_MSGADDRESS A, MT_CLIENT B
         WHERE A.CLN_CODE=B.CLN_CODE
         AND B.CLN_BRK_ALL = 'B'
         AND B.STATUS = 'AA'
         AND A.MSG_IDENT_NO='35'
         AND B.CLN_CODE= :l_sys_dl_deal_struct_hn->h_domcpclt_cd;

            IS_ANY_ORA_ERROR
         if (int_h_count >0)
         {
            if(strchr(l_sys_dl_deal_struct_hn->h_msg_stat,'E')== NULL)
            {
               CO_InsertErr(   l_debug_info_ptr,
                                 ERR_EUROMSG_NOTSENT,
                                 l_sys_dl_deal_struct_hn->h_domcpclt_cd,
                                 APL_NULL_STRING,
                                 APL_NULL_STRING,
                                 __LINE__,
                                 __FILE__ );
               APL_GOBACK_FAIL
            }

		}
	}
	

	if ((!strlen(p_dl_deal_sstdet_struct_h_a->h_instrdate)) &&
		 ((!strlen(p_dl_deal_sstdet_struct_h_a->h_moneydate)) || (l_sys_dl_deal_struct_hn->h_isspotdl[0] == 'Y')))
	{
		APL_DATA_MISSING("Instr. Dt.", APL_NULL_STRING, APL_NULL_STRING);
		int_l_error_flag = APL_FAILURE;
	}
	if ((!strlen(p_dl_deal_sstdet_struct_h_a->h_moneydate)) &&
		 (VAL_VP_DEAL(l_sys_dl_deal_struct_hn->h_dealcd[0])) &&
		 (!strlen(p_dl_deal_sstdet_struct_h_a->h_instrdate) || (l_sys_dl_deal_struct_hn->h_isspotdl[0] == 'Y')))
	{
		APL_DATA_MISSING("Money Dt.", APL_NULL_STRING, APL_NULL_STRING);
		int_l_error_flag = APL_FAILURE;
	}

	

	l_iflag = 0;
	if (APL_FAILURE == CO_Chk_CntryEnabled(	"TRD_SETTLEMENT",
														"CAN_RECINT000",
														&l_iflag,
														l_debug_info_ptr ))
	{
		APL_GOBACK_FAIL
	}

	if ((!l_iflag) && (p_dl_deal_sstdet_struct_h_a->h_rec_int_000))
	{
		if (APL_FAILURE == CO_InsertErr(	l_debug_info_ptr,
														ERR_DEAL_CANT_RECINT000,
														l_sys_dl_deal_struct_hn->h_instr_code,
														APL_NULL_STRING,
														APL_NULL_STRING,
														__LINE__,
														__FILE__ ))
		{
			APL_GOBACK_FAIL
		}
		int_l_error_flag = APL_FAILURE;
	}
	
	if (APL_FAILURE == int_l_error_flag) APL_GOBACK_FAIL



	

	

	l_iflag = 0;

	if (APL_FAILURE == CO_Chk_CntryEnabled(	"TRD_MANIFOLD",
														"MANI_NOTREQD_FOR_MIN",
														&l_iflag,
														l_debug_info_ptr ))
	{
		APL_GOBACK_FAIL
	}
	
	EXEC SQL SELECT CLASSCD, INSTR_TYPE, REG_BR_IND, MIN_FMT_DL_QTY 
	INTO 	:chr_l_h_clscode:l_i_clscode,
			:chr_l_h_typeofinstr:l_i_typeofinstr,
			:chr_l_h_rgbrind:l_i_rgbrind,
			:l_h_minfmttrdquantity:l_i_minfmttrdqty
	FROM MT_INSTRUMENT
	WHERE instr_code = RTRIM(:l_sys_dl_deal_struct_hn->h_instr_code);

	IS_ANY_ORA_ERROR_AND_ZERO_RESULTSET( ERR_INSTR_NOTFND,
                                          l_sys_dl_deal_struct_hn->h_instr_code,
                                          APL_NULL_STRING,
                                          APL_NULL_STRING );

	if (l_mt_core_sys_params_struct_h.manifld_print_ind[0] == 'Y') 
	{
		if ((l_iflag) && (!strcmp(chr_l_h_clscode, "MIN")))
		{
			strcpy(chr_l_manif_flag, APL_NULL_STRING);
		}
		else if (l_mt_core_sys_params_struct_h.loc_proc_ind[0] == 'Y')
		{
			EXEC SQL SELECT MANIFLD_IND INTO :chr_l_manif_flag
			FROM MT_LOCATION
			WHERE location_cd = :l_sys_dl_deal_struct_hn->h_loccode;
	
			IS_ANY_ORA_ERROR_AND_ZERO_RESULTSET(	ERR_LOCN_NOTFND,
																l_sys_dl_deal_struct_hn->h_loccode,
																APL_NULL_STRING,
																APL_NULL_STRING);
																
			if (chr_l_manif_flag[0] == 'N')
			{
				chr_l_manif_flag[0] = ' ';
			}
			else
			{
				if (VAL_DELIVER_DEAL(l_sys_dl_deal_struct_hn->h_dealcd[0]) || l_sys_dl_deal_struct_hn->h_dealcd[0]=='5' || l_sys_dl_deal_struct_hn->h_dealcd[0]=='7')
				{
					chr_l_manif_flag[0] = 'D';
				}
				else
				{
					chr_l_manif_flag[0] = 'R';
				}
			}
		}
		else
		{
			if (VAL_DELIVER_DEAL(l_sys_dl_deal_struct_hn->h_dealcd[0]) || l_sys_dl_deal_struct_hn->h_dealcd[0]=='5' || l_sys_dl_deal_struct_hn->h_dealcd[0]=='7')
			{
				chr_l_manif_flag[0] = 'D';
			}
			else
			{
				chr_l_manif_flag[0] = 'R';
			}
		}
	}
	else
	{
		strcpy(chr_l_manif_flag, APL_NULL_STRING);
	}

   if (APL_FAILURE == DL_Chk_DLDet(  p_dl_deal_sstdet_struct_h_a->h_dl_client,
                                    p_dl_deal_sstdet_struct_h_a->h_indentity_no,
                                    'Y',		
                                    'Y',		
                                    'N',		
                                    'Y',		
                                    NULL,		
                                    NULL,
                                    NULL,
                                    chr_l_manif_flag[0],
                                    l_debug_info_ptr ))
   {
      int_l_error_flag = APL_FAILURE;
   }

	

	if ((!l_sys_dl_deal_struct_id->i_instrdate) && (strlen(p_dl_deal_sstdet_struct_h_a->h_instrdate)))
	{
		if (APL_FAILURE == CO_InsertErr(	l_debug_info_ptr,
														ERR_DEAL_INSTRSETL,
														p_dl_deal_sstdet_struct_h_a->h_dl_client,
														p_dl_deal_sstdet_struct_h_a->h_indentity_no,
														APL_NULL_STRING,
														__LINE__,
														__FILE__))
		{
			APL_GOBACK_FAIL
		}
		int_l_error_flag = APL_FAILURE;
	}

	if ((!l_sys_dl_deal_struct_id->i_moneydate) && (strlen(p_dl_deal_sstdet_struct_h_a->h_moneydate)))
	{
		if (APL_FAILURE == CO_InsertErr(	l_debug_info_ptr,
														ERR_DEAL_MONSETL,
														p_dl_deal_sstdet_struct_h_a->h_dl_client,
														p_dl_deal_sstdet_struct_h_a->h_indentity_no,
														APL_NULL_STRING,
														__LINE__,
														__FILE__))
		{
			APL_GOBACK_FAIL
		}
		int_l_error_flag = APL_FAILURE;
	}

	if (APL_FAILURE == int_l_error_flag) APL_GOBACK_FAIL

	

	if (APL_FAILURE == DL_Chk_TrCdInstr(	l_sys_dl_deal_struct_hn->h_instr_code,
													l_sys_dl_deal_struct_hn->h_dealcd[0],
													&int_l_retval,
													l_debug_info_ptr ))
	{
		APL_GOBACK_FAIL
	}

	if (int_l_retval == 'N')
	{
		if (APL_FAILURE == CO_InsertErr(	l_debug_info_ptr,
														ERR_DEAL_DEALTYP_NVALFORINSTR_A,
														l_sys_dl_deal_struct_hn->h_instr_code,
														APL_NULL_STRING,
														APL_NULL_STRING,
														__LINE__,
														__FILE__ ))
		{
			APL_GOBACK_FAIL
		}
		int_l_error_flag = APL_FAILURE;
	}

	

	if (APL_FAILURE == CO_RtvSysDtTime(chr_l_now, l_debug_info_ptr))
	{
		APL_GOBACK_FAIL
	}

	if (APL_FAILURE == CO_RtvSysDt(chr_l_date, l_debug_info_ptr))
	{
		APL_GOBACK_FAIL
	}

	l_iflag = 0;

	if (APL_FAILURE == CO_Chk_CntryEnabled(	"TRD_SETTLEMENT",
														"CSD>TODAY_OK",
														&l_iflag,
														l_debug_info_ptr ))
	{
		APL_GOBACK_FAIL
	}

	int_l_diff_dates = 0;

	printf("\n Before calling ... l_sys_dl_deal_struct_hn->h_setldt is |%s|, chr_l_now is |%s|\n",l_sys_dl_deal_struct_hn->h_setldt,chr_l_now);
	if (APL_FAILURE == CO_Pro_DateComp(	l_sys_dl_deal_struct_hn->h_setldt,
												chr_l_now,
												&int_l_diff_dates,
												l_debug_info_ptr ))
	{
		APL_GOBACK_FAIL
	}	

	if ((l_iflag == 0) && (int_l_diff_dates < 0))
	{
		if (APL_FAILURE == CO_InsertErr(	l_debug_info_ptr,
														ERR_DEAL_NO_SETL_BEFORE_CSD,
														l_sys_dl_deal_struct_hn->h_dl_client,
														l_sys_dl_deal_struct_hn->h_indentity_no,
														APL_NULL_STRING,
														__LINE__,
														__FILE__ ))
		{
			APL_GOBACK_FAIL
		}
		int_l_error_flag = APL_FAILURE;
	}

	

	 l_iflag = 0;

	if (APL_FAILURE == CO_Chk_CntryEnabled(  "TRD_SETTLEMENT",
                                          "CSD-10<TODAY",
                                          &l_iflag,
                                          l_debug_info_ptr ))
	{
      APL_GOBACK_FAIL
	}

	if ((l_iflag) && (int_l_diff_dates < -10))
	{
		if (APL_FAILURE == CO_InsertErr(	l_debug_info_ptr,
														ERR_DEAL_CSD_MINUS_10_CANT_GT_TODAY,
														l_sys_dl_deal_struct_hn->h_dl_client,	
														l_sys_dl_deal_struct_hn->h_indentity_no,
														APL_NULL_STRING,
														__LINE__,
														__FILE__ ))
		{
			APL_GOBACK_FAIL
		}
		int_l_error_flag = APL_FAILURE;
	}

	

	l_iflag = 0;
	if (APL_FAILURE == CO_Chk_CntryEnabled(	"TRD_SETTLEMENT",
														"NDS_BLK_CONF_REQD",
														&l_iflag,
														l_debug_info_ptr ))
	{
		APL_GOBACK_FAIL
	}

	if (l_iflag)
	{
		EXEC SQL SELECT NDS_BLK INTO :chr_l_h_nds
		FROM DL_LOCALREPDEALTYPE
		WHERE DEAL_CLASS = :l_sys_dl_deal_struct_hn->h_lrdltype;

		IS_ANY_ORA_ERROR_AND_ZERO_RESULTSET(	ERR_VAL_NF,
															"NDS Blk",
															APL_NULL_STRING,
															APL_NULL_STRING);

		if ((chr_l_h_nds[0] == 'T') && (l_sys_dl_deal_struct_id->i_ndsbldate == -1))
		{
			if (APL_FAILURE == CO_InsertErr(	l_debug_info_ptr,
															ERR_DEAL_NNDSBLCKCONF,
															l_sys_dl_deal_struct_hn->h_dl_client,
															l_sys_dl_deal_struct_hn->h_indentity_no,
															APL_NULL_STRING,
															__LINE__,
															__FILE__ ))
			{
				APL_GOBACK_FAIL
			}
			int_l_error_flag = APL_FAILURE;
		}
	}


	

	if (strlen(p_dl_deal_sstdet_struct_h_a->h_instrdate))
	{

		

		int_l_diff_dates = 0;

		printf("\n Before calling ... p_dl_deal_sstdet_struct_h_a->h_instrdate is |%s|, chr_l_now is |%s|\n",p_dl_deal_sstdet_struct_h_a->h_instrdate,chr_l_now);
		if (APL_FAILURE == CO_Pro_DateComp(	p_dl_deal_sstdet_struct_h_a->h_instrdate,
													chr_l_now,
													&int_l_diff_dates,
													l_debug_info_ptr ))
		{
			APL_GOBACK_FAIL
		}

		if (int_l_diff_dates < 0)
		{
			if (APL_FAILURE == CO_InsertErr(	l_debug_info_ptr,
															ERR_DEAL_INSTR_DT_CANT_FUTURE,
															l_sys_dl_deal_struct_hn->h_dl_client,
															l_sys_dl_deal_struct_hn->h_indentity_no,
															APL_NULL_STRING,
															__LINE__,
															__FILE__ ))
			{
				APL_GOBACK_FAIL
			}
			int_l_error_flag = APL_FAILURE;
		}

		

		if (int_l_diff_dates > 0)
		{
			strcpy(chr_l_hisposflg, "Y");		
		}

		

		l_iflag = 0;

		if (APL_FAILURE == CO_Chk_CntryEnabled(	"TRD_SETTLEMENT",
															"INSTR_DT<CSD",
															&l_iflag,
															l_debug_info_ptr ))
		{
			APL_GOBACK_FAIL
		}

		int_l_diff_dates = 0;

		printf("\n Before calling ... p_dl_deal_sstdet_struct_h_a->h_instrdate is |%s|, l_sys_dl_deal_struct_hn->h_setldt is |%s|\n",p_dl_deal_sstdet_struct_h_a->h_instrdate,l_sys_dl_deal_struct_hn->h_setldt);
		if (APL_FAILURE == CO_Pro_DateComp( p_dl_deal_sstdet_struct_h_a->h_instrdate,
                                       l_sys_dl_deal_struct_hn->h_setldt,
                                       &int_l_diff_dates,
                                       l_debug_info_ptr ))
		{
			APL_GOBACK_FAIL
		}

		if ((!l_iflag) && (int_l_diff_dates > 0))
		{
			if (APL_FAILURE == CO_InsertErr(	l_debug_info_ptr,
															ERR_DEAL_INSTR_DT_CANT_BEFORE_CSD,
															l_sys_dl_deal_struct_hn->h_dl_client,
                                             l_sys_dl_deal_struct_hn->h_indentity_no,
                                             APL_NULL_STRING,
                                             __LINE__,
                                             __FILE__ ))
			{
				APL_GOBACK_FAIL
			}
			int_l_error_flag = APL_FAILURE;
		}

		

		int_l_diff_dates = 0;

		printf("\n Before calling ... p_dl_deal_sstdet_struct_h_a->h_instrdate is |%s|, l_sys_dl_deal_struct_hn->h_confdate is |%s|\n",p_dl_deal_sstdet_struct_h_a->h_instrdate,l_sys_dl_deal_struct_hn->h_confdate);
		if (APL_FAILURE == CO_Pro_DateComp(	p_dl_deal_sstdet_struct_h_a->h_instrdate,
													l_sys_dl_deal_struct_hn->h_confdate,
													&int_l_diff_dates,
													l_debug_info_ptr ))
		{
			APL_GOBACK_FAIL
		}
		
		if (int_l_diff_dates > 0)
		{
			if (APL_FAILURE == CO_InsertErr(	l_debug_info_ptr,
															ERR_DEAL_INSTR_DT_CANT_BEFORE_CONFDT,
															l_sys_dl_deal_struct_hn->h_dl_client,
                                             l_sys_dl_deal_struct_hn->h_indentity_no,
                                             APL_NULL_STRING,
                                             __LINE__,
                                             __FILE__ ))
         {
            APL_GOBACK_FAIL
         }
         int_l_error_flag = APL_FAILURE;
		}
	}

	

	if (strlen(p_dl_deal_sstdet_struct_h_a->h_moneydate))
	{

		

		l_iflag = 0;

		if (APL_FAILURE == CO_Chk_CntryEnabled(  "TRD_SETTLEMENT",
                                             "MONEYDT>TODAY",
                                             &l_iflag,
                                             l_debug_info_ptr ))
		{
			APL_GOBACK_FAIL
		}

		int_l_diff_dates = 0;

		printf("\n Before calling ... p_dl_deal_sstdet_struct_h_a->h_moneydate is |%s|, chr_l_now is |%s|\n",p_dl_deal_sstdet_struct_h_a->h_moneydate,chr_l_now);
		if (APL_FAILURE == CO_Pro_DateComp(	p_dl_deal_sstdet_struct_h_a->h_moneydate,
													chr_l_now,
													&int_l_diff_dates,
													l_debug_info_ptr ))
		{
			APL_GOBACK_FAIL
		}

		if ((!l_iflag) && (int_l_diff_dates < 0))
		{
			if (APL_FAILURE == CO_InsertErr(	l_debug_info_ptr,
															ERR_DEAL_MONEYDT_CANT_FUTURE,
															l_sys_dl_deal_struct_hn->h_dl_client,
															l_sys_dl_deal_struct_hn->h_indentity_no,
															APL_NULL_STRING,
															__LINE__,
															__FILE__ ))
			{
				APL_GOBACK_FAIL
			}
			int_l_error_flag = APL_FAILURE;
		}

		

		if ((l_iflag) && (int_l_diff_dates < -9))
		{
			if (APL_FAILURE == CO_InsertErr(  l_debug_info_ptr,
                                             ERR_DEAL_MONEYDT_MINUS_9_CANT_AFTER_TODAY,
                                             l_sys_dl_deal_struct_hn->h_dl_client,
                                             l_sys_dl_deal_struct_hn->h_indentity_no,
                                             APL_NULL_STRING,
                                             __LINE__,
                                             __FILE__ ))
			{
				APL_GOBACK_FAIL
			}
         int_l_error_flag = APL_FAILURE;
		}

		

		l_iflag = 0;

		if (APL_FAILURE == CO_Chk_CntryEnabled(	"TRD_SETTLEMENT",
															"MONEYDT<CSD",
															&l_iflag,
															l_debug_info_ptr ))
		{
			APL_GOBACK_FAIL
		}

		int_l_diff_dates = 0;

		printf("\n Before calling ... p_dl_deal_sstdet_struct_h_a->h_moneydate is |%s|, l_sys_dl_deal_struct_hn->h_setldt is |%s|\n",p_dl_deal_sstdet_struct_h_a->h_moneydate,l_sys_dl_deal_struct_hn->h_setldt);
		if (APL_FAILURE == CO_Pro_DateComp( p_dl_deal_sstdet_struct_h_a->h_moneydate,
                                       l_sys_dl_deal_struct_hn->h_setldt,
                                       &int_l_diff_dates,
                                       l_debug_info_ptr ))
		{
			APL_GOBACK_FAIL
		}

		if ((!l_iflag) && (int_l_diff_dates > 0))
		{
			if (APL_FAILURE == CO_InsertErr(	l_debug_info_ptr,
															ERR_DEAL_MONEYDT_CANT_BEFORE_CSD,
															l_sys_dl_deal_struct_hn->h_dl_client,
                                             l_sys_dl_deal_struct_hn->h_indentity_no,
                                             APL_NULL_STRING,
                                             __LINE__,
                                             __FILE__ ))
			{
				APL_GOBACK_FAIL
			}
			int_l_error_flag = APL_FAILURE;
		}

		

		int_l_diff_dates = 0;

		printf("\n Before calling ... p_dl_deal_sstdet_struct_h_a->h_moneydate is |%s|, l_sys_dl_deal_struct_hn->h_confdate is |%s|\n",p_dl_deal_sstdet_struct_h_a->h_moneydate,l_sys_dl_deal_struct_hn->h_confdate);
		if (APL_FAILURE == CO_Pro_DateComp(	p_dl_deal_sstdet_struct_h_a->h_moneydate,
													l_sys_dl_deal_struct_hn->h_confdate,
													&int_l_diff_dates,
													l_debug_info_ptr ))
		{
			APL_GOBACK_FAIL
		}
		
		if (int_l_diff_dates > 0)
		{
			if (APL_FAILURE == CO_InsertErr(	l_debug_info_ptr,
															ERR_DEAL_MONEYDT_CANT_BEFORE_CONFDT,
															l_sys_dl_deal_struct_hn->h_dl_client,
                                             l_sys_dl_deal_struct_hn->h_indentity_no,
                                             APL_NULL_STRING,
                                             __LINE__,
                                             __FILE__ ))
			{
				APL_GOBACK_FAIL
			}
			int_l_error_flag = APL_FAILURE;
		}
	}
	
	

	if (l_sys_dl_deal_struct_id->i_instrdate == -1) 
	{
		strcpy(chr_l_instr_dt, p_dl_deal_sstdet_struct_h_a->h_instrdate);
	}
	else
	{
		strcpy(chr_l_instr_dt, l_sys_dl_deal_struct_hn->h_instrdate);
	}
	if (l_sys_dl_deal_struct_id->i_moneydate == -1) 
	{
		strcpy(chr_l_moneydt, p_dl_deal_sstdet_struct_h_a->h_moneydate);
	}
	else
	{
		strcpy(chr_l_moneydt, l_sys_dl_deal_struct_hn->h_moneydate);
	}

	if ((l_sys_dl_deal_struct_hn->h_isspotdl[0] == 'Y') &&
		 (strcmp(p_dl_deal_sstdet_struct_h_a->h_instrdate, p_dl_deal_sstdet_struct_h_a->h_moneydate)))
	{
		if (APL_FAILURE == CO_InsertErr(	l_debug_info_ptr,
														ERR_DEAL_INSTR_DT_NOTEQUAL_MONEYDT,
														p_dl_deal_sstdet_struct_h_a->h_dl_client,
														p_dl_deal_sstdet_struct_h_a->h_indentity_no,
														APL_NULL_STRING,
														__LINE__,
														__FILE__ ))
		{
			APL_GOBACK_FAIL
		}
		int_l_error_flag = APL_FAILURE;
	}
	else if ((strlen(chr_l_instr_dt)) && 
				(strlen(chr_l_moneydt)))
	{
		printf("\n Before calling ... chr_l_instr_dt is |%s|, chr_l_moneydt is |%s|\n",chr_l_instr_dt,chr_l_moneydt);
		if (APL_FAILURE == CO_Pro_DateComp(	chr_l_instr_dt,
													chr_l_moneydt,
													&int_l_diff_dates,
													l_debug_info_ptr ))
		{
			APL_GOBACK_FAIL
		}
	}
	else
	{
		int_l_diff_dates = 0;
	}

	if (!strcmp(l_sys_dl_deal_struct_hn->h_ex_arena, "1"))
	{
		strcpy(chr_l_settl_err_cond, l_mt_core_sys_params_struct_h.op_oth_stx_error);
	}
	else
	{
		strcpy(chr_l_settl_err_cond, l_mt_core_sys_params_struct_h.op_oth_trd_error);
	}

	if ( (!strcmp(chr_l_settl_err_cond, "<") ) &&
      ( (int_l_diff_dates > 0) ||
        ( strlen(chr_l_instr_dt) &&
        ( !strlen(chr_l_moneydt) &&
        ( VAL_VP_DEAL( l_sys_dl_deal_struct_hn->h_dealcd[0]) ) ) ) ) )
	{
		if (APL_FAILURE == CO_InsertErr(	l_debug_info_ptr,
														ERR_DEAL_MONEYDT_CANT_AFTER_INSTR_DT,
														p_dl_deal_sstdet_struct_h_a->h_dl_client,
														p_dl_deal_sstdet_struct_h_a->h_indentity_no,
														APL_NULL_STRING,
														__LINE__,
														__FILE__ ))
		{
			APL_GOBACK_FAIL
		}
		int_l_error_flag = APL_FAILURE;
	}

	if ( (!strcmp(chr_l_settl_err_cond, ">") ) &&
      ( (int_l_diff_dates < 0) ||
        ( !strlen(chr_l_instr_dt) &&
           strlen(chr_l_moneydt) ) ) )
	{
		if (APL_FAILURE == CO_InsertErr(	l_debug_info_ptr,
														ERR_DEAL_MONEYDT_CANT_BEFORE_INSTR_DT,
														p_dl_deal_sstdet_struct_h_a->h_dl_client,
														p_dl_deal_sstdet_struct_h_a->h_indentity_no,
														APL_NULL_STRING,
														__LINE__,
														__FILE__ ))
		{
			APL_GOBACK_FAIL
		}
		int_l_error_flag = APL_FAILURE;
	}

	if ( (!strcmp(chr_l_settl_err_cond, "<>") ) &&
      ( (int_l_diff_dates) ||
        ( !strlen(chr_l_instr_dt) && 
			  strlen(chr_l_moneydt) ) ||
        ( strlen(chr_l_instr_dt) && 
			 !strlen(chr_l_moneydt) && 
			 ( VAL_VP_DEAL(l_sys_dl_deal_struct_hn->h_dealcd[0]) ) ) ) )
	{
		if (APL_FAILURE == CO_InsertErr(	l_debug_info_ptr,
														ERR_DEAL_INSTR_DT_NOTEQUAL_MONEYDT,
														p_dl_deal_sstdet_struct_h_a->h_dl_client,
														p_dl_deal_sstdet_struct_h_a->h_indentity_no,
														APL_NULL_STRING,
														__LINE__,
														__FILE__ ))
		{
			APL_GOBACK_FAIL
		}
		int_l_error_flag = APL_FAILURE;
	}

	/*	Addition Exchange Code for Holiday Check	UAT	*/	
	printf("Deal Exchange Code for Holiday, |%s|",l_sys_dl_deal_struct_hn->h_exch_code);	

	if (strlen(p_dl_deal_sstdet_struct_h_a->h_instrdate))
	{
		int_l_chkflg = 0;
		if (APL_FAILURE == CO_Chk_Holiday(	p_dl_deal_sstdet_struct_h_a->h_instrdate,
															&int_l_chkflg,
															l_debug_info_ptr,l_sys_dl_deal_struct_hn->h_exch_code ))
		{
			APL_GOBACK_FAIL;
		}
	
		if (int_l_chkflg)
		{
			if (APL_FAILURE == CO_InsertErr(	l_debug_info_ptr,
															ERR_DATE_IS_HOLIDAY,
															"InstrDt",
															p_dl_deal_sstdet_struct_h_a->h_dl_client,
															p_dl_deal_sstdet_struct_h_a->h_indentity_no,
															__LINE__,
															__FILE__ ))
			{
				APL_GOBACK_FAIL
			}
			int_l_error_flag = APL_FAILURE;
		} 
	}				

	if (strlen(p_dl_deal_sstdet_struct_h_a->h_moneydate))
	{
		int_l_chkflg = 0;
		if (APL_FAILURE == CO_Chk_Holiday(	p_dl_deal_sstdet_struct_h_a->h_moneydate,
															&int_l_chkflg,
															l_debug_info_ptr,l_sys_dl_deal_struct_hn->h_exch_code ))
		{
			APL_GOBACK_FAIL;
		}
	
		if (int_l_chkflg)
		{
			if (APL_FAILURE == CO_InsertErr(	l_debug_info_ptr,
															ERR_DATE_IS_HOLIDAY,
															"MoneyDt",
															p_dl_deal_sstdet_struct_h_a->h_dl_client,
															p_dl_deal_sstdet_struct_h_a->h_indentity_no,
															__LINE__,
															__FILE__ ))
			{
				APL_GOBACK_FAIL
			}
			int_l_error_flag = APL_FAILURE;
		} 
	}

	

	if (((!l_sys_dl_deal_struct_id->i_instrdate) || (!l_sys_dl_deal_struct_id->i_moneydate)) &&
		 (p_dl_deal_sstdet_struct_h_a->h_ispart_[0] == 'Y'))
	{
		if (APL_FAILURE == CO_InsertErr(	l_debug_info_ptr,
														ERR_DEAL_CANT_PARSETL,
														p_dl_deal_sstdet_struct_h_a->h_dl_client,
														p_dl_deal_sstdet_struct_h_a->h_indentity_no,
														APL_NULL_STRING,
														__LINE__,
														__FILE__))
		{
			APL_GOBACK_FAIL
		}
		int_l_error_flag = APL_FAILURE;
	}

	

	if (p_dl_deal_sstdet_struct_h_a->h_ispart_[0] == 'Y')
	{
		l_new_quantity = p_dl_deal_sstdet_struct_h_a->h_newquantity;
	}
	else
	{
		l_new_quantity = l_sys_dl_deal_struct_hn->h_qty;
	}

	if (p_dl_deal_sstdet_struct_h_a->h_marktrfquantity)
	{
		strcpy(chr_l_new_status, "002");
	}
	else if (p_dl_deal_sstdet_struct_h_a->h_rec_int_000 == l_new_quantity)
	{
		strcpy(chr_l_new_status, "000");
	}
	else
	{
		strcpy(chr_l_new_status, l_sys_dl_deal_struct_hn->h_pos_stat);
	}

	

	if (p_dl_deal_sstdet_struct_h_a->h_pr < 0)
	{
		if (APL_FAILURE == CO_InsertErr(	l_debug_info_ptr,
														ERR_VALUE_CANT_NEGATIVE,
														"Instrurity Price",
														APL_NULL_STRING,
														APL_NULL_STRING,
														__LINE__,
														__FILE__ ))
		{
			APL_GOBACK_FAIL
		}
		int_l_error_flag = APL_FAILURE;
	}

	if (p_dl_deal_sstdet_struct_h_a->h_brokercomm < 0)
	{
		if (APL_FAILURE == CO_InsertErr(	l_debug_info_ptr,
														ERR_VALUE_CANT_NEGATIVE,
														"Brok. Comm.",
														APL_NULL_STRING,
														APL_NULL_STRING,
														__LINE__,
														__FILE__ ))
		{
			APL_GOBACK_FAIL
		}
		int_l_error_flag = APL_FAILURE;
	}

	

	

	if ((l_mt_core_sys_params_struct_h.proc_reg_ind[0] == 'N') &&
		 ((p_dl_deal_sstdet_struct_h_a->h_pendregquantity) ||
		  (p_dl_deal_sstdet_struct_h_a->h_marktrfquantity) ||
		  (p_dl_deal_sstdet_struct_h_a->h_mcomplquantity) ||
		  (p_dl_deal_sstdet_struct_h_a->h_rec_int_000) ||
		  (p_dl_deal_sstdet_struct_h_a->h_delta_000) ||
		  (p_dl_deal_sstdet_struct_h_a->h_delta_001) ||
		  (p_dl_deal_sstdet_struct_h_a->h_delta_002)))
	{
		CO_InsertErr(	l_debug_info_ptr,
								ERR_DATA_INTEGRITY,
								"Partial.Reg.Qtys",
								p_dl_deal_sstdet_struct_h_a->h_dl_client,
								p_dl_deal_sstdet_struct_h_a->h_indentity_no,
								__LINE__,
								__FILE__ );
		APL_GOBACK_FAIL
	}		  

	

	if ((VAL_RECDEAL(l_sys_dl_deal_struct_hn->h_dealcd[0]) || l_sys_dl_deal_struct_hn->h_dealcd[0]=='6' || l_sys_dl_deal_struct_hn->h_dealcd[0]=='8') &&
		 ((!strcmp(l_sys_dl_deal_struct_hn->h_pos_stat, STATUS_POS_000)) ||
		  (!strcmp(l_sys_dl_deal_struct_hn->h_pos_stat, STATUS_POS_003))) &&
		 ((p_dl_deal_sstdet_struct_h_a->h_pendregquantity > 0) ||
		  (p_dl_deal_sstdet_struct_h_a->h_marktrfquantity > 0) ||
		  (p_dl_deal_sstdet_struct_h_a->h_mcomplquantity  > 0)))
	{
		CO_InsertErr(	l_debug_info_ptr,
								ERR_DATA_INTEGRITY,
								"Partial.Reg.Qtys",
								p_dl_deal_sstdet_struct_h_a->h_dl_client,
								p_dl_deal_sstdet_struct_h_a->h_indentity_no,
								__LINE__,
								__FILE__ );
		APL_GOBACK_FAIL
	}

	

	EXEC SQL SELECT CLN_ALLOW_REGIND 
	INTO :chr_l_h_canreg:l_i_canreg
	FROM MT_CLIENT
	WHERE CLN_CODE = :p_dl_deal_sstdet_struct_h_a->h_dl_client;

	IS_ANY_ORA_ERROR_AND_ZERO_RESULTSET(	ERR_ACCNOT_FND,
														p_dl_deal_sstdet_struct_h_a->h_dl_client,
														APL_NULL_STRING,
														APL_NULL_STRING);

	if ((chr_l_h_canreg[0] == 'N') && (p_dl_deal_sstdet_struct_h_a->h_marktrfquantity))
	{
		if (APL_FAILURE == CO_InsertErr(	l_debug_info_ptr,
														ERR_ACCOUNT_CANT_REGSTR,
														p_dl_deal_sstdet_struct_h_a->h_dl_client,
														APL_NULL_STRING,
														APL_NULL_STRING,
														__LINE__,
														__FILE__ ))
		{
			APL_GOBACK_FAIL
		}
		int_l_error_flag = APL_FAILURE;
	}

	

	if ((p_dl_deal_sstdet_struct_h_a->h_newquantity > 0) &&
		 (p_dl_deal_sstdet_struct_h_a->h_newquantity > l_sys_dl_deal_struct_hn->h_qty))
	{
		if (APL_FAILURE == CO_InsertErr(	l_debug_info_ptr,
														ERR_DEAL_QTY_CANT_MORE_TRDQTY,
														l_sys_dl_deal_struct_hn->h_dl_client,
														l_sys_dl_deal_struct_hn->h_indentity_no,
														APL_NULL_STRING,
														__LINE__,
														__FILE__ ))
		{
			APL_GOBACK_FAIL
		}
		int_l_error_flag = APL_FAILURE;
	}

	

	if ((!strcmp(chr_l_h_typeofinstr, "FMT")) &&
		 ((p_dl_deal_sstdet_struct_h_a->h_ispart_[0] == 'Y') &&
		  (p_dl_deal_sstdet_struct_h_a->h_newquantity < l_h_minfmttrdquantity)) ||
		 ((p_dl_deal_sstdet_struct_h_a->h_ispart_[0] != 'Y') &&
		  (l_sys_dl_deal_struct_hn->h_qty < l_h_minfmttrdquantity)))
	{
		if (APL_FAILURE == CO_InsertErr(	l_debug_info_ptr,
														ERR_QTY_CANT_LESS_MINFINQTY,
														l_sys_dl_deal_struct_hn->h_dl_client,
														l_sys_dl_deal_struct_hn->h_indentity_no,
														l_sys_dl_deal_struct_hn->h_instr_code,
														__LINE__,
														__FILE__ ))
		{
			APL_GOBACK_FAIL
		}
		int_l_error_flag = APL_FAILURE;
	}

	

	if ((!strcmp(chr_l_h_typeofinstr, "FMT")) &&
		 (p_dl_deal_sstdet_struct_h_a->h_ispart_[0] == 'Y') &&
		 ((l_sys_dl_deal_struct_hn->h_qty - p_dl_deal_sstdet_struct_h_a->h_newquantity) < l_h_minfmttrdquantity))
	{
		if (APL_FAILURE == CO_InsertWarning(	l_debug_info_ptr,
															W_REM_QTY_LESS_MINFMTQTY,
															l_sys_dl_deal_struct_hn->h_dl_client,
															l_sys_dl_deal_struct_hn->h_indentity_no,
															APL_NULL_STRING,
															__LINE__,
															__FILE__ ))
		{
			APL_GOBACK_FAIL
		}
	}

	

	if (VAL_RECDEAL(l_sys_dl_deal_struct_hn->h_dealcd[0]) || l_sys_dl_deal_struct_hn->h_dealcd[0]=='6' || l_sys_dl_deal_struct_hn->h_dealcd[0]=='8')
	{
		p_dl_deal_sstdet_struct_h_a->h_delta_000 = 0.0;
		p_dl_deal_sstdet_struct_h_a->h_delta_001 = 0.0;
		p_dl_deal_sstdet_struct_h_a->h_delta_002 = 0.0;
	}
	else
	{
		p_dl_deal_sstdet_struct_h_a->h_pendregquantity = 0.0;
		p_dl_deal_sstdet_struct_h_a->h_marktrfquantity = 0.0;
		p_dl_deal_sstdet_struct_h_a->h_mcomplquantity  = 0.0;
		p_dl_deal_sstdet_struct_h_a->h_rec_int_000  = 0.0;
	}

	

	if (l_mt_core_sys_params_struct_h.proc_reg_ind[0] == 'Y')
	{	
		if (!strcmp(chr_l_h_rgbrind, BEARER_IND))
		{
			p_dl_deal_sstdet_struct_h_a->h_pendregquantity = 0;
			p_dl_deal_sstdet_struct_h_a->h_marktrfquantity = 0;
			p_dl_deal_sstdet_struct_h_a->h_mcomplquantity  = 0;
			p_dl_deal_sstdet_struct_h_a->h_rec_int_000  = 0;

			

			p_dl_deal_sstdet_struct_h_a->h_delta_000  = l_sys_dl_deal_struct_hn->h_qty;
			p_dl_deal_sstdet_struct_h_a->h_delta_001  = 0;
			p_dl_deal_sstdet_struct_h_a->h_delta_002  = 0;
			strcpy(chr_l_new_status, "000");
		}

		

		

		else if (VAL_RECDEAL(l_sys_dl_deal_struct_hn->h_dealcd[0]) || l_sys_dl_deal_struct_hn->h_dealcd[0]=='6' || l_sys_dl_deal_struct_hn->h_dealcd[0]=='8')
		{
			if (l_new_quantity != (	p_dl_deal_sstdet_struct_h_a->h_pendregquantity +
										p_dl_deal_sstdet_struct_h_a->h_marktrfquantity +
										p_dl_deal_sstdet_struct_h_a->h_mcomplquantity +
										p_dl_deal_sstdet_struct_h_a->h_rec_int_000 ))
			{
				if (APL_FAILURE == CO_InsertErr(	l_debug_info_ptr,
																ERR_DEAL_TOTQTY_CANT_MORE_DEALQTY,
																l_sys_dl_deal_struct_hn->h_dl_client,
																l_sys_dl_deal_struct_hn->h_indentity_no,
																APL_NULL_STRING,
																__LINE__,
																__FILE__ ))
				{
					APL_GOBACK_FAIL
				}
				int_l_error_flag = APL_FAILURE;
			}
		}
		else  
		{
			if (((!strcmp(l_sys_dl_deal_struct_hn->h_pos_stat, "003")) && 
				 (l_new_quantity != p_dl_deal_sstdet_struct_h_a->h_delta_002)) ||
			 	 (l_new_quantity != (	p_dl_deal_sstdet_struct_h_a->h_delta_000 +
										p_dl_deal_sstdet_struct_h_a->h_delta_001 +
										p_dl_deal_sstdet_struct_h_a->h_delta_002 )))
			{
				if (APL_FAILURE == CO_InsertErr(	l_debug_info_ptr,
																ERR_DEAL_TOTQTY_CANT_MORE_DEALQTY,
																l_sys_dl_deal_struct_hn->h_dl_client,
																l_sys_dl_deal_struct_hn->h_indentity_no,
																APL_NULL_STRING,
																__LINE__,
																__FILE__ ))
				{
					APL_GOBACK_FAIL
				}
				int_l_error_flag = APL_FAILURE;
			}
		}
	}

	

	if ((l_mt_core_sys_params_struct_h.proc_reg_ind[0] == 'Y') && 
		 (l_mt_core_sys_params_struct_h.part_reg_ind[0] == 'N'))
	{
		if (p_dl_deal_sstdet_struct_h_a->h_sel_forreg[0] == 'Y')
		{
			if (p_dl_deal_sstdet_struct_h_a->h_marktrfquantity != l_new_quantity)
			{
				if (APL_FAILURE == CO_InsertErr(	l_debug_info_ptr,
																ERR_DEAL_QTYREG_NEQUAL_TOTQTY,
																l_sys_dl_deal_struct_hn->h_dl_client,	
																l_sys_dl_deal_struct_hn->h_indentity_no,
																APL_NULL_STRING,
																__LINE__,	
																__FILE__ ))
				{
					APL_GOBACK_FAIL
				}
				int_l_error_flag = APL_FAILURE;
			}	
		}
		else if (p_dl_deal_sstdet_struct_h_a->h_sel_forreg[0] == 'N')
		{
			if (p_dl_deal_sstdet_struct_h_a->h_mcomplquantity != l_new_quantity)
			{
				if (APL_FAILURE == CO_InsertErr(	l_debug_info_ptr,
																ERR_DEAL_QTYMCL_NEQUAL_TOTQTY,
																l_sys_dl_deal_struct_hn->h_dl_client,	
																l_sys_dl_deal_struct_hn->h_indentity_no,
																APL_NULL_STRING,
																__LINE__,	
																__FILE__ ))
				{
					APL_GOBACK_FAIL
				}
				int_l_error_flag = APL_FAILURE;
			}	
		}
		else if (!strlen(p_dl_deal_sstdet_struct_h_a->h_sel_forreg))
		{
			if ((p_dl_deal_sstdet_struct_h_a->h_pendregquantity) &&
			    (p_dl_deal_sstdet_struct_h_a->h_pendregquantity != l_new_quantity))
			{
				if (APL_FAILURE == CO_InsertErr(	l_debug_info_ptr,
																ERR_DEAL_QTYPND_NEQUAL_TOTQTY,
																l_sys_dl_deal_struct_hn->h_dl_client,	
																l_sys_dl_deal_struct_hn->h_indentity_no,
																APL_NULL_STRING,
																__LINE__,	
																__FILE__ ))
				{
					APL_GOBACK_FAIL
				}
				int_l_error_flag = APL_FAILURE;
			}	
		}
	}	

	

	if (APL_FAILURE == int_l_error_flag) APL_GOBACK_FAIL


	
		if(CA_Rtv_Block_Type(  l_sys_dl_deal_struct_hn->h_indentity_no,
					l_sys_dl_deal_struct_hn->h_classofdl,
					l_sys_dl_deal_struct_hn->h_dealcd,
					l_block_type,
					l_debug_info_ptr) == APL_FAILURE)
		{
				APL_GOBACK_FAIL
		}
	if (APL_FAILURE == DL_Proc_PosLock(	l_sys_dl_deal_struct_hn->h_dl_client,
													l_sys_dl_deal_struct_hn->h_instr_code,
													l_sys_dl_deal_struct_hn->h_loccode,
													APL_NULL_STRING,l_block_type,
													l_debug_info_ptr ))
	{
		APL_GOBACK_FAIL
	}

	

	if ((strlen(p_dl_deal_sstdet_struct_h_a->h_instrdate)) ||
		 ((!l_sys_dl_deal_struct_id->i_instrdate) &&
		  (l_mt_core_sys_params_struct_h.proc_reg_ind[0] == 'Y')))
	{
		if (APL_FAILURE == DL_Proc_PosChkMod(	p_dl_deal_sstdet_struct_h_a,
														l_sys_dl_deal_struct_hn->h_instr_code,
														l_sys_dl_deal_struct_hn->h_loccode,
														chr_l_new_status,
														l_sys_dl_deal_struct_hn->h_dealcd,
														l_sys_dl_deal_struct_id->i_instrdate,
														l_sys_dl_deal_struct_hn->h_pos_stat,
														l_new_quantity,
														'C',
														l_block_type,
														&int_l_chkflg,
														l_debug_info_ptr ))
		{
			APL_GOBACK_FAIL
		}

		if (int_l_chkflg == APL_FAILURE)
		{
			if (APL_FAILURE == CO_InsertErr(	l_debug_info_ptr,
															ERR_DEAL_NENUFPOSN,
															l_sys_dl_deal_struct_hn->h_dl_client,
															l_sys_dl_deal_struct_hn->h_indentity_no,
															APL_NULL_STRING,
															__LINE__,
															__FILE__ ))
			{
				APL_GOBACK_FAIL
			}
			int_l_error_flag = APL_FAILURE;
		}
	}
	

	

	

	if ( l_sys_dl_deal_struct_hn->h_dlfromord[0] == 'Y' )
	{
			if ( APL_FAILURE == CO_Chk_AccValid(	p_dl_deal_sstdet_struct_h_a->h_dl_client, 
														'Y', 
														'C', 
														'B', 
														NULL, 
														'Y', 
														'N', 
														'N', 
														'N', 
														l_debug_info_ptr ) )
  		 {
     		 int_l_error_flag = APL_FAILURE;
		}
	}
	else
	{
			if ( APL_FAILURE == CO_Chk_AccValid(	p_dl_deal_sstdet_struct_h_a->h_dl_client, 
														'Y',
														'C',
														NULL,
														NULL,
														'Y',
														'N',
														'N',
														'N',
														l_debug_info_ptr))
			{
				int_l_error_flag = APL_FAILURE;
			}
	}

	IF_COND_EXISTS("DL_DEAL","DOMCPAC")	
	{
		if ( APL_FAILURE == CO_Chk_AccValid(	l_sys_dl_deal_struct_hn->h_domcpclt_cd, 
													'Y', 
													'B', 
													NULL, 
													NULL, 
													'Y', 
													'N', 
													'N', 
													'N', 
													l_debug_info_ptr ) )
		{
      	int_l_error_flag = APL_FAILURE;
		}
	
	
		strcpy(chr_mainfuncarea, "TRD_MAINT");
		strcpy(chr_l_condid, "EXT_TRD_CNTAC_ALWD");
		l_ext_trd_check =0;

		if (APL_FAILURE == CO_Chk_CntryEnabled(chr_mainfuncarea,
													chr_l_condid,
													&l_ext_trd_check,
													l_debug_info_ptr))
		{
			APL_GOBACK_FAIL;
		}
		if (l_ext_trd_check > 0)
		{	
	
			if((strcmp(l_mt_core_sys_params_struct_h.custody_clt_cd,int_l_domcpac)==0) ||(l_ext_trd_check==0))
			{
				if (!l_sys_dl_deal_struct_id->i_countclt)
				{
				if ( APL_FAILURE == CO_Chk_AccValid(	l_sys_dl_deal_struct_hn->h_countclt, 
																'Y', 
																'C', 
																'C', 
																NULL, 
																'Y', 
																'N', 
																'N', 
																'N', 
																l_debug_info_ptr ) )
					  {
						  int_l_error_flag = APL_FAILURE;
					  }
				}
			}
		}   
	}	

	if ( APL_FAILURE == CO_Chk_InstrValid(	l_sys_dl_deal_struct_hn->h_instr_code, 
												'Y', 
												'Y', 
												'N', 
												'N', 
												NULL, 
												'N', 
												l_debug_info_ptr ) )
	{
      int_l_error_flag = APL_FAILURE;
	}
	
	

	if (l_mt_core_sys_params_struct_h.loc_proc_ind[0] == 'Y')
	{
		if (APL_FAILURE == MT_Chk_Loc(	l_sys_dl_deal_struct_hn->h_loccode,
													'Y',
													'Y',
													NULL,
													l_debug_info_ptr ))
		{
			int_l_error_flag = APL_FAILURE;
		}
	}

	

	if ( APL_FAILURE == CO_Chk_CcyValid(	l_sys_dl_deal_struct_hn->h_currencycode, 
												'M', 
												'Y', 
												l_debug_info_ptr ) )
	{
      int_l_error_flag = APL_FAILURE;
	}
	

	

	if (APL_FAILURE == int_l_error_flag) APL_GOBACK_FAIL

	/*if (APL_SUCCESS == CO_ChkErr(*l_debug_info_ptr)) APL_GOBACK_FAIL*/
	
	

	

	EXEC SQL SELECT DEC_LEN
	INTO :int_l_h_amt_declen:l_i_amt_declen
	FROM DL_CURRENCY
	WHERE CURRENCY_CD = :l_sys_dl_deal_struct_hn->h_currencycode;

	IS_ANY_ORA_ERROR_AND_ZERO_RESULTSET(	ERR_CCY_NOTFND,
														l_sys_dl_deal_struct_hn->h_currencycode,
														APL_NULL_STRING,
														APL_NULL_STRING);

	

   if (!strcmp(chr_l_h_typeofinstr, "FMT"))
      p_dl_deal_sstdet_struct_h_a->h_pr/=100;

	
	
	if ((strlen(p_dl_deal_sstdet_struct_h_a->h_instrdate)) ||
		 ((!l_sys_dl_deal_struct_id->i_instrdate) &&
		  (l_mt_core_sys_params_struct_h.proc_reg_ind[0] == 'Y')))
	{
		if (APL_FAILURE == DL_Proc_PosChkMod(	p_dl_deal_sstdet_struct_h_a,
														l_sys_dl_deal_struct_hn->h_instr_code,
														l_sys_dl_deal_struct_hn->h_loccode,
														chr_l_new_status,
														l_sys_dl_deal_struct_hn->h_dealcd,
														l_sys_dl_deal_struct_id->i_instrdate,
														l_sys_dl_deal_struct_hn->h_pos_stat,
														l_new_quantity,
														'U',
														l_block_type,
														&int_l_chkflg,
														l_debug_info_ptr ))
		{
			APL_GOBACK_FAIL
		}
	}


	     
   
	strcpy(chr_mainfuncarea, "TRD_SST_CHK");
	strcpy(chr_l_condid, "RU_REG_CHK");
   int_l_condexists =0;

	if (APL_SUCCESS == CO_Chk_CntryEnabled(chr_mainfuncarea,
													chr_l_condid,
													&int_l_condexists,
													l_debug_info_ptr))
	{
		if (int_l_condexists > 0)
		{
			EXEC SQL SELECT CLN_CLAS 
			INTO :chr_l_h_acc_class:l_i_acc_class
			FROM MT_CLIENT 
			WHERE CLN_CODE = :p_dl_deal_sstdet_struct_h_a->h_dl_client ;
			
			IS_ANY_ORA_ERROR

			memset(chr_mainfuncarea, APL_NULL_CHAR, APL_MAINFUNCAREA_LEN);
		  memset(chr_l_condid, APL_NULL_CHAR, APL_CONDID_LEN);

			strcpy(chr_mainfuncarea, "TRADE_RRMM");
			strcpy(chr_l_condid, "CLT_CLAS");
			int_l_condexists = 0;
			
			if (APL_SUCCESS == CO_Chk_SplVal(	chr_mainfuncarea,
														chr_l_condid,
														chr_l_h_acc_class,
														&int_l_condexists,
														l_debug_info_ptr))

			if ((int_l_condexists > 0) && strlen(p_dl_deal_sstdet_struct_h_a->h_instrdate) != 0)

			{
				if (strlen(srn_params_str)!=0)
				{
					
					
					CO_SplitStr(srn_params_str,';',&int_noelem,&chr_l_param);
					
					i = 0;
					
					while(i < int_noelem)
					{
					   memset(chr_h_srnregno, APL_NULL_CHAR, APL_SRN_LEN);
						if (strstr(chr_l_param[i],":") == NULL)
						{
							int_nlen = strlen(chr_l_param[i]);
							h_srn_quantity = 0;
						}
						else
						{
							chr_posofspace_A = strstr(chr_l_param[i],":");
							int_nlen =(chr_posofspace_A - chr_l_param[i]);
							h_srn_quantity = atof(chr_posofspace_A+1);
						}
						strncpy(chr_h_srnregno,chr_l_param[i],int_nlen);
						chr_h_srnregno[int_nlen] = '\0' ;

					

							

								if (APL_FAILURE == CRUDBSafekLockFn(l_sys_dl_deal_struct_hn->h_dl_client,
																				l_sys_dl_deal_struct_hn->h_instr_code,
																				l_sys_dl_deal_struct_hn->h_loccode,
																				APL_NULL_STRING,
																				chr_h_srnregno,
																			   l_debug_info_ptr))
														{
																APL_GOBACK_FAIL
														}
				
									
							 if (VAL_DELIVER_DEAL(l_sys_dl_deal_struct_hn->h_dealcd[0]) || l_sys_dl_deal_struct_hn->h_dealcd[0]=='5' || l_sys_dl_deal_struct_hn->h_dealcd[0]=='7')
								{
									

									if (APL_FAILURE == CRUDBUpdtPosnFn(l_sys_dl_deal_struct_hn->h_dl_client,
																				  l_sys_dl_deal_struct_hn->h_instr_code,
																				  l_sys_dl_deal_struct_hn->h_loccode,
																				  l_sys_dl_deal_struct_hn->h_pos_stat,
																				  'S',
																				  l_sys_dl_deal_struct_hn->h_dealcd[0],
																				  &h_srn_quantity, 
																				  'D',
																				  chr_h_srnregno,
																				  l_debug_info_ptr) )
																{
																		APL_GOBACK_FAIL
																}
								}

								else
								{
									if (APL_FAILURE == CRUDBUpdtPosnFn(l_sys_dl_deal_struct_hn->h_dl_client,
																				l_sys_dl_deal_struct_hn->h_instr_code,
																				l_sys_dl_deal_struct_hn->h_loccode,
																				l_sys_dl_deal_struct_hn->h_pos_stat,
																				'S',
																				l_sys_dl_deal_struct_hn->h_dealcd[0],
																				&h_srn_quantity,
																				'I',
																				chr_h_srnregno,
																				l_debug_info_ptr))
																{
																		APL_GOBACK_FAIL
																}
								}

																										 
				  EXEC SQL SELECT DL_RUDEAL.ROWID INTO chr_l_h_ru_rowid:l_i_ru_rowid
					FROM DL_RUDEAL
					WHERE CLIENT = :p_dl_deal_sstdet_struct_h_a->h_dl_client
					AND IDENTIY_NO     = :p_dl_deal_sstdet_struct_h_a->h_indentity_no
					AND INSTR_CODE    = :l_sys_dl_deal_struct_hn->h_instr_code
					AND LOCATION_CD  = :l_sys_dl_deal_struct_hn->h_loccode
					AND ST_REG_NO   = :chr_h_srnregno;

					IS_ANY_ORA_ERROR
	  
				if (APL_ZERO_RESULT_SET)
					{
						strcpy(l_deal_ru_struct_h->h_dl_client,p_dl_deal_sstdet_struct_h_a->h_dl_client);
						strcpy(l_deal_ru_struct_h->h_indentity_no,p_dl_deal_sstdet_struct_h_a->h_indentity_no);
						strcpy(l_deal_ru_struct_h->h_instr_code,l_sys_dl_deal_struct_hn->h_instr_code);
					   strcpy(l_deal_ru_struct_h->h_loccode,l_sys_dl_deal_struct_hn->h_loccode);
						strcpy(l_deal_ru_struct_h->h_st_reg_no,chr_h_srnregno);
					   l_deal_ru_struct_h->h_qty = h_srn_quantity;

						if (APL_SUCCESS != DL_Proc_TrdAmtCalc(l_sys_dl_deal_struct_hn->h_amt,
																		l_sys_dl_deal_struct_hn->h_qty,
																		h_srn_quantity,	
																		&p_new_amount,
																		l_debug_info_ptr))
						{
							APL_GOBACK_FAIL
						}
							
					   l_deal_ru_struct_h->h_amt = p_new_amount;	
						strcpy(l_deal_ru_struct_h->h_dealcd,l_sys_dl_deal_struct_hn->h_dealcd);
						strcpy(l_deal_ru_struct_h->h_deal_dt,l_sys_dl_deal_struct_hn->h_dlt);

						if (APL_FAILURE == CO_RtvSysDt(chr_l_now,l_debug_info_ptr))
												{
													APL_GOBACK_FAIL
												}
												
						strcpy(l_deal_ru_struct_h->h_instrdate,chr_l_now);	
						EXEC SQL INSERT INTO DL_RUDEAL VALUES (:l_deal_ru_struct_h);
						IS_ANY_ORA_ERROR
					}
					else
					{
						if (APL_FAILURE == CRUDBUpdtPosnFn( l_sys_dl_deal_struct_hn->h_dl_client,
																		l_sys_dl_deal_struct_hn->h_instr_code,
																		l_sys_dl_deal_struct_hn->h_loccode,
																		l_sys_dl_deal_struct_hn->h_pos_stat,
																		'C',
																		l_sys_dl_deal_struct_hn->h_dealcd[0],
																		&h_srn_quantity,
																		'D',
																		chr_h_srnregno,
																		l_debug_info_ptr))
												{
													APL_GOBACK_FAIL
												}

						EXEC SQL UPDATE DL_RUDEAL SET INSTRUMENT_DT =:chr_l_now
						WHERE DL_RUDEAL.ROWID =:chr_l_h_ru_rowid; 
						IS_ANY_ORA_ERROR
					}	
			
						i = i + 1;

				  }
			   }	
		  } 		
		}
	}
	else
	{
		APL_GOBACK_FAIL
	}

	     

	

	if (!strcmp(chr_l_h_rgbrind, BEARER_IND))
	{
		p_dl_deal_sstdet_struct_h_a->h_delta_000 = 0;
	}

	

	if	((VAL_FREE_DEAL(l_sys_dl_deal_struct_hn->h_dealcd[0])) || 
		 ((strlen(chr_l_instr_dt)) && 
		  (strlen(chr_l_moneydt))))
	{
		strcpy(chr_l_trd_status, STATUS_SETL);
		
		strcpy(chr_l_fail_code,APL_NULL_STRING);
		l_i_fail_code	= -1;
		

		l_i_subfailcode	= -1;
	}
	else if (strlen(chr_l_instr_dt))
	{
		strcpy(chr_l_trd_status, STATUS_INSTR_SETL);
		
		strcpy(chr_l_fail_code,FAILREASON_539_INSTRSETL);
		l_i_fail_code	= 0;
		

		l_i_subfailcode	= 0;
	}
	else if (strlen(chr_l_moneydt))
	{
		strcpy(chr_l_trd_status, STATUS_MON_SETL);
		
		strcpy(chr_l_fail_code,FAILREASON_539_MONEYSETL);
		l_i_fail_code	= 0;
		

		l_i_subfailcode	= 0;
	}

	

	if (p_dl_deal_sstdet_struct_h_a->h_ispart_[0] == 'Y')
	{
		
		
		if (!strcmp(l_sys_dl_deal_struct_hn->h_maker, l_sys_dl_deal_struct_hn->h_checker))
		{
			CR_Proc_InstrQtyRound(l_sys_dl_deal_struct_hn->h_qty-p_dl_deal_sstdet_struct_h_a->h_newquantity,l_sys_dl_deal_struct_hn->h_instr_code,&h_l_quantity,l_debug_info_ptr);

			EXEC SQL	UPDATE dl_deal
			SET	QTY = :h_l_quantity,
					AMOUNT = ROUND(AMOUNT-:p_dl_deal_sstdet_struct_h_a->h_newamount,:int_l_h_amt_declen),
					PARTIAL_IND_B = 'Y',
					checker = :p_intl_envdatastruct_h->usr,
					checker_dt = :chr_l_now,
					access_stamp = :chr_l_now
			WHERE rowid = :chr_l_h_rowid;

			IS_ANY_ORA_ERROR_AND_ZERO_RESULTSET(	ERR_DEAL_NF,
																p_dl_deal_sstdet_struct_h_a->h_dl_client,
																p_dl_deal_sstdet_struct_h_a->h_indentity_no,
																APL_NULL_STRING);
		}
		else
		{
			CR_Proc_InstrQtyRound(l_sys_dl_deal_struct_hn->h_qty-p_dl_deal_sstdet_struct_h_a->h_newquantity,l_sys_dl_deal_struct_hn->h_instr_code,&h_l_quantity,l_debug_info_ptr);

			EXEC SQL	UPDATE dl_deal
			SET	QTY = :h_l_quantity,
					AMOUNT = ROUND(AMOUNT-:p_dl_deal_sstdet_struct_h_a->h_newamount,:int_l_h_amt_declen),
					PARTIAL_IND_B = 'Y',
					access_stamp = :chr_l_now
			WHERE rowid = :chr_l_h_rowid;

			IS_ANY_ORA_ERROR_AND_ZERO_RESULTSET(	ERR_DEAL_NF,
																p_dl_deal_sstdet_struct_h_a->h_dl_client,
																p_dl_deal_sstdet_struct_h_a->h_indentity_no,
																APL_NULL_STRING);
		}	
	
		

		strcpy(l_dl_dealaudit_struct_h->h_dl_client, p_dl_deal_sstdet_struct_h_a->h_dl_client);
		strcpy(l_dl_dealaudit_struct_h->h_indentity_no, p_dl_deal_sstdet_struct_h_a->h_indentity_no);
		strcpy(l_dl_dealaudit_struct_h->h_trail_for, "T");
		strcpy(l_dl_dealaudit_struct_h->h_processdetail, p_intl_envdatastruct_h->processtion);
		strcpy(l_dl_dealaudit_struct_h->h_proc_usr, p_intl_envdatastruct_h->usr);
		strcpy(l_dl_dealaudit_struct_h->h_subprocess, PARTIALEXECUTE);
		strcpy(l_dl_dealaudit_struct_h->h_logdate, APL_NULL_STRING);
		strcpy(l_dl_dealaudit_struct_h->h_fail_cd, APL_NULL_STRING);
		if ((!strlen(p_dl_deal_sstdet_struct_h_a->h_instrdate)) &&
			 (strlen(p_dl_deal_sstdet_struct_h_a->h_moneydate)))
		{
			l_dl_dealaudit_struct_h->h_qty = 0;
		}
		else
		{
			l_dl_dealaudit_struct_h->h_qty = l_sys_dl_deal_struct_hn->h_qty - l_new_quantity;
		}
		strcpy(l_dl_dealaudit_struct_h->h_dlfromord, l_sys_dl_deal_struct_hn->h_dlfromord);
						
		if (APL_FAILURE == CR_Mod_CLHAudTrail(l_dl_dealaudit_struct_h, l_debug_info_ptr))
		{
			APL_GOBACK_FAIL
		} 

		

		strcpy(l_sys_dl_deal_struct_hn->h_ispart_, "N");
		l_sys_dl_deal_struct_hn->h_qty = p_dl_deal_sstdet_struct_h_a->h_newquantity;
		l_sys_dl_deal_struct_hn->h_amt = p_dl_deal_sstdet_struct_h_a->h_newamount;
		strcpy(l_sys_dl_deal_struct_hn->h_indentity_no, p_dl_deal_sstdet_struct_h_a->h_newindentity_no);
		if ((p_dl_deal_sstdet_struct_h_a->h_mcomplquantity) || (p_dl_deal_sstdet_struct_h_a->h_marktrfquantity))
		{
			strcpy(l_sys_dl_deal_struct_hn->h_lastregdate, chr_l_date);
		}
		l_sys_dl_deal_struct_hn->h_stx_comm = 0.0;
		l_sys_dl_deal_struct_hn->h_custodycomm = 0.0;
		l_sys_dl_deal_struct_hn->h_oth_comm = 0.0;
		l_sys_dl_deal_struct_hn->h_pr = p_dl_deal_sstdet_struct_h_a->h_pr;
		strcpy(l_sys_dl_deal_struct_hn->h_classofdl, "20");
		strcpy(l_sys_dl_deal_struct_hn->h_fail_cd, chr_l_fail_code);  
		strcpy(l_sys_dl_deal_struct_hn->h_failinfo, APL_NULL_STRING);
		strcpy(l_sys_dl_deal_struct_hn->h_custinfo, APL_NULL_STRING);
		strcpy(l_sys_dl_deal_struct_hn->h_markfaildate, APL_NULL_STRING);			
		strcpy(l_sys_dl_deal_struct_hn->h_pos_stat, chr_l_new_status);
		strcpy(l_sys_dl_deal_struct_hn->h_instrdate, p_dl_deal_sstdet_struct_h_a->h_instrdate);			
		strcpy(l_sys_dl_deal_struct_hn->h_moneydate, p_dl_deal_sstdet_struct_h_a->h_moneydate);			
		if (APL_FAILURE == DL_Rtv_DLDropToHis(	chr_l_instr_dt,
                     							chr_l_moneydt,
                     							l_sys_dl_deal_struct_hn->h_pos_stat,
                     							l_sys_dl_deal_struct_hn->h_dealcd[0],
                     							&p_dl_deal_sstdet_struct_h_a->h_mcomplquantity,
                     							&l_sys_dl_deal_struct_hn->h_complquantity,
                     							&l_sys_dl_deal_struct_hn->h_qty,
                     							chr_l_candropdt,
                     							l_debug_info_ptr ))
		{
			APL_GOBACK_FAIL
		}
		strcpy(l_sys_dl_deal_struct_hn->h_candropdate, chr_l_candropdt);
		strcpy(l_sys_dl_deal_struct_hn->h_mod_hispos_ind, chr_l_hisposflg);
		l_sys_dl_deal_struct_hn->h_brokercomm = p_dl_deal_sstdet_struct_h_a->h_brokercomm;
		l_sys_dl_deal_struct_hn->h_rec_int_000 = p_dl_deal_sstdet_struct_h_a->h_rec_int_000;
		l_sys_dl_deal_struct_hn->h_delta_000 = p_dl_deal_sstdet_struct_h_a->h_delta_000;
		l_sys_dl_deal_struct_hn->h_delta_001 = p_dl_deal_sstdet_struct_h_a->h_delta_001;
		l_sys_dl_deal_struct_hn->h_delta_002 = p_dl_deal_sstdet_struct_h_a->h_delta_002;
		strcpy(l_sys_dl_deal_struct_hn->h_deal_status, chr_l_trd_status);
		if (!strcmp(l_sys_dl_deal_struct_hn->h_maker, l_sys_dl_deal_struct_hn->h_checker))
		{
			strcpy(l_sys_dl_deal_struct_hn->h_checker, p_intl_envdatastruct_h->usr);
			strcpy(l_sys_dl_deal_struct_hn->h_checker_dt, chr_l_now);
		}
		strcpy(l_sys_dl_deal_struct_hn->h_access_stamp, chr_l_now);

		

		strcpy(p_intl_envdatastruct_h->h_mode, APL_FUNC_INPUT);

		int_l_chkflg = 0;

		if (APL_FAILURE == DL_Mod_DL(	l_sys_dl_deal_struct_hn,
													APL_NULL_STRING,
													&int_l_chkflg,
													p_intl_envdatastruct_h,
													l_debug_info_ptr ))
		{
			APL_GOBACK_FAIL
		}

		

		memset(l_dl_dealaudit_struct_h, NULL, sizeof(DL_DEALAUDIT_STRUCT_H));
		strcpy(l_dl_dealaudit_struct_h->h_dl_client, p_dl_deal_sstdet_struct_h_a->h_dl_client);
		strcpy(l_dl_dealaudit_struct_h->h_indentity_no, p_dl_deal_sstdet_struct_h_a->h_newindentity_no);
		strcpy(l_dl_dealaudit_struct_h->h_trail_for, "T");
		strcpy(l_dl_dealaudit_struct_h->h_processdetail, p_intl_envdatastruct_h->processtion);
		strcpy(l_dl_dealaudit_struct_h->h_proc_usr, p_intl_envdatastruct_h->usr);
		if ((strlen(p_dl_deal_sstdet_struct_h_a->h_instrdate)) && (strlen(p_dl_deal_sstdet_struct_h_a->h_moneydate)))
		{
			strcpy(chr_l_subfun, SETTLE_SD_MD);
		}
		else if (strlen(p_dl_deal_sstdet_struct_h_a->h_instrdate))
		{
			strcpy(chr_l_subfun, SETTLE_SD);
		}
		else
		{
			strcpy(chr_l_subfun, SETTLE_MD);
		}
		strcpy(l_dl_dealaudit_struct_h->h_subprocess, chr_l_subfun);
		strcpy(l_dl_dealaudit_struct_h->h_logdate, APL_NULL_STRING);
		strcpy(l_dl_dealaudit_struct_h->h_fail_cd, chr_l_fail_code);		
		l_dl_dealaudit_struct_h->h_qty = l_new_quantity;
		strcpy(l_dl_dealaudit_struct_h->h_dlfromord, l_sys_dl_deal_struct_hn->h_dlfromord);
						
		if (APL_FAILURE == CR_Mod_CLHAudTrail(l_dl_dealaudit_struct_h, l_debug_info_ptr))
		{
			APL_GOBACK_FAIL
		} 
	}
	else 
	{

		

		if (APL_FAILURE == DL_Rtv_DLDropToHis(	chr_l_instr_dt,
      	              							chr_l_moneydt,
         	           							chr_l_new_status,
            	        							l_sys_dl_deal_struct_hn->h_dealcd[0],
               	     							&p_dl_deal_sstdet_struct_h_a->h_mcomplquantity,
                  	  							&l_sys_dl_deal_struct_hn->h_complquantity,
                    								&l_sys_dl_deal_struct_hn->h_qty,
                    								chr_l_candropdt,
                    								l_debug_info_ptr ))
		{
			APL_GOBACK_FAIL
		}

		int_l_price_declen = PR_DEC_LEN;


		

		  

       EXEC SQL SELECT FIELD_VAL INTO :int_l_domcpac
       FROM PRO_GSSPLVAL
       WHERE MAIN_FUN = 'SING_SETTL'
       AND SUB_PROCESS = 'DOMCPAC'
       AND NATION = :g_mt_commonsys_params_struct_h.nation_code;

       

       EXEC SQL SELECT FIELD_VAL INTO :chr_l_locncode_c
       FROM PRO_GSSPLVAL
       WHERE MAIN_FUN = 'SING_SETTL'
       AND SUB_PROCESS = 'LOCATION_BOND'
       AND NATION = :g_mt_commonsys_params_struct_h.nation_code;
   	
		 if  ((strcmp(l_sys_dl_deal_struct_hn->h_loccode, chr_l_locncode_c)==0) && 
			   (strcmp(l_sys_dl_deal_struct_hn->h_domcpclt_cd, int_l_domcpac)==0) &&  
		      (strcmp(p_intl_envdatastruct_h->processtion,"GSETL_IND")==0))  
	    {
			strcpy(chr_l_new_typeoftrd,EXTERNALDEAL);
	    }
	    else
		 {
   	 	strcpy(chr_l_new_typeoftrd,l_sys_dl_deal_struct_hn->h_classofdl);
	    }


		printf("\n PJ 5065 \n");	

		
      
		

		if (APL_FAILURE == CO_Chk_CntryEnabled("TRADE_MAINT","NDS_EQ_INSTR_DT",&int_l_exist_a,l_debug_info_ptr))
		{
			APL_GOBACK_FAIL
		}
		if (int_l_exist_a > 0)
		{
			strcpy(chr_l_ndsdt,chr_l_instr_dt);
		}
		else
		{
			strcpy(chr_l_ndsdt,APL_NULL_STRING);
		}	
 
		if (!strcmp(chr_l_ndsdt,APL_NULL_STRING))
		{
			l_i_ndsdt = -1;
		}
		if (!strcmp(l_sys_dl_deal_struct_hn->h_maker, l_sys_dl_deal_struct_hn->h_checker))
		{


			EXEC SQL UPDATE dl_deal 
			SET 	INSTRUMENT_DT		    = :chr_l_instr_dt,
					NDS_DATE        = :chr_l_ndsdt:l_i_ndsdt,
					MONEY_SETL_DT	    = :chr_l_moneydt,
					COST        = ROUND(:p_dl_deal_sstdet_struct_h_a->h_pr,:int_l_price_declen),
					brokercomm      = ROUND(:p_dl_deal_sstdet_struct_h_a->h_brokercomm,:int_l_h_amt_declen),
					STATUS_POS  = :chr_l_new_status,
					failreason_cd     = :chr_l_fail_code:l_i_fail_code,     
					sub_fail_cd	 =	:int_l_h_subfailcode:l_i_subfailcode,
					fail_det     = NULL,
					client_note     = NULL,
					DATEOF_MARKFAIL	 = NULL,
					ALLOW_DROPDT	 = :chr_l_candropdt,
					MOD_HISPOS_IND = :chr_l_hisposflg,
					REC_INT_000	 = :p_dl_deal_sstdet_struct_h_a->h_rec_int_000,
					DELTA_000    = :p_dl_deal_sstdet_struct_h_a->h_delta_000,
					DELTA_001    = :p_dl_deal_sstdet_struct_h_a->h_delta_001,
					DELTA_003    = :p_dl_deal_sstdet_struct_h_a->h_delta_002,
					checker      = :p_intl_envdatastruct_h->usr,
					checker_dt 	 = :chr_l_now,
					DEAL_STAT = :chr_l_trd_status,
				   dl_class	 = :chr_l_new_typeoftrd,	
					access_stamp = :chr_l_now
			WHERE rowid = :chr_l_h_rowid;

			IS_ANY_ORA_ERROR_AND_ZERO_RESULTSET(	ERR_DEAL_NF,
																p_dl_deal_sstdet_struct_h_a->h_dl_client,
																p_dl_deal_sstdet_struct_h_a->h_indentity_no,
																APL_NULL_STRING);
		}
		else
		{
			EXEC SQL UPDATE dl_deal 
			SET   INSTRUMENT_DT		    = :chr_l_instr_dt,
               NDS_DATE        = :chr_l_ndsdt:l_i_ndsdt,
					MONEY_SETL_DT	    = :chr_l_moneydt,
					COST        = ROUND(:p_dl_deal_sstdet_struct_h_a->h_pr,:int_l_price_declen),
					brokercomm      = ROUND(:p_dl_deal_sstdet_struct_h_a->h_brokercomm,:int_l_h_amt_declen),
					STATUS_POS  = :chr_l_new_status,
					failreason_cd     = :chr_l_fail_code:l_i_fail_code,    
					sub_fail_cd	 =	:int_l_h_subfailcode:l_i_subfailcode,
					fail_det     = NULL,
					client_note     = NULL,
					DATEOF_MARKFAIL	 = NULL,
					ALLOW_DROPDT	 = :chr_l_candropdt,
					MOD_HISPOS_IND = :chr_l_hisposflg,
					REC_INT_000	 = :p_dl_deal_sstdet_struct_h_a->h_rec_int_000,
					DELTA_000    = :p_dl_deal_sstdet_struct_h_a->h_delta_000,
					DELTA_001    = :p_dl_deal_sstdet_struct_h_a->h_delta_001,
					DELTA_003    = :p_dl_deal_sstdet_struct_h_a->h_delta_002,
					DEAL_STAT = :chr_l_trd_status,
				   dl_class	 = :chr_l_new_typeoftrd,	
					access_stamp = :chr_l_now
			WHERE rowid = :chr_l_h_rowid;


			IS_ANY_ORA_ERROR_AND_ZERO_RESULTSET(	ERR_DEAL_NF,
																p_dl_deal_sstdet_struct_h_a->h_dl_client,
																p_dl_deal_sstdet_struct_h_a->h_indentity_no,
																APL_NULL_STRING);
		}

		
	
		memset(l_dl_dealaudit_struct_h, NULL, sizeof(DL_DEALAUDIT_STRUCT_H));

		strcpy(l_dl_dealaudit_struct_h->h_dl_client, p_dl_deal_sstdet_struct_h_a->h_dl_client);
		strcpy(l_dl_dealaudit_struct_h->h_indentity_no, p_dl_deal_sstdet_struct_h_a->h_indentity_no);
		strcpy(l_dl_dealaudit_struct_h->h_trail_for, "T");
		strcpy(l_dl_dealaudit_struct_h->h_processdetail, p_intl_envdatastruct_h->processtion);
		strcpy(l_dl_dealaudit_struct_h->h_proc_usr, p_intl_envdatastruct_h->usr);
		if ((strlen(p_dl_deal_sstdet_struct_h_a->h_instrdate)) && (strlen(p_dl_deal_sstdet_struct_h_a->h_moneydate)))
		{
			strcpy(chr_l_subfun, SETTLE_SD_MD);
		}
		else if (strlen(p_dl_deal_sstdet_struct_h_a->h_instrdate))
		{
			strcpy(chr_l_subfun, SETTLE_SD);
		}
		else
		{
			strcpy(chr_l_subfun, SETTLE_MD);
		}
		strcpy(l_dl_dealaudit_struct_h->h_subprocess, chr_l_subfun);
		strcpy(l_dl_dealaudit_struct_h->h_logdate, APL_NULL_STRING);
		strcpy(l_dl_dealaudit_struct_h->h_fail_cd, chr_l_fail_code);		
		l_dl_dealaudit_struct_h->h_qty = l_sys_dl_deal_struct_hn->h_qty;
		strcpy(l_dl_dealaudit_struct_h->h_dlfromord, l_sys_dl_deal_struct_hn->h_dlfromord);
						
		if (APL_FAILURE == CR_Mod_CLHAudTrail(l_dl_dealaudit_struct_h, l_debug_info_ptr))
		{
			APL_GOBACK_FAIL
		}
	} 


	

	if (strlen(p_dl_deal_sstdet_struct_h_a->h_newindentity_no))
	{
		strcpy(chr_l_new_refno, p_dl_deal_sstdet_struct_h_a->h_newindentity_no);
	}
	else
	{
		strcpy(chr_l_new_refno, p_dl_deal_sstdet_struct_h_a->h_indentity_no);
	}

	if ((l_mt_core_sys_params_struct_h.proc_reg_ind[0] == 'Y') &&
		 (VAL_RECDEAL(l_sys_dl_deal_struct_hn->h_dealcd[0]) || l_sys_dl_deal_struct_hn->h_dealcd[0]=='6' || l_sys_dl_deal_struct_hn->h_dealcd[0]=='8'))
	{
		

		if (p_dl_deal_sstdet_struct_h_a->h_marktrfquantity)
		{	
			if ( APL_FAILURE == DL_Proc_Reg( p_dl_deal_sstdet_struct_h_a->h_dl_client,
															 chr_l_new_refno,
															 l_sys_dl_deal_struct_hn->h_delrecdate,
															 chr_l_date,
															 &l_sys_dl_deal_struct_hn->h_qty,
															 &p_dl_deal_sstdet_struct_h_a->h_marktrfquantity,
															 DL_MARKTRF_REGSTCODE,
															 p_intl_envdatastruct_h,
															 l_debug_info_ptr ))
			{
				APL_GOBACK_FAIL
			}
		}

		

		if (p_dl_deal_sstdet_struct_h_a->h_mcomplquantity)
		{	
			if ( APL_FAILURE == DL_Proc_Reg( p_dl_deal_sstdet_struct_h_a->h_dl_client,
															 chr_l_new_refno,
															 l_sys_dl_deal_struct_hn->h_delrecdate,
															 chr_l_date,
															 &l_sys_dl_deal_struct_hn->h_qty,
															 &p_dl_deal_sstdet_struct_h_a->h_mcomplquantity,
															 DL_MARKCOMPL_REGSTCODE,
															 p_intl_envdatastruct_h,
															 l_debug_info_ptr ))
			{
				APL_GOBACK_FAIL
			}
		}
	}


	

	if (strlen(p_dl_deal_sstdet_struct_h_a->h_instrdate))
	{
		EXEC SQL UPDATE MT_CLIENT
		SET 	CLN_POS_DT = :p_dl_deal_sstdet_struct_h_a->h_instrdate
		WHERE CLN_CODE = :p_dl_deal_sstdet_struct_h_a->h_dl_client;
	}
			
	IS_ANY_ORA_ERROR_AND_ZERO_RESULTSET(	ERR_ACCNOT_FND,
														p_dl_deal_sstdet_struct_h_a->h_dl_client,
														APL_NULL_STRING,
														APL_NULL_STRING);
	
	

	
	printf("\n 5257 came here %s %s\n",l_sys_dl_deal_struct_hn->h_classofdl,DEALTYPE_CORP_A);  
	if	 (!strcmp(l_sys_dl_deal_struct_hn->h_classofdl,RTSPROCDEAL) ||
			!strcmp(l_sys_dl_deal_struct_hn->h_classofdl,DEALTYPE_CORP_A) )
		
	{
		if (strcmp(chr_l_trd_status,"CS")==0)
        {
			EXEC SQL SELECT COUNT(*) INTO :int_lp_count
                   FROM DEAL_EVNTIDLINK
	                WHERE CLIENT = :l_sys_dl_deal_struct_hn->h_dl_client
                   AND IDENTIY_NO = :l_sys_dl_deal_struct_hn->h_indentity_no
                   AND SWIFT_MSG_NO = '563N02'; 

			IS_ANY_ORA_ERROR 
 
			if(int_lp_count > 0)
			{
				printf("\n no link found\n"); 
			  
				EXEC SQL SELECT SWIFT_MSGREFNO || ' 12:00:00',EVENT_ID
						 INTO :chr_lp_decldt,:chr_lp_event
						 FROM DEAL_EVNTIDLINK
							WHERE CLIENT = :l_sys_dl_deal_struct_hn->h_dl_client
						AND IDENTIY_NO = :l_sys_dl_deal_struct_hn->h_indentity_no
						AND SWIFT_MSG_NO = '563N02'; 
						  
				if (strlen(chr_lp_event) != 0)
						{
						  CO_SplitStr(chr_lp_event,';', &int_lp_noelem, &chr_lp_param);
						 strcpy(chr_lp_cetyp,chr_lp_param[0]);
					 strcpy(chr_lp_eventnbr,chr_lp_param[1]);	
						} 
				sprintf(chr_lp_param_string,"%s%s%s%s%s%s%s%s%s%s",
							  l_sys_dl_deal_struct_hn->h_instr_code,
							  ";",
						chr_lp_cetyp,
							  ";",
							  chr_lp_decldt,
							  ";",
						chr_lp_eventnbr,
							  ";",
						l_sys_dl_deal_struct_hn->h_indentity_no,
							  ";");
					printf("lp_param_string for 563N02 is %s\n",chr_lp_param_string);
						 
				printf("\n calling GBDbInsIMSGENT for 563N02 ..");
				if(GBDbInsIMSGENT("563N02",
							  APL_NULL_STRING,
							  l_sys_dl_deal_struct_hn->h_dl_client,
											 'Y',
							  chr_lp_param_string,
							l_debug_info_ptr)==APL_FAILURE)
				   {
					  CO_ProcMonitor(APL_OUT_FILE,"Failure from GBDbInsIMSGENT\n",NULL,p_intl_envdatastruct_h);
					  APL_GOBACK_FAIL
				   }

					strcpy(l_ms_msgstat_structa.proc_init,l_sys_dl_deal_struct_hn->h_indentity_no);
				strcpy(l_ms_msgstat_structa.swift_msg_rep,"563N02"); 
				strcpy(l_ms_msgstat_structa.client,l_sys_dl_deal_struct_hn->h_dl_client);
				strcpy(l_ms_msgstat_structa.generate_dt,chr_l_now);


				if (APL_FAILURE == MS_Mod_MsgStat(	l_ms_msgstat_structa,
																&int_retstat,
																l_debug_info_ptr ))
					 {
					   APL_GOBACK_FAIL
					 }
			   
			   EXEC SQL UPDATE DL_DEAL
				   SET MSG_STAT = ltrim(rtrim(MSG_STAT))||'A'
				   WHERE CLIENT=RTRIM(:l_sys_dl_deal_struct_hn->h_dl_client)
				   AND   IDENTIY_NO  =RTRIM(:l_sys_dl_deal_struct_hn->h_indentity_no)
				   AND INSTR(NVL(MSG_STAT,' '),'A') = 0
				   AND INSTRUMENT_DT IS NOT NULL ;

				   IS_ANY_ORA_ERROR	
				 
			} 
			else 
			{ 
				memset(chr_l_prevseme,APL_NULL_CHAR,17);
				EXEC SQL SELECT SWIFT_MSGREFNO INTO :chr_l_prevseme:i_prevseme
					  FROM DEAL_EVNTIDLINK
					  WHERE IDENTIY_NO = :l_sys_dl_deal_struct_hn->h_indentity_no
					  AND CLIENT = :l_sys_dl_deal_struct_hn->h_dl_client
					  AND SWIFT_MSG_NO = '563N05'
					  AND ACCESS_STAMP = ( SELECT MAX(ACCESS_STAMP) FROM DEAL_EVNTIDLINK WHERE IDENTIY_NO = :l_sys_dl_deal_struct_hn->h_indentity_no
											AND CLIENT = :l_sys_dl_deal_struct_hn->h_dl_client AND SWIFT_MSG_NO = '563N05');

				IS_ANY_ORA_ERROR

				strcpy(chr_param_string,l_sys_dl_deal_struct_hn->h_instr_code);
				strcat(chr_param_string,";");
				strcat(chr_param_string,p_ru_eventid);
				strcat(chr_param_string,";");
				if (i_prevseme != -1)
				strcat(chr_param_string,chr_l_prevseme);
				strcat(chr_param_string,";");
				strcat(chr_param_string,";");         

				if (APL_FAILURE == GBDbInsIMSGENT(	"563N05",
																l_sys_dl_deal_struct_hn->h_indentity_no,
																l_sys_dl_deal_struct_hn->h_dl_client,
																'Y',
																chr_param_string,
																l_debug_info_ptr ))
				{
					APL_GOBACK_FAIL
				}
		
				strcpy(l_ms_msgstat_structa.proc_init,l_sys_dl_deal_struct_hn->h_indentity_no);
				strcpy(l_ms_msgstat_structa.swift_msg_rep,"563N05"); 
				strcpy(l_ms_msgstat_structa.client,l_sys_dl_deal_struct_hn->h_dl_client);
				strcpy(l_ms_msgstat_structa.generate_dt,chr_l_now);


				if (APL_FAILURE == MS_Mod_MsgStat(	l_ms_msgstat_structa,
																&int_retstat,
																l_debug_info_ptr ))
				{
					APL_GOBACK_FAIL
				}
			 
				EXEC SQL UPDATE DL_DEAL
					SET MSG_STAT = ltrim(rtrim(MSG_STAT))||'A'
					WHERE CLIENT=RTRIM(:l_sys_dl_deal_struct_hn->h_dl_client)
					AND   IDENTIY_NO  =RTRIM(:l_sys_dl_deal_struct_hn->h_indentity_no)
					AND INSTR(NVL(MSG_STAT,' '),'A') = 0
					AND INSTRUMENT_DT IS NOT NULL ;

				IS_ANY_ORA_ERROR	
			}
		}
		else
		{
			EXEC SQL UPDATE DL_DEAL
            SET MSG_STAT = ltrim(rtrim(MSG_STAT))||'C'
            WHERE CLIENT=RTRIM(:l_sys_dl_deal_struct_hn->h_dl_client)
            AND   IDENTIY_NO  =RTRIM(:l_sys_dl_deal_struct_hn->h_indentity_no)
            AND INSTR(NVL(MSG_STAT,' '),'C') = 0;

			IS_ANY_ORA_ERROR        
		}
	}
	else if ((!strcmp(l_sys_dl_deal_struct_hn->h_classofdl,"11")) && (!strcmp(l_sys_dl_deal_struct_hn->h_entry,"G")))
	{
		if (strcmp(chr_l_trd_status,"CS")==0)
		{
			memset(chr_l_sc_eventid,APL_NULL_CHAR,17);
			EXEC SQL SELECT EVENT_ID INTO :chr_l_sc_eventid:i_sc_eventid
			FROM DEAL_EVNTIDLINK
			WHERE SWIFT_MSG_NO='563N04'
			AND CLIENT = :l_sys_dl_deal_struct_hn->h_dl_client
			AND IDENTIY_NO = :l_sys_dl_deal_struct_hn->h_indentity_no;

			IS_ANY_ORA_ERROR
			

			strcpy(chr_param_string,APL_NULL_STRING);
			strcat(chr_param_string,";");
			strcat(chr_param_string,chr_l_sc_eventid);
			strcat(chr_param_string,";");

			if(l_sys_dl_deal_struct_hn->h_dealcd[0] == DEALCD_DF)
			  strcat(chr_param_string,"D");
			else
			  strcat(chr_param_string,"R");

			strcat(chr_param_string,";");

			if (APL_FAILURE == GBDbInsIMSGENT("563N04",l_sys_dl_deal_struct_hn->h_indentity_no,l_sys_dl_deal_struct_hn->h_dl_client,'Y',chr_param_string,l_debug_info_ptr))
				 APL_GOBACK_FAIL
			strcpy(l_ms_msgstat_structa.proc_init,l_sys_dl_deal_struct_hn->h_indentity_no);
			strcpy(l_ms_msgstat_structa.swift_msg_rep,"53x");
			strcpy(l_ms_msgstat_structa.client,l_sys_dl_deal_struct_hn->h_dl_client);
			strcpy(l_ms_msgstat_structa.generate_dt,chr_l_now);

			if(APL_FAILURE == MS_Mod_MsgStat(l_ms_msgstat_structa,&int_retstat,l_debug_info_ptr))
					{
					  APL_GOBACK_FAIL
					}

				EXEC SQL UPDATE DL_DEAL
				SET MSG_STAT = ltrim(rtrim(MSG_STAT))||'A'
				WHERE CLIENT=RTRIM(:l_sys_dl_deal_struct_hn->h_dl_client)
				AND   IDENTIY_NO  =RTRIM(:l_sys_dl_deal_struct_hn->h_indentity_no)
				AND INSTR(NVL(MSG_STAT,' '),'A') = 0
				AND INSTRUMENT_DT IS NOT NULL ;

				IS_ANY_ORA_ERROR
		}
		else
		{
			EXEC SQL UPDATE DL_DEAL
            SET MSG_STAT = ltrim(rtrim(MSG_STAT))||'C'
            WHERE CLIENT=RTRIM(:l_sys_dl_deal_struct_hn->h_dl_client)
            AND   IDENTIY_NO  =RTRIM(:l_sys_dl_deal_struct_hn->h_indentity_no)
            AND INSTR(NVL(MSG_STAT,' '),'C') = 0;

            IS_ANY_ORA_ERROR

		}
	} 
	else if(strcmp(chr_l_trd_status, STATUS_INSTR_SETL)==0)
	{
		strcpy(chr_l_msg_type, "539");
		      memset(chr_param_string,APL_NULL_CHAR,201);
				strcpy(chr_param_string,chr_l_instr_dt);
				strcat(chr_param_string,";");

		if (APL_FAILURE == GBDbInsIMSGENT(  "539",
										  l_sys_dl_deal_struct_hn->h_indentity_no,
										  l_sys_dl_deal_struct_hn->h_dl_client,
										  'Y',
										  chr_param_string,
										  l_debug_info_ptr ))
		{
		 APL_GOBACK_FAIL
		}

		memset(chr_param_string,APL_NULL_CHAR,201);
		strcpy(chr_param_string,APL_NULL_STRING);
		if ( APL_FAILURE == GBDbInsIMSGENT( MS_MSGNO_534,
											 l_sys_dl_deal_struct_hn->h_indentity_no,
											 l_sys_dl_deal_struct_hn->h_dl_client,
											 'Y',
											 chr_param_string,
											 l_debug_info_ptr ) )
		{
		   APL_GOBACK_FAIL;
		}



	}
	else if(strcmp(chr_l_trd_status, STATUS_MON_SETL)==0)
	{
		memset(chr_param_string,APL_NULL_CHAR,201);
		strcpy(chr_param_string,APL_NULL_STRING);
		if ( APL_FAILURE == GBDbInsIMSGENT( MS_MSGNO_534,
											 l_sys_dl_deal_struct_hn->h_indentity_no,
											 l_sys_dl_deal_struct_hn->h_dl_client,
											 'Y',
											 chr_param_string,
											 l_debug_info_ptr ) )
		{
		   APL_GOBACK_FAIL;
		}
	}
	else if (l_mt_core_sys_params_struct_h.ms_53x_online_eod_ind[0] == MS_SEND53X_ONLINE_IND)
	{

	

	

		strcpy(chr_l_msg_type, "53x");
		memset(chr_param_string,APL_NULL_CHAR,APL_INSTRUMENTCODE_LEN+2);
		strcpy(chr_param_string,APL_NULL_STRING);

		if (APL_FAILURE == GBDbInsIMSGENT(	chr_l_msg_type,
														l_sys_dl_deal_struct_hn->h_indentity_no,
														l_sys_dl_deal_struct_hn->h_dl_client,
														'Y',
														chr_param_string,
														l_debug_info_ptr ))
		{
			APL_GOBACK_FAIL
		}
	}

	printf("values are l_sys_dl_deal_struct_hn->h_setldt is %s, l_sys_dl_deal_struct_hn->h_dl_client is %s, l_sys_dl_deal_struct_hn->h_indentity_no is %s \n",l_sys_dl_deal_struct_hn->h_setldt,l_sys_dl_deal_struct_hn->h_dl_client,l_sys_dl_deal_struct_hn->h_indentity_no);
	if(strncmp(l_sys_dl_deal_struct_hn->h_indentity_no,"LOCCHG",6)== 0)
	{
		if(l_sys_dl_deal_struct_hn->h_dealcd[0] == DEALCD_DF)
		{
			EXEC SQL UPDATE DL_LOCNCHG 
					 	SET DF_SETLDATE=:l_sys_dl_deal_struct_hn->h_setldt
					 	WHERE DF_TXNR_IDEN =:l_sys_dl_deal_struct_hn->h_indentity_no
						AND CLIENT = :l_sys_dl_deal_struct_hn->h_dl_client;
			
			IS_ANY_ORA_ERROR
		} 
		
		if(l_sys_dl_deal_struct_hn->h_dealcd[0] == DEALCD_RF)
		{
			EXEC SQL UPDATE DL_LOCNCHG 
					 	SET RF_SETL_DATE=:l_sys_dl_deal_struct_hn->h_setldt
					 	WHERE RF_DL_IDENT =:l_sys_dl_deal_struct_hn->h_indentity_no
						AND CLIENT = :l_sys_dl_deal_struct_hn->h_dl_client;
			
			IS_ANY_ORA_ERROR
		} 
	}
	 

	if (APL_FAILURE==EI_Mod_MQData(l_sys_dl_deal_struct_hn->h_dl_client,
								l_sys_dl_deal_struct_hn->h_indentity_no,
								NULL,
								NULL,
								"B",
								l_debug_info_ptr))
	   APL_GOBACK_FAIL


	
	
	APL_GOBACK_SUCCESS

   RETURN_SUCCESS :
      APL_IF_DEBUG
         CO_ProcMonitor(APL_OUT_FILE,"Leaving Function DL_Proc_DLSetlRRMMSing successfully", NULL, p_intl_envdatastruct_h);
		free(l_sys_dl_deal_struct_hn);
		free(l_sys_dl_deal_struct_id);
		free(l_reg_trf_struct_h);
		free(l_dl_dealaudit_struct_h);
		free(l_deal_ru_struct_h);
      return(APL_SUCCESS);

   RETURN_FAILURE :
      APL_IF_DEBUG
         CO_ProcMonitor(APL_OUT_FILE,"Leaving Function DL_Proc_DLSetlRRMMSing with errors", NULL, p_intl_envdatastruct_h);
		free(l_sys_dl_deal_struct_hn);
		free(l_sys_dl_deal_struct_id);
		free(l_reg_trf_struct_h);
		free(l_dl_dealaudit_struct_h);
		free(l_deal_ru_struct_h);
      return(APL_FAILURE);

}



int DL_Proc_PosChkMod(	DL_DEAL_SSTDET_STRUCT_H *p_dl_deal_sstdet_struct_h_a,
							char *p_instr_code,
							char *p_location,
							char *p_status_ind,
							char *p_dealcd,
							short p_iinstrdate,
							char *p_old_status,
							double p_quantity,
							char	p_chk_or_upd,
							char *p_block_type,
							int *p_success_flg,
							DEBUG_INFO_STRUCT_H **l_debug_info_ptr )
{

		

	char   chr_l_buf[BUFFER_LEN] = APL_NULL_STRING;
	double int_l_temp = 0.0;
	double l_quantity  = 0.0;
	char l_block_type[5] = APL_NULL_STRING;

	#ifdef APL_THREADS
		APL_SET_CONTEXT
		EXEC SQL CONTEXT USE	:my_ctx_local;
	#endif

	APL_IF_DEBUG
	{
		CO_ProcMonitor(APL_OUT_FILE, "Entered processtion CDBSafekSSTFn", NULL, NULL);
		memset(chr_l_buf, NULL, BUFFER_LEN);
		sprintf(chr_l_buf, "DL_Proc_PosChkMod Account is  : %s", p_dl_deal_sstdet_struct_h_a->h_dl_client);
		CO_ProcMonitor(APL_OUT_FILE, chr_l_buf, NULL, NULL);
		memset(chr_l_buf, NULL, BUFFER_LEN);
		sprintf(chr_l_buf, "DL_Proc_PosChkMod Instrode is : %s", p_instr_code);
		CO_ProcMonitor(APL_OUT_FILE, chr_l_buf, NULL, NULL);
		memset(chr_l_buf, NULL, BUFFER_LEN);
		sprintf(chr_l_buf, "DL_Proc_PosChkMod Location is : %s", p_location);
		CO_ProcMonitor(APL_OUT_FILE, chr_l_buf, NULL, NULL);
		memset(chr_l_buf, NULL, BUFFER_LEN);
		sprintf(chr_l_buf, "DL_Proc_PosChkMod Status is : %s", p_status_ind);
		CO_ProcMonitor(APL_OUT_FILE, chr_l_buf, NULL, NULL);
		memset(chr_l_buf, NULL, BUFFER_LEN);
		sprintf(chr_l_buf, "DL_Proc_PosChkMod Trcode is : %s", p_dealcd);
		CO_ProcMonitor(APL_OUT_FILE, chr_l_buf, NULL, NULL);
		memset(chr_l_buf, NULL, BUFFER_LEN);
		sprintf(chr_l_buf, "DL_Proc_PosChkMod Old Status is : %s", p_old_status);
		CO_ProcMonitor(APL_OUT_FILE, chr_l_buf, NULL, NULL);
		memset(chr_l_buf, NULL, BUFFER_LEN);
		sprintf(chr_l_buf, "DL_Proc_PosChkMod Qty is : %f", p_quantity);
		CO_ProcMonitor(APL_OUT_FILE, chr_l_buf, NULL, NULL);
		memset(chr_l_buf, NULL, BUFFER_LEN);
		sprintf(chr_l_buf, "DL_Proc_PosChkMod Pendregqty is : %f", p_dl_deal_sstdet_struct_h_a->h_pendregquantity);
		CO_ProcMonitor(APL_OUT_FILE, chr_l_buf, NULL, NULL);
		memset(chr_l_buf, NULL, BUFFER_LEN);
		sprintf(chr_l_buf, "Marktrfqty is : %f", p_dl_deal_sstdet_struct_h_a->h_marktrfquantity);
		CO_ProcMonitor(APL_OUT_FILE, chr_l_buf, NULL, NULL);
		memset(chr_l_buf, NULL, BUFFER_LEN);
		sprintf(chr_l_buf, "Mcomplqty is : %f", p_dl_deal_sstdet_struct_h_a->h_mcomplquantity);
		CO_ProcMonitor(APL_OUT_FILE, chr_l_buf, NULL, NULL);
		memset(chr_l_buf, NULL, BUFFER_LEN);
		sprintf(chr_l_buf, "Recint000 is : %f", p_dl_deal_sstdet_struct_h_a->h_rec_int_000);
		CO_ProcMonitor(APL_OUT_FILE, chr_l_buf, NULL, NULL);
		memset(chr_l_buf, NULL, BUFFER_LEN);
		sprintf(chr_l_buf, "Delfrm000 is : %f", p_dl_deal_sstdet_struct_h_a->h_delta_000);
		CO_ProcMonitor(APL_OUT_FILE, chr_l_buf, NULL, NULL);
		memset(chr_l_buf, NULL, BUFFER_LEN);
		sprintf(chr_l_buf, "Delfrm001 is : %f", p_dl_deal_sstdet_struct_h_a->h_delta_001);
		CO_ProcMonitor(APL_OUT_FILE, chr_l_buf, NULL, NULL);
		memset(chr_l_buf, NULL, BUFFER_LEN);
		sprintf(chr_l_buf, "Delfrm003 is : %f", p_dl_deal_sstdet_struct_h_a->h_delta_002);
		CO_ProcMonitor(APL_OUT_FILE, chr_l_buf, NULL, NULL);
		memset(chr_l_buf, NULL, BUFFER_LEN);
		sprintf(chr_l_buf, "Check or Update Flag is : %c", p_chk_or_upd);
		CO_ProcMonitor(APL_OUT_FILE, chr_l_buf, NULL, NULL);
	}

	if(strlen(p_block_type))
		strcpy(l_block_type,p_block_type);
	else
		strcpy(l_block_type,"FREE");


	if (l_mt_core_sys_params_struct_h.proc_reg_ind[0] == 'Y')
	{
		if (VAL_RECDEAL(p_dealcd[0]) || p_dealcd[0]=='6' || p_dealcd[0]=='8')
		{
			if (!strcmp(p_old_status, p_status_ind))
			{
				if (p_iinstrdate == -1)
				{
					if (p_chk_or_upd == 'C')
					{
						if (int_l_move_from_dp_to_settled == 1)
						{
							if (APL_FAILURE == DL_Proc_PosCalc(	p_dl_deal_sstdet_struct_h_a->h_dl_client,
																			p_instr_code,
																			p_location,
																			p_status_ind,
																			APL_NULL_STRING,
																			"DPR",
																			&l_quantity,
																			l_block_type,
																			l_debug_info_ptr ))
							{
								APL_GOBACK_FAIL
							}
						}
						else
						{
							if (APL_FAILURE == DL_Proc_PosCalc(	p_dl_deal_sstdet_struct_h_a->h_dl_client,
																			p_instr_code,
																			p_location,
																			p_status_ind,
																			APL_NULL_STRING,
																			"CR",
																			&l_quantity,
																			l_block_type,
																			l_debug_info_ptr ))
							{
								APL_GOBACK_FAIL
							}
						}	
						if (l_quantity < p_quantity)
						{
							*p_success_flg = APL_FAILURE;
							APL_GOBACK_SUCCESS
						}
					}
					if (p_chk_or_upd == 'U')
					{
						if (int_l_move_from_dp_to_settled == 1)
						{
							if (APL_FAILURE == DL_Mod_Posn(	p_dl_deal_sstdet_struct_h_a->h_dl_client,
																			p_instr_code,
																			p_location,
																			p_status_ind,
																			'D',
																			p_dealcd[0],
																			&p_quantity,
																			'D',l_block_type,
																			l_debug_info_ptr ))
							{
								APL_GOBACK_FAIL
							}
							if (APL_FAILURE == DL_Mod_Posn(	p_dl_deal_sstdet_struct_h_a->h_dl_client,
																			p_instr_code,
																			p_location,
																			p_status_ind,
																			'S',
																			p_dealcd[0],
																			&p_quantity,
																			'I',l_block_type,
																			l_debug_info_ptr ))
							{
								APL_GOBACK_FAIL
							}
						}
						else
						{
							if (APL_FAILURE == DL_Mod_Posn(	p_dl_deal_sstdet_struct_h_a->h_dl_client,
																			p_instr_code,
																			p_location,
																			p_status_ind,
																			'C',
																			p_dealcd[0],
																			&p_quantity,
																			'D',l_block_type,
																			l_debug_info_ptr ))
							{
								APL_GOBACK_FAIL
							}
							if (APL_FAILURE == DL_Mod_Posn(	p_dl_deal_sstdet_struct_h_a->h_dl_client,
																			p_instr_code,
																			p_location,
																			p_status_ind,
																			'S',
																			p_dealcd[0],
																			&p_quantity,
																			'I',l_block_type,
																			l_debug_info_ptr ))
							{
								APL_GOBACK_FAIL
							}
						}
					}	
				}
				if (p_dl_deal_sstdet_struct_h_a->h_rec_int_000 > 0)
				{
					if (p_chk_or_upd == 'C')
					{
						if (APL_FAILURE == DL_Proc_PosCalc(	p_dl_deal_sstdet_struct_h_a->h_dl_client,
																		p_instr_code,
																		p_location,
																		p_status_ind,
																		APL_NULL_STRING,
																		"SFK",
																		&l_quantity,l_block_type,
																		l_debug_info_ptr ))
						{
							APL_GOBACK_FAIL
						}
						if (l_quantity < p_dl_deal_sstdet_struct_h_a->h_rec_int_000)
						{
							p_success_flg = APL_FAILURE;
							APL_GOBACK_SUCCESS;
						}	
					}
					if (p_chk_or_upd == 'U')
					{
						if (APL_FAILURE == DL_Mod_Posn(	p_dl_deal_sstdet_struct_h_a->h_dl_client,
																		p_instr_code,
																		p_location,
																		p_status_ind,
																		'S',
																		p_dealcd[0],
																		&p_dl_deal_sstdet_struct_h_a->h_rec_int_000,
																		'D',l_block_type,
																		l_debug_info_ptr ))
						{
							APL_GOBACK_FAIL
						}
						if (APL_FAILURE == DL_Mod_Posn(	p_dl_deal_sstdet_struct_h_a->h_dl_client,
																		p_instr_code,
																		p_location,
																		"000",
																		'S',
																		p_dealcd[0],
																		&p_dl_deal_sstdet_struct_h_a->h_rec_int_000,
																		'I',l_block_type,
																		l_debug_info_ptr ))
						{
							APL_GOBACK_FAIL
						}
					}
				}
			}
			else  
			{
				if (p_iinstrdate == -1)
				{
					if (p_chk_or_upd == 'C')
					{
						if (APL_FAILURE == DL_Proc_PosCalc(	p_dl_deal_sstdet_struct_h_a->h_dl_client,
																		p_instr_code,
																		p_location,
																		p_old_status,
																		APL_NULL_STRING,
																		"CR",
																		&l_quantity,l_block_type,
																		l_debug_info_ptr ))
						{
							APL_GOBACK_FAIL
						}
						if (l_quantity < p_quantity)
						{
							*p_success_flg = APL_FAILURE;
							APL_GOBACK_SUCCESS
						}
					}
					if (p_chk_or_upd == 'U')
					{
						if (APL_FAILURE == DL_Mod_Posn(	p_dl_deal_sstdet_struct_h_a->h_dl_client,
																		p_instr_code,
																		p_location,
																		p_old_status,
																		'C',
																		p_dealcd[0],
																		&p_quantity,
																		'D',l_block_type,
																		l_debug_info_ptr ))
						{
							APL_GOBACK_FAIL
						}
						if (p_dl_deal_sstdet_struct_h_a->h_rec_int_000)
						{
							if (APL_FAILURE == DL_Mod_Posn(	p_dl_deal_sstdet_struct_h_a->h_dl_client,
																			p_instr_code,
																			p_location,
																			"000",
																			'S',
																			p_dealcd[0],
																			&p_dl_deal_sstdet_struct_h_a->h_rec_int_000,
																			'I',l_block_type,
																			l_debug_info_ptr ))
							{
								APL_GOBACK_FAIL
							}
						}

						

						if (	p_dl_deal_sstdet_struct_h_a->h_mcomplquantity + 
								p_dl_deal_sstdet_struct_h_a->h_pendregquantity + 
								p_dl_deal_sstdet_struct_h_a->h_marktrfquantity )
						{
							int_l_temp = (	p_dl_deal_sstdet_struct_h_a->h_mcomplquantity + 
											p_dl_deal_sstdet_struct_h_a->h_pendregquantity +
											p_dl_deal_sstdet_struct_h_a->h_marktrfquantity );
							if (APL_FAILURE == DL_Mod_Posn(	p_dl_deal_sstdet_struct_h_a->h_dl_client,
																			p_instr_code,
																			p_location,
																			"001",
																			'S',
																			p_dealcd[0],
																			&int_l_temp,
																			'I',l_block_type,
																			l_debug_info_ptr ))
							{
								APL_GOBACK_FAIL
							}
						}
					}
				}
				else if (!strcmp(p_old_status, "001"))
				{
					if (p_chk_or_upd == 'C')
					{
						if (APL_FAILURE == DL_Proc_PosCalc(	p_dl_deal_sstdet_struct_h_a->h_dl_client,
																		p_instr_code,
																		p_location,
																		"001",
																		APL_NULL_STRING,
																		"SFK",
																		&l_quantity,l_block_type,
																		l_debug_info_ptr ))
						{
							APL_GOBACK_FAIL
						}
						if (l_quantity < p_dl_deal_sstdet_struct_h_a->h_rec_int_000 + p_dl_deal_sstdet_struct_h_a->h_marktrfquantity)
						{
							*p_success_flg = APL_FAILURE;
							APL_GOBACK_SUCCESS
						}
					}
					if (p_chk_or_upd == 'U')
					{
						if (APL_FAILURE == DL_Mod_Posn(	p_dl_deal_sstdet_struct_h_a->h_dl_client,
																		p_instr_code,
																		p_location,
																		"001",
																		'S',
																		p_dealcd[0],
																		&p_dl_deal_sstdet_struct_h_a->h_rec_int_000,
																		'D',l_block_type,
																		l_debug_info_ptr ))
						{
							APL_GOBACK_FAIL
						}
						if (p_dl_deal_sstdet_struct_h_a->h_rec_int_000)
						{
							if (APL_FAILURE == DL_Mod_Posn(	p_dl_deal_sstdet_struct_h_a->h_dl_client,
																			p_instr_code,
																			p_location,
																			"000",
																			'S',
																			p_dealcd[0],
																			&p_dl_deal_sstdet_struct_h_a->h_rec_int_000,
																			'I',l_block_type,
																			l_debug_info_ptr ))
							{
								APL_GOBACK_FAIL
							}
						}
					}
				}
				else 
				{
					if (p_chk_or_upd == 'C')
					{
						if (APL_FAILURE == DL_Proc_PosCalc(	p_dl_deal_sstdet_struct_h_a->h_dl_client,
																		p_instr_code,
																		p_location,
																		p_old_status,
																		APL_NULL_STRING,
																		"SFK",
																		&l_quantity,l_block_type,
																		l_debug_info_ptr ))
						{
							APL_GOBACK_FAIL
						}
						if (l_quantity < p_quantity)
						{
							*p_success_flg = APL_FAILURE;
							APL_GOBACK_SUCCESS
						}
					}
					if (p_chk_or_upd == 'U')
					{
						if (APL_FAILURE == DL_Mod_Posn(	p_dl_deal_sstdet_struct_h_a->h_dl_client,
																		p_instr_code,
																		p_location,
																		p_old_status,
																		'S',
																		p_dealcd[0],
																		&p_quantity,
																		'D',l_block_type,
																		l_debug_info_ptr ))
						{
							APL_GOBACK_FAIL
						}
						if (p_dl_deal_sstdet_struct_h_a->h_rec_int_000)
						{
							if (APL_FAILURE == DL_Mod_Posn(	p_dl_deal_sstdet_struct_h_a->h_dl_client,
																			p_instr_code,
																			p_location,
																			"000",
																			'S',
																			p_dealcd[0],
																			&p_dl_deal_sstdet_struct_h_a->h_rec_int_000,
																			'I',l_block_type,
																			l_debug_info_ptr ))
							{
								APL_GOBACK_FAIL
							}
						}
						if (p_dl_deal_sstdet_struct_h_a->h_mcomplquantity + p_dl_deal_sstdet_struct_h_a->h_pendregquantity)
						{
							int_l_temp = (p_dl_deal_sstdet_struct_h_a->h_mcomplquantity + p_dl_deal_sstdet_struct_h_a->h_pendregquantity);
							if (APL_FAILURE == DL_Mod_Posn(	p_dl_deal_sstdet_struct_h_a->h_dl_client,
																			p_instr_code,
																			p_location,
																			"001",
																			'S',
																			p_dealcd[0],
																			&int_l_temp,
																			'I',l_block_type,
																			l_debug_info_ptr ))
							{
								APL_GOBACK_FAIL
							}
						}
					}
				}
			}
		}
		else  
		{
			if (p_chk_or_upd == 'C')
			{
				if (APL_FAILURE == DL_Proc_PosCalc(	p_dl_deal_sstdet_struct_h_a->h_dl_client,
																p_instr_code,
																p_location,
																p_status_ind,
																APL_NULL_STRING,
																"CD",
																&l_quantity,l_block_type,
																l_debug_info_ptr ))
				{
					APL_GOBACK_FAIL
				}
				if (l_quantity < p_quantity)
				{
					*p_success_flg = APL_FAILURE;
					APL_GOBACK_SUCCESS
				}
				if (APL_FAILURE == DL_Proc_PosCalc(	p_dl_deal_sstdet_struct_h_a->h_dl_client,
																p_instr_code,
																p_location,
																"000",
																APL_NULL_STRING,
																"SFK",
																&l_quantity,l_block_type,
																l_debug_info_ptr ))
				{
					APL_GOBACK_FAIL
				}
				if (l_quantity < p_dl_deal_sstdet_struct_h_a->h_delta_000)
				{
					*p_success_flg = APL_FAILURE;
					APL_GOBACK_SUCCESS
				}
				if (APL_FAILURE == DL_Proc_PosCalc(	p_dl_deal_sstdet_struct_h_a->h_dl_client,
																p_instr_code,
																p_location,
																"001",
																APL_NULL_STRING,
																"SFK",
																&l_quantity,l_block_type,
																l_debug_info_ptr ))
				{
					APL_GOBACK_FAIL
				}
				if (l_quantity < p_dl_deal_sstdet_struct_h_a->h_delta_001)
				{
					*p_success_flg = APL_FAILURE;
					APL_GOBACK_SUCCESS
				}
				if (APL_FAILURE == DL_Proc_PosCalc(	p_dl_deal_sstdet_struct_h_a->h_dl_client,
																p_instr_code,
																p_location,
																"003",
																APL_NULL_STRING,
																"SFK",
																&l_quantity,l_block_type,
																l_debug_info_ptr ))
				{
					APL_GOBACK_FAIL
				}
				if (l_quantity < p_dl_deal_sstdet_struct_h_a->h_delta_002)
				{
					*p_success_flg = APL_FAILURE;
					APL_GOBACK_SUCCESS
				}
			}
			if (p_chk_or_upd == 'U')
			{
				if (APL_FAILURE == DL_Mod_Posn(	p_dl_deal_sstdet_struct_h_a->h_dl_client,
																p_instr_code,
																p_location,
																p_status_ind,
																'C',
																p_dealcd[0],
																&p_quantity,
																'D',l_block_type,
																l_debug_info_ptr ))
				{
					APL_GOBACK_FAIL
				}
				if (p_dl_deal_sstdet_struct_h_a->h_delta_000)
				{
					if (APL_FAILURE == DL_Mod_Posn(	p_dl_deal_sstdet_struct_h_a->h_dl_client,
																	p_instr_code,
																	p_location,
																	"000",
																	'S',
																	p_dealcd[0],
																	&p_dl_deal_sstdet_struct_h_a->h_delta_000,
																	'D',l_block_type,
																	l_debug_info_ptr ))
					{
						APL_GOBACK_FAIL
					}
				}	
				if (p_dl_deal_sstdet_struct_h_a->h_delta_001)
				{
					if (APL_FAILURE == DL_Mod_Posn(	p_dl_deal_sstdet_struct_h_a->h_dl_client,
																	p_instr_code,
																	p_location,
																	"001",
																	'S',
																	p_dealcd[0],
																	&p_dl_deal_sstdet_struct_h_a->h_delta_001,
																	'D',l_block_type,
																	l_debug_info_ptr ))
					{
						APL_GOBACK_FAIL
					}
				}	
				if (p_dl_deal_sstdet_struct_h_a->h_delta_002)
				{
					if (APL_FAILURE == DL_Mod_Posn(	p_dl_deal_sstdet_struct_h_a->h_dl_client,
																	p_instr_code,
																	p_location,
																	"003",
																	'S',
																	p_dealcd[0],
																	&p_dl_deal_sstdet_struct_h_a->h_delta_002,
																	'D',l_block_type,
																	l_debug_info_ptr ))
					{
						APL_GOBACK_FAIL
					}
				}
			}
		}
	}
	else  
	{
		if (VAL_RECDEAL(p_dealcd[0]) || p_dealcd[0]=='6' || p_dealcd[0]=='8')
		{
			if (p_chk_or_upd == 'C')
			{
				if (int_l_move_from_dp_to_settled == 1)
				{
					if (APL_FAILURE == DL_Proc_PosCalc(	p_dl_deal_sstdet_struct_h_a->h_dl_client,
																	p_instr_code,
																	p_location,
																	APL_NULL_STRING,
																	APL_NULL_STRING,
																	"DPR",
																	&l_quantity,l_block_type,
																	l_debug_info_ptr ))
					{
						APL_GOBACK_FAIL
					}
				}
				else
				{
					if (APL_FAILURE == DL_Proc_PosCalc(	p_dl_deal_sstdet_struct_h_a->h_dl_client,
																	p_instr_code,
																	p_location,
																	APL_NULL_STRING,
																	APL_NULL_STRING,
																	"CR",
																	&l_quantity,l_block_type,
																	l_debug_info_ptr ))
					{
						APL_GOBACK_FAIL
					}
				}
				if (l_quantity < p_quantity)
				{
					*p_success_flg = APL_FAILURE;
					APL_GOBACK_SUCCESS
				}
			}
			if (p_chk_or_upd == 'U')
			{
				if (int_l_move_from_dp_to_settled == 1)
				{
					if (APL_FAILURE == DL_Mod_Posn(	p_dl_deal_sstdet_struct_h_a->h_dl_client,
																	p_instr_code,
																	p_location,
																	APL_NULL_STRING,
																	'D',
																	p_dealcd[0],
																	&p_quantity,
																	'D',l_block_type,
																	l_debug_info_ptr ))
					{
						APL_GOBACK_FAIL
					}
				}
				else
				{
					if (APL_FAILURE == DL_Mod_Posn(	p_dl_deal_sstdet_struct_h_a->h_dl_client,
																	p_instr_code,
																	p_location,
																	APL_NULL_STRING,
																	'C',
																	p_dealcd[0],
																	&p_quantity,
																	'D',l_block_type,
																	l_debug_info_ptr ))
					{
						APL_GOBACK_FAIL
					}
				}
				if (APL_FAILURE == DL_Mod_Posn(	p_dl_deal_sstdet_struct_h_a->h_dl_client,
																p_instr_code,
																p_location,
																APL_NULL_STRING,
																'S',
																p_dealcd[0],
																&p_quantity,
																'I',l_block_type,
																l_debug_info_ptr ))
				{
					APL_GOBACK_FAIL
				}
			}
		}
		else 
		{
			if (p_chk_or_upd == 'C')
			{
				if (int_l_move_from_dp_to_settled == 1)
				{		
					if (APL_FAILURE == DL_Proc_PosCalc(	p_dl_deal_sstdet_struct_h_a->h_dl_client,
																	p_instr_code,
																	p_location,
																	APL_NULL_STRING,
																	APL_NULL_STRING,
																	"DPD",
																	&l_quantity,l_block_type,
																	l_debug_info_ptr ))
					{
						APL_GOBACK_FAIL
					}
				}
				else
				{
					if (APL_FAILURE == DL_Proc_PosCalc(	p_dl_deal_sstdet_struct_h_a->h_dl_client,
																	p_instr_code,
																	p_location,
																	APL_NULL_STRING,
																	APL_NULL_STRING,
																	"CD",
																	&l_quantity,l_block_type,
																	l_debug_info_ptr ))
					{
						APL_GOBACK_FAIL
					}
				}
				if (l_quantity < p_quantity)
				{
					*p_success_flg = APL_FAILURE;
					APL_GOBACK_SUCCESS
				}
				if (APL_FAILURE == DL_Proc_PosCalc(	p_dl_deal_sstdet_struct_h_a->h_dl_client,
																p_instr_code,
																p_location,
																APL_NULL_STRING,
																APL_NULL_STRING,
																"SFK",
																&l_quantity,l_block_type,
																l_debug_info_ptr ))
				{	
					APL_GOBACK_FAIL
				}
				if (l_quantity < p_quantity)
				{
					*p_success_flg = APL_FAILURE;
					APL_GOBACK_SUCCESS
				}
			}
			if (p_chk_or_upd == 'U')
			{
				if (int_l_move_from_dp_to_settled == 1)
				{
					if (APL_FAILURE == DL_Mod_Posn(	p_dl_deal_sstdet_struct_h_a->h_dl_client,
																	p_instr_code,
																	p_location,
																	APL_NULL_STRING,
																	'D',
																	p_dealcd[0],
																	&p_quantity,
																	'D',l_block_type,
																	l_debug_info_ptr ))
					{
						APL_GOBACK_FAIL
					}
				}
				else
				{
					if (APL_FAILURE == DL_Mod_Posn(	p_dl_deal_sstdet_struct_h_a->h_dl_client,
																	p_instr_code,
																	p_location,
																	APL_NULL_STRING,
																	'C',
																	p_dealcd[0],
																	&p_quantity,
																	'D',l_block_type,
																	l_debug_info_ptr ))
					{
						APL_GOBACK_FAIL
					}
				}
				if (APL_FAILURE == DL_Mod_Posn(	p_dl_deal_sstdet_struct_h_a->h_dl_client,
																p_instr_code,
																p_location,
																APL_NULL_STRING,
																'S',
																p_dealcd[0],
																&p_quantity,
																'D',l_block_type,
																l_debug_info_ptr ))
				{	
					APL_GOBACK_FAIL
				}
			}	
		}
	}

	*p_success_flg = APL_SUCCESS;

	APL_GOBACK_SUCCESS
	
	RETURN_SUCCESS :
		APL_IF_DEBUG
			CO_ProcMonitor(APL_OUT_FILE, "Leaving processtion DL_Proc_PosChkMod successfully", NULL, NULL);
		return(APL_SUCCESS);
	RETURN_FAILURE :
		APL_IF_DEBUG
			CO_ProcMonitor(APL_OUT_FILE, "Leaving processtion DL_Proc_PosChkMod with errors", NULL, NULL);
		return(APL_FAILURE);

}
	
/** Added By Vijay For SLB entry into DL_DEAL_REV For HB_03_001 **/

int DL_SLBREVINP(DL_DEAL_SSTDET_STRUCT_H *p_dl_deal_sstdet_struct_h_a,
                 INTL_ENV_DATA_STRUCT_H *p_intl_envdatastruct_h,
                 DEBUG_INFO_STRUCT_H **l_debug_info_ptr)
{
	int l_rev_date            = 0;
	short i_rev_date          = 0;

	CO_ProcMonitor(APL_OUT_FILE,"Inside DL_SLBREVINP Function \n",NULL,NULL);
	printf("Inside DL_SLBREVINP Function \n");

	EXEC SQL SELECT TO_NUMBER(FIELD_VAL)
           INTO :l_rev_date:i_rev_date
           FROM PRO_GSSPLVAL
           WHERE MAIN_FUN = 'SLB_REV'
             AND SUB_PROCESS = 'SLB_REV_DAY'
             AND NATION = 'XX';

	IS_ANY_ORA_ERROR

	printf("Reversal day after Deal Date---|%d|\n",l_rev_date);

	//Modified by Sandip for ISKB_12422
	EXEC SQL INSERT INTO DL_DEAL_REV
           (SELECT CLIENT,IDENTIY_NO,DEAL_DATE,SETL_DATE,COST,EX_ARENA,AMOUNT,CUSTODYCOMM,BROKERCOMM,STX_COMM,OTH_COMM,INSTRUMENT_DT,MONEY_SETL_DT,QTY,DOMESTIC_CPCLT,SPOTTRD_IND,ORIG_QTY,ORIG_AMOUNT,DEAL_FRM_ORD,ENTRY,REAPIRED_IND,DOMCP_CUSTODYCLT,CP_CLT,CP_CLTNAME,CLIENTOF,CLIENT_NOTE,FX_REQD,PAYLOC_IND,VERFIED_WITH,AMT_DIFFER,BRK_NO,FAILREASON_CD,FAIL_DET,PARTIAL_IND_B,FX_RT,AMEND_COUNT,NUMBER_A,REPORT_AT_EOM_IND,DATEOFBILLING,LCL_IDENTNO,INSTRUCT_PERSON,REC_INT_000,DEAL_CD,INSTR_CODE,CURRENCY_CD,DL_CLASS,ORIG_REFNO,DATEOF_INPUT,MAKER,MAKER_DT,DEAL_STAT,ACCESS_STAMP,INFO1,LOCATION_CD,REGINSTR_IND,STATUS_POS,STATUS,VAL_FDT,COMPREFNO,DATEOF_MARKFAIL,ALLOW_DROPDT,CHECKER,CHECKER_DT,INSTRCONV_IND,NDS_BLK_DT,LR_DL_CLASS,NDS_DATE,UNBLK_DATE,DELTA_000,DELTA_001,DELTA_003,DEL_REC_DATE,LAST_REG_DATE,LR_CHECK_DATE,LR_VALDATE,LRINSTR_DATE,REG_MSG_QTY,TMP_OUT_DT,TMP_OUT_DATE,TRANS_DATE,TOT_QTY,QTY_LOST,MRK_DL_FAILQTY,DL_COMPLETEQTY,OUT_REG_QTY,PEND_REG_QTY,RET_REG_QTY,STAMP_QTY,TEMP_OUT_QUANTITY,TEMP_RET_QUANTITY,VAL_DEED_QTY,HOST_DATE,LRNDS_BILLDT,LRNDS_DATE,LR_UNBLK_DATE,NUMBER_B,CLT_REQDEL_IND,MOD_HISPOS_IND,MOD_HISPOS_DATE,GL_CLIENT,CP_AMT,MSG_STAT,SUB_FAIL_CD,PARTIAL_IND_A,LOC_CHNG_IND,COMM_IDENT_NO,INSTRUCT_PERSONNM,CLIENTOF_CD,INTER_MED_PERSON,INTER_MED_PERSONNM,FXCCY,UNIQ_IDENT_NO,CNT_548,EXP_SETLDATE,RELATED_IDENT_NO,INFORMATON,SETTLEMENT_NO,MKT_TYPE,CLH_FLG,INTEREST,NET_AMT,PAYIN_DT,PAYOUT_DT,DEMAT_QTY,CONTRACT_REQ,EXCUM_FLG,CRN_NO,INTERFII_FLG,PAY_MODE,DL_SECSTATUS,DL_MNYSTATUS,AVAIL_QTY,ALLOT_QTY,SHORTAGE_QTY,CLN_DEPOACC,PLTOPL_FLG,ORIG_STATUS,MAP_FAILCODE,MATCH_FAILCODE,IS_MATCHED,EXCH_CODE,CONTRACT_CD,R_DELAY,SEBI_REPORTED,R_SETT_CODE,R_TRANS_CODE,R_TYPE,REPO_DATE,COMM_AMT,MF_SEQNO
			,GET_NXT_EXCH_BUSSDATE(DL_DEAL.DEAL_DATE,:l_rev_date),TRD_EXCH,TRD_SETL_NO,TRD_MKT_TYPE,STAMP_DUTY
            FROM DL_DEAL
            WHERE DL_DEAL.CLIENT = :p_dl_deal_sstdet_struct_h_a->h_dl_client
            AND DL_DEAL.IDENTIY_NO = :p_dl_deal_sstdet_struct_h_a->h_indentity_no);

	printf("*** SQLCA.SQLCODE After Insert Into DL_DEAL_REV --|%d|\n",sqlca.sqlcode);

	IS_ANY_ORA_ERROR_AND_DUPLICATE(  ERR_DEAL_EXIST,
                                          p_dl_deal_sstdet_struct_h_a->h_dl_client,
                                          p_dl_deal_sstdet_struct_h_a->h_indentity_no,
                                          APL_NULL_STRING );
	/* IS_ANY_ORA_ERROR */

        APL_GOBACK_SUCCESS//AIX Warning Removal
	RETURN_SUCCESS :
		APL_IF_DEBUG
			CO_ProcMonitor(APL_OUT_FILE, "Leaving Function DL_SLBREVINP successfully", NULL, NULL);
		return(APL_SUCCESS);
	RETURN_FAILURE :
		APL_IF_DEBUG
			CO_ProcMonitor(APL_OUT_FILE, "Leaving Function DL_SLBREVINP with errors", NULL, NULL);
		return(APL_FAILURE);
}
/*******************************************************************/
