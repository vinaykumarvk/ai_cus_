

              
   
   
   
   
   
   
   
   
   
   
   
   




#include <CO_HostStructdef.h>

#define FILEPATH_LEN				70
#define FILENAME_LEN_A				80
#define PAGE_HDR_LENGTH		10
#define REPORT_PAGE_LEN			80
#define QUANTITY_LEN					25	
#define AMOUNT_LEN_A				65	

#define	HANDOFF_NORMAL	"N"
#define	HANDOFF_TRUE	"T"
#define	HANDOFF_BOTH	"B"
#define	SEC_CD_LEN_D		9


#define	TYPEOF_DEAL_CORP_1	"18"
#define	TYPEOF_DEAL_CORP_2	"19"
#define	TYPEOF_DEAL_CORP		"C"
#define	NORMAL_DEAL			"N"


EXEC SQL INCLUDE sqlca;

//main(int argc,char **argv)
int main(int argc,char **argv)//Changes done for AIX Migration
{
	DEBUG_INFO_STRUCT_H			*l_debug_info_ptr = NULL;
	FILE						*l_ptr_ini_file = NULL;
	FILE						*l_ptr_log_file = NULL;
	INTL_ENV_DATA_STRUCT_H	l_intl_envdatastruct_h;
	char						chr_l_inifile[FILENAME_LEN_A]   = APL_NULL_STRING;
	char						chr_uname[APL_USERID_LEN]   = APL_NULL_STRING;
	char						chr_passwd[APL_PASSWD_LEN]  = APL_NULL_STRING;
	char						chr_custody_id_b[APL_USERID_LEN]  = APL_NULL_STRING;
	int						int_l_flg = 0;
	int						int_retval = 0;
	char						chr_l_buf[BUFFER_LEN] = APL_NULL_STRING;
	struct sqlca			sqlca;
	char						chr_l_cntry_code[3];
	int						int_num = 0;
	char						**temp = NULL;
	char					 	chr_l_auth_conf[2]	=APL_NULL_STRING;

	memset(&l_intl_envdatastruct_h,NULL,sizeof(INTL_ENV_DATA_STRUCT_H));
	
	

	strcpy(l_intl_envdatastruct_h.usr, argv[3]);
	strcpy(l_intl_envdatastruct_h.h_mode, argv[4]);
	strcpy(l_intl_envdatastruct_h.processtion, argv[5]);
	strcpy(l_intl_envdatastruct_h.auth_req, argv[6]);
	strcpy(l_intl_envdatastruct_h.subprocess, argv[7]);
	strcpy(l_intl_envdatastruct_h.h_process, argv[8]);
	
	strcpy(chr_l_inifile,getenv("INTL_ROOT_PATH"));
	strcat(chr_l_inifile,"intl_sun.cfg");

	if ((l_ptr_ini_file = fopen(chr_l_inifile,"r")) == NULL)
		exit(-1);
	
	APL_FETCH_DB_LOGIN_DETAILS(l_ptr_ini_file,chr_custody_id_b,chr_uname,chr_passwd,APL_OUT_FILE,&l_debug_info_ptr)
	
	
	
	if (CO_DB_Connection_O(chr_uname,chr_passwd,&l_debug_info_ptr) != APL_SUCCESS)
		APL_GOBACK_FAIL

	

	int_retval = CO_Rtv_RptFileName("3G",APL_LOGFILE_DESC,100,argv[5],argv,&l_ptr_log_file,&l_debug_info_ptr);

	if (int_retval != APL_SUCCESS)
	{
		EXEC SQL ROLLBACK WORK RELEASE;
		APL_GOBACK_FAIL
	}

	

	EXEC SQL COMMIT WORK;
	
	if (sqlca.sqlcode != 0)
	{
		CO_Proc_RptClose(l_ptr_log_file,&l_debug_info_ptr);

		EXEC SQL ROLLBACK WORK RELEASE;
		APL_GOBACK_FAIL
	}
	
	

	 if (CO_SplitStr(argv[9],'|',&int_num,&temp) != APL_SUCCESS)
	 {
		CO_Proc_RptClose(l_ptr_log_file,&l_debug_info_ptr);
		
		EXEC SQL ROLLBACK WORK RELEASE;
		APL_GOBACK_FAIL	
	 }	

   

                      
	
   if ( CO_RtvSysParams(&l_debug_info_ptr) == APL_FAILURE)         
						APL_GOBACK_FAIL									 

	strcpy(chr_l_cntry_code,g_mt_commonsys_params_struct_h.nation_code);           
   printf("l_cntry_code is %s\n",chr_l_cntry_code);                 

	
	if(int_num > 5)
		strcpy(chr_l_auth_conf,temp[5]); 

	memset(chr_l_buf,APL_NULL_CHAR,BUFFER_LEN);
	sprintf(chr_l_buf,"Clearing House - %s",chr_l_cntry_code);
	CO_ProcMonitor(l_ptr_log_file,chr_l_buf,NULL,NULL);

	CO_ProcMonitor(l_ptr_log_file,"______________________\n",NULL,NULL);
	CO_ProcMonitor(l_ptr_log_file,"** Rahul **  Work Committed after chr_logfile creation  - \n",NULL,&l_intl_envdatastruct_h);

	
	if (CO_RtvSysParams(&l_debug_info_ptr) != APL_SUCCESS)
	{
		CO_ProcMonitor(l_ptr_log_file,"Unable to get system parameters - Rollback done \n",NULL,&l_intl_envdatastruct_h);
		
		CO_Proc_RptClose(l_ptr_log_file,&l_debug_info_ptr);
		
		EXEC SQL ROLLBACK WORK RELEASE;
		
		APL_GOBACK_FAIL	
	}

	
	 
	int_retval = LockRecFn1(argv,l_ptr_log_file,&l_debug_info_ptr);

	if (int_retval != APL_SUCCESS)
	{
		CO_ProcMonitor(l_ptr_log_file,"Unable to lock BATCH_IN_PROC record - Rollback done \n",NULL,&l_intl_envdatastruct_h);
		
		CO_Proc_RptClose(l_ptr_log_file,&l_debug_info_ptr);

		EXEC SQL ROLLBACK WORK RELEASE;
		
		APL_GOBACK_FAIL
	}

	

	if (strcmp(chr_l_cntry_code, "PL") == 0)               
	{
		int_retval = DL_Proc_ClrHs_po(argv,l_ptr_log_file,&l_intl_envdatastruct_h,&l_debug_info_ptr);
	}
	else if (strcmp(chr_l_cntry_code, "CZ") == 0)
		int_retval = DL_Proc_ClrHs_cz(argv,l_ptr_log_file,&l_intl_envdatastruct_h,&l_debug_info_ptr);
	else if (strcmp(chr_l_cntry_code, "HU") == 0)
		int_retval = DL_Proc_ClrHs_hu(argv,l_ptr_log_file,&l_intl_envdatastruct_h,&l_debug_info_ptr);
	else if (strcmp(chr_l_cntry_code, "TR") == 0)
		{
			if(strcmp(chr_l_auth_conf,"C")==0)
				int_retval = DL_Clh_DlFn(argv,l_ptr_log_file,&l_intl_envdatastruct_h,&l_debug_info_ptr);
			else 
				int_retval = PendTxnFn(argv,l_ptr_log_file,&l_intl_envdatastruct_h,&l_debug_info_ptr);
		 }

	if (int_retval != APL_SUCCESS)
	{
		int_l_flg = 1;

	   DoFinalProcessingFn1(argv,l_ptr_log_file,&l_debug_info_ptr,int_l_flg);
		
		if (CO_ChkErr(l_debug_info_ptr) == APL_SUCCESS)
		{
			
			CO_ProcMonitor(l_ptr_log_file,APL_NULL_STRING,&l_debug_info_ptr,&l_intl_envdatastruct_h);
			CO_FreeErrLst(&l_debug_info_ptr);

		}

		CO_ProcMonitor(l_ptr_log_file,"FAILURE from Clearing House hand-off h_file generation program \n",NULL,&l_intl_envdatastruct_h);

		
		CO_Proc_RptClose(l_ptr_log_file,&l_debug_info_ptr);

		APL_GOBACK_FAIL	
	}
	else
	{
		int_l_flg = 0;

		DoFinalProcessingFn1(argv,l_ptr_log_file,&l_debug_info_ptr,int_l_flg);

		if (CO_ChkErr(l_debug_info_ptr) == APL_SUCCESS)
		{
			
			CO_ProcMonitor(l_ptr_log_file,APL_NULL_STRING,&l_debug_info_ptr,&l_intl_envdatastruct_h);
			CO_FreeErrLst(&l_debug_info_ptr);

		}

		CO_ProcMonitor(l_ptr_log_file,"SUCCESS from Clearing House hand-off h_file generation program \n",NULL,&l_intl_envdatastruct_h);

		
		CO_Proc_RptClose(l_ptr_log_file,&l_debug_info_ptr);

		APL_GOBACK_SUCCESS
	}

	RETURN_SUCCESS	: 
	{
		fclose(l_ptr_ini_file);
	   return(0);
	}

	RETURN_FAILURE	: 
	{
		fclose(l_ptr_ini_file);
  		return(-1);	
	}
}




int DL_Clh_DlFn(char **argv,FILE *p_ptr_log_file,INTL_ENV_DATA_STRUCT_H *p_intl_env_data_struct_h_d,DEBUG_INFO_STRUCT_H **l_debug_info_ptr)
{
	struct sqlca 		  		sqlca;
	FILE							*l_ptr_ini_file = NULL;
	FILE							*l_ptr_rc_handoff_file = NULL;
	FILE							*l_ptr_dc_handoff_file = NULL;
	FILE							*l_ptr_cri_dc_handoff_file = NULL;
	FILE							*l_ptr_broker_handoff_file = NULL;
	FILE							*l_ptr_cri_broker_handoff_file = NULL;
	char							chr_l_inifile[FILENAME_LEN_A] = APL_NULL_STRING;
	char							chr_l_handoff_dir[FILEPATH_LEN] = APL_NULL_STRING;
	char							chr_l_rc_handoff_file_name[FILENAME_LEN_A] = APL_NULL_STRING;
	char							chr_l_dc_handoff_file_name[FILENAME_LEN_A] = APL_NULL_STRING;
	char							chr_l_cri_dc_handoff_file_name[FILENAME_LEN_A] = APL_NULL_STRING;
	char            			chr_l_ca_handoff_file_name[FILENAME_LEN_A] = APL_NULL_STRING;     

	char							chr_l_broker_handoff_file_name[FILENAME_LEN_A] = APL_NULL_STRING;
	char							chr_l_cri_broker_handoff_file_name[FILENAME_LEN_A] = APL_NULL_STRING;
   char                    chr_l_clh_account[16];
   short                   i_clh_account = 0;
   char                    chr_l_isin[13];
   short 						i_instr_isin = 0;
	SYS_DL_DEAL_STRUCT_H		l_sys_dl_deal_struct_hb;
	SYS_DL_DEAL_STRUCT_I		l_sys_dl_deal_struct_il;
   DL_CLHCRI_STRUCT_H			l_dl_clhcri_struct_h;
   DL_CLHCRI_STRUCT_I        l_dl_clhcri_struct_i;
	int							int_retval;
   int                     int_acri_seq_num = 0;
   int                     int_bcri_seq_num = 0;
	char							chr_l_entrytype[2];
	char							chr_l_typeoftrd[3];
	char							chr_l_typeoftrd1[3];
	char							chr_l_trcode_a[2];
	char							chr_l_date[7];
	char							chr_l_date1[7];
	char							chr_l_conf_dt[APL_DATE_LEN];
	char							chr_l_mstacc_a[11];
	short							i_mstclt;
	char							chr_l_cnt_mstacc[11];
	short							i_cnt_mstacc;
	char							chr_l_clscode_a[5];
	short							i_classcd;
	char							chr_l_acc_code[11];
	short							i_acc_code;
	char							chr_l_acc_cl_code[16];
	short							i_acc_cl_code;
	char							chr_l_newissue[3]; 
	short							i_new_issue;
	char							chr_l_mothinstrflg[2];
	short							i_mother_sec_ind;
	char							chr_l_notmotherflg[2];
	char							chr_l_cubk[2];
	short							i_clt_brk_all;
	char							dbl_l_amount_a[66];
	char							int_l_domcpac[11];
	DL_CLHTR_STRUCT_H			l_dl_clhtr_struct_h;
	DL_CLHTR_STRUCT_I			l_dl_clhtr_struct_i;
	char							chr_l_instr_parent[9];
	short							i_instr_parent;
	char							chr_l_clhtr_account[11];
	char							chr_l_clhtr_countacc[APL_COUNTACC_LEN]; 
	char							chr_l_clhtr_instrcode[9];
	char							chr_l_clhtr_recdel[2];
	double						l_clhtr_quantity;
	double						dbl_l_clhtr_amount;
	char							chr_l_sys_date[APL_DATE_LEN];
   char							chr_l_acri_sys_date[11];
   char							chr_l_acri_set_date[11];
   char							chr_l_bcri_sys_date[11];
   char							chr_l_bcri_set_date[11];
   char							chr_l_day[3];
   char							chr_l_month[3];
   char							chr_l_year[5];
	short							i_sys_date = 0;
	char							chr_l_ca_id[21];
	short							i_corp_id;
	char							chr_l_ce_typ[3];
	short							i_ca_event;
	char							chr_l_instrcode_a[9];
	int							int_l_no_lines_printed;
	int							int_l_page_no;
	FILE							*l_clh_error_TR_rpt_file = NULL;
	int							i,int_l_diff;
	char							chr_l_gen_handoff_file_flg[2];
	char							chr_l_incl_amt_flg[2];
	int							int_num = 0;
	char							**temp = NULL;
	int							int_l_err_cond = 0;
	INTL_REPT_STRUCT_H				*l_intl_rept_struct_ha	=NULL;
	short							l_truedvpflag	=	0;	
	char							chr_l_typeoffile[APL_FLAG_LENGTH]	=	APL_NULL_STRING;	
	FILE							*l_ptr_hrc_handoff_file		=	NULL;	
	FILE                    *l_ptr_ca_handoff_file  = NULL;       
	FILE							*l_ptr_hbrokers_handoff_file	=	NULL;	
	char							chr_l_hrc_handoff_file_name[FILENAME_LEN_A] = APL_NULL_STRING;
	char							chr_l_hbrokers_handoff_file_name[FILENAME_LEN_A] 	= APL_NULL_STRING;	
	char							chr_l_acctruedvp[APL_FLAG_LENGTH]						= APL_NULL_STRING;
	short							i_acctruedvp										=	0	;	
	char		chr_l_trlamount[23]	=	APL_NULL_STRING;	
	double	l_exchgrt_a			=	0.0;
	double	l_dbltrlamount		=	0.0;
	char		chr_l_cntac_acntof[APL_COUNTACC_LEN]	=	APL_NULL_STRING;	

   FILE                    *l_broker_RVP_rpt_file = NULL;
   FILE                    *l_broker_DVP_rpt_file = NULL;
   FILE                    *l_broker_DF_rpt_file = NULL;
   FILE                    *l_broker_RF_rpt_file = NULL;

   int                     int_l_lines_rpted_df;
   int                     int_l_lines_rpted_rf;
   int                     int_l_lines_rpted_dvp;
   int                     int_l_lines_rpted_rvp;
   int                     int_l_page_no_df = 0;
   int                     int_l_page_no_rf = 0;
   int                     int_l_page_no_rvp = 0;
   int                     int_l_page_no_dvp = 0;
	int          				int_period_flg = 0;                             	
	int 							int_l_type_flg = 0;
   char          l_quantity[QUANTITY_LEN+1] = APL_NULL_STRING;
   char          chr_l_qty1[5] = APL_NULL_STRING;
   int int_pos = 0;
   int int_l_start = 0;
   char chr_l_rep_qty[19] = APL_NULL_STRING;
   char chr_l_rep_seq[11] = APL_NULL_STRING;

	

	EXEC SQL VAR l_sys_dl_deal_struct_hb.h_instr_code IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hb.h_dl_client IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hb.h_indentity_no IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hb.h_domcpclt_cd IS STRING;

	EXEC SQL VAR l_sys_dl_deal_struct_hb.h_classofdl IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hb.h_dealcd IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hb.h_clientof IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hb.h_countclt IS STRING;
	EXEC SQL VAR l_sys_dl_deal_struct_hb.h_clientofcode IS STRING; 
	EXEC SQL VAR chr_l_cntac_acntof IS STRING;

	EXEC SQL VAR l_dl_clhtr_struct_h.h_instr_code IS STRING;
	EXEC SQL VAR l_dl_clhtr_struct_h.h_dl_client IS STRING;
	EXEC SQL VAR l_dl_clhtr_struct_h.h_countclt IS STRING;

	EXEC SQL VAR chr_l_clh_account IS STRING;
	EXEC SQL VAR chr_l_isin IS STRING;

	EXEC SQL VAR chr_l_acc_code IS STRING;
	EXEC SQL VAR chr_l_mothinstrflg IS STRING;
	EXEC SQL VAR chr_l_instr_parent IS STRING;
	EXEC SQL VAR chr_l_clscode_a IS STRING;
	EXEC SQL VAR chr_l_newissue IS STRING;
	EXEC SQL VAR chr_l_cubk IS STRING;
	EXEC SQL VAR chr_l_trcode_a IS STRING;
	EXEC SQL VAR chr_l_entrytype IS STRING;
	EXEC SQL VAR chr_l_typeoftrd IS STRING;
	EXEC SQL VAR chr_l_typeoftrd1 IS STRING;
	EXEC SQL VAR chr_l_mstacc_a IS STRING;
	EXEC SQL VAR chr_l_cnt_mstacc IS STRING;
	EXEC SQL VAR chr_l_ca_id IS STRING;
	EXEC SQL VAR chr_l_acc_cl_code IS STRING;

	
	EXEC SQL VAR chr_l_acctruedvp	IS STRING;
	EXEC SQL VAR chr_l_instrcode_a		IS STRING;	
	
	
	CO_ProcMonitor(p_ptr_log_file,"Entered processtion DL_Clh_DlFn \n",NULL,p_intl_env_data_struct_h_d);

	memset(chr_l_inifile,NULL,sizeof(chr_l_inifile));
	memset(chr_l_handoff_dir,NULL,sizeof(chr_l_handoff_dir));
	memset(chr_l_dc_handoff_file_name,NULL,sizeof(chr_l_dc_handoff_file_name));
	memset(chr_l_cri_dc_handoff_file_name,NULL,sizeof(chr_l_cri_dc_handoff_file_name));
	memset(chr_l_broker_handoff_file_name,NULL,sizeof(chr_l_broker_handoff_file_name));
	memset(chr_l_cri_broker_handoff_file_name,NULL,sizeof(chr_l_cri_broker_handoff_file_name));
   memset(chr_l_acri_sys_date,APL_NULL_CHAR,10);
   memset(chr_l_acri_set_date,APL_NULL_CHAR,10);
	memset(chr_l_ca_handoff_file_name,NULL,sizeof(chr_l_ca_handoff_file_name));     

	memset(chr_l_trlamount, APL_NULL_CHAR, sizeof(chr_l_trlamount));

	l_intl_rept_struct_ha	= (INTL_REPT_STRUCT_H *)calloc(1, sizeof(INTL_REPT_STRUCT_H));	
	APL_MALLOC_FAIL(l_intl_rept_struct_ha);

	
	if (APL_FAILURE == CO_RtvSysParams(l_debug_info_ptr))
   {
   	CO_ProcMonitor(p_ptr_log_file, "Error In Getting System Parameters", NULL, NULL);
      APL_GOBACK_FAIL
   }

	if (CO_SplitStr(argv[9],'|',&int_num,&temp) != APL_SUCCESS)
		return(APL_FAILURE);

	strcpy(chr_l_conf_dt,temp[1]);
	strcpy(chr_l_gen_handoff_file_flg,temp[2]);
	strcpy(chr_l_incl_amt_flg,temp[3]);
	if(APL_FAILURE == CO_Chk_CntryEnabled("ACC_MAINT", "TRUE_DVP_FLAG", &l_truedvpflag, l_debug_info_ptr))	
		APL_GOBACK_FAIL

		
	if(int_num > 4)
		strcpy(chr_l_typeoffile, temp[4]);

	if (strlen(chr_l_conf_dt) == 0)
		APL_DATA_MISSING("CONF DT",APL_NULL_STRING,APL_NULL_STRING)

	if (strlen(chr_l_gen_handoff_file_flg) == 0)
		APL_DATA_MISSING("GEN HANDOFF FILE FLG",APL_NULL_STRING,APL_NULL_STRING)
	if (strlen(chr_l_incl_amt_flg) == 0)
		APL_DATA_MISSING("INCLUDE AMOUNT FLG",APL_NULL_STRING,APL_NULL_STRING)
	if(strlen(chr_l_typeoffile) == 0)
		APL_DATA_MISSING("TYPE OF FILE", APL_NULL_STRING, APL_NULL_STRING)
	if (CO_ChkErr(*l_debug_info_ptr) == APL_SUCCESS)
		return(APL_FAILURE);
	
	if (CO_RtvSysDt(chr_l_sys_date,l_debug_info_ptr) != APL_SUCCESS)
		return(APL_FAILURE);

	if (CO_Pro_DateComp(chr_l_sys_date,chr_l_conf_dt,&int_l_diff,l_debug_info_ptr) != APL_SUCCESS)
		return(APL_FAILURE);

	if (int_l_diff > 0)
	{
		CO_InsertErr(l_debug_info_ptr,ERR_DATE_CANT_GRT_TODAY,"CONF DT",APL_NULL_STRING,APL_NULL_STRING,__LINE__,__FILE__);
		return(APL_FAILURE);
	}

	sqlca.sqlcode = 0;

	strcpy(chr_l_inifile,getenv("INTL_ROOT_PATH"));
	strcat(chr_l_inifile,"intl_sun.cfg");

	if ((l_ptr_ini_file = fopen(chr_l_inifile,"r")) == NULL)
		return(APL_FAILURE);

	

   int_l_page_no_df=1;
   int_l_page_no_rf=1;
   int_l_page_no_rvp=1;
   int_l_page_no_dvp=1;

	

	if (strcmp(chr_l_gen_handoff_file_flg,"Y") == 0)
	{
		if (CO_ReadToken(l_ptr_ini_file,"INTL_HF_PATH",chr_l_handoff_dir,l_debug_info_ptr) != APL_SUCCESS)
			return(APL_FAILURE);

		chr_l_date[0] = chr_l_conf_dt[0];
		chr_l_date[1] = chr_l_conf_dt[1];
		chr_l_date[2] = chr_l_conf_dt[3];
		chr_l_date[3] = chr_l_conf_dt[4];
		chr_l_date[4] = chr_l_conf_dt[8];
		chr_l_date[5] = chr_l_conf_dt[9];
		chr_l_date[6] = '\0';
		
		chr_l_date1[0] = chr_l_conf_dt[3];
		chr_l_date1[1] = chr_l_conf_dt[4];
		chr_l_date1[2] = chr_l_conf_dt[0];
		chr_l_date1[3] = chr_l_conf_dt[1];
		chr_l_date1[4] = chr_l_conf_dt[8];
		chr_l_date1[5] = chr_l_conf_dt[9];
		chr_l_date1[6] = '\0';

		
		
		if((0 == strcmp(chr_l_typeoffile, HANDOFF_NORMAL)) || (0 == strcmp(chr_l_typeoffile, HANDOFF_BOTH)))
		{

			strcpy(chr_l_dc_handoff_file_name,chr_l_handoff_dir);
			strcat(chr_l_dc_handoff_file_name,"Y");
			strcat(chr_l_dc_handoff_file_name,chr_l_date);
			strcat(chr_l_dc_handoff_file_name,".CIY");
		
			strcpy(chr_l_cri_dc_handoff_file_name,chr_l_handoff_dir);
			strcat(chr_l_cri_dc_handoff_file_name,"BCRI");
			strcat(chr_l_cri_dc_handoff_file_name,chr_l_date);
			strcat(chr_l_cri_dc_handoff_file_name,".CIY");

			strcpy(chr_l_broker_handoff_file_name,chr_l_handoff_dir);
			strcat(chr_l_broker_handoff_file_name,"U");
			strcat(chr_l_broker_handoff_file_name,chr_l_date);
			strcat(chr_l_broker_handoff_file_name,".CIY");


			strcpy(chr_l_cri_broker_handoff_file_name,chr_l_handoff_dir);
			strcat(chr_l_cri_broker_handoff_file_name,"ACRI");
			strcat(chr_l_cri_broker_handoff_file_name,chr_l_date);
			strcat(chr_l_cri_broker_handoff_file_name,".CIY");

                        strcpy(chr_l_ca_handoff_file_name,chr_l_handoff_dir);
                        strcat(chr_l_ca_handoff_file_name,"CA");
                        strcat(chr_l_ca_handoff_file_name,chr_l_date);
                        strcat(chr_l_ca_handoff_file_name,".CIY");

		
			if ((l_ptr_dc_handoff_file = fopen(chr_l_dc_handoff_file_name,"w")) == NULL)
				return(APL_FAILURE);
		
			memset(l_intl_rept_struct_ha,NULL,sizeof(INTL_REPT_STRUCT_H));

			  
		 	strcpy(l_intl_rept_struct_ha->report_name, chr_l_dc_handoff_file_name+strlen(chr_l_handoff_dir));
			strcpy(l_intl_rept_struct_ha->report_desc, APL_HOFF_FILE_DESC);
			strcpy(l_intl_rept_struct_ha->report_date, argv[2]);
			l_intl_rept_struct_ha->report_width = 100;
			strcpy(l_intl_rept_struct_ha->task_desc, p_intl_env_data_struct_h_d->processtion);
			strcpy(l_intl_rept_struct_ha->fe_be_ind, APL_BE_IND);
			strcpy(l_intl_rept_struct_ha->usr, p_intl_env_data_struct_h_d->usr);

			 
		 	if (APL_FAILURE == CO_Proc_DBRptIns( l_intl_rept_struct_ha, l_debug_info_ptr))
   		{
      		APL_GOBACK_FAIL
   		}
		
         
		
			if ((l_ptr_cri_dc_handoff_file = fopen(chr_l_cri_dc_handoff_file_name,"w")) == NULL)
				return(APL_FAILURE);
		
			memset(l_intl_rept_struct_ha,NULL,sizeof(INTL_REPT_STRUCT_H));

		 	strcpy(l_intl_rept_struct_ha->report_name, chr_l_cri_dc_handoff_file_name+strlen(chr_l_handoff_dir));
			strcpy(l_intl_rept_struct_ha->report_desc, APL_HOFF_FILE_DESC);
			strcpy(l_intl_rept_struct_ha->report_date, argv[2]);
			l_intl_rept_struct_ha->report_width = 100;
			strcpy(l_intl_rept_struct_ha->task_desc, p_intl_env_data_struct_h_d->processtion);
			strcpy(l_intl_rept_struct_ha->fe_be_ind, APL_BE_IND);
			strcpy(l_intl_rept_struct_ha->usr, p_intl_env_data_struct_h_d->usr);

		 	if (APL_FAILURE == CO_Proc_DBRptIns( l_intl_rept_struct_ha, l_debug_info_ptr))
   		{
      		APL_GOBACK_FAIL
   		}

         

			if ((l_ptr_broker_handoff_file = fopen(chr_l_broker_handoff_file_name,"w")) == NULL)
				return(APL_FAILURE);

			memset(l_intl_rept_struct_ha,NULL,sizeof(INTL_REPT_STRUCT_H));

			
			strcpy(l_intl_rept_struct_ha->report_name, chr_l_broker_handoff_file_name+strlen(chr_l_handoff_dir));
			strcpy(l_intl_rept_struct_ha->report_desc, APL_HOFF_FILE_DESC);
			strcpy(l_intl_rept_struct_ha->report_date, argv[2]);
			l_intl_rept_struct_ha->report_width = 100;
			strcpy(l_intl_rept_struct_ha->task_desc, p_intl_env_data_struct_h_d->processtion);
			strcpy(l_intl_rept_struct_ha->fe_be_ind, APL_BE_IND);
			strcpy(l_intl_rept_struct_ha->usr, p_intl_env_data_struct_h_d->usr);

			  
			if (APL_FAILURE == CO_Proc_DBRptIns( l_intl_rept_struct_ha, l_debug_info_ptr))
		  	{
		  		APL_GOBACK_FAIL
			}

         
			if ((l_ptr_cri_broker_handoff_file = fopen(chr_l_cri_broker_handoff_file_name,"w")) == NULL)
				return(APL_FAILURE);

			memset(l_intl_rept_struct_ha,NULL,sizeof(INTL_REPT_STRUCT_H));

			strcpy(l_intl_rept_struct_ha->report_name, chr_l_cri_broker_handoff_file_name+strlen(chr_l_handoff_dir));
			strcpy(l_intl_rept_struct_ha->report_desc, APL_HOFF_FILE_DESC);
			strcpy(l_intl_rept_struct_ha->report_date, argv[2]);
			l_intl_rept_struct_ha->report_width = 100;
			strcpy(l_intl_rept_struct_ha->task_desc, p_intl_env_data_struct_h_d->processtion);
			strcpy(l_intl_rept_struct_ha->fe_be_ind, APL_BE_IND);
			strcpy(l_intl_rept_struct_ha->usr, p_intl_env_data_struct_h_d->usr);

			if (APL_FAILURE == CO_Proc_DBRptIns( l_intl_rept_struct_ha, l_debug_info_ptr))
		  	{
		  		APL_GOBACK_FAIL
			}

         
                        if ((l_ptr_ca_handoff_file = fopen(chr_l_ca_handoff_file_name,"w")) == NULL)
                                return(APL_FAILURE);

                        memset(l_intl_rept_struct_ha,NULL,sizeof(INTL_REPT_STRUCT_H));

                        
                        strcpy(l_intl_rept_struct_ha->report_name, chr_l_ca_handoff_file_name+strlen(chr_l_handoff_dir));
                        strcpy(l_intl_rept_struct_ha->report_desc, APL_HOFF_FILE_DESC);
                        strcpy(l_intl_rept_struct_ha->report_date, argv[2]);
                        l_intl_rept_struct_ha->report_width = 100;
                        strcpy(l_intl_rept_struct_ha->task_desc, p_intl_env_data_struct_h_d->processtion);
                        strcpy(l_intl_rept_struct_ha->fe_be_ind, APL_BE_IND);
                        strcpy(l_intl_rept_struct_ha->usr, p_intl_env_data_struct_h_d->usr);

                          
                        if (APL_FAILURE == CO_Proc_DBRptIns( l_intl_rept_struct_ha, l_debug_info_ptr))
                        {
                                APL_GOBACK_FAIL
                        }
		}

		if((0 == strcmp(chr_l_typeoffile, HANDOFF_TRUE)) || (0 == strcmp(chr_l_typeoffile, HANDOFF_BOTH)))
		{
			strcpy(chr_l_hrc_handoff_file_name,chr_l_handoff_dir);
			strcat(chr_l_hrc_handoff_file_name,"HRY");
			strcat(chr_l_hrc_handoff_file_name,chr_l_date);
			strcat(chr_l_hrc_handoff_file_name,".CIY");

			

			

			strcpy(chr_l_hbrokers_handoff_file_name,chr_l_handoff_dir);
			strcat(chr_l_hbrokers_handoff_file_name,"HS");
			strcat(chr_l_hbrokers_handoff_file_name,chr_l_date);
			strcat(chr_l_hbrokers_handoff_file_name,".CIY");

			if ((l_ptr_hrc_handoff_file = fopen(chr_l_hrc_handoff_file_name,"w")) == NULL)
				return(APL_FAILURE);

			memset(l_intl_rept_struct_ha,NULL,sizeof(INTL_REPT_STRUCT_H));

			  
			strcpy(l_intl_rept_struct_ha->report_name, chr_l_hrc_handoff_file_name+strlen(chr_l_handoff_dir));
			strcpy(l_intl_rept_struct_ha->report_desc, APL_HOFF_FILE_DESC);
			strcpy(l_intl_rept_struct_ha->report_date, argv[2]);
			l_intl_rept_struct_ha->report_width = 100;
			strcpy(l_intl_rept_struct_ha->task_desc, p_intl_env_data_struct_h_d->processtion);
			strcpy(l_intl_rept_struct_ha->fe_be_ind, APL_BE_IND);
			strcpy(l_intl_rept_struct_ha->usr, p_intl_env_data_struct_h_d->usr);

			  
			if (APL_FAILURE == CO_Proc_DBRptIns( l_intl_rept_struct_ha, l_debug_info_ptr))
			{
				APL_GOBACK_FAIL
			}
		
			
	
			

			if ((l_ptr_hbrokers_handoff_file = fopen(chr_l_hbrokers_handoff_file_name,"w")) == NULL)
				return(APL_FAILURE);

			memset(l_intl_rept_struct_ha,NULL,sizeof(INTL_REPT_STRUCT_H));

			
			strcpy(l_intl_rept_struct_ha->report_name, chr_l_hbrokers_handoff_file_name+strlen(chr_l_handoff_dir));
			strcpy(l_intl_rept_struct_ha->report_desc, APL_HOFF_FILE_DESC);
			strcpy(l_intl_rept_struct_ha->report_date, argv[2]);
			l_intl_rept_struct_ha->report_width = 100;
			strcpy(l_intl_rept_struct_ha->task_desc, p_intl_env_data_struct_h_d->processtion);
			strcpy(l_intl_rept_struct_ha->fe_be_ind, APL_BE_IND);
			strcpy(l_intl_rept_struct_ha->usr, p_intl_env_data_struct_h_d->usr);

			  
			if (APL_FAILURE == CO_Proc_DBRptIns( l_intl_rept_struct_ha, l_debug_info_ptr))
		  	{
		  		APL_GOBACK_FAIL
			}
		}
	}

	


 

   int_retval = CO_Rtv_RptFileName("CH", "Broker RVP Trades Report", 
									 80, p_intl_env_data_struct_h_d->processtion, argv, 
									 &l_broker_RVP_rpt_file, l_debug_info_ptr);
   if (int_retval != APL_SUCCESS)
      return(APL_FAILURE);

   
   int_retval = WritePendTrdRepFn(l_broker_RVP_rpt_file, int_l_page_no_rvp, 4,0, p_ptr_log_file, p_intl_env_data_struct_h_d, l_debug_info_ptr);
   if (int_retval != APL_SUCCESS)
      return(APL_FAILURE);

   sleep(2);


   int_retval = CO_Rtv_RptFileName("CH", "Broker DVP Trades Report", 80, 
									 p_intl_env_data_struct_h_d->processtion, argv, 
									 &l_broker_DVP_rpt_file, l_debug_info_ptr);
   if (int_retval != APL_SUCCESS)
      return(APL_FAILURE);

   
   int_retval = WritePendTrdRepFn(l_broker_DVP_rpt_file, int_l_page_no_dvp, 3,0, p_ptr_log_file, p_intl_env_data_struct_h_d, l_debug_info_ptr);
   if (int_retval != APL_SUCCESS)
      return(APL_FAILURE);

   sleep(2);


   int_retval = CO_Rtv_RptFileName("CH", "Broker DELV_FREE Trades Report", 80, p_intl_env_data_struct_h_d->processtion, 
									 argv,&l_broker_DF_rpt_file, l_debug_info_ptr);
   if (int_retval != APL_SUCCESS)
      return(APL_FAILURE);

   
   int_retval = WritePendTrdRepFn(l_broker_DF_rpt_file, int_l_page_no_df, 1,0, p_ptr_log_file, p_intl_env_data_struct_h_d, l_debug_info_ptr);
   if (int_retval != APL_SUCCESS)
      return(APL_FAILURE);

   sleep(2);

   int_retval = CO_Rtv_RptFileName("CH", "Broker RECEIVE_FREE Trades Report", 80, p_intl_env_data_struct_h_d->processtion, 
								    argv,&l_broker_RF_rpt_file, l_debug_info_ptr);
   if (int_retval != APL_SUCCESS)
      return(APL_FAILURE);

   
   int_retval = WritePendTrdRepFn(l_broker_RF_rpt_file, int_l_page_no_rf, 2,0, p_ptr_log_file, p_intl_env_data_struct_h_d, l_debug_info_ptr);
   if (int_retval != APL_SUCCESS)
      return(APL_FAILURE);

   sleep(2);
 

	strcpy((char *)chr_l_entrytype, "G");
	strcpy((char *)chr_l_typeoftrd, "19");
	strcpy((char *)chr_l_typeoftrd1, "18");
	strcpy((char *)chr_l_trcode_a, "4");

 	

        if (strcmp(chr_l_gen_handoff_file_flg, "Y") == 0)
           {
             int_retval = CDBGenCAEntryTrFn(l_ptr_ca_handoff_file, p_ptr_log_file, p_intl_env_data_struct_h_d, l_debug_info_ptr);
                if (int_retval != APL_SUCCESS)
                        return(APL_FAILURE);
           }

        fclose(l_ptr_ca_handoff_file);

	

		
   memset(chr_l_day,APL_NULL_CHAR,3);
   memset(chr_l_month,APL_NULL_CHAR,3);
   memset(chr_l_year,APL_NULL_CHAR,5);

   chr_l_day[0] = chr_l_sys_date[0];
   chr_l_day[1] = chr_l_sys_date[1];
   chr_l_day[2] = '\0';

   chr_l_month[0] = chr_l_sys_date[3];
   chr_l_month[1] = chr_l_sys_date[4];
   chr_l_month[2] = '\0';

   chr_l_year[0] = chr_l_sys_date[6];
   chr_l_year[1] = chr_l_sys_date[7];
   chr_l_year[2] = chr_l_sys_date[8];
   chr_l_year[3] = chr_l_sys_date[9];
   chr_l_year[4] = '\0';

   
	sprintf(chr_l_bcri_sys_date,"%s%s%s",chr_l_year,chr_l_month,chr_l_day);	

	if (strcmp(chr_l_gen_handoff_file_flg,"N") == 0)
	{
      EXEC SQL DECLARE TradeInfo11 CURSOR FOR
         SELECT a.* FROM DL_DEAL a,MT_CLIENT b
         WHERE (a.ENTRY != :chr_l_entrytype OR a.dl_class = :chr_l_typeoftrd
                OR (a.dl_class = :chr_l_typeoftrd1 AND a.deal_cd = :chr_l_trcode_a))
         AND   a.VAL_FDT <= :chr_l_conf_dt   
         AND   a.setl_date <= :chr_l_sys_date
         AND   a.client = b.CLN_CODE
         ORDER BY a.domestic_cpclt, a.instr_code
         FOR UPDATE OF a.access_stamp;

      EXEC SQL DECLARE TradeInfo21 CURSOR FOR
         SELECT a.* FROM DL_DEAL a, MT_CLIENT b
         WHERE (a.ENTRY != :chr_l_entrytype OR a.dl_class = :chr_l_typeoftrd
                OR (a.dl_class = :chr_l_typeoftrd1 AND a.deal_cd = :chr_l_trcode_a))
         AND   a.VAL_FDT <= :chr_l_conf_dt   
         AND   a.setl_date <= :chr_l_sys_date
         AND   a.client = b.CLN_CODE
         ORDER BY a.domestic_cpclt, a.instr_code;
	}
	else if (strcmp(chr_l_gen_handoff_file_flg,"Y") == 0)
	{
		
      EXEC SQL DECLARE TradeInfo12 CURSOR FOR
         SELECT a.* FROM DL_DEAL a,MT_CLIENT b
         WHERE (a.ENTRY != :chr_l_entrytype OR a.dl_class = :chr_l_typeoftrd
                OR (a.dl_class = :chr_l_typeoftrd1 AND a.deal_cd = :chr_l_trcode_a))
         AND   a.VAL_FDT <= :chr_l_conf_dt    
         AND   a.TRANS_DATE IS NULL
         AND   a.setl_date <= :chr_l_sys_date
         AND   a.client = b.CLN_CODE
         ORDER BY a.domestic_cpclt, a.instr_code
         FOR UPDATE OF a.access_stamp;

		EXEC SQL DECLARE TradeInfo22 CURSOR FOR
         SELECT a.* FROM DL_DEAL a,MT_CLIENT b
         WHERE (a.ENTRY != :chr_l_entrytype OR a.dl_class = :chr_l_typeoftrd
                OR (a.dl_class = :chr_l_typeoftrd1 AND a.deal_cd = :chr_l_trcode_a))
         AND   a.VAL_FDT <= :chr_l_conf_dt   
         AND   a.TRANS_DATE IS NULL
         AND   a.setl_date <= :chr_l_sys_date
         AND   a.client = b.CLN_CODE
         ORDER BY a.domestic_cpclt, a.instr_code;	
	}

	if (strcmp(chr_l_gen_handoff_file_flg,"N") == 0)
	{
		EXEC SQL OPEN TradeInfo11;
		EXEC SQL OPEN TradeInfo21;
	}
	else if (strcmp(chr_l_gen_handoff_file_flg,"Y") == 0)
	{
		EXEC SQL OPEN TradeInfo12;
		EXEC SQL OPEN TradeInfo22;
	}

	IS_ANY_ORA_ERROR

	for(;;)
	{
		if (strcmp(chr_l_gen_handoff_file_flg,"N") == 0)
			EXEC SQL FETCH TradeInfo11 INTO :l_sys_dl_deal_struct_hb:l_sys_dl_deal_struct_il;
		else if (strcmp(chr_l_gen_handoff_file_flg,"Y") == 0)
			EXEC SQL FETCH TradeInfo12 INTO :l_sys_dl_deal_struct_hb:l_sys_dl_deal_struct_il;

		IS_ANY_ORA_ERROR

		if (APL_ZERO_RESULT_SET)
			break;

		EXEC SQL SELECT NEW_ISSUE,CLASSCD, MOTHER_SEC_IND, INSTR_PARENT
		INTO :chr_l_newissue:i_new_issue,:chr_l_clscode_a:i_classcd, :chr_l_mothinstrflg:i_mother_sec_ind, :chr_l_instr_parent:i_instr_parent
		FROM MT_INSTRUMENT
		WHERE instr_code = :l_sys_dl_deal_struct_hb.h_instr_code;

		IS_ANY_ORA_ERROR_AND_ZERO_RESULTSET(ERR_REC_NOTFND,APL_NULL_STRING,APL_NULL_STRING,APL_NULL_STRING)

		if ((strcmp(chr_l_newissue,"R") == 0) || (strcmp(chr_l_clscode_a,"HS")!=0))
			continue;

		if (strcmp(g_mt_commonsys_params_struct_h.ca_module_ind,"Y") == 0)
		{
			if (strcmp(l_sys_dl_deal_struct_hb.h_classofdl,"19") == 0)
			{
				EXEC SQL SELECT corp_id 
				INTO :chr_l_ca_id:i_corp_id
				FROM CACHEQUE
				WHERE DEAL_IDENTITY_NO = :l_sys_dl_deal_struct_hb.h_indentity_no;

				IS_ANY_ORA_ERROR

				if (sqlca.sqlcode != 1403)
				{

				EXEC SQL SELECT CA_EVENT
				INTO :chr_l_ce_typ:i_ca_event
				FROM CAEVENT
				WHERE corp_id = :chr_l_ca_id;
				
				IS_ANY_ORA_ERROR_AND_ZERO_RESULTSET(ERR_REC_NOTFND,APL_NULL_STRING,APL_NULL_STRING,APL_NULL_STRING)


				if ((strcmp(chr_l_ce_typ,"BO") != 0) && (strcmp(chr_l_ce_typ,"SD") != 0))
					continue;
				}
			}
		}

		EXEC SQL SELECT CLN_master
		INTO :chr_l_mstacc_a:i_mstclt
		FROM MT_CLIENT
		WHERE CLN_CODE = :l_sys_dl_deal_struct_hb.h_dl_client;

		IS_ANY_ORA_ERROR_AND_ZERO_RESULTSET(ERR_REC_NOTFND,APL_NULL_STRING,APL_NULL_STRING,APL_NULL_STRING)

		if ((strcmp(l_sys_dl_deal_struct_hb.h_classofdl,"18") != 0) && (strcmp(l_sys_dl_deal_struct_hb.h_classofdl,"19") != 0))
		{
			if (strcmp(l_sys_dl_deal_struct_hb.h_domcpclt_cd,l_mt_core_sys_params_struct_h.custody_clt_cd) == 0)
			  {
             if (strcmp(l_sys_dl_deal_struct_hb.h_countclt,APL_NULL_STRING) == 0) // AIX Warning
                strcpy(int_l_domcpac,l_sys_dl_deal_struct_hb.h_clientofcode);
             else
                
                strncpy(int_l_domcpac,l_sys_dl_deal_struct_hb.h_countclt,APL_CLIENT_LENGTH-1);
                strcat(int_l_domcpac,"\0");

           } 
			else
				strcpy(int_l_domcpac,l_sys_dl_deal_struct_hb.h_domcpclt_cd);
		}
		else
			strcpy(int_l_domcpac,l_sys_dl_deal_struct_hb.h_domcpclt_cd);

		if (strcmp(int_l_domcpac,APL_NULL_STRING) == 0) // AIX Warning
		{
			if (int_l_err_cond == 0)
			{
				

				int_retval = CO_Rtv_RptFileName("CH","Error Rep - TR",80,p_intl_env_data_struct_h_d->processtion,argv,&l_clh_error_TR_rpt_file,l_debug_info_ptr);

				if (int_retval != APL_SUCCESS)
					APL_GOBACK_FAIL
				
				int_l_err_cond = 1;

				

				int_retval = WriteErrorReportHeaderForTrFn(l_clh_error_TR_rpt_file,int_l_page_no,p_ptr_log_file,p_intl_env_data_struct_h_d,l_debug_info_ptr);

				if (int_retval != APL_SUCCESS)
					APL_GOBACK_FAIL

			}

			

			int_retval = WriteErrorReportDetailsForTrFn(l_clh_error_TR_rpt_file,l_sys_dl_deal_struct_hb.h_dl_client,l_sys_dl_deal_struct_hb.h_indentity_no,p_ptr_log_file,p_intl_env_data_struct_h_d,l_debug_info_ptr);
			if (int_retval != APL_SUCCESS)
				APL_GOBACK_FAIL

			continue;
		}
			
		
		memset(chr_l_acctruedvp, APL_NULL_CHAR, APL_FLAG_LENGTH);

		EXEC SQL SELECT CLN_master, CLN_REG_BCL_IND
		INTO :chr_l_cnt_mstacc:i_cnt_mstacc, :chr_l_acctruedvp:i_acctruedvp
		FROM MT_CLIENT
		WHERE CLN_CODE = :int_l_domcpac;

		IS_ANY_ORA_ERROR_AND_ZERO_RESULTSET(ERR_REC_NOTFND,APL_NULL_STRING,APL_NULL_STRING,APL_NULL_STRING)

		if((strcmp(chr_l_acctruedvp, HANDOFF_TRUE) == 0) && (strcmp(chr_l_typeoffile, HANDOFF_NORMAL) == 0))
			continue;
		else if((strcmp(chr_l_acctruedvp, HANDOFF_TRUE) != 0) && (strcmp(chr_l_typeoffile, HANDOFF_TRUE) == 0))
			continue;
	
			EXEC SQL SELECT MOTHER_SEC_IND,INSTR_PARENT,CLASSCD
			INTO :chr_l_mothinstrflg:i_mother_sec_ind,:chr_l_instr_parent:i_instr_parent,:chr_l_clscode_a:i_classcd
			FROM MT_INSTRUMENT
			WHERE instr_code = :l_sys_dl_deal_struct_hb.h_instr_code;

			IS_ANY_ORA_ERROR_AND_ZERO_RESULTSET(ERR_REC_NOTFND,APL_NULL_STRING,APL_NULL_STRING,APL_NULL_STRING)

			strcpy(chr_l_clhtr_account, l_sys_dl_deal_struct_hb.h_dl_client);
			if(strcmp(l_sys_dl_deal_struct_hb.h_countclt,APL_NULL_STRING)!=0)
			{
				strcpy(chr_l_clhtr_countacc, l_sys_dl_deal_struct_hb.h_countclt);
			}
			else
			{
				strcpy(chr_l_clhtr_countacc,l_sys_dl_deal_struct_hb.h_clientofcode);
			}
			
			strcpy(chr_l_clhtr_instrcode,l_sys_dl_deal_struct_hb.h_instr_code);
		
			if ((strcmp(l_sys_dl_deal_struct_hb.h_dealcd,"2") == 0) || (strcmp(l_sys_dl_deal_struct_hb.h_dealcd,"4") == 0))
				strcpy(chr_l_clhtr_recdel, "1");
			else if ((strcmp(l_sys_dl_deal_struct_hb.h_dealcd,"1") == 0) || (strcmp(l_sys_dl_deal_struct_hb.h_dealcd,"3") == 0))
				strcpy(chr_l_clhtr_recdel, "0");
			
			if ((strcmp(l_sys_dl_deal_struct_hb.h_dealcd,"3") == 0) || (strcmp(l_sys_dl_deal_struct_hb.h_dealcd,"4") == 0))
				dbl_l_clhtr_amount = l_sys_dl_deal_struct_hb.h_amt;
			else if ((strcmp(l_sys_dl_deal_struct_hb.h_dealcd,"1") == 0) || (strcmp(l_sys_dl_deal_struct_hb.h_dealcd,"2") == 0))
				dbl_l_clhtr_amount = 0.0;

			if((0 == strcmp(TYPEOF_DEAL_CORP_1, l_sys_dl_deal_struct_hb.h_classofdl)) || (0 == strcmp(TYPEOF_DEAL_CORP_2, l_sys_dl_deal_struct_hb.h_classofdl)))
			{
				strcpy(chr_l_typeoftrd, TYPEOF_DEAL_CORP);
			}
			else
			{
				strcpy(chr_l_typeoftrd, NORMAL_DEAL);
			}

			if(strcmp(l_sys_dl_deal_struct_hb.h_domcpclt_cd,l_mt_core_sys_params_struct_h.custody_clt_cd) == 0)
			{
				if(strcmp(chr_l_clhtr_recdel,"0")==0)
				{
					int_retval = CDBRecsInClhTrFn(chr_l_clhtr_account,chr_l_clhtr_instrcode,chr_l_clhtr_recdel, chr_l_acctruedvp, p_ptr_log_file, chr_l_typeoftrd,chr_l_clhtr_countacc,p_intl_env_data_struct_h_d, l_debug_info_ptr );	
			
					if (int_retval == APL_SUCCESS)
					{
						strcpy(l_dl_clhtr_struct_h.h_dl_client,chr_l_clhtr_account);
						strcpy(l_dl_clhtr_struct_h.h_instr_code,chr_l_clhtr_instrcode);
						strcpy(l_dl_clhtr_struct_h.h_rec_del,chr_l_clhtr_recdel);
						l_dl_clhtr_struct_h.h_qty = l_sys_dl_deal_struct_hb.h_qty;
						l_dl_clhtr_struct_h.h_amt = dbl_l_clhtr_amount;
						strcpy(l_dl_clhtr_struct_h.h_act_dvp, chr_l_acctruedvp);
						strcpy(l_dl_clhtr_struct_h.h_classofdl, chr_l_typeoftrd);	
						strcpy(l_dl_clhtr_struct_h.h_countclt,chr_l_clhtr_countacc); 

				 
				 		l_dl_clhtr_struct_i.i_dl_client = 0;
				 		l_dl_clhtr_struct_i.i_instr_code = 0;
				 		l_dl_clhtr_struct_i.i_rec_del = 0;
				 		l_dl_clhtr_struct_i.i_qty = 0;
				 		l_dl_clhtr_struct_i.i_amt = 0;
						l_dl_clhtr_struct_i.i_act_dvp = 0;
						l_dl_clhtr_struct_i.i_classofdl = 0;	
				 		l_dl_clhtr_struct_i.i_countclt = 0; 
			
				 		EXEC SQL INSERT INTO DL_CLHTR
							VALUES (:l_dl_clhtr_struct_h:l_dl_clhtr_struct_i);

					   IS_ANY_ORA_ERROR_AND_DUPLICATE(ERR_REC_EXIST,APL_NULL_STRING,APL_NULL_STRING,APL_NULL_STRING)
					}
					else if (int_retval == APL_RECS_EXIST)
					{
						
						EXEC SQL UPDATE DL_CLHTR
						SET QTY = QTY + :l_sys_dl_deal_struct_hb.h_qty,
						 	AMOUNT = AMOUNT + :dbl_l_clhtr_amount
						WHERE client = :chr_l_clhtr_account
						AND   instr_code = :chr_l_clhtr_instrcode
						AND   REC_DEL = :chr_l_clhtr_recdel
						AND	ACT_DVP = :chr_l_acctruedvp
						AND	dl_class = :chr_l_typeoftrd
						AND   cp_clt = :chr_l_clhtr_countacc;
		
						IS_ANY_ORA_ERROR_AND_ZERO_RESULTSET(ERR_REC_NOTFND,APL_NULL_STRING,APL_NULL_STRING,APL_NULL_STRING)
					}
				}
            
            if ((strcmp(l_sys_dl_deal_struct_hb.h_dealcd,"1") == 0) || (strcmp(l_sys_dl_deal_struct_hb.h_dealcd,"3") == 0))
               {
                memset(&l_dl_clhcri_struct_h,NULL,sizeof(DL_CLHCRI_STRUCT_H));
                int_bcri_seq_num++;
                l_dl_clhcri_struct_h.h_sequence_num = int_bcri_seq_num;
                CO_ToStr(l_dl_clhcri_struct_h.h_sequence_num,10,0,chr_l_rep_seq);
				    strcpy(l_dl_clhcri_struct_h.h_sys_dt,chr_l_bcri_sys_date);
					 memset(chr_l_day,APL_NULL_CHAR,3);
                memset(chr_l_month,APL_NULL_CHAR,3);
                memset(chr_l_year,APL_NULL_CHAR,5);

                chr_l_day[0] = l_sys_dl_deal_struct_hb.h_setldt[0];
                chr_l_day[1] = l_sys_dl_deal_struct_hb.h_setldt[1];
                chr_l_day[2] = '\0';

                chr_l_month[0] = l_sys_dl_deal_struct_hb.h_setldt[3];
                chr_l_month[1] = l_sys_dl_deal_struct_hb.h_setldt[4];
                chr_l_month[2] = '\0';

                chr_l_year[0] = l_sys_dl_deal_struct_hb.h_setldt[6];
                chr_l_year[1] = l_sys_dl_deal_struct_hb.h_setldt[7];
                chr_l_year[2] = l_sys_dl_deal_struct_hb.h_setldt[8];
                chr_l_year[3] = l_sys_dl_deal_struct_hb.h_setldt[9];
                chr_l_year[4] = '\0';

                
					 sprintf(chr_l_bcri_set_date,"%s%s%s",chr_l_year,chr_l_month,chr_l_day);
                strcpy(l_dl_clhcri_struct_h.h_set_dt,chr_l_bcri_set_date);
                strcpy(l_dl_clhcri_struct_h.h_dl_client,l_sys_dl_deal_struct_hb.h_dl_client);

                memset(chr_l_clh_account,APL_NULL_CHAR,16);
                EXEC SQL SELECT CLN_CLH INTO :chr_l_clh_account:i_clh_account FROM MT_CLIENT WHERE CLN_CODE = :l_sys_dl_deal_struct_hb.h_domcpclt_cd;
                IS_ANY_ORA_ERROR ;

                strcpy(l_dl_clhcri_struct_h.h_clh_client,chr_l_clh_account);
                strcpy(l_dl_clhcri_struct_h.h_countclt,l_sys_dl_deal_struct_hb.h_countclt);

                memset(chr_l_isin,APL_NULL_CHAR,13);
                EXEC SQL SELECT INSTR_ISIN INTO :chr_l_isin:i_instr_isin FROM MT_INSTRUMENT WHERE INSTR_CODE = :l_sys_dl_deal_struct_hb.h_instr_code ;

                IS_ANY_ORA_ERROR ;
                strcpy(l_dl_clhcri_struct_h.h_instr_isin,chr_l_isin);

                l_dl_clhcri_struct_h.h_qty = l_sys_dl_deal_struct_hb.h_qty ;
                memset(chr_l_rep_qty,APL_NULL_CHAR,19); 
                CO_ToStr(l_dl_clhcri_struct_h.h_qty,15,3,chr_l_rep_qty);

               
               fprintf(l_ptr_cri_dc_handoff_file,"%s,1,%s,%s,CIY,%s,SERB,,,,,%s,,%s,SERB,,,,,XIST,%s,A,%s,1,1,N,000100,%s,235900,N,N,50\n",chr_l_rep_seq,l_dl_clhcri_struct_h.h_sys_dt,l_dl_clhcri_struct_h.h_set_dt,l_dl_clhcri_struct_h.h_dl_client,l_dl_clhcri_struct_h.h_clh_client,l_dl_clhcri_struct_h.h_countclt,l_dl_clhcri_struct_h.h_instr_isin,chr_l_rep_qty,l_dl_clhcri_struct_h.h_set_dt);
					}
            
			}
		if (strcmp(chr_l_gen_handoff_file_flg,"Y") == 0) 
		{	
			if(strcmp(l_sys_dl_deal_struct_hb.h_dealcd,"2")!=0)
			{
				if (strcmp(chr_l_clscode_a,"HS") == 0)
				{
					EXEC SQL UPDATE DL_DEAL
					SET trans_date = :chr_l_sys_date:i_sys_date
					WHERE client = :l_sys_dl_deal_struct_hb.h_dl_client
					AND   IDENTIY_NO = :l_sys_dl_deal_struct_hb.h_indentity_no;
		
					IS_ANY_ORA_ERROR_AND_ZERO_RESULTSET(ERR_REC_NOTFND,APL_NULL_STRING,APL_NULL_STRING,APL_NULL_STRING)
				}
			}
		}
			
			
			memset(chr_l_acctruedvp, APL_NULL_CHAR, APL_FLAG_LENGTH);
			memset(chr_l_acc_cl_code, APL_NULL_CHAR, APL_FLAG_LENGTH);
			
			EXEC SQL SELECT CLN_CLH, CLN_REG_BCL_IND
      	INTO :chr_l_acc_cl_code:i_acc_cl_code, :chr_l_acctruedvp:i_acctruedvp
      	FROM MT_CLIENT
      	WHERE CLN_CODE = :l_sys_dl_deal_struct_hb.h_domcpclt_cd;

      	IS_ANY_ORA_ERROR_AND_ZERO_RESULTSET(ERR_REC_NOTFND,APL_NULL_STRING,APL_NULL_STRING,APL_NULL_STRING)
		
			if (strcmp(chr_l_incl_amt_flg,"Y") == 0)
			{
				if ((strcmp(l_sys_dl_deal_struct_hb.h_dealcd,"3") == 0) || (strcmp(l_sys_dl_deal_struct_hb.h_dealcd,"4") == 0))
					sprintf(dbl_l_amount_a,"%f",l_sys_dl_deal_struct_hb.h_amt);
				else if ((strcmp(l_sys_dl_deal_struct_hb.h_dealcd,"1") == 0) || (strcmp(l_sys_dl_deal_struct_hb.h_dealcd,"2") == 0))
					sprintf(dbl_l_amount_a,"0.000000");
			}
			else
			{
				strcpy(dbl_l_amount_a, APL_NULL_STRING);
			}

			if (strcmp(chr_l_newissue,"N") == 0)
				strcpy(chr_l_newissue,"E");
			else if ((strcmp(chr_l_newissue,"Y") == 0) && (strcmp(chr_l_mothinstrflg,"Y") != 0))
				strcpy(chr_l_newissue,"Y");
			else if ((strcmp(chr_l_newissue,"M") == 0) && (strcmp(chr_l_mothinstrflg,"Y") != 0))
				strcpy(chr_l_newissue,"M");

			
			if (strcmp(chr_l_mothinstrflg,"Y" ) == 0)
				strcpy(chr_l_instrcode_a, l_sys_dl_deal_struct_hb.h_instr_code);
			else
				strcpy(chr_l_instrcode_a, chr_l_instr_parent);

			EXEC SQL SELECT EXCHGRT
         	INTO :l_exchgrt_a
            FROM MT_EXCHRATE
            WHERE CURRENCY_CD = :l_sys_dl_deal_struct_hb.h_currencycode
            	AND DENOM_CCY = :g_mt_commonsys_params_struct_h.dom_ccy
               AND RATE_DATE = (select MAX(RATE_DATE) from MT_EXCHRATE
              	where currency_cd =:l_sys_dl_deal_struct_hb.h_currencycode and DENOM_CCY=:g_mt_commonsys_params_struct_h.dom_ccy);


       	IS_ANY_ORA_ERROR

			memset(chr_l_trlamount, APL_NULL_CHAR, sizeof(chr_l_trlamount));
			if(sqlca.sqlcode != 1403)
			{
				l_dbltrlamount = l_exchgrt_a * l_sys_dl_deal_struct_hb.h_amt;
				sprintf(chr_l_trlamount, "%18.3lf", l_dbltrlamount);
			}
			else
			{
				sprintf(chr_l_trlamount, "%18.3lf", l_sys_dl_deal_struct_hb.h_amt);
			}

			if(strcmp(l_sys_dl_deal_struct_hb.h_countclt,APL_NULL_STRING)==0)
				strcpy(chr_l_cntac_acntof,l_sys_dl_deal_struct_hb.h_clientofcode);
			else
				strcpy(chr_l_cntac_acntof,l_sys_dl_deal_struct_hb.h_countclt);

			
         if((strcmp(l_sys_dl_deal_struct_hb.h_domcpclt_cd,l_mt_core_sys_params_struct_h.custody_clt_cd) != 0) && (strcmp(l_sys_dl_deal_struct_hb.h_dealcd, APL_DEAL_RVP) == 0))
			{
				if (strcmp(chr_l_gen_handoff_file_flg,"Y") == 0)
				{
					int_l_type_flg = 1;
					int_retval = CDBGenBrkEntryDVPTrFn(l_ptr_hrc_handoff_file, chr_l_cntac_acntof,chr_l_acc_cl_code, chr_l_instrcode_a, chr_l_newissue, l_sys_dl_deal_struct_hb.h_qty, dbl_l_amount_a, l_sys_dl_deal_struct_hb.h_setldt, l_sys_dl_deal_struct_hb.h_dl_client, l_sys_dl_deal_struct_hb.h_indentity_no, chr_l_incl_amt_flg, l_sys_dl_deal_struct_hb.h_dealcd, p_ptr_log_file,int_l_type_flg, p_intl_env_data_struct_h_d, l_debug_info_ptr);
				}

				
			}

	
      


	if(strcmp(l_sys_dl_deal_struct_hb.h_domcpclt_cd,l_mt_core_sys_params_struct_h.custody_clt_cd) != 0)
	{
       if(strcmp(l_sys_dl_deal_struct_hb.h_dealcd,"1")==0)
       {
         if(APL_FAILURE == WritePendBrokRepDetFn(l_broker_DF_rpt_file, l_sys_dl_deal_struct_hb.h_domcpclt_cd,chr_l_cntac_acntof , l_sys_dl_deal_struct_hb.h_dl_client, chr_l_acc_cl_code, l_sys_dl_deal_struct_hb.h_instr_code, chr_l_newissue, l_sys_dl_deal_struct_hb.h_dealcd,  l_sys_dl_deal_struct_hb.h_qty, dbl_l_amount_a, p_ptr_log_file, p_intl_env_data_struct_h_d, l_debug_info_ptr))
         {
            APL_GOBACK_FAIL
         }

         int_l_lines_rpted_df = int_l_lines_rpted_df + 2;

         if (int_l_lines_rpted_df == REPORT_PAGE_LEN)
         {
            int_l_page_no_df = int_l_page_no_df + 1;

            
            int_retval = WritePendTrdRepFn(l_broker_DF_rpt_file, int_l_page_no_df, 1,0, p_ptr_log_file, p_intl_env_data_struct_h_d, l_debug_info_ptr);

            if (int_retval != APL_SUCCESS)
               return(APL_FAILURE);

            int_l_lines_rpted_df   = PAGE_HDR_LENGTH;
         }
       }
       else if(strcmp(l_sys_dl_deal_struct_hb.h_dealcd,"2")==0)
       {
         if(APL_FAILURE == WritePendBrokRepDetFn(l_broker_RF_rpt_file, l_sys_dl_deal_struct_hb.h_domcpclt_cd,chr_l_cntac_acntof , l_sys_dl_deal_struct_hb.h_dl_client, chr_l_acc_cl_code, l_sys_dl_deal_struct_hb.h_instr_code, chr_l_newissue, l_sys_dl_deal_struct_hb.h_dealcd,  l_sys_dl_deal_struct_hb.h_qty, dbl_l_amount_a, p_ptr_log_file, p_intl_env_data_struct_h_d, l_debug_info_ptr))
         {
            APL_GOBACK_FAIL
         }

         int_l_lines_rpted_rf = int_l_lines_rpted_rf + 2;

         if (int_l_lines_rpted_rf == REPORT_PAGE_LEN)
         {
            int_l_page_no_rf = int_l_page_no_rf + 1;

            
            int_retval = WritePendTrdRepFn(l_broker_RF_rpt_file, int_l_page_no_rf, 2,0, p_ptr_log_file, p_intl_env_data_struct_h_d, l_debug_info_ptr);

            if (int_retval != APL_SUCCESS)
               return(APL_FAILURE);

            int_l_lines_rpted_rf   = PAGE_HDR_LENGTH;
         }
       }
       else if(strcmp(l_sys_dl_deal_struct_hb.h_dealcd,"3")==0)
       {
         if(APL_FAILURE == WritePendBrokRepDetFn(l_broker_DVP_rpt_file, l_sys_dl_deal_struct_hb.h_domcpclt_cd,chr_l_cntac_acntof , l_sys_dl_deal_struct_hb.h_dl_client, chr_l_acc_cl_code, l_sys_dl_deal_struct_hb.h_instr_code, chr_l_newissue, l_sys_dl_deal_struct_hb.h_dealcd,  l_sys_dl_deal_struct_hb.h_qty, dbl_l_amount_a, p_ptr_log_file, p_intl_env_data_struct_h_d, l_debug_info_ptr))
         {
            APL_GOBACK_FAIL
         }

         int_l_lines_rpted_dvp = int_l_lines_rpted_dvp + 2;

         if (int_l_lines_rpted_dvp == REPORT_PAGE_LEN)
         {
            int_l_page_no_dvp = int_l_page_no_dvp + 1;

            
            int_retval = WritePendTrdRepFn(l_broker_DVP_rpt_file, int_l_page_no_dvp, 3,0, p_ptr_log_file, p_intl_env_data_struct_h_d, l_debug_info_ptr);

            if (int_retval != APL_SUCCESS)
               return(APL_FAILURE);

            int_l_lines_rpted_dvp   = PAGE_HDR_LENGTH;
         }
       }
       else if(strcmp(l_sys_dl_deal_struct_hb.h_dealcd,"4")==0)
       {
         if(APL_FAILURE == WritePendBrokRepDetFn(l_broker_RVP_rpt_file, l_sys_dl_deal_struct_hb.h_domcpclt_cd,chr_l_cntac_acntof , l_sys_dl_deal_struct_hb.h_dl_client, chr_l_acc_cl_code, l_sys_dl_deal_struct_hb.h_instr_code, chr_l_newissue, l_sys_dl_deal_struct_hb.h_dealcd,  l_sys_dl_deal_struct_hb.h_qty, dbl_l_amount_a, p_ptr_log_file, p_intl_env_data_struct_h_d, l_debug_info_ptr))
         {
            APL_GOBACK_FAIL
         }

         int_l_lines_rpted_rvp = int_l_lines_rpted_rvp + 2;

         if (int_l_lines_rpted_rvp == REPORT_PAGE_LEN)
         {
            int_l_page_no_rvp = int_l_page_no_rvp + 1;

            
            int_retval = WritePendTrdRepFn(l_broker_RVP_rpt_file, int_l_page_no_rvp, 4,0, p_ptr_log_file, p_intl_env_data_struct_h_d, l_debug_info_ptr);

            if (int_retval != APL_SUCCESS)
               return(APL_FAILURE);

            int_l_lines_rpted_rvp   = PAGE_HDR_LENGTH;
         }
       }
	}
	


	



		
	}

   fprintf(l_broker_RF_rpt_file,"\n\n");
   fprintf(l_broker_DF_rpt_file,"\n\n");
   fprintf(l_broker_DVP_rpt_file,"\n\n");
   fprintf(l_broker_RVP_rpt_file,"\n\n");

	if (sqlca.sqlerrd[2] == 0)
	{
		CO_InsertErr(l_debug_info_ptr,ERR_NOTHING_REPORT,APL_NULL_STRING,APL_NULL_STRING,APL_NULL_STRING,__LINE__,__FILE__);
	
		if (strcmp(chr_l_gen_handoff_file_flg,"N") == 0)
		{
			EXEC SQL CLOSE TradeInfo11;
			EXEC SQL CLOSE TradeInfo21;
		}
		else if (strcmp(chr_l_gen_handoff_file_flg,"Y") == 0)
		{
			EXEC SQL CLOSE TradeInfo12;
			EXEC SQL CLOSE TradeInfo22;
		}

		APL_GOBACK_FAIL
	}

   for(i=0;i<158;i++)
   {
      fprintf(l_broker_DF_rpt_file,"-");
   }
      fprintf(l_broker_DF_rpt_file,"\n");

   for(i=0;i<158;i++)
   {
      fprintf(l_broker_RF_rpt_file,"-");
   }
      fprintf(l_broker_RF_rpt_file,"\n");

   for(i=0;i<158;i++)
   {
      fprintf(l_broker_DVP_rpt_file,"-");
   }
      fprintf(l_broker_DVP_rpt_file,"\n");

   for(i=0;i<158;i++)
   {
      fprintf(l_broker_RVP_rpt_file,"-");
   }
      fprintf(l_broker_RVP_rpt_file,"\n");


	EXEC SQL DECLARE ClhTrInfo CURSOR FOR
		SELECT * FROM DL_CLHTR;

	EXEC SQL OPEN ClhTrInfo;

	IS_ANY_ORA_ERROR

	int_l_page_no = 1;
	int_l_no_lines_printed = PAGE_HDR_LENGTH;

	for(;;)
	{
		EXEC SQL FETCH ClhTrInfo INTO :l_dl_clhtr_struct_h:l_dl_clhtr_struct_i;

		IS_ANY_ORA_ERROR
		
		if (APL_ZERO_RESULT_SET)
			break;

		EXEC SQL SELECT CLASSCD
		INTO :chr_l_clscode_a:i_classcd
		FROM MT_INSTRUMENT
		WHERE instr_code = :l_dl_clhtr_struct_h.h_instr_code;

		IS_ANY_ORA_ERROR_AND_ZERO_RESULTSET(ERR_REC_NOTFND,APL_NULL_STRING,APL_NULL_STRING,APL_NULL_STRING)

		if (strcmp(chr_l_clscode_a,"HS") != 0)
			continue;

		
		
		EXEC SQL SELECT CLN_CLH
		INTO :chr_l_acc_cl_code:i_acc_cl_code
		FROM MT_CLIENT
		WHERE CLN_CODE = :l_dl_clhtr_struct_h.h_dl_client;

		IS_ANY_ORA_ERROR_AND_ZERO_RESULTSET(ERR_REC_NOTFND,APL_NULL_STRING,APL_NULL_STRING,APL_NULL_STRING)
		

		EXEC SQL SELECT NEW_ISSUE,MOTHER_SEC_IND,INSTR_PARENT
		INTO :chr_l_newissue:i_new_issue,:chr_l_mothinstrflg:i_mother_sec_ind,:chr_l_instr_parent:i_instr_parent
		FROM MT_INSTRUMENT
		WHERE instr_code = :l_dl_clhtr_struct_h.h_instr_code;
		
		IS_ANY_ORA_ERROR_AND_ZERO_RESULTSET(ERR_REC_NOTFND,APL_NULL_STRING,APL_NULL_STRING,APL_NULL_STRING)

		

		if (strcmp(chr_l_newissue,"N") == 0)
			strcpy(chr_l_newissue,"E");
		else if ((strcmp(chr_l_newissue,"Y") == 0) && (strcmp(chr_l_mothinstrflg,"Y") != 0))
			strcpy(chr_l_newissue,"Y");

		else if ((strcmp(chr_l_newissue,"M") == 0) && (strcmp(chr_l_mothinstrflg,"Y") != 0))
			strcpy(chr_l_newissue,"M");

		if (strcmp(chr_l_mothinstrflg,"Y" ) == 0)
			strcpy(chr_l_notmotherflg,"N");
		else
			strcpy(chr_l_notmotherflg,"Y");

		if (strcmp(chr_l_notmotherflg,"Y") == 0)
			strcpy(chr_l_instrcode_a,chr_l_instr_parent);
		else
			strcpy(chr_l_instrcode_a,l_dl_clhtr_struct_h.h_instr_code);

		if(strcmp(l_sys_dl_deal_struct_hb.h_countclt,APL_NULL_STRING)==0)
			strcpy(chr_l_cntac_acntof,l_sys_dl_deal_struct_hb.h_clientofcode);
		else
			strcpy(chr_l_cntac_acntof,l_sys_dl_deal_struct_hb.h_countclt);


		if (strcmp(chr_l_gen_handoff_file_flg,"Y") == 0)
		{
			
			if (strcmp(l_dl_clhtr_struct_h.h_rec_del,"1") == 0)
			{
				
					

			}	
			else if (strcmp(l_dl_clhtr_struct_h.h_rec_del,"0") == 0)
			{
				
					int_retval = CDBGenClEntryTrFn(l_ptr_dc_handoff_file,l_dl_clhtr_struct_h.h_dl_client,l_dl_clhtr_struct_h.h_countclt,chr_l_acc_cl_code,chr_l_instrcode_a, chr_l_newissue, "", l_dl_clhtr_struct_h.h_qty, chr_l_conf_dt, "DELV", l_dl_clhtr_struct_h.h_classofdl, l_dl_clhtr_struct_h.h_amt, p_ptr_log_file, p_intl_env_data_struct_h_d, l_debug_info_ptr);	

			}
			

			if (int_retval != APL_SUCCESS)
				APL_GOBACK_FAIL

		}

		
	}
	
	int_l_page_no = 1;
	int_l_no_lines_printed = PAGE_HDR_LENGTH;
   memset(chr_l_day,APL_NULL_CHAR,3);
   memset(chr_l_month,APL_NULL_CHAR,3);
   memset(chr_l_year,APL_NULL_CHAR,5);

   chr_l_day[0] = chr_l_sys_date[0];
   chr_l_day[1] = chr_l_sys_date[1];
   chr_l_day[2] = '\0';

   chr_l_month[0] = chr_l_sys_date[3];
   chr_l_month[1] = chr_l_sys_date[4];
   chr_l_month[2] = '\0';

   chr_l_year[0] = chr_l_sys_date[6];
   chr_l_year[1] = chr_l_sys_date[7];
   chr_l_year[2] = chr_l_sys_date[8];
   chr_l_year[3] = chr_l_sys_date[9];
   chr_l_year[4] = '\0';

   
	sprintf(chr_l_acri_sys_date,"%s%s%s",chr_l_year,chr_l_month,chr_l_day);

	for(;;)
	{
		if (strcmp(chr_l_gen_handoff_file_flg,"N") == 0)
		{
			EXEC SQL FETCH TradeInfo21 INTO :l_sys_dl_deal_struct_hb:l_sys_dl_deal_struct_il;

			}
		else if (strcmp(chr_l_gen_handoff_file_flg,"Y") == 0)
		{
			EXEC SQL FETCH TradeInfo22 INTO :l_sys_dl_deal_struct_hb:l_sys_dl_deal_struct_il;

			}

		IS_ANY_ORA_ERROR
		
		if (APL_ZERO_RESULT_SET)
			break;
	   
      memset(&l_dl_clhcri_struct_h,NULL,sizeof(DL_CLHCRI_STRUCT_H));
	
		EXEC SQL SELECT CLASSCD,NEW_ISSUE,MOTHER_SEC_IND,INSTR_PARENT
		INTO :chr_l_clscode_a:i_classcd,chr_l_newissue:i_new_issue,chr_l_mothinstrflg:i_mother_sec_ind,chr_l_instr_parent:i_instr_parent
		FROM MT_INSTRUMENT
		WHERE instr_code = :l_sys_dl_deal_struct_hb.h_instr_code;

		IS_ANY_ORA_ERROR_AND_ZERO_RESULTSET(ERR_REC_NOTFND,APL_NULL_STRING,APL_NULL_STRING,APL_NULL_STRING)

		
		memset(chr_l_acctruedvp, APL_NULL_CHAR, APL_FLAG_LENGTH);

		EXEC SQL SELECT CLN_BRK_ALL,CLN_CLH, CLN_REG_BCL_IND
		INTO :chr_l_cubk:i_clt_brk_all,:chr_l_acc_cl_code:i_acc_cl_code, :chr_l_acctruedvp:i_acctruedvp
		FROM MT_CLIENT
		WHERE CLN_CODE = :l_sys_dl_deal_struct_hb.h_domcpclt_cd;

		IS_ANY_ORA_ERROR_AND_ZERO_RESULTSET(ERR_REC_NOTFND,APL_NULL_STRING,APL_NULL_STRING,APL_NULL_STRING)

		if((strcmp(chr_l_acctruedvp, HANDOFF_TRUE) == 0) && (strcmp(chr_l_typeoffile, HANDOFF_NORMAL) == 0))
			continue;
		else if((strcmp(chr_l_acctruedvp, HANDOFF_TRUE) != 0) && (strcmp(chr_l_typeoffile, HANDOFF_TRUE) == 0))
			continue;
		


		
		
		if ((strcmp(chr_l_clscode_a,"HS") != 0) || (strcmp(chr_l_newissue,"R") == 0)
			|| (strcmp(chr_l_cubk,"B") != 0)
			|| (strcmp(l_sys_dl_deal_struct_hb.h_dealcd,"2") == 0) || 
				(strcmp(l_sys_dl_deal_struct_hb.h_dealcd,"4") == 0))
			continue;
		
		if (strcmp(chr_l_mothinstrflg,"Y" ) == 0)
			strcpy(chr_l_notmotherflg,"N");
		else
			strcpy(chr_l_notmotherflg,"Y");

		if (strcmp(chr_l_incl_amt_flg,"Y") == 0)
		{
			if ((strcmp(l_sys_dl_deal_struct_hb.h_dealcd,"3") == 0) || (strcmp(l_sys_dl_deal_struct_hb.h_dealcd,"4") == 0))
				sprintf(dbl_l_amount_a,"%f",l_sys_dl_deal_struct_hb.h_amt);
			else if ((strcmp(l_sys_dl_deal_struct_hb.h_dealcd,"1") == 0) || (strcmp(l_sys_dl_deal_struct_hb.h_dealcd,"2") == 0))
				sprintf(dbl_l_amount_a,"0.000000");
		}
		else if (strcmp(chr_l_incl_amt_flg,"N") == 0)
			
			strcpy(dbl_l_amount_a, APL_NULL_STRING);

		
		if (strcmp(chr_l_notmotherflg,"Y") == 0)
			strcpy(chr_l_instrcode_a,chr_l_instr_parent);
		else
			strcpy(chr_l_instrcode_a,l_sys_dl_deal_struct_hb.h_instr_code);
		
		
		if (strcmp(chr_l_gen_handoff_file_flg,"Y") == 0)
		{

			


			

			if (strcmp(chr_l_newissue,"N") == 0)
				strcpy(chr_l_newissue,"E");
			else if ((strcmp(chr_l_newissue,"Y") == 0) && (strcmp(chr_l_mothinstrflg,"Y") != 0))
				strcpy(chr_l_newissue,"Y");

			else if ((strcmp(chr_l_newissue,"M") == 0) && (strcmp(chr_l_mothinstrflg,"Y") != 0))
				strcpy(chr_l_newissue,"M");

			if(strcmp(l_sys_dl_deal_struct_hb.h_countclt,APL_NULL_STRING)==0)
				strcpy(chr_l_cntac_acntof,l_sys_dl_deal_struct_hb.h_clientofcode);
			else
				strcpy(chr_l_cntac_acntof,l_sys_dl_deal_struct_hb.h_countclt);


			
			
			
			
			if((strcmp(l_sys_dl_deal_struct_hb.h_domcpclt_cd,l_mt_core_sys_params_struct_h.custody_clt_cd) != 0) && (strcmp(l_sys_dl_deal_struct_hb.h_dealcd, APL_DEAL_DVP) == 0))
			{		
				int_l_type_flg = 1;
				int_retval = CDBGenBrkEntryDVPTrFn(l_ptr_hbrokers_handoff_file, chr_l_cntac_acntof,chr_l_acc_cl_code, chr_l_instrcode_a, chr_l_newissue, l_sys_dl_deal_struct_hb.h_qty, dbl_l_amount_a, l_sys_dl_deal_struct_hb.h_setldt, l_sys_dl_deal_struct_hb.h_dl_client, l_sys_dl_deal_struct_hb.h_indentity_no, chr_l_incl_amt_flg, l_sys_dl_deal_struct_hb.h_dealcd, p_ptr_log_file,int_l_type_flg, p_intl_env_data_struct_h_d, l_debug_info_ptr);

				int_period_flg = 0;
				if ( CO_Chk_CcyConvDt("",&int_period_flg,l_debug_info_ptr) == APL_FAILURE )
				{
					APL_GOBACK_FAIL
				}
				if (int_period_flg ==1)
               {
					int_retval = CDBGenBrkEntryTrFn(l_ptr_broker_handoff_file,l_sys_dl_deal_struct_hb.h_dl_client,chr_l_acc_cl_code,chr_l_cntac_acntof,chr_l_instrcode_a,chr_l_newissue,l_sys_dl_deal_struct_hb.h_qty,p_ptr_log_file,int_l_type_flg,p_intl_env_data_struct_h_d,l_debug_info_ptr);

               
               strcpy(l_dl_clhcri_struct_h.h_sys_dt,chr_l_acri_sys_date); 

   				memset(chr_l_day,APL_NULL_CHAR,3);
   				memset(chr_l_month,APL_NULL_CHAR,3);
   				memset(chr_l_year,APL_NULL_CHAR,5);

   				chr_l_day[0] = l_sys_dl_deal_struct_hb.h_setldt[0];
   				chr_l_day[1] = l_sys_dl_deal_struct_hb.h_setldt[1];
   				chr_l_day[2] = '\0';

   				chr_l_month[0] = l_sys_dl_deal_struct_hb.h_setldt[3];
   				chr_l_month[1] = l_sys_dl_deal_struct_hb.h_setldt[4];
   				chr_l_month[2] = '\0';

   				chr_l_year[0] = l_sys_dl_deal_struct_hb.h_setldt[6];
   				chr_l_year[1] = l_sys_dl_deal_struct_hb.h_setldt[7];
   				chr_l_year[2] = l_sys_dl_deal_struct_hb.h_setldt[8];
   				chr_l_year[3] = l_sys_dl_deal_struct_hb.h_setldt[9];
   				chr_l_year[4] = '\0';

   				
					sprintf(chr_l_acri_set_date,"%s%s%s",chr_l_year,chr_l_month,chr_l_day);
               strcpy(l_dl_clhcri_struct_h.h_set_dt,chr_l_acri_set_date); 
               strcpy(l_dl_clhcri_struct_h.h_dl_client,l_sys_dl_deal_struct_hb.h_dl_client);
               memset(chr_l_clh_account,APL_NULL_CHAR,16); 
               EXEC SQL SELECT CLN_CLH INTO :chr_l_clh_account:i_clh_account FROM MT_CLIENT WHERE CLN_CODE = :l_sys_dl_deal_struct_hb.h_domcpclt_cd;
 					IS_ANY_ORA_ERROR ;

               strcpy(l_dl_clhcri_struct_h.h_clh_client,chr_l_clh_account);
					strcpy(l_dl_clhcri_struct_h.h_countclt,l_sys_dl_deal_struct_hb.h_countclt);

					memset(chr_l_isin,APL_NULL_CHAR,13);
					EXEC SQL SELECT INSTR_ISIN INTO :chr_l_isin:i_instr_isin FROM MT_INSTRUMENT WHERE INSTR_CODE = :l_sys_dl_deal_struct_hb.h_instr_code ;

					IS_ANY_ORA_ERROR ;
               strcpy(l_dl_clhcri_struct_h.h_instr_isin,chr_l_isin);

					l_dl_clhcri_struct_h.h_qty = l_sys_dl_deal_struct_hb.h_qty ;
               memset(chr_l_rep_qty,APL_NULL_CHAR,19); 
               CO_ToStr(l_sys_dl_deal_struct_hb.h_qty,15,3,chr_l_rep_qty);               
               int_pos = 0;
   				int_l_start = 0;

   					while (isspace(chr_l_rep_qty[int_pos]))
         					int_pos++;

   					while(chr_l_rep_qty[int_pos] != APL_NULL_CHAR)
         			l_quantity[int_l_start++] = chr_l_rep_qty[int_pos++];

 						l_quantity[int_l_start] = APL_NULL_CHAR;


   					strcpy(chr_l_qty1,".00");
						if (strchr(l_quantity,'.') != NULL)
						{
   						strcat(chr_l_qty1,strchr(l_quantity,'.') + 3);
							chr_l_qty1[4] = APL_NULL_CHAR;
						}
   					else
   						strcat(chr_l_qty1,APL_NULL_STRING);
               if (strcmp(chr_l_qty1,".000")!=0)
                  {
               		int_acri_seq_num++;
							l_dl_clhcri_struct_h.h_sequence_num = int_acri_seq_num;
               		int_retval = CDBGenCRIBrkEntryTrFn(l_ptr_cri_broker_handoff_file,l_dl_clhcri_struct_h,p_ptr_log_file,int_l_type_flg,p_intl_env_data_struct_h_d,l_debug_info_ptr); 
                  }
               

               }
			}
			else
			{
				if ((strcmp(l_sys_dl_deal_struct_hb.h_dealcd,APL_DEAL_DF)==0) && (strcmp(l_sys_dl_deal_struct_hb.h_domcpclt_cd,l_mt_core_sys_params_struct_h.custody_clt_cd) != 0)) 
				{
				int_l_type_flg = 2;
				int_retval = CDBGenBrkEntryTrFn(l_ptr_broker_handoff_file,l_sys_dl_deal_struct_hb.h_dl_client,chr_l_acc_cl_code,chr_l_cntac_acntof,chr_l_instrcode_a,chr_l_newissue,l_sys_dl_deal_struct_hb.h_qty,p_ptr_log_file,int_l_type_flg,p_intl_env_data_struct_h_d,l_debug_info_ptr);
              
               int_acri_seq_num++;
					l_dl_clhcri_struct_h.h_sequence_num = int_acri_seq_num;
               strcpy(l_dl_clhcri_struct_h.h_sys_dt,chr_l_acri_sys_date); 

   				memset(chr_l_day,APL_NULL_CHAR,3);
   				memset(chr_l_month,APL_NULL_CHAR,3);
   				memset(chr_l_year,APL_NULL_CHAR,5);

   				chr_l_day[0] = l_sys_dl_deal_struct_hb.h_setldt[0];
   				chr_l_day[1] = l_sys_dl_deal_struct_hb.h_setldt[1];
   				chr_l_day[2] = '\0';

   				chr_l_month[0] = l_sys_dl_deal_struct_hb.h_setldt[3];
   				chr_l_month[1] = l_sys_dl_deal_struct_hb.h_setldt[4];
   				chr_l_month[2] = '\0';

   				chr_l_year[0] = l_sys_dl_deal_struct_hb.h_setldt[6];
   				chr_l_year[1] = l_sys_dl_deal_struct_hb.h_setldt[7];
   				chr_l_year[2] = l_sys_dl_deal_struct_hb.h_setldt[8];
   				chr_l_year[3] = l_sys_dl_deal_struct_hb.h_setldt[9];
   				chr_l_year[4] = '\0';

   				
					sprintf(chr_l_acri_set_date,"%s%s%s",chr_l_year,chr_l_month,chr_l_day);
               strcpy(l_dl_clhcri_struct_h.h_set_dt,chr_l_acri_set_date); 
               strcpy(l_dl_clhcri_struct_h.h_dl_client,l_sys_dl_deal_struct_hb.h_dl_client);
               memset(chr_l_clh_account,APL_NULL_CHAR,16); 
               EXEC SQL SELECT CLN_CLH INTO :chr_l_clh_account:i_clh_account FROM MT_CLIENT WHERE CLN_CODE = :l_sys_dl_deal_struct_hb.h_domcpclt_cd;
 					IS_ANY_ORA_ERROR ;

               strcpy(l_dl_clhcri_struct_h.h_clh_client,chr_l_clh_account);
					strcpy(l_dl_clhcri_struct_h.h_countclt,l_sys_dl_deal_struct_hb.h_countclt);

					memset(chr_l_isin,APL_NULL_CHAR,13);
					EXEC SQL SELECT INSTR_ISIN INTO :chr_l_isin:i_instr_isin FROM MT_INSTRUMENT WHERE INSTR_CODE = :l_sys_dl_deal_struct_hb.h_instr_code ;

					IS_ANY_ORA_ERROR ;
               strcpy(l_dl_clhcri_struct_h.h_instr_isin,chr_l_isin);

					l_dl_clhcri_struct_h.h_qty = l_sys_dl_deal_struct_hb.h_qty ;

               int_retval = CDBGenCRIBrkEntryTrFn(l_ptr_cri_broker_handoff_file,l_dl_clhcri_struct_h,p_ptr_log_file,int_l_type_flg,p_intl_env_data_struct_h_d,l_debug_info_ptr); 


              
				}
			}

			if (int_retval != APL_SUCCESS)
				APL_GOBACK_FAIL
		
		}
		
		

		

		if (strcmp(chr_l_newissue,"N") == 0)
			strcpy(chr_l_newissue,"B");
		else if ((strcmp(chr_l_newissue,"Y") == 0) && (strcmp(chr_l_mothinstrflg,"Y") != 0))
			strcpy(chr_l_newissue,"Y");

		else if ((strcmp(chr_l_newissue,"M") == 0) && (strcmp(chr_l_mothinstrflg,"Y") != 0))
			strcpy(chr_l_newissue,"M");

		EXEC SQL SELECT EXCHGRT
       	INTO :l_exchgrt_a
         FROM MT_EXCHRATE
         WHERE CURRENCY_CD = :l_sys_dl_deal_struct_hb.h_currencycode
        		AND DENOM_CCY = :g_mt_commonsys_params_struct_h.dom_ccy
            AND RATE_DATE = (select MAX(RATE_DATE) from MT_EXCHRATE
            	where currency_cd =:l_sys_dl_deal_struct_hb.h_currencycode and DENOM_CCY=:g_mt_commonsys_params_struct_h.dom_ccy);


     	IS_ANY_ORA_ERROR

		memset(chr_l_trlamount, APL_NULL_CHAR, sizeof(chr_l_trlamount));
		if(sqlca.sqlcode != 1403)
		{
			l_dbltrlamount = l_exchgrt_a * l_sys_dl_deal_struct_hb.h_amt;
			sprintf(chr_l_trlamount, "%18.3lf", l_dbltrlamount);
		}
		else
		{
			sprintf(chr_l_trlamount, "%18.3lf", l_sys_dl_deal_struct_hb.h_amt);
		}
		
	}
	
	EXEC SQL CLOSE ClhTrInfo;

	if (strcmp(chr_l_gen_handoff_file_flg,"N") == 0)
	{
		EXEC SQL CLOSE TradeInfo11;
		EXEC SQL CLOSE TradeInfo21;
	}
	else if (strcmp(chr_l_gen_handoff_file_flg,"Y") == 0)
	{
		EXEC SQL CLOSE TradeInfo12;
		EXEC SQL CLOSE TradeInfo22;
	}

	EXEC SQL DELETE FROM DL_CLHTR;

	IS_ANY_ORA_ERROR


	


	

	

	if (int_l_err_cond == 1)
	{
		fprintf(l_clh_error_TR_rpt_file,"\n\n");
		for(i=0;i<135;i++)
			fprintf(l_clh_error_TR_rpt_file,"-");
	}

	APL_GOBACK_SUCCESS

	RETURN_SUCCESS :
	{
		if (strcmp(chr_l_gen_handoff_file_flg,"Y") == 0)
		{
			if((strcmp(chr_l_typeoffile, HANDOFF_NORMAL) == 0) || (strcmp(chr_l_typeoffile, HANDOFF_BOTH) == 0))
			{
				
				fclose(l_ptr_dc_handoff_file);
				fclose(l_ptr_cri_dc_handoff_file);
				fclose(l_ptr_broker_handoff_file);
				fclose(l_ptr_cri_broker_handoff_file);
			}
			if((strcmp(chr_l_typeoffile, HANDOFF_TRUE) == 0) || (strcmp(chr_l_typeoffile, HANDOFF_BOTH) == 0))
			{
				fclose(l_ptr_hrc_handoff_file);
				
				
				fclose(l_ptr_hbrokers_handoff_file);
			}
		}
		free(l_intl_rept_struct_ha);

		
		fclose(l_ptr_ini_file);

		
	

		

      

      int_retval = CO_Proc_RptClose(l_broker_DF_rpt_file,l_debug_info_ptr);

      if (int_retval != APL_SUCCESS)
         return(APL_FAILURE);

      int_retval = CO_Proc_RptClose(l_broker_RF_rpt_file,l_debug_info_ptr);

      if (int_retval != APL_SUCCESS)
         return(APL_FAILURE);

      int_retval = CO_Proc_RptClose(l_broker_DVP_rpt_file,l_debug_info_ptr);

      if (int_retval != APL_SUCCESS)
         return(APL_FAILURE);

      int_retval = CO_Proc_RptClose(l_broker_RVP_rpt_file,l_debug_info_ptr);

      if (int_retval != APL_SUCCESS)
         return(APL_FAILURE);
	
	
		if (int_l_err_cond == 1)
		{
			int_retval = CO_Proc_RptClose(l_clh_error_TR_rpt_file,l_debug_info_ptr);

			if (int_retval != APL_SUCCESS)
				return(APL_FAILURE);
		}
		
		CO_ProcMonitor(p_ptr_log_file,"Leaving processtion DL_Clh_DlFn successfully\n",NULL,p_intl_env_data_struct_h_d);

		return(APL_SUCCESS);
	}

	RETURN_FAILURE :
	{
		if (strcmp(chr_l_gen_handoff_file_flg,"Y") == 0)
		{
			if((strcmp(chr_l_typeoffile, HANDOFF_NORMAL) == 0) || (strcmp(chr_l_typeoffile, HANDOFF_BOTH) == 0))
			{
				
				fclose(l_ptr_dc_handoff_file);
				fclose(l_ptr_cri_dc_handoff_file);
				fclose(l_ptr_broker_handoff_file);
				fclose(l_ptr_cri_broker_handoff_file);
			}
			if((strcmp(chr_l_typeoffile, HANDOFF_TRUE) == 0) || (strcmp(chr_l_typeoffile, HANDOFF_BOTH) == 0))
			{
				fclose(l_ptr_hrc_handoff_file);
				
				
				fclose(l_ptr_hbrokers_handoff_file);
			}
		}
		free(l_intl_rept_struct_ha);
		
		
		fclose(l_ptr_ini_file);
		
		

	
		
	

      

      int_retval = CO_Proc_RptClose(l_broker_DF_rpt_file,l_debug_info_ptr);

      if (int_retval != APL_SUCCESS)
         return(APL_FAILURE);

      int_retval = CO_Proc_RptClose(l_broker_RF_rpt_file,l_debug_info_ptr);

      if (int_retval != APL_SUCCESS)
         return(APL_FAILURE);

      int_retval = CO_Proc_RptClose(l_broker_DVP_rpt_file,l_debug_info_ptr);

      if (int_retval != APL_SUCCESS)
         return(APL_FAILURE);

      int_retval = CO_Proc_RptClose(l_broker_RVP_rpt_file,l_debug_info_ptr);

      if (int_retval != APL_SUCCESS)
         return(APL_FAILURE);
	

		if (int_l_err_cond == 1)
		{
			int_retval = CO_Proc_RptClose(l_clh_error_TR_rpt_file,l_debug_info_ptr);

			if (int_retval != APL_SUCCESS)
				return(APL_FAILURE);
		}
		
		CO_ProcMonitor(p_ptr_log_file,"Leaving processtion DL_Clh_DlFn with failure\n",NULL,p_intl_env_data_struct_h_d);

		return(APL_FAILURE);
	}
}




int CDBRecsInClhTrFn(char *chr_p_client, char *p_instr_code, char *p_recdel, char *p_truedvp, FILE *p_ptr_log_file, char *p_typeofdeal,char *p_countclt, 
							INTL_ENV_DATA_STRUCT_H *p_intl_env_data_struct_h_d,
								DEBUG_INFO_STRUCT_H **l_debug_info_ptr)
{
	EXEC SQL BEGIN DECLARE SECTION;

	struct sqlca  sqlca;
	int			  int_l_num_rows = 0;

	EXEC SQL END DECLARE SECTION;

	CO_ProcMonitor(p_ptr_log_file,"Entered processtion CDBRecsInClhTrFn \n",NULL,p_intl_env_data_struct_h_d);

	sqlca.sqlcode = 0;

	EXEC SQL SELECT NVL(COUNT(*),0) INTO :int_l_num_rows
	FROM DL_CLHTR
	WHERE client = :chr_p_client
	AND   instr_code = :p_instr_code
	AND   REC_DEL = :p_recdel
	AND	ACT_DVP = :p_truedvp
	AND	dl_class = :p_typeofdeal
	AND	cp_clt	= :p_countclt;

	IS_ANY_ORA_ERROR

	if (int_l_num_rows == 0)
		APL_GOBACK_SUCCESS
	else
		APL_GOBACK_FAIL

	RETURN_SUCCESS :
	{
		CO_ProcMonitor(p_ptr_log_file,"Leaving processtion CDBRecsInClhTrFn successfully\n",NULL,p_intl_env_data_struct_h_d);

		return(APL_SUCCESS);
	}
	
	RETURN_FAILURE :
	{
		CO_ProcMonitor(p_ptr_log_file,"Leaving processtion CDBRecsInClhTrFn with failure\n",NULL,p_intl_env_data_struct_h_d);
		
		if (sqlca.sqlcode == 0)
			return(APL_RECS_EXIST);
		else
			return(APL_FAILURE);
	}
}





int CDBGenCAEntryTrFn(FILE *l_ptr_ca_handoff_file, FILE *p_ptr_log_file, INTL_ENV_DATA_STRUCT_H *p_intl_env_data_struct_h_d,  DEBUG_INFO_STRUCT_H **l_debug_info_ptr)
{
        char   chr_l_instrcode_a[9] = APL_NULL_STRING;
        char   chr_l_instrgroup[3] = APL_NULL_STRING;
        char   chr_l_client_a[11] = APL_NULL_STRING;
        double  l_takeupquantity = 0.0;
        char   chr_l_gendate[APL_DATE_LEN] = APL_NULL_STRING;
		  char   chr_l_ca_id[21] = APL_NULL_STRING;
		  char   chr_l_instrcode_displayed[9] = APL_NULL_STRING;
 	  	  char   chr_l_instrgroup_displayed[3] = APL_NULL_STRING;		
        char   chr_l_rowid_A[19] =APL_NULL_STRING;

        short i_instr_code		= 0;
        short i_instrgroup	= 0;
        short i_dl_client		= 0;
        short i_takeupquantity	= 0;
        short i_ora_rowid		= 0;
        short i_gendate		= 0;
		  short i_corp_id      = 0;
        short i_instr_code_displayed  = 0;
        short i_instrgroup_displayed  = 0;
	
        EXEC SQL VAR chr_l_instrcode_a IS STRING;
        EXEC SQL VAR chr_l_instrgroup IS STRING;
        EXEC SQL VAR chr_l_client_a IS STRING;
        EXEC SQL VAR chr_l_rowid_A IS STRING;
        EXEC SQL VAR chr_l_gendate IS STRING;
		  EXEC SQL VAR chr_l_ca_id IS STRING;
        EXEC SQL VAR chr_l_instrcode_displayed IS STRING;
        EXEC SQL VAR chr_l_instrgroup_displayed IS STRING;	

		  memset(chr_l_instrcode_a,APL_NULL_CHAR,sizeof(chr_l_instrcode_a));
        memset(chr_l_instrgroup,APL_NULL_CHAR,sizeof(chr_l_instrgroup));
        memset(chr_l_client_a,APL_NULL_CHAR,sizeof(chr_l_client_a));
        memset(chr_l_rowid_A,APL_NULL_CHAR,sizeof(chr_l_rowid_A));
        memset(chr_l_gendate,APL_NULL_CHAR,sizeof(chr_l_gendate));
        memset(chr_l_ca_id,APL_NULL_CHAR,sizeof(chr_l_ca_id));
        memset(chr_l_instrcode_displayed,APL_NULL_CHAR,sizeof(chr_l_instrcode_displayed));
        memset(chr_l_instrgroup_displayed,APL_NULL_CHAR,sizeof(chr_l_instrgroup_displayed));	
        
		  if(APL_FAILURE == CO_RtvSysDt(chr_l_gendate,l_debug_info_ptr))
        {
            printf("Error in getting date");
            APL_GOBACK_FAIL
        }

	EXEC SQL DECLARE TradeInfoCA CURSOR FOR
             SELECT b.instr_code, b.NEW_ISSUE, a.client, a.TAKEUP_QUANTITY, a.corp_id,a.rowid
             FROM CARTSPROC a, MT_INSTRUMENT b
                        WHERE (a.INSTR_PARENT = b.instr_code
                        AND a.CA_EVENT = 'RL'
                        AND a.STATUS = 'UU' AND a.TAKEUP_QUANTITY >0
                        AND a.TRANS_DATE IS NULL)
                        ORDER BY a.instr_code
             FOR UPDATE OF a.access_stamp, a.TRANS_DATE;

	IS_ANY_ORA_ERROR
        
	EXEC SQL OPEN TradeInfoCA;

        IS_ANY_ORA_ERROR


        for(;;)
        {
					l_takeupquantity =0.0;
                EXEC SQL FETCH TradeInfoCA INTO :chr_l_instrcode_a:i_instr_code, :chr_l_instrgroup:i_instrgroup, :chr_l_client_a:i_dl_client, :l_takeupquantity:i_takeupquantity, :chr_l_ca_id:i_corp_id,:chr_l_rowid_A:i_ora_rowid;

                IS_ANY_ORA_ERROR
		printf("l_takeupqty is %lf \n",l_takeupquantity);
		printf("l_takeupqty is %f \n",l_takeupquantity);
		printf("l_takeupqty is %.3lf \n",l_takeupquantity);
		printf("l_takeupqty is %.3f \n",l_takeupquantity);
                if (APL_ZERO_RESULT_SET)
                        break;

					 EXEC SQL SELECT instr_code into :chr_l_instrcode_displayed:i_instr_code_displayed from CAEVENT where corp_id=:chr_l_ca_id ;
                IS_ANY_ORA_ERROR

                EXEC SQL SELECT NEW_ISSUE into :chr_l_instrgroup_displayed:i_instrgroup_displayed from MT_INSTRUMENT where instr_code=:chr_l_instrcode_displayed ;
                IS_ANY_ORA_ERROR
	
					 if (strcmp(chr_l_instrgroup_displayed, "N") == 0)
                        strcpy(chr_l_instrgroup_displayed, "E");

            

            

               fprintf(l_ptr_ca_handoff_file, "%s,%s,CIY,%s,30,%.3lf,\n", chr_l_instrcode_displayed, chr_l_instrgroup_displayed, chr_l_client_a, l_takeupquantity);	

                EXEC SQL UPDATE CARTSPROC
                        SET  access_stamp = :chr_l_gendate:i_gendate,
                             trans_date   = :chr_l_gendate:i_gendate
                        WHERE rowid = :chr_l_rowid_A;

                IS_ANY_ORA_ERROR
        }
        
	EXEC SQL CLOSE TradeInfoCA;
        IS_ANY_ORA_ERROR

        RETURN_SUCCESS :
        {
          CO_ProcMonitor(p_ptr_log_file,"Leaving processtion CDBGenCAEntryTrFn successfully\n",NULL,p_intl_env_data_struct_h_d);
          return(APL_SUCCESS);
        }

        RETURN_FAILURE :
        {
          CO_ProcMonitor(p_ptr_log_file,"Leaving processtion CDBGenCAEntryTrFn with failure\n",NULL,p_intl_env_data_struct_h_d);
          return(APL_FAILURE);
        }

}





int CDBGenClEntryTrFn(FILE *p_ptr_clh_tr_file, char *chr_p_client,char *p_countclt,char *p_dbcltt, char *p_instr_code, char *p_newissue, char *p_crcltt, double p_quantity, char *p_conf_date, char *p_recdel, char *p_typeofdeal,double chr_p_amount,FILE *p_ptr_log_file, INTL_ENV_DATA_STRUCT_H *p_intl_env_data_struct_h_d, DEBUG_INFO_STRUCT_H **l_debug_info_ptr)
{
	struct sqlca  sqlca;
	char			  chr_l_instr_parent[9];
	short			  i_instr_parent;
	char			  chr_l_mothinstrflg[2];
	short			  i_mother_sec_ind;
	char			  chr_l_conf_dt[APL_DATE_LEN];
	char			  chr_l_date[11];
	char			  chr_l_rep_outqty[QUANTITY_LEN+1] = APL_NULL_STRING;
	char			  l_quantity[QUANTITY_LEN+1] = APL_NULL_STRING;
	int			  int_l_start = 0;
	int			  i = 0;
	char			  chr_l_citibank_free_acct[3];
	char			  chr_l_acct_num[2];
	double		  dbl_l_amount_a;
	char			  chr_l_h_amount[66];
   char          chr_l_amount_buf[AMOUNT_LEN_A+1] = APL_NULL_STRING;
   char          chr_l_dec_buf[4] = APL_NULL_STRING;
   char          chr_l_amount_buf1[AMOUNT_LEN_A+1] = APL_NULL_STRING;
   char          chr_l_amount_buf_int[16] = APL_NULL_STRING;
	char			  *chr_l_ptr_decimal = NULL;

	
	EXEC SQL VAR chr_l_instr_parent IS STRING;
	

	CO_ProcMonitor(p_ptr_log_file,"Entered processtion CDBGenClEntryTrFn \n",NULL,p_intl_env_data_struct_h_d);
	
	sqlca.sqlcode = 0;

	EXEC SQL SELECT MOTHER_SEC_IND,INSTR_PARENT
	INTO :chr_l_mothinstrflg:i_mother_sec_ind,:chr_l_instr_parent:i_instr_parent
	FROM MT_INSTRUMENT
	WHERE instr_code = :p_instr_code;

	IS_ANY_ORA_ERROR_AND_ZERO_RESULTSET(ERR_REC_NOTFND,APL_NULL_STRING,APL_NULL_STRING,APL_NULL_STRING)

	if (strcmp(chr_l_mothinstrflg,"N") == 0)
		strcpy(p_instr_code,chr_l_instr_parent);

	strcpy(chr_l_conf_dt,p_conf_date);

	chr_l_date[0] = chr_l_conf_dt[0];
	chr_l_date[1] = chr_l_conf_dt[1];
	chr_l_date[2] = chr_l_conf_dt[2];
	chr_l_date[3] = chr_l_conf_dt[3];
	chr_l_date[4] = chr_l_conf_dt[4];
	chr_l_date[5] = chr_l_conf_dt[5];
	chr_l_date[6] = chr_l_conf_dt[6];
	chr_l_date[7] = chr_l_conf_dt[7];
	chr_l_date[8] = chr_l_conf_dt[8];
	chr_l_date[9] = chr_l_conf_dt[9];
	chr_l_date[10] = '\0';

	CO_ToStr(p_quantity,QUANTITY_LEN,3,chr_l_rep_outqty);

	
	
	while (isspace(chr_l_rep_outqty[i]))
		i++;
	
	while(chr_l_rep_outqty[i] != APL_NULL_CHAR)
		l_quantity[int_l_start++] = chr_l_rep_outqty[i++];

	l_quantity[int_l_start] = APL_NULL_CHAR;

	strcpy(chr_l_citibank_free_acct,"30");
	strcpy(chr_l_acct_num,"0");

	

	
	sprintf(chr_l_h_amount,"%f",chr_p_amount);

	printf("%f,****%s\n",chr_p_amount,chr_l_h_amount);
   strcpy(chr_l_amount_buf,chr_l_h_amount);

   chr_l_ptr_decimal = strchr(chr_l_amount_buf,'.');
	if (chr_l_ptr_decimal != NULL)
   	strncpy(chr_l_dec_buf,chr_l_ptr_decimal,3);
   else
   	strcpy(chr_l_dec_buf,APL_NULL_STRING);
	chr_l_dec_buf[3] = APL_NULL_CHAR;
	printf("l_dec_buf is%s\n",chr_l_dec_buf);

	int_l_start = 0;
	i = 0;
   while(chr_l_amount_buf[int_l_start] != '.')
      chr_l_amount_buf_int[i++] = chr_l_amount_buf[int_l_start++];

   chr_l_amount_buf_int[i] = APL_NULL_CHAR;
	printf("l_amount_buf_int is%s\n",chr_l_amount_buf_int);

   strcpy(chr_l_amount_buf1,chr_l_amount_buf_int);
   strcat(chr_l_amount_buf1,chr_l_dec_buf);
	printf("l_amount_buf1 is%s\n",chr_l_amount_buf1);

	
	
			
			
		
			fprintf(p_ptr_clh_tr_file,"CIY,%s,30,%s,%s,%s,%s,30,%s,,,\n",chr_p_client,chr_l_date,p_instr_code,p_newissue,p_countclt,l_quantity);
	

	RETURN_SUCCESS :
	{
		CO_ProcMonitor(p_ptr_log_file,"Leaving processtion CDBGenClEntryTrFn successfully\n",NULL,p_intl_env_data_struct_h_d);

		return(APL_SUCCESS);
	}
	
	RETURN_FAILURE :
	{
		CO_ProcMonitor(p_ptr_log_file,"Leaving processtion CDBGenClEntryTrFn with failure\n",NULL,p_intl_env_data_struct_h_d);
	
		return(APL_FAILURE);
	}
}



int CDBGenBrkEntryTrFn(FILE *p_ptr_clh_tr_file,char *chr_p_client,char *p_dbcltt,char *p_countclt,char *p_instr_code,char *p_newissue,double p_quantity,FILE *p_ptr_log_file,int p_flg_typ_file,INTL_ENV_DATA_STRUCT_H *p_intl_env_data_struct_h_d,DEBUG_INFO_STRUCT_H **l_debug_info_ptr)
{
	struct sqlca  sqlca;
	char			  chr_l_instr_parent[9];
	short			  i_instr_parent;
	char			  chr_l_mothinstrflg[2];
	short			  i_mother_sec_ind;
	char			  chr_l_date[11];
	char			  chr_l_rep_outqty[QUANTITY_LEN+1] = APL_NULL_STRING;
	char			  *chr_l_ptr_decimal = NULL;
	char			  chr_l_amount_buf[AMOUNT_LEN_A+1] = APL_NULL_STRING;
	char			  chr_l_dec_buf[4] = APL_NULL_STRING;
	char			  chr_l_amount_buf1[AMOUNT_LEN_A+1] = APL_NULL_STRING;
	char			  chr_l_amount_buf_int[16] = APL_NULL_STRING;
	int			  int_l_start = 0;
	int			  i = 0;
	char			  l_quantity[QUANTITY_LEN+1] = APL_NULL_STRING;
	char          chr_l_cp_tksbnk_dtl_acc[3] = APL_NULL_STRING;
	char          chr_l_qty1[5] = APL_NULL_STRING;
	int 			  int_period_flg = 0;

	
   EXEC SQL VAR chr_l_instr_parent IS STRING;
   

	CO_ProcMonitor(p_ptr_log_file,"Entered processtion CDBGenBrkEntryTrFn \n",NULL,p_intl_env_data_struct_h_d);
	
	sqlca.sqlcode = 0;

	EXEC SQL SELECT MOTHER_SEC_IND,INSTR_PARENT
	INTO :chr_l_mothinstrflg:i_mother_sec_ind,:chr_l_instr_parent:i_instr_parent
	FROM MT_INSTRUMENT
	WHERE instr_code = :p_instr_code;

	IS_ANY_ORA_ERROR_AND_ZERO_RESULTSET(ERR_REC_NOTFND,APL_NULL_STRING,APL_NULL_STRING,APL_NULL_STRING)

	if (strcmp(chr_l_mothinstrflg,"N") == 0)
		strcpy(p_instr_code,chr_l_instr_parent);
	
	CO_ToStr(p_quantity,QUANTITY_LEN,3,chr_l_rep_outqty);
	
	i = 0;
	int_l_start = 0;
		 
	
	
	while (isspace(chr_l_rep_outqty[i]))
		i++;
	
	while(chr_l_rep_outqty[i] != APL_NULL_CHAR)
		l_quantity[int_l_start++] = chr_l_rep_outqty[i++];

	l_quantity[int_l_start] = APL_NULL_CHAR;

	strcpy(chr_l_qty1,".00");

	if (strchr(l_quantity,'.') != NULL)
	{		
		strcat(chr_l_qty1,strchr(l_quantity,'.') + 3);
		chr_l_qty1[4] = APL_NULL_CHAR;
	}
	else
		strcat(chr_l_qty1,APL_NULL_STRING);


	

	

	

	
   if( strlen(p_countclt)== 0)
   {
      strcpy(chr_l_cp_tksbnk_dtl_acc,"");
   }
   else
   {
      strcpy(chr_l_cp_tksbnk_dtl_acc,"30");
   }
   

	if ((p_flg_typ_file==1) && (strcmp(chr_l_qty1,".000")!=0))
	{
		fprintf(p_ptr_clh_tr_file,"%s,30,%s,%s,%s,%s,%s,%s,,,\n",chr_p_client,p_instr_code,p_newissue,chr_l_qty1,p_dbcltt,p_countclt,chr_l_cp_tksbnk_dtl_acc);
	}
	else if (p_flg_typ_file==2)
	{
		fprintf(p_ptr_clh_tr_file,"%s,30,%s,%s,%s,%s,%s,%s,,,\n",chr_p_client,p_instr_code,p_newissue,l_quantity,p_dbcltt,p_countclt,chr_l_cp_tksbnk_dtl_acc);
	}
							

	RETURN_SUCCESS :
	{
		CO_ProcMonitor(p_ptr_log_file,"Leaving processtion CDBGenBrkEntryTrFn successfully\n",NULL,p_intl_env_data_struct_h_d);

		return(APL_SUCCESS);
	}
	
	RETURN_FAILURE :
	{
		CO_ProcMonitor(p_ptr_log_file,"Leaving processtion CDBGenBrkEntryTrFn with failure\n",NULL,p_intl_env_data_struct_h_d);
	
		return(APL_FAILURE);
	}
}



int WriteCustReportHeaderForTrFn(FILE *p_ptr_clh_rpt_file,int p_page_no,FILE *p_ptr_log_file,INTL_ENV_DATA_STRUCT_H *p_intl_env_data_struct_h_d,DEBUG_INFO_STRUCT_H **l_debug_info_ptr)
{
	struct sqlca  sqlca;
	char			  chr_l_sys_date[9];
	int			  i;
	char			  chr_l_corp_name[41];
	short			  i_ca_clr_name;

	EXEC SQL VAR chr_l_sys_date IS STRING;
	EXEC SQL VAR chr_l_corp_name IS STRING;

	CO_ProcMonitor(p_ptr_log_file,"Entered processtion WriteCustReportHeaderForTrFn\n",NULL,p_intl_env_data_struct_h_d);
	
	sqlca.sqlcode = 0;

	EXEC SQL SELECT TO_CHAR(SYS_DATE,'DD/MM/YY')
	INTO :chr_l_sys_date
	FROM PRO_SYS_DATE;

	IS_ANY_ORA_ERROR_AND_ZERO_RESULTSET(ERR_DATE_NOT_SET,APL_NULL_STRING,APL_NULL_STRING,APL_NULL_STRING)

	EXEC SQL SELECT ca_identname
	INTO :chr_l_corp_name:i_ca_clr_name
	FROM MT_COMMON_SYS_PARAMS;

	IS_ANY_ORA_ERROR_AND_ZERO_RESULTSET(ERR_REC_NOTFND,APL_NULL_STRING,APL_NULL_STRING,APL_NULL_STRING)

	fprintf(p_ptr_clh_rpt_file,"\n");

	for (i=0;i<135;i++)
		fprintf(p_ptr_clh_rpt_file,"-");

	fprintf(p_ptr_clh_rpt_file,"\n%s         CLEARING HOUSE HAND-OFF FILE REPORT                        Page %d\n",chr_l_sys_date,p_page_no);

	fprintf(p_ptr_clh_rpt_file,"                           %s\n\n",chr_l_corp_name);

	fprintf(p_ptr_clh_rpt_file,"                  Customer Hand-off File Details \n\n");
	
	for (i=0;i<135;i++)
		fprintf(p_ptr_clh_rpt_file,"-");

	fprintf(p_ptr_clh_rpt_file,"\nCustomer      Clh. Code         Instrurity    Mkt. Code  Pre-Matched                        Quantity       Rec/Del\n\n");
	
	for (i=0;i<135;i++)
		fprintf(p_ptr_clh_rpt_file,"-");
	
	fprintf(p_ptr_clh_rpt_file,"\n");

	APL_GOBACK_SUCCESS

	RETURN_SUCCESS :
	{
		CO_ProcMonitor(p_ptr_log_file,"Leaving processtion WriteCustReportHeaderForTrFn successfully\n",NULL,p_intl_env_data_struct_h_d);

		return(APL_SUCCESS);
	}
	
	RETURN_FAILURE :
	{
		CO_ProcMonitor(p_ptr_log_file,"Leaving processtion WriteCustReportHeaderForTrFn with failure \n",NULL,p_intl_env_data_struct_h_d);
	
		return(APL_FAILURE);
	}
}



int WriteBrokReportHeaderForTrFn(FILE *p_ptr_clh_rpt_file,int p_page_no, int p_reptype, FILE *p_ptr_log_file,INTL_ENV_DATA_STRUCT_H *p_intl_env_data_struct_h_d,DEBUG_INFO_STRUCT_H **l_debug_info_ptr)
{
	struct sqlca  sqlca;
	char			  chr_l_sys_date[9];
	int			  i;
	char			  chr_l_corp_name[41];
	short			  i_ca_clr_name;

	EXEC SQL VAR chr_l_sys_date IS STRING;
	EXEC SQL VAR chr_l_corp_name IS STRING;

	CO_ProcMonitor(p_ptr_log_file,"Entered processtion WriteBrokReportHeaderForTrFn\n",NULL,p_intl_env_data_struct_h_d);
	
	sqlca.sqlcode = 0;

	EXEC SQL SELECT TO_CHAR(SYS_DATE,'DD/MM/YY')
	INTO :chr_l_sys_date
	FROM PRO_SYS_DATE;

	IS_ANY_ORA_ERROR_AND_ZERO_RESULTSET(ERR_DATE_NOT_SET,APL_NULL_STRING,APL_NULL_STRING,APL_NULL_STRING)

	EXEC SQL SELECT ca_identname
	INTO :chr_l_corp_name:i_ca_clr_name
	FROM MT_COMMON_SYS_PARAMS;

	IS_ANY_ORA_ERROR_AND_ZERO_RESULTSET(ERR_REC_NOTFND,APL_NULL_STRING,APL_NULL_STRING,APL_NULL_STRING)

	fprintf(p_ptr_clh_rpt_file,"\n");

	for (i=0;i<158;i++)
		fprintf(p_ptr_clh_rpt_file,"-");

	fprintf(p_ptr_clh_rpt_file,"\n%s         CLEARING HOUSE HAND-OFF FILE REPORT                          Page %d\n",chr_l_sys_date,p_page_no);

	fprintf(p_ptr_clh_rpt_file,"                          %s\n\n",chr_l_corp_name);

	if(1 == p_reptype)
		fprintf(p_ptr_clh_rpt_file,"                    Broker Hand-off File Details \n\n\n");
	else
		fprintf(p_ptr_clh_rpt_file,"                Broker Receive Hand-off File Details \n\n\n");
		

	for (i=0;i<158;i++)
		fprintf(p_ptr_clh_rpt_file,"-");

	fprintf(p_ptr_clh_rpt_file,"\nBroker        Clh. Code         Reference No.       Instrurity   Mkt. Code   Pre-Matched    Trade Code                     Quantity%22s \n", "Amount");

	fprintf(p_ptr_clh_rpt_file,"\n");
	
	for (i=0;i<158;i++)
		fprintf(p_ptr_clh_rpt_file,"-");
	
	fprintf(p_ptr_clh_rpt_file,"\n");

	APL_GOBACK_SUCCESS

	RETURN_SUCCESS :
	{
		CO_ProcMonitor(p_ptr_log_file,"Leaving processtion WriteBrokReportHeaderForTrFn successfully\n",NULL,p_intl_env_data_struct_h_d);

		return(APL_SUCCESS);
	}
	
	RETURN_FAILURE :
	{
		CO_ProcMonitor(p_ptr_log_file,"Leaving processtion WriteBrokReportHeaderForTrFn with failure \n",NULL,p_intl_env_data_struct_h_d);
	
		return(APL_FAILURE);
	}
}



int WriteErrorReportHeaderForTrFn(FILE *p_ptr_clh_rpt_file,int p_page_no,FILE *p_ptr_log_file,INTL_ENV_DATA_STRUCT_H *p_intl_env_data_struct_h_d,DEBUG_INFO_STRUCT_H **l_debug_info_ptr)
{
	struct sqlca  sqlca;
	char			  chr_l_sys_date[9];
	int			  i;
	char			  chr_l_corp_name[41];
	short			  i_ca_clr_name;

	EXEC SQL VAR chr_l_sys_date IS STRING;
	EXEC SQL VAR chr_l_corp_name IS STRING;

	CO_ProcMonitor(p_ptr_log_file,"Entered processtion WriteErrorReportHeaderForTrFn\n",NULL,p_intl_env_data_struct_h_d);
	
	sqlca.sqlcode = 0;

	EXEC SQL SELECT TO_CHAR(SYS_DATE,'DD/MM/YY')
	INTO :chr_l_sys_date
	FROM PRO_SYS_DATE;

	IS_ANY_ORA_ERROR_AND_ZERO_RESULTSET(ERR_DATE_NOT_SET,APL_NULL_STRING,APL_NULL_STRING,APL_NULL_STRING)

	EXEC SQL SELECT ca_identname
	INTO :chr_l_corp_name:i_ca_clr_name
	FROM MT_COMMON_SYS_PARAMS;

	IS_ANY_ORA_ERROR_AND_ZERO_RESULTSET(ERR_REC_NOTFND,APL_NULL_STRING,APL_NULL_STRING,APL_NULL_STRING)

	fprintf(p_ptr_clh_rpt_file,"\n");

	for (i=0;i<135;i++)
		fprintf(p_ptr_clh_rpt_file,"-");

	fprintf(p_ptr_clh_rpt_file,"\n%s         CLEARING HOUSE ERROR REPORT                                Page %d\n",chr_l_sys_date,p_page_no);

	fprintf(p_ptr_clh_rpt_file,"                       %s\n\n",chr_l_corp_name);
	
	fprintf(p_ptr_clh_rpt_file,"                      Error File Details \n\n\n");
	for(i=0;i<135;i++)
		fprintf(p_ptr_clh_rpt_file,"-");

	fprintf(p_ptr_clh_rpt_file,"\nAccount       Reference No.           Error Details     \n\n");
	for (i=0;i<135;i++)
		fprintf(p_ptr_clh_rpt_file,"-");

	fprintf(p_ptr_clh_rpt_file,"\n");

	APL_GOBACK_SUCCESS

	RETURN_SUCCESS :
	{
		CO_ProcMonitor(p_ptr_log_file,"Leaving processtion WriteErrorReportHeaderForTrFn successfully\n",NULL,p_intl_env_data_struct_h_d);

		return(APL_SUCCESS);
	}
	
	RETURN_FAILURE :
	{
		CO_ProcMonitor(p_ptr_log_file,"Leaving processtion WriteErrorReportHeaderForTrFn with failure \n",NULL,p_intl_env_data_struct_h_d);
	
		return(APL_FAILURE);
	}
}



int WriteCustReportDetailsForTrFn(FILE *p_ptr_clh_rpt_file,char *chr_p_client,char *p_clhclient,char *p_instr_code,char *p_newissue,char *p_conf_date,double p_quantity,char *p_recdel,FILE *p_ptr_log_file,INTL_ENV_DATA_STRUCT_H *p_intl_env_data_struct_h_d,DEBUG_INFO_STRUCT_H **l_debug_info_ptr)
{
	struct sqlca  sqlca;
	char			  chr_l_instr_parent[9];
	short			  i_instr_parent;
	char			  chr_l_mothinstrflg[2];
	short			  i_mother_sec_ind;
	char			  chr_l_conf_dt[APL_DATE_LEN];
	char			  chr_l_date[9];
	char          chr_l_desc[30];
	char			  chr_l_rep_outqty[QUANTITY_LEN+1] = APL_NULL_STRING;
	int           int_period_flg = 0;
	
	
	EXEC SQL VAR chr_l_instr_parent IS STRING;
	

	CO_ProcMonitor(p_ptr_log_file,"Entered processtion WriteCustReportDetailsForTrFn\n",NULL,p_intl_env_data_struct_h_d);
	
	sqlca.sqlcode = 0;

	EXEC SQL SELECT MOTHER_SEC_IND,INSTR_PARENT
	INTO :chr_l_mothinstrflg:i_mother_sec_ind,:chr_l_instr_parent:i_instr_parent
	FROM MT_INSTRUMENT
	WHERE instr_code = :p_instr_code;

	IS_ANY_ORA_ERROR_AND_ZERO_RESULTSET(ERR_REC_NOTFND,APL_NULL_STRING,APL_NULL_STRING,APL_NULL_STRING)

	if (strcmp(chr_l_mothinstrflg,"N") == 0)
		strcpy(p_instr_code,chr_l_instr_parent);

	strcpy(chr_l_conf_dt,p_conf_date);

	chr_l_date[0] = chr_l_conf_dt[0];
	chr_l_date[1] = chr_l_conf_dt[1];
	chr_l_date[2] = chr_l_conf_dt[2];
	chr_l_date[3] = chr_l_conf_dt[3];
	chr_l_date[4] = chr_l_conf_dt[4];
	chr_l_date[5] = chr_l_conf_dt[5];
	chr_l_date[6] = chr_l_conf_dt[8];
	chr_l_date[7] = chr_l_conf_dt[9];
	chr_l_date[8] = '\0';

	if (strcmp(p_recdel,"0") == 0)
		strcpy(chr_l_desc,"DEL");
	else 
		strcpy(chr_l_desc,"REC");

	CO_ToStr(p_quantity,QUANTITY_LEN,2,chr_l_rep_outqty);

   int_period_flg = 0;

   if ( CO_Chk_CcyConvDt("",&int_period_flg,l_debug_info_ptr) == APL_FAILURE )
               {
                  APL_GOBACK_FAIL
               }

   if (int_period_flg == 1)
      //fprintf(p_ptr_clh_rpt_file,"%-14s%-18s%-12s%-11s%-20s%.3f%5s%-7s\n\n",chr_p_client,p_clhclient,p_instr_code,p_newissue,chr_l_date,p_quantity,' ',chr_l_desc);Changes done for AIX Migration
      fprintf(p_ptr_clh_rpt_file,"%-14s%-18s%-12s%-11s%-20s%.3f%c%-7s\n\n",chr_p_client,p_clhclient,p_instr_code,p_newissue,chr_l_date,p_quantity,' ',chr_l_desc);
   else
		//fprintf(p_ptr_clh_rpt_file,"%-14s%-18s%-12s%-11s%-20s%s%5s%-7s\n\n",chr_p_client,p_clhclient,p_instr_code,p_newissue,chr_l_date,chr_l_rep_outqty,' ',chr_l_desc); Changes done for AIX Migration
		fprintf(p_ptr_clh_rpt_file,"%-14s%-18s%-12s%-11s%-20s%s%c%-7s\n\n",chr_p_client,p_clhclient,p_instr_code,p_newissue,chr_l_date,chr_l_rep_outqty,' ',chr_l_desc);

	APL_GOBACK_SUCCESS

	RETURN_SUCCESS :
	{
		CO_ProcMonitor(p_ptr_log_file,"Leaving processtion WriteCustReportDetailsForTrFn successfully\n",NULL,p_intl_env_data_struct_h_d);

		return(APL_SUCCESS);
	}
	
	RETURN_FAILURE :
	{
		CO_ProcMonitor(p_ptr_log_file,"Leaving processtion WriteCustReportDetailsForTrFn with failure \n",NULL,p_intl_env_data_struct_h_d);
	
		return(APL_FAILURE);
	}
}



int WriteBrokReportDetailsForTrFn(FILE *p_ptr_clh_rpt_file,char *p_domcpac,char *p_clhclient,char *chr_p_refno,char *p_instr_code,char *p_newissue,char *p_conf_date,char *p_dealcd,double p_quantity, char *chr_p_amount, FILE *p_ptr_log_file,INTL_ENV_DATA_STRUCT_H *p_intl_env_data_struct_h_d,DEBUG_INFO_STRUCT_H **l_debug_info_ptr)
{
	struct sqlca  sqlca;
	char			  chr_l_instr_parent[9];
	short			  i_instr_parent;
	char			  chr_l_mothinstrflg[2];
	short			  i_mother_sec_ind;
	char			  chr_l_conf_dt[APL_DATE_LEN];
	char			  chr_l_date[9];
	char          chr_l_desc[30];
	char			  chr_l_rep_outqty[QUANTITY_LEN+1] = APL_NULL_STRING;
	int           int_period_flg = 0;

	
   EXEC SQL VAR chr_l_instr_parent IS STRING;
   

	CO_ProcMonitor(p_ptr_log_file,"Entered processtion WriteBrokReportDetailsForTrFn\n",NULL,p_intl_env_data_struct_h_d);
	
	sqlca.sqlcode = 0;
	
	EXEC SQL SELECT MOTHER_SEC_IND,INSTR_PARENT
	INTO :chr_l_mothinstrflg:i_mother_sec_ind,:chr_l_instr_parent:i_instr_parent
	FROM MT_INSTRUMENT
	WHERE instr_code = :p_instr_code;

	IS_ANY_ORA_ERROR_AND_ZERO_RESULTSET(ERR_REC_NOTFND,APL_NULL_STRING,APL_NULL_STRING,APL_NULL_STRING)

	if (strcmp(chr_l_mothinstrflg,"N") == 0)
		strcpy(p_instr_code,chr_l_instr_parent);

	strcpy(chr_l_conf_dt,p_conf_date);

	chr_l_date[0] = chr_l_conf_dt[0];
	chr_l_date[1] = chr_l_conf_dt[1];
	chr_l_date[2] = chr_l_conf_dt[2];
	chr_l_date[3] = chr_l_conf_dt[3];
	chr_l_date[4] = chr_l_conf_dt[4];
	chr_l_date[5] = chr_l_conf_dt[5];
	chr_l_date[6] = chr_l_conf_dt[8];
	chr_l_date[7] = chr_l_conf_dt[9];
	chr_l_date[8] = '\0';

	if (strcmp(p_dealcd,"1") == 0)
		strcpy(chr_l_desc,"DF");
	else if (strcmp(p_dealcd,"2") == 0)
		strcpy(chr_l_desc,"RF");
	else if (strcmp(p_dealcd,"3") == 0)
		strcpy(chr_l_desc,"DVP");
	else if (strcmp(p_dealcd,"4") == 0)
		strcpy(chr_l_desc,"RVP");

	CO_ToStr(p_quantity,QUANTITY_LEN,2,chr_l_rep_outqty);

   int_period_flg = 0;

   if ( CO_Chk_CcyConvDt("",&int_period_flg,l_debug_info_ptr) == APL_FAILURE )
               {
                  APL_GOBACK_FAIL
               }

   if (int_period_flg == 1)
      fprintf(p_ptr_clh_rpt_file,"%-14s%-18s%-20s%-11s%-12s%-15s%-12s%27.3f%22s \n\n",p_domcpac,p_clhclient,chr_p_refno,p_instr_code,p_newissue,chr_l_date,chr_l_desc,p_quantity, chr_p_amount);
   else
		fprintf(p_ptr_clh_rpt_file,"%-14s%-18s%-20s%-11s%-12s%-15s%-12s%27s%22s \n\n",p_domcpac,p_clhclient,chr_p_refno,p_instr_code,p_newissue,chr_l_date,chr_l_desc,chr_l_rep_outqty, chr_p_amount);

	APL_GOBACK_SUCCESS

	RETURN_SUCCESS :
	{
		CO_ProcMonitor(p_ptr_log_file,"Leaving processtion WriteBrokReportDetailsForTrFn successfully\n",NULL,p_intl_env_data_struct_h_d);

		return(APL_SUCCESS);
	}
	
	RETURN_FAILURE :
	{
		CO_ProcMonitor(p_ptr_log_file,"Leaving processtion WriteBrokReportDetailsForTrFn with failure \n",NULL,p_intl_env_data_struct_h_d);
	
		return(APL_FAILURE);
	}
}



int WriteErrorReportDetailsForTrFn(FILE *p_ptr_clh_rpt_file,char *chr_p_client,char *chr_p_refno,FILE *p_ptr_log_file,INTL_ENV_DATA_STRUCT_H *p_intl_env_data_struct_h_d,DEBUG_INFO_STRUCT_H **l_debug_info_ptr)
{
	struct sqlca  sqlca;

	CO_ProcMonitor(p_ptr_log_file,"Entered processtion WriteErrorReportDetailsForTrFn\n",NULL,p_intl_env_data_struct_h_d);
	
	sqlca.sqlcode = 0;

	fprintf(p_ptr_clh_rpt_file,"%-14s%-18s      Counterparty Information Missing\n\n",chr_p_client,chr_p_refno);

	APL_GOBACK_SUCCESS

	RETURN_SUCCESS :
	{
		CO_ProcMonitor(p_ptr_log_file,"Leaving processtion WriteErrorReportDetailsForTrFn successfully\n",NULL,p_intl_env_data_struct_h_d);

		return(APL_SUCCESS);
	}
	
	RETURN_FAILURE :
	{
		CO_ProcMonitor(p_ptr_log_file,"Leaving processtion WriteErrorReportDetailsForTrFn with failure \n",NULL,p_intl_env_data_struct_h_d);
	
		return(APL_FAILURE);
	}
}



 int CO_DB_Connection_O(char *p_username,char *p_passwd,DEBUG_INFO_STRUCT_H **l_debug_info_ptr)
 {
	struct sqlca		sqlca;

	CO_ProcMonitor(APL_OUT_FILE,"Entered processtion CO_DB_Connection_O \n",NULL,NULL);
	sqlca.sqlcode = 0;

	EXEC SQL CONNECT :p_username IDENTIFIED BY :p_passwd;

	if (sqlca.sqlcode != 0)
		APL_GOBACK_FAIL

	APL_GOBACK_SUCCESS

	RETURN_SUCCESS :
	{
		CO_ProcMonitor(APL_OUT_FILE,"Leaving processtion CO_DB_Connection_O SUCCESS \n",NULL,NULL);

		return(APL_SUCCESS);
	}

	RETURN_FAILURE :
	{
		CO_ProcMonitor(APL_OUT_FILE,"Leaving processtion CO_DB_Connection_O FAILURE \n",NULL,NULL);

		return(APL_FAILURE);
	}
}



 int LockRecFn1(char **argv,FILE *p_ptr_log_file,DEBUG_INFO_STRUCT_H **l_debug_info_ptr)
 {
	struct sqlca		sqlca;
   char                  chr_g_restart_data[APL_RESTARTDATA_LENGTH];
    short                 g_restart_data_i;

EXEC SQL VAR chr_g_restart_data is string;

	CO_ProcMonitor(p_ptr_log_file,"Entered processtion LockRecFn1 \n",NULL,NULL);

	sqlca.sqlcode = 0;

	EXEC SQL SELECT processing_status INTO :chr_g_restart_data:g_restart_data_i
	FROM SYS_BATCHPROC
	WHERE process_name = :argv[0]
	AND proc_init = :argv[1]
	AND STARTDATE = :argv[2]
	AND status = 'started'
	FOR UPDATE OF processing_status,status;

	IS_ANY_ORA_ERROR_AND_ZERO_RESULTSET(ERR_REC_NOTFND,APL_NULL_STRING,APL_NULL_STRING,APL_NULL_STRING)

	APL_GOBACK_SUCCESS

	RETURN_SUCCESS :
	{
		CO_ProcMonitor(p_ptr_log_file,"Leaving processtion LockRecFn1 SUCCESS \n",NULL,NULL);
		return(APL_SUCCESS);
	}

	RETURN_FAILURE :
	{
		CO_ProcMonitor(APL_OUT_FILE,"Leaving processtion LockRecFn1 FAILURE \n",NULL,NULL);

		return(APL_FAILURE);
	}
}



 int DoFinalProcessingFn1(char **argv,FILE *p_ptr_log_file,DEBUG_INFO_STRUCT_H **l_debug_info_ptr,int p_flg)
 {
	struct sqlca		sqlca;
	char					chr_l_buf[BUFFER_LEN] = APL_NULL_STRING;

	CO_ProcMonitor(p_ptr_log_file,"Entered processtion DoFinalProcessingFn1 \n",NULL,NULL);
	sqlca.sqlcode = 0;

	if (p_flg == 0)
	{
		

		if (CO_ChkErr(*l_debug_info_ptr) != APL_SUCCESS)
		{
			memset(chr_l_buf,APL_NULL_CHAR,BUFFER_LEN);
			sprintf(chr_l_buf,"Finished Clearing House program");

			EXEC SQL UPDATE SYS_BATCHPROC
			SET stat_det = :chr_l_buf,
				 status = 'completed'
			WHERE process_name = :argv[0]
			AND proc_init = :argv[1]
			AND STARTDATE = :argv[2]
			AND status = 'started';

			IS_ANY_ORA_ERROR_AND_ZERO_RESULTSET(ERR_REC_NOTFND,APL_NULL_STRING,APL_NULL_STRING,APL_NULL_STRING)
		
		}

		EXEC SQL COMMIT WORK RELEASE;

		CO_ProcMonitor(p_ptr_log_file,"Work Committed \n",NULL,NULL);
	}
	else if (p_flg == 1)
	{
		EXEC SQL ROLLBACK WORK RELEASE;

		CO_ProcMonitor(p_ptr_log_file,"Rollback Done \n",NULL,NULL);
	}

	APL_GOBACK_SUCCESS

	RETURN_SUCCESS :
	{
		CO_ProcMonitor(p_ptr_log_file,"Leaving processtion DoFinalProcessingFn1 SUCCESS \n",NULL,NULL);

		return(APL_SUCCESS);
	}

	RETURN_FAILURE :
	{
		CO_ProcMonitor(APL_OUT_FILE,"Leaving processtion DoFinalProcessingFn1 FAILURE \n",NULL,NULL);

		return(APL_FAILURE);
	}
}


int CDBGenBrkEntryDVPTrFn(FILE *p_ptr_clh_tr_file, char *p_countclt,char *p_dbcltt, char *p_instr_code, char *p_newissue, double p_quantity, char *chr_p_amount, char *p_csd,char *chr_p_client, char *chr_p_refno, char *p_incl_amt_flg, char *p_dealcd, FILE *p_ptr_log_file,int p_flg_typ_file, INTL_ENV_DATA_STRUCT_H *p_intl_env_data_struct_h_d, DEBUG_INFO_STRUCT_H **l_debug_info_ptr)
{
	struct sqlca  sqlca;
	char		  	chr_l_instr_parent[SEC_CD_LEN_D]	=	APL_NULL_STRING;
	short			i_instr_parent					=	0;
	char		  	chr_l_mothinstrflg[APL_FLAG_LENGTH]	=	APL_NULL_STRING;
	short		  	i_mother_sec_ind					=	0;
	char		  	chr_l_csd[APL_DATE_LEN]			=	APL_NULL_STRING;
	char		  	chr_l_date[11]						=	APL_NULL_STRING;
	char		  	chr_l_rep_outqty[QUANTITY_LEN+1] 	= 	APL_NULL_STRING;
	char		  	*chr_l_ptr_decimal 				= 	NULL;
	char		  	chr_l_amount_buf[AMOUNT_LEN_A+1]	=	APL_NULL_STRING;
	char		  	chr_l_dec_buf[4] 						= 	APL_NULL_STRING;
	char		  	chr_l_amount_buf1[AMOUNT_LEN_A+1] = 	APL_NULL_STRING;
	char		  	chr_l_amount_buf_int[16] 			= 	APL_NULL_STRING;
	int		  	int_l_start 								= 	0;
	int		  	i 										= 	0;
	char		  	l_quantity[QUANTITY_LEN+1] 				= 	APL_NULL_STRING;
   char        chr_l_qty1[4]                     =  APL_NULL_STRING;
   char        chr_l_qty2[QUANTITY_LEN+1]                     =  APL_NULL_STRING;
	char			chr_l_gendate[APL_DATE_LEN]			=	APL_NULL_STRING;
	char			chr_l_gendate1[11]						=	APL_NULL_STRING;
	char			chr_l_acc_cl_code[16]					=	APL_NULL_STRING;	
	short			i_acc_cl_code						=	0;	
	char        chr_l_cp_tksbnk_dtl_acc[3] = APL_NULL_STRING;
	int			int_period_flg = 0;

   EXEC SQL VAR chr_l_instr_parent IS STRING;
	EXEC SQL VAR chr_l_acc_cl_code	IS STRING;

	memset(chr_l_gendate, APL_NULL_CHAR, APL_DATE_LEN);
	memset(chr_l_gendate1, APL_NULL_CHAR, 11);
	memset(chr_l_date, APL_NULL_CHAR, 11);
	memset(chr_l_csd, APL_NULL_CHAR, APL_DATE_LEN);

	CO_ProcMonitor(p_ptr_log_file,"Entered processtion CDBGenBrkEntryDVPTrFn \n",NULL,p_intl_env_data_struct_h_d);

	
	sqlca.sqlcode = 0;

	EXEC SQL SELECT MOTHER_SEC_IND,INSTR_PARENT
	INTO :chr_l_mothinstrflg:i_mother_sec_ind,:chr_l_instr_parent:i_instr_parent
	FROM MT_INSTRUMENT
	WHERE instr_code = :p_instr_code;

	IS_ANY_ORA_ERROR_AND_ZERO_RESULTSET(ERR_REC_NOTFND,APL_NULL_STRING,APL_NULL_STRING,APL_NULL_STRING)

	if (strcmp(chr_l_mothinstrflg,"N") == 0)
		strcpy(p_instr_code,chr_l_instr_parent);

	strcpy(chr_l_csd,p_csd);
	strcpy(chr_l_date, strtok(chr_l_csd, " "));	

	if (strcmp(p_incl_amt_flg,"Y") == 0)
	{
		strcpy(chr_l_amount_buf,chr_p_amount);
	
		chr_l_ptr_decimal = strchr(chr_l_amount_buf,'.');

		if (chr_l_ptr_decimal != NULL)
		{
			strncpy(chr_l_dec_buf,chr_l_ptr_decimal,3);
			chr_l_dec_buf[3] = APL_NULL_CHAR;
		}
		else
			strcpy(chr_l_dec_buf,APL_NULL_STRING);

		 
		while(chr_l_amount_buf[int_l_start] != '.')
			chr_l_amount_buf_int[i++] = chr_l_amount_buf[int_l_start++];
		 
		chr_l_amount_buf_int[i] = APL_NULL_CHAR;
		 
		strcpy(chr_l_amount_buf1,chr_l_amount_buf_int);
		strcat(chr_l_amount_buf1,chr_l_dec_buf);

	}
	else if (strcmp(p_incl_amt_flg,"N") == 0)
		strcpy(chr_l_amount_buf1,chr_p_amount);	
	
	CO_ToStr(p_quantity,QUANTITY_LEN,3,chr_l_rep_outqty);
	
	i = 0;
	int_l_start = 0;
		 
	
	while (isspace(chr_l_rep_outqty[i]))
		i++;
	
	while(chr_l_rep_outqty[i] != APL_NULL_CHAR)
		l_quantity[int_l_start++] = chr_l_rep_outqty[i++];

	l_quantity[int_l_start] = APL_NULL_CHAR;
	

	if(APL_FAILURE == CO_RtvSysDt(chr_l_gendate,l_debug_info_ptr))
   {
      printf("Error in getting date");
      APL_GOBACK_FAIL
   }
	strcpy(chr_l_gendate1, strtok(chr_l_gendate, " "));

	memset(chr_l_acc_cl_code, APL_NULL_CHAR, 16);

	EXEC SQL SELECT CLN_CLH
   	INTO :chr_l_acc_cl_code:i_acc_cl_code
   	FROM MT_CLIENT
      WHERE CLN_CODE = :chr_p_client;

	IS_ANY_ORA_ERROR_AND_ZERO_RESULTSET(ERR_REC_NOTFND,APL_NULL_STRING,APL_NULL_STRING,APL_NULL_STRING)

	
   if( strlen(p_countclt)== 0)
   {
      strcpy(chr_l_cp_tksbnk_dtl_acc,"");
   }
   else
   {
      strcpy(chr_l_cp_tksbnk_dtl_acc,"30");
   }

	if((strcmp(APL_DEAL_DVP, p_dealcd) == 0) && (p_flg_typ_file==1))
	{
		
		
		  
	
		int_period_flg = 0;

		if ( CO_Chk_CcyConvDt("",&int_period_flg,l_debug_info_ptr) == APL_FAILURE )
              {
                 APL_GOBACK_FAIL
              }
          printf("*******%s*********\n",chr_l_qty1);
          strcpy(chr_l_qty1,".");
			 if (strchr(l_quantity,'.') != NULL)
          {
				strcat(chr_l_qty1,strchr(l_quantity,'.') + 1);
			 	strcat(chr_l_qty1,strchr(l_quantity,'.') + 2);
          chr_l_qty1[3] = APL_NULL_CHAR;
			 }
          else 
          	strcat(chr_l_qty1,APL_NULL_STRING);
          printf("*******%s*********\n",chr_l_qty1);

		if ((int_period_flg ==1) && ((strcmp(chr_l_qty1,".00")!=0) && (atof(l_quantity) < 1 )) || (atof(l_quantity) > 1))
        {
          EXEC SQL SELECT TRUNC(:l_quantity,2) INTO :chr_l_qty2 FROM DUAL;
          IS_ANY_ORA_ERROR

          printf("*******%s*********\n",chr_l_qty1);
			fprintf(p_ptr_clh_tr_file,"%s,CIY,%s,K,%s,%s,%.2f,%s,%s,30,11,%s,,1,%s,%s,,,%s,%s\n",chr_l_gendate, p_dbcltt, p_instr_code, p_newissue, atof(chr_l_qty2), chr_l_amount_buf1,chr_p_client,chr_l_csd, p_countclt, chr_l_cp_tksbnk_dtl_acc, chr_p_client, chr_p_refno);
          printf("*******%s*********\n",chr_l_qty1);
        }
		else		
			fprintf(p_ptr_clh_tr_file,"%s,CIY,%s,K,%s,%s,%s,%s,%s,30,11,%s,,1,%s,%s,,,%s,%s\n",chr_l_gendate, p_dbcltt, p_instr_code, p_newissue, l_quantity, chr_l_amount_buf1,chr_p_client,chr_l_csd, p_countclt, chr_l_cp_tksbnk_dtl_acc, chr_p_client, chr_p_refno);
		
	}
	else if((strcmp(APL_DEAL_DVP, p_dealcd) == 0) && (p_flg_typ_file==2))
	{
		
      
      
      fprintf(p_ptr_clh_tr_file,"%s,CIY,%s,K,%s,%s,%s,%s,%s,30,11,%s,,1,%s,%s,,,%s,%s\n",chr_l_gendate, p_dbcltt, p_instr_code, p_newissue, l_quantity, chr_l_amount_buf1,chr_p_client,chr_l_csd, p_countclt, chr_l_cp_tksbnk_dtl_acc, chr_p_client, chr_p_refno);
	}
	else if((strcmp(APL_DEAL_RVP, p_dealcd) == 0) && (p_flg_typ_file==1))
	{	
		
		

	     
		
		int_period_flg = 0;
		
		if ( CO_Chk_CcyConvDt("",&int_period_flg,l_debug_info_ptr) == APL_FAILURE )
               {
                  APL_GOBACK_FAIL
               }
		if (int_period_flg == 1)
			fprintf(p_ptr_clh_tr_file,"%s,CIY,%s,N,%s,%s,%.2f,%s,%s,30,,%s,,1,%s,%s,,,%s,%s\n",chr_l_gendate, p_dbcltt, p_instr_code,p_newissue, atof(l_quantity), chr_l_amount_buf1,chr_p_client,chr_l_csd, p_countclt, chr_l_cp_tksbnk_dtl_acc, chr_p_client, chr_p_refno);
		else
			fprintf(p_ptr_clh_tr_file,"%s,CIY,%s,N,%s,%s,%s,%s,%s,30,,%s,,1,%s,%s,,,%s,%s\n",chr_l_gendate, p_dbcltt, p_instr_code, p_newissue, l_quantity, chr_l_amount_buf1,chr_p_client,chr_l_csd, p_countclt, chr_l_cp_tksbnk_dtl_acc, chr_p_client, chr_p_refno); 
	
	}
	else if((strcmp(APL_DEAL_RVP, p_dealcd) == 0) && (p_flg_typ_file==2))
	{
	   
      

      
      fprintf(p_ptr_clh_tr_file,"%s,CIY,%s,N,%s,%s,%s,%s,%s,30,,%s,,1,%s,%s,,,%s,%s\n",chr_l_gendate, p_dbcltt, p_instr_code, p_newissue, l_quantity, chr_l_amount_buf1,chr_p_client,chr_l_csd, p_countclt, chr_l_cp_tksbnk_dtl_acc, chr_p_client, chr_p_refno);
	}
	
	RETURN_SUCCESS :
	{
		CO_ProcMonitor(p_ptr_log_file,"Leaving processtion CDBGenBrkEntryDVPTrFn successfully\n",NULL,p_intl_env_data_struct_h_d);

		return(APL_SUCCESS);
	}
	
	RETURN_FAILURE :
	{
		CO_ProcMonitor(p_ptr_log_file,"Leaving processtion CDBGenBrkEntryDVPTrFn with failure\n",NULL,p_intl_env_data_struct_h_d);
	
		return(APL_FAILURE);
	}
}


int WritePendBrokRepDetFn(FILE *p_ptr_clh_rpt_file,char *p_domcpac,char *p_ac_at_brok,char *p_our_clt,char *p_clh_code,char *p_instr_code,char *p_newissue,char *p_dealcd,double p_quantity, char *chr_p_amount,FILE *p_ptr_log_file,INTL_ENV_DATA_STRUCT_H *p_intl_env_data_struct_h_d,DEBUG_INFO_STRUCT_H **l_debug_info_ptr)
{

   char        chr_l_rep_outqty[QUANTITY_LEN+1]  =  APL_NULL_STRING;
   char          l_quantity[QUANTITY_LEN+1] = APL_NULL_STRING;
   int           int_l_start = 0;
   int           i = 0;
   char         chr_l_trcode_a[4]      =  APL_NULL_STRING;
	int          int_period_flg = 0;

   CO_ToStr(p_quantity,QUANTITY_LEN,0,chr_l_rep_outqty);
   

   while (isspace(chr_l_rep_outqty[i]))
      i++;

   while(chr_l_rep_outqty[i] != APL_NULL_CHAR)
      l_quantity[int_l_start++] = chr_l_rep_outqty[i++];

   l_quantity[int_l_start] = APL_NULL_CHAR;
   if(strcmp(p_dealcd,"1")==0)
      strcpy(chr_l_trcode_a,"DF");
   else if(strcmp(p_dealcd,"2")==0)
      strcpy(chr_l_trcode_a,"RF");
   else if(strcmp(p_dealcd,"3")==0)
      strcpy(chr_l_trcode_a,"DVP");
   else if(strcmp(p_dealcd,"4")==0)
      strcpy(chr_l_trcode_a,"RVP");

   int_period_flg = 0;

   if ( CO_Chk_CcyConvDt("",&int_period_flg,l_debug_info_ptr) == APL_FAILURE )
               {
                  APL_GOBACK_FAIL
               }
   if (int_period_flg == 1)
      fprintf( p_ptr_clh_rpt_file,
            "%-12s    %-12s    %-16s    %-12s   %-9s   %-15s    %-5s    %-.3f           %-s \n\n",
            p_domcpac,
            p_ac_at_brok,
            p_our_clt,
            p_clh_code,
            p_instr_code,
            p_newissue,
            chr_l_trcode_a,
            p_quantity,
            chr_p_amount);
   else
   	fprintf( p_ptr_clh_rpt_file,
            "%-12s    %-12s    %-16s    %-12s   %-9s   %-15s    %-5s    %-s           %-s \n\n",
            p_domcpac,
            p_ac_at_brok,
            p_our_clt,
            p_clh_code,
            p_instr_code,
            p_newissue,
            chr_l_trcode_a,
            chr_l_rep_outqty,
            chr_p_amount);
	
   APL_GOBACK_SUCCESS

   RETURN_SUCCESS :
   {
      CO_ProcMonitor(p_ptr_log_file,"Leaving processtion WritePendBrokRepDetFn successfully\n",NULL,p_intl_env_data_struct_h_d);

      return(APL_SUCCESS);
   }

   RETURN_FAILURE :
   {
    CO_ProcMonitor(p_ptr_log_file,"Leaving processtion WritePendBrokRepDetFn with failure \n",NULL,p_intl_env_data_struct_h_d);

      return(APL_FAILURE);
   }
}



int WritePendTrdRepFn(FILE *p_ptr_clh_rpt_file,int p_page_no, int p_reptype,int p_conf_auth,FILE *p_ptr_log_file,INTL_ENV_DATA_STRUCT_H *p_intl_env_data_struct_h_d,DEBUG_INFO_STRUCT_H **l_debug_info_ptr)
{
   struct sqlca  sqlca;
   char          chr_l_sys_date[9];
   int           i;
   char          chr_l_corp_name[41];
   short         i_ca_clr_name;

   EXEC SQL VAR chr_l_sys_date IS STRING;
   EXEC SQL VAR chr_l_corp_name IS STRING;

   CO_ProcMonitor(p_ptr_log_file,"Entered processtion WritePendTrdRepFn\n",NULL,p_intl_env_data_struct_h_d);

   sqlca.sqlcode = 0;

   EXEC SQL SELECT TO_CHAR(SYS_DATE,'DD/MM/YY')
   INTO :chr_l_sys_date
   FROM PRO_SYS_DATE;

   IS_ANY_ORA_ERROR_AND_ZERO_RESULTSET(ERR_DATE_NOT_SET,APL_NULL_STRING,APL_NULL_STRING,APL_NULL_STRING)

   EXEC SQL SELECT ca_identname
   INTO :chr_l_corp_name:i_ca_clr_name
   FROM MT_COMMON_SYS_PARAMS;

   IS_ANY_ORA_ERROR_AND_ZERO_RESULTSET(ERR_REC_NOTFND,APL_NULL_STRING,APL_NULL_STRING,APL_NULL_STRING)
   fprintf(p_ptr_clh_rpt_file,"\n");

   for (i=0;i<158;i++)
      fprintf(p_ptr_clh_rpt_file,"-");


	if(p_conf_auth==0)
	{
   fprintf(p_ptr_clh_rpt_file,"\n%s                                 PENDING TRADE REPORT- CONFIRMED                        Page %d\n",chr_l_sys_date,p_page_no);
	}
	else
	{
   fprintf(p_ptr_clh_rpt_file,"\n%s                                 PENDING TRADE REPORT-AUTHORISED                        Page %d\n",chr_l_sys_date,p_page_no);
	}

   fprintf(p_ptr_clh_rpt_file,"                                              %s\n\n",chr_l_corp_name);

   if(1 == p_reptype)
      fprintf(p_ptr_clh_rpt_file,"                                         Broker DELV_FREE Trades File Details \n\n\n");
   else if (2== p_reptype)
      fprintf(p_ptr_clh_rpt_file,"                                         Broker RECEIVE_FREE Trades File Details \n\n\n");
   else if (3== p_reptype)
      fprintf(p_ptr_clh_rpt_file,"                                         Broker DVP Trades File Details \n\n\n");
   else if (4== p_reptype)
      fprintf(p_ptr_clh_rpt_file,"                                         Broker RVP Trades File Details \n\n\n");


   for (i=0;i<158;i++)
      fprintf(p_ptr_clh_rpt_file,"-");

   fprintf(p_ptr_clh_rpt_file,"\nBroker        A/c at Broker     Our A/c No.         Clh Code          Instrurity   Mkt. Code       Trade Code      %15sQuantity%11sAmount"," "," ");

   fprintf(p_ptr_clh_rpt_file,"\n");

   for (i=0;i<158;i++)
      fprintf(p_ptr_clh_rpt_file,"-");

   fprintf(p_ptr_clh_rpt_file,"\n");

   APL_GOBACK_SUCCESS

   RETURN_SUCCESS :
   {
      CO_ProcMonitor(p_ptr_log_file,"Leaving processtion WritePendTrdRepFn successfully\n",NULL,p_intl_env_data_struct_h_d);

      return(APL_SUCCESS);
   }

   RETURN_FAILURE :
   {
      CO_ProcMonitor(p_ptr_log_file,"Leaving processtion WritePendTrdRepFn with failure \n",NULL,p_intl_env_data_struct_h_d);

      return(APL_FAILURE);
   }
}



int PendTxnFn(char **argv,FILE *p_ptr_log_file,INTL_ENV_DATA_STRUCT_H *p_intl_env_data_struct_h_d,DEBUG_INFO_STRUCT_H **l_debug_info_ptr)
{

   FILE                    *l_broker_RVP_rpt_file = NULL;
   FILE                    *l_broker_DVP_rpt_file = NULL;
   FILE                    *l_broker_DF_rpt_file = NULL;
   FILE                    *l_broker_RF_rpt_file = NULL;
   char                    chr_l_ahr_handoff_file_name[FILENAME_LEN_A] = APL_NULL_STRING;
   char                    chr_l_ahs_handoff_file_name[FILENAME_LEN_A] = APL_NULL_STRING;
   char                    chr_l_au_handoff_file_name[FILENAME_LEN_A] 	= APL_NULL_STRING;
   FILE                    *l_ptr_AHR_handoff_file 				= NULL;
   FILE                    *l_ptr_AHS_handoff_file 				= NULL;
   FILE                    *l_ptr_AU_handoff_file 					= NULL;
   SYS_DL_DEAL_STRUCT_H     l_sys_dl_deal_struct_hd;
   SYS_DL_DEAL_STRUCT_I     l_sys_dl_deal_struct_ii;
   char                    chr_h_domcp_clhaccount[16]  =APL_NULL_STRING;
   short                   i_domcp_clhaccount;
   char                    chr_h_instrcode_newissue[2]=APL_NULL_STRING;
   short                   i_instr_code_newissue;
   int                     int_l_lines_rpted_df;
   int                     int_l_lines_rpted_rf;
   int                     int_l_lines_rpted_dvp;
   int                     int_l_lines_rpted_rvp;
   int                     int_num = 0;
   char                    **temp = NULL;
   char                    chr_l_gen_handoff_file_flg[2];
   char                    chr_l_sys_date[APL_DATE_LEN];
   short                   i_sys_date = 0;
   char                    chr_l_inifile[FILENAME_LEN_A] = APL_NULL_STRING;
   char                    chr_l_handoff_dir[FILEPATH_LEN] = APL_NULL_STRING;
   FILE                    *l_ptr_ini_file = NULL;
   char                    chr_l_date[7];
   char                    chr_l_date1[7];
   char                    chr_l_conf_dt[APL_DATE_LEN];
   INTL_REPT_STRUCT_H           *l_intl_rept_struct_ha  =NULL;
	char                    dbl_l_amount_a[66];
   int                     int_l_page_no_df = 0;
   int                     int_l_page_no_rf = 0;
   int                     int_l_page_no_rvp = 0;
   int                     int_l_page_no_dvp = 0;
   char                    chr_l_clscode_a[5];
   short                   i_classcd;
   char                    chr_l_acc_cl_code[16];
   short                   i_acc_cl_code;
   char                    chr_l_newissue[3];
   short                   i_new_issue;
   char                    chr_l_mothinstrflg[2];
   short                   i_mother_sec_ind;
   char                    chr_l_notmotherflg[2];
	char							chr_l_instr_parent[9];
	short							i_instr_parent;
	char							chr_l_cubk[2];
	short							i_clt_brk_all;
	char							chr_l_acctruedvp[APL_FLAG_LENGTH]	= APL_NULL_STRING;	
	short							i_acctruedvp					=	0;
	int							i									=  0;
	int							int_retval							=	0;
	char							chr_l_typeoffile[APL_FLAG_LENGTH]	=	APL_NULL_STRING;	
	char							chr_l_instrcode_a[9];
	char							chr_l_incl_amt_flg[2];
	char							chr_l_cntac_acntof[11];
	int							int_l_type_flg						=	0;

   EXEC SQL VAR l_sys_dl_deal_struct_hd.h_domcpclt_cd IS STRING;
   EXEC SQL VAR l_sys_dl_deal_struct_hd.h_countclt IS STRING;
   EXEC SQL VAR l_sys_dl_deal_struct_hd.h_dl_client IS STRING;
   EXEC SQL VAR l_sys_dl_deal_struct_hd.h_instr_code IS STRING;
   EXEC SQL VAR l_sys_dl_deal_struct_hd.h_dealcd IS STRING;
   EXEC SQL VAR chr_h_domcp_clhaccount IS STRING;
   EXEC SQL VAR chr_h_instrcode_newissue IS STRING;
   EXEC SQL VAR chr_l_sys_date IS STRING;
   EXEC SQL VAR chr_l_mothinstrflg IS STRING;
   EXEC SQL VAR chr_l_instr_parent IS STRING;
	EXEC SQL VAR chr_l_acc_cl_code IS STRING;
   EXEC SQL VAR chr_l_clscode_a IS STRING;
   EXEC SQL VAR chr_l_newissue IS STRING;
   EXEC SQL VAR chr_l_cubk IS STRING;
   EXEC SQL VAR chr_l_cntac_acntof IS STRING;

   memset(chr_l_inifile,NULL,sizeof(chr_l_inifile));
   memset(chr_l_handoff_dir,NULL,sizeof(chr_l_handoff_dir));

   l_intl_rept_struct_ha   = (INTL_REPT_STRUCT_H *)calloc(1, sizeof(INTL_REPT_STRUCT_H));
   if (CO_RtvSysDt(chr_l_sys_date,l_debug_info_ptr) != APL_SUCCESS)
      return(APL_FAILURE);
  	if (CO_SplitStr(argv[9],'|',&int_num,&temp) != APL_SUCCESS)
     	return(APL_FAILURE);

	int_l_page_no_df=1;
	int_l_page_no_rf=1;
	int_l_page_no_rvp=1;
	int_l_page_no_dvp=1;
   strcpy(chr_l_conf_dt,temp[1]);
  	strcpy(chr_l_gen_handoff_file_flg,temp[2]);
		
   strcpy(chr_l_inifile,getenv("INTL_ROOT_PATH"));
   strcat(chr_l_inifile,"intl_sun.cfg");

   if ((l_ptr_ini_file = fopen(chr_l_inifile,"r")) == NULL)
      return(APL_FAILURE);

   if (strcmp(chr_l_gen_handoff_file_flg,"Y") == 0)
   {
      if (CO_ReadToken(l_ptr_ini_file,"INTL_HF_PATH",chr_l_handoff_dir,l_debug_info_ptr) != APL_SUCCESS)
         return(APL_FAILURE);

      chr_l_date[0] = chr_l_sys_date[0];
      chr_l_date[1] = chr_l_sys_date[1];
      chr_l_date[2] = chr_l_sys_date[3];
      chr_l_date[3] = chr_l_sys_date[4];
      chr_l_date[4] = chr_l_sys_date[8];
      chr_l_date[5] = chr_l_sys_date[9];
      chr_l_date[6] = '\0';

      chr_l_date1[0] = chr_l_sys_date[3];
      chr_l_date1[1] = chr_l_sys_date[4];
      chr_l_date1[2] = chr_l_sys_date[0];
      chr_l_date1[3] = chr_l_sys_date[1];
      chr_l_date1[4] = chr_l_sys_date[8];
      chr_l_date1[5] = chr_l_sys_date[9];
      chr_l_date1[6] = '\0';

      strcpy(chr_l_au_handoff_file_name,chr_l_handoff_dir);
      strcat(chr_l_au_handoff_file_name,"AU");
      strcat(chr_l_au_handoff_file_name,chr_l_date);
      strcat(chr_l_au_handoff_file_name,".CIY");

      if ((l_ptr_AU_handoff_file = fopen(chr_l_au_handoff_file_name,"w")) == NULL)
         return(APL_FAILURE);

      memset(l_intl_rept_struct_ha,NULL,sizeof(INTL_REPT_STRUCT_H));

      
      strcpy(l_intl_rept_struct_ha->report_name, chr_l_au_handoff_file_name+strlen(chr_l_handoff_dir));
      strcpy(l_intl_rept_struct_ha->report_desc, APL_HOFF_FILE_DESC);
      strcpy(l_intl_rept_struct_ha->report_date, argv[2]);
      l_intl_rept_struct_ha->report_width = 100;
      strcpy(l_intl_rept_struct_ha->task_desc, p_intl_env_data_struct_h_d->processtion);
      strcpy(l_intl_rept_struct_ha->fe_be_ind, APL_BE_IND);
      strcpy(l_intl_rept_struct_ha->usr, p_intl_env_data_struct_h_d->usr);

      
      if (APL_FAILURE == CO_Proc_DBRptIns( l_intl_rept_struct_ha, l_debug_info_ptr))
      {
         APL_GOBACK_FAIL
      }

      strcpy(chr_l_ahs_handoff_file_name,chr_l_handoff_dir);
      strcat(chr_l_ahs_handoff_file_name,"AHS");
      strcat(chr_l_ahs_handoff_file_name,chr_l_date);
      strcat(chr_l_ahs_handoff_file_name,".CIY");

      if ((l_ptr_AHS_handoff_file = fopen(chr_l_ahs_handoff_file_name,"w")) == NULL)
         return(APL_FAILURE);

      memset(l_intl_rept_struct_ha,NULL,sizeof(INTL_REPT_STRUCT_H));

      
      strcpy(l_intl_rept_struct_ha->report_name, chr_l_ahs_handoff_file_name+strlen(chr_l_handoff_dir));
      strcpy(l_intl_rept_struct_ha->report_desc, APL_HOFF_FILE_DESC);
      strcpy(l_intl_rept_struct_ha->report_date, argv[2]);
      l_intl_rept_struct_ha->report_width = 100;
      strcpy(l_intl_rept_struct_ha->task_desc, p_intl_env_data_struct_h_d->processtion);
      strcpy(l_intl_rept_struct_ha->fe_be_ind, APL_BE_IND);
      strcpy(l_intl_rept_struct_ha->usr, p_intl_env_data_struct_h_d->usr);

      
      if (APL_FAILURE == CO_Proc_DBRptIns( l_intl_rept_struct_ha, l_debug_info_ptr))
      {
         APL_GOBACK_FAIL
      }

      strcpy(chr_l_ahr_handoff_file_name,chr_l_handoff_dir);
      strcat(chr_l_ahr_handoff_file_name,"AHR");
      strcat(chr_l_ahr_handoff_file_name,chr_l_date);
      strcat(chr_l_ahr_handoff_file_name,".CIY");

      if ((l_ptr_AHR_handoff_file = fopen(chr_l_ahr_handoff_file_name,"w")) == NULL)
         return(APL_FAILURE);

      memset(l_intl_rept_struct_ha,NULL,sizeof(INTL_REPT_STRUCT_H));

      
      strcpy(l_intl_rept_struct_ha->report_name, chr_l_ahr_handoff_file_name+strlen(chr_l_handoff_dir));
      strcpy(l_intl_rept_struct_ha->report_desc, APL_HOFF_FILE_DESC);
      strcpy(l_intl_rept_struct_ha->report_date, argv[2]);
      l_intl_rept_struct_ha->report_width = 100;
      strcpy(l_intl_rept_struct_ha->task_desc, p_intl_env_data_struct_h_d->processtion);
      strcpy(l_intl_rept_struct_ha->fe_be_ind, APL_BE_IND);
      strcpy(l_intl_rept_struct_ha->usr, p_intl_env_data_struct_h_d->usr);

      
      if (APL_FAILURE == CO_Proc_DBRptIns( l_intl_rept_struct_ha, l_debug_info_ptr))
      {
         APL_GOBACK_FAIL
      }

	}

   int_retval = CO_Rtv_RptFileName("CH", "Broker RVP Trades Report", 80, p_intl_env_data_struct_h_d->processtion, argv, &l_broker_RVP_rpt_file, l_debug_info_ptr);
   if (int_retval != APL_SUCCESS)
      return(APL_FAILURE);

   
   int_retval = WritePendTrdRepFn(l_broker_RVP_rpt_file, int_l_page_no_rvp, 4,1, p_ptr_log_file, p_intl_env_data_struct_h_d, l_debug_info_ptr);
   if (int_retval != APL_SUCCESS)
      return(APL_FAILURE);

   sleep(2);


   int_retval = CO_Rtv_RptFileName("CH", "Broker DVP Trades Report", 80, p_intl_env_data_struct_h_d->processtion, argv, &l_broker_DVP_rpt_file, l_debug_info_ptr);
   if (int_retval != APL_SUCCESS)
      return(APL_FAILURE);

   
   int_retval = WritePendTrdRepFn(l_broker_DVP_rpt_file, int_l_page_no_dvp, 3,1, p_ptr_log_file, p_intl_env_data_struct_h_d, l_debug_info_ptr);
   if (int_retval != APL_SUCCESS)
      return(APL_FAILURE);

   sleep(2);


   int_retval = CO_Rtv_RptFileName("CH", "Broker DELV_FREE Trades Report", 80, p_intl_env_data_struct_h_d->processtion, argv,&l_broker_DF_rpt_file, l_debug_info_ptr);
   if (int_retval != APL_SUCCESS)
      return(APL_FAILURE);

   
   int_retval = WritePendTrdRepFn(l_broker_DF_rpt_file, int_l_page_no_df, 1,1, p_ptr_log_file, p_intl_env_data_struct_h_d, l_debug_info_ptr);
   if (int_retval != APL_SUCCESS)
      return(APL_FAILURE);

   sleep(2);

   int_retval = CO_Rtv_RptFileName("CH", "Broker RECEIVE_FREE Trades Report", 80, p_intl_env_data_struct_h_d->processtion, argv,&l_broker_RF_rpt_file, l_debug_info_ptr);
   if (int_retval != APL_SUCCESS)
      return(APL_FAILURE);

   
   int_retval = WritePendTrdRepFn(l_broker_RF_rpt_file, int_l_page_no_rf, 2,1, p_ptr_log_file, p_intl_env_data_struct_h_d, l_debug_info_ptr);
   if (int_retval != APL_SUCCESS)
      return(APL_FAILURE);

   sleep(2);

	if (strcmp(chr_l_gen_handoff_file_flg,"Y") == 0)	
	{
  		EXEC SQL DECLARE PEND_TXN_CUR CURSOR FOR
           SELECT * FROM DL_DEAL
           WHERE DEAL_STAT='AA'
           AND DOMESTIC_CPCLT!=:l_mt_core_sys_params_struct_h.custody_clt_cd
           AND SETL_DATE<=:chr_l_sys_date
           AND ENTRY!='G'
 			  AND TRANS_DATE IS NULL
      ORDER BY DOMESTIC_CPCLT;
		
   	printf("sqlca.sqlcode is %d\n",sqlca.sqlcode);
		IS_ANY_ORA_ERROR

	}
	else
	{
  		EXEC SQL DECLARE PEND_TXN_CUR1 CURSOR FOR
           SELECT * FROM DL_DEAL
           WHERE DEAL_STAT='AA'
           AND DOMESTIC_CPCLT!=:l_mt_core_sys_params_struct_h.custody_clt_cd
           AND SETL_DATE<=:chr_l_sys_date
           AND ENTRY!='G'
      ORDER BY DOMESTIC_CPCLT;
		
   	printf("sqlca.sqlcode is %d\n",sqlca.sqlcode);
		IS_ANY_ORA_ERROR

	}
	if (strcmp(chr_l_gen_handoff_file_flg,"Y") == 0)	
	{
		EXEC SQL OPEN PEND_TXN_CUR;
		IS_ANY_ORA_ERROR
	}
	else
	{
		EXEC SQL OPEN PEND_TXN_CUR1;
		IS_ANY_ORA_ERROR
	}
		for(;;)
		{
		memset(&l_sys_dl_deal_struct_hd,NULL,sizeof(SYS_DL_DEAL_STRUCT_H));
		memset(&l_sys_dl_deal_struct_ii,NULL,sizeof(SYS_DL_DEAL_STRUCT_I));	
		if (strcmp(chr_l_gen_handoff_file_flg,"Y") == 0)	
		{
			EXEC SQL FETCH PEND_TXN_CUR INTO :l_sys_dl_deal_struct_hd:l_sys_dl_deal_struct_ii;
			IS_ANY_ORA_ERROR
		}
		else
		{
			EXEC SQL FETCH PEND_TXN_CUR1 INTO :l_sys_dl_deal_struct_hd:l_sys_dl_deal_struct_ii;
			IS_ANY_ORA_ERROR
		}
			printf("sqlca.sqlcode=%d\n",sqlca.sqlcode);
			printf("account is %s\n",l_sys_dl_deal_struct_hd.h_dl_client);
			printf("refno is %s\n",l_sys_dl_deal_struct_hd.h_indentity_no);
			if(sqlca.sqlcode==1403)
				break;


      EXEC SQL SELECT CLASSCD,NEW_ISSUE,MOTHER_SEC_IND,INSTR_PARENT
      INTO :chr_l_clscode_a:i_classcd,chr_l_newissue:i_new_issue,chr_l_mothinstrflg:i_mother_sec_ind,chr_l_instr_parent:i_instr_parent
      FROM MT_INSTRUMENT
      WHERE instr_code = :l_sys_dl_deal_struct_hd.h_instr_code;

      IS_ANY_ORA_ERROR_AND_ZERO_RESULTSET(ERR_REC_NOTFND,APL_NULL_STRING,APL_NULL_STRING,APL_NULL_STRING)


      EXEC SQL SELECT CLN_BRK_ALL,CLN_CLH, CLN_REG_BCL_IND
      INTO :chr_l_cubk:i_clt_brk_all,:chr_l_acc_cl_code:i_acc_cl_code, :chr_l_acctruedvp:i_acctruedvp
      FROM MT_CLIENT
      WHERE CLN_CODE = :l_sys_dl_deal_struct_hd.h_domcpclt_cd;

      IS_ANY_ORA_ERROR_AND_ZERO_RESULTSET(ERR_REC_NOTFND,APL_NULL_STRING,APL_NULL_STRING,APL_NULL_STRING)

      if((strcmp(chr_l_acctruedvp, HANDOFF_TRUE) == 0) && (strcmp(chr_l_typeoffile, HANDOFF_NORMAL) == 0))
         continue;
      else if((strcmp(chr_l_acctruedvp, HANDOFF_TRUE) != 0) && (strcmp(chr_l_typeoffile, HANDOFF_TRUE) == 0))
         continue;

		      if ((strcmp(chr_l_clscode_a,"HS") != 0) || (strcmp(chr_l_newissue,"R") == 0)
         || (strcmp(chr_l_cubk,"B") != 0))
         continue;

      if (strcmp(chr_l_mothinstrflg,"Y" ) == 0)
         strcpy(chr_l_notmotherflg,"N");
      else
         strcpy(chr_l_notmotherflg,"Y");

      if (strcmp(chr_l_notmotherflg,"Y") == 0)
         strcpy(chr_l_instrcode_a,chr_l_instr_parent);
      else
         strcpy(chr_l_instrcode_a,l_sys_dl_deal_struct_hd.h_instr_code);


         if (strcmp(chr_l_newissue,"N") == 0)
            strcpy(chr_l_newissue,"E");
         else if ((strcmp(chr_l_newissue,"Y") == 0) && (strcmp(chr_l_mothinstrflg,"Y") != 0))
            strcpy(chr_l_newissue,"Y");
         else if ((strcmp(chr_l_newissue,"M") == 0) && (strcmp(chr_l_mothinstrflg,"Y") != 0))
            strcpy(chr_l_newissue,"M");

         if ((strcmp(l_sys_dl_deal_struct_hd.h_dealcd,"3") == 0) || (strcmp(l_sys_dl_deal_struct_hd.h_dealcd,"4") == 0))
            sprintf(dbl_l_amount_a,"%f",l_sys_dl_deal_struct_hd.h_amt);
         else if ((strcmp(l_sys_dl_deal_struct_hd.h_dealcd,"1") == 0) || (strcmp(l_sys_dl_deal_struct_hd.h_dealcd,"2") == 0))
            sprintf(dbl_l_amount_a,"0.000000");

			if(strcmp(l_sys_dl_deal_struct_hd.h_countclt,APL_NULL_STRING)==0)
				strcpy(chr_l_cntac_acntof,l_sys_dl_deal_struct_hd.h_clientofcode);
			else
				strcpy(chr_l_cntac_acntof,l_sys_dl_deal_struct_hd.h_countclt);


      	if (strcmp(chr_l_gen_handoff_file_flg,"Y") == 0)
      	{
         	if((strcmp(l_sys_dl_deal_struct_hd.h_domcpclt_cd,l_mt_core_sys_params_struct_h.custody_clt_cd) != 0) && (strcmp(l_sys_dl_deal_struct_hd.h_dealcd, APL_DEAL_DVP) == 0))
         	{
				printf("l_cntac_acntof is %s\n",chr_l_cntac_acntof);
					int_l_type_flg = 2;
            	int_retval = CDBGenBrkEntryDVPTrFn(l_ptr_AHS_handoff_file, chr_l_cntac_acntof,chr_l_acc_cl_code, chr_l_instrcode_a, chr_l_newissue, l_sys_dl_deal_struct_hd.h_qty, dbl_l_amount_a, l_sys_dl_deal_struct_hd.h_setldt, l_sys_dl_deal_struct_hd.h_dl_client, l_sys_dl_deal_struct_hd.h_indentity_no, "Y", l_sys_dl_deal_struct_hd.h_dealcd, p_ptr_log_file,int_l_type_flg,p_intl_env_data_struct_h_d, l_debug_info_ptr);
 	         	if (int_retval != APL_SUCCESS)
            		APL_GOBACK_FAIL

				}
				else if((strcmp(l_sys_dl_deal_struct_hd.h_domcpclt_cd,l_mt_core_sys_params_struct_h.custody_clt_cd) != 0) && (strcmp(l_sys_dl_deal_struct_hd.h_dealcd, APL_DEAL_RVP) == 0))
         	{
					int_l_type_flg = 2;
            	int_retval = CDBGenBrkEntryDVPTrFn(l_ptr_AHR_handoff_file, chr_l_cntac_acntof,chr_l_acc_cl_code, chr_l_instrcode_a, chr_l_newissue, l_sys_dl_deal_struct_hd.h_qty, dbl_l_amount_a, l_sys_dl_deal_struct_hd.h_setldt, l_sys_dl_deal_struct_hd.h_dl_client, l_sys_dl_deal_struct_hd.h_indentity_no, "Y", l_sys_dl_deal_struct_hd.h_dealcd, p_ptr_log_file,int_l_type_flg,p_intl_env_data_struct_h_d, l_debug_info_ptr);
            	if (int_retval != APL_SUCCESS)
               	APL_GOBACK_FAIL
         	}
		   	else if ((strcmp(l_sys_dl_deal_struct_hd.h_dealcd,APL_DEAL_DF)==0) && (strcmp(l_sys_dl_deal_struct_hd.h_domcpclt_cd,l_mt_core_sys_params_struct_h.custody_clt_cd) != 0)) 
           	{
					int_l_type_flg = 2;
            	int_retval = CDBGenBrkEntryTrFn(l_ptr_AU_handoff_file,l_sys_dl_deal_struct_hd.h_dl_client,chr_l_acc_cl_code,chr_l_cntac_acntof,chr_l_instrcode_a,chr_l_newissue,l_sys_dl_deal_struct_hd.h_qty,p_ptr_log_file,int_l_type_flg,p_intl_env_data_struct_h_d,l_debug_info_ptr);
         		if (int_retval != APL_SUCCESS)
           			APL_GOBACK_FAIL

	         }

				if(strcmp(l_sys_dl_deal_struct_hd.h_dealcd,"2")!=0)
				{
					EXEC SQL UPDATE DL_DEAL SET TRANS_DATE=:chr_l_sys_date
							WHERE CLIENT=:l_sys_dl_deal_struct_hd.h_dl_client
							AND IDENTIY_NO=:l_sys_dl_deal_struct_hd.h_indentity_no;
			
					IS_ANY_ORA_ERROR
				}
			}

			

		 if(strcmp(l_sys_dl_deal_struct_hd.h_dealcd,"1")==0)
		 {
			if(APL_FAILURE == WritePendBrokRepDetFn(l_broker_DF_rpt_file, l_sys_dl_deal_struct_hd.h_domcpclt_cd,chr_l_cntac_acntof , l_sys_dl_deal_struct_hd.h_dl_client, chr_l_acc_cl_code, l_sys_dl_deal_struct_hd.h_instr_code, chr_l_newissue, l_sys_dl_deal_struct_hd.h_dealcd,  l_sys_dl_deal_struct_hd.h_qty, dbl_l_amount_a, p_ptr_log_file, p_intl_env_data_struct_h_d, l_debug_info_ptr))
         {
            APL_GOBACK_FAIL
         }

         int_l_lines_rpted_df = int_l_lines_rpted_df + 2;

         if (int_l_lines_rpted_df == REPORT_PAGE_LEN)
         {
            int_l_page_no_df = int_l_page_no_df + 1;

            
            int_retval = WritePendTrdRepFn(l_broker_DF_rpt_file, int_l_page_no_df, 1,1, p_ptr_log_file, p_intl_env_data_struct_h_d, l_debug_info_ptr);

            if (int_retval != APL_SUCCESS)
               return(APL_FAILURE);

            int_l_lines_rpted_df   = PAGE_HDR_LENGTH;
         }
		 }
		 else if(strcmp(l_sys_dl_deal_struct_hd.h_dealcd,"2")==0)
		 {
			if(APL_FAILURE == WritePendBrokRepDetFn(l_broker_RF_rpt_file, l_sys_dl_deal_struct_hd.h_domcpclt_cd,chr_l_cntac_acntof , l_sys_dl_deal_struct_hd.h_dl_client, chr_l_acc_cl_code, l_sys_dl_deal_struct_hd.h_instr_code, chr_l_newissue, l_sys_dl_deal_struct_hd.h_dealcd,  l_sys_dl_deal_struct_hd.h_qty, dbl_l_amount_a, p_ptr_log_file, p_intl_env_data_struct_h_d, l_debug_info_ptr))
			{
				APL_GOBACK_FAIL
			}	

      	int_l_lines_rpted_rf = int_l_lines_rpted_rf + 2;

      	if (int_l_lines_rpted_rf == REPORT_PAGE_LEN)
      	{
         	int_l_page_no_rf = int_l_page_no_rf + 1;
   	
				
   			int_retval = WritePendTrdRepFn(l_broker_RF_rpt_file, int_l_page_no_rf, 2,1, p_ptr_log_file, p_intl_env_data_struct_h_d, l_debug_info_ptr);

   			if (int_retval != APL_SUCCESS)
      			return(APL_FAILURE);

       		int_l_lines_rpted_rf   = PAGE_HDR_LENGTH;
      	}
		 }
		 else if(strcmp(l_sys_dl_deal_struct_hd.h_dealcd,"3")==0)
		 {
			if(APL_FAILURE == WritePendBrokRepDetFn(l_broker_DVP_rpt_file, l_sys_dl_deal_struct_hd.h_domcpclt_cd,chr_l_cntac_acntof , l_sys_dl_deal_struct_hd.h_dl_client, chr_l_acc_cl_code, l_sys_dl_deal_struct_hd.h_instr_code, chr_l_newissue, l_sys_dl_deal_struct_hd.h_dealcd,  l_sys_dl_deal_struct_hd.h_qty, dbl_l_amount_a, p_ptr_log_file, p_intl_env_data_struct_h_d, l_debug_info_ptr))
         {
            APL_GOBACK_FAIL
         }

         int_l_lines_rpted_dvp = int_l_lines_rpted_dvp + 2;

         if (int_l_lines_rpted_dvp == REPORT_PAGE_LEN)
         {
            int_l_page_no_dvp = int_l_page_no_dvp + 1;

            
            int_retval = WritePendTrdRepFn(l_broker_DVP_rpt_file, int_l_page_no_dvp, 3,1, p_ptr_log_file, p_intl_env_data_struct_h_d, l_debug_info_ptr);

            if (int_retval != APL_SUCCESS)
               return(APL_FAILURE);

            int_l_lines_rpted_dvp   = PAGE_HDR_LENGTH;
         }
		 }
		 else if(strcmp(l_sys_dl_deal_struct_hd.h_dealcd,"4")==0)
		 {
			if(APL_FAILURE == WritePendBrokRepDetFn(l_broker_RVP_rpt_file, l_sys_dl_deal_struct_hd.h_domcpclt_cd,chr_l_cntac_acntof , l_sys_dl_deal_struct_hd.h_dl_client, chr_l_acc_cl_code, l_sys_dl_deal_struct_hd.h_instr_code, chr_l_newissue, l_sys_dl_deal_struct_hd.h_dealcd,  l_sys_dl_deal_struct_hd.h_qty, dbl_l_amount_a, p_ptr_log_file, p_intl_env_data_struct_h_d, l_debug_info_ptr))
         {
            APL_GOBACK_FAIL
         }

         int_l_lines_rpted_rvp = int_l_lines_rpted_rvp + 2;

         if (int_l_lines_rpted_rvp == REPORT_PAGE_LEN)
         {
            int_l_page_no_rvp = int_l_page_no_rvp + 1;

            
            int_retval = WritePendTrdRepFn(l_broker_RVP_rpt_file, int_l_page_no_rvp, 4,1, p_ptr_log_file, p_intl_env_data_struct_h_d, l_debug_info_ptr);

            if (int_retval != APL_SUCCESS)
               return(APL_FAILURE);

            int_l_lines_rpted_rvp   = PAGE_HDR_LENGTH;
         }
		 }
		}

	if (strcmp(chr_l_gen_handoff_file_flg,"Y") == 0)
	{
		EXEC SQL CLOSE PEND_TXN_CUR;
			IS_ANY_ORA_ERROR
	}
	else
	{
		EXEC SQL CLOSE PEND_TXN_CUR1;
			IS_ANY_ORA_ERROR
	}
   fprintf(l_broker_RF_rpt_file,"\n\n");
   fprintf(l_broker_DF_rpt_file,"\n\n");
   fprintf(l_broker_DVP_rpt_file,"\n\n");
   fprintf(l_broker_RVP_rpt_file,"\n\n");


   for(i=0;i<158;i++)
	{
      fprintf(l_broker_DF_rpt_file,"-");
	}
      fprintf(l_broker_DF_rpt_file,"\n");

   for(i=0;i<158;i++)
	{
      fprintf(l_broker_RF_rpt_file,"-");
	}
      fprintf(l_broker_RF_rpt_file,"\n");

   for(i=0;i<158;i++)
	{
      fprintf(l_broker_DVP_rpt_file,"-");
	}
      fprintf(l_broker_DVP_rpt_file,"\n");

   for(i=0;i<158;i++)
	{
      fprintf(l_broker_RVP_rpt_file,"-");
	}
      fprintf(l_broker_RVP_rpt_file,"\n");

   APL_GOBACK_SUCCESS

   RETURN_SUCCESS :
   {

      if (strcmp(chr_l_gen_handoff_file_flg,"Y") == 0)
      {
            fclose(l_ptr_AHR_handoff_file);
            fclose(l_ptr_AHS_handoff_file);
            fclose(l_ptr_AU_handoff_file);

		}
      free(l_intl_rept_struct_ha);
      
      fclose(l_ptr_ini_file);

      

      int_retval = CO_Proc_RptClose(l_broker_DF_rpt_file,l_debug_info_ptr);

      if (int_retval != APL_SUCCESS)
         return(APL_FAILURE);

      int_retval = CO_Proc_RptClose(l_broker_RF_rpt_file,l_debug_info_ptr);

      if (int_retval != APL_SUCCESS)
         return(APL_FAILURE);

      int_retval = CO_Proc_RptClose(l_broker_DVP_rpt_file,l_debug_info_ptr);

      if (int_retval != APL_SUCCESS)
         return(APL_FAILURE);

      int_retval = CO_Proc_RptClose(l_broker_RVP_rpt_file,l_debug_info_ptr);

      if (int_retval != APL_SUCCESS)
         return(APL_FAILURE);

      CO_ProcMonitor(p_ptr_log_file,"Leaving processtion PendTxnFn successfully\n",NULL,p_intl_env_data_struct_h_d);
      return(APL_SUCCESS);
   }

   RETURN_FAILURE :
   {
      if (strcmp(chr_l_gen_handoff_file_flg,"Y") == 0)
      {
            fclose(l_ptr_AHR_handoff_file);
            fclose(l_ptr_AHS_handoff_file);
            fclose(l_ptr_AU_handoff_file);

		}
      free(l_intl_rept_struct_ha);
      
      fclose(l_ptr_ini_file);
      

      int_retval = CO_Proc_RptClose(l_broker_DF_rpt_file,l_debug_info_ptr);

      if (int_retval != APL_SUCCESS)
         return(APL_FAILURE);

      int_retval = CO_Proc_RptClose(l_broker_RF_rpt_file,l_debug_info_ptr);

      if (int_retval != APL_SUCCESS)
         return(APL_FAILURE);

      int_retval = CO_Proc_RptClose(l_broker_DVP_rpt_file,l_debug_info_ptr);

      if (int_retval != APL_SUCCESS)
         return(APL_FAILURE);

      int_retval = CO_Proc_RptClose(l_broker_RVP_rpt_file,l_debug_info_ptr);

      if (int_retval != APL_SUCCESS)
         return(APL_FAILURE);
      CO_ProcMonitor(p_ptr_log_file,"Leaving processtion PendTxnFn with failure \n",NULL,p_intl_env_data_struct_h_d);
      return(APL_FAILURE);
   }
}



int CDBGenCRIBrkEntryTrFn(FILE *p_ptr_clh_tr_file,DL_CLHCRI_STRUCT_H *p_dl_clhcri_struct_h,FILE *p_ptr_log_file,int p_flg_typ_file,INTL_ENV_DATA_STRUCT_H *p_intl_env_data_struct_h_d,DEBUG_INFO_STRUCT_H **l_debug_info_ptr)
{
	struct sqlca  sqlca;
   char chr_l_rep_seq[11] = APL_NULL_STRING;
   char chr_l_rep_qty[19] = APL_NULL_STRING;
   char          l_quantity[QUANTITY_LEN+1] = APL_NULL_STRING;
   int  int_typeoftransfer = 0;
   char          chr_l_qty1[5] = APL_NULL_STRING;
   int i = 0 ;
	int int_l_start = 0;

	CO_ProcMonitor(p_ptr_log_file,"Entered processtion CDBGenCRIBrkEntryTrFn \n",NULL,p_intl_env_data_struct_h_d);
	
	sqlca.sqlcode = 0;

	CO_ToStr(p_dl_clhcri_struct_h->h_sequence_num,10,0,chr_l_rep_seq);
   if (strlen(p_dl_clhcri_struct_h->h_countclt))	
      int_typeoftransfer = 1;
   else
      int_typeoftransfer = 3;

	CO_ToStr(p_dl_clhcri_struct_h->h_qty,15,3,chr_l_rep_qty);


   i = 0;
   int_l_start = 0;

   while (isspace(chr_l_rep_qty[i]))
         i++;

   while(chr_l_rep_qty[i] != APL_NULL_CHAR)
			l_quantity[int_l_start++] = chr_l_rep_qty[i++];

	l_quantity[int_l_start] = APL_NULL_CHAR;


   strcpy(chr_l_qty1,".00");
	if (strchr(l_quantity,'.') != NULL)
	{
   	strcat(chr_l_qty1,strchr(l_quantity,'.') + 3);
   	chr_l_qty1[4] = APL_NULL_CHAR;
	}
	else
		strcat(chr_l_qty1,APL_NULL_STRING);

   if (((p_flg_typ_file==1) && (strcmp(chr_l_qty1,".000")!=0))||(p_flg_typ_file==2))  
   fprintf(p_ptr_clh_tr_file,"%s,%d,%s,%s,CIY,%s,SERB,,,,,%s,,%s,SERB,,,,,XIST,%s,A,%s,1,1,N,00010,%s,235900,N,N,50\n",chr_l_rep_seq,int_typeoftransfer,p_dl_clhcri_struct_h->h_sys_dt,p_dl_clhcri_struct_h->h_set_dt,p_dl_clhcri_struct_h->h_dl_client,p_dl_clhcri_struct_h->h_clh_client,p_dl_clhcri_struct_h->h_countclt,p_dl_clhcri_struct_h->h_instr_isin,chr_l_rep_qty,p_dl_clhcri_struct_h->h_set_dt);	

	RETURN_SUCCESS :
	{
		CO_ProcMonitor(p_ptr_log_file,"Leaving processtion CDBGenCRIBrkEntryTrFn successfully\n",NULL,p_intl_env_data_struct_h_d);

		return(APL_SUCCESS);
	}
	
	RETURN_FAILURE :
	{
		CO_ProcMonitor(p_ptr_log_file,"Leaving processtion CDBGenCRIBrkEntryTrFn with failure\n",NULL,p_intl_env_data_struct_h_d);
	
		return(APL_FAILURE);
	}
}
