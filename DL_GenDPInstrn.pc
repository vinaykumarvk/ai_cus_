/**
 *    COPYRIGHT NOTICE
 *
 *   Copyright 2005 Polaris Software Lab Limited. All rights reserved.
 *
 *   These materials are confidential and proprietary to 
 *    Polaris Software Lab Limited and no part of these materials should
 *    be reproduced, published, transmitted or distributed in any form or
 *    by any means, electronic, mechanical, photocopying, recording or 
 *    otherwise, or stored in any information storage or retrieval system
 *    of any nature nor should the materials be disclosed to third parties
 *    or used in any other manner for which this is not authorized, without
 *    the prior express written authorization of Polaris Software Lab Limited.
 */
/*******************************************************************************
 *
 * Module Name         :         Deal Processing
 *
 * File Name           :         DL_GenDPInstrn.pc
 *
 * Description         :         This file contains all functions for Payin/Payout 
 *                               Accounting Entries Generation.
 *
 *            Version Control Block
 *
 * Date        Version		Author              Description		RFS No.
 * ---------   --------	 ---------------  ----------------------------------
 * 23/03/2006   1.0        Amit Bhosale			New File	HDFCDL_014
         //AIX-Warnings Removal -- for printf stmts--12032010
 * -----------------------------------------------------------------------------
 *
 * Jun-2010               Narendra Kumar V   Length  of  Batch No  var  ISKB_3298
 *                                           is increased for the NSDL
 *                                           DP Instructions file form
 *                                           at changes  initiated  by 
 *                                           the depository.
 *
 *
 * August-2019            Swapnil Jamble     Instruction 905 is stopped,   ISKB_12434 
 *                                           if deal class is "26" 
 *											 and client parameter is "N". 
 *											 
 *											 
 * September-2019         Shradha Vaingankar Instruction 934 is Generated  ISKB_12434
 *                                           for PMS client,   
 *                                           if CMBP id is maintained 
 *                                           for client.
 ******************************************************************************/


#include "Intellect_Common.h"
#include "CO_HostStructdef.h"
#include "DL_Interface.h"
#include	<stdlib.h>
#include	<DL_Csd.h>
/* OPT:AIX */
#ifdef BUFFER_LEN
#undef BUFFER_LEN
#endif
#define BUFFER_LEN 1000			/*** Was forced to do this ***/
#define APL_STATUS_START   "started"


EXEC SQL INCLUDE SQLCA.H;
int main(int argc,char **argv)
{
   /* DEBUG_INFO_STRUCT_H **l_debug_info_ptr= NULL; ***/
	DEBUG_INFO_STRUCT_H   *l_debug_info_struct = NULL, **l_debug_info_ptr = &l_debug_info_struct;
   INTL_ENV_DATA_STRUCT_H *l_intl_env_data_h;
   int int_num=0;
   char **temp= NULL;
   FILE *g_flogfile= NULL;
   char l_temp_processing_status[51] = APL_NULL_STRING;
   char  chr_g_log_buffer[BUFFER_LEN] = APL_NULL_STRING;
   struct sqlca sqlca;
	/* int int_l_condexists = 0; OPT:AIX */
	short int_l_condexists = 0;
 
  char chr_l_user[APL_USERID_LEN] = APL_NULL_STRING;
  char chr_l_instr_type[2]= APL_NULL_STRING;
  char chr_l_trns_type[2]=APL_NULL_STRING;
  char chr_l_depository_code[2]= APL_NULL_STRING;
  char chr_l_file_type[2]=APL_NULL_STRING;
  char chr_l_deal_date[20]=APL_NULL_STRING;
  char chr_l_exch_code[4]=APL_NULL_STRING;
  char chr_l_settlement_no[16] = APL_NULL_STRING;
  char chr_l_mkt_type[4]= APL_NULL_STRING;
  char chr_l_dp_id[21]= APL_NULL_STRING;
 char chr_l_906_912_flg[4] = APL_NULL_STRING; //added by shyam for early payin

	/* START -- Added by Minal for Implementation Of DIS in INTELLECT CUSTODY on 12/09/2014 */

	char chr_l_transfer_reason_cd[5]= APL_NULL_STRING;
	char chr_l_reason_purpose[23]= APL_NULL_STRING;

	/* END -- Added by Minal for Implementation Of DIS in INTELLECT CUSTODY on 12/09/2014 */

	char chr_rec_type[2]= APL_NULL_STRING;
		memset(chr_rec_type, APL_NULL_CHAR,2);
		strcpy(chr_rec_type,"N");
		printf("\n RECORD TYPE IS |%s|\n",chr_rec_type);


		EXEC SQL BEGIN DECLARE SECTION;

		      EXEC SQL VAR chr_l_instr_type IS STRING;
				EXEC SQL VAR chr_l_trns_type IS STRING;
				EXEC SQL VAR chr_l_depository_code IS STRING;
				EXEC SQL VAR chr_l_file_type IS STRING;
				EXEC SQL VAR chr_l_deal_date IS STRING;
				EXEC SQL VAR chr_l_exch_code IS STRING;
				EXEC SQL VAR chr_l_settlement_no IS STRING;
				EXEC SQL VAR chr_l_mkt_type IS STRING;
				EXEC SQL VAR chr_l_dp_id IS STRING;
                EXEC SQL VAR chr_l_906_912_flg IS STRING; //added by shyam for early payin

		/* START -- Added by Minal for Implementation Of DIS in INTELLECT CUSTODY on 12/09/2014 */

		EXEC SQL VAR chr_l_transfer_reason_cd IS STRING;
		EXEC SQL VAR chr_l_reason_purpose IS STRING;

		/* END -- Added by Minal for Implementation Of DIS in INTELLECT CUSTODY on 12/09/2014 */


		EXEC SQL END DECLARE SECTION;
  
		l_debug_info_ptr = (DEBUG_INFO_STRUCT_H **)calloc(1,sizeof(DEBUG_INFO_STRUCT_H *));	  
		l_intl_env_data_h   =  (INTL_ENV_DATA_STRUCT_H*)calloc(1,sizeof(INTL_ENV_DATA_STRUCT_H));
		APL_MALLOC_FAIL(l_intl_env_data_h);

   if(CO_Get_DBConnect(l_debug_info_ptr) == APL_FAILURE)
  	 {
		APL_GOBACK_FAIL
    }


   if (APL_FAILURE == CO_Rtv_RptFileName( "3DP",
            APL_LOGFILE_DESC,
                 100,
                 argv[5],
                 argv,
                 &g_flogfile,
                 l_debug_info_ptr ))
   {
	 printf("\n Error in CO_Rtv_RptFileName \n");		
/*	 fprintf(g_flogfile, "Unable to Retrive Report Filename");
*/	 APL_GOBACK_FAIL
   }

	EXEC SQL COMMIT;
	IS_ANY_ORA_ERROR

	if(BT_Status_Update(argv[0],
				argv[1],
				argv[2],
				APL_STARTED_STATUS,
				l_debug_info_ptr) ==APL_FAILURE)
	{
		APL_GOBACK_FAIL
	}
	
	
	
	if ( CO_RtvSysParams(l_debug_info_ptr) == APL_FAILURE)
	{
		fprintf(g_flogfile, "Returned Failure from CO_RtvSysParams()");
		APL_GOBACK_FAIL
	}
	Alert("After CO_RtvSysParams");
					
	if (APL_FAILURE == CO_SplitStr( argv[9],
                ';',
                &int_num,
                &temp ))
   {
 		 fprintf(g_flogfile,"Returns Unsuccessfully from CO_SplitStr\n");
		 APL_GOBACK_FAIL
   }
	Alert("After CO_SplitStr");
	/*
	 if (int_num != 9)
		{
			printf("\n Total no of arguments are |%d|", int_num);
			fprintf(g_flogfile, "Improper Number of Arguements");
			APL_GOBACK_FAIL
		}
	*/
		memset ( chr_l_instr_type, APL_NULL_CHAR,2);
		memset ( chr_l_trns_type, APL_NULL_CHAR,2);
		memset( chr_l_depository_code, APL_NULL_CHAR,2);
		memset( chr_l_file_type,APL_NULL_CHAR,2);
		memset( chr_l_deal_date,APL_NULL_CHAR,APL_DATE_LEN);
		memset(chr_l_settlement_no,APL_NULL_CHAR,16);
		memset(chr_l_exch_code,APL_NULL_CHAR,4);
		memset(chr_l_mkt_type,APL_NULL_CHAR,4);
		memset(chr_l_dp_id,APL_NULL_CHAR,21);
		memset(chr_g_log_buffer,APL_NULL_CHAR,BUFFER_LEN);
        memset(chr_l_906_912_flg, APL_NULL_CHAR, sizeof(chr_l_906_912_flg)); //added by shyam for early payin

		strcpy(chr_l_user,argv[3]);
		strcpy(chr_l_instr_type,temp[0]);
		strcpy(chr_l_trns_type, temp[1]);
		strcpy(chr_l_depository_code, temp[2]);
		strcpy(chr_l_file_type, temp[3]);
		strcpy(chr_l_deal_date, temp[4]);
		strcpy(chr_l_settlement_no, temp[5]);
		strcpy(chr_l_exch_code, temp[6]);
		strcpy(chr_l_mkt_type, temp[7]);
		strcpy(chr_l_dp_id, temp[8]);
		



			/* START -- Added by Minal for Implementation Of DIS in INTELLECT CUSTODY on 12/09/2014 */

			memset(chr_l_transfer_reason_cd, APL_NULL_CHAR, sizeof(chr_l_transfer_reason_cd));
			memset(chr_l_reason_purpose, APL_NULL_CHAR, sizeof(chr_l_reason_purpose));

			strcpy(chr_l_transfer_reason_cd, temp[9]);
			strcpy(chr_l_reason_purpose, temp[10]);

			/* END -- Added by Minal for Implementation Of DIS in INTELLECT CUSTODY on 12/09/2014 */

			printf("Transfer Reason is: |%s| and Reason_Purpose is |%s| \n", chr_l_transfer_reason_cd, chr_l_reason_purpose);

		

/*   EXEC SQL SELECT PROCESSING_STATUS into :l_temp_processing_status
     FROM SYS_BATCHPROC
     WHERE PROCESS_NAME=:argv[0]
     AND   PROC_INIT=:argv[1]
     AND   STARTDATE=:argv[2]
     AND   STATUS='started'
     FOR UPDATE OF PROCESSING_STATUS,STATUS;

	IS_ANY_ORA_ERROR
*/


	sprintf(chr_g_log_buffer,"PASSED VALUES ARE: \n chr_l_instr_type=|%s|\n chr_l_trns_type=|%s|\n chr_l_depository_code=|%s| \n chr_l_file_type=|%s| \n chr_l_deal_date|%s| \n  chr_l_settlement_no|%s| \n  chr_l_exch_code|%s| \n  chr_l_mkt_type=|%s| \n  chr_l_dp_id=|%s|\n",
								chr_l_instr_type,chr_l_trns_type,chr_l_depository_code,chr_l_file_type,
								chr_l_deal_date,chr_l_settlement_no,chr_l_exch_code,chr_l_mkt_type,chr_l_dp_id);

	fprintf(g_flogfile,"%s",chr_g_log_buffer);


	Alert("Specific Instruction");

  if(strcmp(chr_l_trns_type,"C")==0)
  {

          strcpy(chr_l_906_912_flg , "912"); //added by shyam for early payin
     
     // chr_l_906_912_flg param is added to this function
	 if(APL_FAILURE ==Proc_GenCLH_Instrn(chr_l_instr_type,
											  chr_l_trns_type,
											  chr_l_depository_code,
											  chr_l_file_type,
											  chr_l_deal_date,
											  chr_l_exch_code,
											  chr_l_settlement_no,
											  chr_l_mkt_type,
											  chr_l_dp_id,
											  chr_l_user,	
                                              chr_l_906_912_flg,
											  g_flogfile,
											  l_intl_env_data_h,
											  &l_debug_info_ptr))
		{	
			fprintf(g_flogfile, "\n Proc_GenCLH_Instrn Returned Failure\n");
			APL_GOBACK_FAIL
		}
          /* added by shyam for early payin  start */
          if(!strcmp(chr_l_instr_type, "I"))
           {
				printf("\ncalling Proc_GenCLH_Instrn for 906\n");
				fprintf(g_flogfile,"Calling Proc_GenCLH_Instrn Function for 906\n");

                strcpy(chr_l_906_912_flg , "906");
                if(APL_FAILURE ==Proc_GenCLH_Instrn(chr_l_instr_type,
													                 chr_l_trns_type,
													                 chr_l_depository_code,
													                 chr_l_file_type,
													                 chr_l_deal_date,
													                 chr_l_exch_code,
													                 chr_l_settlement_no,
													                 chr_l_mkt_type,
													                 chr_l_dp_id,
													                 chr_l_user,	
                                                                     chr_l_906_912_flg,
													                 g_flogfile,
													                 l_intl_env_data_h,
													                 &l_debug_info_ptr))
						  {	
							   fprintf(g_flogfile, "\n Proc_GenCLH_Instrn for 906 Returned Failure\n");
							   APL_GOBACK_FAIL
						  }
           }
           /* added by shyam for early payin  end */

	if(strcmp(chr_l_instr_type,"O")==0)
	 {

		if(APL_FAILURE ==Proc_GenInterDP_CLH_Instrn(chr_l_instr_type,
											  chr_l_trns_type,
											  chr_l_depository_code,
											  chr_l_file_type,
											  chr_l_deal_date,
											  chr_l_exch_code,
											  chr_l_settlement_no,
											  chr_l_mkt_type,
											  chr_l_dp_id,
											  chr_l_user,
											  g_flogfile,
											  l_intl_env_data_h,
											  &l_debug_info_ptr))
		{	
			fprintf(g_flogfile, "\n Proc_GenInterDP_CLH_Instrn Returned Failure\n");
			APL_GOBACK_FAIL
		}
		
     }

		
  }

  if(strcmp(chr_l_trns_type,"D")==0)
  {

	if(APL_FAILURE ==Proc_GenDVP_Instrn(chr_l_instr_type,
											  chr_l_trns_type,
											  chr_l_depository_code,
											  chr_l_file_type,
											  chr_l_deal_date,
											  chr_l_exch_code,
											  chr_l_settlement_no,
											  chr_l_mkt_type,
											  chr_l_dp_id,
											  chr_l_user,	
											  g_flogfile,
											  l_intl_env_data_h,
											  &l_debug_info_ptr))
		{	
			fprintf(g_flogfile, "\n Proc_GenDVP_Instrn Returned Failure \n");
			APL_GOBACK_FAIL
		}

////////////////////////////////////////////////////////////////////////
if(strcmp(chr_l_instr_type,"O")==0)
{
	if(APL_FAILURE ==Proc_GenDVP_Instrn_master904(chr_l_instr_type,
											  chr_l_trns_type,
											  chr_l_depository_code,
											  chr_l_file_type,
											  chr_l_deal_date,
											  chr_l_exch_code,
											  chr_l_settlement_no,
											  chr_l_mkt_type,
											  chr_l_dp_id,
											  chr_l_user,	
											  g_flogfile,
											  l_intl_env_data_h,
											  &l_debug_info_ptr))
		{	
			fprintf(g_flogfile, "\n Proc_GenDVP_Instrn Returned Failure \n");
			APL_GOBACK_FAIL
		}
}
////////////////////////////////////////////////////////////////////////


/**	if(strcmp(chr_l_instr_type,"O")==0)
	 {

		if(APL_FAILURE ==Proc_GenInterDP_DVP_Instrn(chr_l_instr_type,
											  chr_l_trns_type,
											  chr_l_depository_code,
											  chr_l_file_type,
											  chr_l_deal_date,
											  chr_l_exch_code,
											  chr_l_settlement_no,
											  chr_l_mkt_type,
											  chr_l_dp_id,
											  chr_l_user,
											  g_flogfile,
											  l_intl_env_data_h,
											  &l_debug_info_ptr))
		{	
			fprintf(g_flogfile, "\n Proc_GenInterDP_DVP_Instrn Returned Failure \n");
			APL_GOBACK_FAIL
		}
		
     }***/


 }
		/*	DP Instruction Generation of OffMarket for ICICI */
			if(strcmp(chr_l_trns_type,"O")==0)
			{

					Alert("\n calling Proc_GenOffMkt_Instrn \n");

					fprintf(g_flogfile,"Calling Proc_GenOffMkt_Instrn Function \n");

					/* Modified by Minal for Implementation Of DIS in INTELLECT CUSTODY on 12/09/2014 */

					if(APL_FAILURE == Proc_GenOffMkt_Instrn(chr_l_instr_type,
															chr_l_trns_type,
															chr_l_depository_code,
															chr_l_file_type,
															chr_l_deal_date,
															chr_l_dp_id,
															chr_l_user,
															chr_rec_type,
															chr_l_transfer_reason_cd,
															chr_l_reason_purpose,
															g_flogfile,
															l_intl_env_data_h,
															&l_debug_info_ptr))
					{	
						fprintf(g_flogfile, "\n Proc_GenOffMkt_Instrn Returned Failure \n");
						APL_GOBACK_FAIL
					}
					
					if(strcmp(chr_l_instr_type,"O")==0)
					{
					if(APL_FAILURE == Proc_GenOffMkt_Instrn_master904(chr_l_instr_type,
															chr_l_trns_type,
															chr_l_depository_code,
															chr_l_file_type,
															chr_l_deal_date,
															chr_l_dp_id,
															chr_l_user,
															chr_rec_type,
															chr_l_transfer_reason_cd,
															chr_l_reason_purpose,
															g_flogfile,
															l_intl_env_data_h,
															&l_debug_info_ptr))
					{	
						fprintf(g_flogfile, "\n Proc_GenOffMkt_Instrn Returned Failure \n");
						APL_GOBACK_FAIL
					}
					}
					
			}



 
  

  

	RETURN_SUCCESS :
	{

		if(APL_FAILURE == BT_Status_Completed(argv[0],argv[1],argv[2],l_debug_info_ptr))
		{
			APL_GOBACK_FAIL
		}
		EXEC SQL COMMIT WORK;
		if(sqlca.sqlcode != 0)
			APL_GOBACK_FAIL
		exit(0);
	}
	RETURN_FAILURE :
	{
		printf("\n Failed To Generate DP Instruction: ORA|%d|\n\n",sqlca.sqlcode);
		CO_ProcMonitor(g_flogfile, "Failed To Generate DP Instruction", l_debug_info_ptr, NULL);
/*		CO_Proc_RptClose(g_flogfile,&l_debug_info_ptr);*/
		exit(-1);
	}

 }

  // added by shyam, chr_p_906_912_flg param added to this function 
  int Proc_GenCLH_Instrn(char *chr_p_instr_type,
						  char *chr_p_trns_type,
						  char *chr_p_depository_code,
						  char *chr_p_file_type,
						  char *chr_p_deal_date,
						  char *chr_p_exch_code,
						  char *chr_p_settlement_no,
						  char *chr_p_mkt_type,
						  char *chr_p_dp_id,
						  char *chr_p_user,
                          char *chr_p_906_912_flg,
						  FILE *g_flogfile,
						  INTL_ENV_DATA_STRUCT_H *l_intl_env_data_h,
						  DEBUG_INFO_STRUCT_H **l_debug_info_ptr)
  {

	FILE  *l_ptr_ini_file = NULL;
	FILE  *l_ptr_handoff_file = NULL;
	char  chr_g_log_buffer[BUFFER_LEN] = APL_NULL_STRING;
	char  chr_l_inifile[100]= APL_NULL_STRING;
	char  chr_l_handoff_dir[PATH_LENGTH]= APL_NULL_STRING;
    char  chr_l_handoff_file_name[FILENAME_LEN_A]= APL_NULL_STRING;	
	char  chr_l_header[100]= APL_NULL_STRING;
	char  chr_l_trailer[200]= APL_NULL_STRING;
	char  chr_l_detail_rec[1000] =APL_NULL_STRING;
	int  int_l_batchseq=0;
	int  int_l_batchseq_934=0; //Added by Asmeet for ISKB_12434  PMS_ON_MARKET
	int  int_l_batchseq_934_t2t=0; //Added by Asmeet for ISKB_12434  PMS_ON_MARKET
	int   counter=0;
	int   counter_934=0;  //Added by Asmeet for ISKB_12434  PMS_ON_MARKET
	int   batch_seq_display_934=0;  //Added by Asmeet for ISKB_12434  PMS_ON_MARKET
	int   batch_seq_display_934_t2t=0;  //Added by Asmeet for ISKB_12434  PMS_ON_MARKET
	int   batch_seq_display_904_t2t=0;  //Added by Asmeet for ISKB_12434  PMS_ON_MARKET
	int   batch_seq_display=0;  //Added by Asmeet for ISKB_12434  PMS_ON_MARKET
	char  chr_l_instr_isin[13]= APL_NULL_STRING;
	char  chr_l_oth_cmbpid[29]= APL_NULL_STRING;
	char  chr_l_oth_setlno[8]= APL_NULL_STRING;
	char  chr_l_oth_mkt_type[3]= APL_NULL_STRING;
	char  chr_l_remark[21]= APL_NULL_STRING;
	/* char  chr_l_send_refno1[36]= APL_NULL_STRING;
	char  chr_l_send_refno2[36]= APL_NULL_STRING; 
	** Modified For ISKB_3298 Changes - Jun2010 - Naren V */
	char  chr_l_send_refno1[51]= APL_NULL_STRING;
	char  chr_l_send_refno2[51]= APL_NULL_STRING; 
	char  chr_l_depo_part_code[21]=APL_NULL_STRING;
	char chr_l_cmbp_id[29]=APL_NULL_STRING;
	int int_l_len=0;
 	char  chr_p_depository_code_new[5]= APL_NULL_STRING;
   char  chr_p_instr_type_new;
	int int_l_records=0;
	short i_int_l_records=0;
	char chr_l_dprole[3]= APL_NULL_STRING;
	char  chr_l_user[APL_USERID_LEN] = APL_NULL_STRING;
	char  pro_sys_date[APL_DATE_LEN] = APL_NULL_STRING;
	char chr_l_maker[APL_USERID_LEN] = APL_NULL_STRING;
	char  chr_l_maker_dt[APL_DATE_LEN] = APL_NULL_STRING;
	char  chr_l_access_stamp[APL_DATE_LEN] = APL_NULL_STRING;
	/* char  chr_l_internal_ref_no[21] = APL_NULL_STRING;
	** Modified For ISKB_3298 Changes - Jun2010 - Naren V */
	char  chr_l_internal_ref_no[36] = APL_NULL_STRING;
	char chr_l_settlement_dt[20] = APL_NULL_STRING;
	short i_settlement_dt=0;
	char chr_l_instruction_type[4] = APL_NULL_STRING;
	double l_tot_qty=0.0;
	short i_l_tot_qty=0;
	short i_depo_part_code=0;
	char chr_l_identiy_no[17]= APL_NULL_STRING;
	char chr_l_refno_str[4001]= APL_NULL_STRING;
	int   counter1=0;
	int   counter1_t2t=0; //Added by Asmeet for ISKB_12434  PMS_ON_MARKET
	double l_int_purchasesum=0.0;
	double l_int_salesum=0.0;
	double l_int_net_amt=0.0;
	char l_chr_instr_code[9]= APL_NULL_STRING;
	char chr_l_cln_dpid[21]= APL_NULL_STRING;
	char chr_l_cln_depomap_id[21]= APL_NULL_STRING;
	char chr_l_flg='Y';
	char chr_l_identiy_t2t[18]= APL_NULL_STRING;
	char chr_l_other_client_id[14]= APL_NULL_STRING;
	double int_l_deliver_qty=0.0;
	double int_l_receive_qty=0.0;
	int int_l_zero_qty=0;
	int int_l_zero_qty_t2t=0;
       /*Added by Asmeet for ISKB_12434  PMS_ON_MARKET starts*/
	int int_l_zero_qty_934=0;
	double int_l_deliver_qty_934=0.0;
	double int_l_receive_qty_934=0.0;
	double int_l_deliver_qty_904_t2t=0.0;
	double int_l_receive_qty_904_t2t=0.0;
	double int_l_deliver_qty_934_t2t=0.0;
	double int_l_receive_qty_934_t2t=0.0;
        /*Added by Asmeet for ISKB_12434  PMS_ON_MARKET ends*/
	char chr_l_dl_class[DL_DL_CLASS_LEN]=APL_NULL_STRING;
	
	
	short i_purchasesum=0;
	short i_salesum=0;
	short i_cln_dpid=0;
	short i_cln_depomap_id=0;
	short i_cmbp_id=0;
	short i_other_client_id=0;
	short i_instr_isin=0;
	short i_dl_class=0;
	/*Added by Asmeet for ISKB_12434  PMS_ON_MARKET starts*/
	int l_int_cnt=0;
	double l_int_hdr_qty=0.0;
	int l_int_cnt_934=0;
	double l_int_hdr_qty_934=0.0;
	int l_int_cnt_934_t2t=0;
	double l_int_hdr_qty_934_t2t=0.0;
	int l_int_cnt_904_t2t=0;
	double l_int_hdr_qty_904_t2t=0.0;
        /*Added by Asmeet for ISKB_12434  PMS_ON_MARKET ends*/
	char  chr_cmbp_id_new[9]=APL_NULL_STRING; //Added by Shradha for 934 generation KB_12434
	short i_cmbp_id_new=0;  //Added by Shradha for 934 generation KB_12434
	/******  Early Payin/Normal Payin Check : Vinay Kalaskar : 25/09/2008 *******/
        /* Added for Early Payin -- Retro from ICICI */
			int l_early_payin_check = 0;
        	char l_chr_deal_dt[APL_DATE_LEN] =  APL_NULL_STRING;
        	memset(l_chr_deal_dt,APL_NULL_CHAR,sizeof(l_chr_deal_dt));
        	short i_chr_dt_flg = 0;
			char l_chr_setl_dt[APL_DATE_LEN] =  APL_NULL_STRING;	
        	memset(l_chr_setl_dt,APL_NULL_CHAR,sizeof(l_chr_setl_dt));
        /* Added for Early Payin -- Retro from ICICI */

	
	SYS_DL_DEAL_STRUCT_H  *l_dl_deal_struct_h = NULL;
        SYS_DL_DEAL_STRUCT_I  *l_dl_deal_struct_i = NULL;	
		
	
	
	l_dl_deal_struct_h=(SYS_DL_DEAL_STRUCT_H *)calloc(1,sizeof(SYS_DL_DEAL_STRUCT_H));
	APL_MALLOC_FAIL(l_dl_deal_struct_h)
	l_dl_deal_struct_i=(SYS_DL_DEAL_STRUCT_I *)calloc(1,sizeof(SYS_DL_DEAL_STRUCT_I));
	APL_MALLOC_FAIL(l_dl_deal_struct_i)

	memset(l_dl_deal_struct_h, NULL, sizeof(SYS_DL_DEAL_STRUCT_H));
	memset(l_dl_deal_struct_i, 0, sizeof(SYS_DL_DEAL_STRUCT_I));
		memset(chr_g_log_buffer,APL_NULL_CHAR,BUFFER_LEN);

	EXEC SQL BEGIN DECLARE SECTION;
    
    

/*		EXEC SQL VAR chr_p_instr_type IS STRING;
		EXEC SQL VAR chr_p_trns_type IS STRING;
	 	EXEC SQL VAR chr_p_depository_code IS STRING;
		EXEC SQL VAR chr_p_file_type IS STRING;
		EXEC SQL VAR chr_p_deal_date IS STRING;
		EXEC SQL VAR chr_p_exch_code IS STRING;
		EXEC SQL VAR chr_p_settlement_no IS STRING;
		EXEC SQL VAR chr_p_mkt_type IS STRING;
		EXEC SQL VAR chr_p_dp_id IS STRING;	
		EXEC SQL VAR chr_p_instr_type_new IS STRING;
*/		EXEC SQL VAR chr_p_depository_code_new IS STRING;		
		EXEC SQL VAR chr_l_header IS STRING;
		EXEC SQL VAR chr_l_trailer IS STRING;
		EXEC SQL VAR chr_l_instruction_type IS STRING;
		EXEC SQL VAR chr_l_depo_part_code IS STRING;	
		EXEC SQL VAR chr_l_instr_isin IS STRING;
		EXEC SQL VAR chr_l_maker IS STRING;
		EXEC SQL VAR chr_l_maker_dt IS STRING;
		EXEC SQL VAR chr_l_access_stamp IS STRING;
		EXEC SQL VAR chr_l_settlement_dt IS STRING;
		EXEC SQL VAR chr_l_identiy_no IS STRING;
		EXEC SQL VAR chr_l_cln_dpid IS STRING;
		EXEC SQL VAR chr_l_cln_depomap_id IS STRING;
		EXEC SQL VAR chr_l_identiy_t2t IS STRING;
		EXEC SQL VAR chr_l_cmbp_id IS STRING;
		EXEC SQL VAR chr_l_dl_class IS STRING;
	   /* Changes by Vilin for IDO File Generation --> Start */
		EXEC SQL VAR l_chr_setl_dt IS STRING;
		/* Changes by Vilin for IDO File Generation --> End */
		EXEC SQL VAR chr_cmbp_id_new IS STRING; //Added by Shradha for 934 generation KB_12434
		
	EXEC SQL END DECLARE SECTION;

	Alert("Enter CLH DPInstrn");
        /* added by shyam for early payin */
        if(strcmp(chr_p_instr_type,"I")==0)
       {
          fprintf(g_flogfile, "\n906/912 FLAG = |%s|\n", chr_p_906_912_flg);
          if(!strlen(chr_p_906_912_flg))
             strcpy(chr_p_906_912_flg, "912");
       }

		  strcpy(chr_l_maker,chr_p_user);

		  if (  CO_RtvSysDt(pro_sys_date,l_debug_info_ptr) == APL_FAILURE )
		  {
            APL_GOBACK_FAIL
		  }
		  strcpy(chr_l_maker_dt,pro_sys_date);
		

		 if (  CO_RtvSysDtTime(pro_sys_date,l_debug_info_ptr) == APL_FAILURE )
         {
			 APL_GOBACK_FAIL
		 }
		 strcpy(chr_l_access_stamp,pro_sys_date);
        /* Added for Early Payin -- Retro from ICICI */
		/******  Early Payin/Normal Payin Check : Vinay Kalaskar : 25/09/2008 *******/
		strcpy(l_chr_deal_dt,chr_p_deal_date);
		Alert("Deal Date	|%s|\n",l_chr_deal_dt);
		fflush(stdout);
       /*  Changes by Vilin for IDO File Generation --> Start */
       /*	   
		EXEC SQL SELECT (A.PAY_OUT_DT - B.SYS_DATE) INTO :l_early_payin_check 
			FROM MT_SETTL_CAL A, PRO_SYS_DATE B 
			WHERE A.EXCH_CODE = :chr_p_exch_code
			AND TO_CHAR(A.START_DATE,'DD/MM/YYYY') = :chr_p_deal_date
			AND A.SETTL_TYPE = :chr_p_mkt_type 
			AND A.SETTL_NO = :chr_p_settlement_no ;

		
		if(sqlca.sqlcode < 0)
		{
			printf("Error After Payout Date Difference -- Ora Error :|%d|\n",sqlca.sqlcode);
		}

		printf("Payout & System Date Difference :|%d|\n",l_early_payin_check);


		if(l_early_payin_check > 0 )
		{
		if (CO_RtvNextDays(l_chr_deal_dt,
									1,
									chr_p_exch_code,
									l_chr_setl_dt,
									l_debug_info_ptr) != APL_SUCCESS)
		APL_GOBACK_FAIL

			printf("Execution Date For Early Payin : |%s|\n",l_chr_setl_dt);
		fflush(stdout);
		}
		else
		{
			if (CO_RtvNextDays(l_chr_deal_dt,
								2,
								chr_p_exch_code,
								l_chr_setl_dt,
								l_debug_info_ptr) != APL_SUCCESS)
			APL_GOBACK_FAIL

			printf("Execution Date For Normal Payin : |%s|\n",l_chr_setl_dt);
			fflush(stdout);
		}
		// Added for Early Payin -- Retro from ICICI  */
		/*Commented by Prateek on 30092014 for ISKB_6847(Execution Date is coming wrong in Case of Merge Settlement)- START
		EXEC SQL SELECT A.PAY_IN_DT into :l_chr_setl_dt  from MT_SETTL_CAL A 
		WHERE A.EXCH_CODE = :chr_p_exch_code
		AND TO_CHAR(A.START_DATE,'DD/MM/YYYY') = :chr_p_deal_date
		AND A.SETTL_TYPE = :chr_p_mkt_type 
		AND A.SETTL_NO = :chr_p_settlement_no;
		//Changes by Vilin for IDO File Generation --> END
		Commented by Prateek on 30092014 for ISKB_6847(Execution Date is coming wrong in Case of Merge Settlement) - END*/
		
		/*Rewritten by Prateek on 30092014 for ISKB_6847(Execution Date is coming wrong in Case of Merge Settlement) - START*/
		//In case of Merge Settlement Payin and Payout date can be different,so taking both the date separately
		if(strcmp(chr_p_instr_type,"I")==0)
		{
			EXEC SQL SELECT A.PAY_IN_DT into :l_chr_setl_dt  from MT_SETTL_CAL A 
			WHERE A.EXCH_CODE = :chr_p_exch_code
			AND TO_CHAR(A.START_DATE,'DD/MM/YYYY') = :chr_p_deal_date
			AND A.SETTL_TYPE = :chr_p_mkt_type 
			AND A.SETTL_NO = :chr_p_settlement_no;
			IS_ANY_ORA_ERROR

			printf("Sqlcode after fetching execution Date for Payin is |%d|",sqlca.sqlcode);
			printf("Execution Date for Payin is |%s|",l_chr_setl_dt);
		}
		
		if(strcmp(chr_p_instr_type,"O")==0)
		{
			EXEC SQL SELECT A.PAY_OUT_DT into :l_chr_setl_dt  from MT_SETTL_CAL A 
			WHERE A.EXCH_CODE = :chr_p_exch_code
			AND TO_CHAR(A.START_DATE,'DD/MM/YYYY') = :chr_p_deal_date
			AND A.SETTL_TYPE = :chr_p_mkt_type 
			AND A.SETTL_NO = :chr_p_settlement_no;
			IS_ANY_ORA_ERROR

			printf("Sqlcode after fetching execution Date for Payout is |%d|",sqlca.sqlcode);
			printf("Execution Date for Payout is |%s|",l_chr_setl_dt);
		}
		
		/*Rewritten by Prateek on 30092014 for ISKB_6847(Execution Date is coming wrong in Case of Merge Settlement) - END*/
	  
	 	fprintf(g_flogfile,"CLH:Inside Function Values Are .... \n");	 
		 fprintf(g_flogfile,"CLH:chr_p_instr_type|%s|\n",chr_p_instr_type);	
		fprintf(g_flogfile,"CLH:chr_p_trns_type|%s|\n",chr_p_trns_type);	
		fprintf(g_flogfile,"CLH:chr_p_depository_code|%s|\n",chr_p_depository_code);	
		fprintf(g_flogfile,"CLH:chr_p_file_type|%s|\n",chr_p_file_type);	
		fprintf(g_flogfile,"CLH:chr_p_deal_date|%s|\n",chr_p_deal_date);	
		fprintf(g_flogfile,"CLH:chr_p_exch_code|%s|\n",chr_p_exch_code);	
		fprintf(g_flogfile,"CLH:chr_p_settlement_no|%s|\n",chr_p_settlement_no);	
		fprintf(g_flogfile,"CLH:chr_p_mkt_type|%s|\n",chr_p_mkt_type);	
		fprintf(g_flogfile,"CLH:chr_p_dp_id|%s|\n",chr_p_dp_id);	

		 
		EXEC SQL SELECT DECODE(:chr_p_depository_code,'N','NSDL','C','CDSL')
			  			/*	 DECODE(:chr_p_instr_type,'I','3','O','4')	*/
						INTO :chr_p_depository_code_new FROM dual;
		IS_ANY_ORA_ERROR
	/* CHANGES MADE FOR SLB - AMISH - 27/03/2008 */
	if(((strcmp(chr_p_exch_code,"NSE")==0) && (strcmp(chr_p_mkt_type,"23")==0 || strcmp(chr_p_mkt_type,"24")==0 || strcmp(chr_p_mkt_type,"25")==0))
		|| 
	   ((strcmp(chr_p_exch_code,"BSE")==0) && (strcmp(chr_p_mkt_type,"18")==0 || strcmp(chr_p_mkt_type,"19")==0 || strcmp(chr_p_mkt_type,"20")==0))
	   ||
	   ((strcmp(chr_p_exch_code,"MCS")==0) && (strcmp(chr_p_mkt_type,"63")==0 || strcmp(chr_p_mkt_type,"64")==0 || strcmp(chr_p_mkt_type,"65")==0))
	  )
	 {
		chr_l_flg='N';
		fprintf(g_flogfile,"SLB TRANSACTION ..SO PROCESSING SHOULD BE LIKE T2T TRANSACTIONS \n");	

	 }
	
	 fprintf(g_flogfile,"NOT A SLB TRANSACTION \n");	
	if(chr_l_flg== 'Y')
	 {
	Alert("Before CLH Count");
	if(strcmp(chr_p_instr_type,"I")==0)	
	{
		EXEC SQL SELECT COUNT(*) INTO :int_l_records:i_int_l_records
	 	 FROM (SELECT COUNT(*)
		   FROM Dl_Deal a ,mt_instrument c,mt_cli_depo_map d,mt_exch_depo e
			WHERE a.client=d.cln_code
	 	    AND d.cln_depo_code=:chr_p_depository_code_new
			AND a.instr_code=c.instr_code
			AND TO_CHAR(a.deal_date,'DD/MM/YYYY')=:chr_p_deal_date
			AND a.exch_code=:chr_p_exch_code
			AND e.exch_code=a.exch_code
			AND a.mkt_type=:chr_p_mkt_type
			//AND a.mkt_type!=DECODE(a.exch_code,'NSE','22','BSE','16','MCS','03')/*Added by PT MCS*/
			AND ((a.mkt_type!= DECODE(a.exch_code,'NSE','22','BSE','16','MCS','03'))
			AND (a.mkt_type!= DECODE(a.exch_code,'NSE','50','BSE','17','MCS','24')))
			AND a.settlement_no=:chr_p_settlement_no
			AND a.clh_flg=:chr_p_trns_type
			AND e.dp_id=:chr_p_dp_id
			AND e.depo_code=:chr_p_depository_code_new
			AND (a.deal_cd = DECODE(:chr_p_instr_type,'I','1','O','2') OR
				  			a.deal_cd = DECODE(:chr_p_instr_type,'I','3','O','4'))
			AND a.deal_stat='CC' 
			AND a.NDS_BLK_DT is null
            /* added by shyam for early payin*/ 
            AND ((:chr_p_906_912_flg = '912' AND (a.CLIENT||'#'||a.IDENTIY_NO NOT IN(SELECT CLIENT||'#'||IDENTIY_NO FROM DL_EARLYPAYIN_DET WHERE STATUS = 'AA' AND SETTLEMENT_NO = :chr_p_settlement_no )))
                  OR
                (:chr_p_906_912_flg = '906' AND (a.CLIENT||'#'||a.IDENTIY_NO     IN(SELECT CLIENT||'#'||IDENTIY_NO FROM DL_EARLYPAYIN_DET WHERE STATUS = 'AA' AND SETTLEMENT_NO = :chr_p_settlement_no ))))
		  GROUP BY  a.client,d.cln_depo_map_client_id,a.instr_code,a.exch_code,a.settlement_no,a.mkt_type,a.deal_cd,
					c.instr_isin,a.setl_date,cln_depo_map_dp_id,e.cm_cc_id,e.cln_id,a.dl_class) X;
		  
			IS_ANY_ORA_ERROR	
			
	            /* Changes by Shradha for 934 generation KB_12434 - Start*/
			 
				EXEC SQL SELECT NVL(SUM(X.tot_qty),0) INTO :l_tot_qty:i_l_tot_qty
				 FROM (SELECT DECODE(:chr_p_instr_type,'I',NVL(SUM(a.qty),0),'O',NVL(SUM(a.allot_qty),0)) as tot_qty 
				    FROM DL_DEAL A ,
				    MT_INSTRUMENT C,
				    MT_CLI_DEPO_MAP D,
				    MT_EXCH_DEPO E
					WHERE a.client=d.cln_code
					AND d.cln_depo_code=:chr_p_depository_code_new
					AND a.instr_code=c.instr_code
					AND TO_CHAR(a.deal_date,'DD/MM/YYYY')=:chr_p_deal_date
					AND a.exch_code=:chr_p_exch_code
					AND e.exch_code=a.exch_code
					AND a.mkt_type=:chr_p_mkt_type
					//AND a.mkt_type!=DECODE(a.exch_code,'NSE','22','BSE','16','MCS','03')/*Added by PT MCS*/
			AND ((a.mkt_type!= DECODE(a.exch_code,'NSE','22','BSE','16','MCS','03'))
			AND (a.mkt_type!= DECODE(a.exch_code,'NSE','50','BSE','17','MCS','24')))					
					AND a.settlement_no=:chr_p_settlement_no
					AND a.clh_flg=:chr_p_trns_type
					AND e.dp_id=:chr_p_dp_id
					AND e.depo_code=:chr_p_depository_code_new
					AND (a.deal_cd = DECODE(:chr_p_instr_type,'I','1','O','2') OR
									a.deal_cd = DECODE(:chr_p_instr_type,'I','3','O','4'))
					AND a.deal_stat='CC'
					AND a.NDS_BLK_DT is null
					/* added by shyam for early payin*/ 
					AND ((:chr_p_906_912_flg = '912' AND (a.CLIENT||'#'||a.IDENTIY_NO NOT IN(SELECT CLIENT||'#'||IDENTIY_NO FROM DL_EARLYPAYIN_DET WHERE STATUS = 'AA' AND SETTLEMENT_NO = :chr_p_settlement_no )))
						  OR
						(:chr_p_906_912_flg = '906' AND (a.CLIENT||'#'||a.IDENTIY_NO     IN(SELECT CLIENT||'#'||IDENTIY_NO FROM DL_EARLYPAYIN_DET WHERE STATUS = 'AA' AND SETTLEMENT_NO = :chr_p_settlement_no ))))
					AND d.CMBP_ID is null  /* Added by Shradha for 934 generation KB_12434 */
				  GROUP BY  a.client,d.cln_depo_map_client_id,a.instr_code,a.exch_code,a.settlement_no,a.mkt_type,a.deal_cd,
							c.instr_isin,a.setl_date,cln_depo_map_dp_id,e.cm_cc_id,e.cln_id,a.dl_class) X;
				  
					IS_ANY_ORA_ERROR	  
			 
		  /* Changes by Shradha for 934 generation KB_12434 - End */
		
	}
	if(strcmp(chr_p_instr_type,"O")==0)	
    {
		EXEC SQL SELECT COUNT(*) INTO :int_l_records:i_int_l_records
	 	 FROM (SELECT COUNT(*)
		   FROM Dl_Deal a ,mt_instrument c,mt_cli_depo_map d,mt_exch_depo e,dl_markshortage f
			WHERE a.client=d.cln_code
	 	    AND d.cln_depo_code=:chr_p_depository_code_new
			AND a.instr_code=c.instr_code
			AND TO_CHAR(a.deal_date,'DD/MM/YYYY')=:chr_p_deal_date
			AND a.exch_code=:chr_p_exch_code
			AND e.exch_code=a.exch_code
			AND a.mkt_type=:chr_p_mkt_type
			//AND a.mkt_type!=DECODE(a.exch_code,'NSE','22','BSE','16','MCS','03') /*Added by PT MCS*/
						AND ((a.mkt_type!= DECODE(a.exch_code,'NSE','22','BSE','16','MCS','03'))
			AND (a.mkt_type!= DECODE(a.exch_code,'NSE','50','BSE','17','MCS','24')))
			AND a.settlement_no=:chr_p_settlement_no
			AND a.clh_flg=:chr_p_trns_type
			AND e.dp_id=:chr_p_dp_id
			AND e.depo_code=:chr_p_depository_code_new
			AND f.depo_code=:chr_p_depository_code_new
			AND a.client=f.dl_client
			AND a.identiy_no=f.dl_ref_no
			AND NVL(f.pool_trans,'N')='N'
			AND (a.deal_cd = DECODE(:chr_p_instr_type,'I','1','O','2') OR
				  			a.deal_cd = DECODE(:chr_p_instr_type,'I','3','O','4'))
			AND a.deal_stat IN('CC','MS')
			AND a.NDS_BLK_DT is null
		  GROUP BY  a.client,d.cln_depo_map_client_id,a.instr_code,a.exch_code,a.settlement_no,a.mkt_type,a.deal_cd,
					c.instr_isin,a.setl_date,cln_depo_map_dp_id,e.cm_cc_id,e.cln_id,a.dl_class) X;
		  
			IS_ANY_ORA_ERROR
			
			/* Changes by Shradha for 934 generation KB_12434 - Start */
					EXEC SQL SELECT NVL(SUM(X.tot_qty),0) INTO :l_tot_qty:i_l_tot_qty
				 FROM (SELECT DECODE(:chr_p_instr_type,'I',NVL(SUM(a.qty),0),'O',NVL(SUM(a.allot_qty),0)) as tot_qty 
				   FROM DL_DEAL A ,MT_INSTRUMENT C,MT_CLI_DEPO_MAP D,MT_EXCH_DEPO E,DL_MARKSHORTAGE F
					WHERE a.client=d.cln_code
					AND d.cln_depo_code=:chr_p_depository_code_new
					AND a.instr_code=c.instr_code
					AND TO_CHAR(a.deal_date,'DD/MM/YYYY')=:chr_p_deal_date
					AND a.exch_code=:chr_p_exch_code
					AND e.exch_code=a.exch_code
					AND a.mkt_type=:chr_p_mkt_type
					//AND a.mkt_type!=DECODE(a.exch_code,'NSE','22','BSE','16','MCS','03') /*Added by PT MCS*/
								AND ((a.mkt_type!= DECODE(a.exch_code,'NSE','22','BSE','16','MCS','03'))
			AND (a.mkt_type!= DECODE(a.exch_code,'NSE','50','BSE','17','MCS','24')))
					AND a.settlement_no=:chr_p_settlement_no
					AND a.clh_flg=:chr_p_trns_type
					AND e.dp_id=:chr_p_dp_id
					AND e.depo_code=:chr_p_depository_code_new
					AND f.depo_code=:chr_p_depository_code_new
					AND a.client=f.dl_client
					AND a.identiy_no=f.dl_ref_no
					AND NVL(f.pool_trans,'N')='N'
					AND (a.deal_cd = DECODE(:chr_p_instr_type,'I','1','O','2') OR
									a.deal_cd = DECODE(:chr_p_instr_type,'I','3','O','4'))
					AND a.deal_stat IN('CC','MS') 
					AND a.NDS_BLK_DT is null
					AND d.CMBP_ID is null /* Added by Shradha for 934 generation KB_12434*/
				  GROUP BY  a.client,d.cln_depo_map_client_id,a.instr_code,a.exch_code,a.settlement_no,a.mkt_type,a.deal_cd,
							c.instr_isin,a.setl_date,cln_depo_map_dp_id,e.cm_cc_id,e.cln_id,a.dl_class) X;
				  
					IS_ANY_ORA_ERROR
			/* Changes by Shradha for 934 generation KB_12434 - End */
	}
		  if(int_l_records == 0)
		  {
			  fprintf(g_flogfile," CLH:NO Records Found For The Given Criteria !!! \n");
			  chr_l_flg='N';
		  }
	  	 IS_ANY_ORA_ERROR

	Alert("After CLH Count");
		 printf("\n No Of CLH Records|%d| \n",int_l_records);
		 sprintf(chr_g_log_buffer,"\n No Of CLH Records|%d| \n",int_l_records);
		 fprintf(g_flogfile,"%s",chr_g_log_buffer);
 }/*SLB CHGS */
	  if(chr_l_flg== 'Y')
	  {
		  /* Commented and added below by Asmeet to stop unneccesary generation of batch sequence  for ISKB_12434  PMS_ON_MARKET
		EXEC SQL SELECT DL_DPINSTRSEQ.NEXTVAL INTO :int_l_batchseq FROM DUAL;
		IS_ANY_ORA_ERROR
			*/
/********************** Inserting Header Record **********************/

/*Changed by Narendra Kumar for ISKB_3298 -- Static data change -- change of DP role from 04 to 01 -- Started*/

/*		EXEC SQL INSERT INTO
		  	dl_dpinstr_hdr(batch_no,record_type,dp_id,dp_role,status,buy_sell_flg,tot_num_record,
								tot_qty,maker,maker_date,access_stamp)
					  VALUES(:int_l_batchseq,01,:chr_p_dp_id,04,'G',DECODE(:chr_p_instr_type,'I','S','O','B'),
								:int_l_records,:l_tot_qty,:chr_l_maker,:chr_l_maker_dt,:chr_l_access_stamp);*/
		
		/* Commented and added again after cursor query by Asmeet for ISKB_12434  PMS_ON_MARKET
		EXEC SQL INSERT INTO
		  	dl_dpinstr_hdr(batch_no,record_type,dp_id,dp_role,status,buy_sell_flg,tot_num_record,
								tot_qty,maker,maker_date,access_stamp)
					  VALUES(:int_l_batchseq,01,:chr_p_dp_id,01,'G',DECODE(:chr_p_instr_type,'I','S','O','B'),
								:int_l_records,:l_tot_qty,:chr_l_maker,:chr_l_maker_dt,:chr_l_access_stamp);

/*Changed by Narendra Kumar for ISKB_3298 -- Static data change -- change of DP role from 04 to 01 -- Ended*/

		//IS_ANY_ORA_ERROR
	//Alert("After CLH Header Insert");
/*Changed by Narendra Kumar for ISKB_3298 -- Static data change -- change of DP role from 04 to 01 -- Ended*/
		
	/* Commented by Asmeet 
		printf("\n ************** CLH :Batch NO=|%d| \n",int_l_batchseq);
		sprintf(chr_g_log_buffer,"\n CLH :Batch NO=|%d| \n",int_l_batchseq);
		fprintf(g_flogfile,"%s",chr_g_log_buffer);
		printf("\n CLH :Batch NO for POOL TO POOL TRANSACTION=|%d| \n",int_l_batchseq_934);
		sprintf(chr_g_log_buffer,"\n CLH :Batch NO for POOL TO POOL TRANSACTION=|%d| \n",int_l_batchseq_934);
		fprintf(g_flogfile,"%s",chr_g_log_buffer);
	*/	
		//fprintf(g_flogfile,"CLH Cursor:After Inserting Header Record");
    /* added by shyam for early payin */
    if((!strcmp(chr_p_906_912_flg, "912") || !strcmp(chr_p_906_912_flg, "906")) && !strcmp(chr_p_instr_type, "I"))
        //fprintf(g_flogfile,"\n********* |%s| ************",chr_p_906_912_flg);
    
	Alert("Before CLH Cursor Declare");
	if(strcmp(chr_p_instr_type,"I")==0)
   {	            

	 EXEC SQL DECLARE l_cur_gen_clh_dpinstr1 CURSOR FOR
		SELECT a.client,d.cln_depo_map_client_id,a.instr_code,a.exch_code,a.mkt_type,a.settlement_no,a.deal_cd,
			   DECODE(:chr_p_instr_type,'I',NVL(SUM(a.qty),0),'O',NVL(SUM(a.allot_qty),0)),
			   c.instr_isin,setl_date,d.cln_depo_map_dp_id,e.cm_cc_id,e.cln_id,a.dl_class
		FROM Dl_Deal a ,mt_instrument c,mt_cli_depo_map d,mt_exch_depo e
			WHERE a.client=d.cln_code
	 	   AND d.cln_depo_code=:chr_p_depository_code_new
			AND a.instr_code=c.instr_code
			AND TO_CHAR(a.deal_date,'DD/MM/YYYY')=:chr_p_deal_date
			AND a.exch_code=:chr_p_exch_code
			AND e.exch_code=a.exch_code
			AND a.mkt_type=:chr_p_mkt_type
			//AND a.mkt_type!=DECODE(a.exch_code,'NSE','22','BSE','16','MCS','03') /*Added by PT MCS*/
						AND ((a.mkt_type!= DECODE(a.exch_code,'NSE','22','BSE','16','MCS','03'))
			AND (a.mkt_type!= DECODE(a.exch_code,'NSE','50','BSE','17','MCS','24')))
			AND a.settlement_no=:chr_p_settlement_no
			AND a.clh_flg=:chr_p_trns_type
			AND e.dp_id=:chr_p_dp_id
			AND e.depo_code=:chr_p_depository_code_new
			AND (a.deal_cd = DECODE(:chr_p_instr_type,'I','1','O','2') OR
				  			a.deal_cd = DECODE(:chr_p_instr_type,'I','3','O','4'))
			AND a.deal_stat='CC' AND a.NDS_BLK_DT is null
            /*Added by shyam for early payin */
            AND ((:chr_p_906_912_flg = '912' AND (a.CLIENT||'#'||a.IDENTIY_NO NOT IN(SELECT CLIENT||'#'||IDENTIY_NO FROM DL_EARLYPAYIN_DET WHERE STATUS = 'AA' AND SETTLEMENT_NO = :chr_p_settlement_no)))
                  OR
                 (:chr_p_906_912_flg = '906' and (a.CLIENT||'#'||a.IDENTIY_NO     IN(SELECT CLIENT||'#'||IDENTIY_NO FROM DL_EARLYPAYIN_DET WHERE STATUS = 'AA' AND SETTLEMENT_NO = :chr_p_settlement_no))))
		GROUP BY  a.client,d.cln_depo_map_client_id,a.instr_code,a.exch_code,a.settlement_no,a.mkt_type,a.deal_cd,
					c.instr_isin,a.setl_date,cln_depo_map_dp_id,e.cm_cc_id,e.cln_id,a.dl_class;

		
		
	   EXEC SQL OPEN l_cur_gen_clh_dpinstr1;
		IS_ANY_ORA_ERROR

   }
   if(strcmp(chr_p_instr_type,"O")==0)
   {      
		 EXEC SQL DECLARE l_cur_gen_clh_dpinstr2 CURSOR FOR
		SELECT a.client,d.cln_depo_map_client_id,a.instr_code,a.exch_code,a.mkt_type,a.settlement_no,a.deal_cd,
			   DECODE(:chr_p_instr_type,'I',NVL(SUM(a.qty),0),'O',NVL(SUM(a.allot_qty),0)),
			c.instr_isin,setl_date,d.cln_depo_map_dp_id,e.cm_cc_id,e.cln_id,a.dl_class
		FROM Dl_Deal a ,mt_instrument c,mt_cli_depo_map d,mt_exch_depo e,dl_markshortage f
			WHERE a.client=d.cln_code
	 	   AND d.cln_depo_code=:chr_p_depository_code_new
			AND a.instr_code=c.instr_code
			AND TO_CHAR(a.deal_date,'DD/MM/YYYY')=:chr_p_deal_date
			AND a.exch_code=:chr_p_exch_code
			AND e.exch_code=a.exch_code
			AND a.mkt_type=:chr_p_mkt_type
			//AND a.mkt_type!=DECODE(a.exch_code,'NSE','22','BSE','16','MCS','03') /*Added by PT MCS*/
						AND ((a.mkt_type!= DECODE(a.exch_code,'NSE','22','BSE','16','MCS','03'))
			AND (a.mkt_type!= DECODE(a.exch_code,'NSE','50','BSE','17','MCS','24')))
			AND a.settlement_no=:chr_p_settlement_no
			AND a.clh_flg=:chr_p_trns_type
			AND e.dp_id=:chr_p_dp_id
			AND e.depo_code=:chr_p_depository_code_new
			AND f.depo_code=:chr_p_depository_code_new
			AND a.client=f.dl_client
			AND a.identiy_no=f.dl_ref_no
			AND NVL(f.pool_trans,'N')='N'
			AND (a.deal_cd = DECODE(:chr_p_instr_type,'I','1','O','2') OR
				  			a.deal_cd = DECODE(:chr_p_instr_type,'I','3','O','4'))
			AND a.deal_stat IN('CC','MS') AND a.NDS_BLK_DT is null
		GROUP BY  a.client,d.cln_depo_map_client_id,a.instr_code,a.exch_code,a.settlement_no,a.mkt_type,a.deal_cd,
					c.instr_isin,a.setl_date,cln_depo_map_dp_id,e.cm_cc_id,e.cln_id,a.dl_class;
	
			 EXEC SQL OPEN l_cur_gen_clh_dpinstr2;
			 IS_ANY_ORA_ERROR	

   }
	Alert("After CLH Cursor Declare");

	   for(;;)
		{
			memset(l_dl_deal_struct_h, NULL, sizeof(SYS_DL_DEAL_STRUCT_H));
			memset(l_dl_deal_struct_i, 0, sizeof(SYS_DL_DEAL_STRUCT_I));
			memset(chr_l_refno_str,APL_NULL_CHAR,4001);
			memset(chr_cmbp_id_new,APL_NULL_CHAR,sizeof(chr_cmbp_id_new));
			
		
	Alert("Before CLH Cursor Fetch");
		if(strcmp(chr_p_instr_type,"I")==0)
		{
			EXEC SQL FETCH l_cur_gen_clh_dpinstr1 INTO   :l_dl_deal_struct_h->h_dl_client:l_dl_deal_struct_i->i_dl_client,
				  :chr_l_cln_depomap_id:i_cln_depomap_id,
				  :l_dl_deal_struct_h->h_instr_code:l_dl_deal_struct_i->i_instr_code,
													:l_dl_deal_struct_h->h_exch_code:l_dl_deal_struct_i->i_exch_code,
													:l_dl_deal_struct_h->h_mkt_type:l_dl_deal_struct_i->i_mkt_type,	
													:l_dl_deal_struct_h->h_settlement_no:l_dl_deal_struct_i->i_settlement_no,
													:l_dl_deal_struct_h->h_dealcd:l_dl_deal_struct_i->i_dealcd,
													:l_dl_deal_struct_h->h_qty:l_dl_deal_struct_i->i_qty,
													:chr_l_instr_isin:i_instr_isin,
													:l_dl_deal_struct_h->h_setldt:l_dl_deal_struct_i->i_setldt,
													:chr_l_cln_dpid:i_cln_dpid,
													:chr_l_cmbp_id:i_cmbp_id,
													:chr_l_other_client_id:i_other_client_id,
													:chr_l_dl_class:i_dl_class;

			/* Added for Early Payin -- Retro from ICICI */
			printf("Execution Date |%s|\n",l_chr_setl_dt);
			strcpy(l_dl_deal_struct_h->h_setldt,l_chr_setl_dt);
			printf("Execution 904 Date |%s|\n",l_dl_deal_struct_h->h_setldt);
			fprintf(g_flogfile,"After Fetch l_cur_gen_clh_dpinstr1 -- :|%d|\n",sqlca.sqlcode);
			/* Added for Early Payin -- Retro from ICICI */
			
				if(APL_ZERO_RESULT_SET)
				{
					/*934 Condition added by Asmeet for ISKB_12434  PMS_ON_MARKET */
				 if(counter==0 && counter_934==0)
				  {
						fprintf(g_flogfile,"No Records Found in l_cur_gen_clh_dpinstr1 CURSOR! \n");
				  }
				 break;

				}
				IS_ANY_ORA_ERROR

		}
		if(strcmp(chr_p_instr_type,"O")==0)
		{
				EXEC SQL FETCH l_cur_gen_clh_dpinstr2 INTO   :l_dl_deal_struct_h->h_dl_client:l_dl_deal_struct_i->i_dl_client,
				  :chr_l_cln_depomap_id:i_cln_depomap_id,
				  :l_dl_deal_struct_h->h_instr_code:l_dl_deal_struct_i->i_instr_code,
													:l_dl_deal_struct_h->h_exch_code:l_dl_deal_struct_i->i_exch_code,
													:l_dl_deal_struct_h->h_mkt_type:l_dl_deal_struct_i->i_mkt_type,	
													:l_dl_deal_struct_h->h_settlement_no:l_dl_deal_struct_i->i_settlement_no,
													:l_dl_deal_struct_h->h_dealcd:l_dl_deal_struct_i->i_dealcd,
													:l_dl_deal_struct_h->h_qty:l_dl_deal_struct_i->i_qty,
													:chr_l_instr_isin:i_instr_isin,
													:l_dl_deal_struct_h->h_setldt:l_dl_deal_struct_i->i_setldt,
													:chr_l_cln_dpid:i_cln_dpid,
													:chr_l_cmbp_id:i_cmbp_id,
													:chr_l_other_client_id:i_other_client_id,
													:chr_l_dl_class:i_dl_class;
			
				if(APL_ZERO_RESULT_SET)
				{
					/*934 Condition added by Asmeet for ISKB_12434  PMS_ON_MARKET */
				 if(counter==0 && counter_934==0)
				  {
						fprintf(g_flogfile,"No Records Found in l_cur_gen_clh_dpinstr2 CURSOR! \n");
				  }
				 break;

				}
				IS_ANY_ORA_ERROR

		}
	Alert("After CLH Cursor Fetch");

	/* Commented and added above by Asmeet for ISKB_12434  PMS_ON_MARKET to display generated sequence numbers only once in log file starts	
			counter++;

			sprintf(chr_l_internal_ref_no,"%d%d",int_l_batchseq,counter);
			strcpy(chr_l_send_refno1,chr_l_internal_ref_no);
			printf("\n CLH :Internal Ref No=|%s| \n",chr_l_internal_ref_no);
			printf("\n CLH :Batch NO=|%d| \n",int_l_batchseq);
			sprintf(chr_g_log_buffer,"\n CLH :Batch NO=|%d| \n",int_l_batchseq);
			fprintf(g_flogfile,"%s",chr_g_log_buffer);
	*/		
			
			
		 EXEC SQL SELECT	:l_dl_deal_struct_h->h_dealcd INTO :chr_p_instr_type_new
								FROM dual;
		 
		 IS_ANY_ORA_ERROR 

		 printf("\n CLH********chr_p_instr_type_new**************=|%c| \n",chr_p_instr_type_new);

                 /* Added by Shradha for 934 generation KB_12434 - Start */
		 if(strcmp(chr_p_depository_code_new,"NSDL")==0)	
		 {
			 Alert("\n CLH********l_dl_deal_struct_h->h_dl_client**************=|%s| \n",l_dl_deal_struct_h->h_dl_client);
			 EXEC SQL SELECT CMBP_ID INTO :chr_cmbp_id_new:i_cmbp_id_new 
			 FROM MT_CLI_DEPO_MAP 
			 WHERE CLN_CODE =  :l_dl_deal_struct_h->h_dl_client 
			 and STATUS='AA' 
			 and CLN_DEPO_CODE = :chr_p_depository_code_new
			 AND CMBP_ID IS NOT NULL
			 AND ROWNUM =1;			 
			 
			 
			 Alert("shr:: sqlca.sqlcode |%d|",sqlca.sqlcode);
                         IS_ANY_ORA_ERROR			
		 }
			 Alert("\n CLH********chr_cmbp_id_new**************=|%s| \n",chr_cmbp_id_new);
			 Alert(" ** chr_l_cmbp_id = |%s|",chr_l_cmbp_id);
				 /* Added by Shradha for 934 generation KB_12434 - End */		
			

				
				/* Changes by Shradha for 934 generation KB_12434 - Starts */
			/** Condition is added to generate 934 instruction, if CMBP Id is maintained for client.  **/
			if(strcmp(l_dl_deal_struct_h->h_dealcd,"1")==0 || strcmp(l_dl_deal_struct_h->h_dealcd,"3")==0)
			{	
		        if(strcmp(chr_cmbp_id_new,APL_NULL_STRING)==0)
					strcpy(chr_l_instruction_type,"904");			
                else
                    strcpy(chr_l_instruction_type,"934"); 					
			}
			else if(strcmp(l_dl_deal_struct_h->h_dealcd,"2")==0 || strcmp(l_dl_deal_struct_h->h_dealcd,"4")==0)
			{
				Alert("\n chr_cmbp_id_new in else if=|%s| \n",chr_cmbp_id_new);
				
				if(strcmp(chr_cmbp_id_new,APL_NULL_STRING)==0)
				{
					strcpy(chr_l_instruction_type,"905");						
					Alert("\n chr_l_instruction_type in if=|%s|",chr_l_instruction_type);					
				}
                else
				{
					strcpy(chr_l_instruction_type,"934");
					strcpy(chr_l_cmbp_id,chr_cmbp_id_new);				
					strcpy(chr_l_cln_depomap_id,chr_l_other_client_id); // Swapnil PMS 12434 -  /*Added by Asmeet for ISKB_12434  PMS_ON_MARKET */
					Alert("\n chr_l_instruction_type in else=|%s|",chr_l_instruction_type);
				}
			}
			Alert("\n ***** chr_l_cmbp_id=|%s|",chr_l_cmbp_id);
			Alert("\n ***** chr_l_cln_depomap_id=|%s|",chr_l_cln_depomap_id);
			/* Changes by Shradha for 934 generation KB_12434 - Ends */

			Alert("\n chr_l_refno_str before counter=|%s|",chr_l_refno_str);	
			Alert("\n chr_l_instruction_type before counter=|%s|",chr_l_instruction_type);	
			
		/*Added by Asmeet for ISKB_12434  PMS_ON_MARKET starts*/	
		if(strcmp(chr_l_instruction_type,"934")==0)
			{
				if(batch_seq_display_934 ==0)
				{	
					EXEC SQL SELECT DL_DPINSTRSEQ.NEXTVAL INTO :int_l_batchseq_934 FROM DUAL;
					IS_ANY_ORA_ERROR
						
						batch_seq_display_934 = 1;
				}
				counter_934++;
				sprintf(chr_l_internal_ref_no,"%d%d",int_l_batchseq_934,counter_934);
				
			}
		else
			{
				if(batch_seq_display ==0)
				{	
					EXEC SQL SELECT DL_DPINSTRSEQ.NEXTVAL INTO :int_l_batchseq FROM DUAL;
					IS_ANY_ORA_ERROR
						
						batch_seq_display = 1;
				}
				counter++;
				sprintf(chr_l_internal_ref_no,"%d%d",int_l_batchseq,counter);
				
			}
			
			strcpy(chr_l_send_refno1,chr_l_internal_ref_no);
			printf("\n CLH :Internal Ref No=|%s| \n",chr_l_internal_ref_no);
			
			Alert("\n chr_l_refno_str after counter=|%s|",chr_l_refno_str);	
			Alert("\n chr_l_instruction_type after counter=|%s|",chr_l_instruction_type);	
                      /*Added by Asmeet for ISKB_12434  PMS_ON_MARKET ends*/ 
/*	********************   Start Retriving IDENTIY_NO from dl_deal table *************** */

	Alert("Before CLH Inner Cursor Declare");
   if(strcmp(chr_p_instr_type,"I")==0)
   {

		EXEC SQL DECLARE l_cur_upd_dpm_clh_i CURSOR FOR
			SELECT identiy_no 
			FROM Dl_Deal a ,mt_cli_depo_map d
			WHERE a.client=:l_dl_deal_struct_h->h_dl_client
			AND d.cln_code=:l_dl_deal_struct_h->h_dl_client
	 	    AND d.cln_depo_code=:chr_p_depository_code_new
			AND a.instr_code=:l_dl_deal_struct_h->h_instr_code
			AND TO_CHAR(a.deal_date,'DD/MM/YYYY')=:chr_p_deal_date
			AND a.exch_code=:chr_p_exch_code
			AND a.mkt_type=:chr_p_mkt_type
			//AND a.mkt_type!=DECODE(a.exch_code,'NSE','22','BSE','16','MCS','03') /*Added by PT MCS*/
						AND ((a.mkt_type!= DECODE(a.exch_code,'NSE','22','BSE','16','MCS','03'))
			AND (a.mkt_type!= DECODE(a.exch_code,'NSE','50','BSE','17','MCS','24')))
			AND a.settlement_no=:chr_p_settlement_no
			AND a.clh_flg=:chr_p_trns_type
			AND (a.deal_cd = DECODE(:chr_p_instr_type,'I','1','O','2') OR
	  			a.deal_cd = DECODE(:chr_p_instr_type,'I','3','O','4'))
			AND a.deal_stat='CC' AND a.NDS_BLK_DT is null
            /*Added by shyam for early payin */
            AND ((:chr_p_906_912_flg = '912' AND (a.CLIENT||'#'||a.IDENTIY_NO NOT IN(SELECT CLIENT||'#'||IDENTIY_NO FROM DL_EARLYPAYIN_DET WHERE STATUS = 'AA'  AND SETTLEMENT_NO = :chr_p_settlement_no)))
                  OR
                 (:chr_p_906_912_flg = '906' AND (a.CLIENT||'#'||a.IDENTIY_NO     IN(SELECT CLIENT||'#'||IDENTIY_NO FROM DL_EARLYPAYIN_DET WHERE STATUS = 'AA' AND SETTLEMENT_NO = :chr_p_settlement_no))));


	   EXEC SQL OPEN l_cur_upd_dpm_clh_i;
		IS_ANY_ORA_ERROR
	}
	else
	{
		EXEC SQL DECLARE l_cur_upd_dpm_clh_o CURSOR FOR
			SELECT identiy_no 
			FROM Dl_Deal a ,mt_cli_depo_map d,dl_markshortage g
			WHERE a.client=:l_dl_deal_struct_h->h_dl_client
			AND d.cln_code=:l_dl_deal_struct_h->h_dl_client
	 	    AND d.cln_depo_code=:chr_p_depository_code_new
			AND a.instr_code=:l_dl_deal_struct_h->h_instr_code
			AND TO_CHAR(a.deal_date,'DD/MM/YYYY')=:chr_p_deal_date
			AND a.exch_code=:chr_p_exch_code
			AND a.mkt_type=:chr_p_mkt_type
			//AND a.mkt_type!=DECODE(a.exch_code,'NSE','22','BSE','16','MCS','03') /*Added by PT MCS*/
			AND ((a.mkt_type!= DECODE(a.exch_code,'NSE','22','BSE','16','MCS','03'))
			AND (a.mkt_type!= DECODE(a.exch_code,'NSE','50','BSE','17','MCS','24')))
			AND a.settlement_no=:chr_p_settlement_no
			AND a.clh_flg=:chr_p_trns_type
			AND a.client=g.dl_client
			AND a.identiy_no=g.dl_ref_no
			AND NVL(g.pool_trans,'N')='N'
	 	    AND g.depo_code=:chr_p_depository_code_new
			AND (a.deal_cd = DECODE(:chr_p_instr_type,'I','1','O','2') OR
	  			a.deal_cd = DECODE(:chr_p_instr_type,'I','3','O','4'))
			AND a.deal_stat IN('CC','MS') AND a.NDS_BLK_DT is null;


	   EXEC SQL OPEN l_cur_upd_dpm_clh_o;
		IS_ANY_ORA_ERROR
		}
	Alert("After CLH Inner Cursor Declare");

	   for(;;)
	   {
	Alert("Before CLH Inner Cursor Fetch");
	   if(strcmp(chr_p_instr_type,"I")==0)
		   {

		  EXEC SQL FETCH l_cur_upd_dpm_clh_i INTO :chr_l_identiy_no;
			}
		else
		{
		  EXEC SQL FETCH l_cur_upd_dpm_clh_o INTO :chr_l_identiy_no;
		}
 
	Alert("After CLH Inner Cursor Fetch");
		  if(APL_ZERO_RESULT_SET)
		  {
			  /*934 Condition added by Asmeet for ISKB_12434  PMS_ON_MARKET */
			 if(counter==0 && counter_934==0)
			  {
					fprintf(g_flogfile,"No Records Found in l_cur_upd_dpm_clh CURSOR! \n");
			  }
			 break;

		  }
		  	IS_ANY_ORA_ERROR
			//Alert("\n [CLH:NonT2T] Updating DP Generation Date for Account|%s|, RefNo|%s| with Date |%s|..",l_dl_deal_struct_h->h_dl_client,chr_l_identiy_no,chr_l_maker_dt);

			//fprintf(g_flogfile,"\n [CLH:NonT2T] Updating DP Generation Date for Account|%s|, RefNo|%s| with Date |%s|..",l_dl_deal_struct_h->h_dl_client,chr_l_identiy_no,chr_l_maker_dt);
			
		 	if(l_dl_deal_struct_h->h_qty > 0)
		    { 
				EXEC SQL UPDATE DL_DEAL SET NDS_BLK_DT=:chr_l_maker_dt WHERE
				identiy_no = :chr_l_identiy_no AND
				client=:l_dl_deal_struct_h->h_dl_client;
				if(sqlca.sqlcode)
				{
					fprintf(g_flogfile,"CLH:Error Updating NDS_BLK_DT ORA|%d|\n",sqlca.sqlcode);
				}
		  		IS_ANY_ORA_ERROR
	Alert("After CLH Deal Update ");
 
		    }

			strcat(chr_l_refno_str,chr_l_identiy_no);
			strcat(chr_l_refno_str,",");
	  }
     if(strcmp(chr_p_instr_type,"I")==0)
     {

		EXEC SQL CLOSE l_cur_upd_dpm_clh_i;
	  }
	  else
		EXEC SQL CLOSE l_cur_upd_dpm_clh_o;

		IS_ANY_ORA_ERROR
	Alert("After CLH Inner Cursor Close");

/*		EXEC SQL SELECT substr(:chr_l_refno_str,1,length(:chr_l_refno_str)-1) INTO
						:chr_l_refno_str FROM dual;

		IS_ANY_ORA_ERROR
*/

		Alert("\n DEAL_REFNO_STRING=|%s|\n",chr_l_refno_str);
		//fprintf(g_flogfile,"Counter=|%d| Deal String is=|%s|\n",counter,chr_l_refno_str); /*** THE MOST CULPRIT LINE ...Ash *****/
		//fprintf(g_flogfile,"Counter_934=|%d| Deal String is=|%s|\n",counter_934,chr_l_refno_str); 
		fflush(g_flogfile);

/*	********************   Start Retriving IDETIY_NO from dl_deal table *************** */


		

		if(l_dl_deal_struct_h->h_qty > 0)
		{

			//fprintf(g_flogfile,"CLH:Before Inserting Into DL_DPINSTRS\n");

			Alert("\n chr_l_refno_str in DL_DPINSTRS=|%s|",chr_l_refno_str);	
			Alert("\n chr_l_instruction_type in DL_DPINSTRS=|%s|",chr_l_instruction_type);	

/*			if(!strcmp(chr_l_dl_class,"59") && !strcmp(chr_p_exch_code,"BSE"))
				strcpy(l_dl_deal_struct_h->h_mkt_type,"4");
			else if(!strcmp(chr_l_dl_class,"59") && !strcmp(chr_p_exch_code,"NSE"))
				strcpy(l_dl_deal_struct_h->h_mkt_type,"14");
*/				
			/* Isolve353:AmitB:140707 :systemdate as Setl Date for auction trades	*/
			if(!strcmp(l_dl_deal_struct_h->h_mkt_type,"14") || !strcmp(l_dl_deal_struct_h->h_mkt_type,"4"))
					strcpy(l_dl_deal_struct_h->h_setldt,chr_l_maker_dt);

			EXEC SQL INSERT INTO DL_DPINSTRS
			(batch_no,serial_no,trans_type,client,instr_code,qty,exch_code,mkt_type,settlement_no,setl_date,isin_cd,
			clh_dvp,cmbp_id,dpm_trans_no,rev_flg,other_branch_cd,other_client_id,other_mkt_type,other_stlmnt_no,
			internal_ref_no,send_ref_1,send_ref_2,maker,maker_date,checker,checker_date,access_stamp,status,depo_ind,deal_ref_nos,deal_cd,other_dp_id,client_code)
			VALUES(DECODE(:chr_l_instruction_type,'934',:int_l_batchseq_934,:int_l_batchseq),DECODE(:chr_l_instruction_type,'934',:counter_934,:counter),:chr_l_instruction_type,:chr_l_cln_depomap_id,
			:l_dl_deal_struct_h->h_instr_code,:l_dl_deal_struct_h->h_qty,:chr_p_exch_code,
			:l_dl_deal_struct_h->h_mkt_type,:l_dl_deal_struct_h->h_settlement_no,
			:l_dl_deal_struct_h->h_setldt,:chr_l_instr_isin,'C',:chr_l_cmbp_id,NULL,NULL,NULL,
			DECODE(:chr_p_depository_code_new,'CDSL',DECODE(:chr_p_exch_code,'BSE',DECODE(:chr_l_instruction_type,'904',:chr_l_cmbp_id,:chr_l_other_client_id),'NSE',:chr_l_other_client_id,:chr_l_other_client_id),:chr_l_other_client_id),
			/***** :chr_l_other_client_id,***/
		  	NULL,NULL,:chr_l_internal_ref_no,:chr_l_send_refno1,NULL,
			:chr_l_maker,:chr_l_maker_dt,NULL,NULL,:chr_l_access_stamp,'G',:chr_p_depository_code_new,:chr_l_refno_str,:l_dl_deal_struct_h->h_dealcd,:chr_p_dp_id,      :l_dl_deal_struct_h->h_dl_client);

		IS_ANY_ORA_ERROR																							
	Alert("After CLH DPINSTRS Insert ");
                /*Above query modified by Asmeet for ISKB_12434  PMS_ON_MARKET (Added decode for 934 or 904)*/

		//sprintf(chr_g_log_buffer,"CLH Cursor:After Inserting Details Record for client=|%s|",l_dl_deal_struct_h->h_dl_client);	
			//fprintf(g_flogfile,"%s",chr_g_log_buffer);
		}
		else if(l_dl_deal_struct_h->h_qty ==  0)
		{
                        /*Added by Asmeet for ISKB_12434  PMS_ON_MARKET starts*/
			if(strcmp(chr_l_instruction_type,"934")==0)
			{
				counter_934--;
				int_l_zero_qty_934++;
				sprintf(chr_g_log_buffer,"ZERO QUANTITY FOR Client=|%s| Instrument=|%s| \n",l_dl_deal_struct_h->h_dl_client,l_dl_deal_struct_h->h_instr_code);
			}	
			else
			{	counter--; //Added by Prateek on 30092014 for ISKB_6847(Serial number is coming wrong in Handoff file)
			int_l_zero_qty++;
			sprintf(chr_g_log_buffer,"ZERO QUANTITY FOR Client=|%s| Instrument=|%s| \n",l_dl_deal_struct_h->h_dl_client,l_dl_deal_struct_h->h_instr_code);
			}
                         /*Added by Asmeet for ISKB_12434  PMS_ON_MARKET starts*/
			fprintf(g_flogfile,"%s",chr_g_log_buffer);
			
		}


		strcpy(chr_l_refno_str,APL_NULL_STRING);

                /*Added by Asmeet for ISKB_12434  PMS_ON_MARKET starts*/
		if(strcmp(chr_l_instruction_type,"934")==0)
		{
			l_int_cnt_934=l_int_cnt_934+1;
			l_int_hdr_qty_934=l_int_hdr_qty_934+l_dl_deal_struct_h->h_qty;
		}
		else
		{
			l_int_cnt=l_int_cnt+1;
			l_int_hdr_qty=l_int_hdr_qty+l_dl_deal_struct_h->h_qty;
		}
                 /*Added by Asmeet for ISKB_12434  PMS_ON_MARKET starts*/
			

	   }	/* OUTER FOR LOOP ENDS	*/
		
		printf("\n ************** CLH :Batch NO **************|%d| \n",int_l_batchseq);
		sprintf(chr_g_log_buffer,"\n ************** CLH :Batch NO **************|%d| \n",int_l_batchseq);
		fprintf(g_flogfile,"%s",chr_g_log_buffer);
		printf("\n ************** CLH :Batch NO for POOL TO POOL TRANSACTION **************|%d| \n",int_l_batchseq_934);
		sprintf(chr_g_log_buffer,"\n ************** CLH :Batch NO for POOL TO POOL TRANSACTION **************|%d| \n",int_l_batchseq_934);
		fprintf(g_flogfile,"%s",chr_g_log_buffer);
		
	   if(strcmp(chr_p_instr_type,"I")==0)
	   {

		EXEC SQL CLOSE l_cur_gen_clh_dpinstr1;
		IS_ANY_ORA_ERROR
	   }
	   if(strcmp(chr_p_instr_type,"O")==0)
	   {
			EXEC SQL CLOSE l_cur_gen_clh_dpinstr2;
			IS_ANY_ORA_ERROR
	   }
	Alert("After CLH Outer Cursor Close");


		if(strcmp(chr_p_instr_type,"I")==0)
		{
                        /*Commented below line and Added by Asmeet for ISKB_12434  PMS_ON_MARKET */
			//int_l_deliver_qty=l_tot_qty;
			int_l_deliver_qty=l_int_hdr_qty;
			int_l_deliver_qty_934=l_int_hdr_qty_934;
		}
		else if(strcmp(chr_p_instr_type,"O")==0)	
		{
                         /*Commented below line and Added by Asmeet for ISKB_12434  PMS_ON_MARKET to add seperate batch seq for 934  starts*/
			//int_l_receive_qty=l_tot_qty;
			int_l_receive_qty=l_int_hdr_qty;
			int_l_receive_qty_934=l_int_hdr_qty_934;
		}
				
		/*Added by Asmeet for ISKB_12434  PMS_ON_MARKET starts*/
		//fprintf(g_flogfile,"Counter_934 afterrr=|%d| Deal String is=|%s|\n",counter_934,chr_l_refno_str);
		
		printf("\n No Of CLH Records for 934|%d| \n",l_int_cnt_934);
		//sprintf(chr_g_log_buffer,"\n No Of CLH Records for 934|%d| \n",l_int_cnt_934);
		 
		 if(l_int_cnt_934 > 0)
		{
			EXEC SQL INSERT INTO
		  	dl_dpinstr_hdr(batch_no,record_type,dp_id,dp_role,status,buy_sell_flg,tot_num_record,
								tot_qty,maker,maker_date,access_stamp)
					  VALUES(:int_l_batchseq_934,01,:chr_p_dp_id,01,'G',DECODE(:chr_p_instr_type,'I','S','O','B'),
								:l_int_cnt_934,:l_int_hdr_qty_934,:chr_l_maker,:chr_l_maker_dt,:chr_l_access_stamp);	
			IS_ANY_ORA_ERROR
		
			EXEC SQL INSERT INTO dl_dpinstr_trail(batch_no,record_type,branch_cd,deliver_qty,receive_qty,
											  tot_qty,status,maker,maker_date,access_stamp)
									VALUES(:int_l_batchseq_934,99,'000',//:g_mt_commonsys_params_struct_h.brnch_cd,
											 :int_l_deliver_qty_934,:int_l_receive_qty_934,:l_int_hdr_qty_934,'G',:chr_l_maker,
											 :chr_l_maker_dt,:chr_l_access_stamp);			
			IS_ANY_ORA_ERROR	
			
			EXEC SQL UPDATE dl_dpinstr_hdr SET tot_num_record=tot_num_record - :int_l_zero_qty_934
								WHERE batch_no=TO_CHAR(:int_l_batchseq_934);
			IS_ANY_ORA_ERROR
			fprintf(g_flogfile,"CLH:No of Zero Quantity Records for 934=|%d| \n",int_l_zero_qty_934);
		/*Added by Asmeet for ISKB_12434  PMS_ON_MARKET to add seperate batch seq for 934 ends*/	
		}
			
		if(l_int_cnt > 0)
		{		
			EXEC SQL INSERT INTO
		  	dl_dpinstr_hdr(batch_no,record_type,dp_id,dp_role,status,buy_sell_flg,tot_num_record,
								tot_qty,maker,maker_date,access_stamp)
					  VALUES(:int_l_batchseq,01,:chr_p_dp_id,01,'G',DECODE(:chr_p_instr_type,'I','S','O','B'),
								:l_int_cnt,:l_int_hdr_qty,:chr_l_maker,:chr_l_maker_dt,:chr_l_access_stamp);
			IS_ANY_ORA_ERROR
		
                      /*Query modified by Asmeet for ISKB_12434  PMS_ON_MARKET*/  
			EXEC SQL INSERT INTO dl_dpinstr_trail(batch_no,record_type,branch_cd,deliver_qty,receive_qty,
														  tot_qty,status,maker,maker_date,access_stamp)
												VALUES(:int_l_batchseq,99,'000',//:g_mt_commonsys_params_struct_h.brnch_cd,
														 :int_l_deliver_qty,:int_l_receive_qty,:l_int_hdr_qty,'G',:chr_l_maker,
														 :chr_l_maker_dt,:chr_l_access_stamp);		
			
		IS_ANY_ORA_ERROR	
	
		EXEC SQL UPDATE dl_dpinstr_hdr SET tot_num_record=tot_num_record - :int_l_zero_qty
							WHERE batch_no=TO_CHAR(:int_l_batchseq);
		IS_ANY_ORA_ERROR
				
		//fprintf(g_flogfile,"CLH:No of Zero Quantity Records=|%d| \n",int_l_zero_qty);	
		}	
			
	 }	/* ** IF ends ** */ 

/* **************** PROCESSING FOR T2T SEGMENT TRADES ******************** */


	chr_l_flg='Y';

	fprintf(g_flogfile,"CLH RECORDS:T2T: PROCESSING FOR T2T SEGMENT TRADES ");

/*if(strcmp(chr_p_instr_type,"I")==0 && (strcmp(chr_p_mkt_type,"22")==0 && strcmp(chr_p_exch_code,"NSE")==0) || strcmp(chr_p_mkt_type,"16")==0 && strcmp(chr_p_exch_code,"BSE")==0 )*/
/*if(strcmp(chr_p_instr_type,"I")==0 && ((strcmp(chr_p_mkt_type,"22")==0 && strcmp(chr_p_exch_code,"NSE")==0) || (strcmp(chr_p_mkt_type,"16")==0 && strcmp(chr_p_exch_code,"BSE")==0 )))
{
*/	EXEC SQL SELECT COUNT(*),DECODE(:chr_p_instr_type,'I',NVL(SUM(a.qty),0),'O',NVL(SUM(a.allot_qty),0)) as tot_qty 
					INTO :int_l_records:i_int_l_records,:l_tot_qty:i_l_tot_qty
		   FROM Dl_Deal a ,mt_instrument c,mt_cli_depo_map d,mt_exch_depo e
			WHERE a.client=d.cln_code
	 	    AND d.cln_depo_code=:chr_p_depository_code_new
			AND a.instr_code=c.instr_code
			AND TO_CHAR(a.deal_date,'DD/MM/YYYY')=:chr_p_deal_date
			AND a.exch_code=:chr_p_exch_code
			AND /*a.mkt_type=DECODE(:chr_p_exch_code,'NSE','22','BSE','16') */ 	/* CHANGES MADE FOR SLB - AMISH - 27/03/2008 */
				(  a.mkt_type = DECODE(:chr_p_exch_code,'NSE',22,'BSE','16','MCS','03') OR  //Added By PT For MCS
				a.mkt_type = DECODE(:chr_p_exch_code,'NSE',23,'BSE','18') OR
			    a.mkt_type = DECODE(:chr_p_exch_code,'NSE',24,'BSE','19') OR
				a.mkt_type = DECODE(:chr_p_exch_code,'NSE',25,'BSE','20') OR
				a.mkt_type = DECODE(:chr_p_exch_code,'NSE','50','BSE','17','MCS','03')
			  )
			AND a.settlement_no=:chr_p_settlement_no
			AND a.clh_flg=:chr_p_trns_type
			AND e.dp_id=:chr_p_dp_id
			AND e.exch_code=:chr_p_exch_code
			AND e.depo_code=:chr_p_depository_code_new
			AND (a.deal_cd = DECODE(:chr_p_instr_type,'I','1','O','2') OR
				  			a.deal_cd = DECODE(:chr_p_instr_type,'I','3','O','4'))
			AND ( a.deal_stat=DECODE(:chr_p_instr_type,'I','CC','O','MS') OR deal_stat=DECODE(:chr_p_instr_type,'I','CC','O','CC'))
/*			AND a.deal_stat='CC'
*/			AND a.NDS_BLK_DT is null
            /* added by shyam for early payin*/
            AND ( (:chr_p_906_912_flg = '912' AND (a.CLIENT||'#'||a.IDENTIY_NO NOT IN(SELECT CLIENT||'#'||IDENTIY_NO FROM DL_EARLYPAYIN_DET WHERE STATUS = 'AA' AND SETTLEMENT_NO = :chr_p_settlement_no)))
                   OR
                   (:chr_p_906_912_flg = '906' AND (a.CLIENT||'#'||a.IDENTIY_NO     IN(SELECT CLIENT||'#'||IDENTIY_NO FROM DL_EARLYPAYIN_DET WHERE STATUS = 'AA' AND SETTLEMENT_NO = :chr_p_settlement_no)))
                );
		  
		  if(int_l_records == 0)
		  {
			  fprintf(g_flogfile," CLH:T2T:NO Records Found For The Given Criteria !!!");
			  chr_l_flg='N';
		  }
	  	 IS_ANY_ORA_ERROR

	Alert("After CLH T2T Count ");
		 printf("\n No Of CLH:T2T Records|%d| \n",int_l_records);
		 sprintf(chr_g_log_buffer,"\n No Of CLH:T2T Records|%d| \n",int_l_records);
		 fprintf(g_flogfile,"%s" ,chr_g_log_buffer);


  if(chr_l_flg== 'Y')
  {

	/* Commenetd by Asmeet  and added below again for ISKB_12434  PMS_ON_MARKET 
	EXEC SQL SELECT DL_DPINSTRSEQ.NEXTVAL INTO :int_l_batchseq FROM DUAL;
		IS_ANY_ORA_ERROR
	*/	
		/*Changed by Narendra Kumar for ISKB_3298 -- Static data change -- change of DP role from 04 to 01 -- Started*/
	
			/*EXEC SQL INSERT INTO
		  	dl_dpinstr_hdr(batch_no,record_type,dp_id,dp_role,buy_sell_flg,status,tot_num_record,
								tot_qty,maker,maker_date,access_stamp)
					  VALUES(:int_l_batchseq,01,:chr_p_dp_id,04,
							   DECODE(:chr_p_instr_type,'I','S','O','B'),'G',:int_l_records,:l_tot_qty,
								:chr_l_maker,:chr_l_maker_dt,:chr_l_access_stamp);*/
/* Commented by Asmeet and added below for  ISKB_12434  PMS_ON_MARKET
			EXEC SQL INSERT INTO
		  	dl_dpinstr_hdr(batch_no,record_type,dp_id,dp_role,buy_sell_flg,status,tot_num_record,
								tot_qty,maker,maker_date,access_stamp)
					  VALUES(:int_l_batchseq,01,:chr_p_dp_id,01,
							   DECODE(:chr_p_instr_type,'I','S','O','B'),'G',:int_l_records,:l_tot_qty,
								:chr_l_maker,:chr_l_maker_dt,:chr_l_access_stamp);
*/
		/*Changed by Narendra Kumar for ISKB_3298 -- Static data change -- change of DP role from 04 to 01 -- Ended*/
		
		IS_ANY_ORA_ERROR
		
		//fprintf(g_flogfile,"CLH Cursor:T2T: After Inserting Header Record");


	Alert("Before CLH T2T Cursor Declare ");
		EXEC SQL DECLARE l_cur_gen_clh_T2T CURSOR FOR
		SELECT a.identiy_no,a.client,d.cln_depo_map_client_id,a.instr_code,a.exch_code,a.mkt_type,a.settlement_no,a.deal_cd,
			   DECODE(:chr_p_instr_type,'I',NVL(a.qty,0),'O',NVL(a.allot_qty,0)),
			   c.instr_isin,setl_date,d.cln_depo_map_dp_id,e.cm_cc_id,e.cln_id
		FROM Dl_Deal a ,mt_instrument c,mt_cli_depo_map d,mt_exch_depo e
			WHERE a.client=d.cln_code
	 	   AND d.cln_depo_code=:chr_p_depository_code_new
			AND a.instr_code=c.instr_code
			AND TO_CHAR(a.deal_date,'DD/MM/YYYY')=:chr_p_deal_date
			AND a.exch_code=:chr_p_exch_code
			AND /*a.mkt_type=DECODE(:chr_p_exch_code,'NSE','22','BSE','16') */ 	/* CHANGES MADE FOR SLB - AMISH - 27/03/2008 */
				(  a.mkt_type = DECODE(:chr_p_exch_code,'NSE',22,'BSE','16','MCS','03') OR  //Added By PT For MCS
				a.mkt_type = DECODE(:chr_p_exch_code,'NSE',23,'BSE','18') OR
			    a.mkt_type = DECODE(:chr_p_exch_code,'NSE',24,'BSE','19') OR
				a.mkt_type = DECODE(:chr_p_exch_code,'NSE',25,'BSE','20') OR
				a.mkt_type = DECODE(:chr_p_exch_code,'NSE','50','BSE','17','MCS','03')
			  )

			AND a.settlement_no=:chr_p_settlement_no
			AND a.clh_flg=:chr_p_trns_type
			AND e.dp_id=:chr_p_dp_id
			AND e.exch_code=:chr_p_exch_code
			AND e.depo_code=:chr_p_depository_code_new
			AND (a.deal_cd = DECODE(:chr_p_instr_type,'I','1','O','2') OR
				  			a.deal_cd = DECODE(:chr_p_instr_type,'I','3','O','4'))
			AND ( a.deal_stat=DECODE(:chr_p_instr_type,'I','CC','O','MS') OR a.deal_stat=DECODE(:chr_p_instr_type,'I','CC','O','CC'))
/*			AND a.deal_stat='CC'
*/			AND a.NDS_BLK_DT is null;

	Alert("After CLH T2T Cursor Declare ");


	   EXEC SQL OPEN l_cur_gen_clh_T2T;
		IS_ANY_ORA_ERROR
	Alert("After CLH T2T Cursor Open ");

	   for(;;)
	   {
			memset(l_dl_deal_struct_h, NULL, sizeof(SYS_DL_DEAL_STRUCT_H));
			memset(l_dl_deal_struct_i, NULL, sizeof(SYS_DL_DEAL_STRUCT_I));
			memset(chr_cmbp_id_new,APL_NULL_CHAR,sizeof(chr_cmbp_id_new));

		EXEC SQL FETCH l_cur_gen_clh_T2T INTO		:l_dl_deal_struct_h->h_indentity_no:l_dl_deal_struct_i->i_indentity_no,
													:l_dl_deal_struct_h->h_dl_client:l_dl_deal_struct_i->i_dl_client,
													:chr_l_cln_depomap_id:i_cln_depomap_id,
													:l_dl_deal_struct_h->h_instr_code:l_dl_deal_struct_i->i_instr_code,
													:l_dl_deal_struct_h->h_exch_code:l_dl_deal_struct_i->i_exch_code,
													:l_dl_deal_struct_h->h_mkt_type:l_dl_deal_struct_i->i_mkt_type,	
													:l_dl_deal_struct_h->h_settlement_no:l_dl_deal_struct_i->i_settlement_no,
													:l_dl_deal_struct_h->h_dealcd:l_dl_deal_struct_i->i_dealcd,
													:l_dl_deal_struct_h->h_qty:l_dl_deal_struct_i->i_qty,
													:chr_l_instr_isin:i_instr_isin,
													:l_dl_deal_struct_h->h_setldt:l_dl_deal_struct_i->i_setldt,
													:chr_l_cln_dpid:i_cln_dpid,
													:chr_l_cmbp_id:i_cmbp_id,
													:chr_l_other_client_id:i_other_client_id;

                        printf("Execution Date |%s|\n",l_chr_setl_dt);
			strcpy(l_dl_deal_struct_h->h_setldt,l_chr_setl_dt);
			printf("Execution 904 Date |%s|\n",l_dl_deal_struct_h->h_setldt);
			
	Alert("After CLH T2T Cursor Fetch ");
			if(APL_ZERO_RESULT_SET)
		    {

			 if(counter1==0 && counter1_t2t==0)
			  {
					fprintf(g_flogfile,"CLH:T2T: No Records Found In l_cur_gen_clh_T2T CURSOR !!!");
			  }
			 break;

		    }
		  	IS_ANY_ORA_ERROR
		/* //Commented by Asmeet for ISKB_12434  PMS_ON_MARKET
			//counter1++;  

			sprintf(chr_l_internal_ref_no,"%d%d",int_l_batchseq,counter1);
			//sprintf(chr_l_internal_ref_no,"%d%d",int_l_batchseq,counter_t2t);
			strcpy(chr_l_send_refno1,chr_l_internal_ref_no);
			printf("\n CLH :T2T:Internal Ref No=|%s| \n",chr_l_internal_ref_no);
		*/	
			
			EXEC SQL SELECT	:l_dl_deal_struct_h->h_dealcd INTO :chr_p_instr_type_new
									FROM dual;
			 
			IS_ANY_ORA_ERROR 
		
			strcpy(chr_l_identiy_t2t,l_dl_deal_struct_h->h_indentity_no);
			strcat(chr_l_identiy_t2t,",");
	
			//sprintf(chr_g_log_buffer," CLH:T2T:********DEAL CD=|%c| chr_l_identiy_t2t=|%s|********\n",chr_p_instr_type_new,chr_l_identiy_t2t);
			//fprintf(g_flogfile,"%s",chr_g_log_buffer);

			
			
			/*
			if(strcmp(l_dl_deal_struct_h->h_dealcd,"1")==0 || strcmp(l_dl_deal_struct_h->h_dealcd,"3")==0)
			{	
				strcpy(chr_l_instruction_type,"904");			
				
				EXEC SQL SELECT payin_dt INTO :chr_l_settlement_dt:i_settlement_dt FROM dl_deal
					WHERE identiy_no=:l_dl_deal_struct_h->h_indentity_no
					AND client=:l_dl_deal_struct_h->h_dl_client;

				IS_ANY_ORA_ERROR

				EXEC SQL SELECT pay_in_dt
		  			INTO :chr_l_settlement_dt:i_settlement_dt
					FROM	mt_settl_cal
				 WHERE settl_no  = :l_dl_deal_struct_h->h_settlement_no
					AND exch_code = :l_dl_deal_struct_h->h_exch_code
					AND settl_type = :l_dl_deal_struct_h->h_mkt_type;
		
				IS_ANY_ORA_ERROR
			
				printf("\n CLH:T2T: Payin Settlement Date=|%s| \n",chr_l_settlement_dt);
				printf("CLH:T2T: l_dl_deal_struct_h->h_settlement_no id |%s|\n",l_dl_deal_struct_h->h_settlement_no);
				printf("CLH:T2T: l_dl_deal_struct_h->h_exch_code id |%s|\n",l_dl_deal_struct_h->h_exch_code);
				printf("CLH:T2T: l_dl_deal_struct_h->h_mkt_type id |%s|\n",l_dl_deal_struct_h->h_mkt_type);
				
			}
			else if(strcmp(l_dl_deal_struct_h->h_dealcd,"2")==0 || strcmp(l_dl_deal_struct_h->h_dealcd,"4")==0)
			{
				strcpy(chr_l_instruction_type,"905");
				
				
				EXEC SQL SELECT payout_dt INTO :chr_l_settlement_dt:i_settlement_dt FROM dl_deal
					WHERE identiy_no=:l_dl_deal_struct_h->h_indentity_no
					AND client=:l_dl_deal_struct_h->h_dl_client;

				IS_ANY_ORA_ERROR

				EXEC SQL SELECT pay_out_dt
		  			INTO :chr_l_settlement_dt:i_settlement_dt
					FROM	mt_settl_cal
				 WHERE settl_no  = :l_dl_deal_struct_h->h_settlement_no
					AND exch_code = :l_dl_deal_struct_h->h_exch_code
					AND settl_type = :l_dl_deal_struct_h->h_mkt_type;
		
				IS_ANY_ORA_ERROR
				
				printf("\n CLH: Payout Settlement Date=|%s| \n",chr_l_settlement_dt);
				
			}
*/				
			
			if(strcmp(chr_p_depository_code_new,"NSDL")==0)	
		 {
			 Alert("\n CLH********l_dl_deal_struct_h->h_dl_client**************=|%s| \n",l_dl_deal_struct_h->h_dl_client);
			 EXEC SQL SELECT CMBP_ID INTO :chr_cmbp_id_new:i_cmbp_id_new 
			 FROM MT_CLI_DEPO_MAP 
			 WHERE CLN_CODE =  :l_dl_deal_struct_h->h_dl_client 
			 and STATUS='AA' 
			 and CLN_DEPO_CODE = :chr_p_depository_code_new
			 AND CMBP_ID IS NOT NULL
			 AND ROWNUM =1;			 
			 
			 
			 Alert("shr:: sqlca.sqlcode |%d|",sqlca.sqlcode);
                         IS_ANY_ORA_ERROR			
			}
			 Alert("\n CLH********chr_cmbp_id_new**************=|%s| \n",chr_cmbp_id_new);
			 Alert(" ** chr_l_cmbp_id = |%s|",chr_l_cmbp_id);
				 /* Added by Shradha for 934 generation KB_12434 - End */		
			

				
				/* Changes by Shradha for 934 generation KB_12434 - Starts */
			/** Condition is added to generate 934 instruction, if CMBP Id is maintained for client.  **/
			if(strcmp(l_dl_deal_struct_h->h_dealcd,"1")==0 || strcmp(l_dl_deal_struct_h->h_dealcd,"3")==0)
			{	
		        if(strcmp(chr_cmbp_id_new,APL_NULL_STRING)==0)
					strcpy(chr_l_instruction_type,"904");			
                else
                    strcpy(chr_l_instruction_type,"934"); 					
			}
			else if(strcmp(l_dl_deal_struct_h->h_dealcd,"2")==0 || strcmp(l_dl_deal_struct_h->h_dealcd,"4")==0)
			{
				if(strcmp(chr_cmbp_id_new,APL_NULL_STRING)==0)
				{
					strcpy(chr_l_instruction_type,"905");						
				}
                else
				{
					strcpy(chr_l_instruction_type,"934");
					strcpy(chr_l_cmbp_id,chr_cmbp_id_new);				
					strcpy(chr_l_cln_depomap_id,chr_l_other_client_id); // Swapnil PMS 12434 -  /*Added by Asmeet for ISKB_12434  PMS_ON_MARKET */
				}
			}
			Alert("\n ***** chr_l_cmbp_id=|%s|",chr_l_cmbp_id);
			Alert("\n ***** chr_l_cln_depomap_id=|%s|",chr_l_cln_depomap_id);
			/* Changes by Shradha for 934 generation KB_12434 - Ends */
			
			
			
			/*Added by Asmeet for ISKB_12434  PMS_ON_MARKET starts*/	
		if(strcmp(chr_l_instruction_type,"934")==0)
			{
				if(batch_seq_display_934_t2t ==0)
				{	
					EXEC SQL SELECT DL_DPINSTRSEQ.NEXTVAL INTO :int_l_batchseq_934_t2t FROM DUAL;
					IS_ANY_ORA_ERROR
						
						batch_seq_display_934_t2t = 1;
				}
				counter1_t2t++;
				sprintf(chr_l_internal_ref_no,"%d%d",int_l_batchseq_934_t2t,counter1_t2t);
				
			}
		else
			{
				if(batch_seq_display_904_t2t ==0)
				{	
					EXEC SQL SELECT DL_DPINSTRSEQ.NEXTVAL INTO :int_l_batchseq FROM DUAL;
					IS_ANY_ORA_ERROR
						
						batch_seq_display_904_t2t = 1;
				}
				counter1++;
				sprintf(chr_l_internal_ref_no,"%d%d",int_l_batchseq,counter1);
				
			}
			
			

			strcpy(chr_l_send_refno1,chr_l_internal_ref_no);
			printf("\n CLH :Internal Ref No=|%s| \n",chr_l_internal_ref_no);
			
			Alert("\n chr_l_refno_str after counter=|%s|",chr_l_refno_str);	
			Alert("\n chr_l_instruction_type after counter=|%s|",chr_l_instruction_type);	
                      /*Added by Asmeet for ISKB_12434  PMS_ON_MARKET ends*/ 
			
		/*	

			printf("\n T2T :Batch NO for t2t=|%d| \n",int_l_batchseq);
			sprintf(chr_g_log_buffer,"\n T2T :Batch NO for t2t=|%d| \n",int_l_batchseq);
			fprintf(g_flogfile,"%s",chr_g_log_buffer);
			strcpy(chr_l_send_refno1,chr_l_internal_ref_no);
			printf("\n CLH :Internal Ref No=|%s| \n",chr_l_internal_ref_no);
		*/	
			
/** Change:AmiTB:20/11/06:Corporation Id for BSE-Payin & PoolClientId for BSE_Payout **/
			if(l_dl_deal_struct_h->h_qty > 0)
			{
				if(!strcmp(l_dl_deal_struct_h->h_mkt_type,"16") && !strcmp(l_dl_deal_struct_h->h_exch_code,"BSE"))
				{
					strcpy(l_dl_deal_struct_h->h_mkt_type,"5");
				}
				/* Isolve353:AmitB:140707 :systemdate as Setl Date for auction trades	*/
				if(!strcmp(l_dl_deal_struct_h->h_mkt_type,"14") || !strcmp(l_dl_deal_struct_h->h_mkt_type,"4"))
					strcpy(l_dl_deal_struct_h->h_setldt,chr_l_maker_dt);

				EXEC SQL INSERT INTO DL_DPINSTRS
				(batch_no,serial_no,trans_type,client,instr_code,qty,exch_code,mkt_type,settlement_no,setl_date,isin_cd,
				clh_dvp,cmbp_id,dpm_trans_no,rev_flg,other_branch_cd,other_client_id,other_mkt_type,other_stlmnt_no,
				internal_ref_no,send_ref_1,send_ref_2,maker,maker_date,checker,checker_date,access_stamp,status,depo_ind,deal_ref_nos,deal_cd,other_dp_id,client_code)
				VALUES(DECODE(:chr_l_instruction_type,'934',:int_l_batchseq_934_t2t,:int_l_batchseq),DECODE(:chr_l_instruction_type,'934',:counter1_t2t,:counter1),:chr_l_instruction_type,:chr_l_cln_depomap_id,
				:l_dl_deal_struct_h->h_instr_code,:l_dl_deal_struct_h->h_qty,:chr_p_exch_code,
				:l_dl_deal_struct_h->h_mkt_type,:l_dl_deal_struct_h->h_settlement_no,
				:l_dl_deal_struct_h->h_setldt,:chr_l_instr_isin,'C',:chr_l_cmbp_id,NULL,NULL,NULL,
			DECODE(:chr_p_depository_code_new,'CDSL',DECODE(:chr_p_exch_code,'BSE',DECODE(:chr_l_instruction_type,'904',:chr_l_cmbp_id,:chr_l_other_client_id),'NSE',:chr_l_other_client_id,:chr_l_other_client_id),:chr_l_other_client_id),
	/*		DECODE(:chr_p_depository_code_new,'CDSL',DECODE(:chr_p_exch_code,'BSE',:chr_l_cmbp_id,'NSE',:chr_l_other_client_id,:chr_l_other_client_id),:chr_l_other_client_id),	*/
				/***** :chr_l_other_client_id,***/
				NULL,NULL,:chr_l_internal_ref_no,:chr_l_send_refno1,NULL,
				:chr_l_maker,:chr_l_maker_dt,NULL,NULL,:chr_l_access_stamp,'G',:chr_p_depository_code_new,:chr_l_identiy_t2t,:l_dl_deal_struct_h->h_dealcd,:chr_p_dp_id,:l_dl_deal_struct_h->h_dl_client);

			IS_ANY_ORA_ERROR																							

			printf("\n [CLH:T2T] Updating DP Generation Date for Account|%s|, RefNo|%s| with Date |%s|..",l_dl_deal_struct_h->h_dl_client,l_dl_deal_struct_h->h_indentity_no,chr_l_maker_dt);
		
			 //fprintf(g_flogfile,"\n [CLH:T2T] Updating DP Generation Date for Account|%s|, RefNo|%s| with Date |%s|",l_dl_deal_struct_h->h_dl_client,l_dl_deal_struct_h->h_indentity_no,chr_l_maker_dt);	
			 
			EXEC SQL UPDATE DL_DEAL SET NDS_BLK_DT=:chr_l_maker_dt WHERE
			identiy_no = :l_dl_deal_struct_h->h_indentity_no AND
			client=:l_dl_deal_struct_h->h_dl_client;
			if(sqlca.sqlcode)
			{
				fprintf(g_flogfile,"CLH:T2T:Error Updating NDS_BLK_DT ORA|%d|\n",sqlca.sqlcode);
			}
		  	IS_ANY_ORA_ERROR
		
		}
		else if(l_dl_deal_struct_h->h_qty ==  0)	
		{
			if(strcmp(chr_l_instruction_type,"934")==0)
			{
				counter1_t2t--; //Added by Prateek on 30092014 for ISKB_6847(Serial number is coming wrong in Handoff file)
				int_l_zero_qty_t2t++;
				sprintf(chr_g_log_buffer,"CLH:T2T:ZERO QUANTITY FOR Client=|%s| Instrument=|%s| \n",l_dl_deal_struct_h->h_dl_client,l_dl_deal_struct_h->h_instr_code);
				fprintf(g_flogfile,"%s",chr_g_log_buffer);
			}
			else
			{
				counter1--; //Added by Prateek on 30092014 for ISKB_6847(Serial number is coming wrong in Handoff file)
				int_l_zero_qty++;
				sprintf(chr_g_log_buffer,"CLH:T2T:ZERO QUANTITY FOR Client=|%s| Instrument=|%s| \n",l_dl_deal_struct_h->h_dl_client,l_dl_deal_struct_h->h_instr_code);
				fprintf(g_flogfile,"%s",chr_g_log_buffer);
			}

		}
		/*Added by Asmeet for ISKB_12434  PMS_ON_MARKET starts*/
		if(strcmp(chr_l_instruction_type,"934")==0)
		{
			l_int_cnt_934_t2t=l_int_cnt_934_t2t+1;
			l_int_hdr_qty_934_t2t=l_int_hdr_qty_934_t2t+l_dl_deal_struct_h->h_qty;
		}
		else
		{
			l_int_cnt_904_t2t=l_int_cnt_904_t2t+1;
			l_int_hdr_qty_904_t2t=l_int_hdr_qty_904_t2t+l_dl_deal_struct_h->h_qty;
		}
                 /*Added by Asmeet for ISKB_12434  PMS_ON_MARKET starts*/

	 }
	 
			printf("\n ************** T2T :Batch NO for t2t  **************|%d| \n",int_l_batchseq);
			sprintf(chr_g_log_buffer,"\n ************** T2T :Batch NO for t2t **************|%d| \n",int_l_batchseq);
			fprintf(g_flogfile,"%s",chr_g_log_buffer);
			printf("\n ************** T2T :Batch NO for POOL TO POOL TRANSACTION **************|%d| \n",int_l_batchseq_934_t2t);
			sprintf(chr_g_log_buffer,"\n ************** T2T :Batch NO for POOL TO POOL TRANSACTION **************|%d| \n",int_l_batchseq_934_t2t);
			fprintf(g_flogfile,"%s",chr_g_log_buffer);

	EXEC SQL CLOSE l_cur_gen_clh_T2T;
	IS_ANY_ORA_ERROR

	Alert("After CLH T2T Cursor Close");
		
		if(strcmp(chr_p_instr_type,"I")==0)
		{
			int_l_deliver_qty=l_tot_qty;
		}
		else if(strcmp(chr_p_instr_type,"O")==0)	
		{
			int_l_receive_qty=l_tot_qty;
		}
		
		if(strcmp(chr_p_instr_type,"I")==0)
		{
                        /*Commented below line and Added by Asmeet for ISKB_12434  PMS_ON_MARKET */
			//int_l_deliver_qty=l_tot_qty;
			int_l_deliver_qty_904_t2t=l_int_hdr_qty_904_t2t;
			int_l_deliver_qty_934_t2t=l_int_hdr_qty_934_t2t;
		}
		else if(strcmp(chr_p_instr_type,"O")==0)	
		{
                         /*Commented below line and Added by Asmeet for ISKB_12434  PMS_ON_MARKET to add seperate batch seq for 934  starts*/
			//int_l_receive_qty=l_tot_qty;
			int_l_receive_qty_904_t2t=l_int_hdr_qty_904_t2t;
			int_l_receive_qty_934_t2t=l_int_hdr_qty_934_t2t;
		}
			
		/*Added by Asmeet for ISKB_12434  PMS_ON_MARKET starts*/
		//fprintf(g_flogfile,"Counter_934 afterrr=|%d| Deal String is=|%s|\n",counter_934,chr_l_refno_str);
		
	if(l_int_cnt_934_t2t > 0)
	{		
		EXEC SQL INSERT INTO
		  	dl_dpinstr_hdr(batch_no,record_type,dp_id,dp_role,buy_sell_flg,status,tot_num_record,
								tot_qty,maker,maker_date,access_stamp)
					  VALUES(:int_l_batchseq_934_t2t,01,:chr_p_dp_id,01,
							   DECODE(:chr_p_instr_type,'I','S','O','B'),'G',:l_int_cnt_934_t2t,:l_int_hdr_qty_934_t2t,
								:chr_l_maker,:chr_l_maker_dt,:chr_l_access_stamp);
		IS_ANY_ORA_ERROR
		
		EXEC SQL INSERT INTO
	  			dl_dpinstr_trail(batch_no,record_type,branch_cd,deliver_qty,receive_qty,										  											tot_qty,status,maker,maker_date,access_stamp)
							 VALUES(:int_l_batchseq_934_t2t,99,'000',//:g_mt_commonsys_params_struct_h.brnch_cd,
									  :int_l_deliver_qty_934_t2t,:int_l_receive_qty_934_t2t,:l_int_hdr_qty_934_t2t,'G',:chr_l_maker,
									  :chr_l_maker_dt,:chr_l_access_stamp);

		IS_ANY_ORA_ERROR	

			
		EXEC SQL UPDATE dl_dpinstr_hdr SET tot_num_record=tot_num_record - :int_l_zero_qty_t2t
							WHERE batch_no=TO_CHAR(:int_l_batchseq_934_t2t);
		IS_ANY_ORA_ERROR
		
		//fprintf(g_flogfile,"CLH:T2T:No of Zero Quantity Records=|%d| \n",int_l_zero_qty_t2t);	
	}		
		
	if(l_int_cnt_904_t2t > 0)
	{		
		EXEC SQL INSERT INTO
		  	dl_dpinstr_hdr(batch_no,record_type,dp_id,dp_role,buy_sell_flg,status,tot_num_record,
								tot_qty,maker,maker_date,access_stamp)
					  VALUES(:int_l_batchseq,01,:chr_p_dp_id,01,
							   DECODE(:chr_p_instr_type,'I','S','O','B'),'G',:l_int_cnt_904_t2t,:l_int_hdr_qty_904_t2t,
								:chr_l_maker,:chr_l_maker_dt,:chr_l_access_stamp);
		IS_ANY_ORA_ERROR
			
		EXEC SQL INSERT INTO
	  			dl_dpinstr_trail(batch_no,record_type,branch_cd,deliver_qty,receive_qty,										  											tot_qty,status,maker,maker_date,access_stamp)
							 VALUES(:int_l_batchseq,99,'000',//:g_mt_commonsys_params_struct_h.brnch_cd,
									  :int_l_deliver_qty_904_t2t,:int_l_receive_qty_904_t2t,:l_int_hdr_qty_904_t2t,'G',:chr_l_maker,
									  :chr_l_maker_dt,:chr_l_access_stamp);

		IS_ANY_ORA_ERROR	

			
		EXEC SQL UPDATE dl_dpinstr_hdr SET tot_num_record=tot_num_record - :int_l_zero_qty
							WHERE batch_no=TO_CHAR(:int_l_batchseq);
		IS_ANY_ORA_ERROR
		
		//fprintf(g_flogfile,"CLH:T2T:No of Zero Quantity Records=|%d| \n",int_l_zero_qty);	
	}	
  }	/* **** IF(chr_l_flg== 'Y') Ends **** */

/*}
*/

APL_GOBACK_SUCCESS;

RETURN_SUCCESS:
{
	
	fprintf(g_flogfile," Leaving Proc_GenCLH_Instrn With Success\n");
	return(APL_SUCCESS);
}

RETURN_FAILURE:
{
	printf("\n Error Inside Proc_GenCLH_Instrn:ORA|%d|\n",sqlca.sqlcode);
	sprintf(chr_g_log_buffer,"Leaving Proc_GenCLH_Instrn With Failure ORA|%d|\n",sqlca.sqlcode);	
	CO_ProcMonitor(g_flogfile,chr_g_log_buffer,l_debug_info_ptr,NULL);
	return(APL_FAILURE);	
}

  }	/*********** END CLH FUNCTION ****************/


  int Proc_GenDVP_Instrn(char *chr_p_instr_type,
						  char *chr_p_trns_type,
						  char *chr_p_depository_code,
						  char *chr_p_file_type,
						  char *chr_p_deal_date,
						  char *chr_p_exch_code,
						  char *chr_p_settlement_no,
						  char *chr_p_mkt_type,
						  char *chr_p_dp_id,
						  char *chr_p_user,
						  FILE *g_flogfile,
						  INTL_ENV_DATA_STRUCT_H *l_intl_env_data_h,
						  DEBUG_INFO_STRUCT_H **l_debug_info_ptr)
  {

	FILE  *l_ptr_ini_file = NULL;
	FILE  *l_ptr_handoff_file = NULL;
	char  chr_g_log_buffer[BUFFER_LEN] = APL_NULL_STRING;
	char  chr_l_inifile[100]= APL_NULL_STRING;
	char  chr_l_handoff_dir[PATH_LENGTH]= APL_NULL_STRING;
    char  chr_l_handoff_file_name[FILENAME_LEN_A]= APL_NULL_STRING;	
	char  chr_l_header[100]= APL_NULL_STRING;
	char  chr_l_trailer[200]= APL_NULL_STRING;
	char  chr_l_detail_rec[1000] =APL_NULL_STRING;
	int   int_l_batchseq=0;
	int   counter=0;
	int   int_l_batchseq_934=0;
	int   l_int_cnt_934=0;
	double l_int_hdr_qty_934=0.0;
	double int_l_deliver_qty_934=0.0;
	double int_l_receive_qty_934=0.0;
	int int_l_zero_qty_934=0;
	int l_int_cnt=0;
	double l_int_hdr_qty=0.0;
	int   batch_seq_display_934=0;
	int   batch_seq_display=0;
	int   counter_934=0;
	char  chr_l_instr_isin[13]= APL_NULL_STRING;
	char  chr_l_oth_cmbpid[29]= APL_NULL_STRING;
	char  chr_l_oth_setlno[8]= APL_NULL_STRING;
	char  chr_l_oth_mkt_type[3]= APL_NULL_STRING;
	char  chr_l_remark[21]= APL_NULL_STRING;
	/* char  chr_l_send_refno1[36]= APL_NULL_STRING;
	char  chr_l_send_refno2[36]= APL_NULL_STRING; 
	** Modified For ISKB_3298 Changes - Jun2010 - Naren V */
	char  chr_l_send_refno1[51]= APL_NULL_STRING;
	char  chr_l_send_refno2[51]= APL_NULL_STRING; 
	char  chr_l_depo_part_code[21]=APL_NULL_STRING;
	char  chr_l_cmbp_id[29]=APL_NULL_STRING;
	char  chr_l_pms_cmbpid[29]=APL_NULL_STRING; //added by asmeet for PMS 12434
	char  chr_l_pms_client_cmbp_pid[29]=APL_NULL_STRING; //added by asmeet for PMS 12434
	char  chr_l_client_cpid[29]=APL_NULL_STRING; //added by asmeet for PMS 12434
	char  chr_l_pms_cmbpid_t2t[29]=APL_NULL_STRING; //added by asmeet for PMS 12434
	char  chr_l_pms_client_cmbp_pid_t2t[29]=APL_NULL_STRING; //added by asmeet for PMS 12434
	char  chr_l_client_cpid_t2t[29]=APL_NULL_STRING; //added by asmeet for PMS 12434
	char  chr_l_dpid[21]=APL_NULL_STRING;
	int   int_l_len=0;
 	char  chr_p_depository_code_new[5]= APL_NULL_STRING;
    char  chr_p_instr_type_new=APL_NULL_CHAR; 
	int	  int_l_records=0;
	char  chr_l_dprole[3]= APL_NULL_STRING;
	char  chr_l_user[APL_USERID_LEN] = APL_NULL_STRING;
	char  pro_sys_date[APL_DATE_LEN] = APL_NULL_STRING;
	char  chr_l_maker[APL_USERID_LEN] = APL_NULL_STRING;
	char  chr_l_maker_dt[APL_DATE_LEN] = APL_NULL_STRING;
	char  chr_l_access_stamp[APL_DATE_LEN] = APL_NULL_STRING;
	/* char  chr_l_internal_ref_no[21] = APL_NULL_STRING;
	** Modified For ISKB_3298 Changes - Jun2010 - Naren V */
	char  chr_l_internal_ref_no[36] = APL_NULL_STRING;
	char  chr_l_settlement_dt[20] = APL_NULL_STRING;
	char  chr_l_instruction_type[4] = APL_NULL_STRING;
	double l_tot_qty=0.0;
	char  chr_l_identiy_no[17]= APL_NULL_STRING;
	char  chr_l_refno_str[4001]= APL_NULL_STRING;
	int   counter2=0;
	double l_int_purchasesum=0.0;
	double l_int_salesum=0.0;
	double l_int_net_amt=0.0;
	char l_chr_instr_code[9]= APL_NULL_STRING;
	char chr_l_cln_depomap_id[21]= APL_NULL_STRING;
	char chr_l_flg='Y';
	char chr_l_identiy_t2t[18]= APL_NULL_STRING;
	double int_l_deliver_qty=0.0;
	double int_l_receive_qty=0.0;
	int int_l_zero_qty=0;
	char chr_l_dl_class[DL_DL_CLASS_LEN]=APL_NULL_STRING;
	// IB_12174 start
	char chr_l_set_exch_cd[11]=APL_NULL_STRING;
	short i_set_exch_cd=0;
	char chr_l_stl_mkt_type[4]=APL_NULL_STRING;
	short i_stl_mkt_type=0;
	char chr_l_setl_no[10]=APL_NULL_STRING;
	short i_setl_no=0;
	// IB_12174 end
		
	char  chr_cmbp_id_new[9]=APL_NULL_STRING;
	short i_cmbp_id_new=0;
	
	short i_cmbp_id=0;
	short i_pms_client_cmbpid=0; //added by asmeet for PMS 12434
	short i_pms_client_cmbpid_t2t=0; //added by asmeet for PMS 12434
	short i_instr_isin=0;
	short i_dpid=0;
	short i_depo_part_code=0;
	short i_int_l_records=0;
	short i_l_tot_qty=0;
	short i_settlement_dt=0;
	short i_purchasesum=0;
	short i_salesum=0;
	short i_cln_depomap_id=0;
	short i_dl_class=0;
	

	SYS_DL_DEAL_STRUCT_H  *l_dl_deal_struct_h = NULL;
    SYS_DL_DEAL_STRUCT_I  *l_dl_deal_struct_i = NULL;	
		
	
	
	l_dl_deal_struct_h=(SYS_DL_DEAL_STRUCT_H *)calloc(1,sizeof(SYS_DL_DEAL_STRUCT_H));
	APL_MALLOC_FAIL(l_dl_deal_struct_h)
	l_dl_deal_struct_i=(SYS_DL_DEAL_STRUCT_I *)calloc(1,sizeof(SYS_DL_DEAL_STRUCT_I));
	APL_MALLOC_FAIL(l_dl_deal_struct_i)

	memset(l_dl_deal_struct_h, NULL, sizeof(SYS_DL_DEAL_STRUCT_H));
	memset(l_dl_deal_struct_i, NULL, sizeof(SYS_DL_DEAL_STRUCT_I));
		memset(chr_g_log_buffer,APL_NULL_CHAR,BUFFER_LEN);
		//KB_12174
		memset(chr_l_set_exch_cd, APL_NULL_CHAR, sizeof(chr_l_set_exch_cd));
		memset(chr_l_stl_mkt_type, APL_NULL_CHAR, sizeof(chr_l_stl_mkt_type));
		memset(chr_l_setl_no, APL_NULL_CHAR, sizeof(chr_l_setl_no));

	EXEC SQL BEGIN DECLARE SECTION;
/*
		EXEC SQL VAR chr_p_instr_type IS STRING;
		EXEC SQL VAR chr_p_trns_type IS STRING;
	 	EXEC SQL VAR chr_p_depository_code IS STRING;
		EXEC SQL VAR chr_p_file_type IS STRING;  

		EXEC SQL VAR chr_p_deal_date IS STRING;
		EXEC SQL VAR chr_p_exch_code IS STRING;
		EXEC SQL VAR chr_p_settlement_no IS STRING;
		EXEC SQL VAR chr_p_mkt_type IS STRING;
		EXEC SQL VAR chr_p_dp_id IS STRING;	 */
		EXEC SQL VAR chr_p_depository_code_new IS STRING;
/*		EXEC SQL VAR chr_p_instr_type_new IS STRING;
*/		EXEC SQL VAR chr_l_header IS STRING;
		EXEC SQL VAR chr_l_trailer IS STRING;
		EXEC SQL VAR chr_l_instruction_type IS STRING;
		
		EXEC SQL VAR chr_l_depo_part_code IS STRING;	
		EXEC SQL VAR chr_l_instr_isin IS STRING;
		EXEC SQL VAR chr_l_maker IS STRING;
		EXEC SQL VAR chr_l_maker_dt IS STRING;
		EXEC SQL VAR chr_l_access_stamp IS STRING;
		EXEC SQL VAR chr_l_settlement_dt IS STRING;
		EXEC SQL VAR chr_l_identiy_no IS STRING;
		EXEC SQL VAR chr_l_cln_depomap_id IS STRING;
		EXEC SQL VAR chr_l_identiy_t2t IS STRING;
		EXEC SQL VAR chr_l_dl_class IS STRING;
		EXEC SQL VAR chr_cmbp_id_new IS STRING; 
		
	EXEC SQL END DECLARE SECTION;
	

	Alert("Enter Proc_GenDVP_Instrn");
		  strcpy(chr_l_maker,chr_p_user);

		  if (  CO_RtvSysDt(pro_sys_date,l_debug_info_ptr) == APL_FAILURE )
		  {
            APL_GOBACK_FAIL
		  }
		  strcpy(chr_l_maker_dt,pro_sys_date);
		

		 if (  CO_RtvSysDtTime(pro_sys_date,l_debug_info_ptr) == APL_FAILURE )
         {
			 APL_GOBACK_FAIL
		 }
		 strcpy(chr_l_access_stamp,pro_sys_date);

		
	 	fprintf(g_flogfile,"DVP:Inside Function Values Are .... \n");	 
	
		 
		fprintf(g_flogfile,"DVP:chr_p_instr_type|%s|\n",chr_p_instr_type);	
		fprintf(g_flogfile,"DVP:chr_p_trns_type|%s|\n",chr_p_trns_type);	
		fprintf(g_flogfile,"DVP:chr_p_depository_code|%s|\n",chr_p_depository_code);	
		fprintf(g_flogfile,"DVP:chr_p_file_type|%s|\n",chr_p_file_type);	
		fprintf(g_flogfile,"DVP:chr_p_deal_date|%s|\n",chr_p_deal_date);	
		fprintf(g_flogfile,"DVP:chr_p_exch_code|%s|\n",chr_p_exch_code);	
		fprintf(g_flogfile,"DVP:chr_p_settlement_no|%s|\n",chr_p_settlement_no);	
		fprintf(g_flogfile,"DVP:chr_p_mkt_type|%s|\n",chr_p_mkt_type);	
		fprintf(g_flogfile,"DVP:chr_p_dp_id|%s|\n",chr_p_dp_id);	
	 
		EXEC SQL SELECT DECODE(:chr_p_depository_code,'N','NSDL','C','CDSL')
/*			 				 DECODE(:chr_p_instr_type,'I','3','O','4')							*/
						INTO :chr_p_depository_code_new FROM dual;
		IS_ANY_ORA_ERROR

		
	Alert("Before Count Query");
	  if(strcmp(chr_p_instr_type,"I")==0)
	  {

		  EXEC SQL SELECT COUNT(*),NVL(SUM(X.tot_qty),0) INTO :int_l_records:i_int_l_records,:l_tot_qty:i_l_tot_qty
		FROM (SELECT COUNT(*),DECODE(:chr_p_instr_type,'I',NVL(SUM(f.qty),0),'O',NVL(SUM(a.qty),0)) AS tot_qty 
			  FROM Dl_Deal a , mt_instrument c,mt_cli_depo_map d,dl_dpgen_det f
			  WHERE a.client=f.dl_client
				AND a.identiy_no=f.dl_ref_no
				AND NVL(f.gendp_flg,'N')='Y'
				AND a.client=d.cln_code
				AND a.instr_code=c.instr_code
				AND d.cln_depo_code=:chr_p_depository_code_new
				AND d.cln_depo_map_dp_id=:chr_p_dp_id
				AND (a.deal_cd = DECODE(:chr_p_instr_type,'I','1','O','2') OR
									a.deal_cd = DECODE(:chr_p_instr_type,'I','3','O','4'))
				AND a.exch_code=:chr_p_exch_code
				AND a.settlement_no=:chr_p_settlement_no
				AND a.mkt_type=:chr_p_mkt_type
				AND TO_CHAR(deal_date,'DD/MM/YYYY')=:chr_p_deal_date
				AND a.clh_flg=:chr_p_trns_type
				AND a.deal_stat IN('CC','MS')
				AND a.mkt_type!=DECODE(a.exch_code,'NSE','22','BSE','16','MCS','03') /*Added by PT MCS*/
				AND a.NDS_BLK_DT is null
			GROUP BY a.client,d.cln_depo_map_client_id,a.instr_code,a.exch_code,
				a.settlement_no,a.mkt_type,a.deal_cd,c.instr_isin,a.setl_date,
				f.broker_cmbpid,f.cp_clnid,f.broker_dpid,f.cp_dpid,a.ex_arena,f.exec_dt,a.dl_class) X;

	   }
	   if(strcmp(chr_p_instr_type,"O")==0)
	   {
		 EXEC SQL SELECT COUNT(*),NVL(SUM(X.tot_qty),0) INTO :int_l_records:i_int_l_records,:l_tot_qty:i_l_tot_qty
			FROM (SELECT COUNT(*),DECODE(:chr_p_instr_type,'I',NVL(SUM(f.qty),0),'O',NVL(SUM(a.qty),0)) AS tot_qty 
			  FROM Dl_Deal a , mt_instrument c,mt_cli_depo_map d,dl_dpgen_det f
			  WHERE a.client=f.dl_client
				AND a.identiy_no=f.dl_ref_no
				AND NVL(f.gendp_flg,'N')='Y'
				AND a.client=d.cln_code
				AND a.instr_code=c.instr_code
				AND d.cln_depo_code=:chr_p_depository_code_new
				AND d.cln_depo_map_dp_id=:chr_p_dp_id
				AND (a.deal_cd = DECODE(:chr_p_instr_type,'I','1','O','2') OR
									a.deal_cd = DECODE(:chr_p_instr_type,'I','3','O','4'))
				AND a.exch_code=:chr_p_exch_code
				AND a.settlement_no=:chr_p_settlement_no
				AND a.mkt_type=:chr_p_mkt_type
				AND TO_CHAR(deal_date,'DD/MM/YYYY')=:chr_p_deal_date
				AND a.clh_flg=:chr_p_trns_type
				AND a.deal_stat='CC'
				AND a.mkt_type!=DECODE(a.exch_code,'NSE','22','BSE','16','MCS','03') /*Added by PT MCS*/
				AND a.NDS_BLK_DT is null
				AND ( (f.DP_ID IS NULL) OR (f.DP_ID IS NOT NULL AND f.DP_ID=d.cln_depo_map_dp_id and f.CLIENT_ID = d.cln_depo_map_client_id) )
			GROUP BY a.client,d.cln_depo_map_client_id,a.instr_code,a.exch_code,
				a.settlement_no,a.mkt_type,a.deal_cd,c.instr_isin,a.setl_date,
				f.broker_cmbpid,f.cp_clnid,f.broker_dpid,f.cp_dpid,a.ex_arena,f.exec_dt,a.dl_class) X;

	   }
	
	Alert("After Count Query");
		  if(int_l_records==0)
		 {
			 fprintf(g_flogfile,"DVP: NO Records Found For the Given Criteria !!!");
			  chr_l_flg='N';
		  }

		  IS_ANY_ORA_ERROR

		  printf("No Of DVP Records|%d| \n",int_l_records);
		  sprintf(chr_g_log_buffer,"\n No Of DVP Records|%d|",int_l_records);	
		  fprintf(g_flogfile,"%s",chr_g_log_buffer);

	  if(chr_l_flg== 'Y')
	  {
			/** EXEC SQL SELECT DL_DPINSTRSEQ.NEXTVAL INTO :int_l_batchseq FROM DUAL;
			IS_ANY_ORA_ERROR Commented by arun for 934 on - market hand delivery**/ 
			
			


/********************** Inserting Header Record **********************/
		
		  printf("batch_no is %d\n",int_l_batchseq);
		  printf("chr_p_dp_id is %s\n",chr_p_dp_id);
		  printf("int_l_records is %d\n",int_l_records);
		  printf("l_tot_qty is %f\n",l_tot_qty);//AIX Warning Removal
		  printf("int_l_batchseq=|%d| \n",int_l_batchseq);
		  printf("chr_l_maker=|%s| \n",chr_l_maker);
		  printf("chr_l_maker_dt=|%s| \n",chr_l_maker_dt);
		  printf("chr_l_access_stamp=|%s| \n",chr_l_access_stamp);
		  
	Alert("Before Insert Header Query");

		/*Changed by Narendra Kumar for ISKB_3298 -- Static data change -- change of DP role from 04 to 01 -- Started*/

			/*EXEC SQL INSERT INTO dl_dpinstr_hdr
						(batch_no,record_type,dp_id,dp_role,buy_sell_flg,status,tot_num_record,
						 tot_qty,maker,maker_date,access_stamp)
			 			 VALUES(:int_l_batchseq,01,:chr_p_dp_id,04,DECODE(:chr_p_instr_type,'I','S','O','B'),
								 'G',:int_l_records,:l_tot_qty,:chr_l_maker,:chr_l_maker_dt,:chr_l_access_stamp);*/

			/**** EXEC SQL INSERT INTO dl_dpinstr_hdr
						(batch_no,record_type,dp_id,dp_role,buy_sell_flg,status,tot_num_record,
						 tot_qty,maker,maker_date,access_stamp)
			 			 VALUES(:int_l_batchseq,01,:chr_p_dp_id,01,DECODE(:chr_p_instr_type,'I','S','O','B'),
								 'G',:int_l_records,:l_tot_qty,:chr_l_maker,:chr_l_maker_dt,:chr_l_access_stamp);Commented by arun for 934 on - market hand delivery**/

			/*Changed by Narendra Kumar for ISKB_3298 -- Static data change -- change of DP role from 04 to 01 -- Ended*/
			
			IS_ANY_ORA_ERROR
			
	Alert("After Insert Header Query");
		printf("\n DVP Cursor:After Inserting Header Record \n");

		
		
		fprintf(g_flogfile,"DVP Cursor:After Inserting Header Record");
		fflush(g_flogfile);
		
/********************** Inserting Header Record **********************/

	if(strcmp(chr_p_instr_type,"I")==0)
	{

	Alert("Before Cursor declare for I ");
	//IB_12174 start
	   EXEC SQL DECLARE l_cur_gen_dvp_dpinstr1 CURSOR FOR	
		 SELECT a.client,d.cln_depo_map_client_id,a.instr_code,a.exch_code,a.mkt_type,a.settlement_no,a.deal_cd,
				DECODE(:chr_p_instr_type,'I',NVL(SUM(f.qty),0),'O',NVL(SUM(f.qty),0)) AS QTY,
				DECODE(a.ex_arena,'2',f.cp_dpid,f.broker_cmbpid) as CMBPID,
				DECODE(a.ex_arena,'2',f.cp_clnid,f.broker_dpid) as DPID,
/*		 		DECODE(f.broker_cmbpid,NULL,f.cp_clnid,f.broker_cmbpid) as CMBPID,
				DECODE(f.broker_dpid,NULL,f.cp_dpid,f.broker_dpid) as DPID,
*/				c.instr_isin,
				f.exec_dt,
				a.dl_class,
				a.domestic_cpclt,
				a.deal_date,
				d.cmbp_id
		FROM Dl_Deal a , mt_instrument c,mt_cli_depo_map d,dl_dpgen_det f
			  WHERE a.client=f.dl_client
			AND a.identiy_no=f.dl_ref_no
			AND NVL(f.gendp_flg,'N')='Y'
			AND a.client=d.cln_code
			AND a.instr_code=c.instr_code
	 	    AND d.cln_depo_code=:chr_p_depository_code_new
			AND d.cln_depo_map_dp_id=:chr_p_dp_id
			AND (a.deal_cd = DECODE(:chr_p_instr_type,'I','1','O','2') OR
			  					a.deal_cd = DECODE(:chr_p_instr_type,'I','3','O','4'))
			AND a.exch_code=:chr_p_exch_code
			AND a.settlement_no=:chr_p_settlement_no
			AND a.mkt_type=:chr_p_mkt_type
			AND TO_CHAR(deal_date,'DD/MM/YYYY')=:chr_p_deal_date
			AND a.clh_flg=:chr_p_trns_type
			AND a.deal_stat IN('CC','MS')
			AND a.mkt_type!=DECODE(a.exch_code,'NSE','22','BSE','16','MCS','03') /*Added by PT MCS*/
			AND a.NDS_BLK_DT is null
		GROUP BY a.ex_arena,a.client,d.cln_depo_map_client_id,a.instr_code,a.exch_code,a.settlement_no,a.mkt_type,a.deal_cd,
				c.instr_isin,a.setl_date,
				f.broker_cmbpid,f.cp_clnid,f.broker_dpid,f.cp_dpid,f.exec_dt,a.dl_class,a.domestic_cpclt,a.deal_date,d.cmbp_id;
	
           //IB_12174 end
	
		EXEC SQL OPEN l_cur_gen_dvp_dpinstr1;
		IS_ANY_ORA_ERROR	
		
	}	
	if(strcmp(chr_p_instr_type,"O")==0)
	{		
	Alert("Before Cursor declare for O ");
		 EXEC SQL DECLARE l_cur_gen_dvp_dpinstr2 CURSOR FOR	
		 SELECT a.client,d.cln_depo_map_client_id,a.instr_code,a.exch_code,a.mkt_type,a.settlement_no,a.deal_cd,
				DECODE(:chr_p_instr_type,'I',NVL(SUM(f.qty),0),'O',NVL(SUM(f.qty),0)) AS QTY,
				DECODE(a.ex_arena,'2',f.cp_dpid,f.broker_cmbpid) as CMBPID,
				DECODE(a.ex_arena,'2',f.cp_clnid,f.broker_dpid) as DPID,
				c.instr_isin,
				f.exec_dt,
				a.dl_class
		FROM Dl_Deal a , mt_instrument c,mt_cli_depo_map d,dl_dpgen_det f
			  WHERE a.client=f.dl_client
			AND a.identiy_no=f.dl_ref_no
			AND NVL(f.gendp_flg,'N')='Y'
			AND a.client=d.cln_code
			AND a.instr_code=c.instr_code
	 	    AND d.cln_depo_code=:chr_p_depository_code_new
			AND d.cln_depo_map_dp_id=:chr_p_dp_id
			AND (a.deal_cd = DECODE(:chr_p_instr_type,'I','1','O','2') OR
			  					a.deal_cd = DECODE(:chr_p_instr_type,'I','3','O','4'))
			AND a.exch_code=:chr_p_exch_code
			AND a.settlement_no=:chr_p_settlement_no
			AND a.mkt_type=:chr_p_mkt_type
			AND TO_CHAR(deal_date,'DD/MM/YYYY')=:chr_p_deal_date
			AND a.clh_flg=:chr_p_trns_type
			AND a.deal_stat='CC'
			AND a.mkt_type!=DECODE(a.exch_code,'NSE','22','BSE','16','MCS','03') /*Added by PT MCS*/
			AND a.NDS_BLK_DT is null
			AND ( (f.DP_ID IS NULL) OR (f.DP_ID IS NOT NULL AND f.DP_ID=d.cln_depo_map_dp_id and f.CLIENT_ID = d.cln_depo_map_client_id) )
		GROUP BY a.ex_arena,a.client,d.cln_depo_map_client_id,a.instr_code,a.exch_code,a.settlement_no,a.mkt_type,a.deal_cd,
				c.instr_isin,a.setl_date,
				f.broker_cmbpid,f.cp_clnid,f.broker_dpid,f.cp_dpid,f.exec_dt,a.dl_class;
			
			EXEC SQL OPEN l_cur_gen_dvp_dpinstr2;
			IS_ANY_ORA_ERROR

	}

	

	   for(;;)
	   {
			memset(l_dl_deal_struct_h, NULL, sizeof(SYS_DL_DEAL_STRUCT_H));
			memset(l_dl_deal_struct_i, NULL, sizeof(SYS_DL_DEAL_STRUCT_I));
			memset(chr_l_refno_str,APL_NULL_CHAR,4001);
			memset(chr_l_cmbp_id,APL_NULL_CHAR,sizeof(chr_l_cmbp_id));
			memset(chr_l_dpid,APL_NULL_CHAR,sizeof(chr_l_dpid));
			memset(chr_l_instr_isin,APL_NULL_CHAR,sizeof(chr_l_instr_isin));
			memset(chr_l_dl_class,APL_NULL_CHAR,sizeof(chr_l_dl_class));
			memset(chr_l_pms_client_cmbp_pid,APL_NULL_CHAR,sizeof(chr_l_pms_client_cmbp_pid));
		
			/* Swapnil for DP Issue */
			memset(chr_l_set_exch_cd, APL_NULL_CHAR, sizeof(chr_l_set_exch_cd));
			memset(chr_l_stl_mkt_type, APL_NULL_CHAR, sizeof(chr_l_stl_mkt_type));
			memset(chr_l_setl_no, APL_NULL_CHAR, sizeof(chr_l_setl_no));			
		
	    if(strcmp(chr_p_instr_type,"I")==0)
		{	
	Alert("Before Cursor Fetch for I ");

			EXEC SQL FETCH l_cur_gen_dvp_dpinstr1 INTO :l_dl_deal_struct_h->h_dl_client:l_dl_deal_struct_i->i_dl_client,
													:chr_l_cln_depomap_id:i_cln_depomap_id,	
													:l_dl_deal_struct_h->h_instr_code:l_dl_deal_struct_i->i_instr_code,
													:l_dl_deal_struct_h->h_exch_code:l_dl_deal_struct_i->i_exch_code,
													:l_dl_deal_struct_h->h_mkt_type:l_dl_deal_struct_i->i_mkt_type,	
													:l_dl_deal_struct_h->h_settlement_no:l_dl_deal_struct_i->i_settlement_no,
													:l_dl_deal_struct_h->h_dealcd:l_dl_deal_struct_i->i_dealcd,
													:l_dl_deal_struct_h->h_qty:l_dl_deal_struct_i->i_qty,
													:chr_l_cmbp_id:i_cmbp_id,
													:chr_l_dpid:i_dpid,
													:chr_l_instr_isin:i_instr_isin,
													:l_dl_deal_struct_h->h_setldt:l_dl_deal_struct_i->i_setldt,
													:chr_l_dl_class:i_dl_class,
													:l_dl_deal_struct_h->h_domcpclt_cd:l_dl_deal_struct_i->i_domcpclt_cd,
													:l_dl_deal_struct_h->h_dlt:l_dl_deal_struct_i->i_dlt,
													:chr_l_pms_client_cmbp_pid:i_pms_client_cmbpid;
				if(APL_ZERO_RESULT_SET)
				{
				
				 if(counter==0 && counter_934==0)
				  {
						fprintf(g_flogfile,"No Records Found in l_cur_gen_dvp_dpinstr1 CURSOR!" );
				  }
				  break;
				}
				IS_ANY_ORA_ERROR
		
		}
		if(strcmp(chr_p_instr_type,"O")==0)
		{	

	Alert("Before Cursor Fetch for O ");
			EXEC SQL FETCH l_cur_gen_dvp_dpinstr2 INTO :l_dl_deal_struct_h->h_dl_client:l_dl_deal_struct_i->i_dl_client,
													:chr_l_cln_depomap_id:i_cln_depomap_id,	
													:l_dl_deal_struct_h->h_instr_code:l_dl_deal_struct_i->i_instr_code,
													:l_dl_deal_struct_h->h_exch_code:l_dl_deal_struct_i->i_exch_code,
													:l_dl_deal_struct_h->h_mkt_type:l_dl_deal_struct_i->i_mkt_type,	
													:l_dl_deal_struct_h->h_settlement_no:l_dl_deal_struct_i->i_settlement_no,
													:l_dl_deal_struct_h->h_dealcd:l_dl_deal_struct_i->i_dealcd,
													:l_dl_deal_struct_h->h_qty:l_dl_deal_struct_i->i_qty,
													:chr_l_cmbp_id:i_cmbp_id,
													:chr_l_dpid:i_dpid,
													:chr_l_instr_isin:i_instr_isin,
													:l_dl_deal_struct_h->h_setldt:l_dl_deal_struct_i->i_setldt,
													:chr_l_dl_class:i_dl_class;
				if(APL_ZERO_RESULT_SET)
				{
				
				 if(counter==0 && counter_934==0)
				  {
						fprintf(g_flogfile,"No Records Found in l_cur_gen_dvp_dpinstr2 CURSOR!" );
				  }
				  break;
				}
				IS_ANY_ORA_ERROR
		
		}	
	Alert("After Cursor Fetch ");


			//counter++;
			

			

		 EXEC SQL SELECT :l_dl_deal_struct_h->h_dealcd INTO :chr_p_instr_type_new
								FROM dual;
		 
		 IS_ANY_ORA_ERROR 
		 // IB_12174 start
		  if(strcmp(chr_p_instr_type,"I")==0 )
		{
			Alert("\n a1 Swapnil for Mkt_Type_22 issue : chr_l_set_exch_cd = |%s|",chr_l_set_exch_cd);
			Alert("\n a1 Swapnil for Mkt_Type_22 issue : PTY_CODE = |%s|",l_dl_deal_struct_h->h_domcpclt_cd);	
			
                   EXEC SQL SELECT SET_EXCH_CODE INTO :chr_l_set_exch_cd:i_set_exch_cd
		   FROM MT_PARTY WHERE PTY_CODE=:l_dl_deal_struct_h->h_domcpclt_cd;
		
		   IS_ANY_ORA_ERROR

			Alert("\n a2 Swapnil for Mkt_Type_22 issue : chr_l_stl_mkt_type = |%s|",chr_l_stl_mkt_type);		   
			Alert("\n a2 Swapnil for Mkt_Type_22 issue : chr_l_set_exch_cd = |%s|",chr_l_set_exch_cd);
			Alert("\n a2 Swapnil for Mkt_Type_22 issue : TRD_MKT_TYPE = |%s|",l_dl_deal_struct_h->h_mkt_type);
			Alert("\n a2 Swapnil for Mkt_Type_22 issue : TRD_EXCH = |%s|",l_dl_deal_struct_h->h_exch_code);		   
			Alert("\n a2 Swapnil for Mkt_Type_22 issue : sqlca.sqlcode = |%d|",sqlca.sqlcode);		   
		   
		   EXEC SQL SELECT SETT_MKT_TYPE  INTO :chr_l_stl_mkt_type:i_stl_mkt_type FROM STATIC_TRAD_SETT_EXCH
							WHERE TRD_MKT_TYPE = :l_dl_deal_struct_h->h_mkt_type
							AND TRD_EXCH = :l_dl_deal_struct_h->h_exch_code
							AND  SETT_EXCH      = decode(:chr_l_set_exch_cd,'NSCCL','NSE','ICCL','BSE');
							Alert("\n shrinath8 \n");
		IS_ANY_ORA_ERROR
		
			Alert("\n a3 Swapnil for Mkt_Type_22 issue : chr_l_setl_no = |%s|",chr_l_setl_no);	
			Alert("\n a3 Swapnil for Mkt_Type_22 issue : chr_l_stl_mkt_type = |%s|",chr_l_stl_mkt_type);	
			Alert("\n a3 Swapnil for Mkt_Type_22 issue : START_DATE = |%s|",l_dl_deal_struct_h->h_dlt);	
			Alert("\n a3 Swapnil for Mkt_Type_22 issue : sqlca.sqlcode = |%d|",sqlca.sqlcode);			
			
		EXEC SQL SELECT SETTL_NO INTO :chr_l_setl_no:i_setl_no from mt_settl_cal a where EXCH_CODE = decode(:chr_l_set_exch_cd,'NSCCL','NSE','ICCL','BSE')
			AND settl_type = :chr_l_stl_mkt_type 
			AND START_DATE =to_date(:l_dl_deal_struct_h->h_dlt,'dd/MM/yyyy hh24:mi:ss');
			
			Alert("\n a4 Swapnil for Mkt_Type_22 issue : chr_l_setl_no = |%s|",chr_l_setl_no);
			Alert("\n a4 Swapnil for Mkt_Type_22 issue : h_settlement_no = |%s|",l_dl_deal_struct_h->h_settlement_no);
			Alert("\n a4 Swapnil for Mkt_Type_22 issue : sqlca.sqlcode = |%d|",sqlca.sqlcode);			
			
			if ((!strlen(chr_l_stl_mkt_type) || !strlen(chr_l_setl_no)))
			{
			Alert("\n shrinath99999999999999999999 \n");
				strcpy(chr_l_stl_mkt_type,l_dl_deal_struct_h->h_mkt_type);
				strcpy(chr_l_setl_no,l_dl_deal_struct_h->h_settlement_no);
			}
		Alert("chr_l_set_exch_cd:==|%s|, chr_l_stl_mkt_type==|%s|,chr_l_setl_no==|%s|,domestic_cpclt=|%s|,deal_date==|%s|",chr_l_set_exch_cd,chr_l_stl_mkt_type,chr_l_setl_no,l_dl_deal_struct_h->h_domcpclt_cd,l_dl_deal_struct_h->h_dlt);	
			IS_ANY_ORA_ERROR
		}
		  // IB_12174 End
		
		 
		 sprintf(chr_g_log_buffer,"\n DVP********DEAL CD**************=|%c| ",chr_p_instr_type_new);	
		 fprintf(g_flogfile,"%s",chr_g_log_buffer);

	/*	if(strcmp(l_dl_deal_struct_h->h_dealcd,"1")==0 || strcmp(l_dl_deal_struct_h->h_dealcd,"3")==0)
		{	
			strcpy(chr_l_instruction_type,"904");

		}
		else if(strcmp(l_dl_deal_struct_h->h_dealcd,"2")==0 || strcmp(l_dl_deal_struct_h->h_dealcd,"4")==0)
		{
			strcpy(chr_l_instruction_type,"905");
			
		}*/


		memset(chr_cmbp_id_new,APL_NULL_CHAR,sizeof(chr_cmbp_id_new));
		 if(strcmp(chr_p_depository_code_new,"NSDL")==0)	
		 {
			 //Alert("\n CLH********l_dl_deal_struct_h->h_dl_client**************=|%s| \n",l_dl_deal_struct_h->h_dl_client);
			 EXEC SQL SELECT CMBP_ID INTO :chr_cmbp_id_new:i_cmbp_id_new 
			 FROM MT_CLI_DEPO_MAP 
			 WHERE CLN_CODE =  :l_dl_deal_struct_h->h_dl_client 
			 and STATUS='AA' 
			 and CLN_DEPO_CODE = :chr_p_depository_code_new
			 AND CMBP_ID IS NOT NULL
			 AND ROWNUM =1;			 
			 
			 
			 Alert("shr:: sqlca.sqlcode |%d|",sqlca.sqlcode);
                         IS_ANY_ORA_ERROR			
			}

		if(strcmp(l_dl_deal_struct_h->h_dealcd,"3")==0)
		{	
			//strcpy(chr_l_instruction_type,"904");
			if(strcmp(chr_cmbp_id_new,APL_NULL_STRING)==0)
					strcpy(chr_l_instruction_type,"904");			
                else
                    strcpy(chr_l_instruction_type,"934"); 					

		}
		else if(strcmp(l_dl_deal_struct_h->h_dealcd,"4")==0)
		{
			//strcpy(chr_l_instruction_type,"905"); ARUNACHALAM K
			if(strcmp(chr_cmbp_id_new,APL_NULL_STRING)==0)
					strcpy(chr_l_instruction_type,"905");			
                else
                    strcpy(chr_l_instruction_type,"934"); 		
			
		}else if (strcmp(l_dl_deal_struct_h->h_dealcd,"1")==0 ){
					
					strcpy(chr_l_instruction_type,"904");			
			
		}else if (strcmp(l_dl_deal_struct_h->h_dealcd,"2")==0 ){
					
					strcpy(chr_l_instruction_type,"905");
			
		}


		if(strcmp(chr_l_instruction_type,"934")==0)
			{
				
				Alert("INSIDE 934 1");
				if(batch_seq_display_934 ==0)
				{	
			
					Alert("INSIDE 934 SEQ");
					EXEC SQL SELECT DL_DPINSTRSEQ.NEXTVAL INTO :int_l_batchseq_934 FROM DUAL;
					IS_ANY_ORA_ERROR
						
						batch_seq_display_934 = 1;
				}
				counter_934++;
				sprintf(chr_l_internal_ref_no,"%d%d",int_l_batchseq_934,counter_934);
				
				Alert("INSIDE 934 SEQ IS |%d| :",int_l_batchseq_934);
				
			}
		else
			{
				
				Alert("INSIDE 904 1");
				if(batch_seq_display ==0)
				{	
					Alert("INSIDE 904 SEQ");
					EXEC SQL SELECT DL_DPINSTRSEQ.NEXTVAL INTO :int_l_batchseq FROM DUAL;
					IS_ANY_ORA_ERROR
						
						batch_seq_display = 1;
				}
				counter++;
				sprintf(chr_l_internal_ref_no,"%d%d",int_l_batchseq,counter);
				Alert("INSIDE 904 SEQ IS |%d| :",int_l_batchseq);
				
			}
			
			//sprintf(chr_l_internal_ref_no,"%d%d",int_l_batchseq,counter);
			strcpy(chr_l_send_refno1,chr_l_internal_ref_no);

			sprintf(chr_g_log_buffer,"\n DVP: Internal Ref No=|%s|",chr_l_internal_ref_no);	
			fprintf(g_flogfile,"%s",chr_g_log_buffer);

		 
/*	********************   Start Retriving IDENTIY_NO from dl_deal table *************** */
/*	Addition BROKER_DPID Condition to identify deal	Rohit	*/
		printf("\n CLIENT=|%s| \n",l_dl_deal_struct_h->h_dl_client);
	Alert("Before Inner Cursor Declare  ");
      if(strcmp(chr_p_instr_type,"I")==0)
      {
			EXEC SQL DECLARE l_cur_upd_dpm_dvp_i CURSOR FOR
				SELECT identiy_no
				FROM Dl_Deal a ,mt_instrument c,mt_cli_depo_map d,dl_dpgen_det f
				where a.client=d.cln_code
				and  a.client=:l_dl_deal_struct_h->h_dl_client
				 and a.instr_code=c.instr_code
				 and a.instr_code=:l_dl_deal_struct_h->h_instr_code
				 and a.identiy_no=f.dl_ref_no
				 AND a.client=f.dl_client
				 AND NVL(f.gendp_flg,'N')='Y'
				 AND a.exch_code=:l_dl_deal_struct_h->h_exch_code
				 AND a.settlement_no=:l_dl_deal_struct_h->h_settlement_no
				 AND a.mkt_type=:l_dl_deal_struct_h->h_mkt_type
				 AND a.mkt_type!=DECODE(a.exch_code,'NSE','22','BSE','16','MCS','03') /*Added by PT MCS*/
				 AND to_char(deal_date,'DD/MM/YYYY')=:chr_p_deal_date
				 AND (a.deal_cd = DECODE(:chr_p_instr_type,'I','1','O','2') OR
					 		a.deal_cd = DECODE(:chr_p_instr_type,'I','3','O','4'))	 
				 AND  d.CLN_DEPO_CODE=:chr_p_depository_code_new
			 	 AND  d.CLN_DEPO_MAP_DP_ID=:chr_p_dp_id
				 AND a.clh_flg=:chr_p_trns_type
				 AND a.deal_stat IN('CC','MS') 
				 AND DECODE(a.ex_arena,'2',f.cp_dpid,f.broker_cmbpid)=:chr_l_cmbp_id
				 AND DECODE(a.ex_arena,'2',f.cp_clnid,f.broker_dpid)=:chr_l_dpid	
				 AND a.NDS_BLK_DT is null;	 

	   EXEC SQL OPEN l_cur_upd_dpm_dvp_i;
		IS_ANY_ORA_ERROR
				 
		}
		else
		{
			EXEC SQL DECLARE l_cur_upd_dpm_dvp_o CURSOR FOR
				SELECT identiy_no
				FROM Dl_Deal a ,mt_instrument c,mt_cli_depo_map d,dl_dpgen_det f
				where a.client=d.cln_code
				and  a.client=:l_dl_deal_struct_h->h_dl_client
				 and a.instr_code=c.instr_code
				 and a.instr_code=:l_dl_deal_struct_h->h_instr_code
				 and a.identiy_no=f.dl_ref_no
				 AND a.client=f.dl_client
				 AND NVL(f.gendp_flg,'N')='Y'
				 AND a.exch_code=:l_dl_deal_struct_h->h_exch_code
				 AND a.settlement_no=:l_dl_deal_struct_h->h_settlement_no
				 AND a.mkt_type=:l_dl_deal_struct_h->h_mkt_type
				 AND a.mkt_type!=DECODE(a.exch_code,'NSE','22','BSE','16','MCS','03') /*Added by PT MCS*/
				 AND to_char(deal_date,'DD/MM/YYYY')=:chr_p_deal_date
				 AND (a.deal_cd = DECODE(:chr_p_instr_type,'I','1','O','2') OR
					 		a.deal_cd = DECODE(:chr_p_instr_type,'I','3','O','4'))	 
				 AND  d.CLN_DEPO_CODE=:chr_p_depository_code_new
			 	 AND  d.CLN_DEPO_MAP_DP_ID=:chr_p_dp_id
				 AND a.clh_flg=:chr_p_trns_type
				 AND a.deal_stat='CC' 
				 AND DECODE(a.ex_arena,'2',f.cp_dpid,f.broker_cmbpid)=:chr_l_cmbp_id
				 AND DECODE(a.ex_arena,'2',f.cp_clnid,f.broker_dpid)=:chr_l_dpid	
				 AND a.NDS_BLK_DT is null;	 
	   	
			EXEC SQL OPEN l_cur_upd_dpm_dvp_o;
		IS_ANY_ORA_ERROR
		}
	Alert("After Inner Cursor Declare  ");
			

	   for(;;)
	   {
			      if(strcmp(chr_p_instr_type,"I")==0)
						      {

	Alert("Before Inner Cursor fetch  ");
		  EXEC SQL FETCH l_cur_upd_dpm_dvp_i INTO :chr_l_identiy_no;
								}
					else
					{
		  EXEC SQL FETCH l_cur_upd_dpm_dvp_o INTO :chr_l_identiy_no;
					}
	Alert("After Inner Cursor fetch  ");
 
		  if(APL_ZERO_RESULT_SET)
		  {
			 if(counter==0 && counter_934==0)
			  {
					fprintf(g_flogfile,"No Records Found in l_cur_upd_dpm_dvp CURSOR!" );
			  }
			 break;

		  }
		  	IS_ANY_ORA_ERROR

		  if(l_dl_deal_struct_h->h_qty > 0)
		  {
			printf("\n [DVP:NonT2T] Updating DP Generation Date for Account|%s|, RefNo|%s| with Date |%s|..",l_dl_deal_struct_h->h_dl_client,chr_l_identiy_no,chr_l_maker_dt);

			 fprintf(g_flogfile,"\n [DVP:NonT2T] Updating DP Generation Date for Account|%s|, RefNo|%s| with Date |%s|",l_dl_deal_struct_h->h_dl_client,chr_l_identiy_no,chr_l_maker_dt);
			
			EXEC SQL UPDATE DL_DEAL SET NDS_BLK_DT=:chr_l_maker_dt WHERE
			identiy_no = :chr_l_identiy_no AND
			client=:l_dl_deal_struct_h->h_dl_client;
			if(sqlca.sqlcode)
			{
				fprintf(g_flogfile,"DVP:Error Updating NDS_BLK_DT ORA|%d|\n",sqlca.sqlcode);
			}
		  	IS_ANY_ORA_ERROR
	Alert("After Update DL_DEAL ");

			printf("\n STRING counter=|%d| \n",counter);

/*			strcat(chr_l_refno_str,"'");	*/
			strcat(chr_l_refno_str,chr_l_identiy_no);
			strcat(chr_l_refno_str,",");

		  }
	
	  }
      if(strcmp(chr_p_instr_type,"I")==0)
      {

		EXEC SQL CLOSE l_cur_upd_dpm_dvp_i;
		}
		else
		{
		EXEC SQL CLOSE l_cur_upd_dpm_dvp_o;
		}
		IS_ANY_ORA_ERROR
	Alert("After Inner Cursor Close ");

/*		EXEC SQL SELECT substr(:chr_l_refno_str,1,length(:chr_l_refno_str)-1) INTO
						:chr_l_refno_str FROM dual;
		IS_ANY_ORA_ERROR
*/
		printf("\nDVP: REF_STRING=|%s|\n",chr_l_refno_str);
		fprintf(g_flogfile,"\n Deal String is=|%s|",chr_l_refno_str); 


   	 if(strcmp(chr_p_instr_type,"I")==0 && (strcmp(chr_l_pms_client_cmbp_pid,APL_NULL_STRING)==0))
	  {
		 strcpy(chr_l_pms_cmbpid,chr_l_cmbp_id); //chr_l_pms_client_cmbp_pid
		 strcpy(chr_l_client_cpid,APL_NULL_STRING);
		  
	  }
	 else
	 {
		 
		if((strcmp(l_dl_deal_struct_h->h_dealcd,"4")==0 || strcmp(l_dl_deal_struct_h->h_dealcd,"3")==0) && strcmp(chr_l_instruction_type,"934")==0 && strcmp(chr_p_trns_type,"D")==0)
		{
			strcpy(chr_l_pms_cmbpid,chr_l_pms_client_cmbp_pid);
			strcpy(chr_l_client_cpid,APL_NULL_STRING); 
		}
		else {	
			strcpy(chr_l_pms_cmbpid,APL_NULL_STRING);
			strcpy(chr_l_client_cpid,chr_l_cmbp_id); 
		}
		
		
		
	 }
		
/*	********************   Start Retriving IDENTIY_NO from dl_deal table *************** */

		
		

		
		sprintf(chr_g_log_buffer,"\n DVP: FETCHED VALUES ARE: \n chr_l_cln_depomap_id=|%s|\n QTY=|%lf|\n EXCH_CODE=|%s| \n SETTLEMENT_NO=|%s| \n MKT_TYPE|%s| \n ISIN=|%s| \n CMBP_ID=|%s| \n Internal REEFNO=|%s|\n DEPOSITORY=|%s| \n",
								chr_l_cln_depomap_id,l_dl_deal_struct_h->h_qty,chr_p_exch_code,l_dl_deal_struct_h->h_settlement_no,
								l_dl_deal_struct_h->h_mkt_type,chr_l_instr_isin,chr_l_cmbp_id,chr_l_internal_ref_no,chr_p_depository_code_new);
	
		fprintf(g_flogfile,"%s",chr_g_log_buffer);
			
		printf("\n chr_l_maker_dt=|%s| \n",chr_l_maker_dt);
		printf("\n l_dl_deal_struct_h->h_instr_code=|%s| \n",l_dl_deal_struct_h->h_instr_code);
		printf("\n chr_l_access_stamp=|%s| \n",chr_l_access_stamp);
		printf("\n chr_l_maker=|%s| \n",chr_l_maker);
		printf("\n chr_l_internal_ref_no=|%s| \n",chr_l_internal_ref_no);
		printf("\n chr_l_instr_isin=|%s| \n",chr_l_instr_isin);
		printf("\n chr_l_cln_depomap_id=|%s| \n",chr_l_cln_depomap_id);	
		
		
		printf("\n ************** : Batch NO for DVP  **************|%d| \n",int_l_batchseq);
			sprintf(chr_g_log_buffer,"\n ************** Batch NO for DVP **************|%d| \n",int_l_batchseq);
			fprintf(g_flogfile,"%s",chr_g_log_buffer);
		printf("\n ************** DVP :Batch NO for POOL TO POOL TRANSACTION **************|%d| \n",int_l_batchseq_934);
		sprintf(chr_g_log_buffer,"\n ************** DVP :Batch NO for POOL TO POOL TRANSACTION **************|%d| \n",int_l_batchseq_934);
		fprintf(g_flogfile,"%s",chr_g_log_buffer);
	
		if(l_dl_deal_struct_h->h_qty > 0)
		{

/*			if(!strcmp(chr_l_dl_class,"59") && !strcmp(chr_p_exch_code,"BSE"))
				strcpy(l_dl_deal_struct_h->h_mkt_type,"4");
			else if(!strcmp(chr_l_dl_class,"59") && !strcmp(chr_p_exch_code,"NSE"))
				strcpy(l_dl_deal_struct_h->h_mkt_type,"14");
*/			
			fprintf(g_flogfile,"DVP:Before Inserting Into DL_DPINSTRS\n");
			// IB_12174 start
			EXEC SQL INSERT INTO DL_DPINSTRS
			(batch_no,serial_no,trans_type,client,instr_code,qty,exch_code,mkt_type,settlement_no,setl_date,isin_cd,
			clh_dvp,cmbp_id,dpm_trans_no,rev_flg,other_branch_cd,other_client_id,other_mkt_type,
			other_stlmnt_no,internal_ref_no,send_ref_1,send_ref_2,maker,maker_date,checker,checker_date,
			access_stamp,status,depo_ind,deal_ref_nos,deal_cd,other_dp_id,client_code)
			VALUES(DECODE(:chr_l_instruction_type,'934',:int_l_batchseq_934,:int_l_batchseq),DECODE(:chr_l_instruction_type,'934',:counter_934,:counter),:chr_l_instruction_type,:chr_l_cln_depomap_id,
				:l_dl_deal_struct_h->h_instr_code,:l_dl_deal_struct_h->h_qty,:chr_p_exch_code,
				:l_dl_deal_struct_h->h_mkt_type,:l_dl_deal_struct_h->h_settlement_no,
			   :l_dl_deal_struct_h->h_setldt,:chr_l_instr_isin,'D',:chr_l_pms_cmbpid,NULL,NULL,NULL,:chr_l_client_cpid,:chr_l_stl_mkt_type,
				:chr_l_setl_no,:chr_l_internal_ref_no,
			   :chr_l_send_refno1,NULL,:chr_l_maker,:chr_l_maker_dt,NULL,NULL,:chr_l_access_stamp,'G',
			   :chr_p_depository_code_new,:chr_l_refno_str,:l_dl_deal_struct_h->h_dealcd,:chr_l_dpid,:l_dl_deal_struct_h->h_dl_client);
			
			
			//IS_ANY_ORA_ERROR
			
			if(sqlca.sqlcode)
			{
				Alert("sqlca.sqlcode -- :  %d : ",sqlca.sqlcode);
				fprintf(g_flogfile,"sqlca.sqlcode  |%d|\n",sqlca.sqlcode);
			
				goto RETURN_FAILURE;
			}
			
	Alert("After Insert DL_DPINSTRS ");
		//IB_12174 ends
			sprintf(chr_g_log_buffer,"DVP Cursor:After Inserting Details Record for client=|%s|",l_dl_deal_struct_h->h_dl_client);	
			fprintf(g_flogfile,"%s",chr_g_log_buffer);

		}
		else if(l_dl_deal_struct_h->h_qty ==  0)
		{
			counter--; //Added by Prateek on 30092014 for ISKB_6847(Serial number is coming wrong in Handoff file)
			int_l_zero_qty++;
			sprintf(chr_g_log_buffer,"DVP:ZERO QUANTITY FOR Client=|%s| Instrument=|%s| \n",l_dl_deal_struct_h->h_dl_client,l_dl_deal_struct_h->h_instr_code);
			fprintf(g_flogfile,"%s",chr_g_log_buffer);
	
		}
			

		strcpy(chr_l_refno_str,APL_NULL_STRING);
		
		if(strcmp(chr_l_instruction_type,"934")==0)
		{
			Alert("After  934 count increased ");
			
			l_int_cnt_934=l_int_cnt_934+1;
			l_int_hdr_qty_934=l_int_hdr_qty_934+l_dl_deal_struct_h->h_qty;
		}
		else
		{
			Alert("After  904 count increased ");
			
			l_int_cnt=l_int_cnt+1;
			l_int_hdr_qty=l_int_hdr_qty+l_dl_deal_struct_h->h_qty;
		}
			
	}
	
	if(strcmp(chr_p_instr_type,"I")==0)
	{
		EXEC SQL CLOSE l_cur_gen_dvp_dpinstr1;
		IS_ANY_ORA_ERROR
	}
	if(strcmp(chr_p_instr_type,"O")==0)
	{
		EXEC SQL CLOSE l_cur_gen_dvp_dpinstr2;
		IS_ANY_ORA_ERROR
	}

	Alert("After  Cursor Close ");
		
		if(strcmp(chr_p_instr_type,"I")==0)
		{
			int_l_deliver_qty=l_tot_qty;
		}
		else if(strcmp(chr_p_instr_type,"O")==0)	
		{
			int_l_receive_qty=l_tot_qty;
		}

	
		/***EXEC SQL INSERT INTO
	  			dl_dpinstr_trail(batch_no,record_type,branch_cd,deliver_qty,receive_qty,										  											tot_qty,status,maker,maker_date,access_stamp)
							 VALUES(:int_l_batchseq,99,'000',
									  :int_l_deliver_qty,:int_l_receive_qty,:l_tot_qty,'G',:chr_l_maker,
									  :chr_l_maker_dt,:chr_l_access_stamp);

		IS_ANY_ORA_ERROR	

	Alert("After  Insert  Trail ");

		EXEC SQL UPDATE dl_dpinstr_hdr SET TOT_NUM_RECORD=TOT_NUM_RECORD - :int_l_zero_qty WHERE batch_no=TO_CHAR(:int_l_batchseq);
		IS_ANY_ORA_ERROR
	Alert("After  update Header ");***/
	
	if(strcmp(chr_p_instr_type,"I")==0)
		{
                        /*Commented below line and Added by Asmeet for ISKB_12434  PMS_ON_MARKET */
			//int_l_deliver_qty=l_tot_qty;
			int_l_deliver_qty=l_int_hdr_qty;
			int_l_deliver_qty_934=l_int_hdr_qty_934;
		}
		else if(strcmp(chr_p_instr_type,"O")==0)	
		{
                         /*Commented below line and Added by Asmeet for ISKB_12434  PMS_ON_MARKET to add seperate batch seq for 934  starts*/
			//int_l_receive_qty=l_tot_qty;
			int_l_receive_qty=l_int_hdr_qty;
			int_l_receive_qty_934=l_int_hdr_qty_934;
		}
		
	
	Alert("INSIDE 934 COUNT IS |%d| :",l_int_cnt_934);
	if(l_int_cnt_934 > 0)
		{
			
			Alert("INSIDE count 934");
			EXEC SQL INSERT INTO
		  	dl_dpinstr_hdr(batch_no,record_type,dp_id,dp_role,status,buy_sell_flg,tot_num_record,
								tot_qty,maker,maker_date,access_stamp)
					  VALUES(:int_l_batchseq_934,01,:chr_p_dp_id,01,'G',DECODE(:chr_p_instr_type,'I','S','O','B'),
								:l_int_cnt_934,:l_int_hdr_qty_934,:chr_l_maker,:chr_l_maker_dt,:chr_l_access_stamp);	
			IS_ANY_ORA_ERROR
		
			EXEC SQL INSERT INTO dl_dpinstr_trail(batch_no,record_type,branch_cd,deliver_qty,receive_qty,
											  tot_qty,status,maker,maker_date,access_stamp)
									VALUES(:int_l_batchseq_934,99,'000',//:g_mt_commonsys_params_struct_h.brnch_cd,
											 :int_l_deliver_qty_934,:int_l_receive_qty_934,:l_int_hdr_qty_934,'G',:chr_l_maker,
											 :chr_l_maker_dt,:chr_l_access_stamp);			
			IS_ANY_ORA_ERROR	
			
			EXEC SQL UPDATE dl_dpinstr_hdr SET tot_num_record=tot_num_record - :int_l_zero_qty_934
								WHERE batch_no=TO_CHAR(:int_l_batchseq_934);
			IS_ANY_ORA_ERROR
			fprintf(g_flogfile,"CLH:No of Zero Quantity Records for 934=|%d| \n",int_l_zero_qty_934);
		/*Added by Asmeet for ISKB_12434  PMS_ON_MARKET to add seperate batch seq for 934 ends*/	
		}
			
			Alert("INSIDE 904 COUNT IS |%d| :",l_int_cnt);
		if(l_int_cnt > 0)
		{		
	
			Alert("INSIDE count 904");
			EXEC SQL INSERT INTO
		  	dl_dpinstr_hdr(batch_no,record_type,dp_id,dp_role,status,buy_sell_flg,tot_num_record,
								tot_qty,maker,maker_date,access_stamp)
					  VALUES(:int_l_batchseq,01,:chr_p_dp_id,01,'G',DECODE(:chr_p_instr_type,'I','S','O','B'),
								:l_int_cnt,:l_int_hdr_qty,:chr_l_maker,:chr_l_maker_dt,:chr_l_access_stamp);
			IS_ANY_ORA_ERROR
		
                      /*Query modified by Asmeet for ISKB_12434  PMS_ON_MARKET*/  
			EXEC SQL INSERT INTO dl_dpinstr_trail(batch_no,record_type,branch_cd,deliver_qty,receive_qty,
														  tot_qty,status,maker,maker_date,access_stamp)
												VALUES(:int_l_batchseq,99,'000',//:g_mt_commonsys_params_struct_h.brnch_cd,
														 :int_l_deliver_qty,:int_l_receive_qty,:l_int_hdr_qty,'G',:chr_l_maker,
														 :chr_l_maker_dt,:chr_l_access_stamp);		
			
		IS_ANY_ORA_ERROR	
	
		EXEC SQL UPDATE dl_dpinstr_hdr SET tot_num_record=tot_num_record - :int_l_zero_qty
							WHERE batch_no=TO_CHAR(:int_l_batchseq);
		IS_ANY_ORA_ERROR
				
		//fprintf(g_flogfile,"CLH:No of Zero Quantity Records=|%d| \n",int_l_zero_qty);	
		}

			
		fprintf(g_flogfile,"DVP:No of Zero Quantity Records=|%d| \n",int_l_zero_qty);	
			
			
 }	
 


/* **************** PROCESSING FOR T2T SEGMENT TRADES (Modified by Asmeet for PMS 12434******************** */
 

/* if(strcmp(chr_p_instr_type,"I")==0 &&  strcmp(chr_p_mkt_type,"22")==0)*/
/***if(strcmp(chr_p_instr_type,"I")==0 && ((strcmp(chr_p_mkt_type,"22")==0 && strcmp(chr_p_exch_code,"NSE")==0) || (strcmp(chr_p_mkt_type,"16")==0 && strcmp(chr_p_exch_code,"BSE")==0 )))
 {
***/	 chr_l_flg='Y';

	fprintf(g_flogfile,"\n DVP RECORDS- T2T: \n PROCESSING FOR T2T SEGMENT TRADES \n");
	Alert("before  DVP T2T Count ");
	
		fprintf(g_flogfile,"DVP T2T :chr_p_instr_type|%s|\n",chr_p_instr_type);	
		fprintf(g_flogfile,"DVP T2T :chr_p_trns_type|%s|\n",chr_p_trns_type);	
		fprintf(g_flogfile,"DVP T2T :chr_p_depository_code|%s|\n",chr_p_depository_code);	
		fprintf(g_flogfile,"DVP T2T :chr_p_depository_code_new|%s|\n",chr_p_depository_code_new);	
		fprintf(g_flogfile,"DVP T2T :chr_p_file_type|%s|\n",chr_p_file_type);	
		fprintf(g_flogfile,"DVP T2T :chr_p_deal_date|%s|\n",chr_p_deal_date);	
		fprintf(g_flogfile,"DVP T2T :chr_p_exch_code|%s|\n",chr_p_exch_code);	
		fprintf(g_flogfile,"DVP T2T :chr_p_settlement_no|%s|\n",chr_p_settlement_no);	
		fprintf(g_flogfile,"DVP T2T :chr_p_mkt_type|%s|\n",chr_p_mkt_type);	
		fprintf(g_flogfile,"DVP T2T :chr_p_dp_id|%s|\n",chr_p_dp_id);	
	
		 EXEC SQL SELECT COUNT(*),NVL(SUM(X.tot_qty),0) INTO :int_l_records:i_int_l_records,:l_tot_qty:i_l_tot_qty
		FROM (SELECT COUNT(*),DECODE(:chr_p_instr_type,'I',NVL(SUM(f.qty),0),'O',NVL(SUM(f.qty),0)) AS tot_qty 
			 FROM Dl_Deal a , mt_instrument c,mt_cli_depo_map d,dl_dpgen_det f
			  WHERE a.client=f.dl_client
			AND a.identiy_no=f.dl_ref_no
			AND NVL(f.gendp_flg,'N')='Y'
			AND a.client=d.cln_code
			AND a.instr_code=c.instr_code
	 	    AND d.cln_depo_code=:chr_p_depository_code_new
	 	AND d.cln_depo_map_dp_id=:chr_p_dp_id
	 	    AND (a.deal_cd = DECODE(:chr_p_instr_type,'I','1','O','2') OR
			  					a.deal_cd = DECODE(:chr_p_instr_type,'I','3','O','4'))
			AND a.exch_code=:chr_p_exch_code
			AND a.settlement_no=:chr_p_settlement_no
			AND (a.mkt_type=DECODE(:chr_p_exch_code,'NSE','22','BSE','16','MCS','03')
			OR a.mkt_type=DECODE(:chr_p_exch_code,'NSE','50','BSE','17','MCS','03'))
			AND TO_CHAR(deal_date,'DD/MM/YYYY')=:chr_p_deal_date
			AND a.clh_flg=:chr_p_trns_type
			AND ( a.deal_stat=DECODE(:chr_p_instr_type,'O','CC','I','MS') OR a.deal_stat=DECODE(:chr_p_instr_type,'O','CC','I','CC'))
			AND a.NDS_BLK_DT is null
			AND ( (f.DP_ID IS NULL) OR (f.DP_ID IS NOT NULL AND f.DP_ID=d.cln_depo_map_dp_id and f.CLIENT_ID = d.cln_depo_map_client_id) )
                        GROUP BY a.client,d.cln_depo_map_client_id,a.instr_code,a.exch_code,
				a.settlement_no,a.mkt_type,a.deal_cd,c.instr_isin,a.setl_date,
				f.broker_cmbpid,f.cp_clnid,f.broker_dpid,f.cp_dpid,a.ex_arena,f.exec_dt,a.dl_class) X;


		  if(int_l_records==0)
		 {
			 fprintf(g_flogfile,"DVP:T2T: NO Records Found For the Given Criteria !!!");
			  chr_l_flg='N';
		  }

		  IS_ANY_ORA_ERROR


	if(chr_l_flg=='Y')
	{

		EXEC SQL SELECT DL_DPINSTRSEQ.NEXTVAL INTO :int_l_batchseq FROM DUAL;
			IS_ANY_ORA_ERROR
			
	/********************** Inserting Header Record **********************/
		
		  printf("T2T batch_no is %d\n",int_l_batchseq);
		  printf("T2T chr_p_dp_id is %s\n",chr_p_dp_id);
		  printf("T2T int_l_records is %d\n",int_l_records);
		  printf("T2T l_tot_qty is %f\n",l_tot_qty);//AIX Warning Removal
		  printf("T2T int_l_batchseq=|%d| \n",int_l_batchseq);
		  printf("T2T chr_l_maker=|%s| \n",chr_l_maker);
		  printf("T2T chr_l_maker_dt=|%s| \n",chr_l_maker_dt);
		  printf("T2T chr_l_access_stamp=|%s| \n",chr_l_access_stamp);

			
	Alert("before Insert DVP Header");

		/*Changed by Narendra Kumar for ISKB_3298 -- Static data change -- change of DP role from 04 to 01 -- Started*/

		/*EXEC SQL INSERT INTO dl_dpinstr_hdr
				(batch_no,record_type,dp_id,dp_role,status,buy_sell_flg,tot_num_record,tot_qty,maker,maker_date,access_stamp)
				 VALUES(:int_l_batchseq,01,:chr_p_dp_id,04,'G',DECODE(:chr_p_instr_type,'I','S','O','B'),
						:int_l_records,:l_tot_qty,:chr_l_maker,:chr_l_maker_dt,:chr_l_access_stamp);*/

		EXEC SQL INSERT INTO dl_dpinstr_hdr
				(batch_no,record_type,dp_id,dp_role,status,buy_sell_flg,tot_num_record,tot_qty,maker,maker_date,access_stamp)
				 VALUES(:int_l_batchseq,01,:chr_p_dp_id,01,'G',DECODE(:chr_p_instr_type,'I','S','O','B'),
						:int_l_records,:l_tot_qty,:chr_l_maker,:chr_l_maker_dt,:chr_l_access_stamp);

		/*Changed by Narendra Kumar for ISKB_3298 -- Static data change -- change of DP role from 04 to 01 -- Ended*/

		IS_ANY_ORA_ERROR
				
		fprintf(g_flogfile,"DVP:T2T:After Inserting Header Record");

		Alert("before Curosr declare DVP T2T");
		 EXEC SQL DECLARE l_cur_gen_dvp_T2T CURSOR FOR	
		 SELECT a.client,d.cln_depo_map_client_id,a.instr_code,a.exch_code,a.mkt_type,a.settlement_no,a.deal_cd,
				DECODE(:chr_p_instr_type,'I',NVL(SUM(f.qty),0),'O',NVL(SUM(f.qty),0)) AS QTY,
				DECODE(a.ex_arena,'2',f.cp_dpid,f.broker_cmbpid) as CMBPID,
				DECODE(a.ex_arena,'2',f.cp_clnid,f.broker_dpid) as DPID,	
				c.instr_isin,
				f.exec_dt,
				a.dl_class,
				a.domestic_cpclt,
				a.deal_date,
				d.cmbp_id
		FROM Dl_Deal a , mt_instrument c,mt_cli_depo_map d,dl_dpgen_det f
			  WHERE a.client=f.dl_client
			AND a.identiy_no=f.dl_ref_no
			AND NVL(f.gendp_flg,'N')='Y'
			AND a.client=d.cln_code
			AND a.instr_code=c.instr_code
	 	   AND d.cln_depo_code=:chr_p_depository_code_new
		   AND d.cln_depo_map_dp_id=:chr_p_dp_id
	 	   AND (a.deal_cd = DECODE(:chr_p_instr_type,'I','1','O','2') OR
			  					a.deal_cd = DECODE(:chr_p_instr_type,'I','3','O','4'))
			AND a.exch_code=:chr_p_exch_code
			AND a.settlement_no=:chr_p_settlement_no
			AND (a.mkt_type=DECODE(:chr_p_exch_code,'NSE','22','BSE','16','MCS','03')
			OR a.mkt_type=DECODE(:chr_p_exch_code,'NSE','50','BSE','17','MCS','03'))
			AND TO_CHAR(deal_date,'DD/MM/YYYY')=:chr_p_deal_date
			AND a.clh_flg=:chr_p_trns_type
			AND ( a.deal_stat=DECODE(:chr_p_instr_type,'O','CC','I','MS') OR a.deal_stat=DECODE(:chr_p_instr_type,'O','CC','I','CC'))
			AND a.NDS_BLK_DT is null
			AND ( (f.DP_ID IS NULL) OR (f.DP_ID IS NOT NULL AND f.DP_ID=d.cln_depo_map_dp_id and f.CLIENT_ID = d.cln_depo_map_client_id) )
		GROUP BY a.ex_arena,a.client,d.cln_depo_map_client_id,a.instr_code,a.exch_code,a.settlement_no,a.mkt_type,a.deal_cd,
			c.instr_isin,a.setl_date,
			f.broker_cmbpid,f.cp_clnid,f.broker_dpid,f.cp_dpid,f.exec_dt,a.dl_class,a.domestic_cpclt,a.deal_date,d.cmbp_id;

	
		Alert("before Curosr Open DVP T2T");
	
		EXEC SQL OPEN l_cur_gen_dvp_T2T;
		IS_ANY_ORA_ERROR
		fflush(g_flogfile);
	   for(;;)
	   {
			memset(l_dl_deal_struct_h, NULL, sizeof(SYS_DL_DEAL_STRUCT_H));
			memset(l_dl_deal_struct_i, NULL, sizeof(SYS_DL_DEAL_STRUCT_I));
			memset(chr_l_refno_str,APL_NULL_CHAR,sizeof(chr_l_refno_str));
			memset(chr_l_cmbp_id,APL_NULL_CHAR,sizeof(chr_l_cmbp_id));
			memset(chr_l_dpid,APL_NULL_CHAR,sizeof(chr_l_dpid));
			memset(chr_l_instr_isin,APL_NULL_CHAR,sizeof(chr_l_instr_isin));
			memset(chr_l_pms_client_cmbp_pid_t2t,APL_NULL_CHAR,sizeof(chr_l_pms_client_cmbp_pid_t2t));

			/* Swapnil for DP Issue */
			memset(chr_l_set_exch_cd, APL_NULL_CHAR, sizeof(chr_l_set_exch_cd));
			memset(chr_l_stl_mkt_type, APL_NULL_CHAR, sizeof(chr_l_stl_mkt_type));
			memset(chr_l_setl_no, APL_NULL_CHAR, sizeof(chr_l_setl_no));			

		Alert("before Curosr fetch DVP T2T");
		EXEC SQL FETCH l_cur_gen_dvp_T2T INTO													:l_dl_deal_struct_h->h_dl_client:l_dl_deal_struct_i->i_dl_client,
												:chr_l_cln_depomap_id:i_cln_depomap_id,	
												:l_dl_deal_struct_h->h_instr_code:l_dl_deal_struct_i->i_instr_code,
												:l_dl_deal_struct_h->h_exch_code:l_dl_deal_struct_i->i_exch_code,
												:l_dl_deal_struct_h->h_mkt_type:l_dl_deal_struct_i->i_mkt_type,	
												:l_dl_deal_struct_h->h_settlement_no:l_dl_deal_struct_i->i_settlement_no,
												:l_dl_deal_struct_h->h_dealcd:l_dl_deal_struct_i->i_dealcd,
												:l_dl_deal_struct_h->h_qty:l_dl_deal_struct_i->i_qty,
												:chr_l_cmbp_id:i_cmbp_id,
												:chr_l_dpid:i_dpid,
												:chr_l_instr_isin:i_instr_isin,
												:l_dl_deal_struct_h->h_setldt:l_dl_deal_struct_i->i_setldt,
												:chr_l_dl_class:i_dl_class,
												:l_dl_deal_struct_h->h_domcpclt_cd:l_dl_deal_struct_i->i_domcpclt_cd,
												:l_dl_deal_struct_h->h_dlt:l_dl_deal_struct_i->i_dlt,
												:chr_l_pms_client_cmbp_pid_t2t:i_pms_client_cmbpid_t2t;
			if(APL_ZERO_RESULT_SET)
		    {
			
			 if(counter2==0)
			  {
					fprintf(g_flogfile,"No Records Found In l_cur_gen_dvp_T2T CURSOR !!!" );
			  }
	 		  break;
		    }
		  	IS_ANY_ORA_ERROR

			counter2++;
		Alert("After Curosr fetch DVP T2T");
			

			sprintf(chr_l_internal_ref_no,"%d%d",int_l_batchseq,counter2);
			strcpy(chr_l_send_refno1,chr_l_internal_ref_no);

			sprintf(chr_g_log_buffer,"DVP:T2T Internal Ref No=|%s|",chr_l_internal_ref_no);	
			fprintf(g_flogfile,"%s",chr_g_log_buffer);


		 EXEC SQL SELECT :l_dl_deal_struct_h->h_dealcd INTO :chr_p_instr_type_new
								FROM dual;
		 
		 IS_ANY_ORA_ERROR 
		// IB_12174 start
			Alert("\n  Swapnil for Mkt_Type_22 issue chr_p_instr_type = |%s|",chr_p_instr_type);		
		if(strcmp(chr_p_instr_type,"I")==0 )
		{
			Alert("\n 1 Swapnil for Mkt_Type_22 issue : chr_l_set_exch_cd = |%s|",chr_l_set_exch_cd);
			Alert("\n 1 Swapnil for Mkt_Type_22 issue : PTY_CODE = |%s|",l_dl_deal_struct_h->h_domcpclt_cd);
			
                   EXEC SQL SELECT SET_EXCH_CODE INTO :chr_l_set_exch_cd:i_set_exch_cd
		   FROM MT_PARTY WHERE PTY_CODE=:l_dl_deal_struct_h->h_domcpclt_cd;
		
		   IS_ANY_ORA_ERROR

			Alert("\n 2 Swapnil for Mkt_Type_22 issue : chr_l_stl_mkt_type = |%s|",chr_l_stl_mkt_type);		   
			Alert("\n 2 Swapnil for Mkt_Type_22 issue : chr_l_set_exch_cd = |%s|",chr_l_set_exch_cd);
			Alert("\n 2 Swapnil for Mkt_Type_22 issue : TRD_MKT_TYPE = |%s|",l_dl_deal_struct_h->h_mkt_type);
			Alert("\n 2 Swapnil for Mkt_Type_22 issue : TRD_EXCH = |%s|",l_dl_deal_struct_h->h_exch_code);
			Alert("\n 2 Swapnil for Mkt_Type_22 issue : sqlca.sqlcode = |%d|",sqlca.sqlcode);			
		   
		   EXEC SQL SELECT SETT_MKT_TYPE  INTO :chr_l_stl_mkt_type:i_stl_mkt_type FROM STATIC_TRAD_SETT_EXCH
							WHERE TRD_MKT_TYPE = :l_dl_deal_struct_h->h_mkt_type
							AND TRD_EXCH = :l_dl_deal_struct_h->h_exch_code
							AND  SETT_EXCH      = decode(:chr_l_set_exch_cd,'NSCCL','NSE','ICCL','BSE');
							printf("\n asmeet8 \n");
		IS_ANY_ORA_ERROR

			Alert("\n 3 Swapnil for Mkt_Type_22 issue : chr_l_setl_no = |%s|",chr_l_setl_no);	
			Alert("\n 3 Swapnil for Mkt_Type_22 issue : chr_l_stl_mkt_type = |%s|",chr_l_stl_mkt_type);	
			Alert("\n 3 Swapnil for Mkt_Type_22 issue : START_DATE = |%s|",l_dl_deal_struct_h->h_dlt);	
			Alert("\n 3 Swapnil for Mkt_Type_22 issue : sqlca.sqlcode = |%d|",sqlca.sqlcode);			
		
		EXEC SQL SELECT SETTL_NO INTO :chr_l_setl_no:i_setl_no from mt_settl_cal a where EXCH_CODE = decode(:chr_l_set_exch_cd,'NSCCL','NSE','ICCL','BSE')
			AND settl_type = :chr_l_stl_mkt_type 
			AND START_DATE =to_date(:l_dl_deal_struct_h->h_dlt,'dd/MM/yyyy hh24:mi:ss');
			
			Alert("\n 4 Swapnil for Mkt_Type_22 issue : chr_l_setl_no = |%s|",chr_l_setl_no);
			Alert("\n 4 Swapnil for Mkt_Type_22 issue : h_settlement_no = |%s|",l_dl_deal_struct_h->h_settlement_no);
			Alert("\n 4 Swapnil for Mkt_Type_22 issue : sqlca.sqlcode = |%d|",sqlca.sqlcode);			
			
			if ((!strlen(chr_l_stl_mkt_type) || !strlen(chr_l_setl_no)))
			{
			Alert("\n asmeet99999999999999999999 \n");
				strcpy(chr_l_stl_mkt_type,l_dl_deal_struct_h->h_mkt_type);
				strcpy(chr_l_setl_no,l_dl_deal_struct_h->h_settlement_no);
			}
		Alert("chr_l_set_exch_cd:==|%s|, chr_l_stl_mkt_type==|%s|,chr_l_setl_no==|%s|,domestic_cpclt=|%s|,deal_date==|%s|",chr_l_set_exch_cd,chr_l_stl_mkt_type,chr_l_setl_no,l_dl_deal_struct_h->h_domcpclt_cd,l_dl_deal_struct_h->h_dlt);	
			IS_ANY_ORA_ERROR
		}
		  // IB_12174 End
			Alert("\n 5 Swapnil for Mkt_Type_22 issue ");

		 /* Commented and added below by Asmeet for T2T ON mkt PMS iskb 12434
		 strcpy(chr_l_identiy_t2t,l_dl_deal_struct_h->h_indentity_no);
		 strcat(chr_l_identiy_t2t,",");
	
		sprintf(chr_g_log_buffer,"DVP:T2T:********DEAL CD=|%c| chr_l_identiy_t2t=|%s|********\n ",chr_p_instr_type_new,chr_l_identiy_t2t);
		fprintf(g_flogfile,"%s",chr_g_log_buffer);
		*/
		
		if(strcmp(l_dl_deal_struct_h->h_dealcd,"1")==0 || strcmp(l_dl_deal_struct_h->h_dealcd,"3")==0)
		{
			strcpy(chr_l_instruction_type,"904");
			

		}
		else if(strcmp(l_dl_deal_struct_h->h_dealcd,"2")==0 || strcmp(l_dl_deal_struct_h->h_dealcd,"4")==0)
		{
			strcpy(chr_l_instruction_type,"905");
			
		}


		/*	********************   Start Retriving IDENTIY_NO from dl_deal table for T2T by Asmeet *************** */
			printf("\n CLIENT T2T=|%s| \n",l_dl_deal_struct_h->h_dl_client);
		
		EXEC SQL DECLARE l_cur_upd_dpm_dvp_t2t_i CURSOR FOR
				SELECT identiy_no
				FROM Dl_Deal a ,mt_instrument c,mt_cli_depo_map d,dl_dpgen_det f
				where a.client=d.cln_code
				and  a.client=:l_dl_deal_struct_h->h_dl_client
				 and a.instr_code=c.instr_code
				 and a.instr_code=:l_dl_deal_struct_h->h_instr_code
				 and a.identiy_no=f.dl_ref_no
				 AND a.client=f.dl_client
				 AND NVL(f.gendp_flg,'N')='Y'
				 AND a.exch_code=:l_dl_deal_struct_h->h_exch_code
				 AND a.settlement_no=:l_dl_deal_struct_h->h_settlement_no
				 AND (a.mkt_type=DECODE(a.exch_code,'NSE','22','BSE','16','MCS','03')
				 OR a.mkt_type=DECODE(a.exch_code,'NSE','50','BSE','17','MCS','03'))
				 AND to_char(deal_date,'DD/MM/YYYY')=:chr_p_deal_date
				 AND (a.deal_cd = DECODE(:chr_p_instr_type,'I','1','O','2') OR
					 		a.deal_cd = DECODE(:chr_p_instr_type,'I','3','O','4'))	 
				 AND  d.CLN_DEPO_CODE=:chr_p_depository_code_new
			 	 AND  d.CLN_DEPO_MAP_DP_ID=:chr_p_dp_id
				 AND a.clh_flg=:chr_p_trns_type
				AND ( a.deal_stat=DECODE(:chr_p_instr_type,'I','MS','O','CC') or a.deal_stat=DECODE(:chr_p_instr_type,'I','CC','O','CC'))
				 AND DECODE(a.ex_arena,'2',f.cp_dpid,f.broker_cmbpid)=:chr_l_cmbp_id
				 AND DECODE(a.ex_arena,'2',f.cp_clnid,f.broker_dpid)=:chr_l_dpid	
				 AND a.NDS_BLK_DT is null;	 
		
		EXEC SQL OPEN l_cur_upd_dpm_dvp_t2t_i;
		IS_ANY_ORA_ERROR
		
		Alert("After Inner Cursor T2T Declare  ");
		
		for(;;)
	   {
		Alert("Before Inner Cursor T2T fetch  ");
		
			EXEC SQL FETCH l_cur_upd_dpm_dvp_t2t_i INTO :chr_l_identiy_t2t;
		
		Alert("After Inner Cursor T2T fetch  ");
 
		  if(APL_ZERO_RESULT_SET)
		  {
			 if(counter2==0)
			  {
					fprintf(g_flogfile,"No Records Found in l_cur_upd_dpm_dvp_t2t_i CURSOR!" );
			  }
			 break;

		  }
		  	IS_ANY_ORA_ERROR

		  if(l_dl_deal_struct_h->h_qty > 0)
		  {
			printf("\n [DVP:T2T] Updating DP Generation Date for Account|%s|, RefNo|%s| with Date |%s|..",l_dl_deal_struct_h->h_dl_client,chr_l_identiy_t2t,chr_l_maker_dt);

			 fprintf(g_flogfile,"\n [DVP:T2T] Updating DP Generation Date for Account|%s|, RefNo|%s| with Date |%s|",l_dl_deal_struct_h->h_dl_client,chr_l_identiy_t2t,chr_l_maker_dt);
			
			EXEC SQL UPDATE DL_DEAL SET NDS_BLK_DT=:chr_l_maker_dt WHERE
			identiy_no = :chr_l_identiy_t2t AND
			client=:l_dl_deal_struct_h->h_dl_client;
			if(sqlca.sqlcode)
			{
				fprintf(g_flogfile,"DVP:Error Updating NDS_BLK_DT ORA|%d|\n",sqlca.sqlcode);
			}
		  	IS_ANY_ORA_ERROR
	Alert("After Update T2T DL_DEAL ");

			printf("\n T2T STRING counter2=|%d| \n",counter2);

/*			strcat(chr_l_refno_str,"'");	*/
			strcat(chr_l_refno_str,chr_l_identiy_t2t);
			strcat(chr_l_refno_str,",");

		  }
	
	  }
	  
	  EXEC SQL CLOSE l_cur_upd_dpm_dvp_t2t_i;
	  
		IS_ANY_ORA_ERROR
		Alert("After Inner Cursor Close ");
	  
		printf("\n T2T DVP: REF_STRING=|%s|\n",chr_l_refno_str);
		fprintf(g_flogfile,"\n T2T Deal String is=|%s|",chr_l_refno_str); 
		
		 if(strcmp(chr_p_instr_type,"I")==0 && (strcmp(chr_l_pms_client_cmbp_pid_t2t,APL_NULL_STRING)==0))
	  {
		 strcpy(chr_l_pms_cmbpid_t2t,chr_l_cmbp_id); 
		 strcpy(chr_l_client_cpid_t2t,APL_NULL_STRING);
		  
	  }
	 else
	 {
		strcpy(chr_l_pms_cmbpid_t2t,APL_NULL_STRING);
		strcpy(chr_l_client_cpid_t2t,chr_l_cmbp_id); 
	 }
		/*	********************   Start Retriving IDENTIY_NO from dl_deal table for T2T by Asmeet *************** */
		
		

		sprintf(chr_g_log_buffer," \n DVP: FETCHED VALUES ARE: \n chr_l_cln_depomap_id=|%s|\n QTY=|%lf|\n EXCH_CODE=|%s| \n SETTLEMENT_NO=|%s| \n MKT_TYPE|%s| \n ISIN=|%s| CMBP_ID=|%s| Internal REEFNO=|%s|\n DEPOSITORY=|%s| \n",
								chr_l_cln_depomap_id,l_dl_deal_struct_h->h_qty,
								chr_p_exch_code,l_dl_deal_struct_h->h_settlement_no,l_dl_deal_struct_h->h_mkt_type,
								chr_l_instr_isin,chr_l_cmbp_id,chr_l_internal_ref_no,chr_p_depository_code_new);

	
		fprintf(g_flogfile,"%s",chr_g_log_buffer);
		
			printf("\n ************** : Batch NO for DVP T2T  **************|%d| \n",int_l_batchseq);
			sprintf(chr_g_log_buffer,"\n **************  Batch NO for DVP T2T **************|%d| \n",int_l_batchseq);
			fprintf(g_flogfile,"%s",chr_g_log_buffer);
		
		if(l_dl_deal_struct_h->h_qty > 0)
		{	
			if(!strcmp(l_dl_deal_struct_h->h_mkt_type,"16") && !strcmp(l_dl_deal_struct_h->h_exch_code,"BSE"))
			{
					strcpy(l_dl_deal_struct_h->h_mkt_type,"5");
			}
		
			EXEC SQL INSERT INTO DL_DPINSTRS
			(batch_no,serial_no,trans_type,client,instr_code,qty,exch_code,mkt_type,settlement_no,setl_date,isin_cd,
			clh_dvp,cmbp_id,dpm_trans_no,rev_flg,other_branch_cd,other_client_id,other_mkt_type,
			other_stlmnt_no,internal_ref_no,send_ref_1,send_ref_2,maker,maker_date,checker,checker_date,
			access_stamp,status,depo_ind,deal_ref_nos,deal_cd,other_dp_id,client_code)
			VALUES(:int_l_batchseq,:counter2,:chr_l_instruction_type,:chr_l_cln_depomap_id,:l_dl_deal_struct_h->h_instr_code,
				:l_dl_deal_struct_h->h_qty,:chr_p_exch_code,:l_dl_deal_struct_h->h_mkt_type,:l_dl_deal_struct_h->h_settlement_no,
			   :l_dl_deal_struct_h->h_setldt,:chr_l_instr_isin,'D',:chr_l_pms_cmbpid_t2t,NULL,NULL,NULL,:chr_l_client_cpid_t2t,:chr_l_stl_mkt_type,:chr_l_setl_no,:chr_l_internal_ref_no,
			   :chr_l_send_refno1,NULL,:chr_l_maker,:chr_l_maker_dt,NULL,NULL,:chr_l_access_stamp,'G',
			   :chr_p_depository_code_new,:chr_l_refno_str,:l_dl_deal_struct_h->h_dealcd,:chr_l_dpid,:l_dl_deal_struct_h->h_dl_client);

			IS_ANY_ORA_ERROR
		Alert("After DPINSTR Insert DVP T2T");

	
		}
		else if(l_dl_deal_struct_h->h_qty ==  0)
		{
			counter2--; //Added by Prateek on 30092014 for ISKB_6847(Serial number is coming wrong in Handoff file)
			int_l_zero_qty++;
			sprintf(chr_g_log_buffer,"DVP:T2T:ZERO QUANTITY FOR Client=|%s| Instrument=|%s| \n",l_dl_deal_struct_h->h_dl_client,l_dl_deal_struct_h->h_instr_code);
			fprintf(g_flogfile,"%s",chr_g_log_buffer);
		}
			strcpy(chr_l_refno_str,APL_NULL_STRING);
	 }
	
	   EXEC SQL CLOSE l_cur_gen_dvp_T2T;
		IS_ANY_ORA_ERROR

		Alert("After cursor close DVP T2T");
		
		if(strcmp(chr_p_instr_type,"I")==0)
		{
			int_l_deliver_qty=l_tot_qty;
		}
		else if(strcmp(chr_p_instr_type,"O")==0)	
		{
			int_l_receive_qty=l_tot_qty;
		}
			
		
		EXEC SQL INSERT INTO
	  			dl_dpinstr_trail(batch_no,record_type,branch_cd,deliver_qty,receive_qty,										  											tot_qty,status,maker,maker_date,access_stamp)
							 VALUES(:int_l_batchseq,99,'000',//:g_mt_commonsys_params_struct_h.brnch_cd,
									  :int_l_deliver_qty,:int_l_receive_qty,:l_tot_qty,'G',:chr_l_maker,
									  :chr_l_maker_dt,:chr_l_access_stamp);

		IS_ANY_ORA_ERROR	
		
		EXEC SQL UPDATE dl_dpinstr_hdr SET TOT_NUM_RECORD=TOT_NUM_RECORD - :int_l_zero_qty
	  				WHERE batch_no=TO_CHAR(:int_l_batchseq);
		IS_ANY_ORA_ERROR										
		
		
		fprintf(g_flogfile,"DVP:T2T:No of Zero Quantity Records=|%d| \n",int_l_zero_qty);	
			
	} 	/* **** IF(chr_l_flg== 'Y') Ends **** */

/*** }
***/




/*
	EXEC SQL DECLARE l_cur_clh_qty2 CURSOR FOR
		SELECT a.instr_code,A.purchase_qty,B.sale_qty
		FROM 
		(SELECT instr_code,SUM(qty) as purchase_qty FROM dl_deal
			WHERE deal_cd in('2','4')
			AND exch_code=:chr_p_exch_code
			AND settlement_no=:chr_p_settlement_no
			AND mkt_type=:chr_p_mkt_type
			AND a.mkt_type!=DECODE(a.exch_code,'NSE','22','BSE','16')
			AND clh_flg='C'
			AND :chr_p_instr_type='I'
         GROUP BY instr_code) a,
		(SELECT instr_code,SUM(qty) as sale_qty  from dl_deal
		  WHERE deal_cd in('1','3') 
		  AND exch_code=:chr_p_exch_code
		  AND settlement_no=:chr_p_settlement_no
		  AND mkt_type=:chr_p_mkt_type
		  AND a.mkt_type!=DECODE(a.exch_code,'NSE','22','BSE','16')
		  AND clh_flg='C'
		  AND :chr_p_instr_type='I'
		GROUP BY instr_code)b
	WHERE a.instr_code=b.instr_code;


 EXEC SQL OPEN l_cur_clh_qty2;
 IS_ANY_ORA_ERROR

	   for(;;)
	   {

		EXEC SQL FETCH l_cur_clh_qty2 INTO :l_chr_instr_code,:l_int_purchasesum:i_purchasesum,l_int_salesum:i_salesum;

		if(APL_ZERO_RESULT_SET)
		    {

			 if(counter2==0)
			  {		
			  		fprintf(g_flogfile,"No Records Found in l_cur_clh_qty2 CURSOR!");
			  }
			 break;

		    }
		  	IS_ANY_ORA_ERROR

			counter2++;


			if(l_int_salesum > l_int_purchasesum)
		    {

				l_int_net_amt=l_int_salesum-l_int_purchasesum;

				EXEC SQL INSERT INTO dl_clh_qty
				(batch_no,serial_no,instr_code,clh_qty,maker,maker_date,checker,checker_date,access_stamp)
				VALUES
				(:int_l_batchseq,:counter2,:l_chr_instr_code,:l_int_net_amt,:chr_l_maker,:chr_l_maker_dt,NULL,NULL,NULL);

				
			   if(sqlca.sqlcode)
			   {
					printf("\n Error inserting CLH_QTY into dl_dpinstrs |%d|",sqlca.sqlcode);
			   }
			
			   IS_ANY_ORA_ERROR

			}

			printf("counter2=|%d| \n",counter2);


	   }

	EXEC SQL CLOSE l_cur_clh_qty2;
	IS_ANY_ORA_ERROR

*/
/* ******************************************************************************* */


		APL_GOBACK_SUCCESS							

		  RETURN_SUCCESS:
		  {
			CO_ProcMonitor(g_flogfile," Leaving Proc_GenDVP_Instrn With Success",NULL,NULL);
			return(APL_SUCCESS);
		  }
		   
		  RETURN_FAILURE:
		 {
		   printf("\n Error Inside Proc_GenDVP_Instrn:ORA|%d|\n",sqlca.sqlcode);
		   sprintf(chr_g_log_buffer,"Leaving Proc_GenDVP_Instrn With Failure ORA|%d|\n",sqlca.sqlcode);	
		   CO_ProcMonitor(g_flogfile,chr_g_log_buffer,l_debug_info_ptr,NULL);
		   return(APL_FAILURE);	
		 }

  }	/*********** END DVP FUNCTION ****************/



/* *********** START INTER DEPOSITORY FUNCTION ************ */



 int Proc_GenInterDP_CLH_Instrn(char *chr_p_instr_type,
						  char *chr_p_trns_type,
						  char *chr_p_depository_code,
						  char *chr_p_file_type,
						  char *chr_p_deal_date,
						  char *chr_p_exch_code,
						  char *chr_p_settlement_no,
						  char *chr_p_mkt_type,
						  char *chr_p_dp_id,
						  char *chr_p_user,
						  FILE *g_flogfile,
						  INTL_ENV_DATA_STRUCT_H *l_intl_env_data_h,
						  DEBUG_INFO_STRUCT_H **l_debug_info_ptr)
  {

	FILE  *l_ptr_ini_file = NULL;
	FILE  *l_ptr_handoff_file = NULL;
	char  chr_g_log_buffer[BUFFER_LEN] = APL_NULL_STRING;
	char  chr_l_inifile[100]= APL_NULL_STRING;
	char  chr_l_handoff_dir[PATH_LENGTH]= APL_NULL_STRING;
    char  chr_l_handoff_file_name[FILENAME_LEN_A]= APL_NULL_STRING;	
	char  chr_l_header[100]= APL_NULL_STRING;
	char  chr_l_trailer[200]= APL_NULL_STRING;
	char  chr_l_detail_rec[1000] =APL_NULL_STRING;
	int   int_l_batchseq=0;
	int   counter=0;
	char  chr_l_instr_isin[13]= APL_NULL_STRING;
	char  chr_l_oth_cmbpid[29]= APL_NULL_STRING;
	char  chr_l_oth_setlno[8]= APL_NULL_STRING;
	char  chr_l_oth_mkt_type[3]= APL_NULL_STRING;
	char  chr_l_remark[21]= APL_NULL_STRING;
	/* char  chr_l_send_refno1[36]= APL_NULL_STRING;
	char  chr_l_send_refno2[36]= APL_NULL_STRING; 
	** Modified For ISKB_3298 Changes - Jun2010 - Naren V */
	char  chr_l_send_refno1[51]= APL_NULL_STRING;
	char  chr_l_send_refno2[51]= APL_NULL_STRING; 
	char  chr_l_depo_part_code[21]=APL_NULL_STRING;
	char chr_l_cmbp_id[29]=APL_NULL_STRING;
	int int_l_len=0;
 	char  chr_p_depository_code_new[5]= APL_NULL_STRING;
    char  chr_p_instr_type_new;
	int int_l_records=0;
	short i_int_l_records=0;
	char chr_l_dprole[3]= APL_NULL_STRING;
	char  chr_l_user[APL_USERID_LEN] = APL_NULL_STRING;
	char  pro_sys_date[APL_DATE_LEN] = APL_NULL_STRING;
	char chr_l_maker[APL_USERID_LEN] = APL_NULL_STRING;
	char  chr_l_maker_dt[APL_DATE_LEN] = APL_NULL_STRING;
	char  chr_l_access_stamp[APL_DATE_LEN] = APL_NULL_STRING;
	/* char  chr_l_internal_ref_no[21] = APL_NULL_STRING;
	** Modified For ISKB_3298 Changes - Jun2010 - Naren V */
	char  chr_l_internal_ref_no[36] = APL_NULL_STRING;
	char chr_l_settlement_dt[20] = APL_NULL_STRING;
	short i_settlement_dt=0;
	char chr_l_instruction_type[4] = APL_NULL_STRING;
	double l_tot_qty=0.0;
	short i_l_tot_qty=0;
	short i_depo_part_code=0;
	char chr_l_identiy_no[17]= APL_NULL_STRING;
	char chr_l_refno_str[4001]= APL_NULL_STRING;
	int   counter1=0;
	double l_int_purchasesum=0.0;
	double l_int_salesum=0.0;
	double l_int_net_amt=0.0;
	char l_chr_instr_code[9]= APL_NULL_STRING;
	char chr_l_cln_dpid[21]= APL_NULL_STRING;
	char chr_l_cln_depomap_id[21]= APL_NULL_STRING;
	char chr_l_flg='Y';
	char chr_l_identiy_t2t[18]= APL_NULL_STRING;
	char chr_l_other_client_id[14]= APL_NULL_STRING;
	double int_l_deliver_qty=0.0;
	double int_l_receive_qty=0.0;
	int int_l_zero_qty=0;
	char chr_l_pool_depo[5]=APL_NULL_STRING;
	char chr_l_other_dpid[21]=APL_NULL_STRING;
	char chr_l_batchseq[APL_DP_BATCH_NO_LEN]=APL_NULL_STRING;
	char chr_l_other_client_id1[14]=APL_NULL_STRING;
	char chr_l_rev_flg[2]=APL_NULL_STRING;
	char chr_l_dl_class[DL_DL_CLASS_LEN]=APL_NULL_STRING;
	
		
	short i_purchasesum=0;
	short i_salesum=0;
	short i_cln_dpid=0;
	short i_cln_depomap_id=0;
	short i_cmbp_id=0;
	short i_other_client_id=0;
	short i_instr_isin=0;
	short i_other_dpid=0;
	short i_pool_depo=0;
	short i_other_client_id1=0;
	short i_dl_class=0;
	
	SYS_DL_DEAL_STRUCT_H  *l_dl_deal_struct_h = NULL;
    SYS_DL_DEAL_STRUCT_I  *l_dl_deal_struct_i = NULL;	
		
	
	
	l_dl_deal_struct_h=(SYS_DL_DEAL_STRUCT_H *)calloc(1,sizeof(SYS_DL_DEAL_STRUCT_H));
	APL_MALLOC_FAIL(l_dl_deal_struct_h)
	l_dl_deal_struct_i=(SYS_DL_DEAL_STRUCT_I *)calloc(1,sizeof(SYS_DL_DEAL_STRUCT_I));
	APL_MALLOC_FAIL(l_dl_deal_struct_i)

	memset(l_dl_deal_struct_h, NULL, sizeof(SYS_DL_DEAL_STRUCT_H));
	memset(l_dl_deal_struct_i, 0, sizeof(SYS_DL_DEAL_STRUCT_I));
		memset(chr_g_log_buffer,APL_NULL_CHAR,BUFFER_LEN);

	EXEC SQL BEGIN DECLARE SECTION;


		EXEC SQL VAR chr_p_depository_code_new IS STRING;		
		EXEC SQL VAR chr_l_header IS STRING;
		EXEC SQL VAR chr_l_trailer IS STRING;
		EXEC SQL VAR chr_l_instruction_type IS STRING;
		EXEC SQL VAR chr_l_depo_part_code IS STRING;	
		EXEC SQL VAR chr_l_instr_isin IS STRING;
		EXEC SQL VAR chr_l_maker IS STRING;
		EXEC SQL VAR chr_l_maker_dt IS STRING;
		EXEC SQL VAR chr_l_access_stamp IS STRING;
		EXEC SQL VAR chr_l_settlement_dt IS STRING;
		EXEC SQL VAR chr_l_identiy_no IS STRING;
		EXEC SQL VAR chr_l_cln_dpid IS STRING;
		EXEC SQL VAR chr_l_cln_depomap_id IS STRING;
		EXEC SQL VAR chr_l_identiy_t2t IS STRING;
		EXEC SQL VAR chr_l_cmbp_id IS STRING;
		EXEC SQL VAR chr_l_pool_depo IS STRING;
		EXEC SQL VAR chr_l_other_dpid IS STRING;
		EXEC SQL VAR chr_l_other_client_id1 IS STRING;
		EXEC SQL VAR chr_l_dl_class IS STRING;
		
	EXEC SQL END DECLARE SECTION;
	

		  strcpy(chr_l_maker,chr_p_user);

		  if (  CO_RtvSysDt(pro_sys_date,l_debug_info_ptr) == APL_FAILURE )
		  {
            APL_GOBACK_FAIL
		  }
		  strcpy(chr_l_maker_dt,pro_sys_date);
		

		 if (  CO_RtvSysDtTime(pro_sys_date,l_debug_info_ptr) == APL_FAILURE )
         {
			 APL_GOBACK_FAIL
		 }
		 strcpy(chr_l_access_stamp,pro_sys_date);

		
	 	fprintf(g_flogfile,"InterDP:Inside Function Values Are .... \n");	 
		 
		fprintf(g_flogfile,"InterDP:chr_p_instr_type|%s|\n",chr_p_instr_type);	
		fprintf(g_flogfile,"InterDP:chr_p_trns_type|%s|\n",chr_p_trns_type);	
		fprintf(g_flogfile,"InterDP:chr_p_depository_code|%s|\n",chr_p_depository_code);	
		fprintf(g_flogfile,"InterDP:chr_p_file_type|%s|\n",chr_p_file_type);	
		fprintf(g_flogfile,"InterDP:chr_p_deal_date|%s|\n",chr_p_deal_date);	
		fprintf(g_flogfile,"InterDP:chr_p_exch_code|%s|\n",chr_p_exch_code);	
		fprintf(g_flogfile,"InterDP:chr_p_settlement_no|%s|\n",chr_p_settlement_no);	
		fprintf(g_flogfile,"InterDP:chr_p_mkt_type|%s|\n",chr_p_mkt_type);	
		fprintf(g_flogfile,"InterDP:chr_p_dp_id|%s|\n",chr_p_dp_id);

		 
		EXEC SQL SELECT DECODE(:chr_p_depository_code,'N','NSDL','C','CDSL')
						INTO :chr_p_depository_code_new FROM dual;
		IS_ANY_ORA_ERROR


	/* CHANGES MADE FOR SLB - AMISH - 27/03/2008 */
	if(((strcmp(chr_p_exch_code,"NSE")==0) && (strcmp(chr_p_mkt_type,"23")==0 || strcmp(chr_p_mkt_type,"23")==0 || strcmp(chr_p_mkt_type,"23")==0))
		|| 
	   ((strcmp(chr_p_exch_code,"BSE")==0) && (strcmp(chr_p_mkt_type,"18")==0 || strcmp(chr_p_mkt_type,"19")==0 || strcmp(chr_p_mkt_type,"20")==0))
	   ||
	   ((strcmp(chr_p_exch_code,"MCS")==0) && (strcmp(chr_p_mkt_type,"63")==0 || strcmp(chr_p_mkt_type,"64")==0 || strcmp(chr_p_mkt_type,"65")==0))
	  )
	 {
		chr_l_flg='N';
		fprintf(g_flogfile,"SLB TRANSACTION ..SO PROCESSING SHOULD BE LIKE T2T TRANSACTIONS \n");	

	 }

		 fprintf(g_flogfile,"NOT A SLB TRANSACTION \n");	
	if(chr_l_flg== 'Y')
	 {
EXEC SQL SELECT COUNT(*),NVL(SUM(X.tot_qty),0)INTO :int_l_records:i_int_l_records,:l_tot_qty:i_l_tot_qty
	 	 FROM (SELECT COUNT(*),NVL(SUM(a.allot_qty),0) as tot_qty 
		   FROM Dl_Deal a ,mt_instrument c,mt_cli_depo_map d,mt_exch_depo e,dl_markshortage f
			WHERE a.client=d.cln_code
	 	    AND d.cln_depo_code=:chr_p_depository_code_new
	 	    AND f.depo_code!=:chr_p_depository_code_new
			AND a.instr_code=c.instr_code
			AND TO_CHAR(a.deal_date,'DD/MM/YYYY')=:chr_p_deal_date
			AND a.exch_code=:chr_p_exch_code
			AND e.exch_code=a.exch_code
			AND a.mkt_type=:chr_p_mkt_type
			AND ((a.mkt_type!= DECODE(a.exch_code,'NSE','22','BSE','16','MCS','03')) AND (a.mkt_type!= DECODE(a.exch_code,'NSE','50','BSE','17','MCS','24'))) /*Added by PT MCS*/
			AND a.settlement_no=:chr_p_settlement_no
			AND a.clh_flg=:chr_p_trns_type
			AND e.dp_id=:chr_p_dp_id
			AND e.depo_code=:chr_p_depository_code_new
			AND a.client=f.dl_client
			AND a.identiy_no=f.dl_ref_no
			AND NVL(f.pool_trans,'N')='Y'
			AND a.deal_cd IN('2','4')
			AND ( a.deal_stat=DECODE(:chr_p_instr_type,'I','CC','O','MS') OR a.deal_stat=DECODE(:chr_p_instr_type,'I','CC','O','CC'))
/*			AND a.deal_stat='CC'
*/			AND a.NDS_BLK_DT is null
		  GROUP BY  a.client,d.cln_depo_map_client_id,a.instr_code,a.exch_code,a.settlement_no,a.mkt_type,a.deal_cd,
					c.instr_isin,a.setl_date,cln_depo_map_dp_id,e.cm_cc_id,e.cln_id,f.depo_code,a.dl_class) X;
		  
			IS_ANY_ORA_ERROR	
		
		  if(int_l_records == 0)
		  {
			  fprintf(g_flogfile," InterDP:NO Records Found For The Given Criteria !!! \n");
			  chr_l_flg='N';
		  }
	  	 IS_ANY_ORA_ERROR

		 printf("\n No Of InterDP:CLH Records|%d| \n",int_l_records);
		 sprintf(chr_g_log_buffer,"\n No Of InterDP:CLH Records|%d| \n",int_l_records);
		 fprintf(g_flogfile,"%s",chr_g_log_buffer);

	 } 	/* CHANGES MADE FOR SLB - AMISH - 27/03/2008 */
	  if(chr_l_flg== 'Y')
	  {
		EXEC SQL SELECT DL_DPINSTRSEQ.NEXTVAL INTO :int_l_batchseq FROM DUAL;
		IS_ANY_ORA_ERROR
		
		strcpy(chr_l_batchseq,"I");
		strcat(chr_l_batchseq,(char*)ltoa(int_l_batchseq));

/********************** Inserting Header Record **********************/
	
		/*Changed by Narendra Kumar for ISKB_3298 -- Static data change -- change of DP role from 04 to 01 -- Started*/

		/*EXEC SQL INSERT INTO
		  	dl_dpinstr_hdr(batch_no,record_type,dp_id,dp_role,status,buy_sell_flg,tot_num_record,
								tot_qty,maker,maker_date,access_stamp)
					  VALUES(:chr_l_batchseq,01,:chr_p_dp_id,04,'G','B',
								:int_l_records,:l_tot_qty,:chr_l_maker,:chr_l_maker_dt,:chr_l_access_stamp);*/
		
		EXEC SQL INSERT INTO
		  	dl_dpinstr_hdr(batch_no,record_type,dp_id,dp_role,status,buy_sell_flg,tot_num_record,
								tot_qty,maker,maker_date,access_stamp)
					  VALUES(:chr_l_batchseq,01,:chr_p_dp_id,01,'G','B',
								:int_l_records,:l_tot_qty,:chr_l_maker,:chr_l_maker_dt,:chr_l_access_stamp);

		/*Changed by Narendra Kumar for ISKB_3298 -- Static data change -- change of DP role from 04 to 01 -- Ended*/

		IS_ANY_ORA_ERROR
		
		fprintf(g_flogfile,"InterDP Cursor:After Inserting Header Record");


	 EXEC SQL DECLARE l_cur_clh_interdp_instr CURSOR FOR
		SELECT a.client,d.cln_depo_map_client_id,a.instr_code,a.exch_code,a.mkt_type,a.settlement_no,a.deal_cd,
			   NVL(SUM(a.allot_qty),0),
			   c.instr_isin,setl_date,d.cln_depo_map_dp_id,e.cm_cc_id,e.cln_id,f.depo_code,a.dl_class
		FROM Dl_Deal a ,mt_instrument c,mt_cli_depo_map d,mt_exch_depo e,dl_markshortage f
			WHERE a.client=d.cln_code
	 	   AND d.cln_depo_code=:chr_p_depository_code_new
	 	   AND f.depo_code!=:chr_p_depository_code_new
			AND a.instr_code=c.instr_code
			AND TO_CHAR(a.deal_date,'DD/MM/YYYY')=:chr_p_deal_date
			AND a.exch_code=:chr_p_exch_code
			AND e.exch_code=a.exch_code
			AND a.mkt_type=:chr_p_mkt_type
			AND a.mkt_type!=DECODE(a.exch_code,'NSE','22','BSE','16','MCS','03') /*Added by PT MCS*/
			AND a.settlement_no=:chr_p_settlement_no
			AND a.clh_flg=:chr_p_trns_type
			AND e.dp_id=:chr_p_dp_id
			AND e.depo_code=:chr_p_depository_code_new
			AND a.client=f.dl_client
			AND a.identiy_no=f.dl_ref_no
			AND NVL(f.pool_trans,'N')='Y'
			AND a.deal_cd IN('2','4')
			AND ( a.deal_stat=DECODE(:chr_p_instr_type,'I','CC','O','MS') OR a.deal_stat=DECODE(:chr_p_instr_type,'I','CC','O','CC'))
/*			AND a.deal_stat='CC'
*/			AND a.NDS_BLK_DT is null
		GROUP BY  a.client,d.cln_depo_map_client_id,a.instr_code,a.exch_code,a.settlement_no,a.mkt_type,a.deal_cd,
					c.instr_isin,a.setl_date,cln_depo_map_dp_id,e.cm_cc_id,e.cln_id,f.depo_code,a.dl_class;

		
		   EXEC SQL OPEN l_cur_clh_interdp_instr;
		IS_ANY_ORA_ERROR

	   for(;;)
		{
			memset(l_dl_deal_struct_h, NULL, sizeof(SYS_DL_DEAL_STRUCT_H));
			memset(l_dl_deal_struct_i, 0, sizeof(SYS_DL_DEAL_STRUCT_I));
			memset(chr_l_refno_str,APL_NULL_CHAR,4001);

			EXEC SQL FETCH l_cur_clh_interdp_instr INTO   :l_dl_deal_struct_h->h_dl_client:l_dl_deal_struct_i->i_dl_client,
				  :chr_l_cln_depomap_id:i_cln_depomap_id,
				  :l_dl_deal_struct_h->h_instr_code:l_dl_deal_struct_i->i_instr_code,
													:l_dl_deal_struct_h->h_exch_code:l_dl_deal_struct_i->i_exch_code,
													:l_dl_deal_struct_h->h_mkt_type:l_dl_deal_struct_i->i_mkt_type,	
													:l_dl_deal_struct_h->h_settlement_no:l_dl_deal_struct_i->i_settlement_no,
													:l_dl_deal_struct_h->h_dealcd:l_dl_deal_struct_i->i_dealcd,
													:l_dl_deal_struct_h->h_qty:l_dl_deal_struct_i->i_qty,
													:chr_l_instr_isin:i_instr_isin,
													:l_dl_deal_struct_h->h_setldt:l_dl_deal_struct_i->i_setldt,
													:chr_l_cln_dpid:i_cln_dpid,
													:chr_l_cmbp_id:i_cmbp_id,
													:chr_l_other_client_id:i_other_client_id,
													:chr_l_pool_depo:i_pool_depo,
													:chr_l_dl_class:i_dl_class;

			
			if(APL_ZERO_RESULT_SET)
		    {

			 if(counter==0)
			  {
					fprintf(g_flogfile,"No Records Found in l_cur_clh_interdp_instr CURSOR! \n");
			  }
			 break;

		    }
		  	IS_ANY_ORA_ERROR

			counter++;

			sprintf(chr_l_internal_ref_no,"%s%d",chr_l_batchseq,counter);
			strcpy(chr_l_send_refno1,chr_l_internal_ref_no);
			printf("\n INTERDP :Internal Ref No=|%s| \n",chr_l_internal_ref_no);
			
			
		 EXEC SQL SELECT	:l_dl_deal_struct_h->h_dealcd INTO :chr_p_instr_type_new
								FROM dual;
		 
		 IS_ANY_ORA_ERROR 
	

		
		 strcpy(chr_l_instruction_type,"925");

		 printf("\n INTERDP********chr_p_instr_type_new**************=|%c| \n",chr_p_instr_type_new);
		 printf("\n INTERDP********chr_l_instruction_type**************=|%s| \n",chr_l_instruction_type);


/*	********************   Start Retriving IDENTIY_NO from dl_deal table *************** */
   if(strcmp(chr_p_instr_type,"I")==0)
    {

		EXEC SQL DECLARE l_cur_upd_interdp_clh_i CURSOR FOR
			SELECT identiy_no 
			FROM Dl_Deal a ,mt_cli_depo_map d
			WHERE a.client=:l_dl_deal_struct_h->h_dl_client
			AND d.cln_code=:l_dl_deal_struct_h->h_dl_client
	 	    AND d.cln_depo_code=:chr_p_depository_code_new
			AND a.instr_code=:l_dl_deal_struct_h->h_instr_code
			AND TO_CHAR(a.deal_date,'DD/MM/YYYY')=:chr_p_deal_date
			AND a.exch_code=:chr_p_exch_code
			AND a.mkt_type=:chr_p_mkt_type
			AND ((a.mkt_type!= DECODE(a.exch_code,'NSE','22','BSE','16','MCS','03')) AND (a.mkt_type!= DECODE(a.exch_code,'NSE','50','BSE','17','MCS','24'))) /*Added by PT MCS*/
			AND a.settlement_no=:chr_p_settlement_no
			AND a.clh_flg=:chr_p_trns_type
			AND a.deal_cd IN('2','4')
			AND a.deal_stat='CC' AND a.NDS_BLK_DT is null;


	   EXEC SQL OPEN l_cur_upd_interdp_clh_i;
		IS_ANY_ORA_ERROR
	 }
	else
	{

		EXEC SQL DECLARE l_cur_upd_interdp_clh_o CURSOR FOR
			SELECT identiy_no 
			FROM Dl_Deal a ,mt_cli_depo_map d , dl_markshortage g
			WHERE a.client=:l_dl_deal_struct_h->h_dl_client
			AND d.cln_code=:l_dl_deal_struct_h->h_dl_client
	 	    AND d.cln_depo_code=:chr_p_depository_code_new
			AND a.instr_code=:l_dl_deal_struct_h->h_instr_code
			AND TO_CHAR(a.deal_date,'DD/MM/YYYY')=:chr_p_deal_date
			AND a.exch_code=:chr_p_exch_code
			AND a.mkt_type=:chr_p_mkt_type
			AND ((a.mkt_type!= DECODE(a.exch_code,'NSE','22','BSE','16','MCS','03')) AND (a.mkt_type!= DECODE(a.exch_code,'NSE','50','BSE','17','MCS','24'))) /*Added by PT MCS*/
			AND a.settlement_no=:chr_p_settlement_no
			AND a.clh_flg=:chr_p_trns_type
			AND a.deal_cd IN('2','4')
			AND a.client=g.dl_client
			AND a.identiy_no=g.dl_ref_no
			AND NVL(g.pool_trans,'N')='Y'
			AND g.depo_code!=:chr_p_depository_code_new
			AND a.deal_stat IN('CC','MS') AND a.NDS_BLK_DT is null;


	   EXEC SQL OPEN l_cur_upd_interdp_clh_o;
		IS_ANY_ORA_ERROR
	}
	   for(;;)
	   {
   if(strcmp(chr_p_instr_type,"I")==0)
		    {

		  EXEC SQL FETCH l_cur_upd_interdp_clh_i INTO :chr_l_identiy_no;
			 }
	else
	{
		  EXEC SQL FETCH l_cur_upd_interdp_clh_o INTO :chr_l_identiy_no;
	}
 
		  if(APL_ZERO_RESULT_SET)
		  {
			 if(counter==0)
			  {
					fprintf(g_flogfile,"No Records Found in l_cur_upd_interdp_clh CURSOR! \n");
			  }
			 break;

		  }
		  	IS_ANY_ORA_ERROR
			printf("\n [InterDP:NonT2T] Updating DP Generation Date for Account|%s|, RefNo|%s| with Date |%s|..",l_dl_deal_struct_h->h_dl_client,chr_l_identiy_no,chr_l_maker_dt);

			fprintf(g_flogfile,"\n [InterDP:NonT2T] Updating DP Generation Date for Account|%s|, RefNo|%s| with Date |%s|..",l_dl_deal_struct_h->h_dl_client,chr_l_identiy_no,chr_l_maker_dt);
			
		 	if(l_dl_deal_struct_h->h_qty > 0)
		    { 
				EXEC SQL UPDATE DL_DEAL SET NDS_BLK_DT=:chr_l_maker_dt WHERE
				identiy_no = :chr_l_identiy_no AND
				client=:l_dl_deal_struct_h->h_dl_client;
				if(sqlca.sqlcode)
				{
					fprintf(g_flogfile,"InterDP:Error Updating NDS_BLK_DT ORA|%d|\n",sqlca.sqlcode);
				}
		  		IS_ANY_ORA_ERROR
		    }

			strcat(chr_l_refno_str,chr_l_identiy_no);
			strcat(chr_l_refno_str,",");
	  }
		   if(strcmp(chr_p_instr_type,"I")==0)
				    {
		EXEC SQL CLOSE l_cur_upd_interdp_clh_i;
					 }
			else
			{
		EXEC SQL CLOSE l_cur_upd_interdp_clh_o;
			}
		IS_ANY_ORA_ERROR


		printf("\n DEAL_REFNO_STRING=|%s|\n",chr_l_refno_str);
		fprintf(g_flogfile,"Counter=|%d| Deal String is=|%s|\n",counter,chr_l_refno_str); /*** THE MOST CULPRIT LINE ...Ash *****/
		fflush(g_flogfile);



/*	********************   Start Retriving IDETIY_NO from dl_deal table *************** */



/*************** CLH: INTER-DEPOSITORY TRANSFER FROM NSDL POOL TO CDSL CLIENT	***************/

			if(strcmp(chr_p_depository_code_new,"CDSL")==0 && strcmp(chr_l_pool_depo,"NSDL")==0)
			{
				
				 strcpy(chr_l_instruction_type,"NC5");
				 strcpy(chr_l_rev_flg,"P");
		
				 EXEC SQL SELECT dp_id,cln_id INTO :chr_l_other_dpid:i_other_dpid,:chr_l_other_client_id1:i_other_client_id1
					 FROM mt_exch_depo 
					 WHERE exch_code=:l_dl_deal_struct_h->h_exch_code
					 AND depo_code='NSDL';
					
				IS_ANY_ORA_ERROR
				
				 if(l_dl_deal_struct_h->h_qty > 0)
				 {
/*					if(!strcmp(chr_l_dl_class,"59") && !strcmp(chr_p_exch_code,"BSE"))
						strcpy(l_dl_deal_struct_h->h_mkt_type,"4");
					else if(!strcmp(chr_l_dl_class,"59") && !strcmp(chr_p_exch_code,"NSE"))
						strcpy(l_dl_deal_struct_h->h_mkt_type,"14");
*/					
					/* Isolve353:AmitB:140707 :systemdate as Setl Date for auction trades	*/
					if(!strcmp(l_dl_deal_struct_h->h_mkt_type,"14") || !strcmp(l_dl_deal_struct_h->h_mkt_type,"4"))
					strcpy(l_dl_deal_struct_h->h_setldt,chr_l_maker_dt);
			
					fprintf(g_flogfile,"InterDp:CLH:NSDL1:Before Inserting Into DL_DPINSTRS\n");

					EXEC SQL INSERT INTO DL_DPINSTRS
					(batch_no,serial_no,trans_type,client,instr_code,qty,exch_code,mkt_type,settlement_no,setl_date,isin_cd,
					clh_dvp,cmbp_id,dpm_trans_no,rev_flg,other_branch_cd,other_client_id,other_mkt_type,other_stlmnt_no,
					internal_ref_no,send_ref_1,send_ref_2,maker,maker_date,checker,checker_date,access_stamp,status,depo_ind,deal_ref_nos,deal_cd,other_dp_id,client_code)
					VALUES(:chr_l_batchseq,:counter,:chr_l_instruction_type,:chr_l_other_client_id1,
					:l_dl_deal_struct_h->h_instr_code,:l_dl_deal_struct_h->h_qty,:chr_p_exch_code,
					:l_dl_deal_struct_h->h_mkt_type,:l_dl_deal_struct_h->h_settlement_no,
					:l_dl_deal_struct_h->h_setldt,:chr_l_instr_isin,'C',:chr_l_cmbp_id,NULL,:chr_l_rev_flg,NULL,
					:chr_l_cln_depomap_id,
					NULL,NULL,:chr_l_internal_ref_no,:chr_l_send_refno1,NULL,
					:chr_l_maker,:chr_l_maker_dt,NULL,NULL,:chr_l_access_stamp,'G',:chr_p_depository_code_new,:chr_l_refno_str,:l_dl_deal_struct_h->h_dealcd,:chr_p_dp_id,:l_dl_deal_struct_h->h_dl_client);

					IS_ANY_ORA_ERROR																							

					sprintf(chr_g_log_buffer,"InterDP Cursor:After Inserting Details Record for client=|%s|",l_dl_deal_struct_h->h_dl_client);	
					fprintf(g_flogfile,"%s",chr_g_log_buffer);
				}
				else if(l_dl_deal_struct_h->h_qty ==  0)
				{
					counter--; //Added by Prateek on 30092014 for ISKB_6847(Serial number is coming wrong in Handoff file)
					int_l_zero_qty++;
					sprintf(chr_g_log_buffer,"ZERO QUANTITY FOR Client=|%s| Instrument=|%s| \n",l_dl_deal_struct_h->h_dl_client,l_dl_deal_struct_h->h_instr_code);
					fprintf(g_flogfile,"%s",chr_g_log_buffer);
					
				}	
			
				 strcpy(chr_l_instruction_type,"NC6");


				 if(l_dl_deal_struct_h->h_qty > 0)
				 {

					counter++;

/*					if(!strcmp(chr_l_dl_class,"59") && !strcmp(chr_p_exch_code,"BSE"))
						strcpy(l_dl_deal_struct_h->h_mkt_type,"4");
					else if(!strcmp(chr_l_dl_class,"59") && !strcmp(chr_p_exch_code,"NSE"))
						strcpy(l_dl_deal_struct_h->h_mkt_type,"14");
*/					
					/* Isolve353:AmitB:140707 :systemdate as Setl Date for auction trades	*/
					if(!strcmp(l_dl_deal_struct_h->h_mkt_type,"14") || !strcmp(l_dl_deal_struct_h->h_mkt_type,"4"))
					strcpy(l_dl_deal_struct_h->h_setldt,chr_l_maker_dt);
					
					fprintf(g_flogfile,"\n InterDP:CLH:NSDL2:Before Inserting Into DL_DPINSTRS\n");

					EXEC SQL INSERT INTO DL_DPINSTRS
					(batch_no,serial_no,trans_type,client,instr_code,qty,exch_code,mkt_type,settlement_no,setl_date,isin_cd,
					clh_dvp,cmbp_id,dpm_trans_no,rev_flg,other_branch_cd,other_client_id,other_mkt_type,other_stlmnt_no,
					internal_ref_no,send_ref_1,send_ref_2,maker,maker_date,checker,checker_date,access_stamp,status,depo_ind,deal_ref_nos,deal_cd,other_dp_id,client_code)
					VALUES(:chr_l_batchseq,:counter,:chr_l_instruction_type,LPAD(:chr_p_dp_id,8,'0')||LPAD(:chr_l_cln_depomap_id,8,'0'),
					:l_dl_deal_struct_h->h_instr_code,:l_dl_deal_struct_h->h_qty,:chr_p_exch_code,
					:l_dl_deal_struct_h->h_mkt_type,:l_dl_deal_struct_h->h_settlement_no,
					:l_dl_deal_struct_h->h_setldt,:chr_l_instr_isin,'C',:chr_l_cmbp_id,NULL,NULL,NULL,
					:chr_l_other_client_id1,
					NULL,NULL,:chr_l_internal_ref_no,:chr_l_send_refno1,NULL,
					:chr_l_maker,:chr_l_maker_dt,NULL,NULL,:chr_l_access_stamp,'G',:chr_p_depository_code_new,:chr_l_refno_str,:l_dl_deal_struct_h->h_dealcd,:chr_l_other_dpid,:l_dl_deal_struct_h->h_dl_client);

					IS_ANY_ORA_ERROR																							

					sprintf(chr_g_log_buffer,"InterDP Cursor:After Inserting Details Record for client=|%s|",l_dl_deal_struct_h->h_dl_client);	
					fprintf(g_flogfile,"%s",chr_g_log_buffer);
				}
				else if(l_dl_deal_struct_h->h_qty ==  0)
				{
					counter--; //Added by Prateek on 30092014 for ISKB_6847(Serial number is coming wrong in Handoff file)
					int_l_zero_qty++;
					sprintf(chr_g_log_buffer,"ZERO QUANTITY FOR Client=|%s| Instrument=|%s| \n",l_dl_deal_struct_h->h_dl_client,l_dl_deal_struct_h->h_instr_code);
					fprintf(g_flogfile,"%s",chr_g_log_buffer);
					
				}	


			}

/*************** INTER-DEPOSITORY TRANSFER FROM CDSL POOL TO NSDL CLIENT	***************/

			printf("\n chr_p_depository_code_new=|%s| chr_l_pool_depo=|%s| \n",chr_p_depository_code_new,chr_l_pool_depo);

			if(strcmp(chr_p_depository_code_new,"NSDL")==0 && strcmp(chr_l_pool_depo,"CDSL")==0)
			{
				
				 strcpy(chr_l_instruction_type,"CN6");


				 EXEC SQL SELECT dp_id,cln_id INTO :chr_l_other_dpid:i_other_dpid,:chr_l_other_client_id1:i_other_client_id1
					 FROM mt_exch_depo 
					 WHERE exch_code=:l_dl_deal_struct_h->h_exch_code
					 AND depo_code='CDSL';
					
				IS_ANY_ORA_ERROR
				
				 if(l_dl_deal_struct_h->h_qty > 0)
				 {

/*					if(!strcmp(chr_l_dl_class,"59") && !strcmp(chr_p_exch_code,"BSE"))
						strcpy(l_dl_deal_struct_h->h_mkt_type,"4");
					else if(!strcmp(chr_l_dl_class,"59") && !strcmp(chr_p_exch_code,"NSE"))
						strcpy(l_dl_deal_struct_h->h_mkt_type,"14");
*/
					/* Isolve353:AmitB:140707 :systemdate as Setl Date for auction trades	*/
					if(!strcmp(l_dl_deal_struct_h->h_mkt_type,"14") || !strcmp(l_dl_deal_struct_h->h_mkt_type,"4"))
					strcpy(l_dl_deal_struct_h->h_setldt,chr_l_maker_dt);

					fprintf(g_flogfile,"InterDP:CLH:CDSL1:Before Inserting Into DL_DPINSTRS\n");

					EXEC SQL INSERT INTO DL_DPINSTRS
					(batch_no,serial_no,trans_type,client,instr_code,qty,exch_code,mkt_type,settlement_no,setl_date,isin_cd,
					clh_dvp,cmbp_id,dpm_trans_no,rev_flg,other_branch_cd,other_client_id,other_mkt_type,other_stlmnt_no,
					internal_ref_no,send_ref_1,send_ref_2,maker,maker_date,checker,checker_date,access_stamp,status,depo_ind,deal_ref_nos,deal_cd,other_dp_id,client_code)
					VALUES(:chr_l_batchseq,:counter,:chr_l_instruction_type,:chr_l_cln_depomap_id,
					:l_dl_deal_struct_h->h_instr_code,:l_dl_deal_struct_h->h_qty,:chr_p_exch_code,
					:l_dl_deal_struct_h->h_mkt_type,:l_dl_deal_struct_h->h_settlement_no,
					:l_dl_deal_struct_h->h_setldt,:chr_l_instr_isin,'C',:chr_l_cmbp_id,NULL,NULL,NULL,
					:chr_l_other_client_id1,
					NULL,NULL,:chr_l_internal_ref_no,:chr_l_send_refno1,NULL,
					:chr_l_maker,:chr_l_maker_dt,NULL,NULL,:chr_l_access_stamp,'G',:chr_p_depository_code_new,:chr_l_refno_str,:l_dl_deal_struct_h->h_dealcd,:chr_l_other_dpid,:l_dl_deal_struct_h->h_dl_client);

					IS_ANY_ORA_ERROR																							

					sprintf(chr_g_log_buffer,"InterDP Cursor:After Inserting Details Record for client=|%s|",l_dl_deal_struct_h->h_dl_client);	
					fprintf(g_flogfile,"%s",chr_g_log_buffer);
				}
				else if(l_dl_deal_struct_h->h_qty ==  0)
				{
					counter--; //Added by Prateek on 30092014 for ISKB_6847(Serial number is coming wrong in Handoff file)
					int_l_zero_qty++;
					sprintf(chr_g_log_buffer,"ZERO QUANTITY FOR Client=|%s| Instrument=|%s| \n",l_dl_deal_struct_h->h_dl_client,l_dl_deal_struct_h->h_instr_code);
					fprintf(g_flogfile,"%s",chr_g_log_buffer);
					
				}	
			
				 strcpy(chr_l_instruction_type,"CN5");
				 strcpy(chr_l_rev_flg,"P");
					
				 if(l_dl_deal_struct_h->h_qty > 0)
				 {

					counter++;

/*					if(!strcmp(chr_l_dl_class,"59") && !strcmp(chr_p_exch_code,"BSE"))
						strcpy(l_dl_deal_struct_h->h_mkt_type,"4");
					else if(!strcmp(chr_l_dl_class,"59") && !strcmp(chr_p_exch_code,"NSE"))
						strcpy(l_dl_deal_struct_h->h_mkt_type,"14");
*/
					/* Isolve353:AmitB:140707 :systemdate as Setl Date for auction trades	*/
					if(!strcmp(l_dl_deal_struct_h->h_mkt_type,"14") || !strcmp(l_dl_deal_struct_h->h_mkt_type,"4"))
					strcpy(l_dl_deal_struct_h->h_setldt,chr_l_maker_dt);

					fprintf(g_flogfile,"InterDP:CLH:CDSL2:Before Inserting Into DL_DPINSTRS\n");

					EXEC SQL INSERT INTO DL_DPINSTRS
					(batch_no,serial_no,trans_type,client,instr_code,qty,exch_code,mkt_type,settlement_no,setl_date,isin_cd,
					clh_dvp,cmbp_id,dpm_trans_no,rev_flg,other_branch_cd,other_client_id,other_mkt_type,other_stlmnt_no,
					internal_ref_no,send_ref_1,send_ref_2,maker,maker_date,checker,checker_date,access_stamp,status,depo_ind,deal_ref_nos,deal_cd,other_dp_id,client_code)
					VALUES(:chr_l_batchseq,:counter,:chr_l_instruction_type,LPAD(:chr_l_other_dpid,8,'0')||LPAD(:chr_l_other_client_id1,8,'0'),
					:l_dl_deal_struct_h->h_instr_code,:l_dl_deal_struct_h->h_qty,:chr_p_exch_code,
					:l_dl_deal_struct_h->h_mkt_type,:l_dl_deal_struct_h->h_settlement_no,
					:l_dl_deal_struct_h->h_setldt,:chr_l_instr_isin,'C',:chr_l_cmbp_id,NULL,:chr_l_rev_flg,NULL,
					:chr_l_cln_depomap_id,
					NULL,NULL,:chr_l_internal_ref_no,:chr_l_send_refno1,NULL,
					:chr_l_maker,:chr_l_maker_dt,NULL,NULL,:chr_l_access_stamp,'G',:chr_p_depository_code_new,:chr_l_refno_str,:l_dl_deal_struct_h->h_dealcd,:chr_p_dp_id,:l_dl_deal_struct_h->h_dl_client);

					IS_ANY_ORA_ERROR																							

					sprintf(chr_g_log_buffer,"InterDP Cursor:After Inserting Details Record for client=|%s|",l_dl_deal_struct_h->h_dl_client);	
					fprintf(g_flogfile,"%s",chr_g_log_buffer);
				}
				else if(l_dl_deal_struct_h->h_qty ==  0)
				{
					counter--; //Added by Prateek on 30092014 for ISKB_6847(Serial number is coming wrong in Handoff file)
					int_l_zero_qty++;
					sprintf(chr_g_log_buffer,"ZERO QUANTITY FOR Client=|%s| Instrument=|%s| \n",l_dl_deal_struct_h->h_dl_client,l_dl_deal_struct_h->h_instr_code);
					fprintf(g_flogfile,"%s",chr_g_log_buffer);
					
				}	


			}


		strcpy(chr_l_refno_str,APL_NULL_STRING);


	   }	/* OUTER FOR LOOP ENDS	*/

		EXEC SQL CLOSE l_cur_clh_interdp_instr;
		IS_ANY_ORA_ERROR

		if(strcmp(chr_p_instr_type,"I")==0)
		{
			int_l_deliver_qty=l_tot_qty;
		}
		else if(strcmp(chr_p_instr_type,"O")==0)	
		{
			int_l_receive_qty=l_tot_qty;
		}
				
			EXEC SQL INSERT INTO dl_dpinstr_trail(batch_no,record_type,branch_cd,deliver_qty,receive_qty,
														  tot_qty,status,maker,maker_date,access_stamp)
												VALUES(:chr_l_batchseq,99,'000',//:g_mt_commonsys_params_struct_h.brnch_cd,
														 :int_l_deliver_qty,:int_l_receive_qty,:l_tot_qty,'G',:chr_l_maker,
														 :chr_l_maker_dt,:chr_l_access_stamp);		
			
		IS_ANY_ORA_ERROR	
	
		EXEC SQL UPDATE dl_dpinstr_hdr SET tot_num_record=tot_num_record - :int_l_zero_qty
							WHERE batch_no=:chr_l_batchseq;
		IS_ANY_ORA_ERROR
				
		fprintf(g_flogfile,"InterDP:No of Zero Quantity Records=|%d| \n",int_l_zero_qty);	
			
			
	 }	/* ** IF ends ** */ 


	chr_l_flg='Y';

	fprintf(g_flogfile,"InterDP RECORDS:CLH:T2T: PROCESSING FOR T2T SEGMENT TRADES ");

/*if(strcmp(chr_p_instr_type,"I")==0 && strcmp(chr_p_mkt_type,"22")==0)*/
/***if(strcmp(chr_p_instr_type,"I")==0 && ((strcmp(chr_p_mkt_type,"22")==0 && strcmp(chr_p_exch_code,"NSE")==0) || (strcmp(chr_p_mkt_type,"16")==0 && strcmp(chr_p_exch_code,"BSE")==0 )))
{
***/


EXEC SQL SELECT COUNT(*),NVL(SUM(a.allot_qty),0) as tot_qty 
					INTO :int_l_records:i_int_l_records,:l_tot_qty:i_l_tot_qty
		   FROM Dl_Deal a ,mt_instrument c,mt_cli_depo_map d,mt_exch_depo e,dl_markshortage f
			WHERE a.client=d.cln_code
	 	    AND d.cln_depo_code=:chr_p_depository_code_new
	 	    AND f.depo_code!=:chr_p_depository_code_new
			AND a.instr_code=c.instr_code
			AND TO_CHAR(a.deal_date,'DD/MM/YYYY')=:chr_p_deal_date
			AND a.exch_code=:chr_p_exch_code
			AND /*a.mkt_type=DECODE(:chr_p_exch_code,'NSE','22','BSE','16') */ 	/* CHANGES MADE FOR SLB - AMISH - 27/03/2008 */
			 (  a.mkt_type = DECODE(:chr_p_exch_code,'NSE','22','BSE','16','MCS','03') OR  //Modby PT for MCS 
				a.mkt_type = DECODE(:chr_p_exch_code,'NSE','23','BSE','18','MCS','63') OR
			    a.mkt_type = DECODE(:chr_p_exch_code,'NSE','24','BSE','19','MCS','64') OR
				a.mkt_type = DECODE(:chr_p_exch_code,'NSE','25','BSE','20','MCS','65') OR
				a.mkt_type = DECODE(:chr_p_exch_code,'NSE','50','BSE','17','MCS','03')
			  )
			AND a.settlement_no=:chr_p_settlement_no
			AND a.clh_flg=:chr_p_trns_type
			AND e.dp_id=:chr_p_dp_id
			AND e.exch_code=:chr_p_exch_code
			AND e.depo_code=:chr_p_depository_code_new
			AND a.client=f.dl_client
			AND a.identiy_no=f.dl_ref_no
			AND NVL(f.pool_trans,'N')='Y'
			AND a.deal_cd  IN('2','4')
			AND ( a.deal_stat=DECODE(:chr_p_instr_type,'I','CC','O','MS') OR a.deal_stat=DECODE(:chr_p_instr_type,'I','CC','O','CC'))
/*			AND a.deal_stat='CC'
*/			AND a.NDS_BLK_DT is null;
		  
		  if(int_l_records == 0)
		  {
			  fprintf(g_flogfile," InterDP:CLH:T2T:NO Records Found For The Given Criteria !!!");
			  chr_l_flg='N';
		  }
	  	 IS_ANY_ORA_ERROR

		 printf("\n No Of InterDP:CLH:T2T Records|%d| \n",int_l_records);
		 sprintf(chr_g_log_buffer,"\n No Of InterDP:CLH:T2T Records|%d| \n",int_l_records);
		 fprintf(g_flogfile,"%s" ,chr_g_log_buffer);


  if(chr_l_flg== 'Y')
  {

	EXEC SQL SELECT DL_DPINSTRSEQ.NEXTVAL INTO :int_l_batchseq FROM DUAL;
		IS_ANY_ORA_ERROR
		
		strcpy(chr_l_batchseq,"I");
		strcat(chr_l_batchseq,(char*)ltoa(int_l_batchseq));

/********************** Inserting Header Record **********************/

	/*Changed by Narendra Kumar for ISKB_3298 -- Static data change -- change of DP role from 04 to 01 -- Started*/

		/*EXEC SQL INSERT INTO
		  	dl_dpinstr_hdr(batch_no,record_type,dp_id,dp_role,buy_sell_flg,status,tot_num_record,
								tot_qty,maker,maker_date,access_stamp)
					  VALUES(:chr_l_batchseq,01,:chr_p_dp_id,04,
							   'B','G',:int_l_records,:l_tot_qty,
								:chr_l_maker,:chr_l_maker_dt,:chr_l_access_stamp);*/
		
			EXEC SQL INSERT INTO
		  	dl_dpinstr_hdr(batch_no,record_type,dp_id,dp_role,buy_sell_flg,status,tot_num_record,
								tot_qty,maker,maker_date,access_stamp)
					  VALUES(:chr_l_batchseq,01,:chr_p_dp_id,01,
							   'B','G',:int_l_records,:l_tot_qty,
								:chr_l_maker,:chr_l_maker_dt,:chr_l_access_stamp);

	/*Changed by Narendra Kumar for ISKB_3298 -- Static data change -- change of DP role from 04 to 01 -- Ended*/

		IS_ANY_ORA_ERROR
		
		fprintf(g_flogfile,"InterDP Cursor:CLH:T2T: After Inserting Header Record");


		EXEC SQL DECLARE l_cur_interdp_clh_T2T CURSOR FOR
		SELECT a.identiy_no,a.client,d.cln_depo_map_client_id,a.instr_code,a.exch_code,a.mkt_type,a.settlement_no,a.deal_cd,
			   NVL(a.allot_qty,0),
			   c.instr_isin,setl_date,d.cln_depo_map_dp_id,e.cm_cc_id,e.cln_id
		FROM Dl_Deal a ,mt_instrument c,mt_cli_depo_map d,mt_exch_depo e,dl_markshortage f
			WHERE a.client=d.cln_code
	 	   AND d.cln_depo_code=:chr_p_depository_code_new
			AND a.instr_code=c.instr_code
			AND TO_CHAR(a.deal_date,'DD/MM/YYYY')=:chr_p_deal_date
			AND a.exch_code=:chr_p_exch_code
			AND /*a.mkt_type=DECODE(:chr_p_exch_code,'NSE','22','BSE','16') */ 	/* CHANGES MADE FOR SLB - AMISH - 27/03/2008 */
			 (  a.mkt_type = DECODE(:chr_p_exch_code,'NSE','22','BSE','16','MCS','03') OR
				a.mkt_type = DECODE(:chr_p_exch_code,'NSE','23','BSE','18','MCS','23') OR
			    a.mkt_type = DECODE(:chr_p_exch_code,'NSE','24','BSE','19','MCS','24') OR
				a.mkt_type = DECODE(:chr_p_exch_code,'NSE','25','BSE','20','MCS','25') OR
				a.mkt_type = DECODE(:chr_p_exch_code,'NSE','50','BSE','17','MCS','03')
			  )
			AND a.settlement_no=:chr_p_settlement_no
			AND a.clh_flg=:chr_p_trns_type
			AND e.dp_id=:chr_p_dp_id
			AND e.exch_code=:chr_p_exch_code
			AND e.depo_code=:chr_p_depository_code_new
			AND f.depo_code!=:chr_p_depository_code_new
			AND a.client=f.dl_client
			AND a.identiy_no=f.dl_ref_no
			AND NVL(f.pool_trans,'N')='Y'
			AND a.deal_cd  IN('2','4')
			AND ( a.deal_stat=DECODE(:chr_p_instr_type,'I','CC','O','MS') OR a.deal_stat=DECODE(:chr_p_instr_type,'I','CC','O','CC'))
/*			AND a.deal_stat='CC' 
*/			AND a.NDS_BLK_DT is null;



	   EXEC SQL OPEN l_cur_interdp_clh_T2T;
		IS_ANY_ORA_ERROR

	   for(;;)
	   {
			memset(l_dl_deal_struct_h, NULL, sizeof(SYS_DL_DEAL_STRUCT_H));
			memset(l_dl_deal_struct_i, NULL, sizeof(SYS_DL_DEAL_STRUCT_I));

		EXEC SQL FETCH l_cur_interdp_clh_T2T INTO	:l_dl_deal_struct_h->h_indentity_no:l_dl_deal_struct_i->i_indentity_no,
													:l_dl_deal_struct_h->h_dl_client:l_dl_deal_struct_i->i_dl_client,
													:chr_l_cln_depomap_id:i_cln_depomap_id,
													:l_dl_deal_struct_h->h_instr_code:l_dl_deal_struct_i->i_instr_code,
													:l_dl_deal_struct_h->h_exch_code:l_dl_deal_struct_i->i_exch_code,
													:l_dl_deal_struct_h->h_mkt_type:l_dl_deal_struct_i->i_mkt_type,	
													:l_dl_deal_struct_h->h_settlement_no:l_dl_deal_struct_i->i_settlement_no,
													:l_dl_deal_struct_h->h_dealcd:l_dl_deal_struct_i->i_dealcd,
													:l_dl_deal_struct_h->h_qty:l_dl_deal_struct_i->i_qty,
													:chr_l_instr_isin:i_instr_isin,
													:l_dl_deal_struct_h->h_setldt:l_dl_deal_struct_i->i_setldt,
													:chr_l_cln_dpid:i_cln_dpid,
													:chr_l_cmbp_id:i_cmbp_id,
													:chr_l_other_client_id:i_other_client_id;
			
			if(APL_ZERO_RESULT_SET)
		    {

			 if(counter1==0)
			  {
					fprintf(g_flogfile,"InterDP:CLH:T2T: No Records Found In l_cur_interdp_clh_T2T CURSOR !!!");
			  }
			 break;

		    }
		  	IS_ANY_ORA_ERROR

			counter1++;

			sprintf(chr_l_internal_ref_no,"%s%d",chr_l_batchseq,counter1);
			strcpy(chr_l_send_refno1,chr_l_internal_ref_no);
			printf("\n InterDP :T2T:Internal Ref No=|%s| \n",chr_l_internal_ref_no);
			
			
			EXEC SQL SELECT	:l_dl_deal_struct_h->h_dealcd INTO :chr_p_instr_type_new
									FROM dual;
			 
			IS_ANY_ORA_ERROR 
		
			strcpy(chr_l_identiy_t2t,l_dl_deal_struct_h->h_indentity_no);
			strcat(chr_l_identiy_t2t,",");
	
			sprintf(chr_g_log_buffer," InterDP:CLH:T2T:********DEAL CD=|%c| chr_l_identiy_t2t=|%s|********\n",chr_p_instr_type_new,chr_l_identiy_t2t);
			fprintf(g_flogfile,"%s",chr_g_log_buffer);


			if(strcmp(chr_p_depository_code_new,"CDSL")==0 && strcmp(chr_l_pool_depo,"NSDL")==0)
			{
				
				 strcpy(chr_l_instruction_type,"NC5");
				 strcpy(chr_l_rev_flg,"P");


				 EXEC SQL SELECT dp_id,cln_id INTO :chr_l_other_dpid:i_other_dpid,:chr_l_other_client_id1:i_other_client_id1
					 FROM mt_exch_depo 
					 WHERE exch_code=:l_dl_deal_struct_h->h_exch_code
					 AND depo_code='NSDL';
					
				IS_ANY_ORA_ERROR


				if(l_dl_deal_struct_h->h_qty > 0)
				{
					if(!strcmp(l_dl_deal_struct_h->h_mkt_type,"16") && !strcmp(l_dl_deal_struct_h->h_exch_code,"BSE"))
					{
						strcpy(l_dl_deal_struct_h->h_mkt_type,"5");
					}
					/* Isolve353:AmitB:140707 :systemdate as Setl Date for auction trades	*/
					if(!strcmp(l_dl_deal_struct_h->h_mkt_type,"14") || !strcmp(l_dl_deal_struct_h->h_mkt_type,"4"))
					strcpy(l_dl_deal_struct_h->h_setldt,chr_l_maker_dt);

						fprintf(g_flogfile,"InterDp:CLH:T2T:NSDL1:Before Inserting Into DL_DPINSTRS\n");

					EXEC SQL INSERT INTO DL_DPINSTRS
					(batch_no,serial_no,trans_type,client,instr_code,qty,exch_code,mkt_type,settlement_no,setl_date,isin_cd,
					clh_dvp,cmbp_id,dpm_trans_no,rev_flg,other_branch_cd,other_client_id,other_mkt_type,other_stlmnt_no,
					internal_ref_no,send_ref_1,send_ref_2,maker,maker_date,checker,checker_date,access_stamp,status,depo_ind,deal_ref_nos,deal_cd,other_dp_id,client_code)
					VALUES(:chr_l_batchseq,:counter1,:chr_l_instruction_type,:chr_l_other_client_id1,
					:l_dl_deal_struct_h->h_instr_code,:l_dl_deal_struct_h->h_qty,:chr_p_exch_code,
					:l_dl_deal_struct_h->h_mkt_type,:l_dl_deal_struct_h->h_settlement_no,
					:l_dl_deal_struct_h->h_setldt,:chr_l_instr_isin,'C',:chr_l_cmbp_id,NULL,:chr_l_rev_flg,NULL,
					:chr_l_cln_depomap_id,
					NULL,NULL,:chr_l_internal_ref_no,:chr_l_send_refno1,NULL,
					:chr_l_maker,:chr_l_maker_dt,NULL,NULL,:chr_l_access_stamp,'G',:chr_p_depository_code_new,:chr_l_identiy_t2t,:l_dl_deal_struct_h->h_dealcd,:chr_p_dp_id,:l_dl_deal_struct_h->h_dl_client);

					IS_ANY_ORA_ERROR																							

					printf("\n [InterDP:CLH:T2T] Updating DP Generation Date for Account|%s|, RefNo|%s| with Date |%s|..",l_dl_deal_struct_h->h_dl_client,l_dl_deal_struct_h->h_indentity_no,chr_l_maker_dt);
				
					 fprintf(g_flogfile,"\n [InterDP:CLH:T2T] Updating DP Generation Date for Account|%s|, RefNo|%s| with Date |%s|",l_dl_deal_struct_h->h_dl_client,chr_l_identiy_no,chr_l_maker_dt);	
					 
					EXEC SQL UPDATE DL_DEAL SET NDS_BLK_DT=:chr_l_maker_dt WHERE
					identiy_no = :l_dl_deal_struct_h->h_indentity_no AND
					client=:l_dl_deal_struct_h->h_dl_client;
					if(sqlca.sqlcode)
					{
						fprintf(g_flogfile,"InterDP:CLH:T2T:Error Updating NDS_BLK_DT ORA|%d|\n",sqlca.sqlcode);
					}
					IS_ANY_ORA_ERROR
				
				}
				else if(l_dl_deal_struct_h->h_qty ==  0)	
				{
					counter1--; //Added by Prateek on 30092014 for ISKB_6847(Serial number is coming wrong in Handoff file)
					int_l_zero_qty++;
					sprintf(chr_g_log_buffer,"InterDP:CLH:T2T:ZERO QUANTITY FOR Client=|%s| Instrument=|%s| \n",l_dl_deal_struct_h->h_dl_client,l_dl_deal_struct_h->h_instr_code);
					fprintf(g_flogfile,"%s",chr_g_log_buffer);

				}

				strcpy(chr_l_instruction_type,"NC6");


				 if(l_dl_deal_struct_h->h_qty > 0)
				 {

					counter++;

					if(!strcmp(l_dl_deal_struct_h->h_mkt_type,"16") && !strcmp(l_dl_deal_struct_h->h_exch_code,"BSE"))
					{
						strcpy(l_dl_deal_struct_h->h_mkt_type,"5");
					}
					/* Isolve353:AmitB:140707 :systemdate as Setl Date for auction trades	*/
					if(!strcmp(l_dl_deal_struct_h->h_mkt_type,"14") || !strcmp(l_dl_deal_struct_h->h_mkt_type,"4"))
					strcpy(l_dl_deal_struct_h->h_setldt,chr_l_maker_dt);

						fprintf(g_flogfile,"\n InterDP:CLH:T2T:NSDL2:Before Inserting Into DL_DPINSTRS\n");	

						EXEC SQL INSERT INTO DL_DPINSTRS
						(batch_no,serial_no,trans_type,client,instr_code,qty,exch_code,mkt_type,settlement_no,setl_date,isin_cd,
						clh_dvp,cmbp_id,dpm_trans_no,rev_flg,other_branch_cd,other_client_id,other_mkt_type,other_stlmnt_no,
						internal_ref_no,send_ref_1,send_ref_2,maker,maker_date,checker,checker_date,access_stamp,status,depo_ind,deal_ref_nos,deal_cd,other_dp_id,client_code)
						VALUES(:chr_l_batchseq,:counter1,:chr_l_instruction_type,LPAD(:chr_p_dp_id,8,'0')||LPAD(:chr_l_cln_depomap_id,8,'0'),
						:l_dl_deal_struct_h->h_instr_code,:l_dl_deal_struct_h->h_qty,:chr_p_exch_code,
						:l_dl_deal_struct_h->h_mkt_type,:l_dl_deal_struct_h->h_settlement_no,
						:l_dl_deal_struct_h->h_setldt,:chr_l_instr_isin,'C',:chr_l_cmbp_id,NULL,NULL,NULL,
						:chr_l_other_client_id1,
						NULL,NULL,:chr_l_internal_ref_no,:chr_l_send_refno1,NULL,
						:chr_l_maker,:chr_l_maker_dt,NULL,NULL,:chr_l_access_stamp,'G',:chr_p_depository_code_new,:chr_l_identiy_t2t,:l_dl_deal_struct_h->h_dealcd,:chr_l_other_dpid,:l_dl_deal_struct_h->h_dl_client);

						IS_ANY_ORA_ERROR																							
				
						 fprintf(g_flogfile,"\n [InterDP:CLH:T2T] Updating DP Generation Date for Account|%s|, RefNo|%s| with Date |%s|",l_dl_deal_struct_h->h_dl_client,chr_l_identiy_no,chr_l_maker_dt);	
					 
						EXEC SQL UPDATE DL_DEAL SET NDS_BLK_DT=:chr_l_maker_dt WHERE
						identiy_no = :l_dl_deal_struct_h->h_indentity_no AND
						client=:l_dl_deal_struct_h->h_dl_client;

						if(sqlca.sqlcode)
						{
							fprintf(g_flogfile,"InterDP:CLH:T2T:Error Updating NDS_BLK_DT ORA|%d|\n",sqlca.sqlcode);
						}
						IS_ANY_ORA_ERROR
					}
					else if(l_dl_deal_struct_h->h_qty ==  0)
					{
						counter1--; //Added by Prateek on 30092014 for ISKB_6847(Serial number is coming wrong in Handoff file)
						int_l_zero_qty++;
						sprintf(chr_g_log_buffer,"ZERO QUANTITY FOR Client=|%s| Instrument=|%s| \n",l_dl_deal_struct_h->h_dl_client,l_dl_deal_struct_h->h_instr_code);
						fprintf(g_flogfile,"%s",chr_g_log_buffer);
						
					}	


			}

/***************  T2T : CLH: INTER-DEPOSITORY TRANSFER FROM CDSL POOL TO NSDL CLIENT	***************/

			printf("\n chr_p_depository_code_new=|%s| chr_l_pool_depo=|%s| \n",chr_p_depository_code_new,chr_l_pool_depo);

			if(strcmp(chr_p_depository_code_new,"NSDL")==0 && strcmp(chr_l_pool_depo,"CDSL")==0)
			{
				
				 strcpy(chr_l_instruction_type,"CN6");

				EXEC SQL SELECT dp_id,cln_id INTO :chr_l_other_dpid:i_other_dpid,:chr_l_other_client_id1:i_other_client_id1
					 FROM mt_exch_depo 
					 WHERE exch_code=:l_dl_deal_struct_h->h_exch_code
					 AND depo_code='CDSL';
					
				IS_ANY_ORA_ERROR
				
				 if(l_dl_deal_struct_h->h_qty > 0)
				 {
					
					if(!strcmp(l_dl_deal_struct_h->h_mkt_type,"16") && !strcmp(l_dl_deal_struct_h->h_exch_code,"BSE"))
					{
						strcpy(l_dl_deal_struct_h->h_mkt_type,"5");
					}
					/* Isolve353:AmitB:140707 :systemdate as Setl Date for auction trades	*/
					if(!strcmp(l_dl_deal_struct_h->h_mkt_type,"14") || !strcmp(l_dl_deal_struct_h->h_mkt_type,"4"))
					strcpy(l_dl_deal_struct_h->h_setldt,chr_l_maker_dt);

					fprintf(g_flogfile,"InterDP:CLH:T2T:CDSL1:Before Inserting Into DL_DPINSTRS\n");
			

					EXEC SQL INSERT INTO DL_DPINSTRS
					(batch_no,serial_no,trans_type,client,instr_code,qty,exch_code,mkt_type,settlement_no,setl_date,isin_cd,
					clh_dvp,cmbp_id,dpm_trans_no,rev_flg,other_branch_cd,other_client_id,other_mkt_type,other_stlmnt_no,
					internal_ref_no,send_ref_1,send_ref_2,maker,maker_date,checker,checker_date,access_stamp,status,depo_ind,deal_ref_nos,deal_cd,other_dp_id,client_code)
					VALUES(:chr_l_batchseq,:counter1,:chr_l_instruction_type,:chr_l_cln_depomap_id,
					:l_dl_deal_struct_h->h_instr_code,:l_dl_deal_struct_h->h_qty,:chr_p_exch_code,
					:l_dl_deal_struct_h->h_mkt_type,:l_dl_deal_struct_h->h_settlement_no,
					:l_dl_deal_struct_h->h_setldt,:chr_l_instr_isin,'C',:chr_l_cmbp_id,NULL,NULL,NULL,
					:chr_l_other_client_id1,
					NULL,NULL,:chr_l_internal_ref_no,:chr_l_send_refno1,NULL,
					:chr_l_maker,:chr_l_maker_dt,NULL,NULL,:chr_l_access_stamp,'G',:chr_p_depository_code_new,:chr_l_identiy_t2t,:l_dl_deal_struct_h->h_dealcd,:chr_l_other_dpid,:l_dl_deal_struct_h->h_dl_client);

					IS_ANY_ORA_ERROR

					sprintf(chr_g_log_buffer,"InterDP:CLH:T2T: Cursor:After Inserting Details Record for client=|%s|",l_dl_deal_struct_h->h_dl_client);	
					fprintf(g_flogfile,"%s",chr_g_log_buffer);

					EXEC SQL UPDATE DL_DEAL SET NDS_BLK_DT=:chr_l_maker_dt WHERE
						identiy_no = :l_dl_deal_struct_h->h_indentity_no AND
						client=:l_dl_deal_struct_h->h_dl_client;

						if(sqlca.sqlcode)
						{
							fprintf(g_flogfile,"InterDP:CLH:T2T:Error Updating NDS_BLK_DT ORA|%d|\n",sqlca.sqlcode);
						}
						IS_ANY_ORA_ERROR

				   }
					else if(l_dl_deal_struct_h->h_qty ==  0)
					{
						counter1--; //Added by Prateek on 30092014 for ISKB_6847(Serial number is coming wrong in Handoff file)
						int_l_zero_qty++;
						sprintf(chr_g_log_buffer,"ZERO QUANTITY FOR Client=|%s| Instrument=|%s| \n",l_dl_deal_struct_h->h_dl_client,l_dl_deal_struct_h->h_instr_code);
						fprintf(g_flogfile,"%s",chr_g_log_buffer);
					
					}	

					strcpy(chr_l_instruction_type,"CN5");
					strcpy(chr_l_rev_flg,"P");

				 if(l_dl_deal_struct_h->h_qty > 0)
				{

					counter++;

					if(!strcmp(l_dl_deal_struct_h->h_mkt_type,"16") && !strcmp(l_dl_deal_struct_h->h_exch_code,"BSE"))
					{
						strcpy(l_dl_deal_struct_h->h_mkt_type,"5");
					}
					/* Isolve353:AmitB:140707 :systemdate as Setl Date for auction trades	*/
					if(!strcmp(l_dl_deal_struct_h->h_mkt_type,"14") || !strcmp(l_dl_deal_struct_h->h_mkt_type,"4"))
					strcpy(l_dl_deal_struct_h->h_setldt,chr_l_maker_dt);

					fprintf(g_flogfile,"InterDP:CLH:T2T:CDSL2:Before Inserting Into DL_DPINSTRS\n");
		
					EXEC SQL INSERT INTO DL_DPINSTRS
					(batch_no,serial_no,trans_type,client,instr_code,qty,exch_code,mkt_type,settlement_no,setl_date,isin_cd,
					clh_dvp,cmbp_id,dpm_trans_no,rev_flg,other_branch_cd,other_client_id,other_mkt_type,other_stlmnt_no,
					internal_ref_no,send_ref_1,send_ref_2,maker,maker_date,checker,checker_date,access_stamp,status,depo_ind,deal_ref_nos,deal_cd,other_dp_id,client_code)
					VALUES(:chr_l_batchseq,:counter1,:chr_l_instruction_type,LPAD(:chr_l_other_dpid,8,'0')||LPAD(:chr_l_other_client_id1,8,'0'),
					:l_dl_deal_struct_h->h_instr_code,:l_dl_deal_struct_h->h_qty,:chr_p_exch_code,
					:l_dl_deal_struct_h->h_mkt_type,:l_dl_deal_struct_h->h_settlement_no,
					:l_dl_deal_struct_h->h_setldt,:chr_l_instr_isin,'C',:chr_l_cmbp_id,NULL,:chr_l_rev_flg,NULL,
					:chr_l_cln_depomap_id,
					NULL,NULL,:chr_l_internal_ref_no,:chr_l_send_refno1,NULL,
					:chr_l_maker,:chr_l_maker_dt,NULL,NULL,:chr_l_access_stamp,'G',:chr_p_depository_code_new,:chr_l_identiy_t2t,:l_dl_deal_struct_h->h_dealcd,:chr_l_other_dpid,:l_dl_deal_struct_h->h_dl_client);

					IS_ANY_ORA_ERROR
						
					sprintf(chr_g_log_buffer,"InterDP Cursor:After Inserting Details Record for client=|%s|",l_dl_deal_struct_h->h_dl_client);	
					fprintf(g_flogfile,"%s",chr_g_log_buffer);
				
					EXEC SQL UPDATE DL_DEAL SET NDS_BLK_DT=:chr_l_maker_dt WHERE
						identiy_no = :l_dl_deal_struct_h->h_indentity_no AND
						client=:l_dl_deal_struct_h->h_dl_client;

						if(sqlca.sqlcode)
						{
							fprintf(g_flogfile,"InterDP:CLH:T2T:Error Updating NDS_BLK_DT ORA|%d|\n",sqlca.sqlcode);
						}
						IS_ANY_ORA_ERROR

					
				}
				else if(l_dl_deal_struct_h->h_qty ==  0)
				{
					counter1--;//Added by Prateek on 30092014 for ISKB_6847(Serial number is coming wrong in Handoff file)
					int_l_zero_qty++;
					sprintf(chr_g_log_buffer,"ZERO QUANTITY FOR Client=|%s| Instrument=|%s| \n",l_dl_deal_struct_h->h_dl_client,l_dl_deal_struct_h->h_instr_code);
					fprintf(g_flogfile,"%s",chr_g_log_buffer);

				}

		
			}

		}

	EXEC SQL CLOSE l_cur_interdp_clh_T2T;
	IS_ANY_ORA_ERROR

		
		int_l_receive_qty=l_tot_qty;

			
		EXEC SQL INSERT INTO
	  			dl_dpinstr_trail(batch_no,record_type,branch_cd,deliver_qty,receive_qty,										  											tot_qty,status,maker,maker_date,access_stamp)
							 VALUES(:chr_l_batchseq,99,'000',//:g_mt_commonsys_params_struct_h.brnch_cd,
									  :int_l_deliver_qty,:int_l_receive_qty,:l_tot_qty,'G',:chr_l_maker,
									  :chr_l_maker_dt,:chr_l_access_stamp);

		IS_ANY_ORA_ERROR	

			
		EXEC SQL UPDATE dl_dpinstr_hdr SET tot_num_record=tot_num_record - :int_l_zero_qty
							WHERE batch_no=:chr_l_batchseq;
		IS_ANY_ORA_ERROR
		
		fprintf(g_flogfile,"InterDP:CLH:T2T:No of Zero Quantity Records=|%d| \n",int_l_zero_qty);	
			
  }		/* **** IF(chr_l_flg== 'Y') Ends **** */



APL_GOBACK_SUCCESS							;

RETURN_SUCCESS:
{
	CO_ProcMonitor(g_flogfile," Leaving Proc_GenInterDP_CLH_Instrn With Success",NULL,NULL);
	fprintf(g_flogfile," Leaving Proc_GenInterDP_Instrn With Success\n");
	return(APL_SUCCESS);
}

RETURN_FAILURE:
{
	printf("\n Error Inside Proc_GenInterDP_CLH_Instrn:ORA|%d|\n",sqlca.sqlcode);
	sprintf(chr_g_log_buffer,"Leaving Proc_GenInterDP_Instrn With Failure ORA|%d|\n",sqlca.sqlcode);	
	CO_ProcMonitor(g_flogfile,chr_g_log_buffer,l_debug_info_ptr,NULL);
	return(APL_FAILURE);	
}

}

/* *********** END CLH INTER DEPOSITORY FUNCTION ************ */






  int Proc_GenInterDP_DVP_Instrn(char *chr_p_instr_type,
						  char *chr_p_trns_type,
						  char *chr_p_depository_code,
						  char *chr_p_file_type,
						  char *chr_p_deal_date,
						  char *chr_p_exch_code,
						  char *chr_p_settlement_no,
						  char *chr_p_mkt_type,
						  char *chr_p_dp_id,
						  char *chr_p_user,
						  FILE *g_flogfile,
						  INTL_ENV_DATA_STRUCT_H *l_intl_env_data_h,
						  DEBUG_INFO_STRUCT_H **l_debug_info_ptr)
  {

	FILE  *l_ptr_ini_file = NULL;
	FILE  *l_ptr_handoff_file = NULL;
	char  chr_g_log_buffer[BUFFER_LEN] = APL_NULL_STRING;
	char  chr_l_inifile[100]= APL_NULL_STRING;
	char  chr_l_handoff_dir[PATH_LENGTH]= APL_NULL_STRING;
    char  chr_l_handoff_file_name[FILENAME_LEN_A]= APL_NULL_STRING;	
	char  chr_l_header[100]= APL_NULL_STRING;
	char  chr_l_trailer[200]= APL_NULL_STRING;
	char  chr_l_detail_rec[1000] =APL_NULL_STRING;
	int   int_l_batchseq=0;
	int   counter=0;
	char  chr_l_instr_isin[13]= APL_NULL_STRING;
	char  chr_l_oth_cmbpid[29]= APL_NULL_STRING;
	char  chr_l_oth_setlno[8]= APL_NULL_STRING;
	char  chr_l_oth_mkt_type[3]= APL_NULL_STRING;
	char  chr_l_remark[21]= APL_NULL_STRING;
	/* char  chr_l_send_refno1[36]= APL_NULL_STRING;
	char  chr_l_send_refno2[36]= APL_NULL_STRING; 
	** Modified For ISKB_3298 Changes - Jun2010 - Naren V */
	char  chr_l_send_refno1[51]= APL_NULL_STRING;
	char  chr_l_send_refno2[51]= APL_NULL_STRING; 
	char  chr_l_depo_part_code[21]=APL_NULL_STRING;
	char  chr_l_cmbp_id[29]=APL_NULL_STRING;
	char  chr_l_dpid[21]=APL_NULL_STRING;
	int   int_l_len=0;
 	char  chr_p_depository_code_new[5]= APL_NULL_STRING;
    char  chr_p_instr_type_new=APL_NULL_CHAR; 
	int	  int_l_records=0;
	char  chr_l_dprole[3]= APL_NULL_STRING;
	char  chr_l_user[APL_USERID_LEN] = APL_NULL_STRING;
	char  pro_sys_date[APL_DATE_LEN] = APL_NULL_STRING;
	char  chr_l_maker[APL_USERID_LEN] = APL_NULL_STRING;
	char  chr_l_maker_dt[APL_DATE_LEN] = APL_NULL_STRING;
	char  chr_l_access_stamp[APL_DATE_LEN] = APL_NULL_STRING;
	/* char  chr_l_internal_ref_no[21] = APL_NULL_STRING;
	** Modified For ISKB_3298 Changes - Jun2010 - Naren V */
	char  chr_l_internal_ref_no[36] = APL_NULL_STRING;
	char  chr_l_settlement_dt[20] = APL_NULL_STRING;
	char  chr_l_instruction_type[4] = APL_NULL_STRING;
	double l_tot_qty=0.0;
	char  chr_l_identiy_no[17]= APL_NULL_STRING;
	char  chr_l_refno_str[4001]= APL_NULL_STRING;
	int   counter2=0;
	double l_int_purchasesum=0.0;
	double l_int_salesum=0.0;
	double l_int_net_amt=0.0;
	char l_chr_instr_code[9]= APL_NULL_STRING;
	char chr_l_cln_depomap_id[21]= APL_NULL_STRING;
	char chr_l_flg='Y';
	char chr_l_identiy_t2t[18]= APL_NULL_STRING;
	double int_l_deliver_qty=0.0;
	double int_l_receive_qty=0.0;
	int int_l_zero_qty=0;
	char chr_l_pool_depo[5]=APL_NULL_STRING;
	char chr_l_other_client_id[14]= APL_NULL_STRING;
	char chr_l_other_dpid[21]=APL_NULL_STRING;
	char chr_l_batchseq[APL_DP_BATCH_NO_LEN]=APL_NULL_STRING;
	char chr_l_other_client_id1[14]=APL_NULL_STRING;
	char chr_l_broker_cd[11]= APL_NULL_STRING;
	char chr_l_rev_flg[2]=APL_NULL_STRING;
	char chr_l_dl_class[DL_DL_CLASS_LEN]=APL_NULL_STRING;

	
	short i_cmbp_id=0;
	short i_instr_isin=0;
	short i_dpid=0;
	short i_depo_part_code=0;
	short i_int_l_records=0;
	short i_l_tot_qty=0;
	short i_settlement_dt=0;
	short i_purchasesum=0;
	short i_salesum=0;
	short i_cln_depomap_id=0;
	short i_pool_depo=0;
	short i_other_client_id=0;
	short i_other_dpid=0;
	short i_other_client_id1=0;
	short i_broker_cd=0;
	short i_dl_class=0;
	

	SYS_DL_DEAL_STRUCT_H  *l_dl_deal_struct_h = NULL;
    SYS_DL_DEAL_STRUCT_I  *l_dl_deal_struct_i = NULL;	
		
	
	
	l_dl_deal_struct_h=(SYS_DL_DEAL_STRUCT_H *)calloc(1,sizeof(SYS_DL_DEAL_STRUCT_H));
	APL_MALLOC_FAIL(l_dl_deal_struct_h)
	l_dl_deal_struct_i=(SYS_DL_DEAL_STRUCT_I *)calloc(1,sizeof(SYS_DL_DEAL_STRUCT_I));
	APL_MALLOC_FAIL(l_dl_deal_struct_i)

	memset(l_dl_deal_struct_h, NULL, sizeof(SYS_DL_DEAL_STRUCT_H));
	memset(l_dl_deal_struct_i, NULL, sizeof(SYS_DL_DEAL_STRUCT_I));
		memset(chr_g_log_buffer,APL_NULL_CHAR,BUFFER_LEN);

	EXEC SQL BEGIN DECLARE SECTION;
		EXEC SQL VAR chr_p_depository_code_new IS STRING;
		EXEC SQL VAR chr_l_header IS STRING;
		EXEC SQL VAR chr_l_trailer IS STRING;
		EXEC SQL VAR chr_l_instruction_type IS STRING;
		
		EXEC SQL VAR chr_l_depo_part_code IS STRING;	
		EXEC SQL VAR chr_l_instr_isin IS STRING;
		EXEC SQL VAR chr_l_maker IS STRING;
		EXEC SQL VAR chr_l_maker_dt IS STRING;
		EXEC SQL VAR chr_l_access_stamp IS STRING;
		EXEC SQL VAR chr_l_settlement_dt IS STRING;
		EXEC SQL VAR chr_l_identiy_no IS STRING;
		EXEC SQL VAR chr_l_cln_depomap_id IS STRING;
		EXEC SQL VAR chr_l_identiy_t2t IS STRING;
		EXEC SQL VAR chr_l_pool_depo IS STRING;
		EXEC SQL VAR chr_l_other_dpid IS STRING;
		EXEC SQL VAR chr_l_other_client_id IS STRING;
		EXEC SQL VAR chr_l_other_client_id1 IS STRING;
		EXEC SQL VAR chr_l_broker_cd IS STRING;
		EXEC SQL VAR chr_l_dl_class IS STRING;
		
	EXEC SQL END DECLARE SECTION;
	

		  strcpy(chr_l_maker,chr_p_user);

		  if (  CO_RtvSysDt(pro_sys_date,l_debug_info_ptr) == APL_FAILURE )
		  {
            APL_GOBACK_FAIL
		  }
		  strcpy(chr_l_maker_dt,pro_sys_date);
		

		 if (  CO_RtvSysDtTime(pro_sys_date,l_debug_info_ptr) == APL_FAILURE )
         {
			 APL_GOBACK_FAIL
		 }
		 strcpy(chr_l_access_stamp,pro_sys_date);

		
	 	fprintf(g_flogfile,"InterDP:DVP:Inside Function Values Are .... \n");	 
	
		 
		fprintf(g_flogfile,"InterDP:DVP:chr_p_instr_type|%s|\n",chr_p_instr_type);	
		fprintf(g_flogfile,"InterDP:DVP:chr_p_trns_type|%s|\n",chr_p_trns_type);	
		fprintf(g_flogfile,"InterDP:DVP:chr_p_depository_code|%s|\n",chr_p_depository_code);	
		fprintf(g_flogfile,"InterDP:DVP:chr_p_file_type|%s|\n",chr_p_file_type);	
		fprintf(g_flogfile,"InterDP:DVP:chr_p_deal_date|%s|\n",chr_p_deal_date);	
		fprintf(g_flogfile,"InterDP:DVP:chr_p_exch_code|%s|\n",chr_p_exch_code);	
		fprintf(g_flogfile,"InterDP:DVP:chr_p_settlement_no|%s|\n",chr_p_settlement_no);	
		fprintf(g_flogfile,"InterDP:DVP:chr_p_mkt_type|%s|\n",chr_p_mkt_type);	
		fprintf(g_flogfile,"InterDP:DVP:chr_p_dp_id|%s|\n",chr_p_dp_id);	
	 
		EXEC SQL SELECT DECODE(:chr_p_depository_code,'N','NSDL','C','CDSL')
						INTO :chr_p_depository_code_new FROM dual;
		IS_ANY_ORA_ERROR

		

		

		  EXEC SQL SELECT COUNT(*),NVL(SUM(X.tot_qty),0) INTO :int_l_records:i_int_l_records,:l_tot_qty:i_l_tot_qty
		FROM (SELECT COUNT(*),DECODE(:chr_p_instr_type,'I',NVL(SUM(f.qty),0),'O',NVL(SUM(a.qty),0)) AS tot_qty 
			  FROM Dl_Deal a , mt_instrument c,mt_cli_depo_map d,dl_dpgen_det f,dl_markshortage g
			  WHERE a.client=f.dl_client
				AND a.identiy_no=f.dl_ref_no
				AND NVL(f.gendp_flg,'N')='Y'
				AND a.client=d.cln_code
				AND a.instr_code=c.instr_code
				AND d.cln_depo_code=:chr_p_depository_code_new
				AND g.depo_code!=:chr_p_depository_code_new
				AND d.cln_depo_map_dp_id=:chr_p_dp_id
				AND a.client=g.dl_client
				AND a.identiy_no=g.dl_ref_no
				AND NVL(g.pool_trans,'N')='Y'
				AND (a.deal_cd = DECODE(:chr_p_instr_type,'I','1','O','2') OR
									a.deal_cd = DECODE(:chr_p_instr_type,'I','3','O','4'))
				AND a.exch_code=:chr_p_exch_code
				AND a.settlement_no=:chr_p_settlement_no
				AND a.mkt_type=:chr_p_mkt_type
				AND TO_CHAR(deal_date,'DD/MM/YYYY')=:chr_p_deal_date
				AND a.clh_flg=:chr_p_trns_type
				AND ( a.deal_stat=DECODE(:chr_p_instr_type,'O','CC','I','MS') OR a.deal_stat=DECODE(:chr_p_instr_type,'O','CC','I','CC'))
            //	AND a.deal_stat='CC'
				AND a.mkt_type!=DECODE(a.exch_code,'NSE','22','BSE','16','MCS','03') /*Added by PT MCS*/
				AND a.NDS_BLK_DT is null
			GROUP BY a.client,d.cln_depo_map_client_id,a.instr_code,a.exch_code,
				a.settlement_no,a.mkt_type,a.deal_cd,c.instr_isin,a.setl_date,
				f.broker_cmbpid,f.cp_clnid,f.broker_dpid,f.cp_dpid,a.ex_arena,f.exec_dt,g.depo_code,a.domestic_cpclt,a.dl_class) X;


		  if(int_l_records==0)
		 {
			 fprintf(g_flogfile,"InterDP:DVP: NO Records Found For the Given Criteria !!!");
			  chr_l_flg='N';
		  }

		  IS_ANY_ORA_ERROR

		  printf("No Of InterDP:DVP Records|%d| \n",int_l_records);
		  sprintf(chr_g_log_buffer,"\n No Of InterDP:DVP Records|%d|",int_l_records);	
		  fprintf(g_flogfile,"%s",chr_g_log_buffer);

	  if(chr_l_flg== 'Y')
	  {
			EXEC SQL SELECT DL_DPINSTRSEQ.NEXTVAL INTO :int_l_batchseq FROM DUAL;
			IS_ANY_ORA_ERROR

			strcpy(chr_l_batchseq,"I");
			strcat(chr_l_batchseq,(char*)ltoa(int_l_batchseq));


		  printf("batch_no is %s\n",chr_l_batchseq);
		  printf("chr_p_dp_id is %s\n",chr_p_dp_id);
		  printf("int_l_records is %d\n",int_l_records);
		  printf("l_tot_qty is %f\n",l_tot_qty);//AIX Warning Removal
		  printf("int_l_batchseq=|%d| \n",int_l_batchseq);
		  printf("chr_l_maker=|%s| \n",chr_l_maker);
		  printf("chr_l_maker_dt=|%s| \n",chr_l_maker_dt);
		  printf("chr_l_access_stamp=|%s| \n",chr_l_access_stamp);
		  
		  /*Changed by Narendra Kumar for ISKB_3298 -- Static data change -- change of DP role from 04 to 01 -- Started*/

			/*EXEC SQL INSERT INTO dl_dpinstr_hdr
						(batch_no,record_type,dp_id,dp_role,buy_sell_flg,status,tot_num_record,
						 tot_qty,maker,maker_date,access_stamp)
			 			 VALUES(:chr_l_batchseq,01,:chr_p_dp_id,04,'B',
								 'G',:int_l_records,:l_tot_qty,:chr_l_maker,:chr_l_maker_dt,:chr_l_access_stamp);*/

			EXEC SQL INSERT INTO dl_dpinstr_hdr
						(batch_no,record_type,dp_id,dp_role,buy_sell_flg,status,tot_num_record,
						 tot_qty,maker,maker_date,access_stamp)
			 			 VALUES(:chr_l_batchseq,01,:chr_p_dp_id,01,'B',
								 'G',:int_l_records,:l_tot_qty,:chr_l_maker,:chr_l_maker_dt,:chr_l_access_stamp);

			/*Changed by Narendra Kumar for ISKB_3298 -- Static data change -- change of DP role from 04 to 01 -- Ended*/
			
			IS_ANY_ORA_ERROR
			
		printf("\n InterDP:DVP Cursor:After Inserting Header Record \n");

		
		
		fprintf(g_flogfile,"InterDP:DVP Cursor:After Inserting Header Record\n ");
		fflush(g_flogfile);
		


	 EXEC SQL DECLARE l_cur_dvp_interdp_instr  CURSOR FOR	
		 SELECT a.client,d.cln_depo_map_client_id,a.instr_code,a.exch_code,a.mkt_type,a.settlement_no,a.deal_cd,
				DECODE(:chr_p_instr_type,'I',NVL(SUM(f.qty),0),'O',NVL(SUM(f.qty),0)) AS QTY,
				DECODE(a.ex_arena,'2',f.cp_dpid,'1',f.broker_cmbpid) as CMBPID,
				DECODE(a.ex_arena,'2',f.cp_clnid,'1',f.broker_dpid) as DPID,
				c.instr_isin,
				f.exec_dt,
				g.depo_code,
				a.domestic_cpclt,
				a.dl_class
		FROM Dl_Deal a , mt_instrument c,mt_cli_depo_map d,dl_dpgen_det f,dl_markshortage g
			  WHERE a.client=f.dl_client
			AND a.identiy_no=f.dl_ref_no
			AND NVL(f.gendp_flg,'N')='Y'
			AND a.client=d.cln_code
			AND a.instr_code=c.instr_code
	 	    AND d.cln_depo_code=:chr_p_depository_code_new
	 	    AND g.depo_code!=:chr_p_depository_code_new
			AND d.cln_depo_map_dp_id=:chr_p_dp_id
			AND a.client=g.dl_client
			AND a.identiy_no=g.dl_ref_no
			AND NVL(g.pool_trans,'N')='Y'
			AND (a.deal_cd = DECODE(:chr_p_instr_type,'I','1','O','2') OR
			  					a.deal_cd = DECODE(:chr_p_instr_type,'I','3','O','4'))
			AND a.exch_code=:chr_p_exch_code
			AND a.settlement_no=:chr_p_settlement_no
			AND a.mkt_type=:chr_p_mkt_type
			AND TO_CHAR(deal_date,'DD/MM/YYYY')=:chr_p_deal_date
			AND a.clh_flg=:chr_p_trns_type
			AND ( a.deal_stat=DECODE(:chr_p_instr_type,'O','CC','I','MS') OR a.deal_stat=DECODE(:chr_p_instr_type,'O','CC','I','CC'))
//			AND a.deal_stat='CC'
			AND a.mkt_type!=DECODE(a.exch_code,'NSE','22','BSE','16','MCS','03') /*Added by PT MCS*/
			AND a.NDS_BLK_DT is null
		GROUP BY a.ex_arena,a.client,d.cln_depo_map_client_id,a.instr_code,a.exch_code,a.settlement_no,a.mkt_type,a.deal_cd,
				c.instr_isin,a.setl_date,
				f.broker_cmbpid,f.cp_clnid,f.broker_dpid,f.cp_dpid,f.exec_dt,g.depo_code,a.domestic_cpclt,a.dl_class;

	
	
		EXEC SQL OPEN l_cur_dvp_interdp_instr;
		IS_ANY_ORA_ERROR	
		
	   for(;;)
	   {
			memset(l_dl_deal_struct_h, NULL, sizeof(SYS_DL_DEAL_STRUCT_H));
			memset(l_dl_deal_struct_i, NULL, sizeof(SYS_DL_DEAL_STRUCT_I));
			memset(chr_l_refno_str,APL_NULL_CHAR,4001);

		EXEC SQL FETCH l_cur_dvp_interdp_instr INTO :l_dl_deal_struct_h->h_dl_client:l_dl_deal_struct_i->i_dl_client,
													:chr_l_cln_depomap_id:i_cln_depomap_id,	
													:l_dl_deal_struct_h->h_instr_code:l_dl_deal_struct_i->i_instr_code,
													:l_dl_deal_struct_h->h_exch_code:l_dl_deal_struct_i->i_exch_code,
													:l_dl_deal_struct_h->h_mkt_type:l_dl_deal_struct_i->i_mkt_type,	
													:l_dl_deal_struct_h->h_settlement_no:l_dl_deal_struct_i->i_settlement_no,
													:l_dl_deal_struct_h->h_dealcd:l_dl_deal_struct_i->i_dealcd,
													:l_dl_deal_struct_h->h_qty:l_dl_deal_struct_i->i_qty,
													:chr_l_cmbp_id:i_cmbp_id,
													:chr_l_dpid:i_dpid,
													:chr_l_instr_isin:i_instr_isin,
													:l_dl_deal_struct_h->h_setldt:l_dl_deal_struct_i->i_setldt,
													:chr_l_other_client_id:i_other_client_id,
													:chr_l_pool_depo:i_pool_depo,
													:chr_l_broker_cd:i_broker_cd,
													:chr_l_dl_class:i_dl_class;

			if(APL_ZERO_RESULT_SET)
		    {
			
			 if(counter==0)
			  {
					fprintf(g_flogfile," \n No Records Found in l_cur_dvp_interdp_instr CURSOR!" );
			  }
	 		  break;
		    }
		  	IS_ANY_ORA_ERROR

			counter++;
			

			sprintf(chr_l_internal_ref_no,"%s%d",chr_l_batchseq,counter);
			strcpy(chr_l_send_refno1,chr_l_internal_ref_no);

			sprintf(chr_g_log_buffer,"\n InterDP:DVP: Internal Ref No=|%s|",chr_l_internal_ref_no);	
			fprintf(g_flogfile,"%s",chr_g_log_buffer);


		 EXEC SQL SELECT :l_dl_deal_struct_h->h_dealcd INTO :chr_p_instr_type_new
								FROM dual;
		 
		 IS_ANY_ORA_ERROR 
		
		 
		
		strcpy(chr_l_instruction_type,"925");
		
		printf("\n INTERDP********chr_p_instr_type_new**************=|%c| \n",chr_p_instr_type_new);
		printf("\n INTERDP********chr_l_instruction_type**************=|%s| \n",chr_l_instruction_type);
		sprintf(chr_g_log_buffer,"\n InterDP:DVP -- DEAL CD=|%c|   chr_l_instruction_type=|%s|",chr_p_instr_type_new,chr_l_instruction_type);	
		fprintf(g_flogfile,"%s",chr_g_log_buffer);




/*	********************   Start Retriving IDENTIY_NO from dl_deal table *************** */
		printf("\n CLIENT=|%s| \n",l_dl_deal_struct_h->h_dl_client);


			EXEC SQL DECLARE l_cur_upd_interdp_dvp CURSOR FOR
				SELECT identiy_no
				FROM Dl_Deal a ,mt_instrument c,mt_cli_depo_map d,dl_dpgen_det f
				where a.client=d.cln_code
				and  a.client=:l_dl_deal_struct_h->h_dl_client
				 and a.instr_code=c.instr_code
				 and a.instr_code=:l_dl_deal_struct_h->h_instr_code
				 and a.identiy_no=f.dl_ref_no
				 AND a.client=f.dl_client
				 AND NVL(f.gendp_flg,'N')='Y'
				 AND a.exch_code=:l_dl_deal_struct_h->h_exch_code
				 AND settlement_no=:l_dl_deal_struct_h->h_settlement_no
				 AND a.mkt_type=:l_dl_deal_struct_h->h_mkt_type
				 AND a.mkt_type!=DECODE(a.exch_code,'NSE','22','BSE','16','MCS','03') /*Added by PT MCS*/
				 AND to_char(deal_date,'DD/MM/YYYY')=:chr_p_deal_date
				 AND a.deal_cd IN ('2','4')
				 AND d.CLN_DEPO_CODE=:chr_p_depository_code_new
			 	 AND d.CLN_DEPO_MAP_DP_ID=:chr_p_dp_id
				 AND a.clh_flg=:chr_p_trns_type
				 AND ( a.deal_stat=DECODE(:chr_p_instr_type,'O','CC','I','MS') OR a.deal_stat=DECODE(:chr_p_instr_type,'O','CC','I','CC'))
/*				 AND a.deal_stat='CC'
*/				 AND a.NDS_BLK_DT is null;	 
				 
			
	   EXEC SQL OPEN l_cur_upd_interdp_dvp;
		IS_ANY_ORA_ERROR

	   for(;;)
	   {

		  EXEC SQL FETCH l_cur_upd_interdp_dvp INTO :chr_l_identiy_no;
 
		  if(APL_ZERO_RESULT_SET)
		  {
			 if(counter==0)
			  {
					fprintf(g_flogfile,"No Records Found in l_cur_upd_interdp_dvp CURSOR! \n" );
			  }
			 break;

		  }
		  	IS_ANY_ORA_ERROR

			
		  if(l_dl_deal_struct_h->h_qty > 0)
		  {
			printf("\n [InterDP:DVP:NonT2T] Updating DP Generation Date for Account|%s|, RefNo|%s| with Date |%s|..",l_dl_deal_struct_h->h_dl_client,chr_l_identiy_no,chr_l_maker_dt);

			 fprintf(g_flogfile,"\n [InterDP:DVP:NonT2T] Updating DP Generation Date for Account|%s|, RefNo|%s| with Date |%s|",l_dl_deal_struct_h->h_dl_client,chr_l_identiy_no,chr_l_maker_dt);
			
			EXEC SQL UPDATE DL_DEAL SET NDS_BLK_DT=:chr_l_maker_dt WHERE
			identiy_no = :chr_l_identiy_no AND
			client=:l_dl_deal_struct_h->h_dl_client;
			if(sqlca.sqlcode)
			{
				fprintf(g_flogfile,"InterDP:DVP:Error Updating NDS_BLK_DT ORA|%d|\n",sqlca.sqlcode);
			}
		  	IS_ANY_ORA_ERROR

			printf("\n STRING counter=|%d| \n",counter);

			strcat(chr_l_refno_str,chr_l_identiy_no);
			strcat(chr_l_refno_str,",");

		  }
	
	  }

		EXEC SQL CLOSE l_cur_upd_interdp_dvp;
		IS_ANY_ORA_ERROR


		printf("\nInterDP:DVP: Deal String=|%s|\n",chr_l_refno_str);
		fprintf(g_flogfile,"\n Deal String is=|%s|",chr_l_refno_str); 


/*	********************   END Retriving IDENTIY_NO from dl_deal table *************** */

			

		
		sprintf(chr_g_log_buffer,"\n InterDP:DVP: Fetched Values: \n chr_l_cln_depomap_id=|%s|\n QTY=|%lf|\n EXCH_CODE=|%s| \n SETTLEMENT_NO=|%s| \n MKT_TYPE|%s| \n ISIN=|%s| \n CMBP_ID=|%s| \n Internal REEFNO=|%s|\n DEPOSITORY=|%s| \n",
								chr_l_cln_depomap_id,l_dl_deal_struct_h->h_qty,chr_p_exch_code,l_dl_deal_struct_h->h_settlement_no,
								l_dl_deal_struct_h->h_mkt_type,chr_l_instr_isin,chr_l_cmbp_id,chr_l_internal_ref_no,chr_p_depository_code_new);
	
		fprintf(g_flogfile,"%s",chr_g_log_buffer);
			
		printf("\n chr_l_maker_dt=|%s| \n",chr_l_maker_dt);
		printf("\n l_dl_deal_struct_h->h_instr_code=|%s| \n",l_dl_deal_struct_h->h_instr_code);
		printf("\n chr_l_access_stamp=|%s| \n",chr_l_access_stamp);
		printf("\n chr_l_maker=|%s| \n",chr_l_maker);
		printf("\n chr_l_internal_ref_no=|%s| \n",chr_l_internal_ref_no);
		printf("\n chr_l_instr_isin=|%s| \n",chr_l_instr_isin);
		printf("\n chr_l_cln_depomap_id=|%s| \n",chr_l_cln_depomap_id);	


/*************** DVP:INTER-DEPOSITORY TRANSFER FROM NSDL POOL TO CDSL CLIENT	***************/

		if(strcmp(chr_p_depository_code_new,"CDSL")==0 && strcmp(chr_l_pool_depo,"NSDL")==0)
		{
				
			 strcpy(chr_l_instruction_type,"NC5");
			 strcpy(chr_l_rev_flg,"P");


			EXEC SQL SELECT PTY_DEPO_MAP_DP_ID,PTY_DEPO_MAP_CLIENT_ID INTO :chr_l_other_dpid:i_other_dpid,chr_l_other_client_id1:i_other_client_id1
						FROM mt_pty_depo_map
						WHERE pty_code=:chr_l_broker_cd
						AND depo_code='NSDL';

			IS_ANY_ORA_ERROR
			
			
/*** Find Broker/CP's NSDL CMBP/Client Id		*****/
			 
						
			
				 if(l_dl_deal_struct_h->h_qty > 0)
				 {
/*					 if(!strcmp(chr_l_dl_class,"59") && !strcmp(chr_p_exch_code,"BSE"))
						strcpy(l_dl_deal_struct_h->h_mkt_type,"4");
					else if(!strcmp(chr_l_dl_class,"59") && !strcmp(chr_p_exch_code,"NSE"))
						strcpy(l_dl_deal_struct_h->h_mkt_type,"14");
*/						
					fprintf(g_flogfile,"InterDP:DVP:NSDL1:Before Inserting Into DL_DPINSTRS\n");

					EXEC SQL INSERT INTO DL_DPINSTRS
					(batch_no,serial_no,trans_type,client,instr_code,qty,exch_code,mkt_type,settlement_no,setl_date,isin_cd,
					clh_dvp,cmbp_id,dpm_trans_no,rev_flg,other_branch_cd,other_client_id,other_mkt_type,
					other_stlmnt_no,internal_ref_no,send_ref_1,send_ref_2,maker,maker_date,checker,checker_date,
					access_stamp,status,depo_ind,deal_ref_nos,deal_cd,other_dp_id,client_code)
					VALUES(:chr_l_batchseq,:counter,:chr_l_instruction_type,:chr_l_other_client_id1,
					:l_dl_deal_struct_h->h_instr_code,:l_dl_deal_struct_h->h_qty,:chr_p_exch_code,
					:l_dl_deal_struct_h->h_mkt_type,:l_dl_deal_struct_h->h_settlement_no,:l_dl_deal_struct_h->h_setldt,
					:chr_l_instr_isin,'D',:chr_l_cln_depomap_id,NULL,:chr_l_rev_flg,NULL,:chr_l_cmbp_id,NULL,NULL,:chr_l_internal_ref_no,
					:chr_l_send_refno1,NULL,:chr_l_maker,:chr_l_maker_dt,NULL,NULL,:chr_l_access_stamp,'G',
					:chr_p_depository_code_new,:chr_l_refno_str,:l_dl_deal_struct_h->h_dealcd,:chr_p_dp_id,:l_dl_deal_struct_h->h_dl_client);

					IS_ANY_ORA_ERROR																							

					sprintf(chr_g_log_buffer,"InterDP Cursor:DVP:After Inserting Details Record for client=|%s|",l_dl_deal_struct_h->h_dl_client);	
					fprintf(g_flogfile,"%s",chr_g_log_buffer);
				}
				else if(l_dl_deal_struct_h->h_qty ==  0)
				{
					counter--; //Added by Prateek on 30092014 for ISKB_6847(Serial number is coming wrong in Handoff file)
					int_l_zero_qty++;
					sprintf(chr_g_log_buffer,"ZERO QUANTITY FOR Client=|%s| Instrument=|%s| \n",l_dl_deal_struct_h->h_dl_client,l_dl_deal_struct_h->h_instr_code);
					fprintf(g_flogfile,"%s",chr_g_log_buffer);
					
				}	
			
				 strcpy(chr_l_instruction_type,"NC6");


				 if(l_dl_deal_struct_h->h_qty > 0)
				 {

					counter++;

/*					if(!strcmp(chr_l_dl_class,"59") && !strcmp(chr_p_exch_code,"BSE"))
						strcpy(l_dl_deal_struct_h->h_mkt_type,"4");
					else if(!strcmp(chr_l_dl_class,"59") && !strcmp(chr_p_exch_code,"NSE"))
						strcpy(l_dl_deal_struct_h->h_mkt_type,"14");
*/
					fprintf(g_flogfile,"\n InterDP:DVP:NSDL2:Before Inserting Into DL_DPINSTRS\n");

					EXEC SQL INSERT INTO DL_DPINSTRS
					(batch_no,serial_no,trans_type,client,instr_code,qty,exch_code,mkt_type,settlement_no,setl_date,isin_cd,
					clh_dvp,cmbp_id,dpm_trans_no,rev_flg,other_branch_cd,other_client_id,other_mkt_type,
					other_stlmnt_no,internal_ref_no,send_ref_1,send_ref_2,maker,maker_date,checker,checker_date,
					access_stamp,status,depo_ind,deal_ref_nos,deal_cd,other_dp_id,client_code)

					VALUES(:chr_l_batchseq,:counter,:chr_l_instruction_type,LPAD(:chr_l_cln_depomap_id,8,'0')||LPAD(:chr_p_dp_id,8,'0'),
					:l_dl_deal_struct_h->h_instr_code,:l_dl_deal_struct_h->h_qty,:chr_p_exch_code,
					:l_dl_deal_struct_h->h_mkt_type,:l_dl_deal_struct_h->h_settlement_no,:l_dl_deal_struct_h->h_setldt,
					:chr_l_instr_isin,'D',:chr_l_cmbp_id,NULL,NULL,NULL,:chr_l_other_client_id1,NULL,NULL,:chr_l_internal_ref_no,
					:chr_l_send_refno1,NULL,:chr_l_maker,:chr_l_maker_dt,NULL,NULL,:chr_l_access_stamp,'G',
					:chr_p_depository_code_new,:chr_l_refno_str,:l_dl_deal_struct_h->h_dealcd,:chr_l_other_dpid,:l_dl_deal_struct_h->h_dl_client);

					IS_ANY_ORA_ERROR																							

					sprintf(chr_g_log_buffer,"InterDP Cursor:DVP:After Inserting Details Record for client=|%s|",l_dl_deal_struct_h->h_dl_client);	
					fprintf(g_flogfile,"%s",chr_g_log_buffer);
				}
				else if(l_dl_deal_struct_h->h_qty ==  0)
				{
					counter--; //Added by Prateek on 30092014 for ISKB_6847(Serial number is coming wrong in Handoff file)
					int_l_zero_qty++;
					sprintf(chr_g_log_buffer,"ZERO QUANTITY FOR Client=|%s| Instrument=|%s| \n",l_dl_deal_struct_h->h_dl_client,l_dl_deal_struct_h->h_instr_code);
					fprintf(g_flogfile,"%s",chr_g_log_buffer);
					
				}	


		 }


/*************** DVP:INTER-DEPOSITORY TRANSFER FROM CDSL POOL TO NSDL CLIENT	***************/
		
		if(strcmp(chr_p_depository_code_new,"NSDL")==0 && strcmp(chr_l_pool_depo,"CDSL")==0)
		{
				
			 strcpy(chr_l_instruction_type,"CN6");


				
			EXEC SQL SELECT PTY_DEPO_MAP_DP_ID,PTY_DEPO_MAP_CLIENT_ID INTO :chr_l_other_dpid:i_other_dpid,chr_l_other_client_id1:i_other_client_id1
						FROM mt_pty_depo_map
						WHERE pty_code=:chr_l_broker_cd
						AND depo_code='CDSL';

				IS_ANY_ORA_ERROR

				
				 if(l_dl_deal_struct_h->h_qty > 0)
				 {
					
/*					if(!strcmp(chr_l_dl_class,"59") && !strcmp(chr_p_exch_code,"BSE"))
						strcpy(l_dl_deal_struct_h->h_mkt_type,"4");
					else if(!strcmp(chr_l_dl_class,"59") && !strcmp(chr_p_exch_code,"NSE"))
						strcpy(l_dl_deal_struct_h->h_mkt_type,"14");
*/
					fprintf(g_flogfile,"InterDP:DVP:CDSL1:Before Inserting Into DL_DPINSTRS\n");

					EXEC SQL INSERT INTO DL_DPINSTRS
					(batch_no,serial_no,trans_type,client,instr_code,qty,exch_code,mkt_type,settlement_no,setl_date,isin_cd,
					clh_dvp,cmbp_id,dpm_trans_no,rev_flg,other_branch_cd,other_client_id,other_mkt_type,
					other_stlmnt_no,internal_ref_no,send_ref_1,send_ref_2,maker,maker_date,checker,checker_date,
					access_stamp,status,depo_ind,deal_ref_nos,deal_cd,other_dp_id,client_code)

					VALUES(:chr_l_batchseq,:counter,:chr_l_instruction_type,:chr_l_cln_depomap_id,
					:l_dl_deal_struct_h->h_instr_code,:l_dl_deal_struct_h->h_qty,:chr_p_exch_code,
					:l_dl_deal_struct_h->h_mkt_type,:l_dl_deal_struct_h->h_settlement_no,:l_dl_deal_struct_h->h_setldt,
					:chr_l_instr_isin,'D',:chr_l_cmbp_id,NULL,NULL,NULL,:chr_l_other_client_id1,NULL,NULL,:chr_l_internal_ref_no,
					:chr_l_send_refno1,NULL,:chr_l_maker,:chr_l_maker_dt,NULL,NULL,:chr_l_access_stamp,'G',
					:chr_p_depository_code_new,:chr_l_refno_str,:l_dl_deal_struct_h->h_dealcd,:chr_l_other_dpid,:l_dl_deal_struct_h->h_dl_client);

					IS_ANY_ORA_ERROR																							

					sprintf(chr_g_log_buffer,"InterDP Cursor:DVP:After Inserting Details Record for client=|%s|",l_dl_deal_struct_h->h_dl_client);	
					fprintf(g_flogfile,"%s",chr_g_log_buffer);
				}
				else if(l_dl_deal_struct_h->h_qty ==  0)
				{
					counter--; //Added by Prateek on 30092014 for ISKB_6847(Serial number is coming wrong in Handoff file)
					int_l_zero_qty++;
					sprintf(chr_g_log_buffer,"ZERO QUANTITY FOR Client=|%s| Instrument=|%s| \n",l_dl_deal_struct_h->h_dl_client,l_dl_deal_struct_h->h_instr_code);
					fprintf(g_flogfile,"%s",chr_g_log_buffer);
					
				}	
			
				 strcpy(chr_l_instruction_type,"CN5");
				 strcpy(chr_l_rev_flg,"P");

				 if(l_dl_deal_struct_h->h_qty > 0)
				 {

					counter++;

/*					if(!strcmp(chr_l_dl_class,"59") && !strcmp(chr_p_exch_code,"BSE"))
						strcpy(l_dl_deal_struct_h->h_mkt_type,"4");
					else if(!strcmp(chr_l_dl_class,"59") && !strcmp(chr_p_exch_code,"NSE"))
						strcpy(l_dl_deal_struct_h->h_mkt_type,"14");
*/
					fprintf(g_flogfile,"\n InterDP:DVP:CDSL2:Before Inserting Into DL_DPINSTRS\n");

					EXEC SQL INSERT INTO DL_DPINSTRS
					(batch_no,serial_no,trans_type,client,instr_code,qty,exch_code,mkt_type,settlement_no,setl_date,isin_cd,
					clh_dvp,cmbp_id,dpm_trans_no,rev_flg,other_branch_cd,other_client_id,other_mkt_type,
					other_stlmnt_no,internal_ref_no,send_ref_1,send_ref_2,maker,maker_date,checker,checker_date,
					access_stamp,status,depo_ind,deal_ref_nos,deal_cd,other_dp_id,client_code)

					VALUES(:chr_l_batchseq,:counter,:chr_l_instruction_type,LPAD(:chr_l_other_dpid,8,'0')||LPAD(:chr_l_other_client_id1,8,'0'),
					:l_dl_deal_struct_h->h_instr_code,:l_dl_deal_struct_h->h_qty,:chr_p_exch_code,
					:l_dl_deal_struct_h->h_mkt_type,:l_dl_deal_struct_h->h_settlement_no,:l_dl_deal_struct_h->h_setldt,
					:chr_l_instr_isin,'D',:chr_l_cmbp_id,NULL,:chr_l_rev_flg,NULL,:chr_l_cln_depomap_id,NULL,NULL,:chr_l_internal_ref_no,
					:chr_l_send_refno1,NULL,:chr_l_maker,:chr_l_maker_dt,NULL,NULL,:chr_l_access_stamp,'G',
					:chr_p_depository_code_new,:chr_l_refno_str,:l_dl_deal_struct_h->h_dealcd,:chr_l_dpid,:l_dl_deal_struct_h->h_dl_client);

					IS_ANY_ORA_ERROR																							

					sprintf(chr_g_log_buffer,"InterDP Cursor:DVP:After Inserting Details Record for client=|%s|",l_dl_deal_struct_h->h_dl_client);	
					fprintf(g_flogfile,"%s",chr_g_log_buffer);
				}
				else if(l_dl_deal_struct_h->h_qty ==  0)
				{
					counter--; //Added by Prateek on 30092014 for ISKB_6847(Serial number is coming wrong in Handoff file)
					int_l_zero_qty++;
					sprintf(chr_g_log_buffer,"ZERO QUANTITY FOR Client=|%s| Instrument=|%s| \n",l_dl_deal_struct_h->h_dl_client,l_dl_deal_struct_h->h_instr_code);
					fprintf(g_flogfile,"%s",chr_g_log_buffer);
					
				}	


		 }

		strcpy(chr_l_refno_str,APL_NULL_STRING);
			
	}
	EXEC SQL CLOSE l_cur_dvp_interdp_instr;
	IS_ANY_ORA_ERROR

		
		if(strcmp(chr_p_instr_type,"I")==0)
		{
			int_l_deliver_qty=l_tot_qty;
		}
		else if(strcmp(chr_p_instr_type,"O")==0)	
		{
			int_l_receive_qty=l_tot_qty;
		}

	
		EXEC SQL INSERT INTO
	  			dl_dpinstr_trail(batch_no,record_type,branch_cd,deliver_qty,receive_qty,tot_qty,status,maker,maker_date,access_stamp)
							 VALUES(:chr_l_batchseq,99,'000',//:g_mt_commonsys_params_struct_h.brnch_cd,
									  :int_l_deliver_qty,:int_l_receive_qty,:l_tot_qty,'G',:chr_l_maker,
									  :chr_l_maker_dt,:chr_l_access_stamp);

		IS_ANY_ORA_ERROR	


		EXEC SQL UPDATE dl_dpinstr_hdr SET TOT_NUM_RECORD= TOT_NUM_RECORD - :int_l_zero_qty WHERE batch_no=:chr_l_batchseq;
		IS_ANY_ORA_ERROR

			
		fprintf(g_flogfile,"InterDP:DVP:No of Zero Quantity Records=|%d| \n",int_l_zero_qty);	
			
			
 }	
 

/* **************** PROCESSING FOR T2T SEGMENT TRADES ******************** */
/*** 
 if(strcmp(chr_p_instr_type,"I")==0 && ((strcmp(chr_p_mkt_type,"22")==0 && strcmp(chr_p_exch_code,"NSE")==0) || (strcmp(chr_p_mkt_type,"16")==0 && strcmp(chr_p_exch_code,"BSE")==0 )))
 {
***/
	chr_l_flg='Y';

	fprintf(g_flogfile,"InterDP:DVP RECORDS:T2T: PROCESSING FOR T2T SEGMENT TRADES ");
	
	EXEC SQL SELECT COUNT(*),DECODE(:chr_p_instr_type,'I',NVL(SUM(f.qty),0),'O',NVL(SUM(f.qty),0)) AS tot_qty 
			 INTO :int_l_records:i_int_l_records,:l_tot_qty:i_l_tot_qty
			 FROM Dl_Deal a , mt_instrument c,mt_cli_depo_map d,dl_dpgen_det f,dl_markshortage g
			  WHERE a.client=f.dl_client
			AND a.identiy_no=f.dl_ref_no
			AND NVL(f.gendp_flg,'N')='Y'
			AND a.client=d.cln_code
			AND a.instr_code=c.instr_code
	 	    AND d.cln_depo_code=:chr_p_depository_code_new
			AND g.depo_code!=:chr_p_depository_code_new
			AND a.client=g.dl_client
			AND a.identiy_no=g.dl_ref_no
			AND NVL(g.pool_trans,'N')='Y'
			AND a.deal_cd  IN('2','4')
			AND a.exch_code=:chr_p_exch_code
			AND a.settlement_no=:chr_p_settlement_no
			AND a.mkt_type=DECODE(:chr_p_exch_code,'NSE','22','BSE','16','MCS','03')
			AND TO_CHAR(deal_date,'DD/MM/YYYY')=:chr_p_deal_date
			AND a.clh_flg=:chr_p_trns_type
			AND ( a.deal_stat=DECODE(:chr_p_instr_type,'O','CC','I','MS') OR a.deal_stat=DECODE(:chr_p_instr_type,'O','CC','I','CC'))
/*			AND a.deal_stat='CC'
*/			AND a.NDS_BLK_DT is null;


		  if(int_l_records==0)
		 {
			 fprintf(g_flogfile,"InterDP:DVP:T2T: NO Records Found For the Given Criteria !!!");
			  chr_l_flg='N';
		  }

		  IS_ANY_ORA_ERROR


	if(chr_l_flg=='Y')
	{

		EXEC SQL SELECT DL_DPINSTRSEQ.NEXTVAL INTO :chr_l_batchseq FROM DUAL;
			IS_ANY_ORA_ERROR
			
		strcpy(chr_l_batchseq,"I");
	   strcat(chr_l_batchseq,(char*)ltoa(int_l_batchseq));
		
		/*Changed by Narendra Kumar for ISKB_3298 -- Static data change -- change of DP role from 04 to 01 -- Started*/

		/*EXEC SQL INSERT INTO dl_dpinstr_hdr
				(batch_no,record_type,dp_id,dp_role,status,buy_sell_flg,tot_num_record,tot_qty,maker,maker_date,access_stamp)
				 VALUES(:chr_l_batchseq,01,:chr_p_dp_id,04,'G','B',
						:int_l_records,:l_tot_qty,:chr_l_maker,:chr_l_maker_dt,:chr_l_access_stamp);*/

		EXEC SQL INSERT INTO dl_dpinstr_hdr
				(batch_no,record_type,dp_id,dp_role,status,buy_sell_flg,tot_num_record,tot_qty,maker,maker_date,access_stamp)
				 VALUES(:chr_l_batchseq,01,:chr_p_dp_id,01,'G','B',
						:int_l_records,:l_tot_qty,:chr_l_maker,:chr_l_maker_dt,:chr_l_access_stamp);

		/*Changed by Narendra Kumar for ISKB_3298 -- Static data change -- change of DP role from 04 to 01 -- Ended*/

		IS_ANY_ORA_ERROR
				
		fprintf(g_flogfile,"InterDP:DVP:T2T:After Inserting Header Record");


		 EXEC SQL DECLARE l_cur_gen_dvp_interdp_T2T CURSOR FOR	
		 SELECT a.identiy_no,a.client,d.cln_depo_map_client_id,a.instr_code,a.exch_code,a.mkt_type,a.settlement_no,a.deal_cd,
				DECODE(:chr_p_instr_type,'I',NVL(f.qty,0),'O',NVL(f.qty,0)) AS QTY,
				DECODE(a.ex_arena,'2',f.cp_dpid,f.broker_cmbpid) as CMBPID,
				DECODE(a.ex_arena,'2',f.cp_clnid,f.broker_dpid) as DPID,	
				c.instr_isin,
				f.exec_dt
		FROM Dl_Deal a , mt_instrument c,mt_cli_depo_map d,dl_dpgen_det f,dl_markshortage g
			  WHERE a.client=f.dl_client
			AND a.identiy_no=f.dl_ref_no
			AND NVL(f.gendp_flg,'N')='Y'
			AND a.client=d.cln_code
			AND a.instr_code=c.instr_code
	 	    AND d.cln_depo_code=:chr_p_depository_code_new
  		    AND g.depo_code!=:chr_p_depository_code_new
			AND a.client=g.dl_client
		    AND a.identiy_no=g.dl_ref_no
	  	    AND NVL(g.pool_trans,'N')='N'
			AND a.deal_cd IN('2,','4')
			AND a.exch_code=:chr_p_exch_code
			AND a.settlement_no=:chr_p_settlement_no
			AND a.mkt_type=DECODE(:chr_p_exch_code,'NSE','22','BSE','16','MCS','03')
			AND TO_CHAR(deal_date,'DD/MM/YYYY')=:chr_p_deal_date
			AND a.clh_flg=:chr_p_trns_type
			AND ( a.deal_stat=DECODE(:chr_p_instr_type,'O','CC','I','MS') OR a.deal_stat=DECODE(:chr_p_instr_type,'O','CC','I','CC'))
/*			AND a.deal_stat='CC' 
*/			AND a.NDS_BLK_DT is null;

	
	
		EXEC SQL OPEN l_cur_gen_dvp_interdp_T2T;
		IS_ANY_ORA_ERROR
		fflush(g_flogfile);
	   for(;;)
	   {
			memset(l_dl_deal_struct_h, NULL, sizeof(SYS_DL_DEAL_STRUCT_H));
			memset(l_dl_deal_struct_i, NULL, sizeof(SYS_DL_DEAL_STRUCT_I));

		EXEC SQL FETCH l_cur_gen_dvp_interdp_T2T INTO	:l_dl_deal_struct_h->h_indentity_no:l_dl_deal_struct_i->i_indentity_no,
												:l_dl_deal_struct_h->h_dl_client:l_dl_deal_struct_i->i_dl_client,
												:chr_l_cln_depomap_id:i_cln_depomap_id,	
												:l_dl_deal_struct_h->h_instr_code:l_dl_deal_struct_i->i_instr_code,
												:l_dl_deal_struct_h->h_exch_code:l_dl_deal_struct_i->i_exch_code,
												:l_dl_deal_struct_h->h_mkt_type:l_dl_deal_struct_i->i_mkt_type,	
												:l_dl_deal_struct_h->h_settlement_no:l_dl_deal_struct_i->i_settlement_no,
												:l_dl_deal_struct_h->h_dealcd:l_dl_deal_struct_i->i_dealcd,
												:l_dl_deal_struct_h->h_qty:l_dl_deal_struct_i->i_qty,
												:chr_l_cmbp_id:i_cmbp_id,
												:chr_l_dpid:i_dpid,
												:chr_l_instr_isin:i_instr_isin,
												:l_dl_deal_struct_h->h_setldt:l_dl_deal_struct_i->i_setldt;
			if(APL_ZERO_RESULT_SET)
		    {
			
			 if(counter2==0)
			  {
					fprintf(g_flogfile,"No Records Found In l_cur_gen_dvp_interdp_T2T CURSOR !!! \n" );
			  }
	 		  break;
		    }
		  	IS_ANY_ORA_ERROR

			counter2++;
			

			sprintf(chr_l_internal_ref_no,"%s%d",chr_l_batchseq,counter2);
			strcpy(chr_l_send_refno1,chr_l_internal_ref_no);

			sprintf(chr_g_log_buffer,"InterDP:DVP:T2T Internal Ref No=|%s| \n",chr_l_internal_ref_no);	
			fprintf(g_flogfile,"%s",chr_g_log_buffer);


		 EXEC SQL SELECT :l_dl_deal_struct_h->h_dealcd INTO :chr_p_instr_type_new
								FROM dual;
		 
		 IS_ANY_ORA_ERROR 


		 strcpy(chr_l_identiy_t2t,l_dl_deal_struct_h->h_indentity_no);
		 strcat(chr_l_identiy_t2t,",");
	
		sprintf(chr_g_log_buffer,"InterDP:DVP:T2T:********DEAL CD=|%c| chr_l_identiy_t2t=|%s|********\n ",chr_p_instr_type_new,chr_l_identiy_t2t);
		fprintf(g_flogfile,"%s",chr_g_log_buffer);

		
	
		strcpy(chr_l_instruction_type,"925");
			

		sprintf(chr_g_log_buffer,"InterDP:DVP:T2T FETCHED VALUES ARE: \n IDENTIY_NO=|%s|\n chr_l_cln_depomap_id=|%s|\n QTY=|%lf|\n EXCH_CODE=|%s| \n SETTLEMENT_NO=|%s| \n MKT_TYPE|%s| \n ISIN=|%s| CMBP_ID=|%s| Internal REEFNO=|%s|\n DEPOSITORY=|%s| \n",
								l_dl_deal_struct_h->h_indentity_no,chr_l_cln_depomap_id,l_dl_deal_struct_h->h_qty,
								chr_p_exch_code,l_dl_deal_struct_h->h_settlement_no,l_dl_deal_struct_h->h_mkt_type,
								chr_l_instr_isin,chr_l_cmbp_id,chr_l_internal_ref_no,chr_p_depository_code_new);
	
		fprintf(g_flogfile,"%s",chr_g_log_buffer);
		
/*************** DVP:T2T : INTER-DEPOSITORY TRANSFER FROM NSDL POOL TO CDSL CLIENT	***************/


		if(strcmp(chr_p_depository_code_new,"CDSL")==0 && strcmp(chr_l_pool_depo,"NSDL")==0)
		{
				
			 strcpy(chr_l_instruction_type,"NC5");
			 strcpy(chr_l_rev_flg,"P");


			EXEC SQL SELECT PTY_DEPO_MAP_DP_ID,PTY_DEPO_MAP_CLIENT_ID INTO :chr_l_other_dpid:i_other_dpid,chr_l_other_client_id1:i_other_client_id1
						FROM mt_pty_depo_map
						WHERE pty_code=:chr_l_broker_cd
						AND depo_code='NSDL';

			IS_ANY_ORA_ERROR
			

				if(l_dl_deal_struct_h->h_qty > 0)
				{	
					
					if(!strcmp(l_dl_deal_struct_h->h_mkt_type,"16") && !strcmp(l_dl_deal_struct_h->h_exch_code,"BSE"))
					{
						strcpy(l_dl_deal_struct_h->h_mkt_type,"5");
					}
				
					fprintf(g_flogfile,"InterDP:DVP:T2T:NSDL1:Before Inserting Into DL_DPINSTRS\n");

					EXEC SQL INSERT INTO DL_DPINSTRS
					(batch_no,serial_no,trans_type,client,instr_code,qty,exch_code,mkt_type,settlement_no,setl_date,isin_cd,
					clh_dvp,cmbp_id,dpm_trans_no,rev_flg,other_branch_cd,other_client_id,other_mkt_type,
					other_stlmnt_no,internal_ref_no,send_ref_1,send_ref_2,maker,maker_date,checker,checker_date,
					access_stamp,status,depo_ind,deal_ref_nos,deal_cd,other_dp_id,client_code)
					VALUES(:chr_l_batchseq,:counter2,:chr_l_instruction_type,:chr_l_other_client_id1,:l_dl_deal_struct_h->h_instr_code,
						:l_dl_deal_struct_h->h_qty,:chr_p_exch_code,:l_dl_deal_struct_h->h_mkt_type,:l_dl_deal_struct_h->h_settlement_no,
					   :l_dl_deal_struct_h->h_setldt,:chr_l_instr_isin,'D',:chr_l_cln_depomap_id,NULL,:chr_l_rev_flg,NULL,:chr_l_cmbp_id,NULL,NULL,:chr_l_internal_ref_no,
					   :chr_l_send_refno1,NULL,:chr_l_maker,:chr_l_maker_dt,NULL,NULL,:chr_l_access_stamp,'G',
					   :chr_p_depository_code_new,:chr_l_identiy_t2t,:l_dl_deal_struct_h->h_dealcd,:chr_p_dp_id,:l_dl_deal_struct_h->h_dl_client);

					IS_ANY_ORA_ERROR

					 fprintf(g_flogfile,"\n [InterDP:DVP:T2T] Updating DP Generation Date for Account|%s|, RefNo|%s| with Date |%s|",l_dl_deal_struct_h->h_dl_client,chr_l_identiy_no,chr_l_maker_dt);
					
					EXEC SQL UPDATE DL_DEAL SET NDS_BLK_DT=:chr_l_maker_dt WHERE
					identiy_no = :l_dl_deal_struct_h->h_indentity_no AND
					client=:l_dl_deal_struct_h->h_dl_client;
					if(sqlca.sqlcode)
					{
						fprintf(g_flogfile,"InterDP:DVP:T2T:Error Updating NDS_BLK_DT ORA|%d|\n",sqlca.sqlcode);
					}
					IS_ANY_ORA_ERROR
			
				}
				else if(l_dl_deal_struct_h->h_qty ==  0)
				{
					counter2--; //Added by Prateek on 30092014 for ISKB_6847(Serial number is coming wrong in Handoff file)
					int_l_zero_qty++;
					sprintf(chr_g_log_buffer,"InterDP:DVP:T2T:ZERO QUANTITY FOR Client=|%s| Instrument=|%s| \n",l_dl_deal_struct_h->h_dl_client,l_dl_deal_struct_h->h_instr_code);
					fprintf(g_flogfile,"%s",chr_g_log_buffer);
				}

				strcpy(chr_l_instruction_type,"NC6");

				 if(l_dl_deal_struct_h->h_qty > 0)
				 {

					counter++;

					if(!strcmp(l_dl_deal_struct_h->h_mkt_type,"16") && !strcmp(l_dl_deal_struct_h->h_exch_code,"BSE"))
					{
						strcpy(l_dl_deal_struct_h->h_mkt_type,"5");
					}

					fprintf(g_flogfile,"\n InterDP:DVP:T2T:NSDL2:Before Inserting Into DL_DPINSTRS\n");
					
					EXEC SQL INSERT INTO DL_DPINSTRS
				   (batch_no,serial_no,trans_type,client,instr_code,qty,exch_code,mkt_type,settlement_no,setl_date,isin_cd,
				   clh_dvp,cmbp_id,dpm_trans_no,rev_flg,other_branch_cd,other_client_id,other_mkt_type,
				   other_stlmnt_no,internal_ref_no,send_ref_1,send_ref_2,maker,maker_date,checker,checker_date,
				   access_stamp,status,depo_ind,deal_ref_nos,deal_cd,other_dp_id,client_code)
				   VALUES(:chr_l_batchseq,:counter2,:chr_l_instruction_type,LPAD(:chr_l_cln_depomap_id,8,'0')||LPAD(:chr_p_dp_id,8,'0'),:l_dl_deal_struct_h->h_instr_code,
				   :l_dl_deal_struct_h->h_qty,:chr_p_exch_code,:l_dl_deal_struct_h->h_mkt_type,:l_dl_deal_struct_h->h_settlement_no,
				   :l_dl_deal_struct_h->h_setldt,:chr_l_instr_isin,'D',:chr_l_other_client_id1,NULL,NULL,NULL,:chr_l_other_client_id1,NULL,NULL,:chr_l_internal_ref_no,
				   :chr_l_send_refno1,NULL,:chr_l_maker,:chr_l_maker_dt,NULL,NULL,:chr_l_access_stamp,'G',
				   :chr_p_depository_code_new,:chr_l_identiy_t2t,:l_dl_deal_struct_h->h_dealcd,:chr_l_other_dpid,:l_dl_deal_struct_h->h_dl_client);
					
					IS_ANY_ORA_ERROR																							

					sprintf(chr_g_log_buffer,"InterDP Cursor:DVP:T2T:After Inserting Details Record for client=|%s|",l_dl_deal_struct_h->h_dl_client);	
					fprintf(g_flogfile,"%s",chr_g_log_buffer);

					EXEC SQL UPDATE DL_DEAL SET NDS_BLK_DT=:chr_l_maker_dt WHERE
					identiy_no = :l_dl_deal_struct_h->h_indentity_no AND
					client=:l_dl_deal_struct_h->h_dl_client;
					if(sqlca.sqlcode)
					{
						fprintf(g_flogfile,"InterDP:DVP:T2T:Error Updating NDS_BLK_DT ORA|%d|\n",sqlca.sqlcode);
					}
					IS_ANY_ORA_ERROR
			

					}
				else if(l_dl_deal_struct_h->h_qty ==  0)
				{
					counter2--; //Added by Prateek on 30092014 for ISKB_6847(Serial number is coming wrong in Handoff file)
					int_l_zero_qty++;
					sprintf(chr_g_log_buffer,"ZERO QUANTITY FOR Client=|%s| Instrument=|%s| \n",l_dl_deal_struct_h->h_dl_client,l_dl_deal_struct_h->h_instr_code);
					fprintf(g_flogfile,"%s",chr_g_log_buffer);
					
				}	

		}


/*************** DVP:INTER-DEPOSITORY TRANSFER FROM CDSL POOL TO NSDL CLIENT	***************/
		
		if(strcmp(chr_p_depository_code_new,"NSDL")==0 && strcmp(chr_l_pool_depo,"CDSL")==0)
		{
				
			 strcpy(chr_l_instruction_type,"CN6");


				
			EXEC SQL SELECT PTY_DEPO_MAP_DP_ID,PTY_DEPO_MAP_CLIENT_ID INTO :chr_l_other_dpid:i_other_dpid,chr_l_other_client_id1:i_other_client_id1
						FROM mt_pty_depo_map
						WHERE pty_code=:chr_l_broker_cd
						AND depo_code='CDSL';

				IS_ANY_ORA_ERROR

				 if(l_dl_deal_struct_h->h_qty > 0)
				 {
						
					if(!strcmp(l_dl_deal_struct_h->h_mkt_type,"16") && !strcmp(l_dl_deal_struct_h->h_exch_code,"BSE"))
					{
						strcpy(l_dl_deal_struct_h->h_mkt_type,"5");
					}
					fprintf(g_flogfile,"InterDP:DVP:T2T:CDSL1:Before Inserting Into DL_DPINSTRS\n");
				

					EXEC SQL INSERT INTO DL_DPINSTRS
					(batch_no,serial_no,trans_type,client,instr_code,qty,exch_code,mkt_type,settlement_no,setl_date,isin_cd,
					clh_dvp,cmbp_id,dpm_trans_no,rev_flg,other_branch_cd,other_client_id,other_mkt_type,
					other_stlmnt_no,internal_ref_no,send_ref_1,send_ref_2,maker,maker_date,checker,checker_date,
					access_stamp,status,depo_ind,deal_ref_nos,deal_cd,other_dp_id,client_code)
					VALUES(:chr_l_batchseq,:counter2,:chr_l_instruction_type,:chr_l_cln_depomap_id,:l_dl_deal_struct_h->h_instr_code,
						:l_dl_deal_struct_h->h_qty,:chr_p_exch_code,:l_dl_deal_struct_h->h_mkt_type,:l_dl_deal_struct_h->h_settlement_no,
					   :l_dl_deal_struct_h->h_setldt,:chr_l_instr_isin,'D',:chr_l_other_client_id1,NULL,NULL,NULL,:chr_l_cmbp_id,NULL,NULL,:chr_l_internal_ref_no,
					   :chr_l_send_refno1,NULL,:chr_l_maker,:chr_l_maker_dt,NULL,NULL,:chr_l_access_stamp,'G',
					   :chr_p_depository_code_new,:chr_l_identiy_t2t,:l_dl_deal_struct_h->h_dealcd,:chr_l_other_dpid,:l_dl_deal_struct_h->h_dl_client);

					IS_ANY_ORA_ERROR

					 fprintf(g_flogfile,"\n [InterDP:DVP:T2T] Updating DP Generation Date for Account|%s|, RefNo|%s| with Date |%s|",l_dl_deal_struct_h->h_dl_client,chr_l_identiy_no,chr_l_maker_dt);
					
					EXEC SQL UPDATE DL_DEAL SET NDS_BLK_DT=:chr_l_maker_dt WHERE
					identiy_no = :l_dl_deal_struct_h->h_indentity_no AND
					client=:l_dl_deal_struct_h->h_dl_client;
					if(sqlca.sqlcode)
					{
						fprintf(g_flogfile,"InterDP:DVP:T2T:Error Updating NDS_BLK_DT ORA|%d|\n",sqlca.sqlcode);
					}
					IS_ANY_ORA_ERROR
			
				}
				else if(l_dl_deal_struct_h->h_qty ==  0)
				{
					counter2--; //Added by Prateek on 30092014 for ISKB_6847(Serial number is coming wrong in Handoff file)
					int_l_zero_qty++;
					sprintf(chr_g_log_buffer,"InterDP:DVP:T2T:ZERO QUANTITY FOR Client=|%s| Instrument=|%s| \n",l_dl_deal_struct_h->h_dl_client,l_dl_deal_struct_h->h_instr_code);
					fprintf(g_flogfile,"%s",chr_g_log_buffer);
				}

				 strcpy(chr_l_instruction_type,"CN5");
				 strcpy(chr_l_rev_flg,"P");	

				 if(l_dl_deal_struct_h->h_qty > 0)
				 {

					counter++;

					if(!strcmp(l_dl_deal_struct_h->h_mkt_type,"16") && !strcmp(l_dl_deal_struct_h->h_exch_code,"BSE"))
					{
						strcpy(l_dl_deal_struct_h->h_mkt_type,"5");
					}

					fprintf(g_flogfile,"\n InterDP:DVP:T2T:CDSL2:Before Inserting Into DL_DPINSTRS\n");

					
						EXEC SQL INSERT INTO DL_DPINSTRS
					(batch_no,serial_no,trans_type,client,instr_code,qty,exch_code,mkt_type,settlement_no,setl_date,isin_cd,
					clh_dvp,cmbp_id,dpm_trans_no,rev_flg,other_branch_cd,other_client_id,other_mkt_type,
					other_stlmnt_no,internal_ref_no,send_ref_1,send_ref_2,maker,maker_date,checker,checker_date,
					access_stamp,status,depo_ind,deal_ref_nos,deal_cd,other_dp_id,client_code)
					VALUES(:chr_l_batchseq,:counter2,:chr_l_instruction_type,LPAD(:chr_l_other_dpid,8,'0')||LPAD(:chr_l_other_client_id1,8,'0'),:l_dl_deal_struct_h->h_instr_code,
					:l_dl_deal_struct_h->h_qty,:chr_p_exch_code,:l_dl_deal_struct_h->h_mkt_type,:l_dl_deal_struct_h->h_settlement_no,
				    :l_dl_deal_struct_h->h_setldt,:chr_l_instr_isin,'D',:chr_l_other_client_id1,NULL,:chr_l_rev_flg,NULL,:chr_l_cln_depomap_id,NULL,NULL,:chr_l_internal_ref_no,
				    :chr_l_send_refno1,NULL,:chr_l_maker,:chr_l_maker_dt,NULL,NULL,:chr_l_access_stamp,'G',
				    :chr_p_depository_code_new,:chr_l_identiy_t2t,:l_dl_deal_struct_h->h_dealcd,:chr_l_dpid,:l_dl_deal_struct_h->h_dl_client);

					IS_ANY_ORA_ERROR

					 fprintf(g_flogfile,"\n [InterDP:DVP:T2T] Updating DP Generation Date for Account|%s|, RefNo|%s| with Date |%s|",l_dl_deal_struct_h->h_dl_client,chr_l_identiy_no,chr_l_maker_dt);
					
					EXEC SQL UPDATE DL_DEAL SET NDS_BLK_DT=:chr_l_maker_dt WHERE
					identiy_no = :l_dl_deal_struct_h->h_indentity_no AND
					client=:l_dl_deal_struct_h->h_dl_client;
					if(sqlca.sqlcode)
					{
						fprintf(g_flogfile,"InterDP:DVP:T2T:Error Updating NDS_BLK_DT ORA|%d|\n",sqlca.sqlcode);
					}
					IS_ANY_ORA_ERROR
			
				}
				else if(l_dl_deal_struct_h->h_qty ==  0)
				{
					counter2 --; //Added by Prateek on 30092014 for ISKB_6847(Serial number is coming wrong in Handoff file)
					int_l_zero_qty++;
					sprintf(chr_g_log_buffer,"InterDP:DVP:T2T:ZERO QUANTITY FOR Client=|%s| Instrument=|%s| \n",l_dl_deal_struct_h->h_dl_client,l_dl_deal_struct_h->h_instr_code);
					fprintf(g_flogfile,"%s",chr_g_log_buffer);
				}
				
		}

	 }
	

	   EXEC SQL CLOSE l_cur_gen_dvp_interdp_T2T;
		IS_ANY_ORA_ERROR

		
		if(strcmp(chr_p_instr_type,"I")==0)
		{
			int_l_deliver_qty=l_tot_qty;
		}
		else if(strcmp(chr_p_instr_type,"O")==0)	
		{
			int_l_receive_qty=l_tot_qty;
		}
			
		
		EXEC SQL INSERT INTO
	  			dl_dpinstr_trail(batch_no,record_type,branch_cd,deliver_qty,receive_qty,										  											tot_qty,status,maker,maker_date,access_stamp)
							 VALUES(:chr_l_batchseq,99,'000',//:g_mt_commonsys_params_struct_h.brnch_cd,
									  :int_l_deliver_qty,:int_l_receive_qty,:l_tot_qty,'G',:chr_l_maker,
									  :chr_l_maker_dt,:chr_l_access_stamp);

		IS_ANY_ORA_ERROR	
		
		EXEC SQL UPDATE dl_dpinstr_hdr SET TOT_NUM_RECORD=TOT_NUM_RECORD - :int_l_zero_qty
	  				WHERE batch_no=:chr_l_batchseq;
		IS_ANY_ORA_ERROR										
		
		
		fprintf(g_flogfile,"InterDP:DVP:T2T:No of Zero Quantity Records=|%d| \n",int_l_zero_qty);	
			
	}
/***
 }
***/


/***
 if(strcmp(chr_p_instr_type,"I")==0 && ((strcmp(chr_p_mkt_type,"22")==0 && strcmp(chr_p_exch_code,"NSE")==0) || (strcmp(chr_p_mkt_type,"16")==0 && strcmp(chr_p_exch_code,"BSE")==0 )))
 {
	 chr_l_flg='Y';

	fprintf(g_flogfile,"InterDP:DVP RECORDS:T2T: PROCESSING FOR T2T SEGMENT TRADES ");
	
	EXEC SQL SELECT COUNT(*),DECODE(:chr_p_instr_type,'I',NVL(SUM(f.qty),0),'O',NVL(SUM(f.qty),0)) AS tot_qty 
			 INTO :int_l_records:i_int_l_records,:l_tot_qty:i_l_tot_qty
			 FROM Dl_Deal a , mt_instrument c,mt_cli_depo_map d,dl_dpgen_det f,dl_markshortage g
			  WHERE a.client=f.dl_client
			AND a.identiy_no=f.dl_ref_no
			AND NVL(f.gendp_flg,'N')='Y'
			AND a.client=d.cln_code
			AND a.instr_code=c.instr_code
	 	   AND d.cln_depo_code=:chr_p_depository_code_new
			AND a.client=g.dl_client
			AND a.identiy_no=g.dl_ref_no
			AND NVL(g.pool_trans,'N')='N'
			AND (a.deal_cd = DECODE(:chr_p_instr_type,'I','1','O','2') OR
			  					a.deal_cd = DECODE(:chr_p_instr_type,'I','3','O','4'))
			AND a.exch_code=:chr_p_exch_code
			AND a.settlement_no=:chr_p_settlement_no
			AND a.mkt_type=:chr_p_mkt_type
			AND TO_CHAR(deal_date,'DD/MM/YYYY')=:chr_p_deal_date
			AND a.clh_flg=:chr_p_trns_type
			AND a.deal_stat='CC' AND a.NDS_BLK_DT is null;


		  if(int_l_records==0)
		 {
			 fprintf(g_flogfile,"InterDP:DVP:T2T: NO Records Found For the Given Criteria !!!");
			  chr_l_flg='N';
		  }

		  IS_ANY_ORA_ERROR


	if(chr_l_flg=='Y')
	{

		EXEC SQL SELECT DL_DPINSTRSEQ.NEXTVAL INTO :chr_l_batchseq FROM DUAL;
			IS_ANY_ORA_ERROR
			


		EXEC SQL INSERT INTO dl_dpinstr_hdr
				(batch_no,record_type,dp_id,dp_role,status,buy_sell_flg,tot_num_record,tot_qty,maker,maker_date,access_stamp)
				 VALUES(:chr_l_batchseq,01,:chr_p_dp_id,04,'G',DECODE(:chr_p_instr_type,'I','S','O','B'),
						:int_l_records,:l_tot_qty,:chr_l_maker,:chr_l_maker_dt,:chr_l_access_stamp);

		IS_ANY_ORA_ERROR
				
		fprintf(g_flogfile,"InterDP:DVP:T2T:After Inserting Header Record");


		 EXEC SQL DECLARE l_cur_gen_dvp_T2T CURSOR FOR	
		 SELECT a.identiy_no,a.client,d.cln_depo_map_client_id,a.instr_code,a.exch_code,a.mkt_type,a.settlement_no,a.deal_cd,
				DECODE(:chr_p_instr_type,'I',NVL(f.qty,0),'O',NVL(f.qty,0)) AS QTY,
				DECODE(a.ex_arena,'2',f.cp_dpid,f.broker_cmbpid) as CMBPID,
				DECODE(a.ex_arena,'2',f.cp_clnid,f.broker_dpid) as DPID,	
				c.instr_isin,
				f.exec_dt
		FROM Dl_Deal a , mt_instrument c,mt_cli_depo_map d,dl_dpgen_det f,dl_markshortage g
			  WHERE a.client=f.dl_client
			AND a.identiy_no=f.dl_ref_no
			AND NVL(f.gendp_flg,'N')='Y'
			AND a.client=d.cln_code
			AND a.instr_code=c.instr_code
	 	   AND d.cln_depo_code=:chr_p_depository_code_new
			AND a.client=g.dl_client
		   AND a.identiy_no=g.dl_ref_no
	  	   AND NVL(g.pool_trans,'N')='N'
			AND (a.deal_cd = DECODE(:chr_p_instr_type,'I','1','O','2') OR
			  					a.deal_cd = DECODE(:chr_p_instr_type,'I','3','O','4'))
			AND a.exch_code=:chr_p_exch_code
			AND a.settlement_no=:chr_p_settlement_no
			AND a.mkt_type=:chr_p_mkt_type
			AND TO_CHAR(deal_date,'DD/MM/YYYY')=:chr_p_deal_date
			AND a.clh_flg=:chr_p_trns_type
			AND a.deal_stat='CC' AND a.NDS_BLK_DT is null;

	
	
		EXEC SQL OPEN l_cur_gen_dvp_T2T;
		IS_ANY_ORA_ERROR
		fflush(g_flogfile);
	   for(;;)
	   {
			memset(l_dl_deal_struct_h, NULL, sizeof(SYS_DL_DEAL_STRUCT_H));
			memset(l_dl_deal_struct_i, NULL, sizeof(SYS_DL_DEAL_STRUCT_I));

		EXEC SQL FETCH l_cur_gen_dvp_T2T INTO	:l_dl_deal_struct_h->h_indentity_no:l_dl_deal_struct_i->i_indentity_no,
												:l_dl_deal_struct_h->h_dl_client:l_dl_deal_struct_i->i_dl_client,
												:chr_l_cln_depomap_id:i_cln_depomap_id,	
												:l_dl_deal_struct_h->h_instr_code:l_dl_deal_struct_i->i_instr_code,
												:l_dl_deal_struct_h->h_exch_code:l_dl_deal_struct_i->i_exch_code,
												:l_dl_deal_struct_h->h_mkt_type:l_dl_deal_struct_i->i_mkt_type,	
												:l_dl_deal_struct_h->h_settlement_no:l_dl_deal_struct_i->i_settlement_no,
												:l_dl_deal_struct_h->h_dealcd:l_dl_deal_struct_i->i_dealcd,
												:l_dl_deal_struct_h->h_qty:l_dl_deal_struct_i->i_qty,
												:chr_l_cmbp_id:i_cmbp_id,
												:chr_l_dpid:i_dpid,
												:chr_l_instr_isin:i_instr_isin,
												:l_dl_deal_struct_h->h_setldt:l_dl_deal_struct_i->i_setldt;
			if(APL_ZERO_RESULT_SET)
		    {
			
			 if(counter2==0)
			  {
					fprintf(g_flogfile,"No Records Found In l_cur_gen_dvp_T2T CURSOR !!! \n" );
			  }
	 		  break;
		    }
		  	IS_ANY_ORA_ERROR

			counter2++;
			

			sprintf(chr_l_internal_ref_no,"%s%d",chr_l_batchseq,counter2);
			strcpy(chr_l_send_refno1,chr_l_internal_ref_no);

			sprintf(chr_g_log_buffer,"InterDP:DVP:T2T Internal Ref No=|%s| \n",chr_l_internal_ref_no);	
			fprintf(g_flogfile,"%s",chr_g_log_buffer);


		 EXEC SQL SELECT :l_dl_deal_struct_h->h_dealcd INTO :chr_p_instr_type_new
								FROM dual;
		 
		 IS_ANY_ORA_ERROR 


		 strcpy(chr_l_identiy_t2t,l_dl_deal_struct_h->h_indentity_no);
		 strcat(chr_l_identiy_t2t,",");
	
		sprintf(chr_g_log_buffer,"InterDP:DVP:T2T:********DEAL CD=|%c| chr_l_identiy_t2t=|%s|********\n ",chr_p_instr_type_new,chr_l_identiy_t2t);
		fprintf(g_flogfile,"%s",chr_g_log_buffer);

		
	
		strcpy(chr_l_instruction_type,"925");
			

		sprintf(chr_g_log_buffer,"InterDP:DVP: FETCHED VALUES ARE: \n IDENTIY_NO=|%s|\n chr_l_cln_depomap_id=|%s|\n QTY=|%lf|\n EXCH_CODE=|%s| \n SETTLEMENT_NO=|%s| \n MKT_TYPE|%s| \n ISIN=|%s| CMBP_ID=|%s| Internal REEFNO=|%s|\n DEPOSITORY=|%s| \n",
								l_dl_deal_struct_h->h_indentity_no,chr_l_cln_depomap_id,l_dl_deal_struct_h->h_qty,
								chr_p_exch_code,l_dl_deal_struct_h->h_settlement_no,l_dl_deal_struct_h->h_mkt_type,
								chr_l_instr_isin,chr_l_cmbp_id,chr_l_internal_ref_no,chr_p_depository_code_new);
	
		fprintf(g_flogfile,"%s",chr_g_log_buffer);
		
		if(l_dl_deal_struct_h->h_qty > 0)
		{	
		
			EXEC SQL INSERT INTO DL_DPINSTRS
			(batch_no,serial_no,trans_type,client,instr_code,qty,exch_code,mkt_type,settlement_no,setl_date,isin_cd,
			clh_dvp,cmbp_id,dpm_trans_no,rev_flg,other_branch_cd,other_client_id1,other_mkt_type,
			other_stlmnt_no,internal_ref_no,send_ref_1,send_ref_2,maker,maker_date,checker,checker_date,
			access_stamp,status,depo_ind,deal_ref_nos,deal_cd,other_dp_id)
			VALUES(:chr_l_batchseq,:counter2,:chr_l_instruction_type,:chr_l_cln_depomap_id,:l_dl_deal_struct_h->h_instr_code,
				:l_dl_deal_struct_h->h_qty,:chr_p_exch_code,:l_dl_deal_struct_h->h_mkt_type,:l_dl_deal_struct_h->h_settlement_no,
			   :l_dl_deal_struct_h->h_setldt,:chr_l_instr_isin,'D',:chr_l_cmbp_id,NULL,NULL,NULL,:chr_l_cmbp_id,NULL,NULL,:chr_l_internal_ref_no,
			   :chr_l_send_refno1,NULL,:chr_l_maker,:chr_l_maker_dt,NULL,NULL,:chr_l_access_stamp,'G',
			   :chr_p_depository_code_new,:chr_l_identiy_t2t,:l_dl_deal_struct_h->h_dealcd,:chr_l_dpid);

			IS_ANY_ORA_ERROR

			printf("\n [InterDP:DVP:T2T] Updating DP Generation Date for Account|%s|, RefNo|%s| with Date |%s|..",l_dl_deal_struct_h->h_dl_client,l_dl_deal_struct_h->h_indentity_no,chr_l_maker_dt);

			 fprintf(g_flogfile,"\n [InterDP:DVP:T2T] Updating DP Generation Date for Account|%s|, RefNo|%s| with Date |%s|",l_dl_deal_struct_h->h_dl_client,chr_l_identiy_no,chr_l_maker_dt);
			
			EXEC SQL UPDATE DL_DEAL SET NDS_BLK_DT=:chr_l_maker_dt WHERE
			identiy_no = :l_dl_deal_struct_h->h_indentity_no AND
			client=:l_dl_deal_struct_h->h_dl_client;
			if(sqlca.sqlcode)
			{
				fprintf(g_flogfile,"InterDP:DVP:T2T:Error Updating NDS_BLK_DT ORA|%d|\n",sqlca.sqlcode);
			}
			IS_ANY_ORA_ERROR
	
		}
		else if(l_dl_deal_struct_h->h_qty ==  0)
		{
			int_l_zero_qty++;
			sprintf(chr_g_log_buffer,"InterDP:DVP:T2T:ZERO QUANTITY FOR Client=|%s| Instrument=|%s| \n",l_dl_deal_struct_h->h_dl_client,l_dl_deal_struct_h->h_instr_code);
			fprintf(g_flogfile,"%s",chr_g_log_buffer);
		}
	 }
	

	   EXEC SQL CLOSE l_cur_gen_dvp_T2T;
		IS_ANY_ORA_ERROR

		
		if(strcmp(chr_p_instr_type,"I")==0)
		{
			int_l_deliver_qty=l_tot_qty;
		}
		else if(strcmp(chr_p_instr_type,"O")==0)	
		{
			int_l_receive_qty=l_tot_qty;
		}
			
		
		EXEC SQL INSERT INTO
	  			dl_dpinstr_trail(batch_no,record_type,branch_cd,deliver_qty,receive_qty,										  											tot_qty,status,maker,maker_date,access_stamp)
							 VALUES(:chr_l_batchseq,99,:g_mt_commonsys_params_struct_h.brnch_cd,
									  :int_l_deliver_qty,:int_l_receive_qty,:l_tot_qty,'G',:chr_l_maker,
									  :chr_l_maker_dt,:chr_l_access_stamp);

		IS_ANY_ORA_ERROR	
		
		EXEC SQL UPDATE dl_dpinstr_hdr SET TOT_NUM_RECORD=TOT_NUM_RECORD - :int_l_zero_qty
	  				WHERE batch_no=:chr_l_batchseq;
		IS_ANY_ORA_ERROR										
		
		
		fprintf(g_flogfile,"InterDP:DVP:T2T:No of Zero Quantity Records=|%d| \n",int_l_zero_qty);	
			
	}

 }

***/

	APL_GOBACK_SUCCESS							

	  RETURN_SUCCESS:
	  {
		CO_ProcMonitor(g_flogfile," Leaving Proc_GenInterDP_DVP_Instrn With Success",NULL,NULL);
		return(APL_SUCCESS);
	  }
	   
	  RETURN_FAILURE:
	 {
	   printf("\n Error Inside Proc_GenInterDP_DVP_Instrn:ORA|%d|\n",sqlca.sqlcode);
	   sprintf(chr_g_log_buffer,"Leaving Proc_GenInterDP_DVP_Instrn With Failure ORA|%d|\n",sqlca.sqlcode);	
	   CO_ProcMonitor(g_flogfile,chr_g_log_buffer,l_debug_info_ptr,NULL);
	   return(APL_FAILURE);	
	 }

 }	/*********** END DVP INTER DEPOSITORY FUNCTION ****************/

/* Modified by Minal for Implementation Of DIS in INTELLECT CUSTODY on 12/09/2014 */
/* Processing OFF MARKET Intra DP RECORDS - START */
int Proc_GenOffMkt_Instrn(char *chr_p_instr_type,
						char *chr_p_trns_type,
						char *chr_p_depository_code,
						char *chr_p_file_type,
						char *chr_p_deal_date,
						char *chr_p_dp_id,
						char *chr_p_user,
						char *chr_p_rectype,
						char *chr_p_transfer_reason_cd,
						char *chr_p_reason_purpose,
						FILE *g_flogfile,
						INTL_ENV_DATA_STRUCT_H *l_intl_env_data_h,
						DEBUG_INFO_STRUCT_H **l_debug_info_ptr)
{

	FILE  *l_ptr_ini_file = NULL;
	FILE  *l_ptr_handoff_file = NULL;
	char  chr_g_log_buffer[BUFFER_LEN] = APL_NULL_STRING;
	char  chr_l_inifile[100]= APL_NULL_STRING;
	char  chr_l_handoff_dir[PATH_LENGTH]= APL_NULL_STRING;
	char  chr_l_handoff_file_name[FILENAME_LEN_A]= APL_NULL_STRING;	
	char  chr_l_header[100]= APL_NULL_STRING;
	char  chr_l_trailer[200]= APL_NULL_STRING;
	char  chr_l_detail_rec[1000] =APL_NULL_STRING;
	int   int_l_batchseq=0;
	int   int_l_cdsl_batchseq = 0;
	char  chr_l_batchseq[APL_DP_BATCH_NO_LEN] =APL_NULL_STRING;
	int   counter=0;
	char  chr_l_instr_isin[13]= APL_NULL_STRING;
	char  chr_l_oth_cmbpid[29]= APL_NULL_STRING;
	char  chr_l_oth_setlno[8]= APL_NULL_STRING;
	char  chr_l_oth_mkt_type[3]= APL_NULL_STRING;
	char  chr_l_remark[21]= APL_NULL_STRING;
	char  chr_l_send_refno1[36]= APL_NULL_STRING;
	char  chr_l_send_refno2[36]= APL_NULL_STRING; 
	char  chr_l_depo_part_code[21]=APL_NULL_STRING;
	char  chr_l_cmbp_id[29]=APL_NULL_STRING;
	char  chr_l_dpid[21]=APL_NULL_STRING;
	int   int_l_len=0;
	char  chr_p_depository_code_new[5]= APL_NULL_STRING;
	char  chr_p_instr_type_new=APL_NULL_CHAR; 
	int	  int_l_records=0;
	char  chr_l_dprole[3]= APL_NULL_STRING;
	char  chr_l_user[APL_USERID_LEN] = APL_NULL_STRING;
	char  pro_sys_date[APL_DATE_LEN] = APL_NULL_STRING;
	char  chr_l_maker[APL_USERID_LEN] = APL_NULL_STRING;
	char  chr_l_maker_dt[APL_DATE_LEN] = APL_NULL_STRING;
	char  chr_l_access_stamp[APL_DATE_LEN] = APL_NULL_STRING;
	char  chr_l_internal_ref_no[21] = APL_NULL_STRING;
	char  chr_l_settlement_dt[20] = APL_NULL_STRING;
	char  chr_l_instruction_type[4] = APL_NULL_STRING;

	double l_tot_qty=0.0;
	char  chr_l_identiy_no[17]= APL_NULL_STRING;
	char  chr_l_refno_str[4001]= APL_NULL_STRING;
	int   counter2=0;
	double l_int_purchasesum=0.0;
	double l_int_salesum=0.0;
	double l_int_net_amt=0.0;
	char l_chr_instr_code[9]= APL_NULL_STRING;
	char chr_l_cln_depomap_id[21]= APL_NULL_STRING;
	char chr_l_flg='Y';
	char chr_l_identiy_t2t[18]= APL_NULL_STRING;
	double int_l_deliver_qty=0.0;
	double int_l_receive_qty=0.0;
	int int_l_zero_qty=0;

	short i_cmbp_id=0;
	short i_instr_isin=0;
	short i_dpid=0;
	short i_depo_part_code=0;
	short i_int_l_records=0;
	short i_l_tot_qty=0;
	short i_settlement_dt=0;
	short i_purchasesum=0;
	short i_salesum=0;
	short i_cln_depomap_id=0;

	short int_l_condexists = 0;

	char chr_depo_map_client_id[21] = APL_NULL_STRING;
	char chr_depo_map_dp_id[21]= APL_NULL_STRING;
	short i_depo_map_client_id = 0;
	short i_depo_map_dp_id = 0;

	/* Added by Hari for IB_6283 */
	int i_cnt=0;
	double l_hdr_qty=0.0;

	SYS_DL_DEAL_STRUCT_H  *l_dl_deal_struct_h = NULL;
	SYS_DL_DEAL_STRUCT_I  *l_dl_deal_struct_i = NULL;	

	
	l_dl_deal_struct_h=(SYS_DL_DEAL_STRUCT_H *)calloc(1,sizeof(SYS_DL_DEAL_STRUCT_H));
	APL_MALLOC_FAIL(l_dl_deal_struct_h)
	l_dl_deal_struct_i=(SYS_DL_DEAL_STRUCT_I *)calloc(1,sizeof(SYS_DL_DEAL_STRUCT_I));
	APL_MALLOC_FAIL(l_dl_deal_struct_i)

	memset(l_dl_deal_struct_h, NULL, sizeof(SYS_DL_DEAL_STRUCT_H));
	memset(l_dl_deal_struct_i, NULL, sizeof(SYS_DL_DEAL_STRUCT_I));
	memset(chr_g_log_buffer,APL_NULL_CHAR,BUFFER_LEN);

	/* START -- Added by Minal for ICICI_IB_6151_PMS Enhancement_Phase 1 on 06/06/2013 */

	short l_dpcount = 0;
	short l_intflag = 0;
	char  chr_l_identity_no[17]= APL_NULL_STRING;
	int int_l_check_count = 0;
	int int_Intra_Bene_counter = 0;
	int int_l_count_depocode = 0;
	int int_l_intra_pool_cnt_depocode = 0;
	char chr_l_IntraPool_ofMkt_identno[17]= APL_NULL_STRING;
	char chr_l_offMkt_depo_code[5] = APL_NULL_STRING;
	char chr_l_offmkt_dp_format[2] = APL_NULL_STRING;
	char chr_l_bene_offmkt_client[11] = APL_NULL_STRING;
	char chr_l_bene_offmkt_location_cd[5] = APL_NULL_STRING;
	char chr_l_bene_offmkt_dp_format[2] = APL_NULL_STRING;
	char chr_l_offmkt_pool_client[11] = APL_NULL_STRING;
	char chr_l_pool_offMkt_depo_code[5] = APL_NULL_STRING;
	char chr_l_pool_offmkt_dp_format[2] = APL_NULL_STRING;

	/* END -- Added by Minal for ICICI_IB_6151_PMS Enhancement_Phase 1 on 06/06/2013 */


	EXEC SQL BEGIN DECLARE SECTION;

		EXEC SQL VAR chr_p_depository_code_new IS STRING;
		EXEC SQL VAR chr_l_header IS STRING;
		EXEC SQL VAR chr_l_trailer IS STRING;
		EXEC SQL VAR chr_l_instruction_type IS STRING;

		EXEC SQL VAR chr_l_depo_part_code IS STRING;	
		EXEC SQL VAR chr_l_instr_isin IS STRING;
		EXEC SQL VAR chr_l_maker IS STRING;
		EXEC SQL VAR chr_l_maker_dt IS STRING;
		EXEC SQL VAR chr_l_access_stamp IS STRING;
		EXEC SQL VAR chr_l_settlement_dt IS STRING;
		EXEC SQL VAR chr_l_identiy_no IS STRING;
		EXEC SQL VAR chr_l_cln_depomap_id IS STRING;
		EXEC SQL VAR chr_l_identiy_t2t IS STRING;

		
		EXEC SQL VAR chr_l_offMkt_depo_code IS STRING;
		EXEC SQL VAR chr_l_offmkt_dp_format IS STRING;
		EXEC SQL VAR chr_l_bene_offmkt_client IS STRING;
		EXEC SQL VAR chr_l_bene_offmkt_location_cd IS STRING;
		EXEC SQL VAR chr_l_bene_offmkt_dp_format IS STRING;
		EXEC SQL VAR chr_l_offmkt_pool_client IS STRING;
		EXEC SQL VAR chr_l_pool_offMkt_depo_code IS STRING;
		EXEC SQL VAR chr_l_pool_offmkt_dp_format IS STRING;


	EXEC SQL END DECLARE SECTION;


	strcpy(chr_l_maker,chr_p_user);

	if (CO_RtvSysDt(pro_sys_date,l_debug_info_ptr) == APL_FAILURE )
	{
		APL_GOBACK_FAIL
	}

	strcpy(chr_l_maker_dt,pro_sys_date);


	if (CO_RtvSysDtTime(pro_sys_date,l_debug_info_ptr) == APL_FAILURE )
	{
		APL_GOBACK_FAIL
	}	
	strcpy(chr_l_access_stamp,pro_sys_date);

	fprintf(g_flogfile,"Off Mkt Values Are .... \n");	 


	fprintf(g_flogfile,"Off Mkt Instrument Type = |%s|\n",chr_p_instr_type);	
	fprintf(g_flogfile,"Off Mkt Transaction Type = |%s|\n",chr_p_trns_type);	
	fprintf(g_flogfile,"Off Mkt Depository Code = |%s|\n",chr_p_depository_code);	
	fprintf(g_flogfile,"Off Mkt File Type = |%s|\n",chr_p_file_type);	
	fprintf(g_flogfile,"Off Mkt Deal Date = |%s|\n",chr_p_deal_date);	
	fprintf(g_flogfile,"Off Mkt DP ID = |%s|\n",chr_p_dp_id);	

	EXEC SQL SELECT DECODE(:chr_p_depository_code,'N','NSDL','C','CDSL')
	/*			 				 DECODE(:chr_p_instr_type,'I','3','O','4')							*/
	INTO :chr_p_depository_code_new FROM dual;
	IS_ANY_ORA_ERROR

        /* Added on 18122015 - Start */
 
        char hvDpBranchCd[4] = APL_NULL_STRING;
        memset(hvDpBranchCd,'\0',sizeof(hvDpBranchCd));
 
        EXEC SQL SELECT FIELD_VAL into :hvDpBranchCd from pro_gssplval where MAIN_FUN = 'DP_OFFMKT_BRNCH_CD'
        AND SUB_PROCESS = 'DP_PASS';

        IS_ANY_ORA_ERROR
        /* Added on 18122015 - End */

	if(!strcmp(chr_p_trns_type,"O"))
	{
		strcpy(chr_p_trns_type,"D");
	}


	if(strcmp(chr_p_instr_type,"I")==0)
	{
		int_l_condexists = 0;
		
		if( CO_Chk_CntryEnabled( "DL_DPINSTGEN",
								"DPINSTGEN",
								&int_l_condexists,
								l_debug_info_ptr
								) == APL_FAILURE)
		{
			APL_GOBACK_FAIL
		}
Alert("\n Hiii int_l_condexists :[%d]",int_l_condexists);
		if(int_l_condexists > 0) //This Condition is not prsent for Kotak as in kotak DL_BIFDET is not used
		{
			/* START -- Changes done by Minal for ICICI_IB_6151_PMS Enhancement_Phase 1 on 06/06/2013 */

			EXEC SQL 
				SELECT COUNT(*),
				NVL(SUM(X.tot_qty),0)
				INTO :int_l_records:i_int_l_records,
				:l_tot_qty:i_l_tot_qty
				FROM (SELECT COUNT(*),
				DECODE(:chr_p_instr_type,'I',NVL(trunc(SUM(G.qty),3),0),'O',NVL(trunc(SUM(A.qty),3),0)) AS tot_qty 
				FROM DL_DEAL A,MT_INSTRUMENT C,MT_CLI_DEPO_MAP D,DL_DPGEN_DET F,DL_BIFDET G
				WHERE A.client=F.dl_client
				AND A.identiy_no=F.dl_ref_no
				AND NVL(F.gendp_flg,'N')='Y'
				AND A.client=D.cln_code
				AND A.instr_code=C.instr_code
				AND D.cln_depo_code=:chr_p_depository_code_new
				AND D.cln_depo_map_dp_id=:chr_p_dp_id
				AND (A.deal_cd = DECODE(:chr_p_instr_type,'I','1','O','2') OR
				A.deal_cd = DECODE(:chr_p_instr_type,'I','3','O','4'))
				AND A.exch_code is null
				AND A.settlement_no is null
				AND A.mkt_type is null
				AND TO_CHAR(deal_date,'DD/MM/YYYY')=:chr_p_deal_date
				AND A.clh_flg=:chr_p_trns_type
				AND A.deal_stat IN('CC','MS')
				AND A.nds_blk_dt is null
				AND G.identiy_no = A.identiy_no
				AND G.client = A.client
				AND G.dp_id = :chr_p_depository_code_new
				AND G.dp_id = D.cln_depo_code
				GROUP BY A.client, D.cln_depo_map_client_id, A.instr_code, A.deal_cd,
				DECODE(:chr_p_depository_code_new,'CDSL',DECODE(A.ex_arena,'1',F.cp_dpid,'2',F.broker_cmbpid),
				'NSDL',DECODE(A.ex_arena,'2',F.cp_clnid,'1',F.broker_cmbpid) ),
				DECODE(:chr_p_depository_code_new,'CDSL',DECODE(A.ex_arena,'1',F.cp_clnid,'2',F.broker_dpid),
				'NSDL',DECODE(A.ex_arena,'2',F.cp_dpid,'1',F.broker_dpid) ),
				C.instr_isin, A.deal_date, A.domestic_cpclt) X;

			printf("\n No. of records and Total qty for Off Mkt Instrument Type I is [%d] and [%f]\n", int_l_records, l_tot_qty);
			/* END -- Changes done by Minal for ICICI_IB_6151_PMS Enhancement_Phase 1 on 06/06/2013 */

		}
		else
		{

			EXEC SQL SELECT COUNT(*),
			NVL(SUM(X.tot_qty),0) 
			INTO :int_l_records:i_int_l_records,
			:l_tot_qty:i_l_tot_qty
			FROM (SELECT COUNT(*),
			DECODE(:chr_p_instr_type,'I',NVL(SUM(f.qty),0),'O',NVL(SUM(A.qty),0)) AS tot_qty 
			FROM DL_DEAL A , MT_INSTRUMENT C,MT_CLI_DEPO_MAP D,DL_DPGEN_DET F
			WHERE A.client=F.dl_client
			AND A.identiy_no=F.dl_ref_no
			AND NVL(F.gendp_flg,'N')='Y'
			AND A.client=D.cln_code
			AND A.instr_code=C.instr_code
			AND D.cln_depo_code=:chr_p_depository_code_new
			AND D.cln_depo_map_dp_id=:chr_p_dp_id
			AND (A.deal_cd = DECODE(:chr_p_instr_type,'I','1','O','2') OR
			A.deal_cd = DECODE(:chr_p_instr_type,'I','3','O','4'))
			AND A.exch_code is null
			AND A.settlement_no is null
			AND A.mkt_type is null
			AND TO_CHAR(deal_date,'DD/MM/YYYY')=:chr_p_deal_date
			AND A.clh_flg=:chr_p_trns_type
			AND A.deal_stat IN('CC','MS')
			AND A.nds_blk_dt is null
      AND A.LOCATION_CD = D.CLN_DEPO_CODE // Added For PMS - Location MApping - 08082015
			GROUP BY A.client,D.cln_depo_map_client_id,A.instr_code,A.exch_code,
			A.settlement_no,A.mkt_type,A.deal_cd,C.instr_isin,A.deal_date,
			F.broker_cmbpid,F.cp_clnid,F.broker_dpid,F.cp_dpid,A.ex_arena,f.exec_dt) X;
		}

	}
	if(strcmp(chr_p_instr_type,"O")==0)
	{
		/* START -- Changes done by Minal for ICICI_IB_6151_PMS Enhancement_Phase 1 on 06/06/2013 */

		EXEC SQL 
			SELECT COUNT(*),
			NVL(SUM(X.tot_qty),0) 
			INTO :int_l_records:i_int_l_records,
			:l_tot_qty:i_l_tot_qty
			FROM (SELECT COUNT(*),
			DECODE(:chr_p_instr_type,'I',NVL(trunc(SUM(f.qty),3),0),'O',NVL(trunc(SUM(A.qty),3),0)) AS tot_qty		 
			FROM DL_DEAL A , MT_INSTRUMENT C,MT_CLI_DEPO_MAP D,DL_DPGEN_DET F
			WHERE A.client=F.dl_client
			AND A.identiy_no=F.dl_ref_no
			AND NVL(F.gendp_flg,'N')='Y'
			AND A.client=D.cln_code
			AND A.instr_code=C.instr_code
			AND D.cln_depo_code=:chr_p_depository_code_new
			AND D.cln_depo_map_dp_id=:chr_p_dp_id
			AND (A.deal_cd = DECODE(:chr_p_instr_type,'I','1','O','2') OR
			A.deal_cd = DECODE(:chr_p_instr_type,'I','3','O','4'))
			AND A.exch_code is null
			AND A.settlement_no is null
			AND A.mkt_type is null
			AND TO_CHAR(deal_date,'DD/MM/YYYY')=:chr_p_deal_date
			AND A.clh_flg=:chr_p_trns_type
			AND A.deal_stat='CC'
			AND A.location_cd = D.cln_depo_code
			AND A.location_cd = :chr_p_depository_code_new 
			AND A.nds_blk_dt is null
			AND ( (f.DP_ID IS NULL) OR (f.DP_ID IS NOT NULL AND f.DP_ID=d.cln_depo_map_dp_id and f.CLIENT_ID = d.cln_depo_map_client_id) )
			GROUP BY A.client,D.cln_depo_map_client_id,A.instr_code,A.exch_code,
			A.settlement_no,A.mkt_type,A.deal_cd,C.instr_isin,a.setl_date,
			F.broker_cmbpid,F.cp_clnid,F.broker_dpid,F.cp_dpid,A.ex_arena, A.deal_date,
			DECODE(:chr_p_depository_code_new,'CDSL',DECODE(A.ex_arena,'1',F.cp_dpid,'2',F.broker_cmbpid),
			'NSDL',DECODE(A.ex_arena,'1',F.cp_clnid,'2',F.broker_cmbpid) ),
			DECODE(:chr_p_depository_code_new,'CDSL',DECODE(A.ex_arena,'1',F.cp_clnid,'2',F.broker_dpid),
			'NSDL',DECODE(A.ex_arena,'1',F.cp_dpid,'2',F.broker_dpid)), A.domestic_cpclt) X;

//		printf("\n No. of records and Total Qyt for Off Mkt Instrument Type O is [%d] and [%f] \n", int_l_records, l_tot_qty);

		/* END -- Changes done by Minal for ICICI_IB_6151_PMS Enhancement_Phase 1 on 06/06/2013 */
	}

	if(int_l_records == 0)
	{
		fprintf(g_flogfile,"NO Records Found for Off Market. ");
		chr_l_flg = 'N';
	}

	IS_ANY_ORA_ERROR

	if(chr_l_flg == 'Y')
	{
		if(!strcmp(chr_p_depository_code_new,"CDSL"))
		{
			int_l_batchseq = 0;

			EXEC SQL 
				SELECT DL_DPINSTRSEQ_MKT_CDSL.NEXTVAL 
				INTO :int_l_batchseq 
				FROM DUAL;

			IS_ANY_ORA_ERROR
		}
		else if(!strcmp(chr_p_depository_code_new,"NSDL"))
		{
			int_l_batchseq = 0;

			EXEC SQL 
				SELECT DL_DPINSTRSEQ.NEXTVAL 
				INTO :int_l_batchseq 
				FROM DUAL;

			IS_ANY_ORA_ERROR
		}

		if(!strcmp(chr_p_depository_code_new,"CDSL"))
		{
			//strcpy(chr_l_batchseq,"A");
			strcat(chr_l_batchseq,(char*)ltoa(int_l_batchseq));
		}

		if(!strcmp(chr_p_depository_code_new,"NSDL"))
		{
			//strcpy(chr_l_batchseq,"N");
			strcat(chr_l_batchseq,(char*)ltoa(int_l_batchseq));
		}

		/********************** Inserting Header Record **********************/

		printf("Batch Number is |%s| \n",chr_l_batchseq);
fflush(stdout);
		printf("DP ID is |%s| \n",chr_p_dp_id);
fflush(stdout);
		printf("Batch Sequence is |%d| \n",int_l_batchseq);
fflush(stdout);
		
		fprintf(g_flogfile,"Off Mkt Intra DP Cursor:After Inserting Header Record");
		fflush(g_flogfile);

		fprintf(g_flogfile,"\n************* BATCH No For OFF Market DP is *****************|%s|\n",chr_l_batchseq);
		
		/********************** Inserting Header Record **********************/

		if(strcmp(chr_p_instr_type,"I")==0)
		{
                      printf("\n XXX1: PAYIN SALE TYPE");

			if(int_l_condexists > 0) //This condition is not present in kotak
			{
                      printf("\n XXX2: PAYIN SALE TYPE b4 l_cur_gen_Ioff_mkt_dpinstr3 CURSOR");
				/* START -- Changes done by Minal for ICICI_IB_6151_PMS Enhancement_Phase 1 on 06/06/2013 */

				EXEC SQL DECLARE l_cur_gen_Ioff_mkt_dpinstr3 CURSOR FOR	
					SELECT A.client,
					D.cln_depo_map_client_id,
					A.instr_code,
					A.deal_cd,
					DECODE(:chr_p_instr_type,'I',NVL(trunc(sum(G.qty),3),0),'O',NVL(trunc(sum(f.qty),3),0)) AS QTY,
					DECODE(:chr_p_depository_code_new,'CDSL',DECODE(A.ex_arena,'2',F.cp_dpid,'1',F.broker_cmbpid),
					'NSDL',DECODE(A.ex_arena,'2',F.cp_clnid,'1',F.broker_cmbpid)) as CMBPID,
					DECODE(:chr_p_depository_code_new,'CDSL',DECODE(A.ex_arena,'2',F.cp_clnid,'1',F.broker_dpid),
					'NSDL',DECODE(A.ex_arena,'2',F.cp_dpid,'1',F.broker_dpid)) as DPID,
					C.instr_isin,
					A.deal_date,
					A.domestic_cpclt
					FROM DL_DEAL A,MT_INSTRUMENT C,MT_CLI_DEPO_MAP D,DL_DPGEN_DET F,DL_BIFDET G
					WHERE A.client=F.dl_client
					AND A.identiy_no=F.dl_ref_no
					AND NVL(F.gendp_flg,'N')='Y'
					AND A.client=D.cln_code
					AND A.instr_code=C.instr_code
					AND D.cln_depo_code=:chr_p_depository_code_new
					AND D.cln_depo_map_dp_id=:chr_p_dp_id
					AND (A.deal_cd = DECODE(:chr_p_instr_type,'I','1','O','2') OR
					A.deal_cd = DECODE(:chr_p_instr_type,'I','3','O','4'))
					AND A.exch_code is null
					AND A.settlement_no is null
					AND A.mkt_type is null
					AND TO_CHAR(deal_date,'DD/MM/YYYY')=:chr_p_deal_date
					AND A.clh_flg=:chr_p_trns_type
					AND A.deal_stat IN('CC','MS')
					AND A.nds_blk_dt is null
					AND G.identiy_no = A.identiy_no
					AND G.client = A.client
					AND G.dp_id = :chr_p_depository_code_new
					AND G.dp_id = D.cln_depo_code
					GROUP BY A.client, D.cln_depo_map_client_id, A.instr_code, A.deal_cd, 
					DECODE(:chr_p_depository_code_new,'CDSL',DECODE(A.ex_arena,'2',F.cp_dpid,'1',F.broker_cmbpid),
					'NSDL',DECODE(A.ex_arena,'2',F.cp_clnid,'1',F.broker_cmbpid) ),
					DECODE(:chr_p_depository_code_new,'CDSL',DECODE(A.ex_arena,'2',F.cp_clnid,'1',F.broker_dpid),
					'NSDL',DECODE(A.ex_arena,'2',F.cp_dpid,'1',F.broker_dpid) ),
					C.instr_isin, A.deal_date, A.domestic_cpclt
					ORDER BY A.client;

				IS_ANY_ORA_ERROR

				/* END -- Changes done by Minal for ICICI_IB_6151_PMS Enhancement_Phase 1 on 06/06/2013 */

				EXEC SQL OPEN l_cur_gen_Ioff_mkt_dpinstr3;

				IS_ANY_ORA_ERROR

			}
			else
			{
                      printf("\n XXX2: PAYIN SALE TYPE Befor CURSOR l_cur_gen_offmarket_dpinstr1");
				EXEC SQL DECLARE l_cur_gen_offmarket_dpinstr1 CURSOR FOR	
					SELECT A.client,
					D.cln_depo_map_client_id,
					A.instr_code,A.deal_cd,
					DECODE(:chr_p_instr_type,'I',NVL(SUM(f.qty),0),'O',NVL(SUM(f.qty),0)) AS QTY,
					DECODE(A.ex_arena,'2',F.cp_clnid,F.broker_cmbpid) as CMBPID,
					DECODE(A.ex_arena,'2',F.cp_dpid,F.broker_dpid) as DPID,
					C.instr_isin,
					A.deal_date,
					A.domestic_cpclt,
               A.identiy_no //16122015
					FROM DL_DEAL A , MT_INSTRUMENT C,MT_CLI_DEPO_MAP D,DL_DPGEN_DET F
					WHERE A.client=F.dl_client
					AND A.identiy_no=F.dl_ref_no
					AND NVL(F.gendp_flg,'N')='Y'
					AND A.client=D.cln_code
          AND A.LOCATION_CD = D.CLN_DEPO_CODE // This Condition added on 08082015 as For Locations mapping - PMS 
					AND A.instr_code=C.instr_code
					AND D.cln_depo_code=:chr_p_depository_code_new
					AND D.cln_depo_map_dp_id=:chr_p_dp_id
					AND (A.deal_cd = DECODE(:chr_p_instr_type,'I','1','O','2') OR
					A.deal_cd = DECODE(:chr_p_instr_type,'I','3','O','4'))
					AND A.exch_code is null
					AND A.settlement_no is null
					AND A.mkt_type is null
					AND TO_CHAR(deal_date,'DD/MM/YYYY')=:chr_p_deal_date
					AND A.clh_flg=:chr_p_trns_type
					AND A.deal_stat IN('CC','MS')
					AND A.nds_blk_dt is null
                                        GROUP BY A.client, D.cln_depo_map_client_id, A.instr_code, A.deal_cd, 
                                        DECODE(A.ex_arena,'2',F.cp_clnid,F.broker_cmbpid), DECODE(A.ex_arena,'2',F.cp_dpid,F.broker_dpid), 
               C.instr_isin, A.deal_date, A.domestic_cpclt,A.identiy_no
                ORDER BY A.client,A.identiy_no;
Alert(" SQLCA SQLCODE DECLARE l_cur_gen_offmarket_dpinstr1:[%d]",sqlca.sqlcode);

				EXEC SQL OPEN l_cur_gen_offmarket_dpinstr1;
Alert(" SQLCA SQLCODE OPEN l_cur_gen_offmarket_dpinstr1:[%d]",sqlca.sqlcode);
				
				IS_ANY_ORA_ERROR
			}
		}
		if(strcmp(chr_p_instr_type,"O")==0)
		{

                     printf("\n XXX1: PAYOUT BUY TYPE");
			/* START -- Changes done by Minal for ICICI_IB_6151_PMS Enhancement_Phase 1 on 06/06/2013 */
                         printf("\n B4 l_cur_gen_Ooff_mkt_dpinstr2 CURSOR");
                         printf("\n chr_p_depository_code_new :[%s]",chr_p_depository_code_new);
                         printf("\n chr_p_instr_type :[%s]",chr_p_instr_type);
                         printf("\n chr_p_dp_id :[%s]",chr_p_dp_id);
                         printf("\n chr_p_deal_date :[%s]",chr_p_deal_date);
                         printf("\n chr_p_trns_type :[%s]",chr_p_trns_type);

			EXEC SQL DECLARE l_cur_gen_Ooff_mkt_dpinstr2 CURSOR FOR	
				SELECT A.client,
				D.cln_depo_map_client_id,
				A.instr_code,A.deal_cd,
				DECODE(:chr_p_instr_type,'I',NVL(trunc(sum(f.qty),3),0),'O',NVL(trunc(sum(f.qty),3),0)) AS QTY,
				DECODE(:chr_p_depository_code_new,'CDSL',DECODE(A.ex_arena,'2',F.cp_dpid,'1',F.broker_cmbpid),
				'NSDL',DECODE(A.ex_arena,'2',F.cp_clnid,'1',F.broker_cmbpid) ) as CMBPID,
				DECODE(:chr_p_depository_code_new,'CDSL',DECODE(A.ex_arena,'2',F.cp_clnid,'1',F.broker_dpid), 'NSDL',DECODE(A.ex_arena,'2',F.cp_dpid,'1',F.broker_dpid) ) as DPID,
				C.instr_isin,
				A.deal_date,
				A.domestic_cpclt,
            A.identiy_no //16122015
				FROM DL_DEAL A , MT_INSTRUMENT C,MT_CLI_DEPO_MAP D,DL_DPGEN_DET F
				WHERE A.client=F.dl_client
				AND A.identiy_no=F.dl_ref_no
				AND NVL(F.gendp_flg,'N')='Y'
				AND A.client=D.cln_code
				AND A.instr_code=C.instr_code
				AND D.cln_depo_code=:chr_p_depository_code_new
				AND D.cln_depo_map_dp_id=:chr_p_dp_id
				AND (A.deal_cd = DECODE(:chr_p_instr_type,'I','1','O','2') OR
				A.deal_cd = DECODE(:chr_p_instr_type,'I','3','O','4'))
				AND A.exch_code is null
				AND A.settlement_no is null
				AND A.mkt_type is null
				AND TO_CHAR(deal_date,'DD/MM/YYYY')=:chr_p_deal_date
				AND A.clh_flg=:chr_p_trns_type
				AND A.deal_stat='CC'
				AND A.nds_blk_dt is null
				AND ( (f.DP_ID IS NULL) OR (f.DP_ID IS NOT NULL AND f.DP_ID=d.cln_depo_map_dp_id and f.CLIENT_ID = d.cln_depo_map_client_id) )
				AND A.location_cd = :chr_p_depository_code_new
				AND A.location_cd = D.cln_depo_code
				group by A.client,D.cln_depo_map_client_id,A.instr_code,A.deal_cd,
				DECODE(:chr_p_depository_code_new,'CDSL',DECODE(A.ex_arena,'2',F.cp_dpid,'1',F.broker_cmbpid),
					'NSDL',DECODE(A.ex_arena,'2',F.cp_clnid,'1',F.broker_cmbpid) ),
				DECODE(:chr_p_depository_code_new,'CDSL',DECODE(A.ex_arena,'2',F.cp_clnid,'1',F.broker_dpid), 
					'NSDL',DECODE(A.ex_arena,'2',F.cp_dpid,'1',F.broker_dpid) ),
				C.instr_isin,A.deal_date,A.domestic_cpclt,A.identiy_no
				order by A.client,A.identiy_no;

			IS_ANY_ORA_ERROR

			/* END -- Changes done by Minal for ICICI_IB_6151_PMS Enhancement_Phase 1 on 06/06/2013 */

			EXEC SQL OPEN l_cur_gen_Ooff_mkt_dpinstr2;

			IS_ANY_ORA_ERROR

		}

		for(;;)
		{
			memset(l_dl_deal_struct_h, NULL, sizeof(SYS_DL_DEAL_STRUCT_H));
			memset(l_dl_deal_struct_i, NULL, sizeof(SYS_DL_DEAL_STRUCT_I));
			memset(chr_l_refno_str,APL_NULL_CHAR,4001);

			if(strcmp(chr_p_instr_type,"I")==0)
			{
                              printf("\n PAYYIN SALEEE FETCH ");

				if(int_l_condexists > 0)
				{
                                  printf("\n Fetching l_cur_gen_Ioff_mkt_dpinstr3 ");

					/* START -- Changes done in query by Minal for ICICI_IB_6151_PMS Enhancement_Phase 1 on 06/06/2013 */

					EXEC SQL FETCH l_cur_gen_Ioff_mkt_dpinstr3 INTO
						:l_dl_deal_struct_h->h_dl_client:l_dl_deal_struct_i->i_dl_client,
						:chr_l_cln_depomap_id:i_cln_depomap_id,	
						:l_dl_deal_struct_h->h_instr_code:l_dl_deal_struct_i->i_instr_code,
						:l_dl_deal_struct_h->h_dealcd:l_dl_deal_struct_i->i_dealcd,
						:l_dl_deal_struct_h->h_qty:l_dl_deal_struct_i->i_qty,
						:chr_l_cmbp_id:i_cmbp_id,
						:chr_l_dpid:i_dpid,
						:chr_l_instr_isin:i_instr_isin,
						:l_dl_deal_struct_h->h_setldt:l_dl_deal_struct_i->i_setldt,
						:l_dl_deal_struct_h->h_domcpclt_cd:l_dl_deal_struct_i->i_domcpclt_cd;

					/* END -- Changes done in query by Minal for ICICI_IB_6151_PMS Enhancement_Phase 1 on 06/06/2013 */

				}
				else
				{
                                printf("\n processing l_cur_gen_offmarket_dpinstr1 FETCH ");

					EXEC SQL FETCH l_cur_gen_offmarket_dpinstr1 INTO 
						:l_dl_deal_struct_h->h_dl_client:l_dl_deal_struct_i->i_dl_client,
						:chr_l_cln_depomap_id:i_cln_depomap_id,	
						:l_dl_deal_struct_h->h_instr_code:l_dl_deal_struct_i->i_instr_code,
						:l_dl_deal_struct_h->h_dealcd:l_dl_deal_struct_i->i_dealcd,
						:l_dl_deal_struct_h->h_qty:l_dl_deal_struct_i->i_qty,
						:chr_l_cmbp_id:i_cmbp_id,
						:chr_l_dpid:i_dpid,
						:chr_l_instr_isin:i_instr_isin,
						:l_dl_deal_struct_h->h_setldt:l_dl_deal_struct_i->i_setldt,
						:l_dl_deal_struct_h->h_domcpclt_cd:l_dl_deal_struct_i->i_domcpclt_cd,
                  :l_dl_deal_struct_h->h_indentity_no:l_dl_deal_struct_i->i_indentity_no;
				}
                              printf("\n sqlca.sqlcode Of DPGEN :[%d]",sqlca.sqlcode);

				if(APL_ZERO_RESULT_SET)
				{

					if(counter==0)
					{
						fprintf(g_flogfile,"No Records Found for Instrument Type I! \n" );
					}
					break;
				}

				IS_ANY_ORA_ERROR

			}
			if(strcmp(chr_p_instr_type,"O")==0)
			{	
                         printf("\n PAYOUT BUT FETCH");
				/* START -- Changes done in query by Minal for ICICI_IB_6151_PMS Enhancement_Phase 1 on 06/06/2013 */

				EXEC SQL FETCH l_cur_gen_Ooff_mkt_dpinstr2 INTO 
					:l_dl_deal_struct_h->h_dl_client:l_dl_deal_struct_i->i_dl_client,
					:chr_l_cln_depomap_id:i_cln_depomap_id,	
					:l_dl_deal_struct_h->h_instr_code:l_dl_deal_struct_i->i_instr_code,
					:l_dl_deal_struct_h->h_dealcd:l_dl_deal_struct_i->i_dealcd,
					:l_dl_deal_struct_h->h_qty:l_dl_deal_struct_i->i_qty,
					:chr_l_cmbp_id:i_cmbp_id,
					:chr_l_dpid:i_dpid,
					:chr_l_instr_isin:i_instr_isin,
					:l_dl_deal_struct_h->h_setldt:l_dl_deal_struct_i->i_setldt,
					:l_dl_deal_struct_h->h_domcpclt_cd:l_dl_deal_struct_i->i_domcpclt_cd,
               :l_dl_deal_struct_h->h_indentity_no:l_dl_deal_struct_i->i_indentity_no;

				/* END -- Changes done in query by Minal for ICICI_IB_6151_PMS Enhancement_Phase 1 on 06/06/2013 */

                               printf("\n sqlca.sqlcode OFFMARKET BUYYYY:[%d]",sqlca.sqlcode);
                               printf("\n chr_l_dpid :[%s]",chr_l_dpid);
				if(APL_ZERO_RESULT_SET)
				{

					if(counter==0)
					{
						fprintf(g_flogfile,"No Records Found for Instrument Type O! \n" );
					}
					break;
				}
				
				IS_ANY_ORA_ERROR

			}

			counter++;

			int_l_check_count = 0;

			if(strcmp(chr_p_depository_code_new, "CDSL") == 0)
			{
				EXEC SQL
					SELECT count(*)
					INTO :int_l_check_count
					FROM MT_CLIENT 
					WHERE cln_code = (SELECT cln_master
									 FROM MT_CLIENT 
									 WHERE cln_code = :l_dl_deal_struct_h->h_dl_client) 
					AND cln_code != cln_master;

				IS_ANY_ORA_ERROR

				EXEC SQL
					SELECT count(*)
					INTO :int_l_count_depocode
					FROM MT_CLI_DEPO_MAP 
					WHERE cln_code = :l_dl_deal_struct_h->h_dl_client;

				IS_ANY_ORA_ERROR

				memset(chr_l_offMkt_depo_code, APL_NULL_CHAR, sizeof(chr_l_offMkt_depo_code));
				memset(chr_l_offmkt_dp_format, APL_NULL_CHAR, sizeof(chr_l_offmkt_dp_format));

				if(int_l_count_depocode == 1)
				{

					EXEC SQL
						SELECT cln_depo_code 
						INTO :chr_l_offMkt_depo_code
						FROM MT_CLI_DEPO_MAP 
						WHERE cln_code = :l_dl_deal_struct_h->h_dl_client;

					IS_ANY_ORA_ERROR

				
				}
				else
				{
					strcpy(chr_l_offMkt_depo_code,"NSDL");

				}

				Alert("Off mkt depo code is : |%s| \n ", chr_l_offMkt_depo_code);

/*
				EXEC SQL 
					SELECT GETCLIENTPARAMBYID('CDSL_DP_FORMAT',:l_dl_deal_struct_h->h_dl_client)
					INTO :chr_l_offmkt_dp_format
					FROM DUAL;

				IS_ANY_ORA_ERROR*/

				Alert("Off mkt dp format is : |%s| for client |%s| \n", chr_l_offmkt_dp_format, l_dl_deal_struct_h->h_dl_client);


				if(int_l_check_count == 0)
				{

					memset(chr_l_bene_offmkt_client, APL_NULL_CHAR, sizeof(chr_l_bene_offmkt_client));
					memset(chr_l_bene_offmkt_location_cd, APL_NULL_CHAR, sizeof(chr_l_bene_offmkt_location_cd));
					memset(chr_l_bene_offmkt_dp_format, APL_NULL_CHAR, sizeof(chr_l_bene_offmkt_dp_format));
		
					if(strcmp(chr_p_instr_type,"I")==0)
					{

						EXEC SQL DECLARE l_cur_IntraBen_Iofmkt_dpinstr CURSOR FOR	
							SELECT DISTINCT A.identiy_no  /*G.identiy_no is changed to A.identiy_no as DL_BIFDET is not used 03082015 */
							FROM DL_DEAL A , MT_INSTRUMENT C,MT_CLI_DEPO_MAP D,DL_DPGEN_DET F /*,DL_BIFDET G 03082015 */
							WHERE A.client=F.dl_client
							AND A.identiy_no=F.dl_ref_no
							AND NVL(F.gendp_flg,'N')='Y'
							AND A.client=D.cln_code
							AND A.instr_code=C.instr_code
							AND D.cln_depo_code=:chr_p_depository_code_new
							AND D.cln_depo_map_dp_id=:chr_p_dp_id
							AND (A.deal_cd = DECODE(:chr_p_instr_type,'I','1','O','2') OR
							A.deal_cd = DECODE(:chr_p_instr_type,'I','3','O','4'))
							AND A.exch_code is null
							AND A.settlement_no is null
							AND A.mkt_type is null
							AND TO_CHAR(deal_date,'DD/MM/YYYY')=:chr_p_deal_date
							AND A.clh_flg=:chr_p_trns_type
							AND A.deal_stat IN('CC','MS')
							AND A.nds_blk_dt is null
/*							AND G.identiy_no = A.identiy_no
							AND G.client = A.client
							AND G.dp_id = :chr_p_depository_code_new
							AND G.dp_id = D.cln_depo_code         03082015 **********/
							AND F.cp_clnid = :chr_l_dpid
							AND A.instr_code = :l_dl_deal_struct_h->h_instr_code
							AND A.client = :l_dl_deal_struct_h->h_dl_client;

						IS_ANY_ORA_ERROR

						EXEC SQL OPEN l_cur_IntraBen_Iofmkt_dpinstr;

						IS_ANY_ORA_ERROR

					}
					else if(strcmp(chr_p_instr_type,"O")==0)
					{


						Alert("chr_l_cmbp_id :|%s| \n",chr_l_cmbp_id);
						Alert("chr_l_dpid :|%s| \n",chr_l_dpid);

						EXEC SQL DECLARE l_cur_IntraBen_Oofmkt_dpinstr CURSOR FOR	
							SELECT DISTINCT A.identiy_no
							FROM DL_DEAL A , MT_INSTRUMENT C,MT_CLI_DEPO_MAP D,DL_DPGEN_DET F
							WHERE A.client=F.dl_client
							AND A.identiy_no=F.dl_ref_no
							AND NVL(F.gendp_flg,'N')='Y'
							AND A.client=D.cln_code
							AND A.instr_code=C.instr_code
							AND D.cln_depo_code=:chr_p_depository_code_new
							AND D.cln_depo_map_dp_id=:chr_p_dp_id
							AND (A.deal_cd = DECODE(:chr_p_instr_type,'I','1','O','2') OR
							A.deal_cd = DECODE(:chr_p_instr_type,'I','3','O','4'))
							AND A.exch_code is null
							AND A.settlement_no is null
							AND A.mkt_type is null
							AND TO_CHAR(deal_date,'DD/MM/YYYY')=:chr_p_deal_date
							AND A.clh_flg=:chr_p_trns_type
							AND A.deal_stat IN('CC','MS')
							AND A.nds_blk_dt is null
							AND F.cp_dpid = :chr_l_cmbp_id
							AND A.instr_code = :l_dl_deal_struct_h->h_instr_code
							AND A.client = :l_dl_deal_struct_h->h_dl_client
							AND F.cp_clnid = :chr_l_dpid;

						IS_ANY_ORA_ERROR
					
						EXEC SQL OPEN l_cur_IntraBen_Oofmkt_dpinstr;

						IS_ANY_ORA_ERROR

					}

					for(;;)
					{
						if(strcmp(chr_p_instr_type,"I")==0)
						{

							strcpy(chr_l_IntraPool_ofMkt_identno,APL_NULL_STRING);

							EXEC SQL FETCH l_cur_IntraBen_Iofmkt_dpinstr INTO :chr_l_IntraPool_ofMkt_identno;

							IS_ANY_ORA_ERROR

							Alert("After fetch Identity No = |%s| \n",chr_l_IntraPool_ofMkt_identno);
						}
						else if(strcmp(chr_p_instr_type,"O")==0)
						{

							strcpy(chr_l_IntraPool_ofMkt_identno,APL_NULL_STRING);

							EXEC SQL FETCH l_cur_IntraBen_Oofmkt_dpinstr INTO :chr_l_IntraPool_ofMkt_identno;

							Alert("After fetch Identity No = |%s| \n",chr_l_IntraPool_ofMkt_identno);
						}


						if(APL_ZERO_RESULT_SET)
						{
							if(int_Intra_Bene_counter == 0)
							{
								fprintf(g_flogfile,"No Records Found! \n");
							}

							break;

						}

						IS_ANY_ORA_ERROR

						int_Intra_Bene_counter++;

						EXEC SQL
							SELECT DISTINCT A.client,
							A.location_cd
							INTO :chr_l_bene_offmkt_client,
							:chr_l_bene_offmkt_location_cd
							FROM DL_DEAL A, MT_CLIENT B 
							WHERE A.identiy_no = :chr_l_IntraPool_ofMkt_identno
							AND A.client != :l_dl_deal_struct_h->h_dl_client
							AND A.client = B.cln_code
							AND A.instr_code = :l_dl_deal_struct_h->h_instr_code;
/*
						EXEC SQL
							SELECT GETCLIENTPARAMBYID('CDSL_DP_FORMAT',:chr_l_bene_offmkt_client)
							INTO :chr_l_bene_offmkt_dp_format
							FROM DUAL;

						IS_ANY_ORA_ERROR
*/

						Alert("End client is |%s|, Location code is |%s| and DP Format is |%s| \n", chr_l_bene_offmkt_client, chr_l_bene_offmkt_location_cd,chr_l_bene_offmkt_dp_format);


					} /* End of for loop */

					if(strcmp(chr_p_instr_type,"I")==0)
					{
						EXEC SQL CLOSE l_cur_IntraBen_Iofmkt_dpinstr;
					}
					else if(strcmp(chr_p_instr_type,"O")==0)
					{
						EXEC SQL CLOSE l_cur_IntraBen_Oofmkt_dpinstr;
					}
				
				}
				else
				{

					memset(chr_l_offmkt_pool_client, APL_NULL_CHAR, sizeof(chr_l_offmkt_pool_client));
					memset(chr_l_pool_offMkt_depo_code, APL_NULL_CHAR, sizeof(chr_l_pool_offMkt_depo_code));
					memset(chr_l_pool_offmkt_dp_format, APL_NULL_CHAR, sizeof(chr_l_pool_offmkt_dp_format));

					EXEC SQL
						SELECT cln_master
						INTO :chr_l_offmkt_pool_client
						FROM MT_CLIENT
						WHERE cln_code = (SELECT cln_master 
										  FROM mt_client 
										  WHERE cln_code = :l_dl_deal_struct_h->h_dl_client
										  )
						AND cln_code != cln_master;

					IS_ANY_ORA_ERROR

					EXEC SQL
						SELECT count(*)
						INTO :int_l_intra_pool_cnt_depocode
						FROM MT_CLI_DEPO_MAP
						WHERE cln_code = :chr_l_offmkt_pool_client;

					IS_ANY_ORA_ERROR

					memset(chr_l_pool_offMkt_depo_code, APL_NULL_CHAR, sizeof(chr_l_pool_offMkt_depo_code));

					if(int_l_intra_pool_cnt_depocode == 1)
					{

						EXEC SQL
							SELECT cln_depo_code 
							INTO :chr_l_pool_offMkt_depo_code
							FROM MT_CLI_DEPO_MAP 
							WHERE cln_code = :chr_l_offmkt_pool_client;

						IS_ANY_ORA_ERROR

					
					}
					else
					{
						strcpy(chr_l_pool_offMkt_depo_code,"NSDL");

					}

/*
					EXEC SQL
						SELECT GETCLIENTPARAMBYID('CDSL_DP_FORMAT',:chr_l_offmkt_pool_client)
						INTO :chr_l_pool_offmkt_dp_format
						FROM DUAL;

						IS_ANY_ORA_ERROR
*/
						Alert("depo code is |%s|, Pool client is |%s| and DP Format is |%s| \n", chr_l_pool_offMkt_depo_code,chr_l_offmkt_pool_client, chr_l_pool_offmkt_dp_format);

				}
			}

			EXEC SQL 
				SELECT :l_dl_deal_struct_h->h_dealcd
				INTO :chr_p_instr_type_new
				FROM DUAL;

			IS_ANY_ORA_ERROR

			sprintf(chr_g_log_buffer,"\n Off Mkt********DEAL CD**************=|%c| ",chr_p_instr_type_new);	
			fprintf(g_flogfile,"%s",chr_g_log_buffer);

			memset(chr_l_instruction_type, APL_NULL_CHAR, sizeof(chr_l_instruction_type));

			Alert("offMkt_depo_code is |%s| \n", chr_l_offMkt_depo_code);

			Alert("offmkt_dp_format is |%s| \n", chr_l_offmkt_dp_format);

			Alert("pool_offMkt_depo_code is |%s| \n", chr_l_pool_offMkt_depo_code);

			Alert("pool_offmkt_dp_format is |%s| \n", chr_l_pool_offmkt_dp_format);

					
			if(strcmp(chr_p_depository_code_new, "CDSL") == 0)
			{
				if(((strcmp(chr_l_offMkt_depo_code, "CDSL") == 0) && (strcmp(chr_l_offmkt_dp_format, "E") == 0)) && (((strcmp(chr_l_bene_offmkt_location_cd, "CDSL") == 0) && (strcmp(chr_l_bene_offmkt_dp_format, "E") == 0))
				|| ((strcmp(chr_l_bene_offmkt_location_cd, "CDSL") == 0) && (strcmp(chr_l_bene_offmkt_dp_format, "C") == 0))))
				{

					if(strcmp(l_dl_deal_struct_h->h_dealcd,"1")==0 || strcmp(l_dl_deal_struct_h->h_dealcd,"3")==0)
					{
						strcpy(chr_l_instruction_type,"CC6");
					}
					else if(strcmp(l_dl_deal_struct_h->h_dealcd,"2")==0 || strcmp(l_dl_deal_struct_h->h_dealcd,"4")==0)
					{
						strcpy(chr_l_instruction_type,"CC6");
					}
						
				}
				else if((((strcmp(chr_l_offMkt_depo_code, "CDSL") == 0) && (strcmp(chr_l_offmkt_dp_format, "E") == 0)) 
				|| ((strcmp(chr_l_offMkt_depo_code, "CDSL") == 0) && (strcmp(chr_l_offmkt_dp_format, "C") == 0)))
				&& ((strcmp(chr_l_pool_offMkt_depo_code, "CDSL") == 0) && (strcmp(chr_l_pool_offmkt_dp_format, "E") == 0)))
				{

					if(strcmp(l_dl_deal_struct_h->h_dealcd,"1")==0 || strcmp(l_dl_deal_struct_h->h_dealcd,"3")==0)
					{
						strcpy(chr_l_instruction_type,"CC6");
					}
					else if(strcmp(l_dl_deal_struct_h->h_dealcd,"2")==0 || strcmp(l_dl_deal_struct_h->h_dealcd,"4")==0)
					{
						strcpy(chr_l_instruction_type,"CC6");
					}
				}
				else if((((strcmp(chr_l_offMkt_depo_code, "CDSL") == 0) && (strcmp(chr_l_offmkt_dp_format, "E") == 0)) || ((strcmp(chr_l_offMkt_depo_code, "CDSL") == 0) && (strcmp(chr_l_offmkt_dp_format, "C") == 0)))
				&& ((strcmp(chr_l_pool_offMkt_depo_code, "CDSL") == 0) && (strcmp(chr_l_pool_offmkt_dp_format, "C") == 0)))
				{

					if(strcmp(l_dl_deal_struct_h->h_dealcd,"1")==0 || strcmp(l_dl_deal_struct_h->h_dealcd,"3")==0)
					{
						strcpy(chr_l_instruction_type,"CC5");
					}
					else if((strcmp(l_dl_deal_struct_h->h_dealcd,"2")==0) || (strcmp(l_dl_deal_struct_h->h_dealcd,"4")==0))
					{
						strcpy(chr_l_instruction_type,"CC5");
					}

				}
				else if(((strcmp(chr_l_offMkt_depo_code, "CDSL") == 0) && (strcmp(chr_l_offmkt_dp_format, "C") == 0))
				&& (((strcmp(chr_l_bene_offmkt_location_cd, "CDSL") == 0) && (strcmp(chr_l_bene_offmkt_dp_format, "C") == 0)) || (strcmp(chr_l_bene_offmkt_location_cd, "CDSL") == 0) && (strcmp(chr_l_bene_offmkt_dp_format, "E") == 0)))
				{
					
					if(strcmp(l_dl_deal_struct_h->h_dealcd,"1")==0 || strcmp(l_dl_deal_struct_h->h_dealcd,"3")==0)
					{
						strcpy(chr_l_instruction_type,"CC5");
					}
					else if(strcmp(l_dl_deal_struct_h->h_dealcd,"2")==0 || strcmp(l_dl_deal_struct_h->h_dealcd,"4")==0)
					{
						strcpy(chr_l_instruction_type,"CC5");
					}

				}
				else
				{
			
					if(strcmp(l_dl_deal_struct_h->h_dealcd,"1")==0 || strcmp(l_dl_deal_struct_h->h_dealcd,"3")==0)
					{
						strcpy(chr_l_instruction_type,"904");
					}
					else if(strcmp(l_dl_deal_struct_h->h_dealcd,"2")==0 || strcmp(l_dl_deal_struct_h->h_dealcd,"4")==0)
					{
						strcpy(chr_l_instruction_type,"905");
					}

				}
			}
			else
			{
				if(strcmp(l_dl_deal_struct_h->h_dealcd,"1")==0 || strcmp(l_dl_deal_struct_h->h_dealcd,"3")==0)
				{
					strcpy(chr_l_instruction_type,"904");
				}
				else if(strcmp(l_dl_deal_struct_h->h_dealcd,"2")==0 || strcmp(l_dl_deal_struct_h->h_dealcd,"4")==0)
				{
					strcpy(chr_l_instruction_type,"905");
				}
			}

			sprintf(chr_l_internal_ref_no,"%d%d",int_l_batchseq,counter);
			strcpy(chr_l_send_refno1,chr_l_internal_ref_no);

			sprintf(chr_g_log_buffer,"\n off mkt Internal Ref No=|%s|",chr_l_internal_ref_no);	
			fprintf(g_flogfile,"%s",chr_g_log_buffer);

			Alert("Trans type is |%s| \n", chr_l_instruction_type);



			/*	********************   Start Retriving IDENTIY_NO from dl_deal table *************** */


			sprintf(chr_g_log_buffer,"\n Off Mkt FETCHED VALUES ARE: \n Client Depo Map ID = |%s|\n QTY = |%lf|\n  ISIN Code = |%s| \n CMBP ID=|%s| \n Internal REEFNO = |%s|\n DEPOSITORY Code = |%s| \n Instrument Code = |%s| \n  DP ID = |%s| \n Dom CPCLT Code = |%s| \n ",chr_l_cln_depomap_id,l_dl_deal_struct_h->h_qty,chr_l_instr_isin,chr_l_cmbp_id,chr_l_internal_ref_no,chr_p_depository_code_new, l_dl_deal_struct_h->h_instr_code,chr_l_dpid, l_dl_deal_struct_h->h_domcpclt_cd);

			fprintf(g_flogfile,"%s",chr_g_log_buffer);

			if(!strcmp(chr_l_cmbp_id,APL_NULL_STRING) || !strcmp(chr_l_dpid,APL_NULL_STRING))
			{
				/*
				EXEC SQL SELECT pty_depo_map_client_id,pty_depo_map_dp_id INTO
				:chr_depo_map_client_id:i_depo_map_client_id,:chr_depo_map_dp_id:i_depo_map_dp_id
				from MT_PTY_DEPO_MAP where
				PTY_CODE = :l_dl_deal_struct_h->h_domcpclt_cd
				AND	DEPO_CODE = :chr_p_depository_code_new;

				IS_ANY_ORA_ERROR

				printf("\n in if -- sqlca.sqlcode is |%d|\n",sqlca.sqlcode);
				
				if(!strcmp(chr_l_cmbp_id,APL_NULL_STRING))
				{
					strcpy(chr_l_cmbp_id,chr_depo_map_client_id);
				}
				if(!strcmp(chr_l_dpid,APL_NULL_STRING))
				{
					strcpy(chr_l_dpid,chr_depo_map_dp_id);
				}
				*/
			}

			if(l_dl_deal_struct_h->h_qty > 0)
			{
				/***** Addition of Client Code into table DL_DPINSTRS : ASHISH 06-06-2007 Start *****/

				if(!strcmp(chr_p_depository_code_new,"CDSL"))
				{
					if(strcmp(chr_p_instr_type,"I")==0)
					{
						/* Modified by Minal for Implementation Of DIS in INTELLECT CUSTODY on 12/09/2014 */

						/* START -- Changes done in query by Minal for ICICI_IB_6151_PMS Enhancement_Phase 1 on 06/06/2013 */

						EXEC SQL 
							INSERT INTO DL_DPINSTRS 
							(batch_no,serial_no,trans_type,client,instr_code,qty,setl_date,isin_cd,
							clh_dvp,cmbp_id,dpm_trans_no,rev_flg,other_branch_cd,other_client_id,other_mkt_type,
							other_stlmnt_no,internal_ref_no,send_ref_1,send_ref_2,maker,maker_date,checker,checker_date,
							access_stamp,status,depo_ind,deal_cd,other_dp_id,client_code,transfer_reason_code,reason_purpose,deal_ref_nos)
							VALUES
							(:chr_l_batchseq,:counter,:chr_l_instruction_type,:chr_l_cln_depomap_id,
							:l_dl_deal_struct_h->h_instr_code,:l_dl_deal_struct_h->h_qty,
							:l_dl_deal_struct_h->h_setldt,:chr_l_instr_isin,'D',:chr_l_cmbp_id,NULL,NULL,NULL,:chr_l_dpid,NULL,
							NULL,:chr_l_internal_ref_no,
							:chr_l_send_refno1,NULL,:chr_l_maker,:chr_l_maker_dt,NULL,NULL,:chr_l_access_stamp,'G',
							:chr_p_depository_code_new,:l_dl_deal_struct_h->h_dealcd,:chr_l_cmbp_id,
							:l_dl_deal_struct_h->h_dl_client,:chr_p_transfer_reason_cd,:chr_p_reason_purpose,:l_dl_deal_struct_h->h_indentity_no||',');

						/* END -- Changes done in query by Minal for ICICI_IB_6151_PMS Enhancement_Phase 1 on 06/06/2013 */

						IS_ANY_ORA_ERROR
					}
					else if(strcmp(chr_p_instr_type,"O")==0)
					{
						/* Modified by Minal for Implementation Of DIS in INTELLECT CUSTODY on 12/09/2014 */
						/* START -- Changes done in query by Minal for ICICI_IB_6151_PMS Enhancement_Phase 1 on 06/06/2013 */

						Alert("chr_l_dpid:: |%s| \n",chr_l_dpid);
						Alert("chr_l_cmbp_id:: |%s| \n",chr_l_cmbp_id);

						EXEC SQL 
							INSERT INTO DL_DPINSTRS 
							(batch_no,serial_no,trans_type,client,instr_code,qty,setl_date,isin_cd,
							clh_dvp,cmbp_id,dpm_trans_no,rev_flg,other_branch_cd,other_client_id,other_mkt_type,
							other_stlmnt_no,internal_ref_no,send_ref_1,send_ref_2,maker,maker_date,checker,checker_date,
							access_stamp,status,depo_ind,deal_cd,other_dp_id,client_code,transfer_reason_code,reason_purpose,deal_ref_nos)
							VALUES
							(:chr_l_batchseq,:counter,:chr_l_instruction_type,:chr_l_cln_depomap_id,
							:l_dl_deal_struct_h->h_instr_code,:l_dl_deal_struct_h->h_qty,
							:l_dl_deal_struct_h->h_setldt,:chr_l_instr_isin,'D',:chr_l_dpid,NULL,NULL,NULL,:chr_l_dpid,NULL,
							NULL,:chr_l_internal_ref_no,
							:chr_l_send_refno1,NULL,:chr_l_maker,:chr_l_maker_dt,NULL,NULL,:chr_l_access_stamp,'G',
							:chr_p_depository_code_new,:l_dl_deal_struct_h->h_dealcd,:chr_l_cmbp_id,
							:l_dl_deal_struct_h->h_dl_client,:chr_p_transfer_reason_cd,:chr_p_reason_purpose,:l_dl_deal_struct_h->h_indentity_no||',');

						/* END -- Changes done in query by Minal for ICICI_IB_6151_PMS Enhancement_Phase 1 on 06/06/2013 */

						IS_ANY_ORA_ERROR
					}

					/* START -- Added by Minal for ICICI_IB_6151_PMS Enhancement_Phase 1 on 06/06/2013 */
          Alert("chr_l_cmbp_id PRI :[%s] \n",chr_l_cmbp_id);
          Alert("chr_l_dpid PRI :[%s] \n",chr_l_dpid);
						l_intflag = 0;

						if(strcmp(chr_p_instr_type,"I")==0)
						{

								EXEC SQL 
									UPDATE DL_DEAL 
									SET nds_blk_dt=:chr_l_maker_dt
									WHERE identiy_no = :l_dl_deal_struct_h->h_indentity_no 
									AND client=:l_dl_deal_struct_h->h_dl_client
									AND instr_code = :l_dl_deal_struct_h->h_instr_code ;
					
								IS_ANY_ORA_ERROR

							sprintf(chr_g_log_buffer,"Off Mkt CDSL -I:After UPDATING Details Record for client=|%s| Ident=|%s| \n",l_dl_deal_struct_h->h_dl_client,l_dl_deal_struct_h->h_indentity_no);

								fprintf(g_flogfile,"%s",chr_g_log_buffer);


						} /* End of if chr_p_instr_type is I */
						else if(strcmp(chr_p_instr_type,"O")==0)
						{

								EXEC SQL 
									UPDATE DL_DEAL 
									SET nds_blk_dt=:chr_l_maker_dt 
									WHERE identiy_no = :l_dl_deal_struct_h->h_indentity_no
									AND client=:l_dl_deal_struct_h->h_dl_client
									AND instr_code = :l_dl_deal_struct_h->h_instr_code ;

								IS_ANY_ORA_ERROR

								Alert("\n after update in DL_DPINSTRS: counter is |%d| \n",counter);

								sprintf(chr_g_log_buffer,"Off Mkt CDSL-O:After UPDATING Details Record for client=|%s| Ident=|%s| \n",l_dl_deal_struct_h->h_dl_client,l_dl_deal_struct_h->h_indentity_no);

								fprintf(g_flogfile,"%s",chr_g_log_buffer);

								strcpy(chr_l_identity_no,APL_NULL_STRING);

						} /* End of if chr_p_instr_type is O */

					/* END -- Added by Minal for ICICI_IB_6151_PMS Enhancement_Phase 1 on 06/06/2013 */

				} /* End of if depository code is CDSL */
				else if(!strcmp(chr_p_depository_code_new,"NSDL"))
				{
					/* Modified by Minal for Implementation Of DIS in INTELLECT CUSTODY on 12/09/2014 */
					/* START -- Changes done in query by Minal for ICICI_IB_6151_PMS Enhancement_Phase 1 on 06/06/2013 */

              printf("\n In NSDL Processing B4 insert in DL_DPINSTRS");
					EXEC SQL 
						INSERT INTO DL_DPINSTRS
						(batch_no,serial_no,trans_type,client,instr_code,qty,setl_date,isin_cd,
						clh_dvp,cmbp_id,dpm_trans_no,rev_flg,other_branch_cd,other_client_id,other_mkt_type,
						other_stlmnt_no,internal_ref_no,send_ref_1,send_ref_2,maker,maker_date,checker,checker_date,
						access_stamp,status,depo_ind,deal_cd,other_dp_id,client_code,transfer_reason_code,reason_purpose,deal_ref_nos)
						VALUES
						(:chr_l_batchseq,:counter,:chr_l_instruction_type,:chr_l_cln_depomap_id,
						:l_dl_deal_struct_h->h_instr_code,:l_dl_deal_struct_h->h_qty,
						:l_dl_deal_struct_h->h_setldt,:chr_l_instr_isin,'D',:chr_l_cmbp_id,NULL,NULL,NULL,
						:chr_l_cmbp_id,NULL,NULL,:chr_l_internal_ref_no,
						:chr_l_send_refno1,NULL,:chr_l_maker,:chr_l_maker_dt,NULL,NULL,:chr_l_access_stamp,'G',
						:chr_p_depository_code_new,:l_dl_deal_struct_h->h_dealcd,:chr_l_dpid,
						:l_dl_deal_struct_h->h_dl_client,:chr_p_transfer_reason_cd,:chr_p_reason_purpose,:l_dl_deal_struct_h->h_indentity_no||',');

					/* END -- Changes done in query by Minal for ICICI_IB_6151_PMS Enhancement_Phase 1 on 06/06/2013 */

					IS_ANY_ORA_ERROR


					/* START -- Added by Minal for ICICI_IB_6151_PMS Enhancement_Phase 1 on 06/06/2013 */

						if(strcmp(chr_p_instr_type,"I")==0)
						{
							EXEC SQL 
									UPDATE DL_DEAL
									SET nds_blk_dt=:chr_l_maker_dt 
									WHERE identiy_no = :l_dl_deal_struct_h->h_indentity_no
									AND client=:l_dl_deal_struct_h->h_dl_client
									AND INSTR_CODE = :l_dl_deal_struct_h->h_instr_code ;

								IS_ANY_ORA_ERROR

								sprintf(chr_g_log_buffer,"Off Mkt NSDL-I:After UPDATING Details Record for client=|%s| Iden=|%s|\n",l_dl_deal_struct_h->h_dl_client,l_dl_deal_struct_h->h_indentity_no);

								fprintf(g_flogfile,"%s",chr_g_log_buffer);


						} /* End of if Instr type is I */
						else if(strcmp(chr_p_instr_type,"O")==0)
						{
							EXEC SQL 
									UPDATE DL_DEAL 
									SET nds_blk_dt=:chr_l_maker_dt
									WHERE identiy_no = :l_dl_deal_struct_h->h_indentity_no
									AND client=:l_dl_deal_struct_h->h_dl_client
									AND INSTR_CODE = :l_dl_deal_struct_h->h_instr_code ;							

								IS_ANY_ORA_ERROR

								sprintf(chr_g_log_buffer,"Off Mkt NSDL-O:After UPDATING Details Record for client=|%s| Iden=|%s| \n",l_dl_deal_struct_h->h_dl_client,l_dl_deal_struct_h->h_indentity_no);

								fprintf(g_flogfile,"%s",chr_g_log_buffer);

						} /* End of if Instr type is O */

				} /* End of if depository code is NSDL */
			}
			else if(l_dl_deal_struct_h->h_qty ==  0)
			{
				int_l_zero_qty++;

				sprintf(chr_g_log_buffer,"off mkt ZERO QUANTITY FOR Client = |%s| Instrument = |%s| \n ",l_dl_deal_struct_h->h_dl_client,l_dl_deal_struct_h->h_instr_code);

				fprintf(g_flogfile,"%s",chr_g_log_buffer);

			}

			strcpy(chr_l_refno_str,APL_NULL_STRING);

			/* Added by Hari for IB_6283 */
                       i_cnt=i_cnt+1;
			l_hdr_qty=l_hdr_qty+l_dl_deal_struct_h->h_qty;

		}

		if(strcmp(chr_p_instr_type,"I")==0)
		{
			if(int_l_condexists > 0)
			{
				/* EXEC SQL CLOSE l_cur_gen_offmarket_dpinstr3; */

				EXEC SQL CLOSE l_cur_gen_Ioff_mkt_dpinstr3;
				
				IS_ANY_ORA_ERROR
			}
			else
			{
				EXEC SQL CLOSE l_cur_gen_offmarket_dpinstr1;
				
				IS_ANY_ORA_ERROR
			}
		}

		if(strcmp(chr_p_instr_type,"O")==0)
		{
			/* EXEC SQL CLOSE l_cur_gen_offmarket_dpinstr2;*/

			EXEC SQL CLOSE l_cur_gen_Ooff_mkt_dpinstr2;
			IS_ANY_ORA_ERROR
		}


	/*Commented and Added by Hari for IB_6283 */
	
	/* if(strcmp(chr_p_instr_type,"I")==0)
		{
			int_l_deliver_qty=l_tot_qty;
		}
		else if(strcmp(chr_p_instr_type,"O")==0)	
		{
			int_l_receive_qty=l_tot_qty;
	   } */

	if(strcmp(chr_p_instr_type,"I")==0)
	   {
			int_l_deliver_qty=l_hdr_qty;
		}
	   else if(strcmp(chr_p_instr_type,"O")==0)	
	   {
			int_l_receive_qty=l_hdr_qty;
	   }
	
	/* Commented and Added by Hari for IB_6283 */
		
		/* EXEC SQL INSERT INTO
	  			dl_dpinstr_trail(batch_no,record_type,branch_cd,deliver_qty,receive_qty,										  											tot_qty,status,maker,maker_date,access_stamp)
							 VALUES(:chr_l_batchseq,99,:g_mt_commonsys_params_struct_h.brnch_cd,
									  :int_l_deliver_qty,:int_l_receive_qty,:l_tot_qty,'G',:chr_l_maker,
									  :chr_l_maker_dt,:chr_l_access_stamp); */

		sprintf(chr_g_log_buffer,"\n No. of off mkt Records : |%d|",i_cnt);	
		fprintf(g_flogfile,"%s",chr_g_log_buffer);

		EXEC SQL INSERT INTO dl_dpinstr_hdr(batch_no,record_type,dp_id,dp_role,buy_sell_flg,status,tot_num_record,tot_qty,maker,maker_date,access_stamp)VALUES(:chr_l_batchseq,01,:chr_p_dp_id,01,DECODE(:chr_p_instr_type,'I','S','O','B'),'G',:i_cnt,:l_hdr_qty,:chr_l_maker,:chr_l_maker_dt,:chr_l_access_stamp); 
		
		IS_ANY_ORA_ERROR

/*In Following Query for Branch Code g_mt_commonsys_params_struct_h.brnch_cd is replaced with hvDpBranchCd - 18122015 - PriyankaB*/
		
		EXEC SQL INSERT INTO dl_dpinstr_trail(batch_no,record_type,branch_cd,deliver_qty,receive_qty,tot_qty,status,maker,maker_date,access_stamp)VALUES(:chr_l_batchseq,99,:hvDpBranchCd,:int_l_deliver_qty,:int_l_receive_qty,:l_hdr_qty,'G',:chr_l_maker,:chr_l_maker_dt,:chr_l_access_stamp);

		IS_ANY_ORA_ERROR	

		/* Added by Hari for IB_6460 - start */
		i_cnt=0;
		l_hdr_qty=0.0;
		/* Added by Hari for IB_6460 - end */

		/* ASHISH 30-09-2008 */
		EXEC SQL 
			UPDATE DL_DPINSTR_HDR 
			SET tot_num_record = tot_num_record - :int_l_zero_qty 
			WHERE batch_no=:chr_l_batchseq;
			
		IS_ANY_ORA_ERROR

		fprintf(g_flogfile,"off mktNo of Zero Quantity Records = |%d| \n",int_l_zero_qty);	

	}

	APL_GOBACK_SUCCESS


	RETURN_SUCCESS:
	{
		APL_FREE(l_dl_deal_struct_h)

		APL_FREE(l_dl_deal_struct_i)

		CO_ProcMonitor(g_flogfile," Leaving Proc_GenOffMkt_Instrn With Success",NULL,NULL);
		return(APL_SUCCESS);
	}

	RETURN_FAILURE:
	{
		APL_FREE(l_dl_deal_struct_h)

		APL_FREE(l_dl_deal_struct_i)

		sprintf(chr_g_log_buffer,"Leaving Proc_GenOffMkt_Instrn With Failure ORA|%d|\n",sqlca.sqlcode);	
		CO_ProcMonitor(g_flogfile,chr_g_log_buffer,NULL,NULL);
		return(APL_FAILURE);	
	}

} /* Processing OFF MARKET RECORDS - END */

  int Proc_GenDVP_Instrn_master904(char *chr_p_instr_type,
						  char *chr_p_trns_type,
						  char *chr_p_depository_code,
						  char *chr_p_file_type,
						  char *chr_p_deal_date,
						  char *chr_p_exch_code,
						  char *chr_p_settlement_no,
						  char *chr_p_mkt_type,
						  char *chr_p_dp_id,
						  char *chr_p_user,
						  FILE *g_flogfile,
						  INTL_ENV_DATA_STRUCT_H *l_intl_env_data_h,
						  DEBUG_INFO_STRUCT_H **l_debug_info_ptr)
  {

	FILE  *l_ptr_ini_file = NULL;
	FILE  *l_ptr_handoff_file = NULL;
	char  chr_g_log_buffer[BUFFER_LEN] = APL_NULL_STRING;
	char  chr_l_inifile[100]= APL_NULL_STRING;
	char  chr_l_handoff_dir[PATH_LENGTH]= APL_NULL_STRING;
    char  chr_l_handoff_file_name[FILENAME_LEN_A]= APL_NULL_STRING;	
	char  chr_l_header[100]= APL_NULL_STRING;
	char  chr_l_trailer[200]= APL_NULL_STRING;
	char  chr_l_detail_rec[1000] =APL_NULL_STRING;
	int   int_l_batchseq=0;
	int   counter=0;
	char  chr_l_instr_isin[13]= APL_NULL_STRING;
	char  chr_l_oth_cmbpid[29]= APL_NULL_STRING;
	char  chr_l_oth_setlno[8]= APL_NULL_STRING;
	char  chr_l_oth_mkt_type[3]= APL_NULL_STRING;
	char  chr_l_remark[21]= APL_NULL_STRING;
	char  chr_l_send_refno1[51]= APL_NULL_STRING;
	char  chr_l_send_refno2[51]= APL_NULL_STRING; 
	char  chr_l_depo_part_code[21]=APL_NULL_STRING;
	char  chr_l_cmbp_id[29]=APL_NULL_STRING;
	char  chr_l_pms_cmbpid[29]=APL_NULL_STRING; 
	char  chr_l_pms_client_cmbp_pid[29]=APL_NULL_STRING; 
	char  chr_l_client_cpid[29]=APL_NULL_STRING; 
	char  chr_l_pms_cmbpid_t2t[29]=APL_NULL_STRING; 
	char  chr_l_pms_client_cmbp_pid_t2t[29]=APL_NULL_STRING; 
	char  chr_l_client_cpid_t2t[29]=APL_NULL_STRING; 
	char  chr_l_dpid[21]=APL_NULL_STRING;
	int   int_l_len=0;
 	char  chr_p_depository_code_new[5]= APL_NULL_STRING;
    char  chr_p_instr_type_new=APL_NULL_CHAR; 
	int	  int_l_records=0;
	char  chr_l_dprole[3]= APL_NULL_STRING;
	char  chr_l_user[APL_USERID_LEN] = APL_NULL_STRING;
	char  pro_sys_date[APL_DATE_LEN] = APL_NULL_STRING;
	char  chr_l_maker[APL_USERID_LEN] = APL_NULL_STRING;
	char  chr_l_maker_dt[APL_DATE_LEN] = APL_NULL_STRING;
	char  chr_l_access_stamp[APL_DATE_LEN] = APL_NULL_STRING;
	char  chr_l_internal_ref_no[36] = APL_NULL_STRING;
	char  chr_l_settlement_dt[20] = APL_NULL_STRING;
	char  chr_l_instruction_type[4] = APL_NULL_STRING;
	double l_tot_qty=0.0;
	char  chr_l_identiy_no[17]= APL_NULL_STRING;
	char  chr_l_rowid[100]= APL_NULL_STRING;
	char  chr_l_nds_blk_dt[20] = APL_NULL_STRING;
	char  chr_l_refno_str[4001]= APL_NULL_STRING;
	int   counter2=0;
	double l_int_purchasesum=0.0;
	double l_int_salesum=0.0;
	double l_int_net_amt=0.0;
	char l_chr_instr_code[9]= APL_NULL_STRING;
	char chr_l_cln_depomap_id[21]= APL_NULL_STRING;
	char chr_l_flg='Y';
	char chr_l_identiy_t2t[18]= APL_NULL_STRING;
	double int_l_deliver_qty=0.0;
	double int_l_receive_qty=0.0;
	int int_l_zero_qty=0;
	char chr_l_dl_class[DL_DL_CLASS_LEN]=APL_NULL_STRING;
	char chr_l_set_exch_cd[11]=APL_NULL_STRING;
	short i_set_exch_cd=0;
	char chr_l_stl_mkt_type[4]=APL_NULL_STRING;
	short i_stl_mkt_type=0;
	char chr_l_setl_no[10]=APL_NULL_STRING;
	short i_setl_no=0;
	char  chr_l_master_dp_id[29]=APL_NULL_STRING;
	char  chr_l_pos_req_flg[2]=APL_NULL_STRING;
	short i_nds_blk_dt=0;
	int counter_mast=0;
	short i_cmbp_id=0;
	short i_pms_client_cmbpid=0; 
	short i_pms_client_cmbpid_t2t=0; 
	short i_instr_isin=0;
	short i_dpid=0;
	short i_depo_part_code=0;
	short i_int_l_records=0;
	short i_l_tot_qty=0;
	short i_settlement_dt=0;
	short i_purchasesum=0;
	short i_salesum=0;
	short i_cln_depomap_id=0;
	short i_dl_class=0;
	
	SYS_DL_DEAL_STRUCT_H  *l_dl_deal_struct_h = NULL;
    SYS_DL_DEAL_STRUCT_I  *l_dl_deal_struct_i = NULL;	
		
	l_dl_deal_struct_h=(SYS_DL_DEAL_STRUCT_H *)calloc(1,sizeof(SYS_DL_DEAL_STRUCT_H));
	APL_MALLOC_FAIL(l_dl_deal_struct_h)
	l_dl_deal_struct_i=(SYS_DL_DEAL_STRUCT_I *)calloc(1,sizeof(SYS_DL_DEAL_STRUCT_I));
	APL_MALLOC_FAIL(l_dl_deal_struct_i)

	memset(l_dl_deal_struct_h, NULL, sizeof(SYS_DL_DEAL_STRUCT_H));
	memset(l_dl_deal_struct_i, NULL, sizeof(SYS_DL_DEAL_STRUCT_I));
	memset(chr_g_log_buffer,APL_NULL_CHAR,BUFFER_LEN);
	memset(chr_l_set_exch_cd, APL_NULL_CHAR, sizeof(chr_l_set_exch_cd));
	memset(chr_l_stl_mkt_type, APL_NULL_CHAR, sizeof(chr_l_stl_mkt_type));
	memset(chr_l_setl_no, APL_NULL_CHAR, sizeof(chr_l_setl_no));

	EXEC SQL BEGIN DECLARE SECTION;
		EXEC SQL VAR chr_p_depository_code_new IS STRING;
		EXEC SQL VAR chr_l_header IS STRING;
		EXEC SQL VAR chr_l_trailer IS STRING;
		EXEC SQL VAR chr_l_instruction_type IS STRING;	
		EXEC SQL VAR chr_l_depo_part_code IS STRING;	
		EXEC SQL VAR chr_l_instr_isin IS STRING;
		EXEC SQL VAR chr_l_maker IS STRING;
		EXEC SQL VAR chr_l_maker_dt IS STRING;
		EXEC SQL VAR chr_l_access_stamp IS STRING;
		EXEC SQL VAR chr_l_settlement_dt IS STRING;
		EXEC SQL VAR chr_l_identiy_no IS STRING;
		EXEC SQL VAR chr_l_cln_depomap_id IS STRING;
		EXEC SQL VAR chr_l_identiy_t2t IS STRING;
		EXEC SQL VAR chr_l_dl_class IS STRING;
	EXEC SQL END DECLARE SECTION;
	

	Alert("Enter Proc_GenDVP_Instrn_master904");
	strcpy(chr_l_maker,chr_p_user);

	if (  CO_RtvSysDt(pro_sys_date,l_debug_info_ptr) == APL_FAILURE )
	{
		APL_GOBACK_FAIL
	}
	
	strcpy(chr_l_maker_dt,pro_sys_date);
		
	if (  CO_RtvSysDtTime(pro_sys_date,l_debug_info_ptr) == APL_FAILURE )
    {
		APL_GOBACK_FAIL
	}
	
	strcpy(chr_l_access_stamp,pro_sys_date);

	fprintf(g_flogfile,"DVP master:Inside Function Values Are .... \n");	 	 
	fprintf(g_flogfile,"DVP master:chr_p_instr_type|%s|\n",chr_p_instr_type);	
	fprintf(g_flogfile,"DVP master:chr_p_trns_type|%s|\n",chr_p_trns_type);	
	fprintf(g_flogfile,"DVP master:chr_p_depository_code|%s|\n",chr_p_depository_code);	
	fprintf(g_flogfile,"DVP master:chr_p_file_type|%s|\n",chr_p_file_type);	
	fprintf(g_flogfile,"DVP master:chr_p_deal_date|%s|\n",chr_p_deal_date);	
	fprintf(g_flogfile,"DVP master:chr_p_exch_code|%s|\n",chr_p_exch_code);	
	fprintf(g_flogfile,"DVP master:chr_p_settlement_no|%s|\n",chr_p_settlement_no);	
	fprintf(g_flogfile,"DVP master:chr_p_mkt_type|%s|\n",chr_p_mkt_type);	
	fprintf(g_flogfile,"DVP master:chr_p_dp_id|%s|\n",chr_p_dp_id);	
	 
	EXEC SQL SELECT DECODE(:chr_p_depository_code,'N','NSDL','C','CDSL') INTO :chr_p_depository_code_new FROM dual;
	IS_ANY_ORA_ERROR
		
	/******************************start******************************************/
	EXEC SQL DECLARE l_cur_dpinstrmaster_dpid CURSOR FOR
	SELECT distinct f.DP_ID
	FROM Dl_Deal a ,
	mt_instrument c,
	mt_cli_depo_map d,
	dl_dpgen_det f
	WHERE a.client                     =f.dl_client
	AND a.identiy_no                   =f.dl_ref_no
	AND NVL(f.gendp_flg,'N')           ='Y'
	AND a.client                       =d.cln_code
	AND a.instr_code                   =c.instr_code
	AND d.cln_depo_code                =:chr_p_depository_code_new
	AND d.cln_depo_map_dp_id           =:chr_p_dp_id
	AND (a.deal_cd                     = DECODE(:chr_p_instr_type,'I','1','O','2')
	OR a.deal_cd                       = DECODE(:chr_p_instr_type,'I','3','O','4'))
	AND a.exch_code                    =:chr_p_exch_code
	AND a.settlement_no                =:chr_p_settlement_no
	AND ((:chr_p_mkt_type in ('13','22') and a.mkt_type in ('13','22')) or (:chr_p_mkt_type in ('49','50') and a.mkt_type in ('49','50'))
or (:chr_p_mkt_type in ('5','16') and a.mkt_type in ('5','16')) or (:chr_p_mkt_type in ('41','17') and a.mkt_type in ('41','17')) 
or (a.mkt_type=:chr_p_mkt_type)
)
	AND TO_CHAR(deal_date,'DD/MM/YYYY')=:chr_p_deal_date
	AND a.clh_flg                      =:chr_p_trns_type
	AND a.deal_stat                    ='CC'
	//AND a.mkt_type			!= DECODE(a.exch_code,'NSE','22','BSE','16','MCS','03')
	AND ( ( (f.DP_ID IS NOT NULL)
	AND (f.DP_ID ||CLIENT_ID)           !=(select CLN_DEPO_MAP_DP_ID||CLN_DEPO_MAP_CLIENT_ID from mt_cli_depo_map where cln_code=f.dl_client and cln_depo_code=:chr_p_depository_code_new) ) )
	AND f.DP_GENERATED='N';

	EXEC SQL OPEN l_cur_dpinstrmaster_dpid;
	IS_ANY_ORA_ERROR
	
	for(;;)
	{	
		memset(chr_l_master_dp_id,APL_NULL_CHAR,sizeof(chr_l_master_dp_id));
		EXEC SQL FETCH l_cur_dpinstrmaster_dpid INTO :chr_l_master_dp_id;
		
		if(APL_ZERO_RESULT_SET)
		{	
			if(counter_mast==0)
			 {
				fprintf(g_flogfile,"No Records Found in l_cur_dpinstrmaster_dpid CURSOR!" );
			 }
			 break;
		}
		IS_ANY_ORA_ERROR			
		counter_mast++;
	
		EXEC SQL SELECT COUNT(*),NVL(SUM(X.tot_qty),0) INTO :int_l_records:i_int_l_records,:l_tot_qty:i_l_tot_qty
		FROM (SELECT COUNT(*),DECODE(:chr_p_instr_type,'I',NVL(SUM(f.qty),0),'O',NVL(SUM(a.qty),0)) AS tot_qty 
		FROM Dl_Deal a , mt_instrument c,mt_cli_depo_map d,dl_dpgen_det f
		WHERE a.client=f.dl_client
		AND a.identiy_no=f.dl_ref_no
		AND NVL(f.gendp_flg,'N')='Y'
		AND a.client=d.cln_code
		AND a.instr_code=c.instr_code
		AND d.cln_depo_code=:chr_p_depository_code_new
		AND d.cln_depo_map_dp_id=:chr_p_dp_id
		AND (a.deal_cd = DECODE(:chr_p_instr_type,'I','1','O','2') OR
		a.deal_cd = DECODE(:chr_p_instr_type,'I','3','O','4'))
		AND a.exch_code=:chr_p_exch_code
		AND a.settlement_no=:chr_p_settlement_no
		AND ((:chr_p_mkt_type in ('13','22') and a.mkt_type in ('13','22')) or (:chr_p_mkt_type in ('49','50') and a.mkt_type in ('49','50'))
or (:chr_p_mkt_type in ('5','16') and a.mkt_type in ('5','16')) or (:chr_p_mkt_type in ('41','17') and a.mkt_type in ('41','17')) 
or (a.mkt_type=:chr_p_mkt_type)
)
		AND TO_CHAR(deal_date,'DD/MM/YYYY')=:chr_p_deal_date
		AND a.clh_flg=:chr_p_trns_type
		AND a.deal_stat='CC'
		//AND a.mkt_type!=DECODE(a.exch_code,'NSE','22','BSE','16','MCS','03') 
		//AND a.NDS_BLK_DT is null
		AND f.DP_GENERATED!='Y'
			AND ( ( (f.DP_ID IS NOT NULL)
	AND (f.DP_ID ||CLIENT_ID)           !=(select CLN_DEPO_MAP_DP_ID||CLN_DEPO_MAP_CLIENT_ID from mt_cli_depo_map where cln_code=f.dl_client and cln_depo_code=:chr_p_depository_code_new) ) )
		and f.DP_ID=:chr_l_master_dp_id
		GROUP BY a.client,d.cln_depo_map_client_id,a.instr_code,a.exch_code,
		a.settlement_no,a.mkt_type,a.deal_cd,c.instr_isin,a.setl_date,
		f.broker_cmbpid,f.cp_clnid,f.broker_dpid,f.cp_dpid,a.ex_arena,f.exec_dt,a.dl_class) X;
				
		Alert("After Count Query");
		if(int_l_records==0)
		{
			fprintf(g_flogfile,"DVP master: NO Records Found For the Given Criteria !!!");
			 chr_l_flg='N';
		}
		IS_ANY_ORA_ERROR

		printf("No Of DVP master Records|%d| \n",int_l_records);
		sprintf(chr_g_log_buffer,"\n No Of DVP master Records|%d|",int_l_records);	
		fprintf(g_flogfile,"%s",chr_g_log_buffer);
		  
		if(chr_l_flg== 'Y')
		{
			EXEC SQL SELECT DL_DPINSTRSEQ.NEXTVAL INTO :int_l_batchseq FROM DUAL;
			IS_ANY_ORA_ERROR
			/********************** Inserting Header Record **********************/
			printf("batch_no is %d\n",int_l_batchseq);
			printf("chr_p_dp_id is %s\n",chr_p_dp_id);
			printf("int_l_records is %d\n",int_l_records);
			printf("l_tot_qty is %f\n",l_tot_qty);//AIX Warning Removal
			printf("int_l_batchseq=|%d| \n",int_l_batchseq);
			printf("chr_l_maker=|%s| \n",chr_l_maker);
			printf("chr_l_maker_dt=|%s| \n",chr_l_maker_dt);
			printf("chr_l_access_stamp=|%s| \n",chr_l_access_stamp);
		  
			Alert("Before Insert Header Query");

			EXEC SQL INSERT INTO dl_dpinstr_hdr
			(batch_no,record_type,dp_id,dp_role,buy_sell_flg,status,tot_num_record,
			tot_qty,maker,maker_date,access_stamp)
			VALUES(:int_l_batchseq,01,:chr_p_dp_id,01,DECODE(:chr_p_instr_type,'I','S','O','B'),'G',:int_l_records,:l_tot_qty,:chr_l_maker,:chr_l_maker_dt,:chr_l_access_stamp);
			
			IS_ANY_ORA_ERROR
			
			Alert("After Insert Header Query");
			printf("\n DVP master Cursor:After Inserting Header Record \n");

			fprintf(g_flogfile,"DVP master Cursor:After Inserting Header Record");
			fflush(g_flogfile);
			counter=0;
			/********************** Inserting Header Record **********************/			
				Alert("Before Cursor declare for O ");
				EXEC SQL DECLARE l_cur_gen_dvp_dpinstr_mst CURSOR FOR	
				SELECT a.client,f.CLIENT_ID,a.instr_code,a.exch_code,a.mkt_type,a.settlement_no,a.deal_cd,
				DECODE(:chr_p_instr_type,'I',NVL(SUM(f.qty),0),'O',NVL(SUM(f.qty),0)) AS QTY,
				DECODE(a.ex_arena,'2',f.cp_dpid,f.broker_cmbpid) as CMBPID,
				DECODE(a.ex_arena,'2',f.cp_clnid,f.broker_dpid) as DPID,
				c.instr_isin,
				f.exec_dt,
				a.dl_class,
				a.domestic_cpclt,
				a.deal_date
				FROM Dl_Deal a , mt_instrument c,mt_cli_depo_map d,dl_dpgen_det f
				WHERE a.client=f.dl_client
				AND a.identiy_no=f.dl_ref_no
				AND NVL(f.gendp_flg,'N')='Y'
				AND a.client=d.cln_code
				AND a.instr_code=c.instr_code
				AND d.cln_depo_code=:chr_p_depository_code_new
				AND d.cln_depo_map_dp_id=:chr_p_dp_id
				AND (a.deal_cd = DECODE(:chr_p_instr_type,'I','1','O','2') OR
			  	a.deal_cd = DECODE(:chr_p_instr_type,'I','3','O','4'))
				AND a.exch_code=:chr_p_exch_code
				AND a.settlement_no=:chr_p_settlement_no
				AND ((:chr_p_mkt_type in ('13','22') and a.mkt_type in ('13','22')) or (:chr_p_mkt_type in ('49','50') and a.mkt_type in ('49','50'))
or (:chr_p_mkt_type in ('5','16') and a.mkt_type in ('5','16')) or (:chr_p_mkt_type in ('41','17') and a.mkt_type in ('41','17')) 
or (a.mkt_type=:chr_p_mkt_type)
)
				AND TO_CHAR(deal_date,'DD/MM/YYYY')=:chr_p_deal_date
				AND a.clh_flg=:chr_p_trns_type
				AND a.deal_stat='CC'
				//AND a.mkt_type!=DECODE(a.exch_code,'NSE','22','BSE','16','MCS','03') 
				//AND a.NDS_BLK_DT is null
					AND ( ( (f.DP_ID IS NOT NULL)
				AND (f.DP_ID ||CLIENT_ID)           !=(select CLN_DEPO_MAP_DP_ID||CLN_DEPO_MAP_CLIENT_ID from mt_cli_depo_map where cln_code=f.dl_client and cln_depo_code=:chr_p_depository_code_new) ) )
				and f.DP_ID=:chr_l_master_dp_id
				AND f.DP_GENERATED!='Y'
				GROUP BY a.ex_arena,a.client,f.CLIENT_ID,a.instr_code,a.exch_code,a.settlement_no,a.mkt_type,a.deal_cd,
				c.instr_isin,a.setl_date,
				f.broker_cmbpid,f.cp_clnid,f.broker_dpid,f.cp_dpid,f.exec_dt,a.dl_class,a.domestic_cpclt,a.deal_date;
			
				EXEC SQL OPEN l_cur_gen_dvp_dpinstr_mst;
				IS_ANY_ORA_ERROR
				
		   for(;;)
		   {
			    
				memset(l_dl_deal_struct_h, NULL, sizeof(SYS_DL_DEAL_STRUCT_H));
				memset(l_dl_deal_struct_i, NULL, sizeof(SYS_DL_DEAL_STRUCT_I));
				memset(chr_l_refno_str,APL_NULL_CHAR,4001);
				memset(chr_l_cmbp_id,APL_NULL_CHAR,sizeof(chr_l_cmbp_id));
				memset(chr_l_dpid,APL_NULL_CHAR,sizeof(chr_l_dpid));
				memset(chr_l_instr_isin,APL_NULL_CHAR,sizeof(chr_l_instr_isin));
				memset(chr_l_dl_class,APL_NULL_CHAR,sizeof(chr_l_dl_class));
				memset(chr_l_pms_client_cmbp_pid,APL_NULL_CHAR,sizeof(chr_l_pms_client_cmbp_pid));
				memset(chr_l_set_exch_cd, APL_NULL_CHAR, sizeof(chr_l_set_exch_cd));
				memset(chr_l_stl_mkt_type, APL_NULL_CHAR, sizeof(chr_l_stl_mkt_type));
				memset(chr_l_setl_no, APL_NULL_CHAR, sizeof(chr_l_setl_no));			
				if(strcmp(chr_p_instr_type,"O")==0)
				{	
					Alert("Before Cursor Fetch for O ");
					EXEC SQL FETCH l_cur_gen_dvp_dpinstr_mst INTO 
					:l_dl_deal_struct_h->h_dl_client:l_dl_deal_struct_i->i_dl_client,
					:chr_l_cln_depomap_id:i_cln_depomap_id,	
					:l_dl_deal_struct_h->h_instr_code:l_dl_deal_struct_i->i_instr_code,
					:l_dl_deal_struct_h->h_exch_code:l_dl_deal_struct_i->i_exch_code,
					:l_dl_deal_struct_h->h_mkt_type:l_dl_deal_struct_i->i_mkt_type,	
					:l_dl_deal_struct_h->h_settlement_no:l_dl_deal_struct_i->i_settlement_no,
					:l_dl_deal_struct_h->h_dealcd:l_dl_deal_struct_i->i_dealcd,
					:l_dl_deal_struct_h->h_qty:l_dl_deal_struct_i->i_qty,
					:chr_l_cmbp_id:i_cmbp_id,
					:chr_l_dpid:i_dpid,
					:chr_l_instr_isin:i_instr_isin,
					:l_dl_deal_struct_h->h_setldt:l_dl_deal_struct_i->i_setldt,
					:chr_l_dl_class:i_dl_class,
					:l_dl_deal_struct_h->h_domcpclt_cd:l_dl_deal_struct_i->i_domcpclt_cd,
					:l_dl_deal_struct_h->h_dlt:l_dl_deal_struct_i->i_dlt;
				
					if(APL_ZERO_RESULT_SET)
					{
						if(counter==0)
						{
							fprintf(g_flogfile,"No Records Found in l_cur_gen_dvp_dpinstr_mst CURSOR!" );
						}
						break;
				    }
					IS_ANY_ORA_ERROR
		
				}	
				Alert("After Cursor Fetch ");

				counter++;
				
				sprintf(chr_l_internal_ref_no,"%d%d",int_l_batchseq,counter);
				strcpy(chr_l_send_refno1,chr_l_internal_ref_no);

				sprintf(chr_g_log_buffer,"\n DVP Master: Internal Ref No=|%s|",chr_l_internal_ref_no);	
				fprintf(g_flogfile,"%s",chr_g_log_buffer);

				//EXEC SQL SELECT :l_dl_deal_struct_h->h_dealcd INTO :chr_p_instr_type_new FROM dual;
				IS_ANY_ORA_ERROR 
		 
				sprintf(chr_g_log_buffer,"\n DVP********DEAL CD**************=|%c| ",chr_p_instr_type_new);	
				fprintf(g_flogfile,"%s",chr_g_log_buffer);
//////////////////////////////////other market type//////////////////
			Alert("\n a1 Swapnil for Mkt_Type_22 issue : chr_l_set_exch_cd = |%s|",chr_l_set_exch_cd);
			Alert("\n a1 Swapnil for Mkt_Type_22 issue : PTY_CODE = |%s|",l_dl_deal_struct_h->h_domcpclt_cd);	
			
                   EXEC SQL SELECT SET_EXCH_CODE INTO :chr_l_set_exch_cd:i_set_exch_cd
		   FROM MT_PARTY WHERE PTY_CODE=:l_dl_deal_struct_h->h_domcpclt_cd;
		
		   IS_ANY_ORA_ERROR

			Alert("\n a2 Swapnil for Mkt_Type_22 issue : chr_l_stl_mkt_type = |%s|",chr_l_stl_mkt_type);		   
			Alert("\n a2 Swapnil for Mkt_Type_22 issue : chr_l_set_exch_cd = |%s|",chr_l_set_exch_cd);
			Alert("\n a2 Swapnil for Mkt_Type_22 issue : TRD_MKT_TYPE = |%s|",l_dl_deal_struct_h->h_mkt_type);
			Alert("\n a2 Swapnil for Mkt_Type_22 issue : TRD_EXCH = |%s|",l_dl_deal_struct_h->h_exch_code);		   
			Alert("\n a2 Swapnil for Mkt_Type_22 issue : sqlca.sqlcode = |%d|",sqlca.sqlcode);		   
		   
		   EXEC SQL SELECT SETT_MKT_TYPE  INTO :chr_l_stl_mkt_type:i_stl_mkt_type FROM STATIC_TRAD_SETT_EXCH
							WHERE TRD_MKT_TYPE = :l_dl_deal_struct_h->h_mkt_type
							AND TRD_EXCH = :l_dl_deal_struct_h->h_exch_code
							AND  SETT_EXCH      = decode(:chr_l_set_exch_cd,'NSCCL','NSE','ICCL','BSE');
							Alert("\n shrinath8 \n");
		IS_ANY_ORA_ERROR
		
			Alert("\n a3 Swapnil for Mkt_Type_22 issue : chr_l_setl_no = |%s|",chr_l_setl_no);	
			Alert("\n a3 Swapnil for Mkt_Type_22 issue : chr_l_stl_mkt_type = |%s|",chr_l_stl_mkt_type);	
			Alert("\n a3 Swapnil for Mkt_Type_22 issue : START_DATE = |%s|",l_dl_deal_struct_h->h_dlt);	
			Alert("\n a3 Swapnil for Mkt_Type_22 issue : sqlca.sqlcode = |%d|",sqlca.sqlcode);			
			
		EXEC SQL SELECT SETTL_NO INTO :chr_l_setl_no:i_setl_no from mt_settl_cal a where EXCH_CODE = decode(:chr_l_set_exch_cd,'NSCCL','NSE','ICCL','BSE')
			AND settl_type = :chr_l_stl_mkt_type 
			AND START_DATE =to_date(:l_dl_deal_struct_h->h_dlt,'dd/MM/yyyy hh24:mi:ss');
			
			Alert("\n a4 Swapnil for Mkt_Type_22 issue : chr_l_setl_no = |%s|",chr_l_setl_no);
			Alert("\n a4 Swapnil for Mkt_Type_22 issue : h_settlement_no = |%s|",l_dl_deal_struct_h->h_settlement_no);
			Alert("\n a4 Swapnil for Mkt_Type_22 issue : sqlca.sqlcode = |%d|",sqlca.sqlcode);			
			
			if ((!strlen(chr_l_stl_mkt_type) || !strlen(chr_l_setl_no)))
			{
			Alert("\n shrinath99999999999999999999 \n");
				strcpy(chr_l_stl_mkt_type,l_dl_deal_struct_h->h_mkt_type);
				strcpy(chr_l_setl_no,l_dl_deal_struct_h->h_settlement_no);
			}
		Alert("chr_l_set_exch_cd:==|%s|, chr_l_stl_mkt_type==|%s|,chr_l_setl_no==|%s|,domestic_cpclt=|%s|,deal_date==|%s|",chr_l_set_exch_cd,chr_l_stl_mkt_type,chr_l_setl_no,l_dl_deal_struct_h->h_domcpclt_cd,l_dl_deal_struct_h->h_dlt);	
			IS_ANY_ORA_ERROR

				strcpy(chr_l_instruction_type,"904");				
		 
				printf("\n CLIENT=|%s| \n",l_dl_deal_struct_h->h_dl_client);
				Alert("Before Inner Cursor Declare  ");

					EXEC SQL DECLARE l_cur_upd_dpm_dvp_mst CURSOR FOR
					SELECT identiy_no,f.rowid,NDS_BLK_DT
					FROM Dl_Deal a ,mt_instrument c,mt_cli_depo_map d,dl_dpgen_det f
					where a.client=d.cln_code
					and  a.client=:l_dl_deal_struct_h->h_dl_client
					and a.instr_code=c.instr_code
					and a.instr_code=:l_dl_deal_struct_h->h_instr_code
					and a.identiy_no=f.dl_ref_no
					AND a.client=f.dl_client
					AND NVL(f.gendp_flg,'N')='Y'
					AND a.exch_code=:l_dl_deal_struct_h->h_exch_code
					AND a.settlement_no=:l_dl_deal_struct_h->h_settlement_no
					AND a.mkt_type=:l_dl_deal_struct_h->h_mkt_type
					//AND a.mkt_type!=DECODE(a.exch_code,'NSE','22','BSE','16','MCS','03') /*Added by PT MCS*/
					AND to_char(deal_date,'DD/MM/YYYY')=:chr_p_deal_date
					AND (a.deal_cd = DECODE(:chr_p_instr_type,'I','1','O','2') OR a.deal_cd = DECODE(:chr_p_instr_type,'I','3','O','4'))	 
					AND  d.CLN_DEPO_CODE=:chr_p_depository_code_new
					AND  d.CLN_DEPO_MAP_DP_ID=:chr_p_dp_id
					AND a.clh_flg=:chr_p_trns_type
					AND a.deal_stat='CC'
					AND f.DP_GENERATED!='Y'
					AND ( ( (f.DP_ID IS NOT NULL)
				AND (f.DP_ID ||CLIENT_ID)           !=(select CLN_DEPO_MAP_DP_ID||CLN_DEPO_MAP_CLIENT_ID from mt_cli_depo_map where cln_code=f.dl_client and cln_depo_code=:chr_p_depository_code_new) ) )
				and f.DP_ID=:chr_l_master_dp_id					
					AND DECODE(a.ex_arena,'2',f.cp_dpid,f.broker_cmbpid)=:chr_l_cmbp_id
					AND DECODE(a.ex_arena,'2',f.cp_clnid,f.broker_dpid)=:chr_l_dpid	;
					//AND a.NDS_BLK_DT is null;	 
	   	
					EXEC SQL OPEN l_cur_upd_dpm_dvp_mst;
					IS_ANY_ORA_ERROR

				Alert("After Inner Cursor Declare  ");

				for(;;)
				{
					
					memset(chr_l_pos_req_flg,APL_NULL_CHAR,sizeof(chr_l_pos_req_flg));
					memset(chr_l_identiy_no,APL_NULL_CHAR,sizeof(chr_l_identiy_no));
					memset(chr_l_rowid,APL_NULL_CHAR,sizeof(chr_l_rowid));
					memset(chr_l_nds_blk_dt,APL_NULL_CHAR,sizeof(chr_l_nds_blk_dt));
					EXEC SQL FETCH l_cur_upd_dpm_dvp_mst INTO :chr_l_identiy_no,:chr_l_rowid,:chr_l_nds_blk_dt:i_nds_blk_dt;

					Alert("After Inner Cursor fetch |%d|",sqlca.sqlcode);
 
					if(APL_ZERO_RESULT_SET)
					{
						if(counter==0)
						{
							fprintf(g_flogfile,"No Records Found in l_cur_upd_dpm_dvp_mst CURSOR!" );
						}
						break;

					}
					IS_ANY_ORA_ERROR

					if(l_dl_deal_struct_h->h_qty > 0)
					{
						printf("\n [DVP:NonT2T] Updating DP Generation Date for Account|%s|, RefNo|%s| with Date |%s|..",l_dl_deal_struct_h->h_dl_client,chr_l_identiy_no,chr_l_maker_dt);
						fflush(stdout);
						fprintf(g_flogfile,"\n [DVP:NonT2T] Updating DP Generation Date for Account|%s|, RefNo|%s| with Date |%s|",l_dl_deal_struct_h->h_dl_client,chr_l_identiy_no,chr_l_maker_dt);
						Alert("chr_l_nds_blk_dt==>|%s|",chr_l_nds_blk_dt);
						if(strcmp(chr_l_nds_blk_dt,"")==0)
						{
							EXEC SQL UPDATE DL_DEAL SET NDS_BLK_DT=:chr_l_maker_dt WHERE
							identiy_no = :chr_l_identiy_no AND
							client=:l_dl_deal_struct_h->h_dl_client;
							Alert("inside if|%d|",sqlca.sqlcode);
							IS_ANY_ORA_ERROR
							strcpy(chr_l_pos_req_flg,"Y");
						}
						else
						{
							strcpy(chr_l_pos_req_flg,"N");	
						}
						Alert("1==>|%s|",chr_l_rowid);
						Alert("2==>|%s|",l_dl_deal_struct_h->h_dl_client);
						Alert("3==>|%s|",chr_l_identiy_no);
							EXEC SQL UPDATE DL_DPGEN_DET SET DP_GENERATED='Y' WHERE
							DL_REF_NO = :chr_l_identiy_no AND
							DL_CLIENT=:l_dl_deal_struct_h->h_dl_client
							AND ROWID=:chr_l_rowid;
							Alert("inside if|%d|",sqlca.sqlcode);
							IS_ANY_ORA_ERROR
						
						if(sqlca.sqlcode)
						{
							fprintf(g_flogfile,"DVP:Error Updating NDS_BLK_DT ORA|%d|\n",sqlca.sqlcode);
						}
						Alert("After Update DL_DEAL ");
						IS_ANY_ORA_ERROR
						Alert("After Update DL_DEAL ");

						printf("\n STRING counter=|%d| \n",counter);

						strcat(chr_l_refno_str,chr_l_identiy_no);
						strcat(chr_l_refno_str,",");
					}
	
				}

				EXEC SQL CLOSE l_cur_upd_dpm_dvp_mst;
				IS_ANY_ORA_ERROR
				Alert("After Inner Cursor Close ");

				printf("\nDVP: REF_STRING=|%s|\n",chr_l_refno_str);
				fprintf(g_flogfile,"\n Deal String is=|%s|",chr_l_refno_str); 
					///  check3 row id to be added

					strcpy(chr_l_pms_cmbpid,APL_NULL_STRING);
					strcpy(chr_l_client_cpid,chr_l_cmbp_id); 


				sprintf(chr_g_log_buffer,"\n DVP: FETCHED VALUES ARE: \n chr_l_cln_depomap_id=|%s|\n QTY=|%lf|\n EXCH_CODE=|%s| \n SETTLEMENT_NO=|%s| \n MKT_TYPE|%s| \n ISIN=|%s| \n CMBP_ID=|%s| \n Internal REEFNO=|%s|\n DEPOSITORY=|%s| \n",
										chr_l_cln_depomap_id,l_dl_deal_struct_h->h_qty,chr_p_exch_code,l_dl_deal_struct_h->h_settlement_no,
										l_dl_deal_struct_h->h_mkt_type,chr_l_instr_isin,chr_l_cmbp_id,chr_l_internal_ref_no,chr_p_depository_code_new);
				fprintf(g_flogfile,"%s",chr_g_log_buffer);	
				printf("\n chr_l_maker_dt=|%s| \n",chr_l_maker_dt);
				printf("\n l_dl_deal_struct_h->h_instr_code=|%s| \n",l_dl_deal_struct_h->h_instr_code);
				printf("\n chr_l_access_stamp=|%s| \n",chr_l_access_stamp);
				printf("\n chr_l_maker=|%s| \n",chr_l_maker);
				printf("\n chr_l_internal_ref_no=|%s| \n",chr_l_internal_ref_no);
				printf("\n chr_l_instr_isin=|%s| \n",chr_l_instr_isin);
				printf("\n chr_l_cln_depomap_id=|%s| \n",chr_l_cln_depomap_id);	
			
	
				if(l_dl_deal_struct_h->h_qty > 0)
				{
					fprintf(g_flogfile,"DVP:Before Inserting Into DL_DPINSTRS\n");
					EXEC SQL INSERT INTO DL_DPINSTRS
					(batch_no,serial_no,trans_type,client,instr_code,qty,exch_code,mkt_type,settlement_no,setl_date,isin_cd,
					clh_dvp,cmbp_id,dpm_trans_no,rev_flg,other_branch_cd,other_client_id,other_mkt_type,
					other_stlmnt_no,internal_ref_no,send_ref_1,send_ref_2,maker,maker_date,checker,checker_date,
					access_stamp,status,depo_ind,deal_ref_nos,deal_cd,other_dp_id,client_code,POSITION_REQ_FLAG)
					VALUES(:int_l_batchseq,:counter,:chr_l_instruction_type,:chr_l_cln_depomap_id,
					:l_dl_deal_struct_h->h_instr_code,:l_dl_deal_struct_h->h_qty,:chr_p_exch_code,
					:l_dl_deal_struct_h->h_mkt_type,:l_dl_deal_struct_h->h_settlement_no,
					:l_dl_deal_struct_h->h_setldt,:chr_l_instr_isin,'D',:chr_l_pms_cmbpid,NULL,NULL,NULL,:chr_l_client_cpid,:chr_l_stl_mkt_type,
					:chr_l_setl_no,:chr_l_internal_ref_no,
					:chr_l_send_refno1,NULL,:chr_l_maker,:chr_l_maker_dt,NULL,NULL,:chr_l_access_stamp,'G',
					:chr_p_depository_code_new,:chr_l_refno_str,:l_dl_deal_struct_h->h_dealcd,:chr_l_dpid,:l_dl_deal_struct_h->h_dl_client,:chr_l_pos_req_flg);

					IS_ANY_ORA_ERROR
					Alert("After Insert DL_DPINSTRS ");
					sprintf(chr_g_log_buffer,"DVP Cursor:After Inserting Details Record for client=|%s|",l_dl_deal_struct_h->h_dl_client);	
					fprintf(g_flogfile,"%s",chr_g_log_buffer);

				}
				else if(l_dl_deal_struct_h->h_qty ==  0)
				{
					counter--; 
					int_l_zero_qty++;
					sprintf(chr_g_log_buffer,"DVP:ZERO QUANTITY FOR Client=|%s| Instrument=|%s| \n",l_dl_deal_struct_h->h_dl_client,l_dl_deal_struct_h->h_instr_code);
					fprintf(g_flogfile,"%s",chr_g_log_buffer);
				}
				
				strcpy(chr_l_refno_str,APL_NULL_STRING);
			}
	
			if(strcmp(chr_p_instr_type,"O")==0)
			{
				EXEC SQL CLOSE l_cur_gen_dvp_dpinstr_mst;
				IS_ANY_ORA_ERROR
			}

			Alert("After  Cursor Close ");
			
				int_l_deliver_qty=l_tot_qty;


	
			EXEC SQL INSERT INTO dl_dpinstr_trail
			(batch_no,record_type,branch_cd,deliver_qty,receive_qty,tot_qty,status,maker,maker_date,access_stamp)
			VALUES(
			:int_l_batchseq,
			99,
			'000',
			:int_l_deliver_qty,
			:int_l_receive_qty,
			:l_tot_qty,
			'G',
			:chr_l_maker,
			:chr_l_maker_dt,
			:chr_l_access_stamp);

			IS_ANY_ORA_ERROR	

			Alert("After  Insert  Trail ");

			EXEC SQL UPDATE dl_dpinstr_hdr SET TOT_NUM_RECORD=TOT_NUM_RECORD - :int_l_zero_qty WHERE batch_no=TO_CHAR(:int_l_batchseq);
			IS_ANY_ORA_ERROR
			Alert("After  update Header ");

			fprintf(g_flogfile,"DVP:No of Zero Quantity Records=|%d| \n",int_l_zero_qty);	
		}
	}
		
		EXEC SQL CLOSE l_cur_dpinstrmaster_dpid;
		IS_ANY_ORA_ERROR
		
		APL_GOBACK_SUCCESS							

		  RETURN_SUCCESS:
		  {
			CO_ProcMonitor(g_flogfile," Leaving Proc_GenDVP_Instrn With Success",NULL,NULL);
			return(APL_SUCCESS);
		  }
		   
		  RETURN_FAILURE:
		 {
		   printf("\n Error Inside Proc_GenDVP_Instrn:ORA|%d|\n",sqlca.sqlcode);
		   sprintf(chr_g_log_buffer,"Leaving Proc_GenDVP_Instrn With Failure ORA|%d|\n",sqlca.sqlcode);	
		   CO_ProcMonitor(g_flogfile,chr_g_log_buffer,l_debug_info_ptr,NULL);
		   return(APL_FAILURE);	
		 }
		/******************************Ends*******************************************/

  }	/*********** END DVP FUNCTION for Master data****************/

/* Processing OFF MARKET Intra DP RECORDS - START */
int Proc_GenOffMkt_Instrn_master904(char *chr_p_instr_type,
						char *chr_p_trns_type,
						char *chr_p_depository_code,
						char *chr_p_file_type,
						char *chr_p_deal_date,
						char *chr_p_dp_id,
						char *chr_p_user,
						char *chr_p_rectype,
						char *chr_p_transfer_reason_cd,
						char *chr_p_reason_purpose,
						FILE *g_flogfile,
						INTL_ENV_DATA_STRUCT_H *l_intl_env_data_h,
						DEBUG_INFO_STRUCT_H **l_debug_info_ptr)
{
	FILE  *l_ptr_ini_file = NULL;
	FILE  *l_ptr_handoff_file = NULL;
	char  chr_g_log_buffer[BUFFER_LEN] = APL_NULL_STRING;
	char  chr_l_inifile[100]= APL_NULL_STRING;
	char  chr_l_handoff_dir[PATH_LENGTH]= APL_NULL_STRING;
	char  chr_l_handoff_file_name[FILENAME_LEN_A]= APL_NULL_STRING;	
	char  chr_l_header[100]= APL_NULL_STRING;
	char  chr_l_trailer[200]= APL_NULL_STRING;
	char  chr_l_detail_rec[1000] =APL_NULL_STRING;
	int   int_l_batchseq=0;
	int   int_l_cdsl_batchseq = 0;
	char  chr_l_batchseq[APL_DP_BATCH_NO_LEN] =APL_NULL_STRING;
	int   counter=0;
	char  chr_l_instr_isin[13]= APL_NULL_STRING;
	char  chr_l_oth_cmbpid[29]= APL_NULL_STRING;
	char  chr_l_oth_setlno[8]= APL_NULL_STRING;
	char  chr_l_oth_mkt_type[3]= APL_NULL_STRING;
	char  chr_l_remark[21]= APL_NULL_STRING;
	char  chr_l_send_refno1[36]= APL_NULL_STRING;
	char  chr_l_send_refno2[36]= APL_NULL_STRING; 
	char  chr_l_depo_part_code[21]=APL_NULL_STRING;
	char  chr_l_cmbp_id[29]=APL_NULL_STRING;
	char  chr_l_dpid[21]=APL_NULL_STRING;
	int   int_l_len=0;
	char  chr_p_depository_code_new[5]= APL_NULL_STRING;
	char  chr_p_instr_type_new=APL_NULL_CHAR; 
	int	  int_l_records=0;
	char  chr_l_dprole[3]= APL_NULL_STRING;
	char  chr_l_user[APL_USERID_LEN] = APL_NULL_STRING;
	char  pro_sys_date[APL_DATE_LEN] = APL_NULL_STRING;
	char  chr_l_maker[APL_USERID_LEN] = APL_NULL_STRING;
	char  chr_l_maker_dt[APL_DATE_LEN] = APL_NULL_STRING;
	char  chr_l_access_stamp[APL_DATE_LEN] = APL_NULL_STRING;
	char  chr_l_internal_ref_no[21] = APL_NULL_STRING;
	char  chr_l_settlement_dt[20] = APL_NULL_STRING;
	char  chr_l_instruction_type[4] = APL_NULL_STRING;

	double l_tot_qty=0.0;
	char  chr_l_identiy_no[17]= APL_NULL_STRING;
	char  chr_l_refno_str[4001]= APL_NULL_STRING;
	int   counter2=0;
	double l_int_purchasesum=0.0;
	double l_int_salesum=0.0;
	double l_int_net_amt=0.0;
	char l_chr_instr_code[9]= APL_NULL_STRING;
	char chr_l_cln_depomap_id[21]= APL_NULL_STRING;
	char chr_l_flg='Y';
	char chr_l_identiy_t2t[18]= APL_NULL_STRING;
	double int_l_deliver_qty=0.0;
	double int_l_receive_qty=0.0;
	int int_l_zero_qty=0;

	short i_cmbp_id=0;
	short i_instr_isin=0;
	short i_dpid=0;
	short i_depo_part_code=0;
	short i_int_l_records=0;
	short i_l_tot_qty=0;
	short i_settlement_dt=0;
	short i_purchasesum=0;
	short i_salesum=0;
	short i_cln_depomap_id=0;

	short int_l_condexists = 0;

	char chr_depo_map_client_id[21] = APL_NULL_STRING;
	char chr_depo_map_dp_id[21]= APL_NULL_STRING;
	short i_depo_map_client_id = 0;
	short i_depo_map_dp_id = 0;
	short i_nds_blk_dt=0;
	/* Added by Hari for IB_6283 */
	int i_cnt=0;
	double l_hdr_qty=0.0;

	SYS_DL_DEAL_STRUCT_H  *l_dl_deal_struct_h = NULL;
	SYS_DL_DEAL_STRUCT_I  *l_dl_deal_struct_i = NULL;	

	
	l_dl_deal_struct_h=(SYS_DL_DEAL_STRUCT_H *)calloc(1,sizeof(SYS_DL_DEAL_STRUCT_H));
	APL_MALLOC_FAIL(l_dl_deal_struct_h)
	l_dl_deal_struct_i=(SYS_DL_DEAL_STRUCT_I *)calloc(1,sizeof(SYS_DL_DEAL_STRUCT_I));
	APL_MALLOC_FAIL(l_dl_deal_struct_i)

	memset(l_dl_deal_struct_h, NULL, sizeof(SYS_DL_DEAL_STRUCT_H));
	memset(l_dl_deal_struct_i, NULL, sizeof(SYS_DL_DEAL_STRUCT_I));
	memset(chr_g_log_buffer,APL_NULL_CHAR,BUFFER_LEN);

	/* START -- Added by Minal for ICICI_IB_6151_PMS Enhancement_Phase 1 on 06/06/2013 */

	short l_dpcount = 0;
	short l_intflag = 0;
	char  chr_l_identity_no[17]= APL_NULL_STRING;
	int int_l_check_count = 0;
	int int_Intra_Bene_counter = 0;
	int int_l_count_depocode = 0;
	int counter_mast=0;
	char  chr_l_rowid[100]= APL_NULL_STRING;
	int int_l_intra_pool_cnt_depocode = 0;
	char chr_l_IntraPool_ofMkt_identno[17]= APL_NULL_STRING;
	char chr_l_offMkt_depo_code[5] = APL_NULL_STRING;
	char chr_l_offmkt_dp_format[2] = APL_NULL_STRING;
	char chr_l_bene_offmkt_client[11] = APL_NULL_STRING;
	char chr_l_bene_offmkt_location_cd[5] = APL_NULL_STRING;
	char chr_l_bene_offmkt_dp_format[2] = APL_NULL_STRING;
	char chr_l_offmkt_pool_client[11] = APL_NULL_STRING;
	char chr_l_pool_offMkt_depo_code[5] = APL_NULL_STRING;
	char chr_l_pool_offmkt_dp_format[2] = APL_NULL_STRING;
	char  chr_l_master_dp_id[29]=APL_NULL_STRING;
	char  chr_l_nds_blk_dt[20] = APL_NULL_STRING;
	char  chr_l_pos_req_flg[2]=APL_NULL_STRING;
	EXEC SQL BEGIN DECLARE SECTION;

		EXEC SQL VAR chr_p_depository_code_new IS STRING;
		EXEC SQL VAR chr_l_header IS STRING;
		EXEC SQL VAR chr_l_trailer IS STRING;
		EXEC SQL VAR chr_l_instruction_type IS STRING;

		EXEC SQL VAR chr_l_depo_part_code IS STRING;	
		EXEC SQL VAR chr_l_instr_isin IS STRING;
		EXEC SQL VAR chr_l_maker IS STRING;
		EXEC SQL VAR chr_l_maker_dt IS STRING;
		EXEC SQL VAR chr_l_access_stamp IS STRING;
		EXEC SQL VAR chr_l_settlement_dt IS STRING;
		EXEC SQL VAR chr_l_identiy_no IS STRING;
		EXEC SQL VAR chr_l_cln_depomap_id IS STRING;
		EXEC SQL VAR chr_l_identiy_t2t IS STRING;

		
		EXEC SQL VAR chr_l_offMkt_depo_code IS STRING;
		EXEC SQL VAR chr_l_offmkt_dp_format IS STRING;
		EXEC SQL VAR chr_l_bene_offmkt_client IS STRING;
		EXEC SQL VAR chr_l_bene_offmkt_location_cd IS STRING;
		EXEC SQL VAR chr_l_bene_offmkt_dp_format IS STRING;
		EXEC SQL VAR chr_l_offmkt_pool_client IS STRING;
		EXEC SQL VAR chr_l_pool_offMkt_depo_code IS STRING;
		EXEC SQL VAR chr_l_pool_offmkt_dp_format IS STRING;


	EXEC SQL END DECLARE SECTION;


	strcpy(chr_l_maker,chr_p_user);

	if (CO_RtvSysDt(pro_sys_date,l_debug_info_ptr) == APL_FAILURE )
	{
		APL_GOBACK_FAIL
	}

	strcpy(chr_l_maker_dt,pro_sys_date);


	if (CO_RtvSysDtTime(pro_sys_date,l_debug_info_ptr) == APL_FAILURE )
	{
		APL_GOBACK_FAIL
	}	
	strcpy(chr_l_access_stamp,pro_sys_date);

	fprintf(g_flogfile,"Off Mkt Master Values Are .... \n");	 


	fprintf(g_flogfile,"Off Mkt Master Instrument Type = |%s|\n",chr_p_instr_type);	
	fprintf(g_flogfile,"Off Mkt Master Transaction Type = |%s|\n",chr_p_trns_type);	
	fprintf(g_flogfile,"Off Mkt Master Depository Code = |%s|\n",chr_p_depository_code);	
	fprintf(g_flogfile,"Off Mkt Master File Type = |%s|\n",chr_p_file_type);	
	fprintf(g_flogfile,"Off Mkt Master Deal Date = |%s|\n",chr_p_deal_date);	
	fprintf(g_flogfile,"Off Mkt Master DP ID = |%s|\n",chr_p_dp_id);	

	EXEC SQL SELECT DECODE(:chr_p_depository_code,'N','NSDL','C','CDSL')
	INTO :chr_p_depository_code_new FROM dual;
	IS_ANY_ORA_ERROR

    char hvDpBranchCd[4] = APL_NULL_STRING;
    memset(hvDpBranchCd,'\0',sizeof(hvDpBranchCd));
 
    EXEC SQL SELECT FIELD_VAL into :hvDpBranchCd from pro_gssplval where MAIN_FUN = 'DP_OFFMKT_BRNCH_CD'
    AND SUB_PROCESS = 'DP_PASS';
	IS_ANY_ORA_ERROR
	
	if(!strcmp(chr_p_trns_type,"O"))
	{
		strcpy(chr_p_trns_type,"D");
	}
	
	/******************************start******************************************/
	EXEC SQL DECLARE l_cur_offmktinstrmst_dpid CURSOR FOR	
	SELECT distinct f.DP_ID
	FROM DL_DEAL A , MT_INSTRUMENT C,MT_CLI_DEPO_MAP D,DL_DPGEN_DET F
	WHERE A.client=F.dl_client
	AND A.identiy_no=F.dl_ref_no
	AND NVL(F.gendp_flg,'N')='Y'
	AND A.client=D.cln_code
	AND A.instr_code=C.instr_code
	AND D.cln_depo_code=:chr_p_depository_code_new
	AND D.cln_depo_map_dp_id=:chr_p_dp_id
	AND (A.deal_cd = DECODE(:chr_p_instr_type,'I','1','O','2') OR
	A.deal_cd = DECODE(:chr_p_instr_type,'I','3','O','4'))
	AND A.exch_code is null
	AND A.settlement_no is null
	AND A.mkt_type is null
	AND TO_CHAR(deal_date,'DD/MM/YYYY')=:chr_p_deal_date
	AND A.clh_flg=:chr_p_trns_type
	AND A.deal_stat='CC'
	//AND A.nds_blk_dt is null
	AND A.location_cd = :chr_p_depository_code_new
	AND A.location_cd = D.cln_depo_code
	AND ( ( (f.DP_ID IS NOT NULL)
	AND (f.DP_ID ||CLIENT_ID)           !=(select CLN_DEPO_MAP_DP_ID||CLN_DEPO_MAP_CLIENT_ID from mt_cli_depo_map where cln_code=f.dl_client and cln_depo_code=:chr_p_depository_code_new) ) )
	AND f.DP_GENERATED='N';
	
	EXEC SQL OPEN l_cur_offmktinstrmst_dpid;
	IS_ANY_ORA_ERROR
	
		for(;;)
	{	
		
		memset(chr_l_master_dp_id,APL_NULL_CHAR,sizeof(chr_l_master_dp_id));
		memset(chr_l_batchseq,APL_NULL_CHAR,sizeof(chr_l_batchseq));
		EXEC SQL FETCH l_cur_offmktinstrmst_dpid INTO :chr_l_master_dp_id;
		
		if(APL_ZERO_RESULT_SET)
		{	
			if(counter_mast==0)
			 {
				fprintf(g_flogfile,"No Records Found in l_cur_dpinstrmaster_dpid CURSOR!" );
			 }
			 break;
		}
		IS_ANY_ORA_ERROR			
		counter_mast++;
		
		if(strcmp(chr_p_instr_type,"O")==0)
		{
			EXEC SQL 
			SELECT COUNT(*),
			NVL(SUM(X.tot_qty),0) 
			INTO :int_l_records:i_int_l_records,
			:l_tot_qty:i_l_tot_qty
			FROM (SELECT COUNT(*),
			DECODE(:chr_p_instr_type,'I',NVL(trunc(SUM(f.qty),3),0),'O',NVL(trunc(SUM(A.qty),3),0)) AS tot_qty		 
			FROM DL_DEAL A , MT_INSTRUMENT C,MT_CLI_DEPO_MAP D,DL_DPGEN_DET F
			WHERE A.client=F.dl_client
			AND A.identiy_no=F.dl_ref_no
			AND NVL(F.gendp_flg,'N')='Y'
			AND A.client=D.cln_code
			AND A.instr_code=C.instr_code
			AND D.cln_depo_code=:chr_p_depository_code_new
			AND D.cln_depo_map_dp_id=:chr_p_dp_id
			AND (A.deal_cd = DECODE(:chr_p_instr_type,'I','1','O','2') OR
			A.deal_cd = DECODE(:chr_p_instr_type,'I','3','O','4'))
			AND A.exch_code is null
			AND A.settlement_no is null
			AND A.mkt_type is null
			AND TO_CHAR(deal_date,'DD/MM/YYYY')=:chr_p_deal_date
			AND A.clh_flg=:chr_p_trns_type
			AND A.deal_stat='CC'
			AND A.location_cd = D.cln_depo_code
			AND A.location_cd = :chr_p_depository_code_new 
			//AND A.nds_blk_dt is null
			AND ( ( (f.DP_ID IS NOT NULL)
			AND (f.DP_ID ||CLIENT_ID)           !=(select CLN_DEPO_MAP_DP_ID||CLN_DEPO_MAP_CLIENT_ID from mt_cli_depo_map where cln_code=f.dl_client and cln_depo_code=:chr_p_depository_code_new) ) )
			and f.DP_ID=:chr_l_master_dp_id
			GROUP BY A.client,D.cln_depo_map_client_id,A.instr_code,A.exch_code,
			A.settlement_no,A.mkt_type,A.deal_cd,C.instr_isin,a.setl_date,
			F.broker_cmbpid,F.cp_clnid,F.broker_dpid,F.cp_dpid,A.ex_arena, A.deal_date,
			DECODE(:chr_p_depository_code_new,'CDSL',DECODE(A.ex_arena,'1',F.cp_dpid,'2',F.broker_cmbpid),
			'NSDL',DECODE(A.ex_arena,'1',F.cp_clnid,'2',F.broker_cmbpid) ),
			DECODE(:chr_p_depository_code_new,'CDSL',DECODE(A.ex_arena,'1',F.cp_clnid,'2',F.broker_dpid),
			'NSDL',DECODE(A.ex_arena,'1',F.cp_dpid,'2',F.broker_dpid)), A.domestic_cpclt) X;
		}
		
		if(int_l_records == 0)
		{
			fprintf(g_flogfile,"NO Records Found for Off Market Master. ");
			chr_l_flg = 'N';
		}

		IS_ANY_ORA_ERROR
		if(chr_l_flg=='Y')
		{
			if(!strcmp(chr_p_depository_code_new,"NSDL"))
			{
				int_l_batchseq = 0;

				EXEC SQL 
					SELECT DL_DPINSTRSEQ.NEXTVAL 
					INTO :int_l_batchseq 
					FROM DUAL;

				IS_ANY_ORA_ERROR
			}
			if(!strcmp(chr_p_depository_code_new,"NSDL"))
			{
				//strcpy(chr_l_batchseq,"N");
				strcat(chr_l_batchseq,(char*)ltoa(int_l_batchseq));
			}
			
		/********************** Inserting Header Record **********************/

		Alert("Batch Number is |%s| \n",chr_l_batchseq);
		Alert("DP ID is |%s| \n",chr_p_dp_id);
		Alert("Batch Sequence is |%d| \n",int_l_batchseq);
		
		fprintf(g_flogfile,"Off Mkt Master Intra DP Cursor:After Inserting Header Record");
		fflush(g_flogfile);

		fprintf(g_flogfile,"\n************* BATCH No For OFF Market Master DP is *****************|%s|\n",chr_l_batchseq);
		fflush(g_flogfile);
		/********************** Inserting Header Record **********************/

		if(strcmp(chr_p_instr_type,"O")==0)
		{

                     Alert("\n XXX1: PAYOUT BUY TYPE");
			             Alert("\n B4 l_cur_gen_Ooff_mkt_dpinstr2 CURSOR");
                         Alert("\n chr_p_depository_code_new :[%s]",chr_p_depository_code_new);
                         Alert("\n chr_p_instr_type :[%s]",chr_p_instr_type);
                         Alert("\n chr_p_dp_id :[%s]",chr_p_dp_id);
                         Alert("\n chr_p_deal_date :[%s]",chr_p_deal_date);
                         Alert("\n chr_p_trns_type :[%s]",chr_p_trns_type);

			EXEC SQL DECLARE l_cur_gen_off_dpinstr_mst CURSOR FOR	
				SELECT A.client,
				f.CLIENT_ID,
				A.instr_code,A.deal_cd,
				DECODE(:chr_p_instr_type,'I',NVL(trunc(sum(f.qty),3),0),'O',NVL(trunc(sum(f.qty),3),0)) AS QTY,
				DECODE(:chr_p_depository_code_new,'CDSL',DECODE(A.ex_arena,'2',F.cp_dpid,'1',F.broker_cmbpid),
				'NSDL',DECODE(A.ex_arena,'2',F.cp_clnid,'1',F.broker_cmbpid) ) as CMBPID,
				DECODE(:chr_p_depository_code_new,'CDSL',DECODE(A.ex_arena,'2',F.cp_clnid,'1',F.broker_dpid), 'NSDL',DECODE(A.ex_arena,'2',F.cp_dpid,'1',F.broker_dpid) ) as DPID,
				C.instr_isin,
				A.deal_date,
				A.domestic_cpclt,
				A.identiy_no,
				A.NDS_BLK_DT,
				f.rowid
				FROM DL_DEAL A , MT_INSTRUMENT C,MT_CLI_DEPO_MAP D,DL_DPGEN_DET F
				WHERE A.client=F.dl_client
				AND A.identiy_no=F.dl_ref_no
				AND NVL(F.gendp_flg,'N')='Y'
				AND A.client=D.cln_code
				AND A.instr_code=C.instr_code
				AND D.cln_depo_code=:chr_p_depository_code_new
				AND D.cln_depo_map_dp_id=:chr_p_dp_id
				AND (A.deal_cd = DECODE(:chr_p_instr_type,'I','1','O','2') OR
				A.deal_cd = DECODE(:chr_p_instr_type,'I','3','O','4'))
				AND A.exch_code is null
				AND A.settlement_no is null
				AND A.mkt_type is null
				AND TO_CHAR(deal_date,'DD/MM/YYYY')=:chr_p_deal_date
				AND A.clh_flg=:chr_p_trns_type
				AND A.deal_stat='CC'
				//AND A.nds_blk_dt is null
				AND ( ( (f.DP_ID IS NOT NULL)
				AND (f.DP_ID ||CLIENT_ID)           !=(select CLN_DEPO_MAP_DP_ID||CLN_DEPO_MAP_CLIENT_ID from mt_cli_depo_map where cln_code=f.dl_client 
				and cln_depo_code=:chr_p_depository_code_new) ) )
				and f.DP_ID=:chr_l_master_dp_id
				AND A.location_cd = :chr_p_depository_code_new
				AND A.location_cd = D.cln_depo_code
				group by A.client,f.CLIENT_ID,A.instr_code,A.deal_cd,
				DECODE(:chr_p_depository_code_new,'CDSL',DECODE(A.ex_arena,'2',F.cp_dpid,'1',F.broker_cmbpid),
				'NSDL',DECODE(A.ex_arena,'2',F.cp_clnid,'1',F.broker_cmbpid) ),
				DECODE(:chr_p_depository_code_new,'CDSL',DECODE(A.ex_arena,'2',F.cp_clnid,'1',F.broker_dpid), 
				'NSDL',DECODE(A.ex_arena,'2',F.cp_dpid,'1',F.broker_dpid) ),
				C.instr_isin,A.deal_date,A.domestic_cpclt,A.identiy_no,A.NDS_BLK_DT,f.rowid
				order by A.client,A.identiy_no;
			
			Alert("\n sqlca.sqlcode OFFMARKET master BUYYYY:[%d]",sqlca.sqlcode);
			IS_ANY_ORA_ERROR

			EXEC SQL OPEN l_cur_gen_off_dpinstr_mst;
			Alert("\n sqlca.sqlcode OFFMARKET master BUYYYY:[%d]",sqlca.sqlcode);
			IS_ANY_ORA_ERROR
			
					for(;;)
		{
			Alert("\n sqlca.sqlcode OFFMARKET master BUYYYY: inside for loop");
			memset(l_dl_deal_struct_h, NULL, sizeof(SYS_DL_DEAL_STRUCT_H));
			memset(l_dl_deal_struct_i, NULL, sizeof(SYS_DL_DEAL_STRUCT_I));
			memset(chr_l_refno_str,APL_NULL_CHAR,4001);
			memset(chr_l_pos_req_flg,APL_NULL_CHAR,sizeof(chr_l_pos_req_flg));
			memset(chr_l_nds_blk_dt,APL_NULL_CHAR,sizeof(chr_l_nds_blk_dt));
			memset(chr_l_rowid,APL_NULL_CHAR,sizeof(chr_l_rowid));			
				

			if(strcmp(chr_p_instr_type,"O")==0)
			{	
                         Alert("\n PAYOUT BUT FETCH");

				EXEC SQL FETCH l_cur_gen_off_dpinstr_mst INTO 
					:l_dl_deal_struct_h->h_dl_client:l_dl_deal_struct_i->i_dl_client,
					:chr_l_cln_depomap_id:i_cln_depomap_id,	
					:l_dl_deal_struct_h->h_instr_code:l_dl_deal_struct_i->i_instr_code,
					:l_dl_deal_struct_h->h_dealcd:l_dl_deal_struct_i->i_dealcd,
					:l_dl_deal_struct_h->h_qty:l_dl_deal_struct_i->i_qty,
					:chr_l_cmbp_id:i_cmbp_id,
					:chr_l_dpid:i_dpid,
					:chr_l_instr_isin:i_instr_isin,
					:l_dl_deal_struct_h->h_setldt:l_dl_deal_struct_i->i_setldt,
					:l_dl_deal_struct_h->h_domcpclt_cd:l_dl_deal_struct_i->i_domcpclt_cd,
               :l_dl_deal_struct_h->h_indentity_no:l_dl_deal_struct_i->i_indentity_no,
			   chr_l_nds_blk_dt:i_nds_blk_dt,
			   :chr_l_rowid;

				/* END -- Changes done in query by Minal for ICICI_IB_6151_PMS Enhancement_Phase 1 on 06/06/2013 */

                               Alert("\n sqlca.sqlcode OFFMARKET master BUYYYY:[%d]",sqlca.sqlcode);
                               Alert("\n chr_l_dpid :[%s]",chr_l_dpid);
				if(APL_ZERO_RESULT_SET)
				{

					if(counter==0)
					{
						fprintf(g_flogfile,"No Records Found for Instrument Type O! \n" );
					}
					break;
				}
				
				IS_ANY_ORA_ERROR

			}

			counter++;

			int_l_check_count = 0;

			EXEC SQL 
				SELECT :l_dl_deal_struct_h->h_dealcd
				INTO :chr_p_instr_type_new
				FROM DUAL;

			IS_ANY_ORA_ERROR

			sprintf(chr_g_log_buffer,"\n Off Mkt********DEAL CD**************=|%c| ",chr_p_instr_type_new);	
			fprintf(g_flogfile,"%s",chr_g_log_buffer);

			memset(chr_l_instruction_type, APL_NULL_CHAR, sizeof(chr_l_instruction_type));

			Alert("offMkt_depo_code is |%s| \n", chr_l_offMkt_depo_code);

			Alert("offmkt_dp_format is |%s| \n", chr_l_offmkt_dp_format);

			Alert("pool_offMkt_depo_code is |%s| \n", chr_l_pool_offMkt_depo_code);

			Alert("pool_offmkt_dp_format is |%s| \n", chr_l_pool_offmkt_dp_format);

					
					strcpy(chr_l_instruction_type,"904");

			sprintf(chr_l_internal_ref_no,"%d%d",int_l_batchseq,counter);
			strcpy(chr_l_send_refno1,chr_l_internal_ref_no);

			sprintf(chr_g_log_buffer,"\n off mkt Internal Ref No=|%s|",chr_l_internal_ref_no);	
			fprintf(g_flogfile,"%s",chr_g_log_buffer);

			Alert("Trans type is |%s| \n", chr_l_instruction_type);



			/*	********************   Start Retriving IDENTIY_NO from dl_deal table *************** */


			sprintf(chr_g_log_buffer,"\n Off Mkt FETCHED VALUES ARE: \n Client Depo Map ID = |%s|\n QTY = |%lf|\n  ISIN Code = |%s| \n CMBP ID=|%s| \n Internal REEFNO = |%s|\n DEPOSITORY Code = |%s| \n Instrument Code = |%s| \n  DP ID = |%s| \n Dom CPCLT Code = |%s| \n ",chr_l_cln_depomap_id,l_dl_deal_struct_h->h_qty,chr_l_instr_isin,chr_l_cmbp_id,chr_l_internal_ref_no,chr_p_depository_code_new, l_dl_deal_struct_h->h_instr_code,chr_l_dpid, l_dl_deal_struct_h->h_domcpclt_cd);

			fprintf(g_flogfile,"%s",chr_g_log_buffer);


			if(l_dl_deal_struct_h->h_qty > 0)
			{
				if(!strcmp(chr_p_depository_code_new,"NSDL"))
				{
						
						if(strcmp(chr_p_instr_type,"O")==0)
						{
						if(strcmp(chr_l_nds_blk_dt,"")==0)
						{
									EXEC SQL 
									UPDATE DL_DEAL 
									SET nds_blk_dt=:chr_l_maker_dt
									WHERE identiy_no = :l_dl_deal_struct_h->h_indentity_no
									AND client=:l_dl_deal_struct_h->h_dl_client
									AND INSTR_CODE = :l_dl_deal_struct_h->h_instr_code ;							
								IS_ANY_ORA_ERROR
								sprintf(chr_g_log_buffer,"Off Mkt NSDL-O:After UPDATING Details Record for client=|%s| Iden=|%s| \n",l_dl_deal_struct_h->h_dl_client,l_dl_deal_struct_h->h_indentity_no);

								fprintf(g_flogfile,"%s",chr_g_log_buffer);

								strcpy(chr_l_pos_req_flg,"Y");
						}
						else
						{
							strcpy(chr_l_pos_req_flg,"N");
						}
						Alert("1==>|%s|",chr_l_rowid);
						Alert("2==>|%s|",l_dl_deal_struct_h->h_dl_client);
						Alert("3==>|%s|",l_dl_deal_struct_h->h_indentity_no);
							EXEC SQL UPDATE DL_DPGEN_DET SET DP_GENERATED='Y' WHERE
							DL_CLIENT=:l_dl_deal_struct_h->h_dl_client
							AND DL_REF_NO=:l_dl_deal_struct_h->h_indentity_no
							AND ROWID=:chr_l_rowid;
							Alert("inside if|%d|",sqlca.sqlcode);
							IS_ANY_ORA_ERROR						
	
						}
				
						printf("\n In NSDL Processing B4 insert in DL_DPINSTRS");
						EXEC SQL 
						INSERT INTO DL_DPINSTRS
						(batch_no,serial_no,trans_type,client,instr_code,qty,setl_date,isin_cd,
						clh_dvp,cmbp_id,dpm_trans_no,rev_flg,other_branch_cd,other_client_id,other_mkt_type,
						other_stlmnt_no,internal_ref_no,send_ref_1,send_ref_2,maker,maker_date,checker,checker_date,
						access_stamp,status,depo_ind,deal_cd,other_dp_id,client_code,transfer_reason_code,reason_purpose,deal_ref_nos,POSITION_REQ_FLAG)
						VALUES
						(:chr_l_batchseq,:counter,:chr_l_instruction_type,:chr_l_cln_depomap_id,
						:l_dl_deal_struct_h->h_instr_code,:l_dl_deal_struct_h->h_qty,
						:l_dl_deal_struct_h->h_setldt,:chr_l_instr_isin,'D',:chr_l_cmbp_id,NULL,NULL,NULL,
						:chr_l_cmbp_id,NULL,NULL,:chr_l_internal_ref_no,
						:chr_l_send_refno1,NULL,:chr_l_maker,:chr_l_maker_dt,NULL,NULL,:chr_l_access_stamp,'G',
						:chr_p_depository_code_new,:l_dl_deal_struct_h->h_dealcd,:chr_l_dpid,
						:l_dl_deal_struct_h->h_dl_client,:chr_p_transfer_reason_cd,:chr_p_reason_purpose,:l_dl_deal_struct_h->h_indentity_no||',',:chr_l_pos_req_flg);

						IS_ANY_ORA_ERROR
				} /* End of if depository code is NSDL */
			}
			else if(l_dl_deal_struct_h->h_qty ==  0)
			{
				int_l_zero_qty++;

				sprintf(chr_g_log_buffer,"off mkt ZERO QUANTITY FOR Client = |%s| Instrument = |%s| \n ",l_dl_deal_struct_h->h_dl_client,l_dl_deal_struct_h->h_instr_code);

				fprintf(g_flogfile,"%s",chr_g_log_buffer);

			}

			strcpy(chr_l_refno_str,APL_NULL_STRING);

			/* Added by Hari for IB_6283 */
                       i_cnt=i_cnt+1;
			l_hdr_qty=l_hdr_qty+l_dl_deal_struct_h->h_qty;

		}
		if(strcmp(chr_p_instr_type,"O")==0)
		{
			/* EXEC SQL CLOSE l_cur_gen_offmarket_dpinstr2;*/

			EXEC SQL CLOSE l_cur_gen_off_dpinstr_mst;
			IS_ANY_ORA_ERROR
		}
		int_l_deliver_qty=l_hdr_qty;
		
		sprintf(chr_g_log_buffer,"\n No. of off mkt Records : |%d|",i_cnt);	
		fprintf(g_flogfile,"%s",chr_g_log_buffer);

		EXEC SQL INSERT INTO dl_dpinstr_hdr(batch_no,record_type,dp_id,dp_role,buy_sell_flg,status,tot_num_record,tot_qty,maker,maker_date,access_stamp)VALUES(:chr_l_batchseq,01,:chr_p_dp_id,01,DECODE(:chr_p_instr_type,'I','S','O','B'),'G',:i_cnt,:l_hdr_qty,:chr_l_maker,:chr_l_maker_dt,:chr_l_access_stamp); 
		
		IS_ANY_ORA_ERROR

		
		EXEC SQL INSERT INTO dl_dpinstr_trail(batch_no,record_type,branch_cd,deliver_qty,receive_qty,tot_qty,status,maker,maker_date,access_stamp)VALUES(:chr_l_batchseq,99,:hvDpBranchCd,:int_l_deliver_qty,:int_l_receive_qty,:l_hdr_qty,'G',:chr_l_maker,:chr_l_maker_dt,:chr_l_access_stamp);

		IS_ANY_ORA_ERROR
		
		i_cnt=0;
		l_hdr_qty=0.0;
		
		EXEC SQL 
			UPDATE DL_DPINSTR_HDR 
			SET tot_num_record = tot_num_record - :int_l_zero_qty 
			WHERE batch_no=:chr_l_batchseq;
			
		IS_ANY_ORA_ERROR
		fprintf(g_flogfile,"off mktNo of Zero Quantity Records = |%d| \n",int_l_zero_qty);	

		}
		
		}
		
	}
	
	EXEC SQL CLOSE l_cur_offmktinstrmst_dpid;
	IS_ANY_ORA_ERROR
	
		APL_GOBACK_SUCCESS


	RETURN_SUCCESS:
	{
		APL_FREE(l_dl_deal_struct_h)

		APL_FREE(l_dl_deal_struct_i)

		CO_ProcMonitor(g_flogfile," Leaving Proc_GenOffMkt_Instrn With Success",NULL,NULL);
		return(APL_SUCCESS);
	}

	RETURN_FAILURE:
	{
		APL_FREE(l_dl_deal_struct_h)

		APL_FREE(l_dl_deal_struct_i)

		sprintf(chr_g_log_buffer,"Leaving Proc_GenOffMkt_Instrn With Failure ORA|%d|\n",sqlca.sqlcode);	
		CO_ProcMonitor(g_flogfile,chr_g_log_buffer,NULL,NULL);
		return(APL_FAILURE);	
	}
	/******************************ends******************************************/
} /* Processing OFF MARKET RECORDS For Master- END */